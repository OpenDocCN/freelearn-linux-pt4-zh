<html><head></head><body><div class="chapter" title="Chapter&#xA0;1.&#xA0;Getting Started with Nginx"><div class="titlepage"><div><div><h1 class="title"><a id="ch01"/>Chapter 1. Getting Started with Nginx</h1></div></div></div><p>Nginx has <a id="id0" class="indexterm"/>emerged as a robust and scalable general-purpose web server in the last decade. It is a choice of many webmasters, startup founders, and site reliability engineers because of its simple yet scalable and expandable architecture, easy configuration, and light memory footprint. Nginx offers a lot of useful features, such as on-the-fly compression and caching out of the box.</p><p>Nginx integrates with existing web technologies such as Apache web server and PHP, and helps solving day-to-day problems in an easy way. Nginx is backed by a large, active community as well as a consulting company funded by venture capital. Therefore, it is actively supported.</p><p>This book will help you get started with Nginx and learn skills necessary to turn it into a powerful tool, a workhorse that will help you to solve your day-to-day challenges.</p><div class="section" title="Installing Nginx"><div class="titlepage"><div><div><h1 class="title"><a id="ch01lvl1sec08"/>Installing Nginx</h1></div></div></div><p>Before <a id="id1" class="indexterm"/>you can dive into specific features of Nginx, you need to learn how to install Nginx on your system.</p><p>It is strongly recommended that you use prebuilt binary packages of Nginx if they are available in your distribution. This ensures best integration of Nginx with your system and reuse of best practices incorporated into the package by the package maintainer. Prebuilt binary packages of Nginx automatically maintain dependencies for you and package maintainers are usually fast to include security patches, so you don't get any complaints from security officers. In addition to that, the package usually provides a distribution-specific startup script, which doesn't come out of the box.</p><p>Refer to your distribution package directory to find out if you have a prebuilt package for Nginx. Prebuilt <a id="id2" class="indexterm"/>Nginx packages can also be found under the <span class="strong"><strong>download</strong></span> link on the official <a class="ulink" href="http://Nginx.org">Nginx.org</a> site.</p><p>In this chapter, we will quickly go through most common distributions that contain prebuilt packages for Nginx.</p><div class="section" title="Installing Nginx on Ubuntu"><div class="titlepage"><div><div><h2 class="title"><a id="ch01lvl2sec07"/>Installing Nginx on Ubuntu</h2></div></div></div><p>The Ubuntu Linux distribution contains a prebuilt package for Nginx. To install it, simply run <a id="id3" class="indexterm"/>the following command:</p><div class="informalexample"><pre class="programlisting">
<span class="strong"><strong>$ sudo apt-get install nginx</strong></span>
</pre></div><p>The <a id="id4" class="indexterm"/>preceding command will install all the required files on your system, including the <code class="literal">logrotate</code> script and service autorun scripts. The following table describes the Nginx installation layout that will be created after running this command as well as the purpose of the selected files and folders:</p><div class="informaltable"><table border="1"><colgroup><col style="text-align: left"/><col style="text-align: left"/></colgroup><thead><tr><th style="text-align: left" valign="bottom">
<p>Description</p>
</th><th style="text-align: left" valign="bottom">
<p>Path/Folder</p>
</th></tr></thead><tbody><tr><td style="text-align: left" valign="top">
<p>Nginx configuration files</p>
</td><td style="text-align: left" valign="top">
<p>
<code class="literal">/etc/nginx</code>
</p>
</td></tr><tr><td style="text-align: left" valign="top">
<p>Main configuration file</p>
</td><td style="text-align: left" valign="top">
<p>
<code class="literal">/etc/nginx/nginx.conf</code>
</p>
</td></tr><tr><td style="text-align: left" valign="top">
<p>Virtual hosts configuration files (including default one)</p>
</td><td style="text-align: left" valign="top">
<p>
<code class="literal">/etc/nginx/sites-enabled</code>
</p>
</td></tr><tr><td style="text-align: left" valign="top">
<p>Custom configuration files</p>
</td><td style="text-align: left" valign="top">
<p>
<code class="literal">/etc/nginx/conf.d</code>
</p>
</td></tr><tr><td style="text-align: left" valign="top">
<p>Log files (both access and error log)</p>
</td><td style="text-align: left" valign="top">
<p>
<code class="literal">/var/log/nginx</code>
</p>
</td></tr><tr><td style="text-align: left" valign="top">
<p>Temporary files</p>
</td><td style="text-align: left" valign="top">
<p>
<code class="literal">/var/lib/nginx</code>
</p>
</td></tr><tr><td style="text-align: left" valign="top">
<p>Default virtual host files</p>
</td><td style="text-align: left" valign="top">
<p>
<code class="literal">/usr/share/nginx/html</code>
</p>
</td></tr></tbody></table></div><div class="note" title="Note" style=""><div class="inner"><h3 class="title"><a id="note02"/>Note</h3><p>Default virtual host files will be placed into <code class="literal">/usr/share/nginx/html</code>. Please keep in mind that this directory is only for the default virtual host. For deploying <a id="id5" class="indexterm"/>your web application, use folders recommended by <span class="strong"><strong>Filesystem Hierarchy Standard</strong></span> (<span class="strong"><strong>FHS</strong></span>).</p></div></div><p>Now you can start the Nginx service with the following command:</p><div class="informalexample"><pre class="programlisting">
<span class="strong"><strong>$ sudo service nginx start</strong></span>
</pre></div><p>This will start Nginx on your system.</p><div class="section" title="Alternatives"><div class="titlepage"><div><div><h3 class="title"><a id="ch01lvl3sec01"/>Alternatives</h3></div></div></div><p>The <a id="id6" class="indexterm"/>prebuilt Nginx package on Ubuntu has a number of alternatives. Each of them allows you to fine tune the Nginx installation for your system.</p></div></div><div class="section" title="Installing Nginx on Red Hat Enterprise Linux or CentOS/Scientific Linux"><div class="titlepage"><div><div><h2 class="title"><a id="ch01lvl2sec08"/>Installing Nginx on Red Hat Enterprise Linux or CentOS/Scientific Linux</h2></div></div></div><p>Nginx is<a id="id7" class="indexterm"/> not provided out of the box in <a id="id8" class="indexterm"/>Red Hat Enterprise Linux or CentOS/Scientific Linux. Instead, we will use<a id="id9" class="indexterm"/> the <span class="strong"><strong>Extra Packages for Enterprise Linux</strong></span> (<span class="strong"><strong>EPEL</strong></span>) repository. EPEL is a repository that is maintained by Red Hat Enterprise Linux maintainers, but contains packages that are not a part of the main distribution for various reasons. You can read <a id="id10" class="indexterm"/>more about EPEL at <a class="ulink" href="https://fedoraproject.org/wiki/EPEL">https://fedoraproject.org/wiki/EPEL</a>.</p><p>To <a id="id11" class="indexterm"/>enable EPEL, you need to download and install the repository configuration package:</p><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc">For <a id="id12" class="indexterm"/>RHEL or CentOS/SL 7, use the following link:<p>
<a class="ulink" href="http://download.fedoraproject.org/pub/epel/7/x86_64/repoview/epel-release.html">http://download.fedoraproject.org/pub/epel/7/x86_64/repoview/epel-release.html</a>
</p></li><li class="listitem" style="list-style-type: disc">For <a id="id13" class="indexterm"/>RHEL/CentOS/SL 6 use the following link:<p>
<a class="ulink" href="http://download.fedoraproject.org/pub/epel/6/i386/repoview/epel-release.html">http://download.fedoraproject.org/pub/epel/6/i386/repoview/epel-release.html</a>
</p></li><li class="listitem" style="list-style-type: disc">If you have a newer/older RHEL version, please take a look at the <span class="emphasis"><em>How can I use these extra packages?</em></span> section <a id="id14" class="indexterm"/>in the original EPEL wiki at the following link:<p>
<a class="ulink" href="https://fedoraproject.org/wiki/EPEL">https://fedoraproject.org/wiki/EPEL</a>
</p></li></ul></div><p>Now that you are ready to install Nginx, use the following command:</p><div class="informalexample"><pre class="programlisting">
<span class="strong"><strong># yum install nginx</strong></span>
</pre></div><p>The preceding command will install all the required files on your system, including the <code class="literal">logrotate</code> script and service autorun scripts. The following table describes the Nginx installation layout that will be created after running this command and the purpose of the selected files and folders:</p><div class="informaltable"><table border="1"><colgroup><col style="text-align: left"/><col style="text-align: left"/></colgroup><thead><tr><th style="text-align: left" valign="bottom">
<p>Description</p>
</th><th style="text-align: left" valign="bottom">
<p>Path/Folder</p>
</th></tr></thead><tbody><tr><td style="text-align: left" valign="top">
<p>Nginx configuration files</p>
</td><td style="text-align: left" valign="top">
<p>/<code class="literal">etc/nginx</code>
</p>
</td></tr><tr><td style="text-align: left" valign="top">
<p>Main configuration file</p>
</td><td style="text-align: left" valign="top">
<p>
<code class="literal">/etc/nginx/nginx.conf</code>
</p>
</td></tr><tr><td style="text-align: left" valign="top">
<p>Virtual hosts configuration files (including default one)</p>
</td><td style="text-align: left" valign="top">
<p>
<code class="literal">/etc/nginx/conf.d</code>
</p>
</td></tr><tr><td style="text-align: left" valign="top">
<p>Custom configuration files</p>
</td><td style="text-align: left" valign="top">
<p>
<code class="literal">/etc/nginx/conf.d</code>
</p>
</td></tr><tr><td style="text-align: left" valign="top">
<p>Log files (both access and error log)</p>
</td><td style="text-align: left" valign="top">
<p>
<code class="literal">/var/log/nginx</code>
</p>
</td></tr><tr><td style="text-align: left" valign="top">
<p>Temporary files</p>
</td><td style="text-align: left" valign="top">
<p>
<code class="literal">/var/lib/nginx</code>
</p>
</td></tr><tr><td style="text-align: left" valign="top">
<p>Default virtual host files</p>
</td><td style="text-align: left" valign="top">
<p>
<code class="literal">/usr/share/nginx/html</code>
</p>
</td></tr></tbody></table></div><div class="note" title="Note" style=""><div class="inner"><h3 class="title"><a id="note03"/>Note</h3><p>Default virtual host files will be placed into <code class="literal">/usr/share/nginx/html</code>. Please keep in mind that this directory is only for the default virtual host. For deploying your web application, use folders recommended by FHS.</p></div></div><p>By<a id="id15" class="indexterm"/> default, the Nginx service will not autostart on <a id="id16" class="indexterm"/>system startup, so let's enable it. Refer to the following table for the commands corresponding to your CentOS <a id="id17" class="indexterm"/>version:</p><div class="informaltable"><table border="1"><colgroup><col style="text-align: left"/><col style="text-align: left"/><col style="text-align: left"/></colgroup><thead><tr><th style="text-align: left" valign="bottom">
<p>Function</p>
</th><th style="text-align: left" valign="bottom">
<p>Cent OS 6</p>
</th><th style="text-align: left" valign="bottom">
<p>Cent OS 7</p>
</th></tr></thead><tbody><tr><td style="text-align: left" valign="top">
<p>Enable Nginx startup at system startup</p>
</td><td style="text-align: left" valign="top">
<p>
<code class="literal">chkconfig nginx on</code>
</p>
</td><td style="text-align: left" valign="top">
<p>
<code class="literal">systemctl enable nginx</code>
</p>
</td></tr><tr><td style="text-align: left" valign="top">
<p>Manually start Nginx</p>
</td><td style="text-align: left" valign="top">
<p>
<code class="literal">service nginx start</code>
</p>
</td><td style="text-align: left" valign="top">
<p>
<code class="literal">systemctl start nginx</code>
</p>
</td></tr><tr><td style="text-align: left" valign="top">
<p>Manually stop Nginx</p>
</td><td style="text-align: left" valign="top">
<p>
<code class="literal">service nginx stop</code>
</p>
</td><td style="text-align: left" valign="top">
<p>
<code class="literal">systemctl start nginx</code>
</p>
</td></tr></tbody></table></div></div><div class="section" title="Installing Nginx from source files"><div class="titlepage"><div><div><h2 class="title"><a id="ch01lvl2sec09"/>Installing Nginx from source files</h2></div></div></div><p>Traditionally, Nginx is<a id="id18" class="indexterm"/> distributed in the source code. In order to install Nginx from the source code, you need to download and compile the source files on your system.</p><div class="note" title="Note" style=""><div class="inner"><h3 class="title"><a id="note04"/>Note</h3><p>It is not recommended that you install Nginx from the source code. Do this only if you have a good reason, such as the following scenarios:</p><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc">You are a software developer and want to debug or extend Nginx</li><li class="listitem" style="list-style-type: disc">You feel confident enough to maintain your own package</li><li class="listitem" style="list-style-type: disc">A package from your distribution is not good enough for you</li><li class="listitem" style="list-style-type: disc">You want to fine-tune your Nginx binary</li></ul></div></div></div><p>In either case, if you are planning to use this way of installing for real use, be prepared to sort out challenges such as dependency maintenance, distribution, and application of security patches.</p><p>In this section, we will be referring to the configuration script. Configuration script is a shell script similar to one generated by autoconf, which is required to properly configure the Nginx source code before it can be compiled. This configuration script has nothing to do with <a id="id19" class="indexterm"/>the Nginx configuration file that we will be discussing later.</p><div class="section" title="Downloading the Nginx source files"><div class="titlepage"><div><div><h3 class="title"><a id="ch01lvl3sec02"/>Downloading the Nginx source files</h3></div></div></div><p>The <a id="id20" class="indexterm"/>primary source for Nginx for an English-speaking<a id="id21" class="indexterm"/> audience is <a class="ulink" href="http://Nginx.org">Nginx.org</a>. Open <a class="ulink" href="http://nginx.org/en/download.html">http://nginx.org/en/download.html</a> in your browser and choose the most recent stable version of Nginx. Download the chosen archive into a directory of your choice (<code class="literal">/usr/local</code> or <code class="literal">/usr/src</code> are common directories to use for compiling software):</p><div class="informalexample"><pre class="programlisting">
<span class="strong"><strong>$ wget -q http://nginx.org/download/nginx-1.7.9.tar.gz</strong></span>
</pre></div><p>Extract the files from the downloaded archive and change to the directory corresponding to the chosen version of Nginx:</p><div class="informalexample"><pre class="programlisting">
<span class="strong"><strong>$ tar xf nginx-1.7.9.tar.gz</strong></span>
<span class="strong"><strong>$ cd nginx-1.7.9</strong></span>
</pre></div><p>To configure the source code, we need to run the <code class="literal">./configure</code> script included in the archive:</p><div class="informalexample"><pre class="programlisting">
<span class="strong"><strong>$ ./configure</strong></span>
<span class="strong"><strong>checking for OS</strong></span>
<span class="strong"><strong> + Linux 3.13.0-36-generic i686</strong></span>
<span class="strong"><strong>checking for C compiler ... found</strong></span>
<span class="strong"><strong>+ using GNU C compiler</strong></span>
<span class="strong"><strong>[...]</strong></span>
</pre></div><p>This script will produce a lot of output and, if successful, will generate a <code class="literal">Makefile</code> file for the source files.</p><p>Notice that we showed the non-privileged user prompt <code class="literal">$</code> instead of the root <code class="literal">#</code> in the previous command lines. You are encouraged to configure and compile software as a regular user and only install as root. This will prevent a lot of problems related to access restriction while working with the source code.</p><div class="section" title="Troubleshooting"><div class="titlepage"><div><div><h4 class="title"><a id="ch01lvl4sec01"/>Troubleshooting</h4></div></div></div><p>The <a id="id22" class="indexterm"/>troubleshooting step, although very simple, has a couple of common pitfalls. The basic installation of Nginx requires the presence of OpenSSL and <span class="strong"><strong>Perl-compatible Regex</strong></span> (<span class="strong"><strong>PCRE</strong></span>) developer<a id="id23" class="indexterm"/> packages in order to compile. If these packages are not properly installed or not installed in locations where the Nginx configuration script is able to locate them, the configuration step might fail.</p><p>Then, you<a id="id24" class="indexterm"/> have to choose between disabling the affected Nginx built-in modules (rewrite or SSL, installing required packages properly, or pointing the Nginx configuration script to the actual location of those packages if they are installed.</p></div></div><div class="section" title="Building Nginx"><div class="titlepage"><div><div><h3 class="title"><a id="ch01lvl3sec03"/>Building Nginx</h3></div></div></div><p>You <a id="id25" class="indexterm"/>can build the source files now using the following command:</p><div class="informalexample"><pre class="programlisting">
<span class="strong"><strong>$ make</strong></span>
</pre></div><p>You'll see a lot of output on compilation. If build is successful, you can install the Nginx file on your system. Before doing that, make sure you escalate your privileges to the super user so that the installation script can install the necessary files into the system areas and assign necessary privileges. Once successful, run the <code class="literal">make install</code> command:</p><div class="informalexample"><pre class="programlisting">
<span class="strong"><strong># make install</strong></span>
</pre></div><p>The preceding command will install all the necessary files on your system. The following table lists all locations of <a id="id26" class="indexterm"/>the Nginx files that will be created after running this command and their purposes:</p><div class="informaltable"><table border="1"><colgroup><col style="text-align: left"/><col style="text-align: left"/></colgroup><thead><tr><th style="text-align: left" valign="bottom">
<p>Description</p>
</th><th style="text-align: left" valign="bottom">
<p>Path/Folder</p>
</th></tr></thead><tbody><tr><td style="text-align: left" valign="top">
<p>Nginx configuration files</p>
</td><td style="text-align: left" valign="top">
<p>
<code class="literal">/usr/local/nginx/conf</code>
</p>
</td></tr><tr><td style="text-align: left" valign="top">
<p>Main configuration file</p>
</td><td style="text-align: left" valign="top">
<p>
<code class="literal">/usr/local/nginx/conf/nginx.conf</code>
</p>
</td></tr><tr><td style="text-align: left" valign="top">
<p>Log files (both access and error log)</p>
</td><td style="text-align: left" valign="top">
<p>
<code class="literal">/usr/local/nginx/logs</code>
</p>
</td></tr><tr><td style="text-align: left" valign="top">
<p>Temporary files</p>
</td><td style="text-align: left" valign="top">
<p>
<code class="literal">/usr/local/nginx</code>
</p>
</td></tr><tr><td style="text-align: left" valign="top">
<p>Default virtual host files</p>
</td><td style="text-align: left" valign="top">
<p>
<code class="literal">/usr/local/nginx/html</code>
</p>
</td></tr></tbody></table></div><div class="note" title="Note" style=""><div class="inner"><h3 class="title"><a id="note05"/>Note</h3><p>Unlike installations from prebuilt packages, installation from source files does not harness Nginx folders for the custom configuration files or virtual host configuration files. The main configuration file is also very simple in its nature. You have to take care of this yourself.</p></div></div><p>Nginx must be ready to use now. To start Nginx, change your working directory to the <code class="literal">/usr/local/nginx</code> directory and run the following command:</p><div class="informalexample"><pre class="programlisting">
<span class="strong"><strong># sbin/nginx</strong></span>
</pre></div><p>This will start Nginx on your system with the default configuration.</p><div class="section" title="Troubleshooting"><div class="titlepage"><div><div><h4 class="title"><a id="ch01lvl4sec02"/>Troubleshooting</h4></div></div></div><p>This stage works flawlessly most of the time. A problem can occur in the following situations:</p><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc">You<a id="id27" class="indexterm"/> are using nonstandard system configuration. Try to play with the options in the configuration script in order to overcome the problem.</li><li class="listitem" style="list-style-type: disc">You compiled in third-party modules and they are out of date or not maintained.</li></ul></div><p>Switch off third-party modules that break your build or contact the developer for assistance.</p></div></div><div class="section" title="Copying the source code configuration from prebuilt packages"><div class="titlepage"><div><div><h3 class="title"><a id="ch01lvl3sec04"/>Copying the source code configuration from prebuilt packages</h3></div></div></div><p>Occasionally<a id="id28" class="indexterm"/> you might want to amend Nginx binary from a prebuilt packages with your own changes. In order to do that you need to reproduce the build tree that was used to compile Nginx binary for the prebuilt package.</p><p>But how would you know what version of Nginx and what configuration script options were used at the build time? Fortunately, Nginx has a solution for that. Just run the existing Nginx binary with the <code class="literal">-V</code> command-line option. Nginx will print the configure-time options. This is shown in the following:</p><div class="informalexample"><pre class="programlisting">
<span class="strong"><strong>$ /usr/sbin/nginx -V</strong></span>
<span class="strong"><strong>nginx version: nginx/1.4.6 (Ubuntu)</strong></span>
<span class="strong"><strong>built by gcc 4.8.2 (Ubuntu 4.8.2-19ubuntu1)</strong></span>
<span class="strong"><strong>TLS SNI support enabled</strong></span>
<span class="strong"><strong>configure arguments: --with-cc-opt='-g -O2 -fstack-protector --param=ssp-buffer-size=4 -Wformat -Werror=format-security -D_FORTIFY_SOURCE=2' --with-ld-opt='-Wl,-Bsymbolic-functions -Wl,-z,relro' …</strong></span>
</pre></div><p>Using the output of the preceding command, reproduce the entire build environment, including the Nginx source tree of the corresponding version and modules that were included into the build.</p><div class="note" title="Note" style=""><div class="inner"><h3 class="title"><a id="note06"/>Note</h3><p>Here, the output of the Nginx <code class="literal">-V</code> command is trimmed for simplicity. In reality, you will be <a id="id29" class="indexterm"/>able to see and copy the entire command line that was passed to the configuration script at the build time.</p></div></div><p>You might even want to reproduce the version of the compiler used in order to produce a binary-identical Nginx executable file (we will discuss this later when discussing how to troubleshoot crashes).</p><p>Once this is done, run the <code class="literal">./configure</code> script of your Nginx source tree with options from the output of the <code class="literal">-V</code> option (with necessary alterations) and follow the remaining steps of the build procedure. You will get an altered Nginx executable on the <code class="literal">objs/</code> folder<a id="id30" class="indexterm"/> of the source tree.</p></div></div><div class="section" title="The structure of the Nginx installation"><div class="titlepage"><div><div><h2 class="title"><a id="ch01lvl2sec10"/>The structure of the Nginx installation</h2></div></div></div><p>When Nginx is installed, we can quickly study the structure of the installation. This will help<a id="id31" class="indexterm"/> you to know your installation better and manage it more confidently.</p><p>For each installation method, we have a set of generic locations and default paths. Let's see what these default locations contain.</p><div class="section" title="The Nginx configuration folder"><div class="titlepage"><div><div><h3 class="title"><a id="ch01lvl3sec05"/>The Nginx configuration folder</h3></div></div></div><p>This<a id="id32" class="indexterm"/> folder contains the main configuration file and a set of parameter files. The following table describes the purpose of each of the default parameter files:</p><div class="informaltable"><table border="1"><colgroup><col style="text-align: left"/><col style="text-align: left"/></colgroup><thead><tr><th style="text-align: left" valign="bottom">
<p>File name</p>
</th><th style="text-align: left" valign="bottom">
<p>Description</p>
</th></tr></thead><tbody><tr><td style="text-align: left" valign="top">
<p>
<code class="literal">mime.types</code>
</p>
</td><td style="text-align: left" valign="top">
<p>This contains the<a id="id33" class="indexterm"/> default MIME type map for converting file extensions into MIME types.</p>
</td></tr><tr><td style="text-align: left" valign="top">
<p>
<code class="literal">fastcgi_params</code>
</p>
</td><td style="text-align: left" valign="top">
<p>This contains the<a id="id34" class="indexterm"/> default FastCGI parameters required for FastCGI to function.</p>
</td></tr><tr><td style="text-align: left" valign="top">
<p>
<code class="literal">scgi_params</code>
</p>
</td><td style="text-align: left" valign="top">
<p>This contains the<a id="id35" class="indexterm"/> default SCGI parameters required for SCGI to function.</p>
</td></tr><tr><td style="text-align: left" valign="top">
<p>
<code class="literal">uwsgi_params</code>
</p>
</td><td style="text-align: left" valign="top">
<p>This contains the default<a id="id36" class="indexterm"/> UWCGI parameters required for UWCGI to function.</p>
</td></tr><tr><td style="text-align: left" valign="top">
<p>
<code class="literal">proxy_params</code>
</p>
</td><td style="text-align: left" valign="top">
<p>This contains the <a id="id37" class="indexterm"/>default proxy module parameters. This parameter set is required for certain web servers when they are behind Nginx, so that they can figure out they are behind a proxy.</p>
</td></tr><tr><td style="text-align: left" valign="top">
<p>
<code class="literal">naxsi.rules</code> (optional)</p>
</td><td style="text-align: left" valign="top">
<p>This is the main rule <a id="id38" class="indexterm"/>set for the NAXSI web application firewall module.</p>
</td></tr><tr><td style="text-align: left" valign="top">
<p>
<code class="literal">koi-utf</code>, <code class="literal">koi-win</code>, and <code class="literal">win-utf</code>
</p>
</td><td style="text-align: left" valign="top">
<p>These <a id="id39" class="indexterm"/>are the<a id="id40" class="indexterm"/> Cyrillic character set<a id="id41" class="indexterm"/> conversion tables.</p>
</td></tr></tbody></table></div></div><div class="section" title="The default virtual host folder"><div class="titlepage"><div><div><h3 class="title"><a id="ch01lvl3sec06"/>The default virtual host folder</h3></div></div></div><p>The default <a id="id42" class="indexterm"/>configuration contains references to this site as root. It is not recommended that you use this directory for real sites, as it is not a good practice for the Nginx folders hierarchy to contain the site hierarchy. Use this directory for testing purposes or for serving auxiliary files.</p></div><div class="section" title="The virtual hosts configuration folder"><div class="titlepage"><div><div><h3 class="title"><a id="ch01lvl3sec07"/>The virtual hosts configuration folder</h3></div></div></div><p>This is the location of virtual host configuration files. The recommended structure of this folder is<a id="id43" class="indexterm"/> to have one file per virtual host in this folder or one folder per virtual host, containing all files related to this virtual host. In this way, you will always know which files were used and which are now being used, and what each of the files contain and which files can be purged.</p></div><div class="section" title="The log folder"><div class="titlepage"><div><div><h3 class="title"><a id="ch01lvl3sec08"/>The log folder</h3></div></div></div><p>This is <a id="id44" class="indexterm"/>the location for Nginx log files. The default access log file and error log file will be written to this location. For installation from source files, it is not recommended that you use the default location <code class="literal">/usr/local/nginx/logs</code> for real sites. Instead, make sure all your log files are stored in the system log file location, such as <code class="literal">/var/log/nginx</code>, to provide better overview and management of your log files.</p></div><div class="section" title="The temporary folder"><div class="titlepage"><div><div><h3 class="title"><a id="ch01lvl3sec09"/>The temporary folder</h3></div></div></div><p>Nginx<a id="id45" class="indexterm"/> uses temporary files for receiving large request bodies, and proxies large files from upstream. Files that are created for this purpose can be found in this folder.</p></div></div></div></div>
<div class="section" title="Configuring Nginx"><div class="titlepage"><div><div><h1 class="title"><a id="ch01lvl1sec09"/>Configuring Nginx</h1></div></div></div><p>Now <a id="id46" class="indexterm"/>that you know how to install Nginx and the structure of its installation, we can study how to configure Nginx. Simplicity of configuration is one of the reasons Nginx is popular among webmasters, because this saves them a lot of time.</p><p>In a nutshell, Nginx configuration files are simply sequences of directives that can take up to eight space-separated arguments, for example:</p><div class="informalexample"><pre class="programlisting">gzip_types text/plain text/css application/x-javascript text/xml application/xml application/xml+rss text/javascript;</pre></div><p>In the configuration file, the directives are delimited by a semicolon (<code class="literal">;</code>) from one another. Some of the directives may have a block instead of a semicolon. A block is delimited by curly brackets (<code class="literal">{}</code>). A block can contain arbitrary text data, for example:</p><div class="informalexample"><pre class="programlisting">types {
    text/html                            html htm shtml;
    text/css                              css;
    text/xml                              xml;
    image/gif                            gif;
    image/jpeg                         jpeg jpg;
    application/x-javascript      js;
    application/atom+xml        atom;
    application/rss+xml            rss;
}</pre></div><p>A block can also contain a list of other directives. In this case, the block is called a section. A section can enclose other sections, thus establishing a hierarchy of sections.</p><p>Most important directives have short names; this reduces the effort required to maintain the configuration file.</p><div class="section" title="Value types"><div class="titlepage"><div><div><h2 class="title"><a id="ch01lvl2sec11"/>Value types</h2></div></div></div><p>In <a id="id47" class="indexterm"/>general, a directive can have arbitrary quoted or unquoted strings as arguments. But many directives have arguments that have common value types. To help you quickly get your head around the value types I listed them in the following table:</p><div class="informaltable"><table border="1"><colgroup><col style="text-align: left"/><col style="text-align: left"/><col style="text-align: left"/></colgroup><thead><tr><th style="text-align: left" valign="bottom">
<p>Value type</p>
</th><th style="text-align: left" valign="bottom">
<p>Format</p>
</th><th style="text-align: left" valign="bottom">
<p>Example of a value</p>
</th></tr></thead><tbody><tr><td style="text-align: left" valign="top">
<p>Flag</p>
</td><td style="text-align: left" valign="top">
<p>[on|off]</p>
</td><td style="text-align: left" valign="top">
<p>
<code class="literal">on</code>, <code class="literal">off</code>
</p>
</td></tr><tr><td style="text-align: left" valign="top">
<p>Signed integer</p>
</td><td style="text-align: left" valign="top">
<p>-?[0-9]+</p>
</td><td style="text-align: left" valign="top">
<p>
<code class="literal">1024</code>
</p>
</td></tr><tr><td style="text-align: left" valign="top">
<p>Size</p>
</td><td style="text-align: left" valign="top">
<p>[0-9]+([mM]|[kK])?</p>
</td><td style="text-align: left" valign="top">
<p>
<code class="literal">23M</code>, <code class="literal">12348k</code>
</p>
</td></tr><tr><td style="text-align: left" valign="top">
<p>Offset</p>
</td><td style="text-align: left" valign="top">
<p>[0-9]+([mM]|[kK]|[gG])?</p>
</td><td style="text-align: left" valign="top">
<p>
<code class="literal">43G</code>, <code class="literal">256M</code>
</p>
</td></tr><tr><td style="text-align: left" valign="top">
<p>Milliseconds</p>
</td><td style="text-align: left" valign="top">
<p>[0-9]+[yMwdhms]?</p>
</td><td style="text-align: left" valign="top">
<p>
<code class="literal">30s</code>, <code class="literal">60m</code>
</p>
</td></tr></tbody></table></div></div><div class="section" title="Variables"><div class="titlepage"><div><div><h2 class="title"><a id="ch01lvl2sec12"/>Variables</h2></div></div></div><p>Variables<a id="id48" class="indexterm"/> are named objects that can be assigned a textual value. Variables can only appear inside the <code class="literal">http</code> section. A variable is referred to by its name, prefixed by the dollar (<code class="literal">$</code>) symbol. Alternatively, a variable reference can enclose a variable name in curly brackets to prevent merging with surrounding text.</p><p>Variables can be used in any directive that accepts them, as shown here:</p><div class="informalexample"><pre class="programlisting">proxy_set_header Host $http_host;</pre></div><p>This directive sets the HTTP header host in a forwarded request to HTTP host name from the original request. This is equivalent to the following:</p><div class="informalexample"><pre class="programlisting">proxy_set_header Host ${http_host};</pre></div><p>With the following syntax, you can specify the host name:</p><div class="informalexample"><pre class="programlisting">proxy_set_header Host ${http_host}_squirrel;</pre></div><p>The preceding command will append a string <code class="literal">_squirrel</code> to the value of the original host name. Without curly brackets, the string <code class="literal">_squirrel</code> would have been interpreted as a part of the variable name, and the reference would have pointed to a variable "http_host_squirrel" rather than <code class="literal">http_host</code>.</p><p>There are also special variable names:</p><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc">Variables from <code class="literal">$1</code> to <code class="literal">$9</code> refer to the capture arguments in the regular expressions, as shown here:<div class="informalexample"><pre class="programlisting">        location ~ /(.+)\.php$ {
            [...]
            proxy_set_header X-Script-Name $1;
        }</pre></div><p>The preceding configuration will set the HTTP header <code class="literal">X-Script-Name</code> in the forwarded request to the name of the PHP script in the request URI. The captures are specified in a regular expression using round brackets.</p></li><li class="listitem" style="list-style-type: disc">Variables that start with <code class="literal">$arg_</code> refer to the corresponding query argument in the original HTTP request, as shown here:<div class="informalexample"><pre class="programlisting">        proxy_set_header X-Version-Name $arg_ver;</pre></div><p>The preceding configuration will set the HTTP header <code class="literal">X-Version-Name</code> in the forwarded request to the value of the <code class="literal">ver</code> query argument in the original request.</p></li><li class="listitem" style="list-style-type: disc">Variables that start with <code class="literal">$http_</code> refer to the corresponding HTTP header line in the original request.</li><li class="listitem" style="list-style-type: disc">Variables that start with <code class="literal">$sent_http_</code> refer to the corresponding HTTP header line in the outbound HTTP request.</li><li class="listitem" style="list-style-type: disc">Variables that start with <code class="literal">$upstream_http_</code> refer to the corresponding HTTP header line in the response received from an upstream.</li><li class="listitem" style="list-style-type: disc">Variables that start with <code class="literal">$cookie_ refer</code> to the corresponding cookie in the original request.</li><li class="listitem" style="list-style-type: disc">Variables that start with <code class="literal">$upstream_cookie_</code> refer to the corresponding cookie in the response received from an upstream.</li></ul></div><p>Variables <a id="id49" class="indexterm"/>must be declared by Nginx modules before they can be used in the configuration. Built-in Nginx modules provide a set of core variables that allow you to operate with the data from HTTP requests and responses. Refer to the Nginx documentation for the complete list of core variables and their functions.</p><p>Third-party modules can provide extra variables. These variables have to be described in the third-party module's documentation.</p></div><div class="section" title="Inclusions"><div class="titlepage"><div><div><h2 class="title"><a id="ch01lvl2sec13"/>Inclusions</h2></div></div></div><p>Any Nginx<a id="id50" class="indexterm"/> configuration section can contain inclusions of other files via <a id="id51" class="indexterm"/>the <code class="literal">include</code> directive. This directive takes a single argument containing a path to a file to be included, as shown here:</p><div class="informalexample"><pre class="programlisting">/*
 * A simple relative inclusion. The target file's path
 * is relative to the location of the current configuration file.
 */
include mime.types;

/*
 * A simple inclusion using an absolute path.
 */
include /etc/nginx/conf/site-defaults.conf;</pre></div><p>Once specified, the <code class="literal">include</code> directive instructs Nginx to process the contents of the file or files specified <a id="id52" class="indexterm"/>by the argument of this directive as if they were specified in place of the <code class="literal">include</code> directive.</p><div class="note" title="Note" style=""><div class="inner"><h3 class="title"><a id="note07"/>Note</h3><p>Relative paths are resolved with respect to the path of the configuration file the directive is specified in. This is good to keep in mind when the <code class="literal">include</code> directive is specified in another included file, such as when a virtual host configuration file contains a relative <code class="literal">include</code> directive.</p></div></div><p>The <code class="literal">include</code> directive can also contain a globbed path with wild cards, either relative or absolute. In this case, the globbed path is expanded and all files matching the specified pattern are included in no particular order. Take a look at the following code:</p><div class="informalexample"><pre class="programlisting">/*
 * A simple glob inclusion. This will include all files
 * ending on ".conf" located in /etc/nginx/sites-enabled
 */
include /etc/nginx/sites-enabled/*.conf;</pre></div><p>The <code class="literal">include</code> directive with wild cards is an obvious solution for including site configurations, as <a id="id53" class="indexterm"/>their number can vary greatly. Using the <code class="literal">include</code> directive, you can properly structure the configuration file or reuse certain parts multiple times.</p></div><div class="section" title="Sections"><div class="titlepage"><div><div><h2 class="title"><a id="ch01lvl2sec14"/>Sections</h2></div></div></div><p>A section is a directive that encloses other directives in its block. Each section's delimiters<a id="id54" class="indexterm"/> must be located in the same file, while the content of a section can span multiple files via the <code class="literal">include</code> directive.</p><p>It is not possible to describe every possible configuration directive in this chapter. Refer to the Nginx documentation for more information. However, I will quickly go over the Nginx configuration section types so that you can orient in the structure of the Nginx configuration files.</p></div><div class="section" title="The http section"><div class="titlepage"><div><div><h2 class="title"><a id="ch01lvl2sec15"/>The http section</h2></div></div></div><p>The <code class="literal">http</code> section<a id="id55" class="indexterm"/> enables and configures the HTTP service in Nginx. It has the server and upstream declarations. As far as individual directives are concerned, the <code class="literal">http</code> section usually contains those that specify defaults for the entire HTTP service.</p><p>The <code class="literal">http</code> section must contain at least one <code class="literal">server</code> section in order to process HTTP requests. Here is a typical layout of the <code class="literal">http</code> section:</p><div class="informalexample"><pre class="programlisting"> http {
     [...]
     server {
         [...]
     }
 }</pre></div><p>Here <a id="id56" class="indexterm"/>and in other examples of this book, we use <code class="literal">[…]</code> to refer to omitted irrelevant parts of the configuration.</p></div><div class="section" title="The server section"><div class="titlepage"><div><div><h2 class="title"><a id="ch01lvl2sec16"/>The server section</h2></div></div></div><p>The <code class="literal">server</code> section <a id="id57" class="indexterm"/>configures an HTTP or HTTPS virtual host and specifies listening addresses for them using the <code class="literal">listen</code> directive. At the end of the configuration stage, all listening addresses are grouped together and all listening addresses are activated at startup.</p><p>The <code class="literal">server</code> section contains the <code class="literal">location</code> sections, as well as sections that can be enclosed by the <code class="literal">location</code> section (see description of other sections types for details). Directives that are specified in the <code class="literal">server</code> section itself go into the so-called default location. In that regard, the <code class="literal">server</code> section serves the purpose of the <code class="literal">location</code> section itself.</p><p>When a request comes in via one of the listening addresses, it is routed to the <code class="literal">server</code> sections that match a virtual host pattern specified by the <code class="literal">server_name</code> directive. The request is then routed further to the location that matches the path of the request URI or processed by the default location if there is no match.</p></div><div class="section" title="The upstream section"><div class="titlepage"><div><div><h2 class="title"><a id="ch01lvl2sec17"/>The upstream section</h2></div></div></div><p>The <code class="literal">upstream</code> section configures a logical server that Nginx can pass requests to for further<a id="id58" class="indexterm"/> processing. This logical server can be configured to be backed by one or more physical servers external to Nginx with concrete domain names or IP addresses.</p><p>Upstream can be referred to by name from any place in the configuration file where a reference to a physical server can take place. In this way, your configuration can be made independent of the underlying structure of the upstream, while the upstream structure can be changed without changing your configuration.</p></div><div class="section" title="The location section"><div class="titlepage"><div><div><h2 class="title"><a id="ch01lvl2sec18"/>The location section</h2></div></div></div><p>The <code class="literal">location</code> section is one of the workhorses in Nginx. The <code class="literal">location</code> directive takes parameters<a id="id59" class="indexterm"/> that specify a pattern that is matched against the path of the request URI. When a request is routed to a location, Nginx activates configuration that is enclosed by that <code class="literal">location</code> section.</p><p>There are<a id="id60" class="indexterm"/> three types of location patterns: simple, exact, and regular expression location patterns.</p><div class="section" title="Simple"><div class="titlepage"><div><div><h3 class="title"><a id="ch01lvl3sec10"/>Simple</h3></div></div></div><p>A<a id="id61" class="indexterm"/> simple location has a string as the first argument. When this string matches the initial part of the request URI, the request is routed to that location. Here is an example of a simple location:</p><div class="informalexample"><pre class="programlisting">        location /images {
            root /usr/local/html/images;
        }</pre></div><p>Any request with a URI that starts with <code class="literal">/images</code>, such as <code class="literal">/images/powerlogo.png</code>, <code class="literal">/images/calendar.png</code>, or <code class="literal">/images/social/github-icon.png</code> will be routed to this location. A URI with a path that equals to <code class="literal">/images</code> will be routed to this location as well.</p></div><div class="section" title="Exact"><div class="titlepage"><div><div><h3 class="title"><a id="ch01lvl3sec11"/>Exact</h3></div></div></div><p>Exact locations<a id="id62" class="indexterm"/> are designated with an equals (<code class="literal">=</code>) character as the first argument and have a string as the second argument, just like simple locations do. Essentially, exact locations work just like simple locations, except that the path in the request URI has to match the second argument of the <code class="literal">location</code> directive exactly in order to be routed to that location:</p><div class="informalexample"><pre class="programlisting">        location = /images/empty.gif {
            emptygif;
        }</pre></div><p>The preceding configuration will return an empty GIF file if and only if the URI <code class="literal">/images/empty.gif</code> is requested.</p></div><div class="section" title="Regular expression locations"><div class="titlepage"><div><div><h3 class="title"><a id="ch01lvl3sec12"/>Regular expression locations</h3></div></div></div><p>Regular<a id="id63" class="indexterm"/> expression locations are designated with a tilde (<code class="literal">~</code>) character or <code class="literal">~*</code> (for case-insensitive matches) as the first argument and have a regular expression as the second argument. Regular expression locations are processed after both simple and exact locations. The path in the request URI has to match the regular expression in the second argument of the <code class="literal">location</code> directive in order to be routed to that location. A typical example is as follows:</p><div class="informalexample"><pre class="programlisting">        location ~ \.php$ {
            [...]
        }</pre></div><p>According to the preceding configuration, requests with URIs that end with <code class="literal">.php</code> will be routed to this location.</p><p>The <code class="literal">location</code> sections<a id="id64" class="indexterm"/> can be nested. For that, you just need to specify a <code class="literal">location</code> section inside another <code class="literal">location</code> section.</p></div></div><div class="section" title="The if section"><div class="titlepage"><div><div><h2 class="title"><a id="ch01lvl2sec19"/>The if section</h2></div></div></div><p>The <code class="literal">if</code> section <a id="id65" class="indexterm"/>encloses a configuration that becomes active once a condition specified by the <code class="literal">if</code> directive is satisfied. The <code class="literal">if</code> section can be enclosed by the <code class="literal">server</code> and <code class="literal">location</code> sections, and is only available if the <code class="literal">rewrite</code> module is present.</p><p>A condition of an <code class="literal">if</code> directive is specified in round brackets and can take the following forms:</p><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc">A plain variable, as <a id="id66" class="indexterm"/>shown here:<div class="informalexample"><pre class="programlisting">if ($file_present) {
    limit_rate 256k;
}</pre></div><p>If the variable evaluates to true value in runtime, the configuration section activates.</p></li><li class="listitem" style="list-style-type: disc">A unary expression<a id="id67" class="indexterm"/> that consists of an operator and a string with variables, as shown here:<div class="informalexample"><pre class="programlisting">if ( -d "${path}" ) {
    try_files "${path}/default.png" "${path}/default.jpg";
}</pre></div><p>The following unary operators are supported:</p><div class="informaltable"><table border="1"><colgroup><col style="text-align: left"/><col style="text-align: left"/><col style="text-align: left"/><col style="text-align: left"/></colgroup><thead><tr><th style="text-align: left" valign="bottom">
<p>Operator</p>
</th><th style="text-align: left" valign="bottom">
<p>Description</p>
</th><th style="text-align: left" valign="bottom">
<p>Operator</p>
</th><th style="text-align: left" valign="bottom">
<p>Description</p>
</th></tr></thead><tbody><tr><td style="text-align: left" valign="top">
<p>
<code class="literal">-f</code>
</p>
</td><td style="text-align: left" valign="top">
<p>True if specified<a id="id68" class="indexterm"/> file exists</p>
</td><td style="text-align: left" valign="top">
<p>
<code class="literal">!-f</code>
</p>
</td><td style="text-align: left" valign="top">
<p>True if specified <a id="id69" class="indexterm"/>file does not exist</p>
</td></tr><tr><td style="text-align: left" valign="top">
<p>
<code class="literal">-d</code>
</p>
</td><td style="text-align: left" valign="top">
<p>True if specified <a id="id70" class="indexterm"/>directory exists</p>
</td><td style="text-align: left" valign="top">
<p>
<code class="literal">!-d</code>
</p>
</td><td style="text-align: left" valign="top">
<p>True if specified <a id="id71" class="indexterm"/>directory does not exist</p>
</td></tr><tr><td style="text-align: left" valign="top">
<p>
<code class="literal">-e</code>
</p>
</td><td style="text-align: left" valign="top">
<p>True if specified <a id="id72" class="indexterm"/>file exists and is a symbolic link</p>
</td><td style="text-align: left" valign="top">
<p>
<code class="literal">!-e</code>
</p>
</td><td style="text-align: left" valign="top">
<p>True if specified <a id="id73" class="indexterm"/>file does not exist or is not a symbolic link</p>
</td></tr><tr><td style="text-align: left" valign="top">
<p>
<code class="literal">-x</code>
</p>
</td><td style="text-align: left" valign="top">
<p>True if specified<a id="id74" class="indexterm"/> file exists and is executable</p>
</td><td style="text-align: left" valign="top">
<p>
<code class="literal">!-x</code>
</p>
</td><td style="text-align: left" valign="top">
<p>True if specified file <a id="id75" class="indexterm"/>does not exist or is not executable</p>
</td></tr></tbody></table></div></li><li class="listitem" style="list-style-type: disc">A binary expression<a id="id76" class="indexterm"/> that consists of a variable name, an operator, and a string with variables. The following binary operators are supported:<div class="informaltable"><table border="1"><colgroup><col style="text-align: left"/><col style="text-align: left"/><col style="text-align: left"/><col style="text-align: left"/></colgroup><thead><tr><th style="text-align: left" valign="bottom">
<p>Operator</p>
</th><th style="text-align: left" valign="bottom">
<p>Description</p>
</th><th style="text-align: left" valign="bottom">
<p>Operator</p>
</th><th style="text-align: left" valign="bottom">
<p>Description</p>
</th></tr></thead><tbody><tr><td style="text-align: left" valign="top">
<p>
<code class="literal">=</code>
</p>
</td><td style="text-align: left" valign="top">
<p>True if a variable<a id="id77" class="indexterm"/> matches a string</p>
</td><td style="text-align: left" valign="top">
<p>
<code class="literal">!=</code>
</p>
</td><td style="text-align: left" valign="top">
<p>True if a variable <a id="id78" class="indexterm"/>does not match a string</p>
</td></tr><tr><td style="text-align: left" valign="top">
<p>
<code class="literal">~</code>
</p>
</td><td style="text-align: left" valign="top">
<p>True if a regular <a id="id79" class="indexterm"/>expression matches the value of a variable </p>
</td><td style="text-align: left" valign="top">
<p>
<code class="literal">!~</code>
</p>
</td><td style="text-align: left" valign="top">
<p>True if a regular<a id="id80" class="indexterm"/> expression does not match the value of a variable </p>
</td></tr><tr><td style="text-align: left" valign="top">
<p>
<code class="literal">~*</code>
</p>
</td><td style="text-align: left" valign="top">
<p>True if a <a id="id81" class="indexterm"/>case-insensitive regular expression matches the value of a variable</p>
</td><td style="text-align: left" valign="top">
<p>
<code class="literal">!~*</code>
</p>
</td><td style="text-align: left" valign="top">
<p>True if a <a id="id82" class="indexterm"/>case-insensitive regular expression does not match the value of a variable</p>
</td></tr></tbody></table></div></li></ul></div><p>Let's discuss some examples of the <code class="literal">if</code> directive.</p><p>This one adds a prefix <code class="literal">/msie/</code> to the URL of any request that contains <code class="literal">MSIE</code> in the user-agent field:</p><div class="informalexample"><pre class="programlisting">if ($http_user_agent ~ MSIE) {
    rewrite ^(.*)$ /msie/$1 break;
}</pre></div><p>The next example sets the variable <code class="literal">$id</code> to the value of the cookie named <code class="literal">id</code>, if it is present:</p><div class="informalexample"><pre class="programlisting">if ($http_cookie ~* "id=([^;]+)(?:;|$)") {
    set $id $1;
}</pre></div><p>The next <a id="id83" class="indexterm"/>one returns HTTP status <code class="literal">405</code> ("Method Not Allowed") for every request with the method <code class="literal">POST</code>:</p><div class="informalexample"><pre class="programlisting">if ($request_method = POST) {
    return 405;
}</pre></div><p>Finally, the configuration in the following example limits the rate to 10 KB whenever the variable <code class="literal">$slow</code> evaluates to true:</p><div class="informalexample"><pre class="programlisting">if ($slow) {
    limit_rate 10k;
}</pre></div><p>The <code class="literal">if</code> directive seems like a powerful instrument, but it must be used with caution. This is because the configuration inside the <code class="literal">if</code> section is not imperative, that is, it does not alter the request processing flow according to the order of the <code class="literal">if</code> directives.</p><div class="note" title="Note" style=""><div class="inner"><h3 class="title"><a id="note08"/>Note</h3><p>Because of the nonintuitive behavior of the <code class="literal">if</code> directive, its use is discouraged.</p></div></div><p>Conditions <a id="id84" class="indexterm"/>are not evaluated in the order they are specified in the configuration file. They are merely applied simultaneously and configuration settings from the sections for which conditions were satisfied are merged together and applied at once.</p></div><div class="section" title="The limit_except section"><div class="titlepage"><div><div><h2 class="title"><a id="ch01lvl2sec20"/>The limit_except section</h2></div></div></div><p>The <code class="literal">limit_except</code> section <a id="id85" class="indexterm"/>activates the configuration that it encloses if the request method <span class="emphasis"><em>does not match</em></span> any from the list of methods specified by this directive. Specifying the <code class="literal">GET</code> method in the list of methods automatically assumes the <code class="literal">HEAD</code> method. This section can only appear inside the <code class="literal">location</code> section, as shown here:</p><div class="informalexample"><pre class="programlisting">limit_except GET {
    return 405;
}</pre></div><p>The preceding configuration will respond with HTTP status <code class="literal">405</code> ("Method Not Allowed") for every request that is not made using the <code class="literal">GET</code> or <code class="literal">HEAD</code> method.</p></div><div class="section" title="Other section types"><div class="titlepage"><div><div><h2 class="title"><a id="ch01lvl2sec21"/>Other section types</h2></div></div></div><p>Nginx <a id="id86" class="indexterm"/>configuration can contain other section types, such as <code class="literal">main</code> and <code class="literal">server</code> in the <code class="literal">main</code> section, as well as section types provided by third-party modules. In this book, we will not pay close attention to them.</p><p>Refer to the documentation of the corresponding modules for information about these types of configuration sections.</p></div><div class="section" title="Configuration settings' inheritance rules"><div class="titlepage"><div><div><h2 class="title"><a id="ch01lvl2sec22"/>Configuration settings' inheritance rules</h2></div></div></div><p>Many<a id="id87" class="indexterm"/> Nginx configuration settings can be inherited from a section of outer level to a section of inner level. This saves a lot of time when you configure Nginx.</p><p>The following figure<a id="id88" class="indexterm"/> illustrates how inheritance rules work:</p><div class="mediaobject"><img src="graphics/B04282_01_01.jpg" alt="Configuration settings' inheritance rules"/></div><p>All <a id="id89" class="indexterm"/>settings can be attributed to three categories:</p><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc">Those that make sense only in the entire HTTP service (marked red)</li><li class="listitem" style="list-style-type: disc">Those that make sense in the virtual host configuration (marked blue)</li><li class="listitem" style="list-style-type: disc">Those that make sense on all levels of configuration (marked green)</li></ul></div><p>The settings from the first category do not have any inheritance rules, because they cannot inherit values from anywhere. They can be specified in the <code class="literal">http</code> section only and can be applied to the entire HTTP service. These are settings set by directives, such as <code class="literal">variables_hash_max_size</code>, <code class="literal">variables_hash_bucket_size</code>, <code class="literal">server_names_hash_max_size</code>, and <code class="literal">server_names_hash_bucket_size</code>.</p><p>The settings from the second category can inherit values only from the <code class="literal">http</code> section. They can be specified both in the <code class="literal">http</code> and <code class="literal">server</code> sections, but the settings applied to a given virtual host are determined by inheritance rules. These are settings set by directives, such as <code class="literal">client_header_timeout</code>, <code class="literal">client_header_buffer_size</code>, and <code class="literal">large_client_header_buffers</code>.</p><p>Finally, the settings from the third category can inherit values from any section up to <code class="literal">http</code>. They can be specified in any section inside the HTTP service configuration, and the settings applied to a given context are determined by inheritance rules.</p><p>The <a id="id90" class="indexterm"/>arrows on the figure illustrate value propagation paths. The colors of the arrows specify the scope of the setting. The propagation rules along a path are as follows:</p><p>When you specify a value for a parameter at a certain level of the configuration, it overrides the value of the same parameter at the outer levels if it is set, and automatically propagates to the inner levels of the configuration. Let's take a look at the following example:</p><div class="informalexample"><pre class="programlisting">location / {
    # The outer section
    root /var/www/example.com;
    gzip on;

    location ~ \.js$ {
        # Inner section 1
        gzip off;

    }
    location ~ \.css$ {
        # Inner section 2
    }
    [...]
}</pre></div><p>The value of the <code class="literal">root</code> directive will propagate to the inner sections, so there is no need to specify it again. The value of the <code class="literal">gzip</code> directive in the outer section will propagate to the inner sections, but will be overridden by the value of the <code class="literal">gzip</code> directive inside the first inner section. The overall effect of that will be that <code class="literal">gzip</code> compression will be enabled everywhere in the other section, except for the first inner section.</p><p>When a value for some parameter is not specified in a given configuration section, it is inherited from a section that encloses the current configuration section. If the enclosing section does not have this parameter set, the search goes to the outer level and so on. If a value for a certain parameter is not specified at all, a built-in default value is used.</p></div><div class="section" title="The First sample configuration"><div class="titlepage"><div><div><h2 class="title"><a id="ch01lvl2sec23"/>The First sample configuration</h2></div></div></div><p>By <a id="id91" class="indexterm"/>this point in the chapter, you might have accumulated a lot of knowledge without having an idea of what a complete working configuration looks like. We will study a short but functioning configuration that will give you an idea of what a complete configuration file might look like:</p><div class="informalexample"><pre class="programlisting">error_log logs/error.log;

events {
    use epoll;
    worker_connections  1024;
}

http {
    include           mime.types;
    default_type      application/octet-stream;

    server {
        listen      80;
        server_name example.org www.example.org;

        location / {
            proxy_pass http://localhost:8080;
            include proxy_params;
        }

        location ~ ^(/images|/js|/css) {
            root html;
            expires 30d;
        }
    }
}</pre></div><p>This configuration first instructs Nginx to write the error log to <code class="literal">logs/error.log</code>. Then, it sets up Nginx to use the epoll event processing method (<code class="literal">use epoll</code>) and allocates memory for 1024 connections per worker (<code class="literal">worker_connections 1024</code>). After that, it enables the HTTP service and configures certain default settings for the HTTP service (<code class="literal">include mime.types</code>, <code class="literal">default_type application/octet-stream</code>). It creates a virtual host and sets its names to <code class="literal">example.org</code> and <code class="literal">www.example.org</code> (<code class="literal">server_name example.org www.example.org</code>). The virtual host is made available at the default listening address <code class="literal">0.0.0.0</code> and port 80 (<code class="literal">listen 80</code>).</p><p>We then configure two locations. The first location passes every request routed to it into a web application server running at <code class="literal">http://localhost:8080</code> (<code class="literal">proxy_pass http://localhost:8080</code>). The second location is a regular expression location. By specifying it we effectively exclude a set of paths from the first location. We use this location to return static data such as images, JavaScript files, and CSS files. We set the base directory for our media files as <code class="literal">html</code> (<code class="literal">root html</code>). For all media files, we set the expiration date as 30 days (<code class="literal">expires 30d</code>).</p><p>To try<a id="id92" class="indexterm"/> out this configuration, back up your default configuration file and replace the content of the default configuration file with the preceding configuration.</p><p>Then, restart <a id="id93" class="indexterm"/>Nginx for the settings to take effect. After this is done, you can navigate to the URL <code class="literal">http://localhost/</code> to check out your new configuration.</p></div><div class="section" title="Configuration best practices"><div class="titlepage"><div><div><h2 class="title"><a id="ch01lvl2sec24"/>Configuration best practices</h2></div></div></div><p>Now <a id="id94" class="indexterm"/>that you know more about the elements and structure of the Nginx configuration file, you might be curious about what best practices exist in this area. Here is a list of recommendations that will help you to maintain your configuration more efficiently and make it more robust and manageable:</p><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc">Structure your configuration well. Observe which common parts of the configuration are used more often, move them to separate files, and reuse them using the <code class="literal">include</code> directive. In addition to that, try to make each file in your <a id="id95" class="indexterm"/>configuration file hierarchy of a reasonable length, ideally no more than two screens. This will help you to read your files quicker and navigate over them efficiently.<div class="note" title="Note" style=""><div class="inner"><h3 class="title"><a id="note09"/>Note</h3><p>It is important to know exactly how your configuration works to successfully manage it. If the configuration doesn't work the way you expect, you might run into issues due to wrong settings being applied, for example, unavailability of arbitrary URIs, unexpected outages, and security loopholes.</p></div></div></li><li class="listitem" style="list-style-type: disc">Minimize use of the <code class="literal">if</code> directive. The <code class="literal">if</code> directive has a nonintuitive behavior. Try <a id="id96" class="indexterm"/>to avoid using it whenever possible to make sure configuration settings are applied to the incoming requests as you expect.</li><li class="listitem" style="list-style-type: disc">Use good defaults. Experiment with inheritance rules and try to come up with defaults for your settings so that they result in the least number of directives to be configured. This includes moving common settings from location to the server level and further to the HTTP level.</li></ul></div></div></div>
<div class="section" title="Summary"><div class="titlepage"><div><div><h1 class="title"><a id="ch01lvl1sec10"/>Summary</h1></div></div></div><p>In this chapter, you learned how to install Nginx from a number of available sources, the structure of Nginx installation and the purpose of various files, the elements and structure of the Nginx configuration file, and how to create a minimal working Nginx configuration file. You also learned about some best practices for Nginx configuration.</p><p>In the next chapter, you will learn how to put Nginx into operation and how to manage it in action.</p></div></body></html>