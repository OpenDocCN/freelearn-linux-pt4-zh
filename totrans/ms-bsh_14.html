<html><head></head><body>
        <section>

                            <header>
                    </header><h1 class="header-title" id="calibre_pb_0">Time for Safety</h1>
                
            
            <article>
                
<p class="calibre1"><span><span>Safety is important, wherever we are. For example, in a construction site as in a newly built operating system, safety is a key factor to have things done the right way. Our shell is nothing different when it comes to safety: we spend most of our time inside our environment, trying to have things done, tasks running, and keep everything in order. This last chapter will give us some quick solutions and hints on how to strengthen it and preserve it from the most common issues using the shell. We will not use more advanced tools such as security or other kernel-level enhancement: such tools would require an entire book on their own, and they come after we clean up our shell. We will perform <em class="calibre20">housekeeping</em>, nothing really invasive, just a <em class="calibre20">finishing touch</em>, trying to find a balance between security, safety, and usability; and this is actually a hard goal: strengthen too much and even the easiest task will be almost impossible to be carried on. It will be be usable and probably our system will be too exposed or unsafe. We will try to hit the sweet spot, having a usable system, fairly safe and secure; but then it is up to the administrator of each system to decide what the balance should be: we can only advice a few tips and show what could be done.</span></span></p>


            </article>

            
        </section>
    

        <section>

                            <header>
                    </header><h1 class="header-title" id="calibre_pb_0">The restricted shell</h1>
                
            
            <article>
                
<p class="calibre1"><span><span>There are different ways to restrict what a user can do on a system and there are a lot of reasons why we would restrict a user's ability to interact with a system: maybe we want a user just to be able to copy a file to and from the system or to have a simple home where they can work on their tasks without peeking around the system. Anyway, whatever is our goal we can start working with a restrict shell.</span></span></p>
<p class="calibre1"><span><span>Bash itself offers an additional layer of security using the following options: </span></span></p>
<ul class="calibre12">
<li class="calibre13"><kbd class="calibre9"><span><span>rbash</span></span></kbd></li>
<li class="calibre13"><kbd class="calibre9"><span><span>--restricted</span></span></kbd></li>
<li class="calibre13"><kbd class="calibre9"><span><span>-r</span></span></kbd></li>
</ul>
<p class="calibre1"><span><span>Invoking <kbd class="calibre9">rbash</kbd> or simply <kbd class="calibre9">bash</kbd> with the <kbd class="calibre9">--restricted</kbd> or <kbd class="calibre9">-r</kbd> options spins a Bash instance that trims down what the users will be able to do on such an environment:</span></span></p>
<ul class="calibre12">
<li class="calibre13"><span><span>The user cannot change the directory using the <kbd class="calibre9">cd</kbd> builtin. </span></span><span>The user will be prevented to set or unset the values for the following environment variables:</span>
<ul class="calibre23">
<li class="calibre13"><kbd class="calibre9">BASH_ENV</kbd></li>
<li class="calibre13"><kbd class="calibre9">ENV</kbd></li>
<li class="calibre13"><kbd class="calibre9">SHELL</kbd></li>
<li class="calibre13"><kbd class="calibre9">PATH</kbd></li>
</ul>
</li>
<li class="calibre13"><span><span>The user will not be able to specify command names with slashes and this means no command names with absolute paths. </span></span><span><span>No filenames containing a slash can be passed as an argument to the built-in command called <kbd class="calibre9">.</kbd>. So, the user will not be able to source (the <kbd class="calibre9">read and execute</kbd> command from) a file from outside his home directory.</span></span></li>
<li class="calibre13"><span><span>No filename containing a slash can be passed as an argument to the builtin command called <kbd class="calibre9">hash</kbd> using the <kbd class="calibre9">-p</kbd> option. Hash determines the full filename of a command specified as an argument by searching into the directories specified by the environmental variable: <kbd class="calibre9">$PATH</kbd>. If <kbd class="calibre9">-p filename</kbd> is given as an option, hash would use the filename as the full path to the command searched. So, no commands invoked outside the home directory.</span></span></li>
<li class="calibre13"><span><span>No functions definitions are imported at the start from the shell environment.</span></span></li>
<li class="calibre13"><span><span>No value is taken into account from the environment SHELLOPTS variable at startup and so no shell options are set for the shell.</span></span></li>
<li class="calibre13"><span><span>No redirections are allowed using the standard operators <kbd class="calibre9">&gt;</kbd>, <kbd class="calibre9">&gt;|</kbd>, <kbd class="calibre9">&lt;&gt;</kbd>, <kbd class="calibre9">&gt;&amp;</kbd>, <kbd class="calibre9">&amp;&gt;</kbd>, <kbd class="calibre9">&gt;&gt;</kbd>.</span></span></li>
<li class="calibre13"><span><span>No exec built-in is available to replace the shell with a different command.</span></span></li>
<li class="calibre13"><span><span>It is not possible to add or delete builtin commands using the <kbd class="calibre9">enable</kbd> builtin with <kbd class="calibre9">-d</kbd> or <kbd class="calibre9">-f</kbd> options.</span></span></li>
<li class="calibre13"><span><span>It is not possible to use the <kbd class="calibre9">enable</kbd> built-in to enable or disable the Bash built-ins.</span></span></li>
<li class="calibre13"><span><span>The option <kbd class="calibre9">-p</kbd> is not allowed for the built-in command, so no <kbd class="calibre9">$PATH</kbd> manipulation is possible.</span></span></li>
<li class="calibre13"><span><span>It is impossible to turn off a restricted mode using <kbd class="calibre9">set +r</kbd> or <kbd class="calibre9">set +o restricted</kbd>.</span></span></li>
</ul>
<p class="calibre1"><span><span>So, with all these limits, the user is caged in its home directory. But how do you set up an <kbd class="calibre9">rbash login</kbd> shell? The easiest method is to find the Bash link and redirect it to <kbd class="calibre9">rbash</kbd>:</span></span></p>
<pre class="codepackt">
<strong class="calibre2">root:# which bash<br class="title-page-name"/></strong><strong class="calibre2">/bin/bash<br class="title-page-name"/></strong><strong class="calibre2">root:# which rbash<br class="title-page-name"/></strong><strong class="calibre2">/bin/rbash<br class="title-page-name"/></strong><strong class="calibre2">root:# ls -lah /bin/rbash <br class="title-page-name"/></strong><strong class="calibre2">lrwxrwxrwx 1 root root 4 Nov 5 2016 /bin/rbash -&gt; bash</strong>
</pre>
<p class="calibre1"><span><span>In this case, a link already exists between <kbd class="calibre9">rbash</kbd> and <kbd class="calibre9">bash</kbd>, but in this case there were not anyone of them, so we must create it:</span></span></p>
<pre class="codepackt">
<strong class="calibre2">root:# cd /bin<br class="title-page-name"/></strong><strong class="calibre2">root:# ln -s bash rbash</strong>
</pre>
<p class="calibre1"><span><span>Then, we have to check that <kbd class="calibre9">rbash</kbd> is listed in <kbd class="calibre9">/etc/shells</kbd> , which sports the full pathnames to valid login shells:</span></span></p>
<pre class="codepackt">
<strong class="calibre2">root:# cat /etc/shells <br class="title-page-name"/></strong><strong class="calibre2"># /etc/shells: valid login shells<br class="title-page-name"/></strong><strong class="calibre2">/bin/sh<br class="title-page-name"/></strong><strong class="calibre2">/bin/dash<br class="title-page-name"/></strong><strong class="calibre2">/bin/bash<br class="title-page-name"/></strong><strong class="calibre2">/bin/rbash</strong>
</pre>
<p class="calibre1"><span><span>Now, let's create a user with a restricted shell:</span></span></p>
<pre class="codepackt">
<strong class="calibre2">root:# adduser --shell /bin/rbash restricted<br class="title-page-name"/></strong><strong class="calibre2">Adding user `restricted' ...<br class="title-page-name"/></strong><strong class="calibre2">Adding new group `restricted' (1000) ...<br class="title-page-name"/></strong><strong class="calibre2">Adding new user `restricted' (1000) with group `restricted' ...<br class="title-page-name"/></strong><strong class="calibre2">Creating home directory `/home/restricted' ...<br class="title-page-name"/></strong><strong class="calibre2">Copying files from `/etc/skel' ...<br class="title-page-name"/></strong><strong class="calibre2">Enter new UNIX password: <br class="title-page-name"/></strong><strong class="calibre2">Retype new UNIX password: <br class="title-page-name"/></strong><strong class="calibre2">passwd: password updated successfully<br class="title-page-name"/></strong><strong class="calibre2">Changing the user information for restricted<br class="title-page-name"/></strong><strong class="calibre2">Enter the new value, or press ENTER for the default<br class="title-page-name"/></strong><strong class="calibre2">Full Name []: <br class="title-page-name"/></strong><strong class="calibre2">Room Number []: <br class="title-page-name"/></strong><strong class="calibre2">Work Phone []: <br class="title-page-name"/></strong><strong class="calibre2">Home Phone []: <br class="title-page-name"/></strong><strong class="calibre2">Other []: <br class="title-page-name"/></strong><strong class="calibre2">Is the information correct? [Y/n] y</strong>
</pre>
<p class="calibre1"><span><span>Once done, let's <kbd class="calibre9">su</kbd> to the user and test the <kbd class="calibre9">cd</kbd> command:</span></span></p>
<pre class="codepackt">
<strong class="calibre2">root:# cd /home/restricted<br class="title-page-name"/></strong><strong class="calibre2">root:# su restricted<br class="title-page-name"/></strong><strong class="calibre2">restricted:~$ cd<br class="title-page-name"/></strong><strong class="calibre2">restricted:~$ cd: restricted</strong>
</pre>
<p class="calibre1"><span><span>Here we are. The <kbd class="calibre9">cd</kbd> command is restricted as we expected it to be. Let's check some other restrictions:</span></span></p>
<pre class="codepackt">
<strong class="calibre2">restricted:~$ pwd<br class="title-page-name"/></strong><strong class="calibre2">/home/restricted<br class="title-page-name"/></strong><strong class="calibre2">restricted:~$ test "Redirection test"&gt; redirected_file<br class="title-page-name"/></strong><strong class="calibre2">rbash: redirected_file: restricted: cannot redirect output</strong>
</pre>
<p class="calibre1"><span><span>Nice, no redirections, though the cage is not really isolated:</span></span></p>
<pre class="codepackt">
<strong class="calibre2">restricted:~$ ls -lah /sbin/c*<br class="title-page-name"/></strong><strong class="calibre2">-rwxr-xr-x 1 root root 19K Mar 30 2015 /sbin/capsh<br class="title-page-name"/></strong><strong class="calibre2">-rwxr-xr-x 1 root root 243K Mar 29 2015 /sbin/cfdisk<br class="title-page-name"/></strong><strong class="calibre2">-rwxr-xr-x 1 root root 23K Mar 29 2015 /sbin/chcpu<br class="title-page-name"/></strong><strong class="calibre2">-rwxr-xr-x 1 root root 9.4K Aug 23 2014 /sbin/crda<br class="title-page-name"/></strong><strong class="calibre2">-rwxr-xr-x 1 root root 1.2K Jan 22 2015 /sbin/cryptdisks_start<br class="title-page-name"/></strong><strong class="calibre2">-rwxr-xr-x 1 root root 1.2K Jan 22 2015 /sbin/cryptdisks_stop<br class="title-page-name"/></strong><strong class="calibre2">-rwxr-xr-x 1 root root 58K Jan 22 2015 /sbin/cryptsetup<br class="title-page-name"/></strong><strong class="calibre2">-rwxr-xr-x 1 root root 45K Jan 22 2015 /sbin/cryptsetup-reencrypt<br class="title-page-name"/></strong><strong class="calibre2">-rwxr-xr-x 1 root root 11K Mar 29 2015 /sbin/ctrlaltdel</strong>
</pre>
<p class="calibre1"><span><span>The restricted user can still do something outside its directory. Let's override this using a local profile:</span></span></p>
<pre class="codepackt">
<strong class="calibre2">root:# mkdir /home/restricted/bin<br class="title-page-name"/></strong><strong class="calibre2">root:# ln -s /bin/df /home/restricted/bin/df</strong>
</pre>
<p class="calibre1"><span><span>Now let's delete <kbd class="calibre9">.bash_profile</kbd> or <kbd class="calibre9">.profile</kbd> we find in the home directory and create it, if it does not exist, the file </span></span><span><span><kbd class="calibre9">.bashrc</kbd> whose only line</span></span><span><span> should be:</span></span></p>
<pre class="codepackt">
<strong class="calibre2">PATH=$HOME/bin</strong>
</pre>
<p class="calibre1"><span><span>Now, let's prevent the user from modifying it:</span></span></p>
<pre class="codepackt">
<strong class="calibre2">root:# chown root. /home/restricted/.bashrc<br class="title-page-name"/></strong><strong class="calibre2">root:# chmod 755 /home/restricted/.bashrc</strong>
</pre>
<p class="calibre1"><span><span>And now let's <kbd class="calibre9">su</kbd>:</span></span></p>
<pre class="codepackt">
<strong class="calibre2">root:# su restricted</strong>
</pre>
<p class="calibre1"><span><span>And let's check what we can do:</span></span></p>
<pre class="codepackt">
<strong class="calibre2">restricted:~$ cd<br class="title-page-name"/></strong><strong class="calibre2">rbash: cd: restricted</strong>
</pre>
<p class="calibre1"><span><span>We are not allowed to do that, which we already know. Let's try to list some files:</span></span></p>
<pre class="codepackt">
<strong class="calibre2">restricted:~$ ls<br class="title-page-name"/></strong><strong class="calibre2">rbash: ls: command not found</strong>
</pre>
<p class="calibre1"><span><span>Great, no commands are available outside our <kbd class="calibre9">$HOME/bin</kbd>. Let's try again:</span></span></p>
<pre class="codepackt">
<strong class="calibre2">restricted:~$ ping<br class="title-page-name"/></strong><strong class="calibre2">rbash: ping: command not found</strong>
</pre>
<p class="calibre1"><span><span>As expected, there is another failure. Now let's try the <kbd class="calibre9">df</kbd> that command we linked inside our user's <kbd class="calibre9">$HOME/bin</kbd> directory:</span></span></p>
<pre class="codepackt">
<strong class="calibre2">restricted:~$ df<br class="title-page-name"/></strong><strong class="calibre2">Filesystem 1K-blocks Used Available Use% Mounted on<br class="title-page-name"/></strong><strong class="calibre2">/dev/sda1 117913932 12494776 99406436 12% /<br class="title-page-name"/></strong><strong class="calibre2">udev 10240 0 10240 0% /dev<br class="title-page-name"/></strong><strong class="calibre2">tmpfs 779256 9192 770064 2% /run<br class="title-page-name"/></strong><strong class="calibre2">tmpfs 1948140 0 1948140 0% /dev/shm<br class="title-page-name"/></strong><strong class="calibre2">tmpfs 5120 4 5116 1% /run/lock<br class="title-page-name"/></strong><strong class="calibre2">tmpfs 1948140 0 1948140 0% /sys/fs/cgroup<br class="title-page-name"/></strong><strong class="calibre2">tmpfs 389628 0 389628 0% /run/user/0</strong>
</pre>
<p class="calibre1"><span><span>This works, we successfully limited the commands the user has access to and restricted it to his home directory. Great, looks like it has been contained, but there are some limitations:</span></span></p>
<p class="calibre1"><span><span>The restricted user can escape this <em class="calibre20">cage</em> running a program, which has a shell function. A classical example is the <kbd class="calibre9">vi</kbd> editor:</span></span></p>
<pre class="codepackt">
<strong class="calibre2">restricted:~$ vi<br class="title-page-name"/></strong><strong class="calibre2">:set shell=/bin/bash<br class="title-page-name"/></strong><strong class="calibre2">:shell<br class="title-page-name"/></strong><strong class="calibre2">restricted:~$ pwd<br class="title-page-name"/></strong><strong class="calibre2">/home/restricted<br class="title-page-name"/></strong><strong class="calibre2">restricted:~$ cd /<br class="title-page-name"/></strong><strong class="calibre2">restricted:~$ ls -lah<br class="title-page-name"/></strong><strong class="calibre2">total 11G<br class="title-page-name"/></strong><strong class="calibre2">drwxr-xr-x 22 root root 4.0K Apr 17 06:32 .<br class="title-page-name"/></strong><strong class="calibre2">drwxr-xr-x 22 root root 4.0K Apr 17 06:32 ..<br class="title-page-name"/></strong><strong class="calibre2">drwxr-xr-x 2 root root 4.0K May 8 05:10 bin<br class="title-page-name"/></strong><strong class="calibre2">drwxr-xr-x 3 root root 4.0K Apr 16 07:51 boot<br class="title-page-name"/></strong><strong class="calibre2">drwxr-xr-x 19 root root 3.2K May 9 04:05 dev<br class="title-page-name"/></strong><strong class="calibre2">drwxr-xr-x 131 root root 12K May 8 05:34 etc<br class="title-page-name"/></strong><strong class="calibre2">drwxr-xr-x 4 root root 4.0K May 8 05:34 home<br class="title-page-name"/></strong><strong class="calibre2">lrwxrwxrwx 1 root root 31 Apr 16 06:14 initrd.img -&gt; /boot/initrd.img-3.16.0-4-amd64<br class="title-page-name"/></strong><strong class="calibre2">drwxr-xr-x 21 root root 4.0K Apr 17 03:59 lib<br class="title-page-name"/></strong><strong class="calibre2">drwxr-xr-x 2 root root 4.0K Apr 16 06:13 lib64<br class="title-page-name"/></strong><strong class="calibre2">drwx------ 2 root root 16K Apr 16 06:13 lost+found<br class="title-page-name"/></strong><strong class="calibre2">drwxr-xr-x 3 root root 4.0K Apr 16 06:13 media<br class="title-page-name"/></strong><strong class="calibre2">drwxr-xr-x 2 root root 4.0K Apr 16 06:13 mnt<br class="title-page-name"/></strong><strong class="calibre2">drwxr-xr-x 2 root root 4.0K Apr 16 06:13 opt<br class="title-page-name"/></strong><strong class="calibre2">-rw-r--r-- 1 root root 10G Apr 16 07:55 playground<br class="title-page-name"/></strong><strong class="calibre2">dr-xr-xr-x 113 root root 0 May 9 04:05 proc<br class="title-page-name"/></strong><strong class="calibre2">drwx------ 9 root root 4.0K May 9 04:07 root<br class="title-page-name"/></strong><strong class="calibre2">drwxr-xr-x 21 root root 840 May 9 04:10 run<br class="title-page-name"/></strong><strong class="calibre2">drwxr-xr-x 2 root root 4.0K Apr 17 03:59 sbin<br class="title-page-name"/></strong><strong class="calibre2">drwxr-xr-x 2 root root 4.0K Apr 16 06:13 srv<br class="title-page-name"/></strong><strong class="calibre2">dr-xr-xr-x 13 root root 0 May 9 04:05 sys<br class="title-page-name"/></strong><strong class="calibre2">drwxrwxrwt 8 root root 4.0K May 9 04:11 tmp<br class="title-page-name"/></strong><strong class="calibre2">drwxr-xr-x 10 root root 4.0K Apr 16 06:13 usr<br class="title-page-name"/></strong><strong class="calibre2">drwxr-xr-x 12 root root 4.0K Apr 16 06:32 var<br class="title-page-name"/></strong><strong class="calibre2">lrwxrwxrwx 1 root root 27 Apr 16 06:14 vmlinuz -&gt; boot/<br class="title-page-name"/>vmlinuz-3.16.0-4-amd64<br class="title-page-name"/></strong><strong class="calibre2">restricted:~$</strong>
</pre>
<p class="calibre1"><span><span>Another method to escape a restricted shell is to invoke an unrestricted shell:</span></span></p>
<pre class="codepackt">
<strong class="calibre2">restricted:~$ cd<br class="title-page-name"/></strong><strong class="calibre2">rbash: cd: restricted<br class="title-page-name"/></strong><strong class="calibre2">restricted:~$ bash<br class="title-page-name"/></strong><strong class="calibre2">restricted:~$ cd /<br class="title-page-name"/></strong><strong class="calibre2">restricted:~$ pwd<br class="title-page-name"/></strong><strong class="calibre2">/<br class="title-page-name"/></strong><strong class="calibre2">restricted:~$</strong>
</pre>
<p class="calibre1"><span><span>This also means that any script with a valid sha-bang will invoke a full-blown shell and escape any restrictions. All of these methods imply that the user has access either to Bash or to any programs featuring a shell function, otherwise jumping out from the cage would not be so easy. But we have to bear something important in mind: this is a method to cage some users in their working space, so it will separate them from each other, give them their own isolated home, and prevent them from inadvertently messing with other parts of the system. It is not a full-blown security layer hacker; for this kind of stuff, we should rely on something more at a kernel level, and it is outside the scope of this book, since it would require quite a long explanation about security, kernel compiling, third-party products, hardening, and so forth. Again, it is a book on its own.</span></span></p>
<p class="calibre1"><span><span>So, we want to keep things clean, and what can we do to host remote connections in an orderly manner?</span></span></p>


            </article>

            
        </section>
    

        <section>

                            <header>
                    </header><h1 class="header-title" id="calibre_pb_0">Restricted shells for OpenSSH</h1>
                
            
            <article>
                
<p class="calibre1"><span><span>Even though the restricted shell for OpenSSH (<a href="http://www.pizzashack.org/rssh/" class="calibre4">http://www.pizzashack.org/rssh/</a>) is not strictly a shell tool; its simplicity makes it a good candidate for helping to keep the house clean when some visitor knocks on wood. Rssh is available for a variety of distributions and platforms and offers a restricted shell allowing not only <kbd class="calibre9">scp</kbd> and <kbd class="calibre9">ftp</kbd>, but also <kbd class="calibre9">csv</kbd>, <kbd class="calibre9">rdist</kbd> , and <kbd class="calibre9">rsync</kbd>. So, we can create accounts available for file copy or synchronization without allowing a full shell access; and this can be handy to keep things on a low profile and lower the server exposure to attacks.</span></span></p>
<p class="calibre1"><span><span>The first step consists in installing rssh from a package or from a source. In our example, we will rely on a package since the distribution used, Debian, has one; and also,  using packages will ensure that the utility will be upgraded and patched by the maintainers whenever needed:</span></span></p>
<pre class="codepackt">
<strong class="calibre2">root:# apt-get install rssh<br class="title-page-name"/></strong><strong class="calibre2">Reading package lists... Done<br class="title-page-name"/></strong><strong class="calibre2">Building dependency tree <br class="title-page-name"/></strong><strong class="calibre2">Reading state information... Done<br class="title-page-name"/></strong><strong class="calibre2">Suggested packages:<br class="title-page-name"/></strong><strong class="calibre2">cvs rdist subversion makejail<br class="title-page-name"/></strong><strong class="calibre2">The following NEW packages will be installed:<br class="title-page-name"/></strong><strong class="calibre2">rssh<br class="title-page-name"/></strong><strong class="calibre2">0 upgraded, 1 newly installed, 0 to remove and 0 not upgraded.<br class="title-page-name"/></strong><strong class="calibre2">Need to get 54.4 kB of archives.<br class="title-page-name"/></strong><strong class="calibre2">After this operation, 119 kB of additional disk space will be used.<br class="title-page-name"/></strong><strong class="calibre2">Get:1 http://ftp.us.debian.org/debian/ jessie/main rssh amd64 2.3.4-4+b1 [54.4 kB]<br class="title-page-name"/></strong><strong class="calibre2">Fetched 54.4 kB in 0s (103 kB/s)<br class="title-page-name"/></strong><strong class="calibre2">Preconfiguring packages ...<br class="title-page-name"/></strong><strong class="calibre2">Selecting previously unselected package rssh.<br class="title-page-name"/></strong><strong class="calibre2">(Reading database ... 62697 files and directories currently installed.)<br class="title-page-name"/></strong><strong class="calibre2">Preparing to unpack .../rssh_2.3.4-4+b1_amd64.deb ...<br class="title-page-name"/></strong><strong class="calibre2">Unpacking rssh (2.3.4-4+b1) ...<br class="title-page-name"/></strong><strong class="calibre2">Processing triggers for man-db (2.7.0.2-5) ...<br class="title-page-name"/></strong><strong class="calibre2">Setting up rssh (2.3.4-4+b1) ...</strong>
</pre>
<p class="calibre1"><span><span>Once installed, we will have a new shell binary available:</span></span></p>
<pre class="codepackt">
<strong class="calibre2">root:# ls -lah /usr/bin/rssh <br class="title-page-name"/></strong><strong class="calibre2">-rwxr-xr-x 1 root root 31K Nov 8 2014 /usr/bin/rssh</strong>
</pre>
<p class="calibre1"><span><span>So, now let's use this new binary as the restricted user's shell:</span></span></p>
<pre class="codepackt">
<strong class="calibre2">root:# chsh -s `which rssh` restricted</strong>
</pre>
<p class="calibre1"><span><span>And let's verify directly on <kbd class="calibre9">/etc/passwd</kbd> that the shell has been assigned:</span></span></p>
<pre class="codepackt">
<strong class="calibre2">root:# egrep restricted /etc/passwd<br class="title-page-name"/></strong><strong class="calibre2">restricted:x:1000:1000:,,,:/home/restricted:/usr/bin/rssh</strong>
</pre>
<p class="calibre1"><span><span>It seems all OK, so let's connect from remote to the system where the restricted user resides:</span></span></p>
<pre class="codepackt">
<strong class="calibre2">zarrelli:~$ ssh -p 9999 restricted@192.168.0.5<br class="title-page-name"/></strong><strong class="calibre2">Warning: Permanently added '[192.168.0.5]:9999' (ECDSA) to the list of known hosts.<br class="title-page-name"/></strong><strong class="calibre2">Restricted@192.168.0.5's password: <br class="title-page-name"/></strong><strong class="calibre2">The programs included with the Debian GNU/Linux system are free software;<br class="title-page-name"/></strong><strong class="calibre2">the exact distribution terms for each program are described in the<br class="title-page-name"/></strong><strong class="calibre2">individual files in /usr/share/doc/*/copyright.<br class="title-page-name"/></strong><strong class="calibre2">Debian GNU/Linux comes with ABSOLUTELY NO WARRANTY, to the extent<br class="title-page-name"/></strong><strong class="calibre2">permitted by applicable law.<br class="title-page-name"/></strong><strong class="calibre2">This account is restricted by rssh.<br class="title-page-name"/></strong><strong class="calibre2">This user is locked out.<br class="title-page-name"/></strong><strong class="calibre2">If you believe this is in error, please contact your system administrator.<br class="title-page-name"/></strong><strong class="calibre2">Connection to 192.168.0.5 closed.</strong>
</pre>
<p class="calibre1"><span><span>The account is locked out and this is the default behavior of <kbd class="calibre9">rssh</kbd> since we did not configure it yet. So, let's see the main configuration directives that we can use inside the</span></span> <span><span><kbd class="calibre9">/etc/rssh.conf</kbd> </span></span><span><span>file to enable some protocols and per user configurations:</span></span></p>
<ul class="calibre12">
<li class="calibre13"><span><span><kbd class="calibre9">allowsftp</kbd>: Allows sftp connections.</span></span></li>
<li class="calibre13"><span><span><kbd class="calibre9">allowcvs</kbd>: Allows cvs connections.</span></span></li>
<li class="calibre13"><span><span><kbd class="calibre9">allowrdist</kbd>: Allows rdist connections.</span></span></li>
<li class="calibre13"><span><span><kbd class="calibre9">allowrsync</kbd>: Allows rsync connections.</span></span></li>
<li class="calibre13"><span><span><kbd class="calibre9">allowsvnserve</kbd>: Allows svnserve connections.</span></span></li>
<li class="calibre13"><span><span><kbd class="calibre9">umask</kbd>: Sets the umask for the files and directories created during a scp or sftp session. The umask is usually set by the shell upon user login, so to avoid this, rssh must set the umask itself.</span></span></li>
<li class="calibre13"><span><span><kbd class="calibre9">logfacility</kbd>: Specifies which syslog facility or C macros to use for logging.</span></span></li>
<li class="calibre13"><span><span><kbd class="calibre9">chrootpath</kbd>: A helper application for <kbd class="calibre9">rssh</kbd> (<kbd class="calibre9">rssh_chroot_helper</kbd>) calls the <kbd class="calibre9">chroot()</kbd> system call changing the root of the filesystem for the session. So, for example:  </span></span><span><span><kbd class="calibre9">chrootpath=/opt/jails</kbd> </span></span><span><span>will change the root of the virtual filesystem to </span></span><span><span><kbd class="calibre9">/opt/jails</kbd> </span></span><span><span>for the users whose shell is <kbd class="calibre9">rssh</kbd>.</span></span></li>
</ul>
<p class="calibre27"><span><span>After the login, the <kbd class="calibre9">/var/caged/users</kbd> directory will appear to the user as the root directory of the filesystem, and it will not be able to get outside of it. </span></span><span>If this directive is used, a <kbd class="calibre9">chroot</kbd> jail must be in place to provide the users a minimal environment. We will see later how to do it. If the user's home directory defined in <kbd class="calibre9">/etc/passwd</kbd> is inside the path specified by <kbd class="calibre9">chrootpath</kbd>, then the user will be <kbd class="calibre9">chdired</kbd> to his home directory, otherwise it will be <kbd class="calibre9">chdired</kbd> to the root of the <kbd class="calibre9">chroot</kbd> jail.</span></p>
<ul class="calibre12">
<li class="calibre13"><span><span><kbd class="calibre9">user</kbd>: With this directive, we can set a per user configuration that will override all others directives. The <kbd class="calibre9">user</kbd> keyword appears in a string separated in fields by colons (<kbd class="calibre9">:</kbd>) with the following structure:</span></span></li>
</ul>
<pre class="calibre21">
<strong class="calibre2">user = "username:unask:access_digits:chroot_path"</strong>
</pre>
<p class="calibre1"><span><span>So, let's see what each fields represents:</span></span></p>
<ul class="calibre12">
<li class="calibre13"><span><span><strong class="calibre2">username</strong>: This is the account name we want to set the configuration for.</span></span></li>
<li class="calibre13"><span><span><strong class="calibre2">umask</strong>: Is the umask expressed in octal for the user. It follows the same specification as if we were setting it for the Bash shell.</span></span></li>
<li class="calibre13"><span><span><strong class="calibre2">access_digits</strong>: These are six binary digits that specify if the user is allowed to use <kbd class="calibre9">rsync</kbd>, <kbd class="calibre9">rdist</kbd>, <kbd class="calibre9">cvs</kbd>, <kbd class="calibre9">sftp</kbd>, <kbd class="calibre9">scp</kbd> , and <kbd class="calibre9">svnserve</kbd> in the order listed.  <kbd class="calibre9">0</kbd> means the user is not allowed, a <kbd class="calibre9">1</kbd> means the user is allowed to use it.</span></span></li>
<li class="calibre13"><span><span><strong class="calibre2">path</strong>: It specifies the path to the directory the user will be chrooted in.</span></span></li>
</ul>
<p class="calibre1"><span><span>Quotes are not mandatory except when there are spaces in the path field. In this case, we can user either single or double quotes. Spaces around <kbd class="calibre9">=</kbd> are fine. So, something like </span></span><span><span><kbd class="calibre9">user=restricted:022:100000:</kbd> m</span></span><span><span>eans that the user restricted has a umask of <kbd class="calibre9">022</kbd> and has the <kbd class="calibre9">rsync</kbd> connections available. No <kbd class="calibre9">chroot</kbd> is specified:</span></span></p>
<pre class="codepackt">
<strong class="calibre2">user = restricted:011:000110:"/usr/local/chroot jails"</strong>
</pre>
<p class="calibre1"><span><span>The previous statement means that the user restricted has an umask of <kbd class="calibre9">011</kbd>, <kbd class="calibre9">sftp</kbd> , and <kbd class="calibre9">scp</kbd> connections available, and it will be chrooted in <kbd class="calibre9">/usr/local/chroot jails</kbd>.</span></span></p>
<p class="calibre1"><span><span>Knowing a bit more about configurations, let's enable just the <kbd class="calibre9">scp</kbd> connections for our restricted user by adding  <kbd class="calibre9">user = restricted:277:000010</kbd> to <kbd class="calibre9">/etc/rssh.conf</kbd>.</span></span></p>
<p class="calibre1"><span><span>Time to check whether we finally can access the remote system:</span></span></p>
<pre class="codepackt">
<strong class="calibre2">zarrelli:~$ ssh -p 9999 restricted@192.168.0.5<br class="title-page-name"/></strong><strong class="calibre2">Warning: Permanently added '[192.168.0.5]:9999' (ECDSA) to the list of known hosts.<br class="title-page-name"/></strong><strong class="calibre2">restricted@192.168.0.5's password: <br class="title-page-name"/></strong><strong class="calibre2">The programs included with the Debian GNU/Linux system are free software;<br class="title-page-name"/></strong><strong class="calibre2">the exact distribution terms for each program are described in the<br class="title-page-name"/></strong><strong class="calibre2">individual files in /usr/share/doc/*/copyright.<br class="title-page-name"/></strong><strong class="calibre2">Debian GNU/Linux comes with ABSOLUTELY NO WARRANTY, to the extent<br class="title-page-name"/></strong><strong class="calibre2">permitted by applicable law.<br class="title-page-name"/></strong><strong class="calibre2">Last login: Tue May 9 06:15:40 2017 from 192.168.0.10<br class="title-page-name"/></strong><strong class="calibre2">This account is restricted by rssh.<br class="title-page-name"/></strong><strong class="calibre2">Allowed commands: scp <br class="title-page-name"/></strong><strong class="calibre2">If you believe this is in error, please contact your system administrator.<br class="title-page-name"/></strong><strong class="calibre2">Connection to 192.168.0.5 closed.</strong>
</pre>
<p class="calibre1"><span><span>This is interesting. The message is slightly different from the previous attempt: we are still prevented to log into the remote server using ssh, but it states that although the account is restricted by rssh, we can use <kbd class="calibre9">scp</kbd>. So, let's try it:</span></span></p>
<pre class="codepackt">
<strong class="calibre2">zarrelli:~$ scp -P 9999 test_file restricted@192.168.0.5:<br class="title-page-name"/></strong><strong class="calibre2">Warning: Permanently added '[192.168.0.5]:9999' (ECDSA) to the list of known hosts.<br class="title-page-name"/></strong><strong class="calibre2">Restricted@192.168.0.5's password: <br class="title-page-name"/></strong><strong class="calibre2">test_file </strong>
</pre>
<p class="calibre1"><span><span>Well, it seems it worked. Let's have a look on the remote server:</span></span></p>
<pre class="codepackt">
<strong class="calibre2">root:# pwd<br class="title-page-name"/></strong><strong class="calibre2">/home/restricted<br class="title-page-name"/></strong><strong class="calibre2">root:# ls -lah test_file <br class="title-page-name"/></strong><strong class="calibre2">-r-------- 1 restricted rssh_users 0 May 10 05:24 test_file</strong>
</pre>
<p class="calibre1"><span><span>Here we go. In the home directory of the restricted user, we have our file with the access rights set to <kbd class="calibre9">400</kbd>, as expected. Nice and easy. But there is a small issue and we can see what it is about here:</span></span></p>
<div class="packt_figure"><span><span><img class="image-border2" src="../images/00047.jpeg"/></span></span></div>
<div class="packt_figref"><span><span>Using FileZilla we are able to browse the entire filesystem of the remote host</span></span></div>
<p class="calibre1"><span><span>Even though the user is limited to a protocol, he can browse the remote filesystem without any restrictions other than the Unix/POSIX file permissions. In the example shown, we enabled the SFTP protocol and actually connected to the system as the restricted user browsing, having a look at the <kbd class="calibre9">/etc</kbd> directory. Can we prevent this? Yes, we can <kbd class="calibre9">chroot</kbd> the user into, ideally, a filesystem on its own, mounted with <kbd class="calibre9">nosuid</kbd> and possibly with a <kbd class="calibre9">noxec</kbd> options if supported. This way, even if a user uploads an executable, he will not be able to run it and/or exploit any <kbd class="calibre9">suid</kbd> rights. Is it easy to do? No, creating a <kbd class="calibre9">chroot</kbd> jail can be really hard since it requires copying the relevant binaries and libraries into the jail itself; versions and paths can change depending on the distribution used and also the release itself. Actually, the source tarball of rssh offers a script, which with some modifications can actually help copying all the necessary files to the jail. There are also some other scripts that we can easily find on the internet and that will help us in this sensible job. Anyway, there is a much easier way to provide a restricted sftp access to a server, and we do not have to look so far away from our environment since we can accomplish this task simply using the OpenSSH server.</span></span></p>


            </article>

            
        </section>
    

        <section>

                            <header>
                    </header><h1 class="header-title" id="calibre_pb_0">Restricted sftp sessions with OpenSSH</h1>
                
            
            <article>
                
<p class="calibre1"><span><span>Using OpenSSH, everything can be easily done with five configuration lines and a few commands; let's see how. We are on the remote server.</span></span></p>
<p class="calibre1"><span><span>First, let's open the OpenSSH file, which is usually found in </span></span><span><span><kbd class="calibre9">/etc/ssh/sshd_config</kbd> </span></span><span><span>and add these few lines:</span></span></p>
<pre class="codepackt">
<strong class="calibre2">Match group sftp-only<br class="title-page-name"/></strong><strong class="calibre2">ChrootDirectory /opt/jails/%u/exchange<br class="title-page-name"/></strong><strong class="calibre2">X11Forwarding no<br class="title-page-name"/></strong><strong class="calibre2">AllowTcpForwarding no<br class="title-page-name"/></strong><strong class="calibre2">ForceCommand internal-sftp</strong>
</pre>
<p class="calibre1"><span><span>We should already know what these directives are, but let's recall what we wrote in <a target="_blank" href="part0194.html#5P0D40-8ae483f626fa439a8b6ee1bf9fb955ec" class="calibre4">Chapter 12</a>,<em class="calibre20"> </em></span></span><em class="calibre20">Remote Connections over SSH</em>, <span><span>about remote connections over ssh:</span></span></p>
<ul class="calibre12">
<li class="calibre13"><span><span><kbd class="calibre9">Match</kbd>: With this directive, we can use conditional statements so that if they are satisfied the following configuration lines, we will override the ones in the main configuration block. If a keyword/configuration block appears in more than one match clause, only the first instance is taken in to account. As matching criteria, we can use the following directives: user, group, host, local address, l local port, address, or all for all of them. We can match a list, patterns an negation. In our example, we are going to match against a group that we are going to create in a moment: whatever account belongs to the group sftp-only will be subjected to the following configuration lines.</span></span></li>
<li class="calibre13"><span><span><kbd class="calibre9">ChrootDirectory</kbd>: By specifying the full path to a directory, we can <kbd class="calibre9">chroot</kbd> a user into it after successful authentication. It is not an easy task since the directory must be owned by root and cannot be writable by anyone else. In addition, we must provide some files required for a session, like the shell, <kbd class="calibre9">/dev/null</kbd>, <kbd class="calibre9">/dev/zero</kbd>, <kbd class="calibre9">/dev/arandom</kbd>, <kbd class="calibre9">/dev/stdin</kbd>, <kbd class="calibre9">/dev/stdout</kbd>, <kbd class="calibre9">/dev/stderr</kbd>, and <kbd class="calibre9">/dev/ttyx</kbd>. We can also find some tokens such as <kbd class="calibre9">%h</kbd> standing for the home directory of the account authenticating, or we can also see <kbd class="calibre9">%%</kbd> , which stands for a simple <kbd class="calibre9">%</kbd>.  <kbd class="calibre9">%u</kbd> is replaced by the username. In our case, we do not have to provide any binaries, because we will allow sftp connections only, since there is no shell, there is no chance of executing anything.</span></span></li>
<li class="calibre13"><span><span><span><span><kbd class="calibre9">X11Forwarding</kbd>: This a</span></span><span><span>llows/denies the <kbd class="calibre9">X11</kbd> forwarding. If set to <kbd class="calibre9">yes</kbd> , it can expose <kbd class="calibre9">X11</kbd> to attacks; so this option must be taken with care. Defaults to <kbd class="calibre9">no</kbd>. We prevent the forwarding to <kbd class="calibre9">X11</kbd>: there is no need for it and it can expose the system.</span></span></span></span></li>
<li class="calibre13"><span><span><span><span><kbd class="calibre9">AllowTcpForwarding</kbd>: This a</span></span><span><span>llow/denies TCP forwarding and can take as argument <kbd class="calibre9">yes</kbd>, <kbd class="calibre9">all</kbd>, <kbd class="calibre9">no</kbd>, or</span></span></span></span> <kbd class="calibre9">local</kbd> and <kbd class="calibre9">remote</kbd><span><span><span><span>. The first two options allow the forwarding, the third denies it, and the <kbd class="calibre9">local</kbd> allows local forwarding only; <kbd class="calibre9">remote</kbd> enables remote forwarding only. There is no shell or TCP forwarding for our example.</span></span></span></span></li>
<li class="calibre13"><span><span><span><span><kbd class="calibre9">ForceCommand</kbd>: </span></span><span><span>Overrides any commands sent by the client or listed in the <kbd class="calibre9">~/.ssh/rc</kbd> of the authenticating account and forces the execution of the command listed in this directive. The command is executed through the account shell with the <kbd class="calibre9">-c</kbd> option. Defaults to <kbd class="calibre9">no</kbd>. In our case, we force the execution of the OpenSSH internal <kbd class="calibre9">sftp</kbd> subsystem.</span></span></span></span></li>
</ul>
<p class="calibre32"><span><span><span><span>Talking about the subsystem, let's verify that in the same config file OpenSSH is configured to use the <kbd class="calibre9">internal-sftp</kbd> subsystem:</span></span></span></span></p>
<pre class="calibre21">
<span><span><strong class="calibre2">Subsystem sftp internal-sftp</strong><span><span> </span></span></span></span>
</pre>
<p class="calibre27"><span><span><span><span>We may also want to add some more restrictions at the end of the configuration file:</span></span></span></span></p>
<pre class="calibre21">
<strong class="calibre2">PermitTunnel no<br class="title-page-name"/></strong><strong class="calibre2">AllowAgentForwarding no</strong>
</pre>
<ul class="calibre12">
<li class="calibre13"><span><span><span><span><kbd class="calibre9">AllowAgentForwarding</kbd>: </span></span><span><span>Defines whether ssh-agent forwarding is allowed or not. Defaults to <kbd class="calibre9">yes</kbd> to increase the security, and since it is not really needed for an <kbd class="calibre9">sftp</kbd> account, so we are going to disable it.</span></span></span></span></li>
<li class="calibre13"><span><span><span><span><kbd class="calibre9">PermitTunnel</kbd>: This a</span></span><span><span>llows/denies the tunnel device forwarding. It takes yes, point-to-point , Ethernet, or no as arguments. Yes enables both point-to-point and Ethernet forwarding. Defaults to no, and we want to be sure it is disabled since we do not need a tunnel for an sftp account.</span></span></span></span></li>
</ul>
<p class="calibre1"><span><span><span><span>Now that we have all the service bits in place, let's restart the OpenSSH server, in our case, this:</span></span></span></span></p>
<pre class="codepackt">
<strong class="calibre2">root:# service ssh restart</strong>
</pre>
<p class="calibre1"><span><span><span><span>Time to add our new group and move our restricted user there:</span></span></span></span></p>
<pre class="codepackt">
<strong class="calibre2">root:# addgroup sftp-only<br class="title-page-name"/></strong><strong class="calibre2">root:# service ssh restart<br class="title-page-name"/></strong><strong class="calibre2">root:# usermod -g sftp-only restricted<br class="title-page-name"/></strong><strong class="calibre2">root:# usermod -s /bin/false restricted</strong>
</pre>
<p class="calibre1"><span><span>So, now we have our restricted user added to the <kbd class="calibre9">sftp-only</kbd> group without a valid shell to log in to the system:</span></span></p>
<pre class="codepackt">
<strong class="calibre2">restricted:x:1000:1003:,,,:/home/restricted:/bin/false</strong>
</pre>
<p class="calibre1"><span><span>Now, let's make the user home directory owned by root so that the user would not be able to write into it:</span></span></p>
<pre class="codepackt">
<strong class="calibre2">root:# chown root. /home/restricted/</strong>
</pre>
<p class="calibre1"><span><span>And let's create a new home owned by <kbd class="calibre9">root</kbd>:</span></span></p>
<pre class="codepackt">
<strong class="calibre2">root:# mkdir -p /opt/sftp-jails/restricted/exchange<br class="title-page-name"/></strong><strong class="calibre2">root:# chown -R root. /opt/sftp-jails/</strong>
</pre>
<p class="calibre1"><span><span>Also let a subdir owned by the restricted user who can write to it:</span></span></p>
<pre class="codepackt">
<strong class="calibre2">root:# chown restricted.root /opt/sftp-jails/restricted/exchange<br class="title-page-name"/></strong><strong class="calibre2">root:# chmod 750 /opt/sftp-jails/restricted/exchange/</strong>
</pre>
<p class="calibre1"><span><span>All fine now, let's try to log in:</span></span></p>
<pre class="codepackt">
<strong class="calibre2">zarrelli:~$ ssh -p 9999 restricted@192.168.0.5<br class="title-page-name"/></strong><strong class="calibre2">Warning: Permanently added '[192.168.0.5]:9999' (ECDSA) to the list of known hosts.<br class="title-page-name"/></strong><strong class="calibre2">restricted@192.168.0.5's password: <br class="title-page-name"/></strong><strong class="calibre2">Could not chdir to home directory /home/restricted: No such file or directory<br class="title-page-name"/></strong><strong class="calibre2">This service allows sftp connections only.<br class="title-page-name"/></strong><strong class="calibre2">Connection to 192.168.0.5 closed.</strong>
</pre>
<p class="calibre1"><span><span>That is fine: we do not want a full shell for the restricted user, so let's try sftp:</span></span></p>
<pre class="codepackt">
<strong class="calibre2">zarrelli:~$ sftp -P 9999 restricted@192.168.0.5<br class="title-page-name"/></strong><strong class="calibre2">Warning: Permanently added '[192.168.0.5]:9999' (ECDSA) to the list of known hosts.<br class="title-page-name"/></strong><strong class="calibre2">Restricted@192.168.0.5's password: <br class="title-page-name"/></strong><strong class="calibre2">Connected to 192.168.0.5.<br class="title-page-name"/></strong><strong class="calibre2">sftp&gt; </strong>
</pre>
<p class="calibre1"><span><span>Great, we are in, but let's check what we can actually do:</span></span></p>
<pre class="codepackt">
<strong class="calibre2">sftp&gt; pwd<br class="title-page-name"/></strong><strong class="calibre2">Remote working directory: /<br class="title-page-name"/></strong><strong class="calibre2">sftp&gt; </strong>
</pre>
<p class="calibre1"><span><span>OK, we are in our remote root directory, but what is inside it?</span></span></p>
<pre class="codepackt">
<strong class="calibre2">sftp&gt; ls -lah<br class="title-page-name"/></strong><strong class="calibre2">drwxr-xr-x 0 0 0 4.0K May 11 14:56 .<br class="title-page-name"/></strong><strong class="calibre2">drwxr-xr-x 0 0 0 4.0K May 11 14:56 ..<br class="title-page-name"/></strong><strong class="calibre2">drwxr-x--- 0 1000 0 4.0K May 11 15:00 exchange</strong>
</pre>
<p class="calibre1"><span><span>This sounds familiar. It is the cage, so let's escape it:</span></span></p>
<pre class="codepackt">
<strong class="calibre2">sftp&gt; cd /<br class="title-page-name"/></strong><strong class="calibre2">sftp&gt; pwd<br class="title-page-name"/></strong><strong class="calibre2">Remote working directory: /<br class="title-page-name"/></strong><strong class="calibre2">sftp&gt; ls<br class="title-page-name"/></strong><strong class="calibre2">exchange <br class="title-page-name"/></strong><strong class="calibre2">sftp&gt; </strong>
</pre>
<p class="calibre1"><span><span>No, we actually cannot do so. At least, let's try to upload something:</span></span></p>
<pre class="codepackt">
<strong class="calibre2">sftp&gt; put test_file<br class="title-page-name"/></strong><strong class="calibre2">Uploading test_file to /test_file<br class="title-page-name"/></strong><strong class="calibre2">remote open("/test_file"): Permission denied<br class="title-page-name"/></strong><strong class="calibre2">sftp&gt; </strong>
</pre>
<p class="calibre1"><span><span>No way, the user's root directory is unwritable, so let's <kbd class="calibre9">cd</kbd> to the exchange directory and try the upload again:</span></span></p>
<pre class="codepackt">
<strong class="calibre2">sftp&gt; cd exchange<br class="title-page-name"/></strong><strong class="calibre2">sftp&gt; put test_file<br class="title-page-name"/></strong><strong class="calibre2">Uploading test_file to /exchange/test_file<br class="title-page-name"/></strong><strong class="calibre2">test_file 100% 0 0.0KB/s 00:00 <br class="title-page-name"/></strong><strong class="calibre2">sftp&gt; </strong>
</pre>
<p class="calibre1"><span><span>It definitely works. Let's get the file back:</span></span></p>
<pre class="codepackt">
<strong class="calibre2">sftp&gt; get test_file<br class="title-page-name"/></strong><strong class="calibre2">Fetching /exchange/test_file to test_file<br class="title-page-name"/></strong><strong class="calibre2">sftp&gt; bye</strong>
</pre>
<p class="calibre1"><span><span>Here we are, the account is ready for the customer to connect and share data. But what if we want to connect using a key for authentication?</span></span></p>
<p class="calibre1"><span><span>Let's first modify </span></span><span><span><kbd class="calibre9">/etc/ssh/ssd_config</kbd> by </span></span><span><span>adding the following line at the very end of the file:</span></span></p>
<pre class="codepackt">
<strong class="calibre2">AuthorizedKeysFile /opt/sftp-jails/authorized_keys/%u/authorized_keys</strong>
</pre>
<p class="calibre1"><span><span>This will be under the match condition and will be triggered for all the users of the <kbd class="calibre9">sftp-only</kbd> group; but for this to be taken in to account, we have to reload the configuration:</span></span></p>
<pre class="codepackt">
<strong class="calibre2">root:# service ssh restart</strong>
</pre>
<p class="calibre1"><span><span>So, since the new directive instructs OpenSSH to look for <kbd class="calibre9">authorized_keys</kbd> inside </span></span><span><kbd class="calibre9">/opt/sftp-jails/authorized_keys/{username}/authorized_keys</kbd> </span><span><span>for all the users belonging to the <kbd class="calibre9">sftp-only</kbd> group, let's start creating the correct directories:</span></span></p>
<pre class="codepackt">
<strong class="calibre2">root:# mkdir -p /opt/sftp-jails/authorized_keys/restricted</strong>
</pre>
<p class="calibre1"><span><span>This is the full path to the user directory holding the authentication key for the user that is restricted. We will have to create one of each user; and the name of the final directory must be the same as the username. Now, we have to trim ownership and access rights:</span></span></p>
<pre class="codepackt">
<strong class="calibre2">root:# cd /opt/sftp-jails<br class="title-page-name"/></strong><strong class="calibre2">root:# chown -R root.sftp-only authorized_keys<br class="title-page-name"/></strong><strong class="calibre2">root:# chown -R restricted.root authorized_keys/restricted</strong>
</pre>
<p class="calibre1"><span><span>The <kbd class="calibre9">authorized_keys</kbd> directory belongs to user root and the group: <kbd class="calibre9">sftp-only</kbd> , while the subdirectory restricted belongs to user restricted and group root:</span></span></p>
<pre class="codepackt">
<strong class="calibre2">root:# chmod 750 /opt/sftp-jails/authorized_keys/<br class="title-page-name"/></strong><strong class="calibre2">root:# chmod 500 /opt/sftp-jails/authorized_keys/restricted/</strong>
</pre>
<p class="calibre1"><span><span>All the users from the <kbd class="calibre9">sftp-only</kbd> group can traverse the <kbd class="calibre9">authorized_keys</kbd> directory, but only the restricted user can traverse the directory restricted. Now, let's copy our key example to the final destination:</span></span></p>
<pre class="codepackt">
<strong class="calibre2">root:# cp id_ecdsa_to_spoton.pub /opt/sftp-jails/authorized_keys/restricted/authorized_keys</strong>
</pre>
<p class="calibre1"><span><span>And now let's give it a correct ownership and access rights:</span></span></p>
<pre class="codepackt">
<strong class="calibre2">root:# chown restricted.root /opt/sftp-jails/authorized_keys/restricted/authorized_keys<br class="title-page-name"/></strong><strong class="calibre2">root:#chmod 400 /opt/sftp-jails/authorized_keys/restricted/authorized_keys</strong>
</pre>
<p class="calibre1"><span><span>So, we should end with such a configuration:</span></span></p>
<pre class="codepackt">
<strong class="calibre2">root:# cd /opt/<br class="title-page-name"/></strong><strong class="calibre2">root:# tree -pug <br class="title-page-name"/></strong><strong class="calibre2">.<br class="title-page-name"/></strong><strong class="calibre2">└── [drwxr-xr-x root root ] sftp-jails<br class="title-page-name"/></strong><strong class="calibre2">    ├── [drwxr-x--- root sftp-only] authorized_keys<br class="title-page-name"/></strong><strong class="calibre2">    │   └── [dr-x------ restricted root ] restricted<br class="title-page-name"/></strong><strong class="calibre2">    │       └── [-r-------- restricted root ] authorized_keys<br class="title-page-name"/></strong><strong class="calibre2">    └── [drwxr-xr-x root sftp-only] restricted<br class="title-page-name"/></strong><strong class="calibre2">        └── [drwxr-x--- restricted root ] exchange<br class="title-page-name"/></strong><strong class="calibre2">            └── [-rw-r--r-- restricted sftp-only] test_file</strong>
</pre>
<p class="calibre1"><span><span>Everything looks fine, so we just have to test what we have done so far. Let's go to the local server and try a connection on the remote server:</span></span></p>
<pre class="codepackt">
<strong class="calibre2">local_user:~$ sftp -i .ssh/id_ecdsa_to_spoton -P 9999 restricted@192.168.0.5<br class="title-page-name"/></strong><strong class="calibre2">Warning: Permanently added '[192.168.0.5]:9999' (ECDSA) to the list of known hosts.<br class="title-page-name"/></strong><strong class="calibre2">Connected to 192.168.0.5.<br class="title-page-name"/></strong><strong class="calibre2">sftp&gt; </strong>
</pre>
<p class="calibre1"><span><span>So, we are successfully connected using our identity key. We can then automate the connection adding the following snippet to the <kbd class="calibre9">.ssh/config</kbd> file of <kbd class="calibre9">local_user</kbd>:</span></span></p>
<pre class="codepackt">
<strong class="calibre2">Host spoton-sftp<br class="title-page-name"/></strong><strong class="calibre2">AddressFamily inet<br class="title-page-name"/></strong><strong class="calibre2">ConnectionAttempts 10<br class="title-page-name"/></strong><strong class="calibre2">ForwardAgent no<br class="title-page-name"/></strong><strong class="calibre2">ForwardX11 no<br class="title-page-name"/></strong><strong class="calibre2">ForwardX11Trusted no<br class="title-page-name"/></strong><strong class="calibre2">GatewayPorts no<br class="title-page-name"/></strong><strong class="calibre2">HostBasedAuthentication no<br class="title-page-name"/></strong><strong class="calibre2">HostKeyAlias sftp-alias<br class="title-page-name"/></strong><strong class="calibre2">HostName 192.168.0.5<br class="title-page-name"/></strong><strong class="calibre2">IdentityFile ~/.ssh/id_ecdsa_to_spoton<br class="title-page-name"/></strong><strong class="calibre2">PasswordAuthentication no<br class="title-page-name"/></strong><strong class="calibre2">Port 9999<br class="title-page-name"/></strong><strong class="calibre2">Protocol 2<br class="title-page-name"/></strong><strong class="calibre2">Compression yes<br class="title-page-name"/></strong><strong class="calibre2">CompressionLevel 9<br class="title-page-name"/></strong><strong class="calibre2">ServerAliveCountMax 3<br class="title-page-name"/></strong><strong class="calibre2">ServerAliveInterval 15<br class="title-page-name"/></strong><strong class="calibre2">TCPKeepAlive no<br class="title-page-name"/></strong><strong class="calibre2">User restricted</strong>
</pre>
<p class="calibre1"><span><span>Let's try a <kbd class="calibre9">ssh</kbd> connection:</span></span></p>
<pre class="codepackt">
<strong class="calibre2">local_user:~$ ssh spoton-sftp<br class="title-page-name"/></strong><strong class="calibre2">Warning: Permanently added 'sftp-alias,[192.168.0.5]:9999' (ECDSA) to the list of known hosts.<br class="title-page-name"/></strong><strong class="calibre2">Could not chdir to home directory /home/restricted: No such file or directory<br class="title-page-name"/></strong><strong class="calibre2">This service allows sftp connections only.<br class="title-page-name"/></strong><strong class="calibre2">Connection to 192.168.0.5 closed.</strong>
</pre>
<p class="calibre1"><span><span>This is correct, we should not be allowed to connect over <kbd class="calibre9">ssh</kbd> with shell or access a home directory.</span></span></p>
<p class="calibre1"><span><span>Let's try an <kbd class="calibre9">sftp</kbd> connection:</span></span></p>
<pre class="codepackt">
<strong class="calibre2">local_user:~$ sftp spoton-sftp<br class="title-page-name"/></strong><strong class="calibre2">Warning: Permanently added 'sftp-alias,[192.168.0.5]:9999' (ECDSA) to the list of known hosts.<br class="title-page-name"/></strong><strong class="calibre2">Connected to spoton-sftp.</strong>
</pre>
<p class="calibre1"><span><span>Great, we are connected using our identity key and with no user or file or IP address specified. So, let's make some test:</span></span></p>
<pre class="codepackt">
<strong class="calibre2">sftp&gt; pwd<br class="title-page-name"/></strong><strong class="calibre2">Remote working directory: /</strong>
</pre>
<p class="calibre1"><span><span>We are in our user root directory; let's try to climb up to the system root directory:</span></span></p>
<pre class="codepackt">
<strong class="calibre2">sftp&gt; cd /<br class="title-page-name"/></strong><strong class="calibre2">sftp&gt; pwd<br class="title-page-name"/></strong><strong class="calibre2">Remote working directory: /<br class="title-page-name"/></strong><strong class="calibre2">sftp&gt; ls<br class="title-page-name"/></strong><strong class="calibre2">exchange </strong>
</pre>
<p class="calibre1"><span><span>No way, we are caged into our root directory and cannot go to any upper levels. Let's look for a file to upload:</span></span></p>
<pre class="codepackt">
<strong class="calibre2">sftp&gt; !ls<br class="title-page-name"/></strong><strong class="calibre2">test_local</strong>
</pre>
<p class="calibre1"><span><span>Let's try to upload it to the home directory:</span></span></p>
<pre class="codepackt">
<strong class="calibre2">sftp&gt; put test_local<br class="title-page-name"/></strong><strong class="calibre2">Uploading test_local to /test_local<br class="title-page-name"/></strong><strong class="calibre2">remote open("/test_local"): Permission denied</strong>
</pre>
<p class="calibre1"><span><span>We have no permission, as expected. We need to use the exchange subdirectory for our purposes:</span></span></p>
<pre class="codepackt">
<strong class="calibre2">sftp&gt; cd exchange<br class="title-page-name"/></strong><strong class="calibre2">sftp&gt; put test_local<br class="title-page-name"/></strong><strong class="calibre2">Uploading test_local to /exchange/test_local<br class="title-page-name"/></strong><strong class="calibre2">test_local 100% 0 0.0KB/s 00:00 </strong>
</pre>
<p class="calibre1"><span><span>Successfully uploaded! Now, let's see what is inside the exchange directory:</span></span></p>
<pre class="codepackt">
<strong class="calibre2">sftp&gt; ls<br class="title-page-name"/></strong><strong class="calibre2">test_file test_local <br class="title-page-name"/></strong><strong class="calibre2">Ok, we have the old and the new file. Let's grab the old file:<br class="title-page-name"/></strong><strong class="calibre2">sftp&gt; get test_file<br class="title-page-name"/></strong><strong class="calibre2">Fetching /exchange/test_file to test_file<br class="title-page-name"/></strong><strong class="calibre2">sftp&gt; </strong>
</pre>
<p class="calibre1"><span><span>Done! Everything looks fine. Or something like that since we are blind on what happens during the connection. Since everything is in an isolated cage, there is no way to use a system facility such as <kbd class="calibre9">rsyslog</kbd> to actually record what the user is doing during an <kbd class="calibre9">sftp</kbd> session. Or, at least, the normal <kbd class="calibre9">rsyslog</kbd> configuration is not able to do this, but there are a few methods to work around this limitation. One that we are going to see  involves the use of a pipe; it will make things really easy. First, let's modify a couple of directives in </span></span><span><kbd class="calibre9">/etc/ssh/sshd_config</kbd>.</span></p>
<p class="calibre1"><span><span>The old <kbd class="calibre9">Subsystem</kbd> and <kbd class="calibre9">ForceCommand</kbd> now must be rewritten as:</span></span></p>
<pre class="codepackt">
<strong class="calibre2">Subsystem sftp internal-sftp -l INFO<br class="title-page-name"/></strong><strong class="calibre2">ForceCommand internal-sftp -l INFO</strong>
</pre>
<p class="calibre1"><span><span>Now the <kbd class="calibre9">internal-sftp</kbd> will log with a level of <kbd class="calibre9">INFO</kbd>, so we have to export this information to the main log using a socket. So, let's create a file:</span></span></p>
<pre class="codepackt">
<strong class="calibre2">root:# cat /etc/rsyslog.d/openssh-sftp.conf <br class="title-page-name"/></strong><strong class="calibre2">module(load="imuxsock")<br class="title-page-name"/></strong><strong class="calibre2">input(type="imuxsock" Socket="/opt/sftp-jails/restricted/dev/log" CreatePath="on")<br class="title-page-name"/></strong><strong class="calibre2">if $programname == 'internal-sftp' then /var/log/openssh-sftp.log<br class="title-page-name"/></strong><strong class="calibre2">&amp; stop</strong>
</pre>
<p class="calibre1"><span><span>So, what we have done is instruct <kbd class="calibre9">rsyslog</kbd> to create a Unix socket in in the <kbd class="calibre9">/dev</kbd> directory of the restricted user; and the <kbd class="calibre9">sftp</kbd> subsystem will be able to send the log messages to <kbd class="calibre9">rsyslog</kbd> using that socket. Yes, but how are these messages written? They are written by simply accessing one of the properties of the message itself. In this case, if the name of the program that generated the messages is <kbd class="calibre9">internal-sftp</kbd>, then the message is written on <kbd class="calibre9">/var/log/openssh-sftp.log</kbd>. Once done, let's restart both <kbd class="calibre9">sshd</kbd> and <kbd class="calibre9">rsyslog</kbd>:</span></span></p>
<pre class="codepackt">
<strong class="calibre2">root:# service ssh restart<br class="title-page-name"/></strong><strong class="calibre2">root:# service rsyslog restart</strong>
</pre>
<div class="packt_infobox"><span class="calibre30">If you receive a message from <kbd class="calibre28">rsyslog</kbd> complaining about the <kbd class="calibre28">imuxsock</kbd> module already being loaded, just comment out the first line with <kbd class="calibre28">#</kbd>.</span></div>
<p class="calibre1"><span><span>Now, we just have to make another connection and issue some commands in order to populate the log file:</span></span></p>
<pre class="codepackt">
<strong class="calibre2">root:# cat /var/log/openssh-sftp.log <br class="title-page-name"/></strong><strong class="calibre2">May 11 14:28:25 spoton internal-sftp[16080]: session opened for local user restricted from [192.168.0.10]<br class="title-page-name"/></strong><strong class="calibre2">May 11 14:28:26 spoton internal-sftp[16080]: opendir "/"<br class="title-page-name"/></strong><strong class="calibre2">May 11 14:28:26 spoton internal-sftp[16080]: closedir "/"<br class="title-page-name"/></strong><strong class="calibre2">May 11 14:28:35 spoton internal-sftp[16080]: opendir "/exchange"<br class="title-page-name"/></strong><strong class="calibre2">May 11 14:28:35 spoton internal-sftp[16080]: closedir "/exchange"<br class="title-page-name"/></strong><strong class="calibre2">May 11 14:28:39 spoton internal-sftp[16080]: open "/exchange/test_file" flags READ mode 0666<br class="title-page-name"/></strong><strong class="calibre2">May 11 14:28:39 spoton internal-sftp[16080]: close "/exchange/test_file" bytes read 0 written 0<br class="title-page-name"/></strong><strong class="calibre2">May 11 14:28:42 spoton internal-sftp[16080]: open "/exchange/test_file" flags WRITE,CREATE,TRUNCATE mode 0644<br class="title-page-name"/></strong><strong class="calibre2">May 11 14:28:42 spoton internal-sftp[16080]: sent status Permission denied<br class="title-page-name"/></strong><strong class="calibre2">May 11 14:29:00 spoton internal-sftp[16080]: opendir "/exchange"<br class="title-page-name"/></strong><strong class="calibre2">May 11 14:29:00 spoton internal-sftp[16080]: closedir "/exchange"<br class="title-page-name"/></strong><strong class="calibre2">May 11 14:29:05 spoton internal-sftp[16080]: remove name "/exchange/test_file"<br class="title-page-name"/></strong><strong class="calibre2">May 11 14:29:06 spoton internal-sftp[16080]: opendir "/exchange"<br class="title-page-name"/></strong><strong class="calibre2">May 11 14:29:06 spoton internal-sftp[16080]: closedir "/exchange"<br class="title-page-name"/></strong><strong class="calibre2">May 11 14:29:09 spoton internal-sftp[16080]: open "/exchange/test_file" flags WRITE,CREATE,TRUNCATE mode 0644<br class="title-page-name"/></strong><strong class="calibre2">May 11 14:29:09 spoton internal-sftp[16080]: close "/exchange/test_file" bytes read 0 written 0<br class="title-page-name"/></strong><strong class="calibre2">May 11 14:29:10 spoton internal-sftp[16080]: opendir "/exchange"<br class="title-page-name"/></strong><strong class="calibre2">May 11 14:29:10 spoton internal-sftp[16080]: closedir "/exchange"<br class="title-page-name"/></strong><strong class="calibre2">May 11 14:30:45 spoton internal-sftp[16080]: session closed for local user restricted from [192.168.0.10]</strong>
</pre>
<p class="calibre1"><span><span>That's it. Now we have a nice log showing us what the user has done during his <kbd class="calibre9">sftp</kbd> session; and the log itself is out of reach of any <kbd class="calibre9">sftp</kbd> users. In our example, we redirected the messages based on the name of the program, which created them; but we have other tags we can use to filter. So, let's see the more useful ones:</span></span></p>
<ul class="calibre12">
<li class="calibre13"><span><span><kbd class="calibre9">HOSTNAME</kbd>: The hostname as it appears in the message.</span></span></li>
<li class="calibre13"><span><span><kbd class="calibre9">FROMHOST</kbd>: The hostname of the system the message was received from. In a chained configuration, this is the system next to the receiver, not necessarily the first sender.</span></span></li>
<li class="calibre13"><span><span><kbd class="calibre9">syslogfacility</kbd>: The facility reported by the message in numerical form.</span></span></li>
<li class="calibre13"><span><span><kbd class="calibre9">syslogfacility-text</kbd>: The facility reported by the message in text form.</span></span></li>
<li class="calibre13"><span><span><kbd class="calibre9">syslogseverity</kbd>: The severity reported by the message in numerical form.</span></span></li>
<li class="calibre13"><span><span><kbd class="calibre9">syslogseverity-text</kbd>: The severity reported by the message in text form.</span></span></li>
</ul>
<p class="calibre1"><span><span>By using these properties, we can do something interesting. Let's start creating another user with the same group and shell as restricted:</span></span></p>
<pre class="codepackt">
<strong class="calibre2">root:# adduser --shell /bin/false --gid 1003 casualuser<br class="title-page-name"/></strong><strong class="calibre2">Adding user `casualuser' ...<br class="title-page-name"/></strong><strong class="calibre2">Adding new user `casualuser' (1003) with group `sftp-only' ...<br class="title-page-name"/></strong><strong class="calibre2">Creating home directory `/home/casualuser' ...<br class="title-page-name"/></strong><strong class="calibre2">Copying files from `/etc/skel' ...<br class="title-page-name"/></strong><strong class="calibre2">Enter new UNIX password: <br class="title-page-name"/></strong><strong class="calibre2">Retype new UNIX password: <br class="title-page-name"/></strong><strong class="calibre2">passwd: password updated successfully<br class="title-page-name"/></strong><strong class="calibre2">Changing the user information for casualuser<br class="title-page-name"/></strong><strong class="calibre2">Enter the new value, or press ENTER for the default<br class="title-page-name"/></strong><strong class="calibre2">Full Name []: <br class="title-page-name"/></strong><strong class="calibre2">Room Number []: <br class="title-page-name"/></strong><strong class="calibre2">Work Phone []: <br class="title-page-name"/></strong><strong class="calibre2">Home Phone []: <br class="title-page-name"/></strong><strong class="calibre2">Other []: <br class="title-page-name"/></strong><strong class="calibre2">Is the information correct? [Y/n] </strong>
</pre>
<p class="calibre1"><span><span>Now, let's change the home directory owner for the user's home directory:</span></span></p>
<pre class="codepackt">
<strong class="calibre2">root:# chown -R root. /home/casualuser/</strong>
</pre>
<p class="calibre1"><span><span>Let's create the new jail copying the one we already have:</span></span></p>
<pre class="codepackt">
<strong class="calibre2">root:# cd /opt/sftp-jails<br class="title-page-name"/></strong><strong class="calibre2"> root:# cp -ra restricted/ casualuser</strong>
</pre>
<p class="calibre1"><span><span>We just have to fix the ownership now:</span></span></p>
<pre class="codepackt">
<strong class="calibre2">root:# cd casualuser<br class="title-page-name"/></strong><strong class="calibre2">root:# chown -R casualuser.root exchange/<br class="title-page-name"/></strong><strong class="calibre2">root:# cd exchange<br class="title-page-name"/></strong><strong class="calibre2">root:# chown casualuser.sftp-only *</strong>
</pre>
<p class="calibre1"><span><span>Time for copying the keys:</span></span></p>
<pre class="codepackt">
<strong class="calibre2">root:# cd /opt/sftp-jails/authorized_keys<br class="title-page-name"/></strong><strong class="calibre2">root:# cp -ra restricted casualuser<br class="title-page-name"/></strong><strong class="calibre2">root:# chown -R casualuser.root casualuser/</strong>
</pre>
<p class="calibre1"><span><span>In our example, for brevity, we are using the same key as the restricted user, but we can always create a new key and copy over the <kbd class="calibre9">authorized_keys</kbd> file to give each user their own key. Once done, let's try a connection:</span></span></p>
<pre class="codepackt">
<strong class="calibre2">local_user:~$ sftp -i .ssh/id_ecdsa_to_spoton -P 9999 casualuser@192.168.0.5 <br class="title-page-name"/></strong><strong class="calibre2">Warning: Permanently added '[192.168.0.5]:9999' (ECDSA) to the list of known hosts.<br class="title-page-name"/></strong><strong class="calibre2">Connected to 192.168.0.5.<br class="title-page-name"/></strong><strong class="calibre2">sftp&gt; ls<br class="title-page-name"/></strong><strong class="calibre2">dev exchange <br class="title-page-name"/></strong><strong class="calibre2">sftp&gt; !ls<br class="title-page-name"/></strong><strong class="calibre2">test_file test_local<br class="title-page-name"/></strong><strong class="calibre2">sftp&gt; put test_file<br class="title-page-name"/></strong><strong class="calibre2">Uploading test_file to /test_file<br class="title-page-name"/></strong><strong class="calibre2">remote open("/test_file"): Permission denied<br class="title-page-name"/></strong><strong class="calibre2">sftp&gt; cd exchange<br class="title-page-name"/></strong><strong class="calibre2">sftp&gt; put test_file<br class="title-page-name"/></strong><strong class="calibre2">Uploading test_file to /exchange/test_file<br class="title-page-name"/></strong><strong class="calibre2">test_file <br class="title-page-name"/></strong><strong class="calibre2">sftp&gt;</strong>
</pre>
<p class="calibre1"><span><span>OK, the user can access and has the right permissions, but what about logging? Nothing, we did not set up anything for logging, so let's modify </span></span><span><span><kbd class="calibre9">/etc/rsyslog.d/openssh-sftp.conf</kbd> by a</span></span><span><span>dding the following line:</span></span></p>
<pre class="codepackt">
<strong class="calibre2">input(type="imuxsock" Socket="/opt/sftp-jails/casualuser/dev/log" CreatePath="on")</strong>
</pre>
<p class="calibre1"><span><span>Now, to get the new instructions taken in account, let's restart <kbd class="calibre9">rsyslog</kbd>:</span></span></p>
<pre class="codepackt">
<strong class="calibre2">service rsyslog restart</strong>
</pre>
<p class="calibre1"><span><span>And let's connect again to generate some logging lines:</span></span></p>
<pre class="codepackt">
<strong class="calibre2">local_user:~$ sftp -i .ssh/id_ecdsa_to_spoton -P 9999 casualuser@192.168.0.5<br class="title-page-name"/></strong><strong class="calibre2">Warning: Permanently added '[192.168.0.5]:9999' (ECDSA) to the list of known hosts.<br class="title-page-name"/></strong><strong class="calibre2">Connected to 192.168.0.5.<br class="title-page-name"/></strong><strong class="calibre2">sftp&gt; ls<br class="title-page-name"/></strong><strong class="calibre2">dev exchange <br class="title-page-name"/></strong><strong class="calibre2">sftp&gt; cd exchange<br class="title-page-name"/></strong><strong class="calibre2">sftp&gt; ls<br class="title-page-name"/></strong><strong class="calibre2">test_file test_local <br class="title-page-name"/></strong><strong class="calibre2">sftp&gt; get test_local<br class="title-page-name"/></strong><strong class="calibre2">Fetching /exchange/test_local to test_local<br class="title-page-name"/></strong><strong class="calibre2">sftp&gt; bye</strong>
</pre>
<p class="calibre1"><span><span>Let's check the log file:</span></span></p>
<pre class="codepackt">
<strong class="calibre2">May 12 04:02:04 spoton internal-sftp[18573]: session opened for local user casualuser from [192.168.0.10]<br class="title-page-name"/></strong><strong class="calibre2">May 12 04:02:06 spoton internal-sftp[18573]: opendir "/"<br class="title-page-name"/></strong><strong class="calibre2">May 12 04:02:06 spoton internal-sftp[18573]: closedir "/"<br class="title-page-name"/></strong><strong class="calibre2">May 12 04:02:11 spoton internal-sftp[18573]: opendir "/exchange"<br class="title-page-name"/></strong><strong class="calibre2">May 12 04:02:11 spoton internal-sftp[18573]: closedir "/exchange"<br class="title-page-name"/></strong><strong class="calibre2">May 12 04:02:15 spoton internal-sftp[18573]: open "/exchange/test_local" flags READ mode 0666<br class="title-page-name"/></strong><strong class="calibre2">May 12 04:02:15 spoton internal-sftp[18573]: close "/exchange/test_local" bytes read 0 written 0<br class="title-page-name"/></strong><strong class="calibre2">May 12 04:02:18 spoton internal-sftp[18573]: session closed for local user casualuser from [192.168.35.219]<br class="title-page-name"/></strong><strong class="calibre2">May 12 04:06:45 spoton internal-sftp[18631]: session opened for local user casualuser from [192.168.0.10]</strong>
</pre>
<p class="calibre1"><span><span>This is what is expected. We created a Unix socket in the new user's jail; and we are receiving the messages sent by the <kbd class="calibre9">internal-sftp</kbd> subsystem for the account session. Nice, but confusing. All the log messages from all the users will be contained in a single file, and since the command messages such as </span></span><span><span><kbd class="calibre9">May 12 04:02:11 spoton internal-sftp[18573]: closedir "/exchange"</kbd> a</span></span><span><span>re not identified by a user account name, but from a session ID [18631], it is feasible to follow all the actions performed during a session and trace them back to the user who made them.</span></span><span><span> But overall, it is not so easy to read. What can we do? Well, as always we have to use a bit of imagination and creativity and bend the rules to take some advantages. Let's tinker with the <kbd class="calibre9">rsyslog</kbd> config file for <kbd class="calibre9">openssh-sftp</kbd>:</span></span></p>
<pre class="codepackt">
<strong class="calibre2">/etc/rsyslog.d/openssh-sftp.conf</strong>
</pre>
<p class="calibre1"><span><span>Let's open it and replace its content with the following lines:</span></span></p>
<pre class="codepackt">
<strong class="calibre2">#module(load="imuxsock")<br class="title-page-name"/></strong><strong class="calibre2">input(type="imuxsock" HOSTNAME="restricted" Socket="/opt/sftp-jails/restricted/dev/log" CreatePath="on")<br class="title-page-name"/></strong><strong class="calibre2">input(type="imuxsock" HostName="casualuser" Socket="/opt/sftp-jails/casualuser/dev/log" CreatePath="on")<br class="title-page-name"/></strong><strong class="calibre2">if $hostname == 'restricted' then /var/log/openssh-sftp/restricted-sftp.log<br class="title-page-name"/></strong><strong class="calibre2">if $hostname == 'casualuser' then /var/log/openssh-sftp/casualuser-sftp.log<br class="title-page-name"/></strong><strong class="calibre2">&amp; stop</strong>
</pre>
<p class="calibre1"><span><span>What did we do? We used a property manipulation string, which allowed us to associate a hostname property to the messages coming from a specific socket. Then, we added two rules to redirect the messages to a per user log file, based on the hostname property found in the messages themselves. We intentionally wrote the hostname property with different cases to show that the property name is case insensitive. Time to restart <kbd class="calibre9">rsyslogd</kbd>:</span></span></p>
<pre class="codepackt">
<strong class="calibre2">root:# service rsyslog restart</strong>
</pre>
<p class="calibre1"><span><span>The logging facility is ready, let's connect again and make some <em class="calibre20">noise</em>:</span></span></p>
<pre class="codepackt">
<strong class="calibre2">local_user:~$ sftp -i .ssh/id_ecdsa_to_spoton -P 9999 casualuser@192.168.0.5<br class="title-page-name"/></strong><strong class="calibre2">Warning: Permanently added '[192.168.0.5]:9999' (ECDSA) to the list of known hosts.<br class="title-page-name"/></strong><strong class="calibre2">Connected to 192.168.0.5.<br class="title-page-name"/></strong><strong class="calibre2">sftp&gt; ls<br class="title-page-name"/></strong><strong class="calibre2">dev exchange <br class="title-page-name"/></strong><strong class="calibre2">sftp&gt; cd exchange<br class="title-page-name"/></strong><strong class="calibre2">sftp&gt; ls<br class="title-page-name"/></strong><strong class="calibre2">test_file test_local <br class="title-page-name"/></strong><strong class="calibre2">sftp&gt; get test_local<br class="title-page-name"/></strong><strong class="calibre2">Fetching /exchange/test_local to test_local<br class="title-page-name"/></strong><strong class="calibre2">sftp&gt; cd ..<br class="title-page-name"/></strong><strong class="calibre2">sftp&gt; put test_file<br class="title-page-name"/></strong><strong class="calibre2">Uploading test_file to /test_file<br class="title-page-name"/></strong><strong class="calibre2">remote open("/test_file"): Permission denied<br class="title-page-name"/></strong><strong class="calibre2">sftp&gt; cd /<br class="title-page-name"/></strong><strong class="calibre2">sftp&gt; </strong>
</pre>
<p class="calibre1"><span><span>Now is the time to check:</span></span></p>
<pre class="codepackt">
<strong class="calibre2">root:# ls -lah /var/log/openssh-sftp/casualuser-sftp.log <br class="title-page-name"/></strong><strong class="calibre2">-rw-r----- 1 root adm 757 May 12 05:14 /var/log/openssh-sftp/casualuser-sftp.log</strong>
</pre>
<p class="calibre1"><span><span>We connected as casualuser, and indeed we see a file named <kbd class="calibre9">casualuser-sftp.log</kbd> exactly where we expected to find it. Let's have a look at what is inside:</span></span></p>
<pre class="codepackt">
<strong class="calibre2">root:# cat /var/log/openssh-sftp/casualuser-sftp.log <br class="title-page-name"/></strong><strong class="calibre2">May 12 05:13:48 casualuser internal-sftp[19004]: session opened for local user casualuser from [192.168.0.10]<br class="title-page-name"/></strong><strong class="calibre2">May 12 05:13:49 casualuser internal-sftp[19004]: opendir "/"<br class="title-page-name"/></strong><strong class="calibre2">May 12 05:13:49 casualuser internal-sftp[19004]: closedir "/"<br class="title-page-name"/></strong><strong class="calibre2">May 12 05:13:54 casualuser internal-sftp[19004]: opendir "/exchange"<br class="title-page-name"/></strong><strong class="calibre2">May 12 05:13:54 casualuser internal-sftp[19004]: closedir "/exchange"<br class="title-page-name"/></strong><strong class="calibre2">May 12 05:14:13 casualuser internal-sftp[19004]: open "/exchange/test_local" flags READ mode 0666<br class="title-page-name"/></strong><strong class="calibre2">May 12 05:14:13 casualuser internal-sftp[19004]: close "/exchange/test_local" bytes read 0 written 0<br class="title-page-name"/></strong><strong class="calibre2">May 12 05:14:23 casualuser internal-sftp[19004]: open "/test_file" flags WRITE,CREATE,TRUNCATE mode 0644<br class="title-page-name"/></strong><strong class="calibre2">May 12 05:14:23 casualuser internal-sftp[19004]: sent status Permission denied<br class="title-page-name"/></strong><strong class="calibre2">May 12 05:41:50 casualuser internal-sftp[19004]: session closed for local user casualuser from [192.168.0.10]</strong>
</pre>
<p class="calibre1"><span><span>That's it. Our <kbd class="calibre9">sftp</kbd> session has been fully logged and now if we want to know what the casual user did, we just have to open the log file and read it through. One interesting note, each line of message has now the name of the user it belongs to. Well, it would actually be the hostname, but we streched the rules to get what we wanted from the system. Is it really so? Let's make a final check connecting a restricted user to see if a new log file is being generated:</span></span></p>
<pre class="codepackt">
<strong class="calibre2">local_user:~$ sftp -i .ssh/id_ecdsa_to_spoton -P 9999 restricted@192.168.0.5<br class="title-page-name"/></strong><strong class="calibre2">Warning: Permanently added '[192.168.0.5]:9999' (ECDSA) to the list of known hosts.<br class="title-page-name"/></strong><strong class="calibre2">Connected to 192.168.0.5.<br class="title-page-name"/></strong><strong class="calibre2">sftp&gt; mkdir test<br class="title-page-name"/></strong><strong class="calibre2">Couldn't create directory: Permission denied<br class="title-page-name"/></strong><strong class="calibre2">sftp&gt; cd exchange<br class="title-page-name"/></strong><strong class="calibre2">sftp&gt; mkdir test<br class="title-page-name"/></strong><strong class="calibre2">sftp&gt; ls<br class="title-page-name"/></strong><strong class="calibre2">test test_file test_local <br class="title-page-name"/></strong><strong class="calibre2">sftp&gt; dc test<br class="title-page-name"/></strong><strong class="calibre2">Invalid command.<br class="title-page-name"/></strong><strong class="calibre2">sftp&gt; cd test<br class="title-page-name"/></strong><strong class="calibre2">sftp&gt; bye</strong>
</pre>
<p class="calibre1"><span><span>Now that we have issued some commands as a restricted user, let's see if the file we want is really in place:</span></span></p>
<pre class="codepackt">
<strong class="calibre2">root:# ls -lah /var/log/openssh-sftp/restricted-sftp.log <br class="title-page-name"/></strong><strong class="calibre2">-rw-r----- 1 root adm 607 May 12 05:47 /var/log/openssh-sftp/restricted-sftp.log</strong>
</pre>
<p class="calibre1"><span><span>The file is correctly in place, so let's have a look inside:</span></span></p>
<pre class="codepackt">
<strong class="calibre2">root:# cat /var/log/openssh-sftp/restricted-sftp.log <br class="title-page-name"/></strong><strong class="calibre2">May 12 05:43:47 restricted internal-sftp[19147]: session opened for local user restricted from [192.168.0.10]<br class="title-page-name"/></strong><strong class="calibre2">May 12 05:47:04 restricted internal-sftp[19147]: mkdir name "/test" mode 0777<br class="title-page-name"/></strong><strong class="calibre2">May 12 05:47:04 restricted internal-sftp[19147]: sent status Permission denied<br class="title-page-name"/></strong><strong class="calibre2">May 12 05:47:11 restricted internal-sftp[19147]: mkdir name "/exchange/test" mode 0777<br class="title-page-name"/></strong><strong class="calibre2">May 12 05:47:13 restricted internal-sftp[19147]: opendir "/exchange"<br class="title-page-name"/></strong><strong class="calibre2">May 12 05:47:13 restricted internal-sftp[19147]: closedir "/exchange"<br class="title-page-name"/></strong><strong class="calibre2">May 12 05:47:22 restricted internal-sftp[19147]: session closed for local user restricted from [192.168.0.10]</strong>
</pre>
<p class="calibre1"><span><span>The content is there; all the actions performed by the restricted user have been logged and are out of his reach. One last check here:</span></span></p>
<pre class="codepackt">
<strong class="calibre2">root:# grep restricted casualuser-sftp.log | wc -l<br class="title-page-name"/></strong><strong class="calibre2">0</strong>
</pre>
<p class="calibre1"><span><span>This confirms that no lines tagged as restricted are listed into the <kbd class="calibre9">casualuser-sftp.log</kbd> , so each user has his own log.</span></span></p>
<p class="calibre1"><span><span>So, we now have a fully functional <kbd class="calibre9">sftp</kbd> server, along with individual jails and per user logging. There is just one nice touch left to give to our server, and this will bring us back to the old times: we are talking of a banner to display to our users. It can look like that is something not so useful or something that belongs to the past times but it is not that. When someone connects to our server must be notified that this is a private facility and no illegal action will be allowed. This is useful at least for two reasons:</span></span></p>
<ul class="calibre12">
<li class="calibre13">If an unauthorized user connects by mistake to our server, he has to know that he is not where he thinks he is; so we give him a chance to disconnect and no further actions will be taken.</li>
<li class="calibre13"><span><span>If an unknown user connects willfully to our server, he must be notified that he is not allowed to do so. In case he proceeds further, we will then be allowed in the future to show this as an evidence of his will to carry some illegal actions against our facility.</span></span></li>
</ul>
<p class="calibre1"><span><span>It can look quite simplistic, but with a banner in place, no one will be able to say <em class="calibre20">I did not know</em>. No, the user was notified and that matters. Since we do not want to scare our visitors, let's make a banner with a jazz using <kbd class="calibre9">figlet</kbd>, a utility that will apply some nice fonts to our messages ready to be displayed over a terminal. In our example, we are using Debian, so a simple </span></span><kbd class="calibre9">root:# apt-get install figlet</kbd> <span><span>will install the utility. The default set of font is not so rich, but more can be downloaded from the site of this project at </span></span><span><span><a href="http://www.figlet.org/fontdb.cgi" class="calibre4">http://www.figlet.org/fontdb.cgi</a>.</span></span></p>
<p class="calibre1"><span><span>Let's first test what we have already installed on our system. For a Debian environment, the font files reside in </span></span><span><span><kbd class="calibre9">/usr/share/figlet/</kbd> , </span></span><span><span>but this can differ based on the distribution used. So, to test all the fonts and see what we do like the most, a one line for loop is what we need:</span></span></p>
<pre class="codepackt">
<strong class="calibre2">root:# for i in $(ls -1 /usr/share/figlet/*.flf | awk -F "." '{print $1}') ; do figlet -f $i test ; echo $i ; done</strong>
</pre>
<p class="calibre1"><img class="image-border16" src="../images/00048.jpeg"/></p>
<p class="calibre1"><span><span>A simple <kbd class="calibre9">for</kbd> loop will show us our message in all the fonts available. </span></span><span><span>So, let's create a test file with our welcome banner:</span></span></p>
<pre class="codepackt">
<strong class="calibre2">Welcome<br class="title-page-name"/></strong><strong class="calibre2">to our restricted <br class="title-page-name"/></strong><strong class="calibre2">sftp server</strong>
</pre>
<p class="calibre1"><span><span>Let's save it to a file named </span></span><span><span><kbd class="calibre9">header.txt</kbd> a</span></span><span><span>nd pass it to <kbd class="calibre9">figlet stdin</kbd>:</span></span></p>
<pre class="codepackt">
<strong class="calibre2">root:# figlet -cf slant &lt; header.txt &gt; /opt/sftp/jails/sftp-banner</strong>
</pre>
<p class="calibre1"><span><span>We will get something like what is shown in the following screenshot, which is nicely centered:</span></span></p>
<div class="packt_figure"><img class="image-border34" src="../images/00049.jpeg"/></div>
<p class="calibre1"><span><span>A simple <kbd class="calibre9">for</kbd> loop will show us our message in all the fonts available. </span></span><span><span>Now, let's add some meaningful warning to a <kbd class="calibre9">footer.txt</kbd> file:</span></span></p>
<pre class="codepackt">
<strong class="calibre2">WARNING <br class="title-page-name"/></strong><strong class="calibre2">This service is restricted to authorized users only. All activities on this system are logged.</strong>
</pre>
<p class="calibre1"><span><span>Let's pass this message through <kbd class="calibre9">figlet</kbd>:</span></span></p>
<pre class="codepackt">
<strong class="calibre2">root:# figlet -cf digital &lt; footer.txt &gt;&gt; /opt/sftp-jails/sftp-banner</strong>
</pre>
<p class="calibre1"><span><span>Since we have our banner, let's clean it up a bit:</span></span></p>
<pre class="codepackt">
<strong class="calibre2">root:# rm footer.txt header.txt<br class="title-page-name"/></strong><strong class="calibre2">root:# chown root.root /opt/sftp-jails/sftp-banner<br class="title-page-name"/></strong><strong class="calibre2">root:# chmod 500 /opt/sftp-jails/sftp-banner</strong>
</pre>
<p class="calibre1"><span><span>That's all. So we try a new connection to the server, and we will get a nice welcome message like the one shown here:</span></span></p>
<div class="packt_figure"><img class="image-border35" src="../images/00050.gif"/></div>
<div class="packt_figref"><span><span>A nice welcome message will remind the visitors about the restriction of this sftp site.</span></span></div>
<p class="calibre1"><span><span>Great, but let's say we saw a font that we like, but it is not installed. For the sake of this example, let's say we want to use the alligator font:</span></span></p>
<pre class="codepackt">
<strong class="calibre2">root:# figlet -cf alligator test<br class="title-page-name"/></strong><strong class="calibre2">figlet: alligator: Unable to open font file</strong>
</pre>
<p class="calibre1"><span><span>It is not installed so we cannot use it, but it is just a matter of downloading it and copying over the font directory:</span></span></p>
<pre class="codepackt">
<strong class="calibre2">root:# wget -P /usr/share/figlet/ http://www.figlet.org/fonts/alligator.flf<br class="title-page-name"/></strong><strong class="calibre2">--2017-05-12 08:18:46-- http://www.figlet.org/fonts/alligator.flf<br class="title-page-name"/></strong><strong class="calibre2">Resolving www.figlet.org (www.figlet.org)... 188.226.162.120<br class="title-page-name"/></strong><strong class="calibre2">Connecting to www.figlet.org (www.figlet.org)|188.226.162.120|:80... connected.<br class="title-page-name"/></strong><strong class="calibre2">HTTP request sent, awaiting response... 200 OK<br class="title-page-name"/></strong><strong class="calibre2">Length: 11285 (11K) [text/plain]<br class="title-page-name"/></strong><strong class="calibre2">Saving to: ‘/usr/share/figlet/alligator.flf'<br class="title-page-name"/><br class="title-page-name"/></strong><strong class="calibre2">/usr/share/figlet/alligator.flf 100%[=======================================================================================================&gt;] 11.02K --.-KB/s in 0s <br class="title-page-name"/><br class="title-page-name"/></strong><strong class="calibre2">2017-05-12 08:18:46 (44.3 MB/s) - ‘/usr/share/figlet/alligator.flf' saved [11285/11285]</strong>
</pre>
<p class="calibre1"><span><span>Now let's just give the previous command again:</span></span></p>
<pre class="codepackt">
<strong class="calibre2"> root:# figlet -cf alligator test</strong>
</pre>
<p class="calibre1"><span><span>The font is available to figlet, and so the result is what we can see in the following screenshot:</span></span></p>
<div class="packt_figure"><img class="image-border36" src="../images/00051.jpeg"/></div>
<div class="packt_figref"><span><span>Installing a font is simply a matter of copying it in the fonts directory</span></span></div>
<p class="calibre1"><span><span>So, let's have fun. Try to change and create your message in the style we prefer: a banner shall not be necessarily boring.</span></span></p>


            </article>

            
        </section>
    

        <section>

                            <header>
                    </header><h1 class="header-title" id="calibre_pb_0">Summary</h1>
                
            
            <article>
                
<p class="calibre1"><span><span>This is the last summary of this book and the last topic was figlet; and it was not just a coincidence. What we tried to make clear through all the chapters is that Bash is fun. Did we touch every possible topic and example? No, not at all, and this is the greatest thing of all: we have so many things to see, so many ways to bend Bash to do unthinkable tasks. Just think about something and then try the shell: in most cases a bit of imagination will find a creative way to overcome obstacles and to chuckle about what has been done. This book is named <em class="calibre20">Mastering Bash</em>, but no book can exhaust the massive amount of things that we can discover about this shell. So, this is not a landing point, this is just a step further, maybe higher than usual, but just a step in an ongoing journey in our favorite environment, in our beloved GNU/Linux operating system.</span></span></p>


            </article>

            
        </section>
    </body></html>