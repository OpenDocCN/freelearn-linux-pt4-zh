<html><head></head><body><div class="chapter" title="Chapter&#xA0;3.&#xA0;The Software Layer"><div class="titlepage"><div><div><h1 class="title"><a id="ch03"/>Chapter 3. The Software Layer</h1></div></div></div><p>In this chapter, we will cover the following recipes:</p><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc">Exploring an image's contents</li><li class="listitem" style="list-style-type: disc">Adding a new software layer</li><li class="listitem" style="list-style-type: disc">Selecting a specific package versions and providers</li><li class="listitem" style="list-style-type: disc">Adding supported packages</li><li class="listitem" style="list-style-type: disc">Adding new packages</li><li class="listitem" style="list-style-type: disc">Adding data, scripts, or configuration files</li><li class="listitem" style="list-style-type: disc">Managing users and groups</li><li class="listitem" style="list-style-type: disc">Using the sysvinit initialization system</li><li class="listitem" style="list-style-type: disc">Using the systemd initialization system</li><li class="listitem" style="list-style-type: disc">Installing package-installation scripts</li><li class="listitem" style="list-style-type: disc">Reducing the Linux kernel image size</li><li class="listitem" style="list-style-type: disc">Reducing the root filesystem image size</li><li class="listitem" style="list-style-type: disc">Releasing software</li><li class="listitem" style="list-style-type: disc">Analyzing your system for compliance</li><li class="listitem" style="list-style-type: disc">Working with open source and proprietary code</li></ul></div><div class="section" title="Introduction"><div class="titlepage"><div><div><h1 class="title"><a id="ch03lvl1sec40"/>Introduction</h1></div></div></div><p>With hardware-specific changes on their way, the next step is customizing the target root filesystem; that is, the software that runs under the Linux kernel, also called the Linux <a id="id290" class="indexterm"/>user space.</p><p>The usual approach to this is to start with one of the available core images and both optimize and customize it as per the needs of your embedded project. Usually, the images chosen as a starting point are either <code class="literal">core-image-minimal</code> or <code class="literal">core-image-sato</code>, but any of them will do.</p><p>This chapter will show you how to add a software layer to contain those changes, and will explain some of the common customizations made, such as size optimization. It will also show you how to add new packages to your root filesystem, including licensing considerations.</p></div></div>
<div class="section" title="Exploring an image's contents"><div class="titlepage"><div><div><h1 class="title"><a id="ch03lvl1sec41"/>Exploring an image's contents</h1></div></div></div><p>We have already seen<a id="id291" class="indexterm"/> how to use the build history feature to obtain a list of packages and files included in our image. In this recipe, we will explain how the root filesystem is built so that we are able to track its components.</p><div class="section" title="Getting ready"><div class="titlepage"><div><div><h2 class="title"><a id="ch03lvl2sec107"/>Getting ready</h2></div></div></div><p>When packages are built, they are classified inside the working directory of your project (<code class="literal">tmp/work</code>) according to their architecture. For example, on a <code class="literal">wandboard-quad</code> build, we find the following directories:</p><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc"><code class="literal">all-poky-linux</code>: This is<a id="id292" class="indexterm"/> used for <a id="id293" class="indexterm"/>architecture-independent packages</li><li class="listitem" style="list-style-type: disc"><code class="literal">cortexa9hf-vfp-neon-poky-linux-gnueabi</code>: This is used for cortexa9, <a id="id294" class="indexterm"/>hard floating point packages</li><li class="listitem" style="list-style-type: disc"><code class="literal">wandboard_quad-poky-linux-gnueabi</code>: This is used for machine-specific packages; in this case, <a id="id295" class="indexterm"/><code class="literal">wandboard-quad</code></li><li class="listitem" style="list-style-type: disc"><code class="literal">x86_64-linux</code>: This <a id="id296" class="indexterm"/>is used for the packages that form the host <code class="literal">sysroot</code></li></ul></div><p>BitBake will build all the packages included in its dependency list inside its own directory.</p></div><div class="section" title="How to do it..."><div class="titlepage"><div><div><h2 class="title"><a id="ch03lvl2sec108"/>How to do it...</h2></div></div></div><p>To find the <code class="literal">build</code> directory for a given package, we can execute the following command:</p><div class="informalexample"><pre class="programlisting">
<span class="strong"><strong>$ bitbake -e &lt;package&gt; | grep ^WORKDIR=</strong></span>
</pre></div><p>Inside the <code class="literal">build</code> directory, we find some subdirectories (assuming <code class="literal">rm_work</code> is not used) that the build system uses in the packaging task. These subdirectories include the following:</p><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc"><code class="literal">deploy-rpms</code>: This is the<a id="id297" class="indexterm"/> directory where the final packages are stored. We look here for individual packages that can be locally copied to a target and installed. These packages are copied to the <code class="literal">tmp/deploy</code> directory and are also used when Yocto builds the root filesystem image.</li><li class="listitem" style="list-style-type: disc"><code class="literal">image</code>: This is the<a id="id298" class="indexterm"/> default destination directory where the <code class="literal">do_install</code> task installs components. It can be modified by the recipe with the <code class="literal">D</code> configuration variable.</li><li class="listitem" style="list-style-type: disc"><code class="literal">package</code>: This one contains the <a id="id299" class="indexterm"/>actual package contents.</li><li class="listitem" style="list-style-type: disc"><code class="literal">package-split</code>: This is <a id="id300" class="indexterm"/>where the contents are categorized in subdirectories named after their final packages. Recipes can split the package contents into several final packages, as specified by the <code class="literal">PACKAGES</code> variable. The default packages besides the default package name are:<div class="itemizedlist"><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc"><code class="literal">dbg</code>: This installs components used in debugging</li><li class="listitem" style="list-style-type: disc"><code class="literal">dev</code>: This installs components used in development, such as headers and libraries</li><li class="listitem" style="list-style-type: disc"><code class="literal">staticdev</code>: This installs libraries and headers used in static compilation</li><li class="listitem" style="list-style-type: disc"><code class="literal">doc</code>: This is where the documentation is placed</li><li class="listitem" style="list-style-type: disc"><code class="literal">locale</code>: This installs localization components</li></ul></div></li></ul></div><p>The components to be<a id="id301" class="indexterm"/> installed in each package are selected using the <code class="literal">FILES</code> variable. For example, to add to the default package, you could execute the following command:</p><div class="informalexample"><pre class="programlisting">
<span class="strong"><strong>FILES_${PN} += "${bindir}/file.bin"</strong></span>
</pre></div><p>And to add to the development package, you could use the following:</p><div class="informalexample"><pre class="programlisting">
<span class="strong"><strong>FILES_${PN}-dev += "${libdir}/lib.so"</strong></span>
</pre></div></div><div class="section" title="How it works..."><div class="titlepage"><div><div><h2 class="title"><a id="ch03lvl2sec109"/>How it works...</h2></div></div></div><p>Once the Yocto build system has built all the individual packages in its dependency list, it runs the <code class="literal">do_rootfs</code> task, which populates the <code class="literal">sysroot</code> and builds the root filesystem before creating the final package images. You can find the location of the root filesystem by executing:</p><div class="informalexample"><pre class="programlisting">
<span class="strong"><strong>$ bitbake -e core-image-minimal | grep ^IMAGE_ROOTFS=</strong></span>
</pre></div><p>Note that the <code class="literal">IMAGE_ROOTFS</code> variable is not configurable and should not be changed.</p><p>The contents of this directory will later be prepared into an image according to what image types are configured in the <code class="literal">IMAGE_FSTYPES</code> configuration variable. If something has been installed in this directory, it will then be installed in the final image.</p></div></div>
<div class="section" title="Adding a new software layer"><div class="titlepage"><div><div><h1 class="title"><a id="ch03lvl1sec42"/>Adding a new software layer</h1></div></div></div><p>Root filesystem customization involves adding or modifying content to the base image. Metadata for this content goes into one or more software layers, depending on the amount of customization needed.</p><p>A typical embedded <a id="id302" class="indexterm"/>project will have just one software layer containing all non-hardware-specific customizations. But it is also possible to have extra layers for graphical frameworks or system-wide elements.</p><div class="section" title="Getting ready"><div class="titlepage"><div><div><h2 class="title"><a id="ch03lvl2sec110"/>Getting ready</h2></div></div></div><p>Before starting work on a new layer, it is good practice to check whether someone else provides a similar layer. Also, if you are trying to integrate an open source project, check whether a layer for it already exists. There <a id="id303" class="indexterm"/>is an index of available layers at <a class="ulink" href="http://layers.openembedded.org/">http://layers.openembedded.org/</a>.</p></div><div class="section" title="How to do it..."><div class="titlepage"><div><div><h2 class="title"><a id="ch03lvl2sec111"/>How to do it...</h2></div></div></div><p>We can then create a new <code class="literal">meta-custom</code> layer using the <code class="literal">yocto-layer</code> command as we learned in the <span class="emphasis"><em>Creating a custom BSP layer</em></span> recipe in <a class="link" href="ch02.html" title="Chapter 2. The BSP Layer">Chapter 2</a>, <span class="emphasis"><em>The BSP Layer</em></span>. From the <code class="literal">sources</code> directory, execute the following command:</p><div class="informalexample"><pre class="programlisting">
<span class="strong"><strong>$ yocto-layer create custom</strong></span>
</pre></div><p>Don't forget to add the layer to your project's <code class="literal">conf/bblayers.conf</code> file and to your template's <code class="literal">conf</code> directory to make it available for all new projects.</p><p>The default <code class="literal">conf/layer.conf</code> configuration file is as follows:</p><div class="informalexample"><pre class="programlisting"># We have a conf and classes directory, add to BBPATH
BBPATH .= ":${LAYERDIR}"

# We have recipes-* directories, add to BBFILES
BBFILES += "${LAYERDIR}/recipes-*/*/*.bb \
        ${LAYERDIR}/recipes-*/*/*.bbappend"

BBFILE_COLLECTIONS += "custom"
BBFILE_PATTERN_custom = "^${LAYERDIR}/"
BBFILE_PRIORITY_custom = "6"</pre></div><p>We have discussed all the relevant variables in this snippet in the <span class="emphasis"><em>Creating a custom BSP layer</em></span> recipe in <a class="link" href="ch02.html" title="Chapter 2. The BSP Layer">Chapter 2</a>, <span class="emphasis"><em>The BSP Layer</em></span>.</p></div><div class="section" title="How it works..."><div class="titlepage"><div><div><h2 class="title"><a id="ch03lvl2sec112"/>How it works...</h2></div></div></div><p>When adding content to a new software layer, we need to keep in mind that our layer needs to play well with other layers in the Yocto project. To this end, when customizing recipes, we will always use append files, and will only override existing recipes if we are completely sure there is no way to add the customization required through an append file.</p><p>To help us manage <a id="id304" class="indexterm"/>the content across several layers, we can use the following <code class="literal">bitbake-layers</code> command-line utilities:</p><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc"><code class="literal">$ bitbake-layers show-layers</code>: This <a id="id305" class="indexterm"/>will display the configured layers as BitBake sees them. It is helpful to detect errors on your <code class="literal">conf/bblayer.conf</code> file.</li><li class="listitem" style="list-style-type: disc"><code class="literal">$ bitbake-layers show-recipes</code>: This <a id="id306" class="indexterm"/>command will display all the available recipes and the layers that provide them. It can be used to verify that BitBake is seeing your newly created recipe. If it does not appear, verify that the filesystem hierarchy corresponds to the one defined in your layer's <code class="literal">BBFILES</code> variable in <code class="literal">conf/layer.conf</code>.</li><li class="listitem" style="list-style-type: disc"><code class="literal">$ bitbake-layers show-overlayed</code>: This <a id="id307" class="indexterm"/>command will show all the recipes that are overlayed by another recipe with the same name but in a higher priority layer. It helps detect recipe clashes.</li><li class="listitem" style="list-style-type: disc"><code class="literal">$ bitbake-layers show-appends</code>: This<a id="id308" class="indexterm"/> command will list all available append files and the recipe files they apply to. It can be used to verify that BitBake is seeing your append files. Also, as before with recipes, if they don't appear, you will need to check the filesystem hierarchy and your layer's <code class="literal">BBFILES</code> variable.</li><li class="listitem" style="list-style-type: disc"><code class="literal">$ bitbake-layers flatten &lt;output_dir&gt;</code>: This command will create a directory with the <a id="id309" class="indexterm"/>contents of all configured layers without overlayed recipes and with all the append files applied. This is how BitBake will see the metadata. This flattened directory is useful to discover conflicts with your layer's metadata.</li></ul></div></div><div class="section" title="There's more..."><div class="titlepage"><div><div><h2 class="title"><a id="ch03lvl2sec113"/>There's more...</h2></div></div></div><p>We will sometimes add customizations that are specific to one board or machine. These are not always hardware-related, so they could be found both in a BSP or software layer.</p><p>When doing so, we will try to keep our customizations as specific as possible. One typical example is customizing for a specific machine or machine family. If you need to add a patch for the <code class="literal">wandboard-quad</code> machine, you would use the following line of code:</p><div class="informalexample"><pre class="programlisting">SRC_URI_append_wandboard-quad = " file://mypatch.patch"</pre></div><p>And, if the patch is applicable to all i.MX6-based boards, you can use the following:</p><div class="informalexample"><pre class="programlisting">SRC_URI_append_mx6 = " file://mypatch.patch"</pre></div><p>To be able to use machine families overrides, the machine configuration files need to include a <code class="literal">SOC_FAMILY</code> variable, such as the one for the <code class="literal">wandboard-quad</code> in <code class="literal">meta-fsl-arm-extra</code>. Refer to the following line of code:</p><div class="informalexample"><pre class="programlisting">conf/machine/wandboard-quad.conf:SOC_FAMILY = "mx6:mx6q:wandboard"</pre></div><p>And for it to appear in the <code class="literal">MACHINEOVERRIDES</code> variable, the <code class="literal">soc-family.inc</code> file needs to be included, as it is in <code class="literal">meta-fsl-arm</code>. Here is the relevant code excerpt from the <code class="literal">conf/machine/include/imx-base.inc</code> file:</p><div class="informalexample"><pre class="programlisting">include conf/machine/include/soc-family.inc
MACHINEOVERRIDES =. "${@['', '${SOC_FAMILY}:']['${SOC_FAMILY}' != '']}"</pre></div><p>BitBake will search a<a id="id310" class="indexterm"/> predefined path, looking for files inside the package's working directory, defined in the <code class="literal">FILESPATH</code> variable as a colon-separated list. Specifically:</p><div class="informalexample"><pre class="programlisting">${PN}-${PV}/${DISTRO}
${PN}/${DISTRO}
files/${DISTRO}

${PN}-${PV}/${MACHINE}
${PN}/${MACHINE}
files/${MACHINE}

${PN}-${PV}/${SOC_FAMILY}
${PN}/${SOC_FAMILY}
files/${SOC_FAMILY}

${PN}-${PV}/${TARGET_ARCH}
${PN}/${TARGET_ARCH}
files/${TARGET_ARCH}

${PN}-${PV}/
${PN}/
files/</pre></div><p>In the specific case of the <code class="literal">wandboard-quad</code>, this translates to the following:</p><div class="informalexample"><pre class="programlisting">${PN}-${PV}/poky
${PN}/poky
files/poky
${PN}-${PV}/wandboard-quad
${PN}/wandboard-quad
files/wandboard-quad
${PN}-${PV}/wandboard
${PN}/wandboard
files/wandboard
${PN}-${PV}/mx6q
${PN}/mx6q
files/mx6q
${PN}-${PV}/mx6
${PN}/mx6
files/mx6
${PN}-${PV}/armv7a
${PN}/armv7a
files/armv7a
${PN}-${PV}/arm
${PN}/arm
files/arm
${PN}-${PV}/
${PN}/
files/</pre></div><p>Here, <code class="literal">PN</code> is the package name and <code class="literal">PV</code> is the package version.</p><p>It is best to place patches in the most specific of these, so <code class="literal">wandboard-quad</code>, followed by <code class="literal">wandboard</code>, <code class="literal">mx6q</code>, <code class="literal">mx6</code>, <code class="literal">armv7a</code>, <code class="literal">arm</code>, and finally the generic <code class="literal">PN-PV</code>, <code class="literal">PN</code>, and <code class="literal">files</code>.</p><p>Note that the search <a id="id311" class="indexterm"/>path refers to the location of the BitBake recipe, so append files need to always add the path when adding content. Our append files can add extra folders to this search path if needed by appending or prepending to the <code class="literal">FILESEXTRAPATHS</code> variable as follows:</p><div class="informalexample"><pre class="programlisting">FILESEXTRAPATHS_prepend := "${THISDIR}/folder:"</pre></div><div class="note" title="Note" style=""><div class="inner"><h3 class="title"><a id="note19"/>Note</h3><p>Note the immediate operator (<code class="literal">:=</code>) that expands <code class="literal">THISDIR</code> immediately, and the prepend that places your added path before any other path so that your patches and files are found first in the search.</p><p>Also, we have seen the <code class="literal">+=</code> and <code class="literal">=+</code> style of operators in configuration files, but they should be avoided in recipe files and the append and prepend operators should be given preference, as seen in the example code explained previously to avoid ordering issues.</p></div></div></div></div>
<div class="section" title="Selecting a specific package version and providers"><div class="titlepage"><div><div><h1 class="title"><a id="ch03lvl1sec43"/>Selecting a specific package version and providers</h1></div></div></div><p>Our layers can provide recipes<a id="id312" class="indexterm"/> for different versions of the same package. For example, the<a id="id313" class="indexterm"/> <code class="literal">meta-fsl-arm</code> layer contains several different types of Linux sources:</p><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc"><code class="literal">linux-imx</code>: This <a id="id314" class="indexterm"/>corresponds to the Freescale BSP kernel image fetched from <a class="ulink" href="http://git.freescale.com/git/cgit.cgi/imx/linux-2.6-imx.git/">http://git.freescale.com/git/cgit.cgi/imx/linux-2.6-imx.git/</a></li><li class="listitem" style="list-style-type: disc"><code class="literal">linux-fslc</code>: This is<a id="id315" class="indexterm"/> the mainline Linux kernel and fetched from <a class="ulink" href="https://github.com/Freescale/linux-fslc">https://github.com/Freescale/linux-fslc</a></li><li class="listitem" style="list-style-type: disc"><code class="literal">linux-timesys</code>: This is a kernel with Vybrid platform <a id="id316" class="indexterm"/>support fetched from <a class="ulink" href="https://github.com/Timesys/linux-timesys">https://github.com/Timesys/linux-timesys</a></li></ul></div><p>As we mentioned before, all recipes provide the package name (for example, <code class="literal">linux-imx</code> or <code class="literal">linux-fslc</code>) by default, but all Linux recipes must also provide the <code class="literal">virtual/kernel</code> virtual package. The build system will resolve <code class="literal">virtual/kernel</code> to the most appropriate <a id="id317" class="indexterm"/>Linux recipe name, taking into account the requirements <a id="id318" class="indexterm"/>of the build, such as the machine it is building for.</p><p>And within those recipes, <code class="literal">linux-imx</code>, for example, has both 2.6.35.3 and 3.10.17 recipe versions.</p><p>In this recipe, we will show how to tell the Yocto build system which specific package and version to build.</p><div class="section" title="How to do it..."><div class="titlepage"><div><div><h2 class="title"><a id="ch03lvl2sec114"/>How to do it...</h2></div></div></div><p>To specify the exact package we want to build, the build system allows us to specify what provider and version to use.</p><div class="section" title="How do we select which provider to use?"><div class="titlepage"><div><div><h3 class="title"><a id="ch03lvl3sec44"/>How do we select which provider to use?</h3></div></div></div><p>We can tell BitBake which recipe to use by using the <code class="literal">PREFERRED_PROVIDER</code> variable. To set a preferred provider for the <code class="literal">virtual/kernel</code> virtual package on our Wandboard machine, we would add the following to its machine configuration file:</p><div class="informalexample"><pre class="programlisting">PREFERRED_PROVIDER_virtual/kernel = "linux-imx"</pre></div></div><div class="section" title="How do we select which version to use?"><div class="titlepage"><div><div><h3 class="title"><a id="ch03lvl3sec45"/>How do we select which version to use?</h3></div></div></div><p>Within a specific <a id="id319" class="indexterm"/>provider, we can also tell BitBake which version to use with the <code class="literal">PREFERRED_VERSION</code> variable. For example, to set a specific <code class="literal">linux-imx</code> version for all i.MX6-based machines, we would add the following to our <code class="literal">conf/local.conf</code> file:</p><div class="informalexample"><pre class="programlisting">PREFERRED_VERSION_linux-imx_mx6 = "3.10.17"</pre></div><p>The <code class="literal">%</code> wildcard is accepted to match any character, as we see here:</p><div class="informalexample"><pre class="programlisting">PREFERRED_VERSION_linux-imx_mx6 = "3.10%"</pre></div><p>It is, however, more common to see this type of configuration done in machine configuration files, in which case we would not use the <code class="literal">_mx6</code> append.</p></div><div class="section" title="How do we select which version not to use?"><div class="titlepage"><div><div><h3 class="title"><a id="ch03lvl3sec46"/>How do we select which version not to use?</h3></div></div></div><p>We can use the <code class="literal">DEFAULT_PREFERENCE</code> variable set to <code class="literal">-1</code> to specify that a version is not to be used unless explicitly set by a <code class="literal">PREFERRED_VERSION</code> variable. This is commonly used in development versions of packages.</p><div class="informalexample"><pre class="programlisting">DEFAULT_PREFERENCE = "-1"</pre></div></div></div></div>
<div class="section" title="Adding supported packages"><div class="titlepage"><div><div><h1 class="title"><a id="ch03lvl1sec44"/>Adding supported packages</h1></div></div></div><p>It is common to<a id="id320" class="indexterm"/> want to add new packages to an image that already has an available recipe in one of the included Yocto layers.</p><p>When the target image desired is very different from the supplied core images, it is recommended to define a new image rather than to customize an existing one.</p><p>This recipe will show how to customize an existing image by adding supported packages to it, but also to create a completely new image recipe if needed.</p><div class="section" title="Getting ready"><div class="titlepage"><div><div><h2 class="title"><a id="ch03lvl2sec115"/>Getting ready</h2></div></div></div><p>To discover whether a package we require is included in our configured layers, and what specific versions are supported, we can use <code class="literal">bitbake-layers</code> from our build directory as we saw previously:</p><div class="informalexample"><pre class="programlisting">
<span class="strong"><strong>$ bitbake-layers show-recipes | grep -A 1 htop</strong></span>
<span class="strong"><strong>htop:</strong></span>
<span class="strong"><strong>  meta-oe              1.0.3</strong></span>
</pre></div><p>Alternatively, we can also use BitBake as follows:</p><div class="informalexample"><pre class="programlisting">
<span class="strong"><strong>$ bitbake -s | grep htop</strong></span>
<span class="strong"><strong>htop                                                :1.0.3-r0</strong></span>
</pre></div><p>Or we can use the <code class="literal">find</code> Linux command in our <code class="literal">sources</code> directory:</p><div class="informalexample"><pre class="programlisting">
<span class="strong"><strong>$ find . -type f -name "htop*.bb"</strong></span>
<span class="strong"><strong>./meta-openembedded/meta-oe/recipes-support/htop/htop_1.0.3.bb</strong></span>
</pre></div><p>Once we know what packages we want to include in our final images, let's see how we can add them to the image.</p></div><div class="section" title="How to do it..."><div class="titlepage"><div><div><h2 class="title"><a id="ch03lvl2sec116"/>How to do it...</h2></div></div></div><p>While developing, we <a id="id321" class="indexterm"/>will use our project's <code class="literal">conf/local.conf</code> file to add customizations. To add packages to all images, we can use the following line of code:</p><div class="informalexample"><pre class="programlisting">IMAGE_INSTALL_append = " htop"</pre></div><div class="note" title="Note" style=""><div class="inner"><h3 class="title"><a id="note20"/>Note</h3><p>Note that there is a space after the first quote to separate the new package from the existing ones, as the append operator does not add a space.</p></div></div><p>We could also limit the addition to a specific image with:</p><div class="informalexample"><pre class="programlisting">IMAGE_INSTALL_append_pn-core-image-minimal = " htop"</pre></div><p>Another way to easily customize is by making<a id="id322" class="indexterm"/> use of <span class="strong"><strong>features</strong></span>. A feature is a logical grouping of packages. For example, we could create a new feature called <code class="literal">debug-utils</code>, which will add a whole set of debugging utilities. We could define our feature in a configuration file or class as follows:</p><div class="informalexample"><pre class="programlisting">FEATURE_PACKAGES_debug-utils = "strace perf"</pre></div><p>We could then add this feature to our image by adding an <code class="literal">EXTRA_IMAGE_FEATURES</code> variable to our <code class="literal">conf/local.conf</code> file as follows:</p><div class="informalexample"><pre class="programlisting">EXTRA_IMAGE_FEATURES += "debug-utils"</pre></div><p>If you were to add it to an image recipe, you would use the <code class="literal">IMAGE_FEATURES</code> variable instead.</p><p>Usually, features get added as a <code class="literal">packagegroup</code> recipe instead of being listed as packages individually. Let's show how to define a <code class="literal">packagegroup</code> recipe in the <code class="literal">recipes-core/packagegroups/packagegroup-debug-utils.bb</code> file:</p><div class="informalexample"><pre class="programlisting">SUMMARY = "Debug applications packagegroup"
LICENSE = "GPLv2"
LIC_FILES_CHKSUM = "file://${COREBASE}/LICENSE;md5=3f40d7994397109285ec7b81fdeb3b58"

inherit packagegroup

RDEPENDS_${PN} = "\
    strace \
    perf \
"</pre></div><p>And you would then<a id="id323" class="indexterm"/> add it to the <code class="literal">FEATURE_PACKAGES</code> variable as follows:</p><div class="informalexample"><pre class="programlisting">FEATURE_PACKAGES_debug-utils = "packagegroup-debug-utils"</pre></div><p>We can use <code class="literal">packagegroups</code> to create more complex examples. Refer to the <span class="emphasis"><em>Yocto Project Development Manual</em></span> at <a class="ulink" href="http://www.yoctoproject.org/docs/1.7.1/dev-manual/dev-manual.html">http://www.yoctoproject.org/docs/1.7.1/dev-manual/dev-manual.html</a> for <a id="id324" class="indexterm"/>details.</p></div><div class="section" title="How it works..."><div class="titlepage"><div><div><h2 class="title"><a id="ch03lvl2sec117"/>How it works...</h2></div></div></div><p>The best approach to customize images is to create our own images using an existing image as template. We could use <code class="literal">core-image-minimal.bb</code>, which contains the following code:</p><div class="informalexample"><pre class="programlisting">SUMMARY = "A small image just capable of allowing a device to boot."

IMAGE_INSTALL = "packagegroup-core-boot ${ROOTFS_PKGMANAGE_BOOTSTRAP} ${CORE_IMAGE_EXTRA_INSTALL}"

IMAGE_LINGUAS = " "

LICENSE = "MIT"

inherit core-image

IMAGE_ROOTFS_SIZE ?= "8192"</pre></div><p>And extend it to your <a id="id325" class="indexterm"/>own version that allows for the customization of <code class="literal">IMAGE_FEATURES</code>, by adding the following <code class="literal">meta-custom/recipes-core/images/custom-image.bb</code> image file:</p><div class="informalexample"><pre class="programlisting">require recipes-core/images/core-image-minimal.bb
IMAGE_FEATURES += "ssh-server-dropbear package-management"</pre></div><p>Of course, we can also define a new image from scratch using one of the available images as a template.</p></div><div class="section" title="There's more..."><div class="titlepage"><div><div><h2 class="title"><a id="ch03lvl2sec118"/>There's more...</h2></div></div></div><p>A final way to customize images is by adding shell functions that get executed once the image has been created. You do this by adding the following to your image recipe or <code class="literal">conf/local.conf</code> file:</p><div class="informalexample"><pre class="programlisting">ROOTFS_POSTPROCESS_COMMAND += "function1;...;functionN"</pre></div><p>You can use the path to the root filesystem in your command with the <code class="literal">IMAGE_ROOTFS</code> variable.</p><p>Classes would use the <code class="literal">IMAGE_POSTPROCESS_COMMAND</code> variable instead of <code class="literal">ROOTFS_POSTPROCESS_COMMAND</code>.</p><p>One example of usage can be found in the <code class="literal">debug-tweaks</code> feature in <code class="literal">image.bbclass</code>, when images are tweaked to allow passwordless root logins. This method is also commonly used to customize the root password of a target image.</p><div class="section" title="Configuring packages"><div class="titlepage"><div><div><h3 class="title"><a id="ch03lvl3sec47"/>Configuring packages</h3></div></div></div><p>As we saw in the <span class="emphasis"><em>Configuring the Linux kernel</em></span> recipe in <a class="link" href="ch02.html" title="Chapter 2. The BSP Layer">Chapter 2</a>, <span class="emphasis"><em>The BSP Layer</em></span>, some packages, like the<a id="id326" class="indexterm"/> Linux kernel, provide a configuration menu and can be configured with the <code class="literal">menuconfig</code> BitBake command.</p><p>Another package worth mentioning with a configuration interface is BusyBox. We will show how to configure BusyBox, for example to add <code class="literal">pgrep</code>, a tool that looks up process's IDs by name. To do so follow the next steps:</p><div class="orderedlist"><ol class="orderedlist arabic"><li class="listitem">Configure BusyBox:<div class="informalexample"><pre class="programlisting">
<span class="strong"><strong>$ bitbake -c menuconfig busybox</strong></span>
</pre></div></li><li class="listitem">In <span class="strong"><strong>Process utilities</strong></span> choose <code class="literal">pgrep</code>.</li><li class="listitem">Compile BusyBox:<div class="informalexample"><pre class="programlisting">
<span class="strong"><strong>$ bitbake -C compile busybox</strong></span>
</pre></div></li><li class="listitem">Copy the RPM package into the target:<div class="informalexample"><pre class="programlisting">
<span class="strong"><strong>$ bitbake -e busybox | grep ^WORKDIR=</strong></span>
<span class="strong"><strong>$ scp ${WORKDIR}/deploy-rpms/cortexa9hf_vfp_neon/busybox- 1.22.1-r32.cortexa9hf_vfp_neon.rpm root@&lt;target_ip&gt;:/tmp</strong></span>
</pre></div></li><li class="listitem">Install the RPM package on the target:<div class="informalexample"><pre class="programlisting">
<span class="strong"><strong># rpm --force -U /tmp/busybox-1.22.1- r32.cortexa9hf_vfp_neon.rpm</strong></span>
</pre></div><p>Note that we are forcing the update as the package version has not increased with the configuration change.</p></li></ol></div></div></div></div>
<div class="section" title="Adding new packages"><div class="titlepage"><div><div><h1 class="title"><a id="ch03lvl1sec45"/>Adding new packages</h1></div></div></div><p>We have seen how to <a id="id327" class="indexterm"/>customize our image so that we can add supported packages to it. When we can't find an existing recipe or we need to integrate some new software we have developed, we will need to create a new Yocto recipe.</p><div class="section" title="Getting ready"><div class="titlepage"><div><div><h2 class="title"><a id="ch03lvl2sec119"/>Getting ready</h2></div></div></div><p>There are some questions we need to ask ourselves before starting to write a new recipe:</p><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc">Where is the source code stored?</li><li class="listitem" style="list-style-type: disc">Is it source-controlled or released as a tarball?</li><li class="listitem" style="list-style-type: disc">What is the source code license?</li><li class="listitem" style="list-style-type: disc">What build system is it using?</li><li class="listitem" style="list-style-type: disc">Does it need configuration?</li><li class="listitem" style="list-style-type: disc">Can we cross-compile it as is or does it need to be patched?</li><li class="listitem" style="list-style-type: disc">What are the files that need to be deployed to the root filesystem, and where do they go?</li><li class="listitem" style="list-style-type: disc">Are there any system changes that need to happen, such as new users or <code class="literal">init</code> scripts?</li><li class="listitem" style="list-style-type: disc">Are there any dependencies that need to be installed into <code class="literal">sysroot</code> beforehand?</li></ul></div><p>Once we know the answers to these questions, we are ready to start writing our recipe.</p></div><div class="section" title="How to do it..."><div class="titlepage"><div><div><h2 class="title"><a id="ch03lvl2sec120"/>How to do it...</h2></div></div></div><p>It is best to start from a blank template like the one that follows than to start from a similar recipe and modify it, as the result will be cleaner and contain only the strictly needed instructions.</p><p>A good starting base for a minimal recipe addition is:</p><div class="informalexample"><pre class="programlisting">SUMMARY = "The package description for the package management system"

LICENSE = "The package's licenses typically from meta/files/common-licenses/"
LIC_FILES_CHKSUM = "License checksum used to track open license changes"
DEPENDS = "Package list of build time dependencies"

SRC_URI = "Local or remote file or repository to fetch"
SRC_URI[md5sum] = "md5 checksums for all remote fetched files (not for repositories)"
SRC_URI[sha256sum] = "sha256 checksum for all remote fetched files (not for repositories)"

S = "Location of the source in the working directory, by default ${WORKDIR}/${PN}-${PV}."

inherit &lt;class needed for some functionality&gt;

# Task overrides, like do_configure, do_compile and do_install, or nothing.

# Package splitting (if needed).

# Machine selection variables (if needed).</pre></div></div><div class="section" title="How it works..."><div class="titlepage"><div><div><h2 class="title"><a id="ch03lvl2sec121"/>How it works...</h2></div></div></div><p>We will explain each one of the recipe<a id="id328" class="indexterm"/> sections in more detail in the following sections.</p><div class="section" title="Package licensing"><div class="titlepage"><div><div><h3 class="title"><a id="ch03lvl3sec48"/>Package licensing</h3></div></div></div><p>Every recipe needs to <a id="id329" class="indexterm"/>contain a <code class="literal">LICENSE</code> variable. The <code class="literal">LICENSE</code> variable allows you to specify multiple, alternative, and per-package type licenses, as seen in the following examples:</p><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc">For MIT or GPLv2 alternative licenses, we will use:<div class="informalexample"><pre class="programlisting">LICENSE = "GPL-2.0 | MIT"</pre></div></li><li class="listitem" style="list-style-type: disc">For both ISC and MIT licenses, we will use:<div class="informalexample"><pre class="programlisting">LICENSE = "ISC &amp; MIT"</pre></div></li><li class="listitem" style="list-style-type: disc">For split packages, all of them GPLv2 except the documentation that is covered under the Creative Commons, we will use:<div class="informalexample"><pre class="programlisting">LICENSE_${PN} = "GPLv2"
LICENSE_${PN}-dev = "GPLv2"
LICENSE_${PN}-dbg = "GPLv2"
LICENSE_${PN}-doc = "CC-BY-2.0"</pre></div></li></ul></div><p>Open source packages usually have the license included with the source code in <code class="literal">README</code>, <code class="literal">COPYING</code>, or <code class="literal">LICENSE</code> files, and even the source code header files.</p><p>For open source licenses, we also need to specify <code class="literal">LIC_FILES_CHECKSUM</code> for all licenses so that the build system can notify us when the licenses change. To add it, we locate the file or file portion that contains the license and provide its relative path from the directory containing the source and a MD5 checksum for it. For example:</p><div class="informalexample"><pre class="programlisting">LIC_FILES_CHKSUM = "file://${COREBASE}/meta/files/common- licenses/GPL-2.0;md5=801f80980d171dd6425610833a22dbe6"
LIC_FILES_CHKSUM = "file://COPYING;md5=f7bdc0c63080175d1667091b864cb12c"
LIC_FILES_CHKSUM = "file://usr/include/head.h;endline=7;md5=861ebad4adc7236f8d1905338 abd7eb2"
LIC_FILES_CHKSUM = "file://src/file.c;beginline=5;endline=13;md5=6c7486b21a8524b1879f a159578da31e"</pre></div><p>Proprietary code <a id="id330" class="indexterm"/>should have the license set as <code class="literal">CLOSED</code>, and no <code class="literal">LIC_FILES_CHECKSUM</code> is needed for it.</p></div><div class="section" title="Fetching package contents"><div class="titlepage"><div><div><h3 class="title"><a id="ch03lvl3sec49"/>Fetching package contents</h3></div></div></div><p>The <code class="literal">SRC_URI</code> variable lists the <a id="id331" class="indexterm"/>files to fetch. The build system will use different fetchers depending on the file prefix. These can be:</p><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc">Local files included with the metadata (<code class="literal">file://</code>). If the local file is a patch, the <code class="literal">SRC_URI</code> variable can be extended with patch-specific arguments such as:<div class="itemizedlist"><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc"><code class="literal">striplevel</code>: The default patch strip level is 1 but it can be modified with this argument</li><li class="listitem" style="list-style-type: disc"><code class="literal">patchdir</code>: This specifies the directory location to apply the patch to, with the default being the source directory</li><li class="listitem" style="list-style-type: disc"><code class="literal">apply</code>: This argument controls whether to apply the patch or not, with the default being to apply it</li></ul></div></li><li class="listitem" style="list-style-type: disc">Files stored in remote servers (typically, <code class="literal">http(s)://</code>, <code class="literal">ftp://</code>, or <code class="literal">ssh://</code>).</li><li class="listitem" style="list-style-type: disc">Files stored in remote repositories (typically, <code class="literal">git://</code>, <code class="literal">svn://</code>, <code class="literal">hg://</code>, or <code class="literal">bzr://</code>). These also need a <code class="literal">SRCREV</code> variable to specify the revision.</li></ul></div><p>Files stored in remote servers (not local files or remote repositories) need to specify two checksums. If there are several files, they can be distinguished with a <code class="literal">name</code> argument; for example:</p><div class="informalexample"><pre class="programlisting">SRCREV = "04024dea2674861fcf13582a77b58130c67fccd8"
SRC_URI = "git://repo.com/git/ \
           file://fix.patch;name=patch \
           http://example.org/archive.data;name=archive"
SRC_URI[archive.md5sum] = "aaf32bde135cf3815aa3221726bad71e"
SRC_URI[archive.sha256sum] = "65be91591546ef6fdfec93a71979b2b108eee25edbc20c53190caafc9a92d4e7"</pre></div><p>The source directory folder, <code class="literal">S</code>, specifies the location of the source files. The repository will be checked out here, or the tarball decompressed in this location. If the tarball decompresses in the standard <code class="literal">${PN}-${PV}</code> location, it can be omitted as it is the default. For repositories, it needs to <a id="id332" class="indexterm"/>always be specified; for example:</p><div class="informalexample"><pre class="programlisting">S = "${WORKDIR}/git"</pre></div></div><div class="section" title="Specifying task overrides"><div class="titlepage"><div><div><h3 class="title"><a id="ch03lvl3sec50"/>Specifying task overrides</h3></div></div></div><p>All recipes<a id="id333" class="indexterm"/> inherit the <code class="literal">base.bbclass</code> class, which defines the following tasks:</p><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc"><code class="literal">do_fetch</code>: This method <a id="id334" class="indexterm"/>fetches the source code, selecting the fetcher using the <code class="literal">SRC_URI</code> variable.</li><li class="listitem" style="list-style-type: disc"><code class="literal">do_unpack</code>: This <a id="id335" class="indexterm"/>method unpacks the code in the working directory to a location specified by the <code class="literal">S</code> variable.</li><li class="listitem" style="list-style-type: disc"><code class="literal">do_configure</code>: This method<a id="id336" class="indexterm"/> configures the source code if needed. It does nothing by default.</li><li class="listitem" style="list-style-type: disc"><code class="literal">do_compile</code>: This method<a id="id337" class="indexterm"/> compiles the source and runs the GNU make target by default.</li><li class="listitem" style="list-style-type: disc"><code class="literal">do_install</code>: This method <a id="id338" class="indexterm"/>copies the results of the build from the <code class="literal">build</code> directory <code class="literal">B</code> to the destination directory <code class="literal">D</code>. It does nothing by default.</li><li class="listitem" style="list-style-type: disc"><code class="literal">do_package</code>: This method <a id="id339" class="indexterm"/>splits the deliverables into several packages. It does nothing by default.</li></ul></div><p>Usually, only the configuration, compilation, and installation tasks are overridden, and this is mostly done implicitly by inheriting a class like <code class="literal">autotools</code>.</p><p>For a custom recipe that does not use a build system, you need to provide the required instructions for configuration (if any), compilation, and installation in their corresponding <code class="literal">do_configure</code>, <code class="literal">do_compile</code>, and <code class="literal">do_install</code> overrides. As an example of this type of recipe, <code class="literal">meta-custom/recipes-example/helloworld/helloworld_1.0.bb</code>, may be seen here:</p><div class="informalexample"><pre class="programlisting">DESCRIPTION = "Simple helloworld application"
SECTION = "examples"
LICENSE = "MIT"
LIC_FILES_CHKSUM = "file://${COMMON_LICENSE_DIR}/MIT;md5=0835ade698e0bcf8506ecda2f7b4f302"

SRC_URI = "file://helloworld.c"

S = "${WORKDIR}"

<span class="strong"><strong>do_compile()</strong></span> {
             ${CC} helloworld.c -o helloworld
}

<span class="strong"><strong>do_install()</strong></span> {
             install -d ${D}${bindir}
             install -m 0755 helloworld ${D}${bindir}
}</pre></div><p>With the <code class="literal">meta-custom/recipes-example/helloworld/helloworld-1.0/helloworld.c</code> source file being the following:</p><div class="informalexample"><pre class="programlisting">#include &lt;stdio.h&gt;

int main(void)
{
    return printf("Hello World");
}</pre></div><p>We will see example recipes that use the most common build systems in the next chapter.</p></div><div class="section" title="Configuring packages"><div class="titlepage"><div><div><h3 class="title"><a id="ch03lvl3sec51"/>Configuring packages</h3></div></div></div><p>The Yocto build system <a id="id340" class="indexterm"/>provides the <code class="literal">PACKAGECONFIG</code> variable to help in the configuration of packages by defining a number of features. Your recipe defines the individual features as follows:</p><div class="informalexample"><pre class="programlisting">PACKAGECONFIG ??= "feature"
PACKAGECONFIG[feature] = "--with-feature,--without-feature,build- deps-feature,rt-deps-feature"</pre></div><p>The <code class="literal">PACKAGECONFIG</code> variable contains a space-separated list of feature names, and it can be extended or overridden in <code class="literal">bbappend</code> files; have a look at the following example:</p><div class="informalexample"><pre class="programlisting">PACKAGECONFIG_append = " feature1 feature2"</pre></div><p>To extend or override it from a distribution or local configuration file, you would use the following syntax:</p><div class="informalexample"><pre class="programlisting">PACKAGECONFIG_pn-&lt;package_name&gt; = "feature1 feature2"
PACKAGECONFIG_append_pn-&lt;package_name&gt; = " feature1 feature2"</pre></div><p>Following that, we characterize each feature with four ordered arguments:</p><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc">Extra configuration arguments (for <code class="literal">EXTRA_OECONF</code>) when the feature is enabled</li><li class="listitem" style="list-style-type: disc">Extra configuration arguments (for <code class="literal">EXTRA_OECONF</code>) when the feature is disabled</li><li class="listitem" style="list-style-type: disc">Extra build dependencies (for <code class="literal">DEPENDS</code>) when the feature is enabled</li><li class="listitem" style="list-style-type: disc">Extra runtime dependencies (for <code class="literal">RDEPENDS</code>) when the feature is enabled</li></ul></div><p>The four arguments are <a id="id341" class="indexterm"/>optional, but the ordering needs to be maintained by leaving the surrounding commas.</p><p>For example, the <code class="literal">wpa-supplicant</code> recipe defines two features, <code class="literal">gnutls</code> and <code class="literal">openssl</code>, but only enables <code class="literal">gnutls</code> by default, as seen here:</p><div class="informalexample"><pre class="programlisting">PACKAGECONFIG ??= "gnutls"
PACKAGECONFIG[gnutls] = ",,gnutls"
PACKAGECONFIG[openssl] = ",,openssl"</pre></div></div><div class="section" title="Splitting into several packages"><div class="titlepage"><div><div><h3 class="title"><a id="ch03lvl3sec52"/>Splitting into several packages</h3></div></div></div><p>It is common to separate the <a id="id342" class="indexterm"/>recipe contents into different packages that serve different <a id="id343" class="indexterm"/>needs. Typical examples are to include documentation in a <code class="literal">doc</code> package, and header and/or libraries in a <code class="literal">dev</code> package. We can do this using the <code class="literal">FILES</code> variable as follows:</p><div class="informalexample"><pre class="programlisting">FILES_${PN} += "List of files to include in the main package"
FILES_${PN}-dbg += "Optional list of files to include in the debug package"
FILES_${PN}-dev += "Optional list of files to include in the development package"
FILES_${PN}-doc += "Optional list of files to include in the documentation package"</pre></div></div><div class="section" title="Setting machine-specific variables"><div class="titlepage"><div><div><h3 class="title"><a id="ch03lvl3sec53"/>Setting machine-specific variables</h3></div></div></div><p>Each recipe has a <code class="literal">PACKAGE_ARCH</code> variable that categorizes the recipe into a package feed, as we saw in<a id="id344" class="indexterm"/> the <span class="emphasis"><em>Exploring an image's contents</em></span> recipe. Most of the times, they are automatically sorted out by the Yocto build system. For example, if the recipe is a kernel, a kernel module recipe, or an image recipe, or even if it is cross-compiling or building native applications, the Yocto build system will set the package architecture accordingly.</p><p>BitBake will also look at the <code class="literal">SRC_URI</code> machine overrides and adjust the package architecture, and if your recipe is using the <code class="literal">allarch</code> class, it will set the package architecture to <code class="literal">all</code>.</p><p>So when working on a recipe that only applies to a machine or machine family, or that contains changes that are specific to a machine or machine family, we need to check whether the package is categorized in the appropriate package feed, and if not, specify the package architecture explicitly in the recipe itself by using the following line of code:</p><div class="informalexample"><pre class="programlisting">PACKAGE_ARCH = "${MACHINE_ARCH}"</pre></div><p>Also, when a<a id="id345" class="indexterm"/> recipe is only to be parsed for specific machine types, we specify it with the <code class="literal">COMPATIBLE_MACHINE</code> variable. For example, to make it compatible only with the <code class="literal">mxs, mx5 and mx6 SoC families</code>, we would use the following:</p><div class="informalexample"><pre class="programlisting">COMPATIBLE_MACHINE = "(mxs|mx5|mx6)"</pre></div></div></div></div>
<div class="section" title="Adding data, scripts, or configuration files"><div class="titlepage"><div><div><h1 class="title"><a id="ch03lvl1sec46"/>Adding data, scripts, or configuration files</h1></div></div></div><p>All recipes<a id="id346" class="indexterm"/> inherit the base class with the default set of tasks to run. After <a id="id347" class="indexterm"/>inheriting the base class, a recipe knows how to do things like <a id="id348" class="indexterm"/>fetching and compiling.</p><p>As most recipes are meant to install some sort of executable, the base class knows how to build it. But sometimes all we want is to install data, scripts, or configuration files into the filesystem.</p><p>If the data or configuration is related to an application, the most logical thing to do is to package it together with the application's recipe itself, and if we think it is better to be installed separately, we could even split it into its own package.</p><p>But some other times, the data or configuration is unrelated to an application, maybe it applies to the whole system or we just want to provide a separate recipe for it. Optionally, we could even want to install some Perl or Python scripts that don't need to be compiled.</p><div class="section" title="How to do it..."><div class="titlepage"><div><div><h2 class="title"><a id="ch03lvl2sec122"/>How to do it...</h2></div></div></div><p>In those cases, our recipe should inherit the <code class="literal">allarch</code> class that is inherited by recipes that do not produce architecture-specific output.</p><p>An example of this type of recipe, <code class="literal">meta-custom/recipes-example/example-data/example-data_1.0.bb</code>, may be seen here:</p><div class="informalexample"><pre class="programlisting">DESCRIPTION = "Example of data or configuration recipe"
SECTION = "examples"

LICENSE = "GPLv2"
LIC_FILES_CHKSUM = "file://${COREBASE}/meta/files/common-licenses/GPL-2.0;md5=801f80980d171dd6425610833a22dbe6"

SRCREV = "${AUTOREV}"
SRC_URI = "git://github.com/yoctocookbook/examples.git \
           file://example.data"

S = "${WORKDIR}/git"

inherit allarch

do_compile() {
}

do_install() {
        install -d ${D}${sysconfdir}
        install -d ${D}${sbindir}
        install -m 0755 ${WORKDIR}/example.data ${D}/${sysconfdir}/
        install -m 0755 ${S}/python-scripts/* ${D}/${sbindir}
}</pre></div><p>It assumes that the <a id="id349" class="indexterm"/>fictitious <code class="literal">examples.git</code> repository contains a <code class="literal">python-scripts</code> folder, which we want to include in our root filesystem.</p><p>A working recipe <a id="id350" class="indexterm"/>example can be found in the source that accompanies the <a id="id351" class="indexterm"/>book.</p></div></div>
<div class="section" title="Managing users and groups"><div class="titlepage"><div><div><h1 class="title"><a id="ch03lvl1sec47"/>Managing users and groups</h1></div></div></div><p>It is also common <a id="id352" class="indexterm"/>to need to add or modify users and groups to our filesystem. This recipe <a id="id353" class="indexterm"/>explains how it is done.</p><div class="section" title="Getting ready"><div class="titlepage"><div><div><h2 class="title"><a id="ch03lvl2sec123"/>Getting ready</h2></div></div></div><p>The user information is stored in the <code class="literal">/etc/passwd</code> file, a text file that is used as a database for the system user's information. The <code class="literal">passwd</code> file is human-readable.</p><p>Each line on it corresponds to one user in the system, and it has the following format:</p><div class="informalexample"><pre class="programlisting">&lt;username&gt;:&lt;password&gt;:&lt;uid&gt;:&lt;gid&gt;:&lt;comment&gt;:&lt;home directory&gt;:&lt;login shell&gt;</pre></div><p>Let's see each of the parameters of this format:</p><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc"><code class="literal">username</code>: A unique string that identifies the user at login</li><li class="listitem" style="list-style-type: disc"><code class="literal">uid</code>: User ID, a number that Linux uses to identify the user</li><li class="listitem" style="list-style-type: disc"><code class="literal">gid</code>: Group ID, a number that Linux uses to identify the user's primary group</li><li class="listitem" style="list-style-type: disc"><code class="literal">comment</code>: Comma-separated values that describe the account, typically the user's contact details</li><li class="listitem" style="list-style-type: disc"><code class="literal">home directory</code>: Path to the user's home directory</li><li class="listitem" style="list-style-type: disc"><code class="literal">login shell</code>: Shell that is started for interactive logins</li></ul></div><p>The default <code class="literal">passwd</code> file is stored with the <code class="literal">base-passwd</code> package and looks as follows:</p><div class="informalexample"><pre class="programlisting">root::0:0:root:/root:/bin/sh
daemon:*:1:1:daemon:/usr/sbin:/bin/sh
bin:*:2:2:bin:/bin:/bin/sh
sys:*:3:3:sys:/dev:/bin/sh
sync:*:4:65534:sync:/bin:/bin/sync
games:*:5:60:games:/usr/games:/bin/sh
man:*:6:12:man:/var/cache/man:/bin/sh
lp:*:7:7:lp:/var/spool/lpd:/bin/sh
mail:*:8:8:mail:/var/mail:/bin/sh
news:*:9:9:news:/var/spool/news:/bin/sh
uucp:*:10:10:uucp:/var/spool/uucp:/bin/sh
proxy:*:13:13:proxy:/bin:/bin/sh
www-data:*:33:33:www-data:/var/www:/bin/sh
backup:*:34:34:backup:/var/backups:/bin/sh
list:*:38:38:Mailing List Manager:/var/list:/bin/sh
irc:*:39:39:ircd:/var/run/ircd:/bin/sh
gnats:*:41:41:Gnats Bug-Reporting System (admin):/var/lib/gnats:/bin/sh
nobody:*:65534:65534:nobody:/nonexistent:/bin/sh</pre></div><p>All accounts have <a id="id354" class="indexterm"/>disabled direct logins, indicated by an asterisk on the password field, except<a id="id355" class="indexterm"/> for root, which has no password. This is because, by default, the image is built with the <code class="literal">debug-tweaks</code> feature that enables passwordless login for the root user, among other things. If the root password was enabled, we would see the encrypted root password.</p><div class="note" title="Note" style=""><div class="inner"><h3 class="title"><a id="note21"/>Note</h3><p>Do not forget to remove the <code class="literal">debug-tweaks</code> feature from production images.</p></div></div><p>There is a corresponding <code class="literal">/etc/group</code> file that is installed at the same time with the information for the system groups.</p><p>The <code class="literal">core-image-minimal</code> image does not include shadow password protection, but other images, such as <code class="literal">core-image-full-cmdline</code>, do. When enabled, all password fields contain an <span class="emphasis"><em>x</em></span>, and the encrypted passwords are kept on a <code class="literal">/etc/shadow</code> file, which is only accessible to the super user.</p><p>Any user that is needed by the system but not included in the list we saw earlier needs to be created.</p></div><div class="section" title="How to do it..."><div class="titlepage"><div><div><h2 class="title"><a id="ch03lvl2sec124"/>How to do it...</h2></div></div></div><p>The standard <a id="id356" class="indexterm"/>way for a recipe to add or modify system users or groups is to use the <code class="literal">useradd</code> class, which uses the following variables:</p><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc"><code class="literal">USERADD_PACKAGES</code>: This <a id="id357" class="indexterm"/>variable specifies the individual packages in the recipe that require users or groups to be added. For the main package, you would use the following:<div class="informalexample"><pre class="programlisting">USERADD_PACKAGES = "${PN}"</pre></div></li><li class="listitem" style="list-style-type: disc"><code class="literal">USERADD_PARAM</code>: This variable corresponds to the arguments passed to the Linux <code class="literal">useradd</code> command, to add new users to the system.</li><li class="listitem" style="list-style-type: disc"><code class="literal">GROUPADD_PARAM</code>: This variable corresponds to the arguments passed to the Linux <code class="literal">groupadd</code> command, to add new groups to the system.</li><li class="listitem" style="list-style-type: disc"><code class="literal">GROUPMEMS_PARAM</code>: This variable corresponds to the arguments passed to the Linux <code class="literal">groupmems</code> command, which administers members of the user's primary group.</li></ul></div><p>An example snippet of a recipe using the <code class="literal">useradd</code> class follows:</p><div class="informalexample"><pre class="programlisting">inherit useradd

PASSWORD ?= "miDBHFo2hJSAA"
USERADD_PACKAGES = "${PN}"
USERADD_PARAM_${PN} = "--system --create-home \
                       --groups tty \
                       --password ${PASSWORD} \
                       --user-group ${PN}"</pre></div><p>The password can be generated on your host using the <code class="literal">mkpasswd</code> Linux command-line utility, installed with the <code class="literal">whois</code> Ubuntu package.</p></div><div class="section" title="There's more..."><div class="titlepage"><div><div><h2 class="title"><a id="ch03lvl2sec125"/>There's more...</h2></div></div></div><p>When generating users and groups using the <code class="literal">useradd</code> class, the <code class="literal">uid</code> and <code class="literal">gid</code> values are assigned dynamically during package installation. If this is not desired, there is a way to assign system-wide static <code class="literal">uid</code> and <code class="literal">gid</code> values by providing your own <code class="literal">passwd</code> and group files.</p><p>To do this, you need to define the <code class="literal">USERADDEXTENSION</code> variable in your <code class="literal">conf/local.conf</code> file as follows:</p><div class="informalexample"><pre class="programlisting">USERADDEXTENSION = "useradd-staticids"</pre></div><p>The build system will then search the <code class="literal">BBPATH</code> variable for <code class="literal">files/passwd</code> and <code class="literal">files/group</code> files to obtain the <code class="literal">uid</code> and <code class="literal">gid</code> values. The files have the standard <code class="literal">passwd</code> layout as defined previously, with the password field ignored.</p><p>The default filenames can be overridden by using the <code class="literal">USERADD_UID_TABLES</code> and <code class="literal">USERADD_GID_TABLES</code> variables.</p><p>You also need to define the following:</p><div class="informalexample"><pre class="programlisting">USERADD_ERROR_DYNAMIC = "1"</pre></div><p>This is done so that the build system produces an error if the required <code class="literal">uid</code> and <code class="literal">gid</code> values are not found in the provided files.</p><div class="note" title="Note" style=""><div class="inner"><h3 class="title"><a id="note22"/>Note</h3><p>Note that if you use the <code class="literal">useradd</code> class in a project that is already built, you will need to remove the <code class="literal">tmp</code> directory and rebuild from the <code class="literal">sstate-cache</code> directory or you will get build errors.</p></div></div><p>There is also a way to add user and group information that is not tied to a specific recipe but to an image – by using the <code class="literal">extrausers</code> class. It is configured by the <code class="literal">EXTRA_USERS_PARAMS</code> variable in an image recipe and used as follows:</p><div class="informalexample"><pre class="programlisting">inherit extrausers

EXTRA_USERS_PARAMS = "\
  useradd -P password root; \
  "</pre></div><p>This sets the root password to <code class="literal">password</code>.</p></div></div>
<div class="section" title="Using the sysvinit initialization manager"><div class="titlepage"><div><div><h1 class="title"><a id="ch03lvl1sec48"/>Using the sysvinit initialization manager</h1></div></div></div><p>The initialization <a id="id358" class="indexterm"/>manager is an important part of the root filesystem. It is the first thing the kernel executes, and it has the responsibility to start the rest of the system.</p><p>This recipe will introduce the <code class="literal">sysvinit</code> initialization manager.</p><div class="section" title="Getting ready"><div class="titlepage"><div><div><h2 class="title"><a id="ch03lvl2sec126"/>Getting ready</h2></div></div></div><p>This is the default initialization manager in Yocto and it has been used in Linux since the operating system's origin. The kernel is passed an <code class="literal">init</code> command-line argument, typically <code class="literal">/sbin/init</code>, which is then launched. This <code class="literal">init</code> process has PID 1 and is the parent of all processes. The <code class="literal">init</code> process can either be implemented by BusyBox or be an independent program installed with the <code class="literal">sysvinit</code> package. Both of them work in the same way, based on the concept of <a id="id359" class="indexterm"/>
<span class="strong"><strong>runlevel</strong></span>, a machine state that defines which processes to run.</p><p>The <code class="literal">init</code> process will read an <code class="literal">inittab</code> file and look for a default runlevel. The default <code class="literal">inittab</code> file is installed with the <code class="literal">sysvinit-inittab</code> package and is as follows:</p><div class="informalexample"><pre class="programlisting"># /etc/inittab: init(8) configuration.
# $Id: inittab,v 1.91 2002/01/25 13:35:21 miquels Exp $

# The default runlevel.
id:5:initdefault:

# Boot-time system configuration/initialization script.
# This is run first except when booting in emergency (-b) mode.
si::sysinit:/etc/init.d/rcS

# What to do in single-user mode.
~~:S:wait:/sbin/sulogin

# /etc/init.d executes the S and K scripts upon change
# of runlevel.
#
# Runlevel 0 is halt.
# Runlevel 1 is single-user.
# Runlevels 2-5 are multi-user.
# Runlevel 6 is reboot.

l0:0:wait:/etc/init.d/rc 0
l1:1:wait:/etc/init.d/rc 1
l2:2:wait:/etc/init.d/rc 2
l3:3:wait:/etc/init.d/rc 3
l4:4:wait:/etc/init.d/rc 4
l5:5:wait:/etc/init.d/rc 5
l6:6:wait:/etc/init.d/rc 6
# Normally not reached, but fallthrough in case of emergency.
z6:6:respawn:/sbin/sulogin</pre></div><p>Then, <code class="literal">init</code> runs all scripts starting with <code class="literal">S</code> in the <code class="literal">/etc/rcS.d</code> directory, followed by all the scripts starting with <code class="literal">S</code> in the <code class="literal">/etc/rcN.d</code> directory, where <code class="literal">N</code> is the runlevel value.</p><p>So the <code class="literal">init</code> process<a id="id360" class="indexterm"/> just performs the initialization and forgets about the processes. If something goes wrong and the processes are killed, no one will care. The system watchdog will reboot the system if it becomes unresponsive, but applications built with more than one process usually need some type of process monitor that can react to the health of the system, but <code class="literal">sysvinit</code> does not offer these types of mechanisms.</p><p>However, <code class="literal">sysvinit</code> is a well-understood and reliable initialization manager and the recommendation is to keep it unless you need some extra feature.</p></div><div class="section" title="How to do it..."><div class="titlepage"><div><div><h2 class="title"><a id="ch03lvl2sec127"/>How to do it...</h2></div></div></div><p>When using <code class="literal">sysvinit</code> as the initialization manager, Yocto offers the <code class="literal">update-rc.d</code> class as a helper to install initialization scripts so that they are started and stopped when needed.</p><p>When using this<a id="id361" class="indexterm"/> class, you need to specify the <code class="literal">INITSCRIPT_NAME</code> variable with the name of the script to install and <code class="literal">INITSCRIPT_PARAMS</code> with the options to pass to the <code class="literal">update-rc.d</code> utility. You can optionally use the <code class="literal">INITSCRIPT_PACKAGES</code> variable to list the packages to contain the initialization scripts. By default, this contains the main package only, and if multiple packages are provided, the <code class="literal">INITSCRIPT_NAME</code> and <code class="literal">INITSCRIPT_PARAMS</code> need to be specified for each using overrides. An example snippet follows:</p><div class="informalexample"><pre class="programlisting">INITSCRIPT_PACKAGES = "${PN}-httpd ${PN}-ftpd"
INITSCRIPT_NAME_${PN}-httpd = "httpd.sh"
INITSCRIPT_NAME_${PN}-ftpd = "ftpd.sh"
INITSCRIPT_PARAMS_${PN}-httpd = "defaults"
INITSCRIPT_PARAMS_${PN}-ftpd = "start 99 5 2 . stop 20 0 1 6 ."</pre></div><p>When an initialization script is not tied to a particular recipe, we can add a specific recipe for it. For example, the following recipe will run a <code class="literal">mount.sh</code> script in the <code class="literal">recipes-example/sysvinit-mount/sysvinit-mount_1.0.bb</code> file.</p><div class="informalexample"><pre class="programlisting">DESCRIPTION = "Initscripts for mounting filesystems"
LICENSE = "MIT"

LIC_FILES_CHKSUM = "file://${COMMON_LICENSE_DIR}/MIT;md5=0835ade698e0bcf8506ecda2f7b4 f302"

SRC_URI = "file://mount.sh"

INITSCRIPT_NAME = "mount.sh"
INITSCRIPT_PARAMS = "start 09 S ."

inherit update-rc.d

S = "${WORKDIR}"

do_install () {
    install -d ${D}${sysconfdir}/init.d/
    install -c -m 755 ${WORKDIR}/${INITSCRIPT_NAME} ${D}${sysconfdir}/init.d/${INITSCRIPT_NAME}
}</pre></div></div></div>
<div class="section" title="Using the systemd initialization manager"><div class="titlepage"><div><div><h1 class="title"><a id="ch03lvl1sec49"/>Using the systemd initialization manager</h1></div></div></div><p>As an alternative <a id="id362" class="indexterm"/>to <code class="literal">sysvinit</code>, you can configure your project to use <code class="literal">systemd</code> as an initialization manager, although <code class="literal">systemd</code> packs many more features.</p><div class="section" title="Getting ready"><div class="titlepage"><div><div><h2 class="title"><a id="ch03lvl2sec128"/>Getting ready</h2></div></div></div><p>The <code class="literal">systemd</code> initialization manager is replacing <code class="literal">sysvinit</code> and other initialization managers in most Linux distributions. It is based on the concepts of units, an abstraction of all elements that are relevant for system startup and maintenance, and targets, which group units and can be viewed as a runlevel equivalent. Some of the units <code class="literal">systemd</code> defines are:</p><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc">Services</li><li class="listitem" style="list-style-type: disc">Sockets</li><li class="listitem" style="list-style-type: disc">Devices</li><li class="listitem" style="list-style-type: disc">Mount points</li><li class="listitem" style="list-style-type: disc">Snapshots</li><li class="listitem" style="list-style-type: disc">Timers</li><li class="listitem" style="list-style-type: disc">Paths</li></ul></div><p>The default targets and their runlevel equivalents are defined in the following table:</p><div class="informaltable"><table border="1"><colgroup><col style="text-align: left"/><col style="text-align: left"/><col style="text-align: left"/><col style="text-align: left"/></colgroup><thead><tr><th style="text-align: left" valign="bottom">
<p>Sysvinit</p>
</th><th style="text-align: left" valign="bottom">
<p>Runlevel</p>
</th><th style="text-align: left" valign="bottom">
<p>Systemd target</p>
</th><th style="text-align: left" valign="bottom">
<p>Notes</p>
</th></tr></thead><tbody><tr><td style="text-align: left" valign="top">
<p>0</p>
</td><td style="text-align: left" valign="top">
<p><code class="literal">runlevel0.target</code></p>
</td><td style="text-align: left" valign="top">
<p><code class="literal">poweroff.target</code></p>
</td><td style="text-align: left" valign="top">
<p>Halt the system.</p>
</td></tr><tr><td style="text-align: left" valign="top">
<p>1, s, single</p>
</td><td style="text-align: left" valign="top">
<p><code class="literal">runlevel1.target</code></p>
</td><td style="text-align: left" valign="top">
<p><code class="literal">rescue.target</code></p>
</td><td style="text-align: left" valign="top">
<p>Single user mode.</p>
</td></tr><tr><td style="text-align: left" valign="top">
<p>2, 4</p>
</td><td style="text-align: left" valign="top">
<p><code class="literal">runlevel2.target</code>, <code class="literal">runlevel4.target</code></p>
</td><td style="text-align: left" valign="top">
<p><code class="literal">multi-user.target</code></p>
</td><td style="text-align: left" valign="top">
<p>User-defined/site-specific runlevels. By default, identical to <code class="literal">3</code>.</p>
</td></tr><tr><td style="text-align: left" valign="top">
<p>3</p>
</td><td style="text-align: left" valign="top">
<p><code class="literal">runlevel3.target</code></p>
</td><td style="text-align: left" valign="top">
<p><code class="literal">multi-user.target</code></p>
</td><td style="text-align: left" valign="top">
<p>Multiuser, non-graphical. Users can usually log in via multiple consoles or via the network.</p>
</td></tr><tr><td style="text-align: left" valign="top">
<p>5</p>
</td><td style="text-align: left" valign="top">
<p><code class="literal">runlevel5.target</code></p>
</td><td style="text-align: left" valign="top">
<p><code class="literal">graphical.target</code></p>
</td><td style="text-align: left" valign="top">
<p>Multiuser, graphical. Usually has all the services of runlevel 3 plus a graphical login.</p>
</td></tr><tr><td style="text-align: left" valign="top">
<p>6</p>
</td><td style="text-align: left" valign="top">
<p><code class="literal">runlevel6.target</code></p>
</td><td style="text-align: left" valign="top">
<p><code class="literal">reboot.target</code></p>
</td><td style="text-align: left" valign="top">
<p>Reboot the system.</p>
</td></tr></tbody></table></div><p>The <code class="literal">systemd</code> initialization manager is designed to be compatible with <code class="literal">sysvinit</code>, including using <code class="literal">sysvinit init</code> scripts.</p><p>Some of the<a id="id363" class="indexterm"/> features of <code class="literal">systemd</code> are:</p><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc">Parallelization capabilities that allow for faster boot times</li><li class="listitem" style="list-style-type: disc">Service initialization via sockets and D-Bus so that services are only started when needed</li><li class="listitem" style="list-style-type: disc">Process monitoring that allows for process failure recovery</li><li class="listitem" style="list-style-type: disc">System state snapshots and restoration</li><li class="listitem" style="list-style-type: disc">Mount point management</li><li class="listitem" style="list-style-type: disc">Transactional-dependency-based unit control, where units establish dependencies between them</li></ul></div></div><div class="section" title="How to do it..."><div class="titlepage"><div><div><h2 class="title"><a id="ch03lvl2sec129"/>How to do it...</h2></div></div></div><p>To configure <a id="id364" class="indexterm"/>your system to use <code class="literal">systemd</code>, you need to add the <code class="literal">systemd</code> distribution feature to your project by adding the following to your distribution's configuration file, under <code class="literal">sources/poky/meta-yocto/conf/distro/poky.conf</code> for the default <code class="literal">poky</code> distribution, or locally on your project's <code class="literal">conf/local.conf</code> file:</p><div class="informalexample"><pre class="programlisting">DISTRO_FEATURES_append = " systemd"</pre></div><div class="note" title="Note" style=""><div class="inner"><h3 class="title"><a id="note23"/>Note</h3><p>Note the space required after the starting quote.</p></div></div><div class="informalexample"><pre class="programlisting">VIRTUAL-RUNTIME_init_manager = "systemd"</pre></div><p>This configuration example allows you to define a main image with <code class="literal">systemd</code> and a rescue image with <code class="literal">sysvinit</code>, providing it does not use the <code class="literal">VIRTUAL-RUNTIME_init_manager</code> variable. Hence, the rescue image cannot use the <code class="literal">packagegroup-core-boot</code> or <code class="literal">packagegroup-core-full-cmdline</code> recipes. As an example, the recipe where the image size has been reduced, which we will introduce in the <span class="emphasis"><em>Reducing the root filesystem image size</em></span> recipe in this chapter, could be used as the basis for a rescue image.</p><p>To remove <code class="literal">sysvinit</code> completely from your system, you would do the following:</p><div class="informalexample"><pre class="programlisting">DISTRO_FEATURES_BACKFILL_CONSIDERED = "sysvinit"
VIRTUAL-RUNTIME_initscripts = ""</pre></div><p>Feature backfilling is the automatic extension of machine and distribution features to keep backwards compatibility. The <code class="literal">sysvinit</code> distribution feature is automatically filled in, so to remove it, we need to blacklist it by adding it to the <code class="literal">DISTRO_FEATURES_BACKFILL_CONSIDERED</code> variable as shown earlier.</p><div class="note" title="Note" style=""><div class="inner"><h3 class="title"><a id="tip12"/>Tip</h3><p>Note that if you are using an existing project and you change the <code class="literal">DISTRO_FEATURES</code> variable as explained earlier, you will need to remove the <code class="literal">tmp</code> directory and build with <code class="literal">sstate-cache</code> or the build will fail.</p></div></div></div><div class="section" title="There's more..."><div class="titlepage"><div><div><h2 class="title"><a id="ch03lvl2sec130"/>There's more...</h2></div></div></div><p>Not only does<a id="id365" class="indexterm"/> the root filesystem needs to be configured, but the Linux kernel also needs to be specifically configured with all the features required by <code class="literal">systemd</code>. There is an extensive list of kernel configuration variables in the <code class="literal">systemd</code> source README file. As an example, to extend the minimal kernel configuration that we will introduce in the <span class="emphasis"><em>Reducing the Linux kernel image size</em></span> recipe later on this chapter, for the Wandboard to support <code class="literal">systemd</code>, we would need to add the following configuration changes in the <code class="literal">arch/arm/configs/wandboard-quad_minimal_defconfig</code> file:</p><div class="informalexample"><pre class="programlisting">+CONFIG_FHANDLE=y
+CONFIG_CGROUPS=y
+CONFIG_SECCOMP=y
+CONFIG_NET=y
+CONFIG_UNIX=y
+CONFIG_INET=y
+CONFIG_AUTOFS4_FS=y
+CONFIG_TMPFS=y
+CONFIG_TMPFS_POSIX_ACL=y
+CONFIG_SCHEDSTATS=y</pre></div><p>The default kernel configuration provided for the Wandboard will launch a <code class="literal">core-image-minimal</code> image of <code class="literal">systemd</code> just fine.</p><div class="section" title="Installing systemd unit files"><div class="titlepage"><div><div><h3 class="title"><a id="ch03lvl3sec54"/>Installing systemd unit files</h3></div></div></div><p>Yocto offers <a id="id366" class="indexterm"/>the <code class="literal">systemd</code> class as a helper to install unit files. By default, unit files are installed on the <code class="literal">${systemd_unitdir}/system</code> path on the destination directory.</p><p>When using this class, you need to specify the <code class="literal">SYSTEMD_SERVICE_${PN}</code> variable with the name of the unit file to install. You can optionally use the <code class="literal">SYSTEMD_PACKAGES</code> variable to list the packages to contain the unit files. By default, this is the main package only, and if multiple packages are provided, the <code class="literal">SYSTEMD_SERVICE</code> variable needs to be specified using overrides.</p><p>Services are configured to launch at boot by default, but this can be changed with the <code class="literal">SYSTEMD_AUTO_ENABLE</code> variable.</p><p>An example snippet follows:</p><div class="informalexample"><pre class="programlisting">SYSTEMD_PACKAGES = "${PN}-syslog"
SYSTEMD_SERVICE_${PN}-syslog = "busybox-syslog.service"
SYSTEMD_AUTO_ENABLE = "disabled"</pre></div></div></div></div>
<div class="section" title="Installing package-installation scripts"><div class="titlepage"><div><div><h1 class="title"><a id="ch03lvl1sec50"/>Installing package-installation scripts</h1></div></div></div><p>The supported package<a id="id367" class="indexterm"/> formats, RPM, ipk, and deb, support the addition of installation scripts that can be run at different times during a package installation process. In this recipe, we will see how to install them.</p><div class="section" title="Getting ready"><div class="titlepage"><div><div><h2 class="title"><a id="ch03lvl2sec131"/>Getting ready</h2></div></div></div><p>There are different types of installation scripts:</p><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc"><span class="strong"><strong>Preinstallation scripts</strong></span> (<code class="literal">pkg_preinst</code>): These <a id="id368" class="indexterm"/>are called before the package is unpacked</li><li class="listitem" style="list-style-type: disc"><span class="strong"><strong>Postinstallation scripts</strong></span> (<code class="literal">pkg_postinst</code>): These <a id="id369" class="indexterm"/>are called after the package is unpacked, and dependencies will be configured</li><li class="listitem" style="list-style-type: disc"><span class="strong"><strong>Preremoval scripts</strong></span> (<code class="literal">pkg_prerm</code>): These are <a id="id370" class="indexterm"/>called with installed or at least partially installed packages</li><li class="listitem" style="list-style-type: disc"><span class="strong"><strong>Postremoval scripts</strong></span> (<code class="literal">pkg_postrm</code>): These<a id="id371" class="indexterm"/> are called after the package's files have been removed or replaced</li></ul></div></div><div class="section" title="How to do it..."><div class="titlepage"><div><div><h2 class="title"><a id="ch03lvl2sec132"/>How to do it...</h2></div></div></div><p>An example snippet of the installation of a preinstallation script in a recipe is as follows:</p><div class="informalexample"><pre class="programlisting">     pkg_preinst_${PN} () {
         # Shell commands
     }</pre></div><p>All installation scripts work in the same way, with the exception that the postinstallation scripts may be run either on the host at root filesystem image creation time, on the target (for those actions that cannot be performed on the host), or when a package is directly installed on the target. Have a look at the following code:</p><div class="informalexample"><pre class="programlisting"> pkg_postinst_${PN} () {
     if [ x"$D" = "x" ]; then
          # Commands to execute on device
     else
          # Commands to execute on host
     fi
 }</pre></div><p>If the postinstallation script succeeds, the package is marked as installed. If the script fails, the package is marked as unpacked and the script is executed when the image boots again.</p></div><div class="section" title="How it works..."><div class="titlepage"><div><div><h2 class="title"><a id="ch03lvl2sec133"/>How it works...</h2></div></div></div><p>Once the recipe defines an installation script, the class for the specific package type will install it while following the packaging rules of the specific format.</p><p>For postinstallation scripts, when running on the host, <code class="literal">D</code> is set to the destination directory, so the comparison test will <a id="id372" class="indexterm"/>fail. But <code class="literal">D</code> will be empty when running on the target.</p><div class="note" title="Note" style=""><div class="inner"><h3 class="title"><a id="note24"/>Note</h3><p>It is recommended to perform postinstallation scripts on the host if possible, as we need to take into account that some root filesystems will be read only and hence it would not be possible to perform some operations on the target.</p></div></div></div></div>
<div class="section" title="Reducing the Linux kernel image size"><div class="titlepage"><div><div><h1 class="title"><a id="ch03lvl1sec51"/>Reducing the Linux kernel image size</h1></div></div></div><p>Before or in parallel <a id="id373" class="indexterm"/>with the root filesystem customization, embedded projects usually require an image size optimization that will reduce the boot time and memory usage.</p><p>Smaller images mean less storage space, less transmission time, and less programming time, which saves money both in manufacturing and field updates.</p><p>By default, the compressed Linux<a id="id374" class="indexterm"/> kernel image (<span class="strong"><strong>zImage</strong></span>) for the <code class="literal">wandboard-quad</code> is around 5.2 MB. This recipe will show how we can reduce that.</p><div class="section" title="How to do it..."><div class="titlepage"><div><div><h2 class="title"><a id="ch03lvl2sec134"/>How to do it...</h2></div></div></div><p>An example of a minimal kernel configuration for a Wandboard that is able to boot from a microSD card root filesystem is the <code class="literal">arch/arm/configs/wandboard-quad_minimal_defconfig</code> file that follows:</p><div class="informalexample"><pre class="programlisting">CONFIG_KERNEL_XZ=y
CONFIG_NO_HZ=y
CONFIG_HIGH_RES_TIMERS=y
CONFIG_BLK_DEV_INITRD=y
CONFIG_CC_OPTIMIZE_FOR_SIZE=y
CONFIG_EMBEDDED=y
CONFIG_SLOB=y
CONFIG_ARCH_MXC=y
CONFIG_SOC_IMX6Q=y
CONFIG_SOC_IMX6SL=y
CONFIG_SMP=y
CONFIG_VMSPLIT_2G=y
CONFIG_AEABI=y
CONFIG_CPU_FREQ=y
CONFIG_ARM_IMX6_CPUFREQ=y
CONFIG_CPU_IDLE=y
CONFIG_VFP=y
CONFIG_NEON=y
CONFIG_DEVTMPFS=y
CONFIG_DEVTMPFS_MOUNT=y
CONFIG_PROC_DEVICETREE=y
CONFIG_SERIAL_IMX=y
CONFIG_SERIAL_IMX_CONSOLE=y
CONFIG_REGULATOR=y
CONFIG_REGULATOR_ANATOP=y
CONFIG_MMC=y
CONFIG_MMC_SDHCI=y
CONFIG_MMC_SDHCI_PLTFM=y
CONFIG_MMC_SDHCI_ESDHC_IMX=y
CONFIG_DMADEVICES=y
CONFIG_IMX_SDMA=y
CONFIG_EXT3_FS=y</pre></div><p>This configuration builds an 886 K compressed Linux kernel image (zImage).</p></div><div class="section" title="How it works..."><div class="titlepage"><div><div><h2 class="title"><a id="ch03lvl2sec135"/>How it works...</h2></div></div></div><p>Apart from hardware<a id="id375" class="indexterm"/> design considerations (such as running the Linux kernel from a NOR flash and <a id="id376" class="indexterm"/>
<span class="strong"><strong>execute in place</strong></span> (<span class="strong"><strong>XIP</strong></span>) to avoid loading the image to memory), the first step in kernel size optimization is to review the kernel configuration and remove all superfluous features.</p><p>To analyze the sizes of kernel blocks, we may use:</p><div class="informalexample"><pre class="programlisting">
<span class="strong"><strong>$ size vmlinux */built-in.o</strong></span>
<span class="strong"><strong>text    data     bss     dec     hex filename</strong></span>
<span class="strong"><strong>8746205  356560  394484 9497249  90eaa1 vmlinux</strong></span>
<span class="strong"><strong>117253    2418    1224  120895   1d83f block/built-in.o</strong></span>
<span class="strong"><strong>243859   11158      20  255037   3e43d crypto/built-in.o</strong></span>
<span class="strong"><strong>2541356  163465   34404 2739225  29cc19 drivers/built-in.o</strong></span>
<span class="strong"><strong>1956       0       0    1956     7a4 firmware/built-in.o</strong></span>
<span class="strong"><strong>1728762   18672   10544 1757978  1ad31a fs/built-in.o</strong></span>
<span class="strong"><strong>20361   14701     100   35162    895a init/built-in.o</strong></span>
<span class="strong"><strong>29628     760       8   30396    76bc ipc/built-in.o</strong></span>
<span class="strong"><strong>576593   20644  285052  882289   d7671 kernel/built-in.o</strong></span>
<span class="strong"><strong>106256   24847    2344  133447   20947 lib/built-in.o</strong></span>
<span class="strong"><strong>291768   14901    3736  310405   4bc85 mm/built-in.o</strong></span>
<span class="strong"><strong>1722683   39947   50928 1813558  1bac36 net/built-in.o</strong></span>
<span class="strong"><strong>34638     848     316   35802    8bda security/built-in.o</strong></span>
<span class="strong"><strong>276979   19748    1332  298059   48c4b sound/built-in.o</strong></span>
<span class="strong"><strong>138       0       0     138      8a usr/built-in.o</strong></span>
</pre></div><p>Here, <code class="literal">vmlinux</code> is the Linux kernel ELF image, which can be found in the Linux <code class="literal">build</code> directory.</p><p>Some of the<a id="id377" class="indexterm"/> usual things to exclude are:</p><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc">Remove IPv6 (<code class="literal">CONFIG_IPV6</code>) and other superfluous networking features</li><li class="listitem" style="list-style-type: disc">Remove block devices (<code class="literal">CONFIG_BLOCK</code>) if not needed</li><li class="listitem" style="list-style-type: disc">Remove cryptographic features (<code class="literal">CONFIG_CRYPTO</code>) if unused</li><li class="listitem" style="list-style-type: disc">Review the supported filesystem types and remove the unneeded ones, such as flash filesystems on flashless devices</li><li class="listitem" style="list-style-type: disc">Avoid modules and remove the module support (<code class="literal">CONFIG_MODULES</code>) from the kernel if possible</li></ul></div><p>A good strategy is to start with a minimal kernel and add the essential stuff until you get a working system. Start with the <code class="literal">allnoconfig</code> GNU make target and review the configuration items under <code class="literal">CONFIG_EXPERT</code> and <code class="literal">CONFIG_EMBEDDED</code> as they are not included in the <code class="literal">allnoconfig</code> setting.</p><p>Some configuration changes that might not be obvious but reduce the image size considerably without feature removal are listed here:</p><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc">Change the default compression method from <span class="strong"><strong>Lempel–Ziv–Oberhumer</strong></span> (<span class="strong"><strong>LZO</strong></span>)<a id="id378" class="indexterm"/> to XZ (<code class="literal">CONFIG_KERNEL_XZ</code>). The decompression speed will be a bit lower though.</li><li class="listitem" style="list-style-type: disc">Change the allocator from SLUB to <a id="id379" class="indexterm"/><span class="strong"><strong>Simple List Of Blocks</strong></span> (<span class="strong"><strong>SLOB</strong></span>) (<code class="literal">CONFIG_SLOB</code>) for small embedded systems with little memory.</li><li class="listitem" style="list-style-type: disc">Use no high memory (<code class="literal">CONFIG_HIGHMEM</code>) unless you have 4 GB or more memory.</li></ul></div><p>You may also want to have a different configuration for production and development systems, so you may remove the following from your production images:</p><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc"><code class="literal">printk</code> support (<code class="literal">CONFIG_PRINTK</code>)</li><li class="listitem" style="list-style-type: disc"><code class="literal">tracing</code> support (<code class="literal">CONFIG_FTRACE</code>)</li></ul></div><p>In the compilation side of things, optimize for size using <code class="literal">CONFIG_CC_OPTIMIZE_FOR_SIZE</code>.</p><p>Once the basics are covered, we would need to analyze the kernel functions to identify further reduction areas. You can print a sorted list of kernel symbols with the following:</p><div class="informalexample"><pre class="programlisting">
<span class="strong"><strong>$ nm --size-sort --print-size -r vmlinux | head</strong></span>
<span class="strong"><strong>          808bde04 00040000 B __log_buf</strong></span>
<span class="strong"><strong>          8060f1c0 00004f15 r kernel_config_data</strong></span>
<span class="strong"><strong>          80454190 000041f0 T hidinput_connect</strong></span>
<span class="strong"><strong>          80642510 00003d40 r drm_dmt_modes</strong></span>
<span class="strong"><strong>          8065cbbc 00003414 R v4l2_dv_timings_presets</strong></span>
<span class="strong"><strong>          800fbe44 000032c0 T __blockdev_direct_IO</strong></span>
<span class="strong"><strong>          80646290 00003100 r edid_cea_modes</strong></span>
<span class="strong"><strong>          80835970 00003058 t imx6q_clocks_init</strong></span>
<span class="strong"><strong>          8016458c 00002e74 t ext4_fill_super</strong></span>
<span class="strong"><strong>          8056a814 00002aa4 T hci_event_packet</strong></span>
</pre></div><p>You would then need to look into the kernel source to find optimizations.</p><p>The actual space used by the uncompressed kernel in memory can be obtained from a running Wandboard kernel log as follows:</p><div class="informalexample"><pre class="programlisting">
<span class="strong"><strong>$ dmesg | grep -A 3 "text"</strong></span>
<span class="strong"><strong>      .text : 0x80008000 - 0x80a20538   (10338 kB)</strong></span>
<span class="strong"><strong>      .init : 0x80a21000 - 0x80aae240   ( 565 kB)</strong></span>
<span class="strong"><strong>      .data : 0x80ab0000 - 0x80b13644   ( 398 kB)</strong></span>
<span class="strong"><strong>      .bss  : 0x80b13644 - 0x80b973fc   ( 528 kB)</strong></span>
</pre></div><p>From here, the <code class="literal">.text</code> section contains code and constant data, the <code class="literal">.data</code> section contains the initialization data for variables, and the <code class="literal">.bss</code> sections contains all uninitialized data. The <code class="literal">.init</code> section contains global variables used during Linux initialization only, which are freed afterwards as can be seen from the following Linux kernel boot message:</p><div class="informalexample"><pre class="programlisting">Freeing unused kernel memory: 564K (80a21000 - 80aae000)</pre></div><p>There are ongoing efforts to reduce the size of the Linux kernel, so it is expected that newer kernel versions will be smaller and will allow for better customization for use in <a id="id380" class="indexterm"/>embedded systems.</p></div></div>
<div class="section" title="Reducing the root filesystem image size"><div class="titlepage"><div><div><h1 class="title"><a id="ch03lvl1sec52"/>Reducing the root filesystem image size</h1></div></div></div><p>By default, the <code class="literal">core-image-minimal</code> size for the <code class="literal">wandboard-quad</code> unpacked tarball is around 45 MB, <a id="id381" class="indexterm"/>and <code class="literal">core-image-sato</code> is around 150 MB. This recipe will explore methods to reduce their size.</p><div class="section" title="How to do it..."><div class="titlepage"><div><div><h2 class="title"><a id="ch03lvl2sec136"/>How to do it...</h2></div></div></div><p>An example of a small image, <code class="literal">core-image-small</code>, that does not include the <code class="literal">packagegroup-core-boot</code> recipe and can be used as the base for a root filesystem image with reduced size, <code class="literal">recipes-core/images/core-image-small.bb</code>, is shown next:</p><div class="informalexample"><pre class="programlisting">DESCRIPTION = "Minimal console image."

IMAGE_INSTALL= "\
        base-files \
        base-passwd \
        busybox \
        sysvinit \
        initscripts \
        ${ROOTFS_PKGMANAGE_BOOTSTRAP} \
        ${CORE_IMAGE_EXTRA_INSTALL} \
"

IMAGE_LINGUAS = " "

LICENSE = "MIT"

inherit core-image

IMAGE_ROOTFS_SIZE ?= "8192"</pre></div><p>This recipe produces an image of about 6.4 MB. You can go even smaller if you use the <code class="literal">poky-tiny</code> distribution by adding the following to your <code class="literal">conf/local.conf</code> file:</p><div class="informalexample"><pre class="programlisting">DISTRO = "poky-tiny"</pre></div><p>The <code class="literal">poky-tiny</code> <a id="id382" class="indexterm"/>distribution makes a series of size optimizations that may restrict the set of packages you can include in your image. To successfully build this image, you have to skip one of the sanity checks that the Yocto build system performs, by adding the following:</p><div class="informalexample"><pre class="programlisting">INSANE_SKIP_glibc-locale = "installed-vs-shipped"</pre></div><p>With <code class="literal">poky-tiny</code>, the size of the image is further reduced to around 4 MB.</p><p>There are further reductions that can be done to the image; for example, we could replace <code class="literal">sysvinit</code> with <code class="literal">tiny-init</code>, but that is left as an exercise for the reader.</p><p>Images with reduced sizes are also used alongside production images for tasks such as rescue systems and manufacturing test processes. They are also ideal to be built as <code class="literal">initramfs</code> images; that is, images that the Linux kernel mounts from memory, and can even be bundled into a single Linux kernel image binary.</p></div><div class="section" title="How it works..."><div class="titlepage"><div><div><h2 class="title"><a id="ch03lvl2sec137"/>How it works...</h2></div></div></div><p>Start with an <a id="id383" class="indexterm"/>appropriate image like <code class="literal">core-image-minimal</code> and analyze the dependencies as shown in the <span class="emphasis"><em>Debugging the build system</em></span> recipe in <a class="link" href="ch01.html" title="Chapter 1. The Build System">Chapter 1</a>, <span class="emphasis"><em>The Build System</em></span>, and decide which of them are not needed. You could also use the file sizes listed in the image's build history, as seen in the <span class="emphasis"><em>Using build history</em></span> recipe, also in <a class="link" href="ch01.html" title="Chapter 1. The Build System">Chapter 1</a>, <span class="emphasis"><em>The Build System</em></span>, to detect the biggest files in the filesystem and review them. To sort the file sizes, which appear in the fourth column of the <code class="literal">files-in-image.txt</code> file, in reverse order, we could execute:</p><div class="informalexample"><pre class="programlisting">
<span class="strong"><strong>$ sort -r -g  -k 4,4 files-in-image.txt -o sorted-files-in-image.txt</strong></span>
<span class="strong"><strong>sorted-files-in-image.txt:</strong></span>
<span class="strong"><strong>-rwxr-xr-x root       root          1238640 ./lib/libc-2.19.so</strong></span>
<span class="strong"><strong>-rwxr-xr-x root       root           613804 ./sbin/ldconfig</strong></span>
<span class="strong"><strong>-rwxr-xr-x root       root           539860 ./bin/busybox.nosuid</strong></span>
<span class="strong"><strong>-rwxr-xr-x root       root           427556 ./lib/libm-2.19.so</strong></span>
<span class="strong"><strong>-rwxr-xr-x root       root           130304 ./lib/ld-2.19.so</strong></span>
<span class="strong"><strong>-rwxr-xr-x root       root            88548 ./lib/libpthread-2.19.so</strong></span>
<span class="strong"><strong>-rwxr-xr-x root       root            71572 ./lib/libnsl-2.19.so</strong></span>
<span class="strong"><strong>-rwxr-xr-x root       root            71488 ./lib/libresolv-2.19.so</strong></span>
<span class="strong"><strong>-rwsr-xr-x root       root            51944 ./bin/busybox.suid</strong></span>
<span class="strong"><strong>-rwxr-xr-x root       root            42668 ./lib/libnss_files- 2.19.so</strong></span>
<span class="strong"><strong>-rwxr-xr-x root       root            30536 ./lib/libnss_compat- 2.19.so</strong></span>
<span class="strong"><strong>-rwxr-xr-x root       root            30244 ./lib/libcrypt-2.19.so</strong></span>
<span class="strong"><strong>-rwxr-xr-x root       root            28664 ./sbin/init.sysvinit</strong></span>
<span class="strong"><strong>-rwxr-xr-x root       root            26624 ./lib/librt-2.19.so</strong></span>
</pre></div><p>From this, we observe that <code class="literal">glic</code> is the biggest contributor to the filesystem size. Some other places where some space on a console-only system can be saved are:</p><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc">Use the IPK package manager, as it is the lightest, or better yet, remove the <code class="literal">package-management</code> feature from your production root filesystem altogether.</li><li class="listitem" style="list-style-type: disc">Use BusyBox's <code class="literal">mdev</code> device manager instead of <code class="literal">udev</code> by specifying it in your <code class="literal">conf/local.conf</code> file as follows:<div class="informalexample"><pre class="programlisting">VIRTUAL-RUNTIME_dev_manager = "mdev"</pre></div><p>Note that this will only work with core images that include <code class="literal">packagegroup-core-boot</code>.</p></li><li class="listitem" style="list-style-type: disc">If we are running the root filesystem on a block device, use ext2 instead of ext3 or ext4 without the journal.</li><li class="listitem" style="list-style-type: disc">Configure BusyBox with only the essential applets by providing your own configuration file in <code class="literal">bbappend</code>.</li><li class="listitem" style="list-style-type: disc">Review the <code class="literal">glibc</code> configuration, which can be changed via the <code class="literal">DISTRO_FEATURES_LIBC</code> distribution configuration variable. An example of its usage can be found in the <code class="literal">poky-tiny</code> distribution, which is included in the <code class="literal">poky</code> source. The <code class="literal">poky-tiny</code> distribution can be used as a template for the distribution customization of small systems.</li><li class="listitem" style="list-style-type: disc">Consider<a id="id384" class="indexterm"/> switching to a lighter <code class="literal">C</code> library than the default <code class="literal">glibc</code>. For a while, <code class="literal">uclibc</code> was being used as an alternative, but the library seems to be unmaintained for the last couple of years, and the <code class="literal">core-image-minimal</code> image for the Wandboard does not currently build using it.<div class="note" title="Note" style=""><div class="inner"><h3 class="title"><a id="note25"/>Note</h3><p>Recently, there has been some activity with <span class="strong"><strong>musl</strong></span> (<a class="ulink" href="http://www.musl-libc.org/">http://www.musl-libc.org/</a>), a new MIT-licensed <code class="literal">C</code> library. To enable it, you would add the following to your <code class="literal">conf/local.conf</code> file:</p><p>TCLIBC = "musl"</p><p>And you would need to add the <code class="literal">meta-musl</code> layer (<a class="ulink" href="https://github.com/kraj/meta-musl">https://github.com/kraj/meta-musl</a>) to your <code class="literal">conf/bblayers.conf</code> file.</p><p>It currently builds <code class="literal">core-image-minimal</code> for QEMU targets, but there is still work to be done to use it on real hardware like the Wandboard.</p></div></div></li><li class="listitem" style="list-style-type: disc">Compile your applications with <code class="literal">-Os</code> to optimize for size.</li></ul></div></div></div>
<div class="section" title="Releasing software"><div class="titlepage"><div><div><h1 class="title"><a id="ch03lvl1sec53"/>Releasing software</h1></div></div></div><p>When releasing a <a id="id385" class="indexterm"/>product based on the Yocto project, we have to consider that we are building on top of a multitude of different open source projects, each with different licensing requirements.</p><p>At the minimum, your embedded product will contain a bootloader (probably U-Boot), the Linux kernel, and a root filesystem with one or more applications. Both U-Boot and the Linux kernel are licensed under the<a id="id386" class="indexterm"/> <span class="strong"><strong>General Public License version 2</strong></span> (<span class="strong"><strong>GPLv2</strong></span>). And the root filesystem could contain a variety of programs with different licenses.</p><p>All open source licenses allow you to sell a commercial product with a mixture of proprietary and open licenses as long as they are independent and the product complies with all the open source licenses. We will discuss open source and proprietary cohabiting in the <span class="emphasis"><em>Working with open source and proprietary code</em></span> recipe later on.</p><p>It is important to understand all the licensing implications before releasing your product to the public. The Yocto project provides tools to make handling licensing requirements an easier job.</p><div class="section" title="Getting ready"><div class="titlepage"><div><div><h2 class="title"><a id="ch03lvl2sec138"/>Getting ready</h2></div></div></div><p>We first need to specify what requirements we need to comply with to distribute a product built with the Yocto project. For the most restrictive open source licenses, this usually means:</p><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc">Source code distribution, including modifications</li><li class="listitem" style="list-style-type: disc">License texts distributions</li><li class="listitem" style="list-style-type: disc">Distribution of the tools used to build and run the software</li></ul></div></div><div class="section" title="How to do it..."><div class="titlepage"><div><div><h2 class="title"><a id="ch03lvl2sec139"/>How to do it...</h2></div></div></div><p>We can use the <code class="literal">archiver</code> class to provide the deliverables that need to be distributed to comply with the <a id="id387" class="indexterm"/>licenses. We can configure it to:</p><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc">Provide the original unpatched source as tarballs</li><li class="listitem" style="list-style-type: disc">Provide the patches to apply to the original source</li><li class="listitem" style="list-style-type: disc">Provide the recipes used to build the source</li><li class="listitem" style="list-style-type: disc">Provide the license text that must sometimes accompany the binary (according to some licenses)</li></ul></div><p>To use the <code class="literal">archiver</code> class as specified earlier, we add the following to our <code class="literal">conf/local.conf</code> file:</p><div class="informalexample"><pre class="programlisting">INHERIT += "archiver"
ARCHIVER_MODE[src] = "original"
ARCHIVER_MODE[diff] = "1"
ARCHIVER_MODE[recipe] = "1"
COPY_LIC_MANIFEST = "1"
COPY_LIC_DIRS = "1"</pre></div><p>The sources will be provided in the <code class="literal">tmp/deploy/sources</code> directory under a license subdirectory hierarchy.</p><p>For the <code class="literal">wandboard-quad</code>, we find the following directories under <code class="literal">tmp/deploy/sources</code>:</p><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc"><code class="literal">allarch-poky-linux</code></li><li class="listitem" style="list-style-type: disc"><code class="literal">arm-poky-linux-gnueabi</code></li></ul></div><p>And looking for<a id="id388" class="indexterm"/> what's distributed for the Linux kernel source, a GPLv2 package, we find under <code class="literal">tmp/deploy/sources/arm-poky-linux-gnueabi/linux-wandboard-3.10.17-r0</code>:</p><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc"><code class="literal">defconfig</code></li><li class="listitem" style="list-style-type: disc"><code class="literal">github.com.wandboard-org.linux.git.tar.gz</code></li><li class="listitem" style="list-style-type: disc"><code class="literal">linux-wandboard-3.10.17-r0-recipe.tar.gz</code></li></ul></div><p>So we have the kernel configuration, the source tarball, and the recipes used to build it, which include:</p><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc"><code class="literal">linux-wandboard_3.10.17.bb</code></li><li class="listitem" style="list-style-type: disc"><code class="literal">linux-dtb.inc</code></li><li class="listitem" style="list-style-type: disc"><code class="literal">linux-wandboard.inc</code></li></ul></div><p>And the license text for the root filesystem packages will also be included in the root filesystem under <code class="literal">/usr/share/common-licenses</code>, in a package directory hierarchy.</p><p>This configuration will provide deliverables for all build packages, but what we really want to do is provide them only for those whose licenses require us to.</p><p>For sure, we don't want to blindly distribute all the contents of the <code class="literal">sources</code> directory as is, as it will also contain our proprietary source, which we most likely don't want to distribute.</p><p>We can configure the <code class="literal">archiver</code> class only to provide the source for GPL and LGPL packages with the following:</p><div class="informalexample"><pre class="programlisting">COPYLEFT_LICENSE_INCLUDE = "GPL* LGPL*"
COPYLEFT_LICENSE_EXCLUDE = "CLOSED Proprietary"</pre></div><p>And also, for an embedded product, we are usually only concerned with the software that ships in the product itself, so we can limit the recipe type to be archived to target images with the following:</p><div class="informalexample"><pre class="programlisting">COPYLEFT_RECIPE_TYPES = "target"</pre></div><p>We should obtain legal advice to decide which packages have licenses that make source distribution a requirement.</p><p>Other configuration options exist, such as providing the patched or configured source instead of the separated original source and patches, or source <code class="literal">rpms</code> instead of source tarballs. See the <code class="literal">archiver</code> class for more details.</p></div><div class="section" title="There's more…"><div class="titlepage"><div><div><h2 class="title"><a id="ch03lvl2sec140"/>There's more…</h2></div></div></div><p>We can also choose to distribute the whole of our build environment. The best way to do this is usually to publish our BSP and software layers on a public Git repository. Our software layer can then provide <code class="literal">bblayers.conf.sample</code> and <code class="literal">local.conf.sample</code>, which can be used to set up ready-to-use <code class="literal">build</code> directories.</p></div><div class="section" title="See also"><div class="titlepage"><div><div><h2 class="title"><a id="ch03lvl2sec141"/>See also</h2></div></div></div><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc">There are other requirements that haven't been discussed here, such as the mechanism chosen for distribution. It is recommended to get legal advice before releasing a product to ensure all the license obligations have been met.</li></ul></div></div></div>
<div class="section" title="Analyzing your system for compliance"><div class="titlepage"><div><div><h1 class="title"><a id="ch03lvl1sec54"/>Analyzing your system for compliance</h1></div></div></div><p>The Yocto build system <a id="id389" class="indexterm"/>makes it easy to provide auditing information<a id="id390" class="indexterm"/> to our legal advisers. This recipe will explain how.</p><div class="section" title="How to do it..."><div class="titlepage"><div><div><h2 class="title"><a id="ch03lvl2sec142"/>How to do it...</h2></div></div></div><p>Under <code class="literal">tmp/deploy/licenses</code>, we find a directory list of packages (including their corresponding licenses) and an <code class="literal">image</code> folder with a package and license manifest.</p><p>For the example image provided before, <code class="literal">core-image-small</code>, we have the following:</p><div class="informalexample"><pre class="programlisting">
<span class="strong"><strong>tmp/deploy/licenses/core-image-small-wandboard-quad-&lt;timestamp&gt;/package.manifest</strong></span>
base-files
base-passwd
busybox
busybox-syslog
busybox-udhcpc
initscripts
initscripts-functions
libc6
run-postinsts
sysvinit
sysvinit-inittab
sysvinit-pidof
update-alternatives-opkg
update-rc.d</pre></div><p>And the corresponding <code class="literal">tmp/deploy/licenses/core-image-small-wandboard-quad-&lt;timestamp&gt;/license.manifest</code> file excerpt is as follows:</p><div class="informalexample"><pre class="programlisting">PACKAGE NAME: base-files
PACKAGE VERSION: 3.0.14
RECIPE NAME: base-files
LICENSE: GPLv2

PACKAGE NAME: base-passwd
PACKAGE VERSION: 3.5.29
RECIPE NAME: base-passwd
LICENSE: GPLv2+</pre></div><p>These files can be<a id="id391" class="indexterm"/> used to analyze all the different packages that <a id="id392" class="indexterm"/>form our root filesystem. We can also audit them to make sure we comply with the licenses when releasing our product to the public.</p></div><div class="section" title="There's more"><div class="titlepage"><div><div><h2 class="title"><a id="ch03lvl2sec143"/>There's more</h2></div></div></div><p>You can instruct the Yocto build system to specifically avoid certain licenses by using the <code class="literal">INCOMPATIBLE_LICENSE</code> configuration variable. The usual way to use it is to avoid GPLv3-type licenses by adding the following to your <code class="literal">conf/local.conf</code> file:</p><div class="informalexample"><pre class="programlisting">INCOMPATIBLE_LICENSE = "GPL-3.0 LGPL-3.0 AGPL-3.0"</pre></div><p>This will build <code class="literal">core-image-minimal</code> and <code class="literal">core-image-base</code> images as long as no extra image features are included.</p></div></div>
<div class="section" title="Working with open source and proprietary code"><div class="titlepage"><div><div><h1 class="title"><a id="ch03lvl1sec55"/>Working with open source and proprietary code</h1></div></div></div><p>It is common for an <a id="id393" class="indexterm"/>embedded product to be built upon an open source system like the one built by Yocto, and to include proprietary software that adds value and specializes the product. This proprietary part usually is intellectual property and needs to be protected, and it's important to understand how it can coexist with open source.</p><p>This recipe will discuss some examples of open source packages commonly found on embedded products and will briefly explain how to use proprietary software with them.</p><div class="section" title="How to do it..."><div class="titlepage"><div><div><h2 class="title"><a id="ch03lvl2sec144"/>How to do it...</h2></div></div></div><p>Open source licenses<a id="id394" class="indexterm"/> can be broadly divided into two categories based on whether they are:</p><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc"><span class="strong"><strong>Permissive</strong></span>: These are similar to <a id="id395" class="indexterm"/><span class="strong"><strong>Internet Software Consortium</strong></span> (<span class="strong"><strong>ISC</strong></span>), MIT, and BSD<a id="id396" class="indexterm"/> licenses. They have few requirements attached to them and just require us to preserve copyright notices.</li><li class="listitem" style="list-style-type: disc"><span class="strong"><strong>Restrictive</strong></span>: These <a id="id397" class="indexterm"/>are similar to the GPL, which bind us to not only distribute the source code and modifications, either with the binary itself or at a later date, but also to distribute tools to build, install, and run the source.</li></ul></div><p>However, some licenses might "pollute" modifications and derivative work with their own conditions, commonly referred to as <span class="emphasis"><em>viral licenses</em></span>, while others will not. For example, if you link your application to GPL-licensed code, your application will be bound by the GPL too.</p><p>The virulent nature<a id="id398" class="indexterm"/> of the GPL has made some people wary of using GPL-licensed software, but it's important to note that proprietary software can run alongside GPL software as long as the license terms are understood and respected.</p><p>For example, violating the GPLv2 license would mean losing the right to distribute the GPLv2 code in the future, even if further distribution is GPLv2 compliant. In this case, the only way to be able to distribute the code again would be to ask the copyright holder for permission.</p></div><div class="section" title="How it works..."><div class="titlepage"><div><div><h2 class="title"><a id="ch03lvl2sec145"/>How it works...</h2></div></div></div><p>Next, we will provide guidance regarding licensing requirements for some open source packages commonly used in embedded products. It does not constitute legal advice, and as stated before, proper legal auditing of your product should be done before public release.</p><div class="section" title="The U-Boot bootloader"><div class="titlepage"><div><div><h3 class="title"><a id="ch03lvl3sec55"/>The U-Boot bootloader</h3></div></div></div><p>U-Boot is licensed<a id="id399" class="indexterm"/> under the GPLv2, but any program launched by it does not inherit its license. So you are free to use U-Boot to launch a proprietary operating system, for example. However, your final product must comply with the GPLv2 with regards to U-Boot, so U-Boot source code and modifications must be provided.</p></div><div class="section" title="The Linux kernel"><div class="titlepage"><div><div><h3 class="title"><a id="ch03lvl3sec56"/>The Linux kernel</h3></div></div></div><p>The Linux kernel is also<a id="id400" class="indexterm"/> licensed under the GPLv2. Any application that runs in the Linux kernel user space does not inherit its license, so you can run your proprietary software in Linux freely. However, Linux kernel modules are part of the Linux kernel and as such must comply with the GPLv2. Also, your final product must release the Linux kernel source and modifications, including external modules that run in your product.</p></div><div class="section" title="Glibc"><div class="titlepage"><div><div><h3 class="title"><a id="ch03lvl3sec57"/>Glibc</h3></div></div></div><p>The GNU <code class="literal">C</code> library is licensed under the<a id="id401" class="indexterm"/> <span class="strong"><strong>Lesser General Public License</strong></span> (<span class="strong"><strong>LGPL</strong></span>), which<a id="id402" class="indexterm"/> allows dynamic linking without license inheritance. So your proprietary code can dynamically link with <code class="literal">glibc</code>, but of course you still have to comply with the LGPL with regards to <code class="literal">glibc</code>. Note, however, that statically linking your application would pollute it with the LGPL.</p></div><div class="section" title="BusyBox"><div class="titlepage"><div><div><h3 class="title"><a id="ch03lvl3sec58"/>BusyBox</h3></div></div></div><p>BusyBox is also<a id="id403" class="indexterm"/> licensed under the GPLv2. The license allows for non-related software to run alongside it, so your proprietary software can run alongside BusyBox freely. As before, you have to comply with the GPLv2 with regards to BusyBox and distribute its source and modifications.</p></div><div class="section" title="The Qt framework"><div class="titlepage"><div><div><h3 class="title"><a id="ch03lvl3sec59"/>The Qt framework</h3></div></div></div><p>Qt is licensed under three different <a id="id404" class="indexterm"/>licenses, which is common for open source projects. You can choose whether you want a commercial license (in which case, your proprietary application is protected), a LGPL license (which, as discussed before, would also protect your proprietary software by allowing the dynamic linking of your application as long as you complied with the LGPL for the Qt framework itself), or the GPLv3 (which would be inherited by your application).</p></div><div class="section" title="The X Windows system"><div class="titlepage"><div><div><h3 class="title"><a id="ch03lvl3sec60"/>The X Windows system</h3></div></div></div><p>The <code class="literal">X.Org</code> source is licensed under <a id="id405" class="indexterm"/>permissive MIT-style licenses. As such, your proprietary software is free to make any use of it as long as its use is stated and copyright notices are preserved.</p></div></div><div class="section" title="There's more..."><div class="titlepage"><div><div><h2 class="title"><a id="ch03lvl2sec146"/>There's more...</h2></div></div></div><p>Let's see how to integrate our proprietary-licensed code into the Yocto build system. When preparing the recipe for our application, we can take several approaches to licensing:</p><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc">Mark <code class="literal">LICENSE</code> as closed. This is the usual case for a proprietary application. We use the following:<div class="informalexample"><pre class="programlisting">LICENSE = "CLOSED"</pre></div></li><li class="listitem" style="list-style-type: disc">Mark <code class="literal">LICENSE</code> as proprietary and include some type of license agreement. This is commonly done when releasing binaries with some sort of end user agreement that is referenced in the recipe. For example, <code class="literal">meta-fsl-arm</code> uses this type of license to comply with Freescale's End User License Agreement. An example follows:<div class="informalexample"><pre class="programlisting">LICENSE = "Proprietary"
LIC_FILES_CHKSUM = "file://EULA.txt;md5=93b784b1c11b3fffb1638498a8dde3f6"</pre></div></li><li class="listitem" style="list-style-type: disc">Provide multiple licensing options, such as an open source license and a commercial license. In this case, the <code class="literal">LICENSE</code> variable is used to specify the open licenses, and the <code class="literal">LICENSE_FLAGS</code> variable is used for the commercial licenses. A typical example is the <code class="literal">gst-plugins-ugly</code> package in Poky:<div class="informalexample"><pre class="programlisting">LICENSE = "GPLv2+ &amp; LGPLv2.1+ &amp; LGPLv2+"
LICENSE_FLAGS = "commercial"
LIC_FILES_CHKSUM = "file://COPYING;md5=a6f89e2100d9b6cdffcea4f398e37343 \ file://gst/synaesthesia/synaescope.h;beginline=1;endline=20 ;md5=99f301df7b80490c6ff8305fcc712838 \  file://tests/check/elements/xingmux.c;beginline=1;endline=2 1;md5=4c771b8af188724855cb99cadd390068 \  file://gst/mpegstream/gstmpegparse.h;beginline=1;endline=18 ;md5=ff65467b0c53cdfa98d0684c1bc240a9"</pre></div></li></ul></div><p>When the <code class="literal">LICENSE_FLAGS</code> variable is set on a recipe, the package will not be built unless the license appears on the <code class="literal">LICENSE_FLAGS_WHITELIST</code> variable too, typically defined in your <code class="literal">conf/local.conf</code> file. For the earlier example, we would add:</p><div class="informalexample"><pre class="programlisting">LICENSE_FLAGS_WHITELIST = "commercial"</pre></div><p>The <code class="literal">LICENSE</code> and <code class="literal">LICENSE_FLAGS_WHITELIST</code> variables can match exactly for a very narrow match or broadly, as in the preceding example, which matches all licenses that begin with the word <code class="literal">commercial</code>. For narrow matches, the package name must be appended to the license name; for instance, if we only wanted to whitelist the <code class="literal">gst-plugins-ugly</code> package from the earlier example but nothing else, we could use the following:</p><div class="informalexample"><pre class="programlisting">LICENSE_FLAGS_WHITELIST = "commercial_gst-plugins-ugly"</pre></div></div><div class="section" title="See also"><div class="titlepage"><div><div><h2 class="title"><a id="ch03lvl2sec147"/>See also</h2></div></div></div><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc">You should refer to the specific licenses for a complete understanding of the requirements imposed by them. You can find a complete list of open source licenses and their documentation at <a class="ulink" href="http://spdx.org/licenses/">http://spdx.org/licenses/</a>.</li></ul></div></div></div></body></html>