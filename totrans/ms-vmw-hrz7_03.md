# 理解 Horizon 7 架构和组件

在上一章中，我们介绍了虚拟桌面基础设施，特别是 VMware 的解决方案 VMware Horizon。作为介绍的一部分，我们高层次地了解了构成完整解决方案的一些不同组件。在本章中，我们将开始深入探讨这些架构和基础设施组件，重点讨论它们如何协同工作，共同构成完整的解决方案。

本章的各个部分将讨论每个 Horizon View 组件的作用，解释每个组件在整体基础设施中的位置和作用。我们首先会解释高层次的概念，然后深入探讨每个单独组件的工作原理。在我们逐步讨论这些部分时，还会强调一些最佳实践，并提供一些有用的提示和建议。

在这个过程中，我们还将介绍一些与 VMware Horizon 集成和互补的第三方技术，如杀毒解决方案、存储加速技术和高端图形解决方案，这些都帮助提供一个从数据中心到最终用户的完整端到端解决方案。阅读完本章后，你将能够描述 Horizon 的每个组件，例如：

+   连接服务器

+   安全服务器

+   副本服务器

+   安全性与 VMware 统一访问网关

+   在 **View Persona Management** (**VDI**) 和 **User Environment Manager** (**UEM**) 中管理最终用户配置文件

+   显示协议

+   链接、即时和完全克隆

+   硬件加速图形（vSGA、vDGA 和 vGPU）

我们将讨论每个组件在整体解决方案中的作用，以及为什么要使用它们，如何配置它们，以及安装的前提条件。

# 介绍关键的 Horizon 组件

首先，我们将高层次地介绍构成 Horizon View 解决方案的核心基础设施组件和架构。我们将从如图所示的顶层概览开始，然后再深入探讨每个组件的详细信息：

![](img/e500b731-1e9b-4aa7-ab7d-b44a6d077cb0.png)

在前面的图表中描述的所有 VMware Horizon 组件都是整体 Horizon 解决方案的一部分，但不要忘记，一些可用功能取决于你所购买的版本。

还值得记住的是，Horizon 许可包括相关的 vSphere 组件、ESXi 虚拟化程序和 vCenter Server 许可，使你能够部署核心托管基础设施。你可以根据需要部署任意数量的 ESXi 主机和 vCenter 服务器来托管桌面基础设施。

# 高层次的架构概述

本节我们将讨论 Horizon View 的核心功能，特别是如何为托管在 VMware vSphere 平台上的虚拟桌面机器提供代理服务。

Horizon 架构易于理解，因为它的基础建立在标准的 VMware vSphere 产品（ESXi 和 vCenter）上。因此，如果你有使用该平台的技能和经验，那么你已经走了一半的路。

Horizon View 基于 vSphere 基础架构，利用 ESXi 虚拟化和 vCenter Server 的一些功能，添加了多个虚拟服务器以执行各种 View 角色和功能。

以下图所示是提供虚拟桌面的 View 架构概述：

![](img/842ef811-5905-48b4-a877-a78fc312021f.png)

Horizon View 基础架构组件作为安装在 Microsoft Windows Server 操作系统上的应用程序运行，除了统一访问网关（Unified Access Gateway），它是基于 Linux 的硬化设备。理论上，这些基础架构组件可以运行在物理机器上；然而，当它们作为虚拟机运行时，可以获得许多好处，例如提供高可用性（HA）和灾难恢复（DR），以及通过虚拟化实现的典型成本节省。

以下章节将更详细地介绍视图架构中的各个角色和组件，从 Horizon View 连接服务器开始。

# Horizon View 连接服务器

Horizon View 连接服务器也被称为连接代理或视图管理器。它是 View 基础架构的主要组件。其主要角色是通过执行用户身份验证，将用户连接到其虚拟桌面，然后根据用户的配置文件和授权交付和管理适当的桌面资源。登录到虚拟桌面时，您与连接服务器进行通信。

# 连接服务器是如何工作的？

用户将通过启动 Horizon 客户端连接到其 VDI 桌面，但同样，他们也可以使用基于浏览器的访问方式。我们将在第十二章 *Horizon 客户端选项*中介绍 Horizon 客户端和其他访问方法。

那么，接下来会发生什么，登录过程是如何工作的呢？一旦启动 Horizon 客户端，最终用户会输入他们想要连接的 View 连接服务器的地址详情（**1**），然后连接服务器（**2**）会回应并要求他们提供网络登录信息、Active Directory 域用户名和密码。

值得注意的是，Horizon View 现在支持以下不同的 AD 域功能级别：

+   Windows Server 2003

+   Windows Server 2008 和 Windows Server 2008 R2

+   Windows Server 2012 和 Windows Server 2012 R2

+   Windows Server 2016

终端用户的凭证通过 Active Directory 进行验证（**3**），如果验证成功，用户可以继续登录过程。根据他们被授权的资源，终端用户将看到一个启动屏幕，显示几个可以登录的虚拟桌面机图标。这些桌面图标代表了用户被授权使用的桌面池。用户还可能会看到代表已发布应用程序的应用程序图标。

桌面池基本上是类似虚拟桌面机的集合。例如，它可能是为营销部门设置的池，虚拟桌面机包含该部门特定的应用程序和软件。我们将在第八章，*配置和管理桌面池 – 第一部分*中更详细地讨论桌面池。

一旦验证通过，视图管理器或连接服务器会调用 vCenter 服务器（**4**）以创建虚拟桌面机，并且随后 vCenter 会调用（**5**）View Composer（如果你使用的是链接克隆），或者它会使用 vSphere 的 VM 分支功能创建一个即时克隆来启动虚拟桌面的构建过程，如果没有已经可供用户登录的虚拟桌面。

作为整体构建过程的一部分，如果已配置，VMware UEM 将加载终端用户的个人资料，个性化并定制该虚拟桌面以适应该用户。同样适用于 VMware 应用程序卷，如果已配置，它将同时交付任何分层应用程序。

当构建过程完成，虚拟桌面机已准备好供终端用户使用，且包括他们的个人资料和应用程序时，它会通过 Horizon Client 窗口（**6**）或浏览器显示或交付，使用所选择的显示协议 PCoIP、Blast Extreme 或 RDP。这个过程在下图中进行了形象化展示：

![](img/a7444ef5-d086-45f5-ad92-1273ef188a2e.png)

还有其他方式可以部署 VDI 解决方案，而不需要连接代理，尽管你可以说，严格来说，这不是一个真正的 VDI 解决方案。正如我们在介绍和历史中讨论的那样，这就是最早的 VDI 解决方案的样子，允许终端用户通过 RDP 协议直接连接到他们自己的虚拟桌面。然而，如果仔细考虑，仍然有一些特定的使用场景适合采用这种方式。

例如，如果你有大量的远程分支或办公室，你可以部署一部分基础设施，将其托管在本地站点上，从而允许用户在 WAN 故障或分支机构与总部之间网络通信不良的情况下继续工作。

恰巧 VMware 也考虑到这一使用场景，并提出了解决方案，称为 **无代理视图（Brokerless View）**，它使用 VMware Horizon 视图代理的 DirectConnection 插件直接连接虚拟桌面机器，而无需连接服务器。这最初是 VMware 于 2013 年 10 月收购的 Desktone **桌面即服务** (**DaaS**) 解决方案的一部分。然而，别忘了，在 Horizon View 环境中，视图连接服务器提供了更多的功能，远不止将用户连接到桌面，正如我们将在本章后面看到的那样。

除了在最终用户和虚拟桌面机器之间进行连接代理外，视图连接服务器还与 vCenter 服务器协作，管理虚拟桌面机器。例如，当使用链接克隆或即时克隆并启动虚拟桌面时，这些任务由连接服务器发起，但由 vCenter 服务器执行。

现在我们已经介绍了什么是连接服务器，并简要概述了它的工作原理，在接下来的章节中，我们将讨论为了让它正常运行，你需要的要求。

# 连接服务器的最低要求

要安装连接服务器，你需要满足以下最低要求，才能在物理或虚拟机器上运行。

# 硬件要求

下表显示了安装连接服务器所需的硬件：

![](img/9ffb6c9e-a63b-4a92-a2f0-cc4a067beac9.png)

# 支持的操作系统

视图连接服务器必须安装在下表列出的操作系统之一上：

![](img/1b461a76-6380-45bb-9f38-616afa48023f.png)

不再支持没有服务包的 Windows Server 2008 R2。

在接下来的章节中，我们将讨论 Horizon View 安全服务器。

# Horizon View 安全服务器

**Horizon View 安全服务器**是架构中的另一个独立组件，也是连接服务器执行的另一个角色。主要的区别在于，首先，它位于你的 DMZ（隔离区）内，因此没有加入到你的域中。这使得它能够供最终用户从外部网络或互联网安全地连接到他们的虚拟桌面机器，而无需使用 VPN。由于它与其中一个连接服务器配对，因此，它所配对的内部连接服务器负责管理用户和桌面池等信息。其次，它不持有 ADAM 数据库的副本。正如你在第五章《安装与配置 Horizon 7 – 第二部分》中看到的，安装过程与安装视图连接服务器相同，但这一次，你在安装开始时从下拉菜单中选择安全服务器角色。

你不能在已经作为连接服务器或其他任何 Horizon View 组件运行的机器上安装视图安全服务器。

# 安全服务器是如何工作的？

首先，用户登录过程与连接到视图连接服务器时相同，本质上因为安全服务器只是运行部分功能的连接服务器的另一个版本，排除了 ADAM 数据库。不同之处在于您连接到安全服务器的地址。安全服务器位于您的 DMZ（隔离区）内，并与其所配对的位于内部网络上的连接服务器进行通信。因此，现在我们增加了额外的安全层，因为内部连接服务器没有暴露在外部，目的是让用户可以在不首先连接到 VPN 网络的情况下，外部访问他们的虚拟桌面机。

安全服务器不应加入域。

下面的图示描述了安全服务器连接过程：

当用户从 Horizon 客户端登录时，他们现在使用安全服务器的外部 URL 来访问连接服务器，连接服务器反过来会通过 Active Directory 对用户进行身份验证。如果连接服务器被配置为 PCoIP 网关，那么它将把连接和地址信息传递给 Horizon 客户端。这些连接信息将允许 Horizon 客户端通过 PCoIP 连接到安全服务器。图中由绿色箭头（**1**）表示。然后，安全服务器将把 PCoIP 连接转发到虚拟桌面机（**2**），为用户创建连接。虚拟桌面机将在 Horizon 客户端窗口中显示/交付（**3**），并使用所选择的显示协议（PCoIP、Blast Extreme 或 RDP）。我们将在本章稍后讨论此过程以及 View 用于连接的不同端口。

# Horizon View 复制服务器

Horizon View 复制服务器，顾名思义，是视图连接服务器的副本，起着两个关键作用。

第一个作用是为您的 Horizon View 环境提供高可用性。拥有视图连接服务器的副本意味着，如果一个连接服务器出现故障，复制服务器将接管连接请求的管理，从而使最终用户仍然能够连接到他们的虚拟桌面机。

其次，添加复制服务器可以帮助您扩展用户数量和虚拟桌面连接数。单个连接服务器实例最多支持 2,000 个连接，因此添加额外的连接服务器可以一次增加 2,000 个用户，最多可扩展到每个 Horizon View pod 五个连接服务器和 10,000 个用户。我们将在第三章 *设计与部署考虑事项*中讨论 Pod 和 Block 架构。

部署复制服务器时，请记住，如果您没有使用负载均衡器，则需要更改 IP 地址或更新 DNS 记录，以匹配此服务器。

与安全服务器类似，你会发现安装过程几乎与连接服务器相同，但这次，在安装过程中你需要从下拉菜单中选择复制服务器角色。

# 复制服务器是如何工作的？

第一个问题是：什么会被复制？连接代理存储所有与最终用户、桌面池、虚拟桌面机以及其他与 View 相关的对象有关的信息，存储在 ADAM 数据库中。然后，使用 **轻量级目录访问协议** (**LDAP**)（它使用类似 AD 用于复制的方法），这些 View 信息从原始连接服务器复制到复制服务器。

由于连接服务器和复制服务器现在彼此完全相同，如果你的连接服务器出现故障，那么复制服务器实质上就是一个备份，可以接管并让最终用户继续连接他们的虚拟桌面机。此外，由于复制服务器是环境中连接服务器的另一个实例，你可以扩展和管理额外的最终用户。

与其他 Horizon 组件一样，你不能将复制服务器角色安装在运行连接服务器或任何其他 Horizon View 组件的同一台机器上。

# Horizon View 注册服务器和 True SSO

**Horizon View Enrollment Server** 是 Horizon View 连接服务器安装选项的最终组成部分，也是连接服务器安装过程中的另一个安装选项，并且可以从下拉菜单中选择。那么，注册服务器的角色是什么？

Horizon 7 引入了一个名为 **True SSO** 的新功能。True SSO 是一种解决方案，允许用户在不必输入他们的 AD 凭据的情况下认证到 Microsoft Windows 环境。它集成到另一个 VMware 产品 **VMware Identity Manager** (**VIDM**) 中，这是 Horizon 7 高级版和企业版的一部分。

它的工作是坐在连接服务器和 Microsoft CA 之间，从证书存储请求临时证书。

此过程在以下图表中有详细描述：

![](img/a579db1c-47d7-4f3e-9dc7-b742ed58ca9d.png)

用户首先登录 VIDM，可以使用他们的凭据或者其他身份验证方法，例如以下内容：

+   RSA SecurID

+   Kerberos

+   RADIUS 认证

+   RSA 自适应认证

+   基于标准的第三方身份提供者

一旦成功验证，最终用户将被呈现其有权使用的虚拟桌面机或托管应用程序。他们可以通过双击启动其中任何一个，这将启动地平线客户端，如前一图中的红色箭头所示（**1**）。然后用户的凭据将传递给连接服务器（**2**），连接服务器将通过将**安全断言标记语言**（**SAML**）断言发送回身份管理器（**3**）来验证它们。

如果验证了最终用户的凭据，则连接服务器将其传递给注册服务器（**4**）。注册服务器然后向 Microsoft **证书颁发机构**（**CA**）发出请求，为该用户生成一个短期临时证书以供使用（**5**）。

现在生成了证书，连接服务器将其提交给虚拟桌面机的操作系统（**6**），然后操作系统通过活动目录验证证书是否真实（**7**）。

证书经过验证后，最终用户将登录其虚拟桌面机，然后使用所选择的显示协议将其显示/传递到地平线客户端（**8**）。

所有 Horizon 7 支持的桌面操作系统以及 Windows Server 2008 R2 和 Windows Server 2012 R2 都支持真正的 SSO。它还支持 PCoIP、HTML 和 Blast Extreme 交付协议。

# VMware 统一访问网关

**VMware Unified Gateway**在下图中显示了与视图安全服务器相同的角色，但存在一个关键区别。统一访问网关不是 Windows 应用程序，也不是连接服务器中的另一个角色，而是一个运行硬化、锁定的 Linux 操作系统的单独虚拟设备：

![](img/7a852476-4147-4f12-8a51-886e8bf70e66.png)

尽管统一网关设备提供与安全服务器几乎相同的功能，但它们尚未完全替代它，特别是如果您已经在生产环境中使用安全服务器进行外部访问。在这种情况下，您可以继续使用此架构。

如果您使用连接服务器的安全隧道功能、PCoIP 安全网关或 Blast 安全网关功能，则在使用统一访问网关时需要在连接服务器上禁用这些功能。这些功能在统一网关设备上默认启用。

Unified Access Gateway 设备和安全服务器之间的一个关键区别在于 Unified Access Gateway 的扩展方式。之前，您必须将安全服务器与连接服务器配对，这是一种限制，但现在不再是这种情况。因此，您现在可以根据需要为您的环境扩展任意数量的 Unified Access Gateway，单台设备的最大限制约为 2,000 个会话。添加额外的设备只需部署设备即可，因为设备不依赖于其他设备，也不与其他设备通信。它们通过负载均衡器直接与连接服务器通信。

# 持久桌面还是非持久桌面？

在本节中，我们将讨论不同类型的桌面分配以及虚拟桌面如何交付给最终用户。这是一个重要的设计考虑因素，因为所选择的方法可能会影响存储需求（将在下一节讨论）、托管基础设施，以及用来向最终用户提供虚拟桌面的技术或解决方案。

一个常被问到的问题是，是否应该部署专用（持久）分配或浮动桌面（非持久）分配。桌面可以是独立的虚拟机，按 1:1 的比例专门分配给用户（就像物理桌面部署一样，每个用户实际上拥有自己的桌面），或者用户有一个新的、普通的桌面，该桌面在用户登录时会被提供、构建、个性化并分配给他们。用户访问的虚拟桌面从一组可用桌面中随机选择，这些桌面是最终用户有权使用的。

以下是对这两种选项的更详细描述：

+   **持久桌面**：最终用户分配一个桌面，该桌面在会话之间保持所有文档、应用程序和设置。用户第一次连接时，桌面会被静态分配，并将在所有后续会话中继续使用。其他用户无法访问该桌面。

+   **非持久桌面**：最终用户每次连接时可能会连接到不同的虚拟桌面。环境应用程序或用户数据在会话之间不会持久保存，而是通过我们在第一章 *《引入 VDI 和 VMware Horizon 7》* 中讨论的复合桌面模型在用户登录其桌面时提供。用户注销时桌面会被刷新或重置，然后准备好供下一个用户使用。

在大多数情况下，非持久性配置是最佳选择；其主要原因在于，使用这种模型，你不需要为每个用户预先构建所有桌面。你只需在需要时启动虚拟桌面。所有用户都从相同的基本桌面开始，然后在交付之前进行个性化。这有助于提高并发率。例如，你的组织可能有 5,000 人，但每次只有 2,000 人同时登录；因此，你只需要有 2,000 个虚拟桌面可用。否则，你将不得不为可能登录的 5,000 名用户中的每一个构建一个桌面，导致更多的服务器基础设施、更多的存储容量和更多的软件许可证。

对于非持久性桌面来说，以前曾经是个小小的障碍是如何将应用程序交付到虚拟桌面机器上，以及这是否意味着每次用户登录时都必须安装应用程序。现在，应用层分层解决方案（例如 VMware App Volumes 或 Liquidware FlexApp）成为主流技术，应用程序可以按需在构建桌面和用户登录时交付。

我们经常看到有些人对持久性和非持久性桌面的区别以及克隆如何适用感到困惑。为了明确起见，链接克隆、完整克隆和即时克隆不是我们讨论持久性和非持久性桌面时所指的内容。*克隆操作* 指的是如何构建和配置桌面，而术语 *持久性* 和 *非持久性* 指的是如何分配桌面给最终用户。

持久性和非持久性桌面完全关乎用户分配，以及用户是否拥有专用桌面，或者每次登录时从池中分配一个桌面。克隆是 Horizon View 的一个特性，它使用 View Composer 和/或 vCenter 从主或父映像为每个用户创建桌面映像。这意味着，无论是持久性还是非持久性桌面分配，虚拟桌面机器仍然可以是链接克隆、完整克隆或即时克隆。

在接下来的章节中，我们将深入概述 Horizon 7 中可用的克隆技术，从 Horizon View Composer 和链接克隆开始，以及这项技术所提供的优势。

# Horizon View Composer 和链接克隆

在本节中，我们将讨论如何使用克隆技术构建、创建和扩展虚拟桌面机器。我们将描述不同的克隆选项，它们的交付内容以及它们对磁盘存储需求的影响。

# 什么是克隆？

从高层次开始，克隆是现有或父虚拟机的副本。这个父虚拟桌面机器是您要从中创建新虚拟桌面机器的金像。当克隆创建时，它变成一个独立的新虚拟桌面机器，具有自己独特的身份。这个过程不是 Horizon View 独有的。实际上，这是 vSphere 和 vCenter 的功能，而在 Horizon View 的情况下，我们还添加了另一个组件 View Composer 来管理桌面图像。可以部署三种类型的克隆：完整克隆、链接克隆或即时克隆。

虚拟桌面项目无法交付或甚至无法起步的主要原因之一是因为庞大的基础设施和存储需求。存储需求通常被视为巨大的成本负担，这可以归因于人们以与物理桌面环境相同的方式对待 VDI 项目。这意味着每个用户都获得自己专用的虚拟桌面及其带有硬盘空间的虚拟磁盘。然后，这被扩展到整个用户群体，每个用户分配一个带有一些存储空间的虚拟桌面。

让我们举个例子。如果您有 1,000 个用户，并分配 250 GB 的磁盘空间给每个桌面，那么您将需要 1,000 * 250 GB = 250 TB 的磁盘空间仅用于虚拟桌面环境。这对于桌面来说是很多存储空间，可能会导致显著的基础设施成本，这可能意味着在数据中心部署这么多存储成本不划算，与物理桌面部署相比。这将被描述为**完整克隆**方法。

# 什么是完整克隆？

正如其名称所示，完整克隆磁盘是父虚拟机或金像模板的精确、全尺寸副本。一旦创建了金像的克隆，虚拟桌面机器就是独特的，有着自己的身份，作为一个完全独立的虚拟桌面运行，并且不依赖于它所创建的金像。

然而，由于它是一个全尺寸的副本，请注意它将占用与金像完全相同的存储空间，这与本章早期关于存储容量要求的讨论相关。使用完整克隆将需要更大量的存储容量，并可能导致更高的基础设施成本。

但是，在您完全放弃使用完整克隆虚拟桌面机器的想法之前，有一些使用情况依赖于这种模型。例如，如果您使用 VMware Mirage 将操作系统作为基础层传送，它今天只能使用完整克隆和专用 Horizon View 虚拟桌面机器。

在 VDI 中，部署存储需要一种新的方法，这时链接克隆和即时克隆技术便发挥作用。简而言之，链接克隆和即时克隆的设计目的是减少所需的磁盘空间，并简化将镜像部署到多个虚拟桌面机器的过程，使其成为一个集中式的、更加简单的过程。

# 什么是链接克隆？

在讨论完完全克隆后，我们将讨论使用链接克隆部署虚拟桌面机器。

在链接克隆部署中，会创建一个增量磁盘，并由虚拟桌面机器使用它来存储自身操作系统与其父虚拟桌面机器操作系统之间的数据差异。与完全克隆方法不同，链接克隆并不是虚拟磁盘的完整副本。术语*链接克隆*指的是链接克隆始终依赖其父虚拟桌面机器进行操作，因为它会继续从副本磁盘中读取数据。基本上，副本是父虚拟桌面机器快照的复制。

链接克隆本身如果不加限制，可能会增长到与副本磁盘相同的大小。然而，你可以设置限制，控制其增长的上限，如果它开始变得过大，可以刷新与之链接的虚拟桌面。这实际上是从初始快照重新开始克隆过程。

当一个链接克隆虚拟桌面被部署后，父虚拟机与新创建的虚拟桌面机器之间的差异非常小，因此与完全克隆相比，减少了存储容量的需求。这就是链接克隆比完全克隆更加节省空间的原因。

链接克隆背后的底层技术更像是快照而非克隆，但有一个关键的不同——View Composer。通过 View Composer，你可以将多个活动快照与父虚拟机磁盘链接。这使得你可以仅从一个父虚拟机创建多个虚拟桌面镜像。

最佳实践是部署一个包含链接克隆（或即时克隆）的环境，以减少存储需求。然而，正如我们之前提到的，有一些使用场景可能需要部署完全克隆。

需要注意的一点，仍然与存储相关的是，我们现在讨论的不是容量，而是性能。所有的链接克隆虚拟桌面都将从一个副本中读取数据，因此会在存储该副本的地方产生大量的**每秒输入/输出操作次数**（**IOPS**）。根据你的桌面池设计，可能会有多个副本，因为通常会有多个数据存储。这反过来取决于用户数量，从而推动解决方案设计。我们将在第三章《设计与部署考虑因素》中详细讨论这一点。

使用 Horizon View，你可以选择副本存储的位置。一个推荐是副本应该存放在快速存储设备中，例如本地或共享的 SSD。

一种替代方案是部署某种形式的存储加速技术来提升 IOPS。Horizon View 也有其集成的解决方案，称为**视图存储加速器**（**VSA**）或**基于内容的读取缓存**（**CBRC**）。该功能允许你从底层 ESXi 主机服务器分配最多 2GB 的内存，可用作最常读取的块的缓存。由于我们正在创建和启动桌面操作系统，相同的块是必需的；这些可以从内存中检索，从而加速了过程。

在使用即时克隆时，视图存储加速器默认启用且无法配置。

另一种解决方案是**视图作曲器阵列集成**（**VCAI**），它允许将构建链接克隆的过程卸载到存储阵列及其本地快照机制，而不是占用主机服务器的 CPU 资源。

还有其他一些第三方解决方案可以解决存储性能瓶颈，例如 ThinScale 的 ThinIO（[`www.thinscale.com/products/thinio/`](https://www.thinscale.com/products/thinio/)）解决方案，它提供软件定义的存储加速，有效减少磁盘 I/O。

在下一节中，我们将深入探讨链接克隆过程是如何工作的。

# 链接克隆是如何工作的？

在开始构建克隆之前，第一步是创建你的主虚拟桌面机器镜像，该镜像不仅应包含操作系统、核心应用程序和设置，还应包含 Horizon View 代理组件。这个虚拟桌面机器将成为你的父虚拟机或金像镜像，所有其他虚拟桌面机器都将从中创建。我们将在第七章《构建与优化虚拟桌面操作系统》中介绍构建过程。链接克隆通过 View composer 和 vCenter 服务器进行构建和管理。

金像镜像或父镜像不能是虚拟机模板。

一旦父虚拟机（VM）构建完成，你就可以开始使用这个镜像构建虚拟桌面和虚拟桌面池。链接克隆创建过程的概览如下图所示：

![](img/1624fe36-2f5e-4e23-821d-321189377c75.png)

获取你的黄金镜像(**1**)，并对其进行快照(**2**)。当你创建桌面池时，这个快照会被选中并成为副本(**3**)，并被设置为只读。每个虚拟桌面都链接到这个副本，因此称之为*链接克隆*。当你开始创建虚拟桌面时，你创建的是每个用户独特的链接克隆副本。

尽量不要为父虚拟机创建太多快照。我建议只有少数几个快照，否则可能会影响桌面的性能，并使得很难区分每个快照的内容。

# 创建链接克隆

在镜像构建过程中，一旦副本磁盘被创建，View Composer 会创建几个其他虚拟磁盘，包括链接克隆（操作系统磁盘）本身。这些将在以下章节中描述。

# 链接克隆磁盘

创建的主要磁盘是链接克隆磁盘本身。这个链接克隆磁盘基本上是一个空的虚拟磁盘容器，随着用户登录并且桌面启动，它被附加到虚拟桌面机器上。

这个磁盘开始时会很小，但随着时间的推移，它会根据虚拟桌面机器操作系统从副本磁盘请求的区块变化而增长。这些区块变化会存储在链接克隆磁盘中，这个磁盘有时也被称为**增量磁盘**或**差异磁盘**，因为它存储了桌面操作系统从父虚拟机请求的所有增量变化。如前所述，链接克隆磁盘可以增长到与父虚拟机相等的最大大小，但按照最佳实践，你不应该允许这种情况发生。通常，你可以预期链接克隆磁盘只会增加到几百 MB。我们将在本章后面的*链接克隆功能和特性*部分讨论这个问题。

副本磁盘被设置为只读，并作为主磁盘使用。任何虚拟桌面请求的写入和/或区块变化都会直接从链接克隆磁盘中进行读取/写入。

推荐的最佳实践是为存储和托管副本分配一级存储，例如本地或共享的 SSD 驱动器，因为集群中的所有虚拟桌面机器将持续引用这个单一的只读 VMDK 文件作为它们的基础镜像。将其保持在存储栈的顶部可以提高性能，通过减少整体存储负载。

# 持久磁盘或用户数据磁盘

View Composer 的持久磁盘功能允许你配置一个单独的磁盘，该磁盘只包含用户数据和用户设置，而不包含操作系统。这使得在你更新或对操作系统磁盘进行更改时（例如重新组合操作），任何用户数据都能得到保留。

值得注意的是，持久磁盘是通过虚拟机名称而非用户名来引用的，因此，如果你想将磁盘附加到不同的虚拟机，请记住这一点。

数据磁盘还用于存储最终用户的配置文件。因此，你需要根据需求合理调整其大小，确保它足够大，能够存储任何类型的用户配置文件数据，例如虚拟桌面评估。这也是为什么进行桌面评估是个好主意的另一个原因，正如我们在第三章《设计与部署注意事项》中会讲到的那样，帮助你了解用户桌面配置文件和用户数据需求的情况。

# 一次性磁盘

使用**一次性磁盘**选项时，Horizon View 创建一个实际上是临时磁盘的磁盘，每次用户关闭其虚拟桌面机器时都会被删除。

如果你考虑一下 Windows 桌面操作系统的工作方式以及它创建的文件，你会发现有几种文件是临时使用的。例如，临时 Internet 文件或 Windows 页面文件就是其中的两个例子。既然这些只是临时文件，为什么要保留它们呢？在 Horizon View 中，这些类型的文件会被重定向到一次性磁盘，并在虚拟机关闭时删除。

Horizon View 提供了为每个虚拟桌面配置一次性磁盘的选项。此一次性磁盘用于存储临时文件，这些文件在虚拟桌面关闭时会被删除。这些文件不希望存储在主操作系统磁盘上，因为它们会占用不必要的磁盘空间。例如，一次性磁盘上的文件包括页面文件、Windows 系统临时文件和 VMware 日志文件等。

值得指出的是，我们讨论的是临时系统文件，而不是用户文件。最终用户的临时文件仍然存储在用户数据磁盘上，以便能够保留。许多应用程序使用 Windows 临时文件夹来存储安装 CAB 文件，安装后可以引用这些文件。话虽如此，你可能希望删除临时用户数据，以减小整体桌面镜像大小，在这种情况下，你可以确保用户的临时文件被定向到一次性磁盘。

# 内部磁盘

最后，我们有内部磁盘。内部磁盘用于存储重要的配置信息，例如计算机帐户密码，如果刷新了链接克隆，它将用于将虚拟桌面机器重新加入域。它还用于存储**Sysprep**和**Quickprep**配置详细信息。我们将在第七章，*构建和优化虚拟桌面操作系统*中详细讲解 Quickprep。

在磁盘空间方面，内部磁盘相对较小，平均大约为 20 MB。默认情况下，用户无法在其 Windows 资源管理器中看到此磁盘，因为它包含重要的配置信息，您不希望他们删除它。

下图展示了不同磁盘类型的创建概述：

![](img/6fc90d3d-b667-4be6-856f-8cf55aec88b4.png)

在下一节中，我们将深入探讨链接克隆过程的工作原理。

# 理解链接克隆过程是如何工作的

View Composer 和 View Manager 执行了几个复杂的步骤，当用户请求虚拟桌面机器时，这些步骤会启动。那么，构建链接克隆桌面的过程是怎样的，幕后发生了什么呢？当用户登录 Horizon View 并请求虚拟桌面机器时，View Manager 将使用 vCenter 和 View Composer 创建一个虚拟桌面机器，如果没有现有的虚拟桌面机器可供最终用户使用。

该过程在以下章节中进行描述。

# 创建和配置新的虚拟桌面

该过程的第一步是创建和配置虚拟桌面机器，如下所述：

1.  在将虚拟桌面机器置于配置模式之前，**Active Directory 应用程序模式**（**ADAM**）数据库中会创建一个虚拟桌面机器条目。

1.  链接克隆虚拟桌面机器由 View Composer 创建。

1.  在 Active Directory 中创建一个机器帐户，并生成随机密码。

1.  View Composer 检查是否存在副本磁盘，如果没有，则会创建一个。

1.  链接克隆是通过 View Composer 的 vCenter Server API 调用创建的。

1.  创建一个内部磁盘以存储配置信息和机器帐户密码。

虚拟桌面机器已经创建，现在可以进入下一步：自定义。

# 自定义桌面

现在，新建的链接克隆虚拟桌面机器已经构建完成，下一步是对其进行自定义。

要自定义虚拟桌面机器，请按照以下步骤操作：

1.  虚拟桌面机器被切换到自定义模式。

1.  虚拟桌面机器通过 vCenter Server 使用`customizeVM_Task`命令进行自定义，并使用您在 View Manager 控制台中输入的信息加入域。

1.  启动链接克隆虚拟桌面。

1.  链接克隆虚拟桌面机上的 View Composer 代理首次启动并将该机器加入域，使用 `NetJoinDomain` 命令和在内部磁盘上创建的机器账户密码。

1.  链接克隆虚拟桌面机现在已完成 Sysprep 或 Quickprep 操作。完成后，View Composer 会通知 View Agent 自定义已完成，View Agent 再通知 View Manager 自定义过程已结束。

1.  链接克隆虚拟桌面机已关闭，并且已创建快照。如果使用 Quickprep，则在自定义后无需重新启动虚拟桌面机。

1.  链接克隆虚拟桌面机被标记为已配置，现在可以使用。

当最终用户连接并启动链接克隆虚拟桌面机时，安装在该虚拟桌面机上的 View Composer 代理能够跟踪机器账户密码的变化。如果发生更改，新的更新密码将存储在链接克隆的内部磁盘上。根据密码策略，机器账户密码通常会发生变化，因此如果 View Composer 代理检测到密码更改，它将更新链接克隆桌面创建时所创建的内部磁盘上的机器账户密码。这是刷新链接克隆磁盘时的一个关键功能，因为链接克隆虚拟桌面机会恢复到自定义后拍摄的快照。这意味着 View Composer 代理可以将机器账户密码重置为最新密码。

链接克隆过程如下图所示：

![](img/f3c39cd8-9cd5-41df-8a34-ae096d4c67a7.png)

在接下来的部分中，我们将讨论使用链接克隆的一些附加功能和特性。

# 链接克隆的特性和功能

使用 View Composer，您可以对链接克隆磁盘执行几个其他管理功能。此部分概述了这些功能，并用于提供虚拟桌面机器的持续管理。

# 重新组合链接克隆

重新组合链接克隆虚拟桌面机或桌面池允许您对操作系统磁盘进行更新，例如使用最新的补丁或软件更新更新镜像。您只能在相同版本的操作系统上执行更新，因此无法使用重新组合功能从一个操作系统迁移到另一个操作系统，例如从 Windows 7 迁移到 Windows 10。

正如我们在*View Composer 构建了什么？*部分中提到的，我们为用户数据等项目准备了独立的磁盘。在重新组合操作期间，这些磁盘不会受到影响，因此上面的所有用户特定数据都会被保留。

当您启动重新合成操作时，View Composer 实际上是重新开始链接克隆的构建过程；因此，新的操作系统磁盘会被创建，随后会进行自定义，并拍摄类似前面章节所展示的快照。

在重新合成操作过程中，网络接口的 Mac 地址和 Windows SID 不会被保留。由于此更改，某些管理工具和安全类型的解决方案可能无法正常工作。然而，UUID 将保持不变。

在执行重新合成操作之前，您需要创建新的镜像并拍摄初始快照。重新合成过程如下所述：

1.  View Manager 将链接克隆切换到维护模式。

1.  View Manager 调用 View composer 的 resync API，针对正在重新合成的链接克隆，指示 View Composer 使用新的基础镜像和快照。

1.  如果基础镜像和快照的副本不存在，则在链接克隆使用的目标数据存储中，View Composer 将创建该副本，前提是您未配置 View 使用单独的数据存储来存储副本。

1.  对于链接克隆，当前的操作系统磁盘会被 View Composer 删除。然后，它会创建一个新的操作系统磁盘，并将其与新创建的副本关联。

1.  重新合成周期的其余部分跟随了配置和自定义周期的自定义阶段。

以下图示展示了重新合成过程的图形表示。在过程开始之前，首先需要做的是更新您的黄金镜像（**1**），包括您想要部署为虚拟桌面的补丁更新或新应用程序：

![](img/0d3374ba-08db-4227-a7b9-f3cf7edf1a1f.png)

如前所述，快照会被拍摄（**2**），以创建新的副本，副本 V2（**3**）。现有的操作系统磁盘会被销毁，但在重新合成过程中，用户数据磁盘（**4**）会被保留。

# 刷新链接克隆

通过执行链接克隆虚拟桌面的刷新操作，实际上您是在将其恢复到初始状态，即在完成自定义阶段后拍摄的原始快照。这一过程仅适用于操作系统磁盘，其他磁盘不会受到影响。

刷新操作的一个使用案例是，在注销后两小时重新合成一个非持久化桌面，将其恢复到原始状态，并使其可供下一个用户使用。

刷新过程执行以下任务：

1.  链接克隆虚拟桌面被切换到维护模式。

1.  View Manager 将链接克隆虚拟桌面还原为自定义完成后所拍摄的快照：`- vdm-initial-checkpoint`。

1.  链接克隆虚拟桌面启动时，View Composer 代理会检测机器帐户密码是否需要更新。如果不需要更新，并且内部磁盘上的当前密码比注册表中当前存储的密码更新，那么 View Composer 代理将使用内部磁盘上的密码来更新机器帐户密码。

执行刷新操作的一个原因是当链接克隆的操作系统磁盘开始膨胀时。正如我们之前讨论过的，操作系统链接克隆磁盘可能会增长到与其父映像相同的大小。这意味着它占用了比必要的更多磁盘空间，这在某种程度上违背了链接克隆的目的。刷新操作有效地将链接克隆重置为与其父映像之间的小差异。

以下图示展示了刷新操作的表现：

![](img/c9002f0b-553e-4190-a195-642c4c657afc.png)

图示左侧的链接克隆磁盘开始膨胀（**2**）。首先刷新操作将虚拟桌面机置于维护模式（**1**）。然后，虚拟桌面机被还原为原始快照（**3**）。新的链接克隆桌面现在已经重置为与首次创建时相同的大小（**4**）。

# 使用 View Composer 的重新平衡操作

View Composer 中的重新平衡操作用于将链接克隆虚拟桌面机均匀地分布到环境中的多个数据存储区。如果其中一个数据存储区即将满而其他数据存储区还有充足的空闲空间，你可以执行此任务。它还可能有助于提高该数据存储区的性能。例如，如果你在一个数据存储区有 10 台虚拟桌面机，而在另一个数据存储区只有 2 台，那么执行重新平衡操作可能会使它们更均衡，使每个数据存储区都拥有 6 台虚拟桌面机。

你必须使用 View Administrator 控制台来启动 View Composer 中的重新平衡操作。如果你只是尝试对虚拟桌面机执行存储 vMotion，那么 View Composer 将无法跟踪它们。

另一方面，如果你在一个数据存储区有六台虚拟桌面机，而在另一个数据存储区有七台，那么启动重新平衡操作很可能不会产生任何效果，虚拟桌面机也不会被移动，因为这样做没有任何好处。只有当目标数据存储区比源数据存储区有显著更多的空闲容量时，VDI 桌面才会被移动到另一个数据存储区：

1.  链接克隆被切换到维护模式。

1.  根据可用数据存储区的空闲空间，识别需要移动的虚拟机。

1.  操作系统磁盘和持久磁盘与虚拟桌面机断开连接。

1.  分离的操作系统磁盘和持久磁盘被移动到目标数据存储区。

1.  虚拟桌面机被移动到目标数据存储区。

1.  操作系统磁盘和持久磁盘重新连接到链接克隆虚拟桌面机。

1.  View Composer 重新同步链接克隆虚拟桌面机。

1.  View Composer 会在数据存储中检查副本磁盘，如果不存在副本磁盘，会根据本章前面所述的配置步骤创建一个副本磁盘。

1.  根据重新配置操作，链接克隆的操作系统磁盘将被删除，然后创建一个新的操作系统磁盘并进行自定义。

以下图示展示了重新平衡操作。操作开始时，数据存储 A 中有两台虚拟桌面机，数据存储 B 中有四台虚拟桌面机。在这个例子中，重新平衡操作使两个数据存储的虚拟桌面机数量趋于均衡，每个数据存储中有四台虚拟桌面机：

![](img/c44335aa-f665-4ecf-8a4b-1d98455d0542.png)

在下一节中，我们将探讨创建虚拟桌面机的即时克隆功能。

# 即时克隆

**即时克隆**功能是内置于 vSphere 平台的功能，而非特定的 Horizon 功能，并且从 vSphere 6.0 U1 版本开始提供支持，当时它成为 Horizon 的支持功能之一。

它使用 VMware VM Fork 技术来快速配置虚拟桌面机。即时克隆是从已经开机并运行的虚拟桌面机中创建的，称为父虚拟桌面机，在创建即时克隆之前，父虚拟桌面机会被暂挂。这使得即时克隆比链接克隆和 View Composer 更快速地进行配置。

即时克隆与父虚拟桌面机共享内存和磁盘进行读取操作，并且会立即创建，且处于已开机状态，这与基于 View Composer 的链接克隆不同，后者在创建过程中必须启动。此外，除了与父虚拟桌面机共享内存和磁盘外，即时克隆还拥有其自己的独立内存和增量磁盘文件。以下图示展示了即时克隆的架构：

![](img/cba7d6a8-a804-4e1f-90d4-8154b719edd2.png)

当最终用户注销即时克隆虚拟桌面机时，它将被销毁，当用户再次登录时，将创建一个新的即时克隆。如果需要保留任何数据，用户可以使用 App Volumes 的可写卷功能来提供该功能，并使用 UEM 管理他们的个性化设置。

要利用即时克隆，虚拟桌面机需要运行虚拟机硬件版本 11 或更高版本。

# 即时克隆构建过程

之前我们讨论过链接克隆时，分析了构建过程及构建内容，现在我们从即时克隆的角度再看一遍。

一如既往，我们从主镜像开始，这是所有其他桌面构建的虚拟桌面。首先，会对主虚拟桌面进行快照。接下来，基于前一步拍摄的虚拟桌面快照，创建一个内部模板，该模板是主虚拟桌面的链接克隆。

接下来是复制的虚拟桌面，它是内部模板虚拟桌面的瘦配置全克隆。视图存储加速器使用该虚拟桌面的 CBRC 摘要。在复制虚拟桌面之后，通过使用复制虚拟桌面的链接克隆来创建运行中的父虚拟桌面，该链接克隆又是基于复制虚拟桌面快照创建的。

最终，瞬时克隆桌面被创建并准备好供最终用户使用。以下图示描述了这一过程：

![](img/09296593-2598-425b-b0c5-4c6748142b1a.png)

# 瞬时克隆的优势

与链接克隆相比，使用瞬时克隆有几个好处：

+   瞬时克隆几秒钟内即可配置完成，而链接克隆通常需要更长的时间（通常是几分钟）。

+   不再出现启动风暴，因为父桌面已经开机，因此所有瞬时克隆都会在已开机的状态下创建。

+   不需要执行刷新或重组操作，因为桌面的生命周期较短。

+   更新操作系统只需要更新父虚拟机，而无需执行重组操作，最终用户在下次登录时会自动收到更新后的虚拟桌面。

+   它们减轻了 vCenter 服务器的负担。

+   不需要 SE 备用磁盘或 CBRC。

在下一部分，我们将探讨这些新建的虚拟桌面如何进行定制和个性化设置。

# 视图个性化管理

让我们先来了解一下**视图个性化管理**的背景和历史。视图个性化管理最初是一个名为**虚拟配置文件**的技术产品，于 2010 年由 VMware 从 RTO Software 公司收购。

随后，**视图 5.0**推出了视图个性化管理，它允许您配置用户配置文件，以便它们与位于数据中心文件服务器上的远程配置文件库动态同步。其目的是在虚拟化桌面环境中集中管理用户配置文件，作为我们在第一章《引入 VDI 和 VMware Horizon 7》中讨论的复合桌面模型的一部分。

# 为什么我们需要在 VDI 中以不同的方式管理用户配置文件？

在 VDI 解决方案中，一个主要的好处是虚拟桌面按需构建或从预构建的非持久桌面池中交付给用户，之后再交回给用户。典型的部署模型是非持久模型，基本上意味着用户无法拥有自己的桌面，也没有个人文件、数据或设置存储在桌面上。这些设置形成了他们的用户个人资料。

当用户登录时，他们可能会从可用的虚拟桌面池中接收任何桌面。这意味着交付的虚拟桌面将不会针对该用户进行个性化设置。它只是操作系统和应用程序的标准裸机版本。

这就是 View Persona Management 发挥作用的地方，它将用户的个人资料传递到他们被分配的非持久虚拟桌面机器，从而有效地使其成为用户自己的桌面。

当我们谈论按需构建桌面时，我们再次提到复合桌面模型以及桌面如何由几个不同的组件组成。提醒一下，桌面可以分为三个组件：操作系统、应用程序以及用户的个性化设置或个人资料，本质上是构成桌面独属于你的部分。当用户登录时，这些部分会汇聚在一起，提供最终用户的桌面体验。通过 View Persona Management，我们讨论的是用户的个人资料。

本节将向您介绍 View Persona Management 及其在管理用户个人资料方面的优势。有关 View Persona Management 的技术细节和配置，您可以参考 [第十七章](https://www.packtpub.com/sites/default/files/downloads/Managing_the_End_User_Environment_in_Horizon.pdf)，*在 Horizon 中管理最终用户环境*。

# View Persona Management 的优势

从高层次来看，View Persona Management 提供以下功能：

+   用户个性化设置的快速加载，实时检索用户个人资料数据

+   几乎不需要基础设施——只需要文件共享或使用现有的文件夹重定向结构

+   配置一致性保持了会话间的个性化设置

+   高效架构，无需依赖 Windows 漂移用户配置文件

+   支持多平台，兼容 Windows XP、Windows Vista、Windows 7、Windows 8.x 和 Windows 10

除了列出的功能外，View Persona Management 还通过实现无状态虚拟桌面环境，帮助减少虚拟桌面的总拥有成本（TCO）。在一些部署中，用户被分配到专用池中，仅用于保留其个人资料设置，这增加了管理的成本和复杂性。在成本方面，由于个人资料管理是 Horizon View 的一部分，除非需要额外的功能，否则无需购买额外的第三方产品。

关于管理方面，没有额外的组件需要设置或安装，因为一切都由 Active Directory 组策略驱动。在可扩展性方面，鉴于没有诸如数据库之类的基础设施开销，因此可扩展性不是问题，它会随着您的活动目录一起扩展。

# VMware UEM

**VMware UEM**产品是 Horizon 产品组合中最新的版本之一，VMware 在 2015 年 2 月收购荷兰公司 Immidio 时将其加入了该产品线。Immidio 是一家软件公司，开发的产品旨在帮助他们的顾问进行现场工作，核心产品叫做**Flex+**。

UEM 在标准用户配置管理解决方案之上增加了额外的功能，提供一个集中管理控制台，以便提供最终用户虚拟桌面计算机的个性化设置，并能够动态配置策略。它适用于多个不同环境，例如虚拟桌面计算机、物理 PC 以及基于云的 Windows 桌面环境或 DaaS。它的核心是管理 Windows 配置文件，无论操作系统在何种环境或方式下运行。

要使用 UEM 管理虚拟桌面计算机，您需要将 FlexEngine 组件安装到虚拟桌面计算机上。确保将其包含在您的母版映像或父虚拟桌面计算机中。

UEM 有五个主要的应用场景：

+   **应用程序配置管理**：允许您配置应用程序的初始设置，而不是部署应用程序的默认设置。您可以使用 VMware UEM 应用程序配置文件捕获应用程序的预定义设置，将其配置为一次性默认值、完全强制执行（每次应用程序启动时都使用用户的个性化设置）或部分强制执行（应用程序启动时按配置进行，但允许用户进行有限的个性化设置）。

+   **用户环境设置**：允许您集中管理用户环境设置，如下所示：

    +   应用程序阻止

    +   应用程序快捷方式和文件类型关联

    +   驱动器和打印机映射

    +   环境变量

    +   文件、文件夹和注册表设置

    +   文件夹重定向

+   **个性化**：将特定于用户的桌面和应用程序设置从底层操作系统中抽象出来，并使这些设置可以跨多个设备、Windows 版本和应用程序使用。它还支持操作系统迁移，例如从 Windows 7 或 Windows 10。

+   **应用程序迁移**：允许最终用户有效地拥有漫游应用程序和个性化设置，从而使他们能够在不同操作系统版本之间移动，例如从 Windows 7 迁移到 Windows 10。

+   **动态配置**：使用条件集可以让您根据用户、位置和设备等变量组合条件，以动态地提供内容和外观的交付，例如，根据最终用户的位置提供访问网络打印机，或创建基于用户身份的驱动器映射。

SmartPolicies 是 Horizon 的一个功能，利用 UEM 提供特定于虚拟桌面机的政策集。

要使用 SmartPolicies，建议您运行 View Connection Server 版本 7.2 或更高版本，且在使用 RDSH 发布的应用程序时必须使用 Smart Policies。您还需要 UEM 9.0 或更高版本，但推荐使用 UEM 9.2 或更高版本。

使用 Smart Policies，管理员可以对最终用户的虚拟桌面机进行更精细的控制。Horizon 7 功能可以根据最终用户以及其他变量，如客户端设备类型、IP 地址和桌面池名称，动态启用、禁用或控制。通过 SmartPolicies，您可以配置以下内容：

+   USB 重定向

+   打印

+   剪贴板行为

+   客户端驱动器重定向

+   HTML 访问文件传输

+   带宽配置文件

如果您使用的是 UEM 9.1 或更高版本，并且使用的是 Horizon Agent 7.0.1 或更高版本，当用户使用 Blast Extreme 显示协议或 PCoIP 显示协议时，此设置将生效。

# 使用 UEM 还是 Persona Management？

问题是，您应该使用哪种解决方案？UEM 作为 Horizon 企业版的一部分或独立产品提供，这意味着会产生更高的费用或额外费用，除非您本来就计划购买企业版。

UEM 提供了更广泛的配置变量和功能，并且具有一个中央管理控制台，使得管理和部署更加容易。然而，您可能已经有了更全面的 UEM 解决方案。如果您使用的是 Horizon 的较低版本，那么 Persona Management 可能已经能够满足您的需求，如果不能，或许可以考虑使用第三方产品，如 Liquidware ProfileUnity。

# 从虚拟桌面机进行打印

在部署 VDI 解决方案时，常见的一个问题是“*如何管理打印？*”由于您的虚拟桌面实际上是在数据中心的服务器上运行，是否意味着当您按下打印按钮时，打印任务会在那里输出？打印机驱动程序怎么办？通常，您的桌面上已安装与您最近的打印机对应的驱动程序，或者它可能是一个本地连接的打印机。这是否意味着您需要在虚拟桌面机上安装所有可能的打印机驱动程序？幸运的是，这些问题的答案是否定的，在本节中，我们将简要介绍 VMware Horizon View 如何管理打印。

Horizon View 包含了一款 OEM 虚拟打印解决方案，**ThinPrint**，其 OEM 为名为 Cortado 的公司。ThinPrint 允许你的终端用户将打印作业发送到网络打印机或通过 USB 重定向将连接在用户终端设备上的本地打印机发送到虚拟桌面机器。我们将在下一节中介绍 USB 设备管理。

为了回答有关必须安装打印机驱动程序的问题，ThinPrint 使用一个单一的虚拟打印驱动程序，替代所有其他打印驱动程序。若有需要，你仍然可以安装特定的打印驱动程序，用于打印机具有额外功能或特性的情况。然而，虚拟打印驱动程序支持大多数多功能打印机，支持如双面打印等功能。

另一个问题是关于打印作业的打印位置，ThinPrint 也解决了这个问题，它提供了基于位置的打印功能，允许你映射到离你的终端设备最近的打印机。当然，也有第三方解决方案可用，比如 UniPrint。

# 管理 USB 设备

没有一份列出所有在 Horizon View 中可用的设备的清单，因为那将是一个非常长的清单，且鉴于市场上 USB 设备的数量，测试所有设备是不现实的。

大多数 USB 设备应该可以在 Horizon View 环境中正常工作，因为它所做的就是将从终端设备上运行的 View 客户端的 USB 流量重定向到虚拟桌面机器上运行的 View 代理程序。没有完整的经过验证的设备列表，因为这将是一个非常长的列表，且无法测试市场上所有的设备。如果有关于设备功能的问题，你应该联系该 USB 设备的制造商。

可能有些设备因其自身的特性和行为无法工作；例如，一些安全设备检查它们所连接的机器或设备的物理属性。我们曾将 USB 网络摄像头归类为不受支持的设备。然而，随着 **实时音视频**（**RTAV**）的推出，这些设备现在已得到支持。在下一节中，我们将讨论如何通过使用 USB 过滤功能来选择哪些 USB 设备被重定向。

# 过滤支持的 USB 设备

在某些情况下，你可能不希望允许用户有能力插入外部 USB 设备并将其重定向到虚拟桌面机器。问题是，你是否允许用户将 USB 设备插入到他们的物理桌面？

Horizon View 具有一种功能，可以防止 USB 设备被重定向到用户的 VDI 桌面。您可以通过在终端设备、虚拟桌面或使用 Active Directory 组策略来应用此功能。例如，您的组织可能希望禁止使用 USB 闪存盘，因为这将使用户能够从虚拟桌面计算机中复制数据（部署 VDI 的原因之一是将数据集中存储，避免数据离开数据中心）。

您可以创建特定的过滤器，选择允许特定设备（按制造商或设备类型），并阻止所有其他设备。因此，如果您有公司标准类型的设备，它将被允许。您甚至可以进一步选择特定型号的设备，同时阻止任何其他设备，即使它们来自同一供应商。

# 管理多功能 USB 设备

在您的环境中，您可能会有具有多种不同功能的 USB 设备，同时仍使用单一的 USB 连接。例如，一款多媒体键盘可能配备触控板鼠标、扬声器、指纹识别器以及键盘本身。

Horizon View 支持一种被称为 **设备拆分** 的功能。这使得您可以仅重定向设备的某些组件，而不是整个设备。以我们的多媒体示例为例，您可能希望将鼠标保留为终端设备上的本地设备，同时将指纹识别器重定向，以便允许用户安全登录虚拟桌面。

# ThinApp 应用虚拟化

ThinApp 是一种无代理的应用虚拟化或应用打包解决方案，它将应用程序与底层操作系统解耦。它旨在消除应用程序冲突、简化应用程序交付并提高管理效率。ThinApp 许可证包含在 Horizon View 许可证中，可以在物理和虚拟桌面上使用，从而提供一种在整个桌面环境中交付应用程序的机制。

# 应用虚拟化是如何工作的？

ThinApp 将应用程序封装成一个包含单个 `.exe` 或 `.msi` 文件的包，并将它们与以下内容解耦：

+   主机操作系统

+   系统上已安装的任何传统应用程序

+   系统上运行的所有其他虚拟应用程序

然后，应用程序将在其隔离的虚拟环境中运行，对底层操作系统、虚拟文件系统或虚拟注册表的影响最小或为零。

当您创建 ThinApp 包时，实际上是在捕获应用程序运行所需的所有文件、注册表设置和文件系统更改。它还会在过程中捕获其自身的代理，因此终端设备无需安装任何东西。

一旦打包，应用程序可以被部署（无论是流式传输还是安装）到虚拟桌面机或甚至物理桌面。ThinApp 包运行的唯一要求是底层的 Windows 操作系统，无论是物理的还是虚拟的。运行时，重要的是要注意，该包不会对其运行的机器的操作系统进行任何更改。

不需要额外的后端基础设施组件，因为所有 ThinApp 打包的应用程序都存储在文件服务器上的文件共享中。这意味着您可以集中管理并轻松更新您的包，以便所有用户在下次启动应用程序时都会收到更新。下图显示了一个高层次的 ThinApp 架构：

![](img/17c8dabd-c3b7-495c-a2e7-6552faee09d2.png)

总结来说，ThinApp 提供以下功能：

+   允许将 Windows 应用程序打包、分发并作为单一的 `.exe` 或 `.msi` 文件在物理或虚拟桌面机器上执行

+   构建过程链接，一个 `Virtual OS`（`VOS`）与压缩嵌入文件系统和注册表，打包为一个文件

+   不需要在终端用户机器上预先安装任何软件。

+   在底层操作系统上提供零占用

+   不需要传统的安装程序或更改本地操作系统的注册表或文件系统

+   除了用于存储 ThinApp 包的文件共享外，不需要任何后端服务器基础设施

要了解更多关于 ThinApp 的信息以及如何在您的环境中使用它，请阅读 *VMware ThinApp 4.7 Essentials*，作者 Peter Bjork，Packt Publishing。

# 虚拟桌面的防病毒软件

在传统的桌面模型中，安装了防病毒代理，防病毒代理在每个桌面上运行，负责执行防病毒检测扫描，同时维护和更新包含最新恶意软件信息的定义文件。

这种模型在物理桌面环境中运行良好，但在虚拟桌面环境中运行时会遇到一些挑战。当启动检测扫描时，每个虚拟桌面的资源使用量会显著增加。这将导致终端用户的性能下降，桌面主机服务器将变得资源紧张。在物理桌面上没问题，但在 VDI 中，承载桌面的服务器将变得资源紧张。在重新组合桌面或按需构建时，桌面每次都必须下载定义文件，占用网络带宽和存储容量。最后需要考虑的一点是，典型桌面 AV 软件在每个虚拟桌面上安装后会占用多少内存。您需要分配更多内存来运行代理和扫描过程。

假设你有一台 vSphere 主机服务器，运行着大约 100 个虚拟桌面；那么，如果在周四中午 12:00，它们同时启动病毒扫描会怎样？该主机很可能会迅速达到 100% 的使用率，CPU 和存储 I/O 都会达到瓶颈，结果就是桌面无法响应。这样一来，你不仅影响到一个用户的桌面，而是影响了 100 个用户的桌面。你可以安排扫描任务，以避免它们同时进行，但理想情况下，你需要寻找专门为虚拟桌面基础架构设计的替代方法。

其次，如果我们要重新生成桌面或按需构建桌面，我们必须每次都下载定义文件，这不仅占用了网络带宽，还浪费了不必要的存储容量。

因此，所需的是一种新的防病毒保护方法，专为虚拟桌面基础架构设计。随着 VMware vSphere 5.5 的发布，VMware 推出了一个名为 **vShield Endpoint** 的产品，后来被 VMware NSX 取代，它解决了大规模虚拟桌面实施中防病毒扫描的固有问题。通过将所有防病毒操作卸载到一个集中设备上，扫描过程在虚拟化管理程序层面完成，而不是在每个虚拟桌面机器上执行。

尽管 VMware 提供了帮助实现扫描过程的引擎，但它们也与一些领先的防病毒软件供应商合作，传递有关如何识别和防护病毒、恶意软件及其他威胁的知识。他们与以下合作伙伴共同工作：

+   Bitdefender

+   Kaspersky

+   McAfee

+   Sourcefire

+   Symantec

+   Trend Micro

# 协议 – 提供虚拟桌面体验

虚拟桌面解决方案的一个最重要的元素是如何将运行在数据中心的虚拟桌面机的屏幕内容传输到终端用户的设备，并使用户能够通过键盘和鼠标进行互动。为此，VMware Horizon View 提供了使用多种显示或传输协议的选项：PCoIP、Blast Extreme 或 RDP。在本节中，我们将介绍每种协议，如何在提供终端用户体验时发挥作用，以及一些更高级的技术细节。

# PCoIP

**PCoIP** 是由 Teradici ([`www.teradici.com/`](http://www.teradici.com/)) 设计和开发的高性能显示协议。它特别针对通过局域网或广域网提供虚拟桌面，并为终端用户提供功能丰富的桌面体验。

使用 PCoIP 技术，整个屏幕内容会在数据中心进行压缩、加密和编码，然后仅将像素通过标准 IP 网络传输到支持 PCoIP 的终端设备（如零客户端），这些设备使用基于硬件的 Teradici Terra 1 或 Terra 2 芯片组，或者运行基于软件的 Horizon Client 的 Windows、macOS 或平板设备。需要记住的关键点是，数据永远不会离开数据中心。

PCoIP 支持高分辨率、全帧率、3D 图形、高清媒体、多显示器（最多四个，具体取决于终端设备）和高清音频。PCoIP 还支持 USB 外设重定向。

与一些仅用于交付应用程序的传统显示协议不同，PCoIP 是从零开始设计并构建的，专门用于提供完整的桌面体验，利用集成了图形加速技术的基于 Teradici 的零客户端，这些技术被集成在设备的芯片中，或者基于软件的客户端。无论最终用户身处何地（无论是在局域网中还是跨越广域网），PCoIP 都能确保最佳的用户体验。它能够根据网络状况和用户策略动态适应。

# PCoIP 主机渲染

那么，让我们首先来看看不同渲染模型的工作原理。对于桌面 PC，应用程序、操作系统和图形驱动程序在本地协同工作，以提供最佳的 PC 性能。这就是本地客户端渲染。

如果我们转向客户端渲染模型，那么就引入了一个网络连接各个组件。图像现在会通过网络发送到终端设备，在终端设备上使用其本地资源进行处理。使用这种模型会导致应用程序性能下降，因为它在从主机服务器到客户端的过程中需要通过网络传输，同时你仍然需要一个强大的基于 Windows 的终端设备。

那么，主机渲染如何呢？在主机渲染场景中，我们之前描述的桌面 PC 环境几乎不变。然而，PC 现在作为虚拟桌面机器运行。这意味着应用程序会像在物理桌面 PC 上一样正常工作，渲染过程在主机端完成。PCoIP 通过仅加密虚拟桌面机上运行的 View 代理的像素，然后将它们发送到运行 View 客户端的终端设备，或发送到运行 Teradici 硬件的零客户端设备，解码过程将在那里进行。

使用这种模型，您可以轻松部署低功耗、非 Windows 设备，如零客户端，因为应用程序与其运行的终端设备没有依赖关系。

# PCoIP 的多编解码器支持

如果你查看图像的构建过程以及内容的呈现方式，图像的一些组件可能需要使用不同的编解码器来显示图像，这取决于图像的类型。例如，显示文本时会使用不同的编解码器，而显示视频时则会使用另一个编解码器。

PCoIP 可以分析这些不同的媒体图像组件，并在压缩、加密并将像素发送到终端设备进行解码之前，为每个像素应用适当的编解码器。通过这种方式，PCoIP 能够更高效地传输像素，这最终意味着更少的带宽需求和更好的性能。这也意味着你可以控制传输的图像内容质量。我们将在下一部分讨论这一点。

# 控制图像质量

PCoIP 提供的图像质量可以通过 AD 组策略或智能策略进行控制，以根据使用场景提供适当的图像质量。图像是从所谓的**感知无损图像**逐步构建到**无损图像**，后者提供高保真度、像素完美的图像。例如，如果你仅仅是在运行 Microsoft Word，是否真的需要构建像素完美的图像呢？

需要记住的重要一点是，图像质量将会影响传输所需的带宽。我们将在第十章《微调终端用户体验》中更详细地讨论这些控制方法。

# 动态网络功能

为了管理带宽使用，PCoIP 使用自适应编码器，自动调整网络拥塞时的图像质量。网络拥塞的程度可以通过策略进行定义，允许你根据使用场景、位置等配置这一点。因此，位于总部主要网络的用户与位于卫星/分支站点的用户，可能会有不同的限制。当网络不再拥塞时，将恢复最大图像质量。PCoIP 不会通过网络传输任何用户数据，它只传输像素，因此使用实时**用户数据报协议**(**UDP**)，而不是使用 TCP 协议（用于**网络语音协议**(**VoIP**)），以确保响应迅速和交互流畅的终端用户体验。这将减少总体带宽需求，并根据特定时刻可用的网络带宽提供最佳的交互式用户体验。

UDP 不使用错误检查或校正，因此消除了处理检查和校正的任何开销。由于没有像 TCP 协议那样的重传延迟，这使得它非常适合用于媒体流传输。对于终端用户体验而言，这些延迟表现为画面卡顿，通常发生在观看视频内容时。

# 使用 Teradici PCoIP 硬件加速器进行 PCoIP 卸载

除了前面讨论的软件解决方案，Teradici 还提供了一张名为 **Teradici PCoIP 硬件加速卡** 的服务器卸载卡。这张 PCI 卡被安装在托管虚拟桌面机器的服务器上。

关于这张卡片的第一件事要说明的是，它并不是一张 **图形处理单元**（**GPU**）卡。我经常听到一些关于这个问题的混淆，用户们通常认为通过添加加速卡，可以获得 OpenGL 和 DirectX 功能，但事实并非如此。你可能会改善整体体验和性能，但并不会增加额外的 GPU 功能。

这张卡片的目标纯粹是将主机服务器在处理图像编码操作时的负载从 CPU 中分离出来。将图像编码任务卸载到专门的硬件解决方案上可以减少 CPU 的使用，从而提供一致的终端用户体验，使得应用程序能够更加顺畅地运行，因为它们得到了所需的资源。如果将其与类似于 TCP 卸载引擎（TCP Offload Engine）或用于 iSCSI 的 IP 存储世界中的 TOE 卡进行比较，使用基于硬件的卡片要比使用软件发起程序好得多。

释放 CPU 周期以及减少服务器 CPU 的整体负载可能会导致虚拟桌面的更好整合比率，也就是说，每台主机服务器上的虚拟桌面数量会更多。通常，你会看到大约 1.2 倍的增长。

加速卡也可以与 GPU 一起使用。在这种情况下，该卡有效地编码由 GPU 生成的额外像素，确保终端用户能够享受到本地 GPU 提供的所有好处。

# Teradici 物理 PC 主机卡

Teradici 还为物理工作站提供了利用 PCoIP 协议的解决方案：**PCoIP 远程工作站卡**。这张卡实际上并不是用于虚拟桌面会话，而是允许你将 Teradici 主机卡添加到物理工作站上，连接到工作站，并将远程图形、音频和 USB 从工作站传送到启用 PCoIP 的终端设备，比如零客户端。可以把它当作是将你的桌面 PC 搬到数据中心，然后用一根非常长的视频、鼠标和键盘线缆连接过去。这种使用场景通常应用于高性能的机架式工作站或 PC。

那么，这与 Horizon View 有什么关系呢？简单来说，客户端设备与物理桌面的连接是通过 Horizon View 管理的，连接服务器以与连接虚拟桌面机器的方式相同的方式来代理会话。像素、键盘和鼠标操作通过 PCoIP 协议通过网络传输。

# PCoIP 连接过程的工作原理

以下描述了当终端用户登录并请求虚拟桌面机器时，PCoIP 连接过程是如何工作的：

1.  Horizon 客户端通过 HTTPS 将最终用户的凭证发送到您在安全服务器或统一访问网关上配置的 PCoIP 外部 URL 进行身份验证。为此，它使用 XML-API。

1.  HTTPS 身份验证数据从统一访问网关或安全服务器传递到连接服务器。安全服务器使用 IPsec 保护的 AJP13 转发流量，从安全服务器转发到它配对的连接服务器。用户有权访问的桌面池和应用程序从连接服务器读取，并作为可用资源显示在 Horizon 客户端中。

1.  最终用户启动虚拟桌面或发布的应用程序会话。此连接在 TCP 端口`4172`（PCoIP 端口）上启动，连接到统一访问网关或安全服务器。该会话启动过程称为**PCoIP 会话握手**。

1.  使用 UDP 端口`4172`（确保此端口未被阻塞）建立双向 PCoIP 连接，以便从 Horizon 客户端和配置的`pcoipExternalUrl`将会话数据发送到统一访问网关或安全服务器。然后，PCoIP 会话的详细信息从统一访问网关或安全服务器转发回运行在虚拟桌面上的 Horizon 代理，并传输到客户端。

`pcoipExternalUrl`仅用于统一访问网关。如果您使用的是安全服务器进行外部访问，则会使用配对连接服务器上的 PCoIP 外部 URL。

该过程如下图所示：

![](img/95435ec1-d35d-42b1-91b0-59816387fa9c.png)

在接下来的章节中，我们将更详细地了解**Blast Extreme**协议。

# Blast Extreme

Blast Extreme 是 VMware 开发的新协议，如果主机服务器具备适当的 GPU 加速资源，它可以选择使用 H.264 视频编码器，从而将用户体验传递到启用了 H.264 的客户端设备。H.264，或 MPEG-4 第十部分，是一种先进的视频编码，或称为 MPEG-4 AVC，解决方案。它是一种基于块的、运动补偿的视频压缩标准。它是一种常用的视频格式，应用实例包括 DVD 视频内容的传输。

Blast 作为 VMware 协议已经存在一段时间，最早出现在几年前的 Horizon 5.2 版本中，当时它用于提供 HTML5 访问虚拟桌面。现在，它不仅限于提供 HTML5 访问；它还可以使用标准 HTTPS 端口将用户体验交付到最新的客户端设备。

Blast Extreme 交付方式与 PCoIP 具有相同的功能，支持类似的功能，如客户端驱动器重定向、USB、统一通信和本地打印。它们的区别在于资源消耗，Blast 使用更少的 CPU 周期，交付协议更灵活。

与 PCoIP 类似，Blast Extreme 可以补偿延迟增加或带宽减少并动态调整；然而，它还可以同时利用 TCP 和 UDP，而 PCoIP 只能使用 UDP。

您还可以连接多个监视器。根据终端设备，支持最多四个运行分辨率为 2,560 x 1,600 的监视器，或者可以在 Windows 7 远程桌面上禁用 Aero 的情况下运行三个分辨率为 3,840 x 2,160 的 4K 监视器。

以下是 Blast Extreme 的其他特性详细列表：

+   **Blast 自适应 UX**：通过 Horizon View 客户端或基于浏览器的客户端，使用 Blast Extreme、PCoIP 或 RDP 提供对 Horizon View 虚拟桌面机器和托管应用程序的最终用户访问。它自动适应网络条件，通过任一方式提供最佳体验。

+   **Blast 多媒体**：为 Flash、HTML5、QuickTime、Microsoft Silverlight 和 Windows Media 提供丰富的视频播放。

+   **Blast 3D 服务**：基于行业内最广泛的虚拟化图形能力构建，包括使用 NVIDIA GRID vGPU 技术的硬件加速图形。启用 Blast 3D 后，Horizon View 支持最多两个运行分辨率为 1,920 x 1,200 的监视器，或一个运行分辨率为 3,840 x 2,160 的单个 4K 监视器。

+   **Blast 实时通信**：提供对头戴式耳机和网络摄像头等通信工具的完全访问，支持 Skype、Google Hangouts 和 Cisco WebEx 等应用程序。

+   **Blast Unity Touch**：提供更直观的界面，允许您从移动设备上使用 Windows 桌面、应用程序和文件。

+   **Blast 本地访问**：支持连接外围设备，如 USB 闪存驱动器、打印机、智能卡设备和智能手机到您的虚拟桌面机器。

+   **Blast Horizon 客户端**：为终端设备提供高端用户体验的 Blast 启用客户端。

# Blast Extreme 连接过程的工作原理

以下步骤描述了 Blast Extreme 连接过程的工作原理：

1.  与 PCoIP 一样，使用 Blast Extreme，Horizon 客户端通过 HTTPS 将最终用户的凭据用于在安全服务器或统一访问网关上配置的 PCoIP 外部 URL 的身份验证。

1.  HTTPS 认证数据通过统一访问网关设备或安全服务器传递到连接服务器。安全服务器使用从安全服务器到连接服务器的 AJP13 转发流量进行配对。用户有权访问的桌面池和应用程序从连接服务器读取，然后在 Horizon 客户端中显示为可用资源。

1.  最终用户从 Horizon 客户端启动虚拟桌面或发布的应用程序会话。在统一访问网关设备或安全服务器上通过 HTTPS 在 TCP 端口 `443` 进行会话握手。

1.  在 TCP 端口`443`上建立一个安全的 WebSocket 连接，用于允许 Horizon 客户端和统一访问网关设备或安全服务器之间的会话数据传输。

1.  Blast 安全网关服务（无论是统一访问网关设备还是基于安全服务器的）将尝试在端口`443`上建立 UDP WebSocket 连接。如果连接失败或因某种原因被阻止，Blast 安全网关服务将回退到初始的 WebSocket TCP 端口`443`连接。

这个过程在下图中展示：

![](img/d7e6984a-3eab-48cf-b24e-83f8be4676c4.png)

有关更详细的端口设置，请参见以下链接：

[`techzone.vmware.com/resource/`](https://techzone.vmware.com/resource/network-ports-vmware-horizon-7)[network-ports-vmware-horizon-7](https://techzone.vmware.com/resource/network-ports-vmware-horizon-7)。

# 替代显示协议

市面上还有一些其他主流桌面协议，其中一些与 VMware Horizon 兼容，另一些被 Horizon 的竞争者使用。目前可用的主要协议是 Microsoft 的**远程桌面协议**(**RDP**)和 Citrix 的**独立计算架构**(**ICA**)。这些将在接下来的章节中进行描述。

# RDP

RDP 是为 Microsoft 开发的，主要用于通过 TCP IP 连接到远程计算机、服务器、桌面或虚拟机。RDP 现在更常被称为**远程桌面连接**。你可能每天都使用它来远程连接到你的服务器基础设施，以便远程管理服务器。

当你连接到远程桌面或计算机时，实际上是连接到一个终端服务组件，该组件将屏幕内容、按键输入和鼠标移动传送回客户端。

# ICA 协议

ICA 是 Citrix 在其产品 XenDesktop 和 XenApp 中使用的另一种显示协议。它与其他协议的设计类似，用于通过 TCP IP 网络连接将屏幕内容和键盘输入传送到客户端设备。

你通过安装在端点设备上的 ICA 客户端（如**Citrix Receiver**）进行连接。这会加载一个 ICA 文件，包含你正在连接的远程系统的详细信息以及应用于该会话的属性。

那么**高清体验**(**HDX**)呢？HDX 不是一个协议或技术，而是 HDX 的市场品牌。HDX 涵盖了多项 Citrix 技术，描述了整个用户体验，而不是仅仅集中在协议元素上。你还会看到一些子品牌属于 HDX，比如 HDX MediaStream、HDX RealTime 和 HDX 3D。

# 你应该使用哪种协议——Blast Extreme、PCoIP 还是 RDP？

现在我们已经对 PCoIP、Blast Extreme 和 RDP 有了很好的理解，你会选择哪一个？

选择 PCoIP 的最有力理由是它使用 UDP 协议，UDP 更适合流媒体传输，因此非常适合虚拟桌面交付的特性。不过，正如前面提到的，Blast 也可以使用 UDP 作为传输协议。再次强调，UDP 不关心数据如何到达端点设备，它只关心传输的速度以及数据到达的速度。

另一方面，RDP 使用 TCP 作为协议，这是互联网上广泛使用的协议。与 TCP 的关键区别在于，它关注数据如何接收。TCP 要求端点设备确认是否成功接收所有数据包。如果端点设备未收到期望的数据包，它会回复请求 TCP 停止发送数据包或缩小接收量。UDP 则持续发送，并且速度更快，因为没有来自端点设备的确认包。

这时，Blast Extreme 就可以派上用场，它可以使用 TCP 或 UDP 作为传输协议，并能够判断可用的网络容量并相应调整。

Blast Extreme 还将减少端点设备的资源使用，特别是当你使用 NVIDIA GRID 技术进行解码卸载时。然而，需要注意的一点是，当使用 TCP 作为传输协议时，由于需要补偿丢包，它可能会消耗更多的带宽。

在某些情况下，PCoIP 可能不是合适的协议，Blast Extreme 或 RDP 则需要使用。我们最常见的情况是当所需的网络端口被公司策略阻塞，或是来自远程位置的互联网连接被限制时。

当你的桌面被显示回你时，PCoIP 使用 UDP 端口`4172`来传送像素。这个端口有时会被阻塞，因为它通常不被使用。如果这个端口被阻塞，结果是，尽管你能够通过 View 客户端登录到虚拟桌面并且一切看起来正常，你却只会看到一个黑屏。黑屏的原因是像素在传输时被阻塞。在这个例子中，解决方法是使用支持 HTML5 的浏览器通过 Blast Extreme 访问桌面，Blast Extreme 使用标准的 HTTPS 端口。我们将在第十章，*优化终端用户体验*中详细讲解。

这里的关键点是，在规划用户如何连接到虚拟桌面时，要与网络和安全团队合作，并考虑用户的工作方式和所在位置。也许你并不需要外部访问，因此 WAN 的限制就不再是考虑因素。

现在我们已经讨论了如何通过交付协议传输图形，在接下来的部分中，我们将探讨如何在虚拟桌面机器中启用高端图形的选项。

# Horizon View 硬件加速图形

虚拟桌面技术的早期版本在提供高端图形内容时遇到了挑战，因为宿主服务器并未设计用于渲染和提供这些应用所需的图像大小和质量。

让我们从简要的历史和背景开始。支持高端图形的技术是分阶段发布的，首次在 vSphere 5 中推出对 3D 图形的支持，而 View 5.0 则使用基于软件的渲染。这使我们能够支持 Windows Aero 功能等内容，但由于这是一个软件功能，仍然不足以满足一些高端用例的需求。

下一阶段是提供基于硬件的 GPU 虚拟化解决方案，这个解决方案随着 vSphere 5.1 的发布而推出，它允许虚拟机通过虚拟机监控程序层传递，从而利用安装在宿主服务器中的物理图形卡。

如果我们几年前就讨论这个话题，且你有一个需要高端图形功能的用例，那么虚拟桌面将不是一个可行的解决方案。正如我们刚才讨论的，在 VDI 环境中，图形将通过虚拟化的、基于软件的图形驱动程序作为虚拟机监控程序的一部分来交付。

此外，不要忘记，既然我们现在使用服务器来托管虚拟桌面，我们实际上是在使用服务器中图形卡的处理能力，而服务器并不以高端图形能力著称，并且 GPU 能力有限，因为通常情况下，服务器只需要显示管理控制台。

现在这一切都变了。随着 2013 年 View 5.2 的发布，硬件加速图形的能力成为了标准产品功能，推出了**虚拟共享图形加速**（**vSGA**），随后推出了**虚拟专用图形加速**（**vDGA**）。

我们将在本章的接下来的部分讨论这两种技术。我们还将讨论 Horizon View 中图形功能的最新版本，包含**虚拟图形处理单元**（**vGPU**）。

# vSGA

vSGA 实现允许多个虚拟桌面机器共享一张物理 GPU 卡，该卡安装在托管这些虚拟桌面机器的 ESXi 主机服务器中。

在这种模式下，虚拟桌面机器无法直接访问专用的物理 GPU 卡。相反，VMware Tools 中的标准 VMware SVGA 3D 图形驱动程序被安装在虚拟桌面操作系统中。SVGA 驱动程序是一个 VMware 驱动程序，提供对 DirectX 9.0c 和 OpenGL 2.1 的支持。

在此配置中，由显卡制造商提供的驱动程序（VIB）会安装在 ESXi 虚拟化管理程序上，而不是虚拟桌面机器的操作系统上。来自用户会话的图形命令会被此驱动程序拦截并发送到虚拟化管理程序，后者控制 ESXi 服务器中的 GPU。

向用户端点的交付工作方式相同，DevTAP 会将用户体验编码为 PCoIP 或 Blast Extreme，并通过 HTML5 浏览器或 Horizon 客户端将其交付到最终用户设备。下图展示了 vSGA 架构的概览：

![](img/ab9c0469-21d3-4d39-b404-51a826fe3b1d.png)

有几种配置和支持选项需要考虑，我们将在接下来的章节中进行讨论。

# vSGA 支持的显卡

vSGA 将支持基于 OpenGL 2.1 和 DirectX 9 的应用程序，这些应用程序可以在 Windows 7 或 8 的虚拟桌面机器上运行，并且虚拟化在 VMware vSphere 5.1 及更高版本上，使用以下制造商的 GPU 卡之一：

+   Intel HD Graphics P4700，和 Intel Iris Graphics

+   Tesla

+   NVIDIA GRID

+   AMD FirePro

有关最新的兼容性指南和支持的显卡，请点击以下链接：[`www.vmware.com/resources/compatibility/search.php?deviceCategory=vsga`](http://www.vmware.com/resources/compatibility/search.php?deviceCategory=vsga)。

# vSGA 支持多少个虚拟桌面？

这是一个在讨论在 Horizon View 环境中提供硬件加速图形时经常被问到的问题，所以我们需要花些时间来理解这个问题。在 Horizon View 中，您可以根据使用场景创建不同的桌面池，正如我们将在第八章《配置和管理桌面池——第一部分》中所介绍的那样，其中一个桌面池将配置为使用高端图形。通常，您不希望所有用户都能访问硬件 GPU，因此您会为这一使用场景创建一个桌面池。

所以，要回答这个问题，您可以分配给 GPU 的虚拟桌面数量取决于您为每个虚拟桌面分配的视频内存（VRAM）量。需要记住的是，资源是共享的，因此正常的 VMware 虚拟化规则适用。首先要注意的是内存是如何共享的。

分配给虚拟桌面机器的视频内存的一半来自 GPU 卡的内存，另一半来自主机服务器的内存。在配置主机服务器时，您需要确保服务器中配置了足够的内存来分配为视频内存。

基于这一点，且支持的虚拟桌面数量是根据分配的 VRAM 量来决定的，接下来我们来看看具体是如何实现的。

默认情况下，每台虚拟桌面机分配的显存为 128 MB。因此，在这个示例中，64 MB 来自 GPU，另外 64 MB 来自主机服务器。如果你使用一张拥有 4 GB 显存的 GPU 卡，你将能够支持 64 台虚拟桌面机（4 GB 或 4,096 MB 除以每台虚拟桌面机的 64 MB 显存 = 64 台虚拟桌面机）。

使用 Horizon View，你可以为每台虚拟桌面机分配最多 512 MB 的显存。如果将此应用于前面的示例，并使用相同的 4 GB GPU 卡，那么你现在将支持 16 台虚拟桌面机（4 GB 或 4,096 MB 除以每台虚拟桌面机的 256 MB 显存 = 16 台虚拟桌面机）。

使用 AMD 图形解决方案时，每个 GPU 最多支持 15 台桌面。

我们之前提到过，正常的 VMware 虚拟化规则适用，那么我们来详细解释一下这是什么意思。基本上，当你无法满足虚拟桌面机的规格且资源不足时，会发生什么？它无法启动或开机，对吧？GPU 配置也是如此。如果你为桌面池配置了超过该 GPU 能够支持的虚拟桌面机，它们将无法启动。

如果你确实配置了更多虚拟桌面机并且无法确保 GPU 资源可用，请在 View Administrator 控制台中将硬件 3D 设置为自动。这样，Horizon View 将会回退到基于软件的 3D 渲染来提供虚拟桌面机。

# vDGA

虽然 vSGA 是基于共享的，vDGA 允许每个虚拟机拥有对安装在 ESXi 主机服务器上的物理 GPU 卡的独立访问权限。这使得虚拟桌面机能够获得更高水平的图形性能，非常适合用于 CAD/CAM 应用等场景，因为它支持 DirectX（9、10 和 11）、OpenGL 4.4 和 NVIDIA CUDA。

以下图示展示了 vDGA 的架构：

![](img/13660d3c-57e2-4c16-a4d3-8c75c8ecf8cd.png)

vDGA 解决方案利用了一项名为**VMDirectPath I/O 直通**的功能，有时也被称为**PCI 直通**，它允许虚拟桌面机绕过虚拟化管理程序层，直接访问主机服务器中的硬件。在这种情况下，所涉及的硬件是 NVIDIA GPU 卡。

由于 VDI 桌面与 GPU 之间是按一对一方式映射的，因此无法使用 vSphere 的功能，如 HA、DRS 或 vMotion。

# vDGA 支持多少台虚拟桌面？

与 vSGA 不同，vSGA 受限于 GPU 卡上的内存数量，而 vDGA 仅受限于你可以物理安装在主机服务器中的 GPU 或 GRID 卡的数量。这取决于你的服务器供应商及其支持的硬件。

服务器供应商提供启用了 NVIDIA GRID 的预构建服务器，因此这种技术只能通过 OEM 渠道获得。主要原因是服务器需要额外的电力和冷却组件来驱动 GRID 卡。

例如，一张 NVIDIA GRID K2 GPU 卡上有两个 GPU，这意味着您可以将四个虚拟桌面机器分配给这张卡。根据您的服务器硬件平台，您可以安装多个卡，从而增加使用硬件启用 GPU 的虚拟桌面用户数量。

# vDGA 支持的显卡

以下是一些与 vDGA 兼容的 GPU 卡：

+   NVIDIA GRID、NVIDIA Tesla 和 NVIDIA Quadro

+   AMD FirePro

有关最新的兼容性指南和支持的显卡，请点击以下链接：[`www.vmware.com/resources/compatibility/search.php?deviceCategory=vdga`](http://www.vmware.com/resources/compatibility/search.php?deviceCategory=vdga)。

# vGPU

在前面的章节中，我们讨论了两种提供高端图形的不同模型。然而，这些解决方案各自存在一些限制。

使用 vSGA 时，您可以获得在用户数量上的扩展性，这些用户可以使用 GPU 卡；然而，由于它不使用 GPU 供应商提供的原生驱动程序，因此一些 ISV 不会认证其应用程序在此解决方案上运行。他们需要认证 VMware SVGA 驱动程序，因为这是使用的驱动程序。

所以，解决 ISV 支持问题的答案是使用 vDGA，它使用了原生 GPU 供应商的图形驱动程序，但现在在扩展性和高成本方面存在限制。将虚拟桌面机器专用给 GPU，并且每个主机服务器中只有少量的 GPU，这会导致一个非常昂贵的解决方案。尽管如此，也可能有某些应用场景适合这种解决方案。

我们需要的是一种兼顾两全的解决方案；既能够利用共享 GPU 的扩展性，又能使用原生图形驱动程序。这种解决方案称为 vGPU，并作为 Horizon 6 和 6.1 版本的一部分发布。

下图展示了 vGPU 的架构：

![](img/167e6018-2e9d-424a-b1d7-4869560d1a6b.png)

在这种模型中，我们在虚拟桌面机器中安装了原生 NVIDIA 驱动程序，然后该机器可以直接访问主机服务器中的 NVIDIA GRID 卡。GPU 被有效地虚拟化并进行时间切片，每个虚拟桌面机器都能分到这一段时间。

vGPU 仅在 VMware vSphere 6 和 Horizon View 6.1 及更高版本中可用。

# vGPU 支持多少个虚拟桌面？

使用 vGPU 时，支持的用户/虚拟桌面机器数量基于不同的配置文件。这些配置文件在下图中有详细说明，显示了支持的用户数量、支持的显示器数量等：

![](img/374dfd12-544d-4507-8c26-0aa812132f2a.png)

与 vDGA 和 vSGA 解决方案一样，你需要检查是否具有正确支持的硬件。此外，你还应检查你的应用程序是否在这些配置中得到支持。你可以通过以下链接访问 NVIDIA 官网，查找当前支持的应用程序列表：[`www.nvidia.com/object/grid-isv-tested-applications.html`](http://www.nvidia.com/object/grid-isv-tested-applications.html)。

# 统一通信支持。

就像高端图形处理一样，如果我们几年前讨论在 VDI 桌面上运行统一通信解决方案或 VoIP 会话，我会把它描述为 VDI 的致命克星！尽管技术上可以运行，第一次通话可能表现尚可，但增加更多用户最终会导致服务器在处理生成的流量和进行通话所需的资源时崩溃。最终，体验会变得完全不可用。统一通信并不是 VDI 的理想用例。

然而，这一切都发生了变化，现在你可以愉快地在虚拟桌面上使用统一通信解决方案。始终存在一个很好的用例来将统一通信与 VDI 部署结合；只是它以前从未能正常工作！举例来说，一个呼叫中心环境，能够提供灾难恢复解决方案，或者允许用户在雪天时在家工作，仍然能够像在办公室一样拨打和接听电话。

那么，为什么以前不行呢？很简单，因为当你从虚拟桌面拨打 VoIP 电话时，通话会通过 PCoIP 协议进行，从而导致带宽问题，使得桌面性能变慢，并且给服务器增加额外的负载，必须处理通话。这在下图中有详细说明，展示了以前的情况和之后的结果：

![](img/f1e051d8-deb7-4453-8718-a91e9ac57d8d.png)

为了解决这些问题并实现可行的解决方案，VMware 专注于三个关键领域，并提供了以下新功能/增强功能：

+   将媒体处理卸载到客户端设备，通过移除数据中心服务器的负载。

+   优化的点对点媒体传输，消除回环效应。

+   高质量的统一通信 VoIP 和视频，带有 QoS 保障。

# 现在统一通信是如何工作的？

远程过程调用利用虚拟通道，使得运行在 VDI 桌面上的软电话不同组件之间能够进行通信，并将语音和视频数据传输到客户端设备中的其他软电话组件。这些是带外通信。

呼叫控制栈（如果使用 SIP 信令，则为**SIP 栈**）与呼叫控制服务器或呼叫管理器进行通信，以注册或建立通话。

客户端设备上的媒体引擎执行语音和视频流的编码与解码，转换成本地的语音和视频编解码器，然后将 VoIP/视频流直接传输到另一个终端（按照呼叫管理服务器的指示），从而建立点对点通话，避免通过数据中心。这消除了回拨效应。

目前，VMware 支持来自 Cisco、Mittal、Avaya 和 Microsoft Lync 2013 的解决方案。我们将在下一节中讨论 **Microsoft Skype (Lync)** 解决方案。

# 支持 Microsoft Skype

根据我们刚才讨论的内容，VMware Horizon 现在支持 Microsoft Skype，并通过 Horizon Virtualization Pack for Skype for Business 提供完整支持，包括对 VoIP 和视频的全面支持。下图展示了客户端工作过程：

![](img/39d67b6b-0d4d-4fb7-9049-a89dc9682ec3.png)

要启用 Skype，您需要确保在终端设备上安装了 Horizon Virtualization Pack for Skype for Business，并且同时安装了 Horizon 客户端和 Microsoft Skype 客户端。VMware 在 PCoIP 协议内部实现了 Microsoft 的 **动态虚拟通道**（**DVC**）以启用此功能。DVC 提供虚拟桌面机器与客户端终端之间的通信路径。

解决方案有一些限制，需要提到：

+   不支持为音频设备和视频设备调节页面。

+   不支持多视角视频。

+   不支持对话录音功能。

+   不支持呼叫代理功能。

+   不支持响应组代理匿名化功能。

+   不支持匿名加入会议。

+   不支持将 Skype for Business VDI 插件与 Skype for Business Phone Edition 设备一起使用。

# 实时音视频（RTAV）

在统一通信支持的基础上，我们接下来听到的问题是关于如何插入 USB 网络摄像头并在虚拟桌面中使用它的支持。

# 问题

与统一通信和 VoIP 类似，由于这类设备对带宽的高需求，最初不支持在虚拟桌面机器上使用网络摄像头或进行音频输入和输出，这会导致性能较差。之前，任何此类设备的重定向都是通过 PCoIP 协议的 USB 重定向功能来处理的。

这是音频输入的工作方式，但使用 3.5mm 插孔的音频输入完全无法工作。使用 PCoIP 音频重定向功能时，音频输出是有效的，这比使用 USB 重定向要好得多。因为客户端系统无法拆分 USB 音频设备，导致音频输出保持本地，而音频输入被重定向。这意味着在 VoIP 解决方案中使用 USB 耳机时，需要将整个耳机（音频输入和音频输出）都转发给客户端。

# RTAV 如何解决这个问题？

**RTAV** 不使用 USB 转发音频和摄像头设备。相反，USB 设备保持连接到本地客户端，音频和图像从本地设备提取。音频和图像数据被编码后传送到来宾虚拟桌面机器，在那里解码。VMware 安装了一个虚拟摄像头和一个虚拟麦克风虚拟桌面机器。这些设备用于回放音频和视频。你将会在虚拟桌面机器的设备管理器中看到这些设备条目。

RTAV 支持以下功能：

+   同时连接摄像头和音频设备，用于基于 VoIP 的视频会议应用，如 Skype。

+   仅音频输入（无视频）用于 VoIP（仅语音）应用

+   仅摄像头；用于摄像头监控类应用（例如 CCTV）和拍照

# URL 内容重定向

**URL 内容重定向**功能允许你配置 URL，以便在终端设备的本地浏览器中打开，或在虚拟桌面机器上打开。哪个内容在何处打开是通过使用**GPO**进行配置的。

这样做的使用场景是将内部浏览与外部浏览分开。如果你想查看安全内容，可以使用虚拟桌面机器上的浏览器，因为如果数据不离开数据中心，其他浏览活动可以在本地进行。另一个场景可能是你希望限制进入数据中心的带宽使用，如果用户浏览的是大容量内容，他们可以使用本地的互联网连接。

你可以配置两种类型的 URL 进行重定向：

+   用户在浏览器地址栏中输入的 URL

+   应用程序中的链接，例如 Outlook 或 Word，用户可以点击的链接

# Horizon 客户端

Horizon 客户端基本上是解码并在终端设备上显示虚拟桌面机器屏幕的地方。Horizon 客户端有两种不同的类型：一种是基于软件的版本，安装在用户的终端设备上；另一种是基于硬件的版本，使用零客户端或瘦客户端。

我们将在第十二章中讲解 View 客户端选项，*Horizon 客户端选项*。

# 总结

在本章中，我们讨论了 Horizon View 架构及构成完整解决方案的不同组件。我们介绍了关键技术，比如如何通过链接克隆和即时克隆来优化存储，然后我们介绍了一些旨在提供出色终端用户体验的功能，如提供高端图形、统一通信、配置文件管理，以及协议如何将桌面交付给终端用户。

现在你已经理解了所有这些功能和组件，它们是如何工作的，以及它们如何融入整体解决方案。在接下来的章节中，我们将深入探讨如何配置它们。
