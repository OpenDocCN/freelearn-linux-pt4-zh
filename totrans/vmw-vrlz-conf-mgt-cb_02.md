# 第二章。配置 VCM 以管理您的基础设施

在本章中，我们将涵盖以下几篇指南：

+   添加 vCenter 服务器实例

+   添加 vCloud Director 和 vShield 实例

+   从管理的机器收集数据

+   添加发现规则

+   添加网络权限账户以管理多个域中的机器

+   配置用于虚拟环境管理的管理代理机器

+   在 Windows 服务器上安装代理

+   在 Linux 服务器上安装代理

+   创建机器组

# 介绍

一旦安装了 VCM，我们需要对其进行配置，使其适应我们的环境；默认配置需要根据环境特定的变化进行修改。为了管理我们的基础设施，我们需要在 Windows 和 Linux 服务器上安装代理。这可以通过多种方式实现，例如通过脚本安装，或者如果我们使用自动化来部署机器，也可以使用自动化工具本身，或将其推送到 VCM 识别的服务器。

我们需要将 vCenter、vCloud 和 vShield 服务器实例添加到 VCM，以便开始利用这些系统中可用的详细信息，如已部署的机器和 vApp，这些可以用来创建各种报告。同时，捕获的详细信息还包括基础设施中部署的虚拟机，这些虚拟机可以被 VCM 用来部署代理并纳入管理。

我们需要创建各种机器组；机器组基本上是可以根据不同目的（例如修补、报告和合规性检查）将机器集合成一个实体的集合。

在本章中，我们将开始配置 VCM，以便它为日常操作做好准备。

我们开始吧。

# 添加 vCenter 服务器实例

在我们开始管理虚拟基础设施之前，我们需要将这些组件添加到 VCM。我们将从以下几篇指南开始添加它们，从 vCenter 开始。

## 准备工作

我们将需要一个具有管理权限的用户来访问我们要添加到 VCM 的 vCenter 实例，以及其**完全限定域名**（**FQDN**）或 IP 地址。

## 如何操作...

要将 vCenter 实例添加到 VCM，请登录到 VCM 服务器 UI 并按照以下步骤操作：

1.  使用管理员帐户登录到 VCM。

1.  转到**管理** | **机器管理器** | **许可机器** | **许可虚拟环境**。![操作方式...](img/5400_02_pg-2.jpg)

1.  点击**添加机器**。

1.  在向导的第一页上选择**基础**。

1.  输入机器名称的主机名（此处不使用 FQDN），从下拉菜单中选择机器所属的**域**，选择**DNS**作为**类型**，选择**vCenter Windows**作为**机器类型**。

1.  点击**添加**，然后点击**下一步**。

1.  点击**完成**以关闭向导。

    ### 注意

    通过这些步骤，我们将 vCenter 实例添加到 VCM，但我们仍然需要进行配置，以便能够收集详细信息。

1.  现在，选择刚才添加的 vCenter 实例，然后点击**配置设置**。

1.  在此向导中，选择 vCenter 实例。

1.  提供以下信息：

    +   **管理代理**：您的收集器服务器

    +   **端口**：`443`

    +   **用户 ID**：具有 vCenter 管理员访问权限的用户

    +   **密码**：用户密码；输入两次以确认

    +   **忽略不受信任的 SSL 证书**：**是**

1.  填写完所有细节后，点击**下一步**。如何操作...

    ### 注意

    **注意**：用户必须具有 vCenter Server 管理员角色或只读角色。然而，您无法使用只读角色执行操作。

1.  点击**完成**以关闭向导。

1.  在 VCM 控制台上，vCenter 实例的名称前应该有一个绿色圆圈。

## 它是如何工作的...

我们将 vCenter 添加到 VCM，以便收集关于该实例中所有 ESXi 主机、所有虚拟机等的信息，并根据这些信息，我们可以为我们的虚拟基础设施创建合规性检查，发现虚拟机作为 VCM 中的管理机器，进而安装代理，并收集它们的信息。

VCM 从 vCenter 收集以下信息：

+   vCenter 概览

+   vCenter 自定义信息

+   vCenter 来宾

+   vCenter 主机

+   vCenter 主机配置文件

+   vCenter 清单

+   vCenter 网络

+   vCenter 设置

+   vCenter 资源池

+   vCenter 角色

# 添加 vCloud Director 和 vShield 实例

VCM 可以管理三个虚拟元素：vCenter、vShield 和 vCloud。在前面的步骤中，我们添加了 vCenter。接下来，我们将继续进行**vShield**和**vCloud Director**（**vCD**）的配置。

VMware vShield 是一套为 VMware vCenter Server 集成而构建的虚拟安全设备。vShield 安全组是您创建的逻辑信任区，并为其分配资源进行 vShield 保护。

通过将 vCloud 添加到 VCM，您可以使用 vCloud Director 属性创建机器组等。

## 准备就绪

我们将需要 vShield Manager 和 vCloud Director 实例的 IP 地址以及具有管理员权限的用户账户。

在添加 vShield 之前，您必须先收集 vCenter 实例的数据，如下一个步骤所示。

## 如何操作...

我们将把此操作分为两个部分，如下所示。

+   *添加 vShield 实例*

+   *添加 vCloud Director 实例*

### 添加 vShield 实例

这与添加 vCenter 略有不同。在添加 vCenter 实例并收集数据后，VCM 会识别 vShield 虚拟机并使其在 VCM 控制台上可供配置，因此我们无需像添加 vCenter 时那样执行额外的步骤；只需要配置它，接下来我们将按如下步骤进行配置：

1.  前往**管理** | **机器管理器** | **授权机器** | **授权虚拟环境**。

1.  选择 VCM 识别的 vShield 设备，点击**配置设置**。添加 vShield 实例

1.  确保在启动的向导中选择了 vShield 实例。

1.  提供以下信息：

    +   **管理代理**：您的收集器服务器

    +   **端口**：`443`

    +   **用户 ID**：具有对 vShield 的管理访问权限的用户

    +   **密码**：用户的密码；输入两次以确认

    +   **忽略不受信任的 SSL 证书**：**是**

    +   提供此 vShield 实例负责的 vCenter 服务器实例的名称

    ![添加 vShield 实例](img/image_02_004.jpg)

    ### 注释

    **注意**：用户必须具有 vShield Manager 的管理角色或无限制的只读角色。

1.  点击**完成**以关闭向导。

再次，在 VCM 控制台上您应该看到刚刚配置的 vShield 实例前面有一个绿色圆圈。

如果没有，请确保您提供了正确的用户名和密码。

### 添加一个 vCloud Director 实例

登录到 VCM 服务器并按照以下步骤操作：

1.  转到**管理** | **机器管理器** | **已许可的机器** | **已许可的虚拟环境**。

1.  点击**添加机器**。

1.  在向导的第一页中选择**基本**。

1.  在**机器名称**中输入您的主机名，从下拉列表中选择机器所属的**域**，选择**DNS**作为**类型**，选择**vCloud Director**作为**机器类型**。

1.  点击**添加**，然后点击**下一步**。

1.  点击**完成**以结束向导。

    ### 注释

    通过这些步骤，我们将 vCloud 实例添加到 VCM，但我们仍然需要配置它以便收集详细信息。

1.  现在，选择我们刚刚添加的 vCloud Director 实例，然后点击**配置设置**。

1.  在此向导中选择 vCloud Director 机器。

1.  提供以下信息：

    +   **管理代理**：您的 Collector 服务器

    +   **端口**：`443`

    +   **用户 ID**：具有对 vCloud Director 的管理访问权限的用户

    +   以`user@System`格式的本地用户

    +   **密码**：用户的密码；再次输入以确认

    +   **忽略不受信任的 SSL 证书**：**是**

    ![添加 vCloud Director 实例](img/image_02_005.jpg)

1.  点击**完成**以关闭向导。

1.  在 VCM 控制台上，vCloud Director 实例名称前应该有一个绿色圆圈。

## 工作原理...

我们在 vShield 实例中提供信息，即暴露给 VCM 的安全组及其成员。这些详细信息也存储在 VCM 数据库中，可以在需要时使用。

添加并执行集合后，我们从 VCM 控制台中的 vCloud Director 数据库获得以下信息：

+   vCloud Director 组织

+   vCloud Director 虚拟机和 vApps

+   vCloud Director 组织目录

+   vCloud Director 虚拟数据中心（vDC）和网络

+   vCloud Director 组织用户

+   vCloud Director 组织群组

+   vCloud Director 组织设置

此信息可用于根据 vCloud 组织创建机器组以便相应管理。

# 收集来自受管理机器的数据

一旦我们完成添加和配置虚拟环境，就可以开始收集数据，进而用于检查合规性、创建必要的机器组、导出报告等。

我们需要收集虚拟环境中的数据以及我们计划管理的所有机器的数据，即 Windows 或 Linux 服务器。

## 准备就绪

我们要管理的所有服务器应已添加到 VCM 控制台中，可以通过遵循虚拟基础设施的先前步骤或通过本章中的代理安装步骤来完成。

## 如何操作…

我们将把这个步骤分为两个部分：

+   *从虚拟基础设施收集数据*

+   *从受管机器收集数据*

### 从虚拟基础设施收集数据

要从 vCenter、vShield 管理器或 vCD 实例收集所有数据，请按照以下步骤操作：

1.  登录到 VCM，并按照步骤收集虚拟基础设施数据。

1.  你可以在 VCM 控制台的任何地方，确保机器组是**所有机器**（要了解更多关于机器组的信息，请查看*创建机器组*的步骤），然后点击左上角的**收集**。

1.  这将启动一个向导；在**收集类型**下选择**机器数据**。

1.  选择你要收集数据的机器，在本例中，可以选择任何或所有 vCenter、vShield 和 vCloud 服务器。选择它们并确保它们在右侧，然后点击**下一步**。

1.  选择**选择数据类型**来收集这些机器的数据。![从虚拟基础设施收集数据](img/image_02_006.jpg)

1.  在**数据类型**下，勾选**虚拟化**下的每个复选框：![从虚拟基础设施收集数据](img/image_02_007.jpg)

1.  确保没有冲突，然后点击**完成**。

1.  点击 VCM 控制台左上角的**作业**。

1.  确保收集数据的任务已成功完成。

### 从受管机器收集数据

在本小节中，我们将收集来自受管机器的数据，如 Windows 和 Linux 服务器。请按照以下步骤操作：

1.  登录到 VCM，并按照步骤收集虚拟基础设施数据。

1.  你可以在 VCM 控制台的任何地方，确保机器组是**所有机器**（要了解更多关于机器组的信息，请查看*创建机器组*的步骤），然后点击左上角的**收集**。

1.  这将启动一个向导；在**收集类型**下选择**机器数据**。

1.  在下一页，选择你想要收集数据的机器/机器组。选中的机器必须位于右侧。

1.  你有两种选择来决定如何收集数据：根据数据类型或根据收集筛选器集。

    ### 注意

    **注意**：如果你选择数据类型，那么你将看到可以从操作系统的各种实体中选择的选项，如账户、账户策略、磁盘空间、设备驱动器等，这些选项与我们所选的机器的操作系统相关。如果选择筛选器集，VCM 会预先创建一组筛选器，可以用于从受管机器收集数据。这些筛选器集可以在安装 VCM 时或在导入任何合规模板时手动创建。

    ![从受管机器收集数据](img/image_02_008.jpg)

1.  根据你选择的内容，下一页面将有所不同。

1.  对于**数据类型**窗口，选择单独的数据类型或选择全部数据类型。![从受管机器收集数据](img/image_02_009.jpg)

1.  对于**过滤器集**窗口，选择适当的过滤器集以收集数据。![从受管机器收集数据](img/image_02_010.jpg)

1.  确保没有冲突，并关闭向导。它将启动一个采集任务，VCM 将访问指定的机器并根据数据类型或选定的过滤器集收集详细信息。

## 如何工作...

在之前的步骤中，我们添加了 vCenter、vCD 和 vShield Manager；现在，我们需要导入这些元素的数据。通过执行采集操作，我们将这些系统中的详细信息添加到 VCM 中，以便我们可以通过一个单一的界面查看所有细节。

从这些系统获取的详细信息已经在之前的步骤中提到。当 VCM 执行采集操作时，它会进入每个应用的数据库，提取所有相关信息，然后将其存入自己的数据库。例如，当我们执行 vCenter 采集时，它会收集所有虚拟机、ESXi 主机、其版本、虚拟机的快照详情、虚拟机配置等信息。所有数据都将在 VCM 控制台下的**控制台** | **虚拟环境**中展示。

对于 vCD，VCM 会获取有关 vApp、虚拟机、目录、本地用户、组等的信息。

这些信息可以通过报告导出，用于合规性检查。这些信息也可以用于创建动态过滤器，进而创建机器组。

从受管机器（如 Windows 和 Linux 服务器）捕获的详细信息将用于分析它们当前的合规性和补丁状态。

## 还有更多...

如果你想了解过滤器集的详细信息，请查看 VMware 的以下文章：

[`www.vmware.com/support/vcm/doc/help/vcm581/Content/Core_CS/AdminSettingsCollFltr.htm`](https://www.vmware.com/support/vcm/doc/help/vcm581/Content/Core_CS/AdminSettingsCollFltr.htm)

# 添加发现规则

VCM 必须先发现你环境中的机器，然后才能从中收集数据。你可以创建一个**发现规则**来自动发现所有机器，或者可以应用过滤器来限制 VCM 发现的机器。发现规则用于自动发现受管机器。

## 准备工作

你必须配置并收集来自 vCenter 和 vCloud 的数据，才能添加数据库发现规则。

你必须为虚拟环境以及 Windows、Unix 和 Linux 机器配置许可，以便用于数据收集。当你为这些虚拟或物理机器配置许可时，它们会出现在**已许可机器**列表中。

VCM 可以从 Active Directory、浏览器列表、域控制器、数据库或通过 IP 地址发现机器。

我们将在本步骤中执行数据库发现操作；你可以在实验室中查看其他选项。

## 如何操作...

我们将通过以下步骤配置 VCM 以发现 vCenter 虚拟机：

1.  以管理员身份登录 VCM。

1.  转到**管理员** | **机器管理器** | **发现规则**；点击绿色加号按钮以添加新发现规则。

1.  这将启动一个向导；提供一个名称和描述。

1.  选择**通过数据库发现：**复选框。![如何操作...](img/image_02_011.jpg)

1.  在**发现查询**下选择**vCenter 来宾系统**。

1.  另外两个选项是使用 vCloud Director 或直接从主机。![如何操作...](img/image_02_012.jpg)

1.  在下一页，根据此表格选择/填写选项：

    | **选项** | **描述** |
    | --- | --- |
    | **机器名称格式** | VCM 显示来宾机器的格式。您可以选择**NetBIOS**、**DNS**或**VM/vCenter**名称格式。 |
    | **域名** | 添加新机器时的域。该域与手动发现添加机器时的**域名**属性相同。 |
    | **域类型** | 从**Active Directory**、**DNS**或**NetBIOS**域类型中选择一个。 |
    | **协议** | 选择**DCOM**或**HTTP**。 |
    | **HTTP 端口（默认为空时使用）** | 这将使用目标机器上的 HTTP 监听器。监听器配置为在指定端口上监听。端口`26542`是默认设置。接受的端口值范围为`1`到`65535`。其他应用程序不得使用此端口。 |
    | **使用代理服务器** | **否** |
    | **连接字符串** | 这是要联系的虚拟机的地址。此地址可能与 DNS 或其他名称解析系统通过机器名称解析得到的地址不同。当 VCM 必须通过网络地址转换（**NAT**）地址联系 vApp 虚拟机时，请使用此地址。 |
    | **ESX 主机名称过滤器** | 根据您输入的信息，此过滤器将查询虚拟环境中的 ESX 主机名称。 |
    | **虚拟机来宾名称过滤器** | 根据您输入的信息，此过滤器将查询虚拟环境中 ESX 主机上的来宾虚拟机名称。 |
    | **来宾 DNS 名称过滤器** | 根据您输入的信息，此过滤器将查询域名服务器。 |
    | **来宾操作系统名称过滤器** | 根据您输入的信息，此过滤器将查询虚拟环境中的来宾操作系统。 |
    | **电源状态** | 根据您输入的信息，此过滤器将查询虚拟环境中来宾虚拟机的状态。 |

    在按照表格中所述做出适当选择后，您的屏幕应该如下所示：

    ![如何操作...](img/image_02_013.jpg)

1.  选择**是**以在规则创建结束后启动发现，如果需要，您还可以选择**许可**并在**发现的机器**上安装**代理**。

1.  单击**完成**以关闭向导。

## 它是如何工作的...

由于这是对 VCM 数据库执行的查询，我们必须在运行此发现规则之前至少对一个 vCenter 服务器进行数据采集。

如果你选择不为机器授权，VCM 会将机器添加到机器管理器中的可用机器列表；如果选择将其作为发现规则的一部分进行授权，则它们将归类为授权的 Windows 或 Unix 机器。

## 更多内容...

这是从 VCM 帮助文档中提取的所有可用方法的表格，地址：[`www.vmware.com/`](http://www.vmware.com/)：

| **序号** | **方法** | **描述** |
| --- | --- | --- |
| **1** | **通过活动目录** | 通过此方式可以发现所有在所选 AD 域中有账户的机器。发现过程根据当前的域控制器数据识别机器。 |
| **2** | **通过浏览列表** | 此方式通过启用**计算机浏览器**服务的机器来发现机器。当规则通过浏览列表发现机器时，VCM 会返回每台机器的 NetBIOS 域名。 |
| **3** | **通过域控制器** | 通过此方式可以发现所有在所选域中有账户的机器。当域控制器执行定期更新时，现有机器可能不会显示，而已删除的机器可能会出现。 |
| **4** | **通过 IP 地址** | 此方式通过特定的 IP 地址范围来发现网络中所有机器。发现的机器会出现在可用机器列表中。 |
| **5** | **通过数据库发现** | 此方式通过用于发现规则的 SQL 查询来发现机器。该发现类型使用 VCM 已经从其他来源收集的数据作为发现新系统的基础。你可以发现由 vCD 管理的虚拟机、虚拟机客体和虚拟机主机。 |

更多内容请参见这里：

[`www.vmware.com/support/vcm/doc/help/vcm581/Content/Core_CS/AdminMachMngrDiscAECWiz.htm`](https://www.vmware.com/support/vcm/doc/help/vcm581/Content/Core_CS/AdminMachMngrDiscAECWiz.htm)

# 添加网络授权账户以管理多个域中的机器

对于中型到大型基础设施，通常会有多个活动目录域可用。我们可以使用 VCM 管理多个域中的服务器。本节解释了你需要做的工作。

## 准备工作

必须有适当的名称解析。如果中间有防火墙，则第一个章节中提到的端口必须开放。

我们需要为每个域提供一个**网络授权账户**，以便管理该域中的机器，以及执行 VCM 功能，如数据收集、打补丁等。

## 如何操作...

我们需要添加域和网络授权账户，并最终将它们关联在一起。

转到**管理** | **设置** | **网络授权**

我们有三种选择：

+   **可用域**（在执行安装时识别的域）；如果需要，我们可以添加新的域

+   **可用账户**（在执行 VCM 部署时，我们分配了一个 NAA）

+   **分配账户**

### 可用域

在执行 VCM 服务器安装时，域会在某个步骤中进行标识；现在，我们可以添加额外的域。在**可用域**下点击**添加**，并提供域**名称**和**类型**。

![可用域](img/image_02_014.jpg)

### 可用账户

在**可用账户**下，我们可以看到哪些网络权限账户是可用的，然后可以添加任何额外的账户或删除不需要的账户。

![可用账户](img/image_02_015.jpg)

### 分配的账户

这是我们将可用账户与可用域关联的地方。

转到**分配的账户** | **按域** | **Active Directory**，然后点击**编辑分配的账户**，并将可用账户与此域关联。

![分配的账户](img/image_02_016.jpg)

## 它是如何工作的...

基本上，通过遵循这个过程，我们为将由 VCM 管理的各个域中的所有机器分配了具有本地管理员权限或第一章中解释的权限的账户。

我们可以根据需要分配任意数量的账户。当启动 VCM 功能时，将按指定顺序尝试分配的账户。当某个账户被再次启动时，将优先使用最后成功使用的账户。账户按分配顺序从上到下列出。

如果一台机器出现在多个列表中（如域和机器组），则用于与其联系的权限账户的顺序如下：

+   最后一个成功使用的账户

+   分配给域的账户

+   被分配给任何机器组（包括默认的**所有机器**组）的账户

我们只需要对 Windows 进行此操作，因为在 Linux 的情况下，我们需要在 VCM 控制台中接受证书。除非我们接受该证书，否则无法通过 VCM 修补 Linux 机器。要接受证书，在 VCM 控制台中，转到**管理** | **证书**，选择机器，然后点击**更改信任状态**。按照向导操作，您将看到机器前面有一个握手符号。这样，您就可以通过 VCM 控制台修补 Linux 机器。执行此操作的步骤将在下一篇食谱中介绍。

# 为虚拟环境管理配置管理代理机器

管理代理是管理收集器与我们通过 VCM 管理的虚拟环境之间通信的系统，即 vCenter Server、vCD 和 vShield Manager。在本食谱中，我们将指定一个系统作为管理代理。

## 准备工作

我们需要在机器上安装版本 5.5 或更高版本的代理，并收集其数据，这将被指定为管理代理。请参考下一篇食谱。

管理代理机器必须安装版本 5.5 或更高版本的代理。

我们可以指定任何能够与 VCM、vCD、vShield 和 vCenter Server 通信的服务器作为管理代理。

## 如何操作...

登录 VCM 并按照以下步骤指定一个管理代理，然后将其更改为受管虚拟环境：

1.  转到**管理** | **证书**。![操作步骤...](img/image_02_017.jpg)

1.  选择你想要指定为管理代理的机器。

1.  选择**更改信任状态**。

1.  勾选信任框或取消勾选以取消信任所选计算机框，点击**下一步**，然后在下一页点击**完成**以完成向导。

1.  再次选择机器，并点击顶部菜单中的**管理代理**。

1.  选择**启用**，点击**下一步**，然后在下一页点击**完成**以完成向导。

    ### 注意

    **注意**：管理代理的选择完全取决于你管理的基础架构的大小；你可以使用收集器作为管理代理，也可以使用另一台 Windows 机器。如果你的单个 vCenter 实例管理 1 到 30 个主机，并且最多有 1,000 个虚拟机，那么你可以将收集器作为管理代理。否则，请指定一个专用的管理代理。

    ![操作步骤...](img/image_02_018.jpg)

1.  所选服务器现在将成为管理代理。

1.  一旦指定了管理代理，我们可以将其更改为受管虚拟环境。

1.  转到**管理** | **机器管理器** | **许可机器** | **许可虚拟环境**。选择你想要更改管理代理的机器，并点击**配置设置**。

1.  如有必要，选择已添加的机器。

1.  在顶部，有一个下拉框可以选择其中一个可用的管理代理。更改为新的管理代理并点击**下一步**（截图中不可见），然后在下一页点击**完成**以关闭向导。![操作步骤...](img/image_02_019.jpg)

1.  对基础架构中其余的虚拟环境重复步骤 8 到 10。

## 工作原理...

管理代理是管理收集器与虚拟环境之间通信的系统，它使用各个产品的 VMware API。它们必须配置为管理虚拟环境实例与收集器之间的安全通信。

如果任何 vCenter 实例的管理主机数量在 1 到 30 台之间，并且最多有 1,000 个虚拟机，建议 VCM 收集器充当管理代理。默认的管理代理是收集器服务器，但随着工作负载的增加，我们可以开始添加其他代理。在本食谱中，我们介绍了如何指定受管机器作为受管代理。

我们正在指定另一台服务器与虚拟环境通信，以便将一些工作从 VCM 收集器中卸载。该服务器必须能够连接到虚拟环境服务器和 VCM 收集器。

# 在 Windows 服务器上安装代理

在开始管理任何机器之前，我们需要在其上安装一个代理。这可以通过多种方式完成，例如从 VCM 控制台推送、手动安装或通过脚本安装。

在此步骤中，我们将介绍如何在 Windows 服务器上手动安装代理和使用脚本安装代理。

## 准备工作

准备服务器以安装代理；安装程序位于 VCM 收集器服务器上的`X:\Program Files (x86)\Vmware\VCM\AgentFiles`，证书位于`X:\Program Files (x86)\Vmware\VCM\CollectorData`，其中`X`是安装 VCM 的驱动器。

从共享位置复制安装程序和证书，可以将其复制到希望安装的服务器上。

我们需要在将安装代理的服务器上获得管理员访问权限。

本地防火墙应禁用（不推荐）或在管理的机器和 VCM 收集器之间必须开放端口`26542`。

对于代理推送，我们需要将机器注册为 VCM 控制台上的许可机器，并且网络权限账户必须是本地管理员组的一部分，还需在推送代理的机器上开放端口`26542`。

## 如何执行...

我们将这个步骤分成三个部分，如下所示

+   *手动安装代理*

+   *从控制台推送代理*

+   *许可 Windows 机器*

### 手动安装代理

使用管理员帐户登录服务器，将带证书的安装程序复制到本地，并按以下过程操作：

1.  启动`VCMAgentInstall.exe`。

1.  再次点击**下一步**，然后在目标位置屏幕上，继续使用默认值`C:\Windows\CMAgent`。

1.  选择**允许 HTTP**，并使用默认端口`26542`。

1.  在此页面上，浏览到复制证书的位置。

1.  点击**下一步**三次，然后它将开始安装代理。

1.  安装代理后，登录到 VCM 控制台。

1.  转到**管理** | **机器管理器** | **许可机器** | **许可的 Windows 机器**，然后点击**添加机器**。

1.  选择**基本**并自动许可机器。

1.  提供安装代理的机器详细信息，如下所示：

    +   提供**机器名称**参数的主机名

    +   从下拉列表中选择该机器所属的域

    +   将**类型**选择为**DNS**

    +   选择**Windows 服务器**作为**机器类型**

1.  点击**下一步**，然后点击**完成**以关闭向导。

1.  将机器添加到 VCM 后，我们需要在控制台上点击**刷新**按钮，并点击**收集**以开始数据收集。

1.  监控数据收集作业，最后，将机器添加到 VCM 完成。

### 从控制台推送代理

该机器应在 VCM 控制台中，可以通过运行发现规则或手动添加来实现。现在，我们可以从控制台执行代理推送。

登录到 VCM 控制台，并按以下步骤在机器上安装代理：

1.  转到**管理** | **机器管理器** | **许可机器** | **许可的 Windows 机器**，并选择要添加代理的机器。

1.  在菜单中点击 **安装**。![从控制台推送代理](img/image_02_020.jpg)

1.  向导将会打开。确保机器出现在 **已选择** 框中。

1.  在下一个页面中，设置以下值：

    +   **安装地点：** 保持默认设置。

    +   **安装来源：** 保持默认设置。

    +   **选项：** 选择 **HTTP** 并将端口设置为 `26542`，其余保持默认。

    ![从控制台推送代理](img/image_02_021.jpg)

1.  在计划屏幕上，选择 **立即运行**。

1.  确认选择后点击 **完成**。

1.  点击 **作业** 查看作业是否成功，完成后返回控制台，向右滚动，检查机器的代理状态是否从 **未知** 变为 **当前代理**，并显示其代理版本为 **5.8.2**。

1.  一旦机器安装了代理，进行初始数据收集。

### 授权 Windows 机器

我们将执行以下步骤为受管理机器授权。这些步骤对于 Windows 和 Linux/Unix 机器是相同的。

1.  使用管理员账户登录 VCM 控制台。

1.  点击 **管理**。

1.  前往 **机器管理器** | **可用机器**。

1.  选择需要授权的 Windows 机器。

1.  点击 **许可证**。

跟随向导完成机器授权，如果可用数量为负且显示为红色，请联系 VMware 购买更多授权。

## 如何运作...

通过本操作，我们确保要管理的机器已安装代理、在 VCM 中已授权，并且已经执行了数据收集。

VCM 拥有足够的信息来启动软件部署；将机器放入正确的机器组。我们可以执行更具体的收集操作，了解合规状态或修补状态，并根据情况修复机器或安装缺失的补丁。

## 还有更多...

我们可以使用脚本来安装代理。

这是脚本的代码：

```
cd C:\VCM_Agent 
CMAgentInstall.exe /s INSTALLPATH=C:\Windows\CMAgent PORT=26542 CERT=C:\VCM_Agent\VMware_VCM_Enterprise_Certificate_E5D8927D-A9A7-43E8-8E6F-5C88D1E40F12.pem 

```

下面是各个选项的含义：

| **序号** | **选项** | **描述** |
| --- | --- | --- |
| **1** | `C:\VCM_Agent` | BAT 文件、安装程序和证书复制的路径 |
| **2** | `CMAgentInstall.exe` | VCM 代理安装程序 |
| **3** | `/s` | 静默安装选项 |
| **4** | `INSTALLPATH` | 安装 VCM 代理的服务器位置 |
| **5** | `PORT` | VCM 代理通信所用的端口 |
| **6** | `CERT` | VCM 企业证书路径 |

只需运行批处理文件，然后按照步骤 6 至 11 完成代理安装。

你也可以使用 `PowerCLI` 命令 `Copy.VMGuestFile` 和 `Invoke-VMScript` 来自动化部署。

# 在 Linux 服务器上安装代理

我们需要一个代理来管理 Linux/Unix 机器；在本操作中，我们将手动在 Linux 机器上安装代理。

## 准备中

如果是 Linux 安装程序，请确保从与管理的机器所在的同一台 VCM 服务器复制，因为 VCM 证书已嵌入安装程序中。如果我们使用来自另一台 VCM 服务器的安装程序，然后尝试从不同服务器管理它，将失败。

从 VCM 服务器将正确的安装程序复制到 Linux 服务器。

安装先决条件并验证目标机器上是否安装了 `glibc.i686`、`net-tools` 和 `redhat-lsb-core` 软件包。

如果防火墙已启用，请打开 `26542` 端口。

我们需要机器根密码来安装代理。

代理程序位于 VCM Collector 服务器的 `X: \Program Files (x86)\VMware\VCM\Installer\Packages\CMAgent.5.8.2.linux`，与 Windows 不同，不需要像在 Windows 上那样复制证书，因为证书已嵌入安装程序中。

## 如何做...

按照以下步骤在 Linux 机器上安装代理程序：

1.  使用 `scp` 或 `winscp` 在服务器上复制安装程序。

1.  以 root 用户登录 Linux 服务器。

1.  运行 `chmod u+x CMAgent.5.8.2.linux` 。

1.  运行 `./CMAgent.5.8.2.linux` 。

1.  将修改后的 `savedcsi.config` 文件复制到解压后的位置。

    ### 注意

    **注意：** `csi.config` 是 VCM 代理用于安装代理的配置文件。

    有关配置选项的更多详细信息，请访问 [`www.vmware.com/support/vcm/doc/help/vcm581/Content/NIX/CM_Ref_UNIX_csi_config_options.htm`](https://www.vmware.com/support/vcm/doc/help/vcm581/Content/NIX/CM_Ref_UNIX_csi_config_options.htm)。有很多选项可用于配置 `csi.config` 文件。

    我们需要设置 `CSI_AGENT_RUN_OPTION = daemon` 以将其作为守护进程启动；至于其他方面，您可以与您的 Linux 管理员协商并决定。

    例如： `# cp /<Shared_location> csi.config /<extractedlocation>/CSIInstall/csi.config` 。

1.  完成后，运行安装程序脚本 `./CSIInstall/InstallCMAgent -s` 。

    安装代理后，从第 6 步开始按照先前的步骤操作；只需将位置从 **Licensed Windows Machines** 更改为 **Licensed UNIX Machines**，并在输入详细信息时，根据操作系统设置 **Machine Type** 为 **Red Hat Server** 或任何其他操作系统，并按照以下截图：

    ![如何做...](img/image_02_022.jpg)

## 工作原理...

我们还将代理添加到 Linux/Unix 机器上，以便收集受管机器的详细信息；然后，这些详细信息将用于检查合规性和补丁状态。

## 还有更多...

我们可以创建一个预配置的 `csi-config` 文件，并将其与安装程序一起复制到 `/opt/CMAgent`。

将以下脚本内容复制到 `.sh` 文件中。

赋予执行权限： `chmod CMAgentInstall.sh 755` 。

然后运行 `./CMAgentInstall.sh` 命令。

```
IPTABLES="/sbin/iptables" 
grep -i suse /etc/issue >/dev/null || rc=$? 
if [ $rc -ne 0 ]; then 
  IPTABLES="/usr/sbin/iptables" 
fi 

${IPTABLES}-save > /opt/APPL/iptables.CMAgent.preinstall 
${IPTABLES} -I INPUT -m state --state NEW -p tcp --dport 26542 -j ACCEPT 

grep -i suse /etc/issue >/dev/null || rc=$? 
if [ $rc -ne 0 ]; then 
  /sbin/SuSEfirewall2 open EXT TCP 26542 
else 
  grep -i maipo /etc/redhat-release >/dev/null || rc=$? 
  if [ $rc -ne 0 ]; then 
    /sbin/firewall-cmd --zone=public --add-port=26542/tcp --permanent 
  else 
    /sbin/service iptables save 
  fi 
fi 

cd /opt; /opt/APPL/CMAgent.5.8.2.Linux 
cp /opt/CMAgent/csi.config.CMAgent /opt/CSIInstall/csi.config 
/opt/CSIInstall/InstallCMAgent -s 

```

脚本识别机器的操作系统，并基于此在本地防火墙上打开 `26542` 端口。然后，它复制预配置的 `csi.config` 文件，并最终从 `/opt/CSIInstall` 文件夹安装代理。

# 创建机器组

机器/虚拟对象组用于将管理的机器和虚拟对象组织成小的逻辑组。VCM 部署时会提供默认组（更多细节见*更多内容...*部分）。

## 准备就绪

作为管理员，你必须有一定的想法，了解哪些机器应该放在一起。你可以利用这个概念，根据需求创建机器组。

## 如何操作...

一旦你对要通过组实现的目标有了基本的了解，登录到 VCM 控制台，并按照接下来详细描述的步骤进行操作。

我们将创建一个机器组，包含所有属于`Study.local`活动目录组的机器，并且一旦有新机器从相同域添加到 VCM，它将自动添加这些机器。

1.  进入**管理** | **机器管理器** | **机器/虚拟对象组** | **所有机器**，然后点击**添加组**。![如何操作...](img/image_02_023.jpg)

1.  提供名称和适当的描述，然后点击**下一步**。

1.  设置**成员类型**为**动态**或**静态**。

1.  在我们的例子中，我们选择了**动态**，所以在下一页点击**完成**以完成向导。

1.  再次执行第 1 步，但这次，进入我们刚刚创建的机器组。点击该组，然后点击**过滤器**。在这里，我们将定义将机器添加到此组的标准。

1.  在**过滤器**下，点击**添加过滤器**。

1.  提供一个有意义的名称和描述，然后点击**下一步**。

1.  现在，我们从 vCenter、vCloud 和所有管理机器中收集的所有细节都可以在这里进行过滤。

1.  创建过滤器时，你的想象力是唯一的限制，你可以使用从 VCM 收集的所有信息。在我们的例子中，我们选择了机器作为数据类型；这就是你通过经验和期望共同作用来创建你想要的机器组的地方。![如何操作...](img/image_02_024.jpg)

1.  在**规则类型**下选择**基本**。

1.  现在，添加你的条件，比如**域名** = ``'STUDY'``。![如何操作...](img/image_02_025.jpg)

1.  点击**下一步**，然后点击**完成**关闭向导。

1.  现在，进入机器组，刷新后，你将看到所有属于`STUDY`域的机器。![如何操作...](img/image_02_026.jpg)

## 它是如何工作的...

当你使用管理机器时，可以创建静态组，其中成员由手动选择，或者动态组，其中过滤器动态决定成员资格。机器可以属于多个组。

你可以在主工具栏上设置活动机器组，并且可以在文本框右侧定义机器过滤器，正如这个截图所示。机器组过滤器进一步限制所选机器组。

![它是如何工作的...](img/image_02_027.jpg)

除了在**管理**滑块中的节点外，所有节点中的活动机器组都会将显示的数据限制为所选机器组中定义的管理机器。

## 还有更多...

这是安装 VCM 时创建的默认组列表：

| **名称** | **描述** |
| --- | --- |
| 所有机器 | VCM 中的所有已许可机器 |
| AD 自动创建 | Active Directory 自动创建的机器组 |
| 所有 Unix 机器 | 所有 Unix 机器 |
| 所有 VM 客户端机器 | 来自受管理 vCenter、vCloud 和 vShield 环境的所有受管理 VM 客户端 |
| 所有 VM 客户端 Unix 机器 | 所有 VM 客户端 Unix 机器 |
| 所有 VM 客户端 Windows 机器 | 所有 VM 客户端 Windows 机器 |
| 所有 VM 主机机器 | 所有 VM 主机机器 |
| 所有 Windows 机器 | 所有 Windows 机器 |

### 动态组

在动态组中，我们定义一个或多个过滤器，并根据这些过滤器来填充组。如果定义了多个过滤器，那么它们之间会进行逻辑 `AND` 操作。

你的想象力是唯一的限制，考虑到你在 VCM 中拥有的数据量，并且在创建组的过滤器时，这些数据都是可以使用的。

### 静态组

在静态组中，我们在创建组时定义成员，然后根据需要更新它们。与这些组没有关联任何过滤器。

最佳的使用案例是为所有 vCenter Server 实例创建一个静态组，因为我们不会每天添加成员，如果添加了成员，也可以手动添加。
