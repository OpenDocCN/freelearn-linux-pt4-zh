<html><head></head><body><div class="chapter" title="Chapter&#xA0;5.&#xA0; NSX Edge Services"><div class="titlepage"><div><div><h1 class="title"><a id="ch05"/>Chapter 5.  NSX Edge Services </h1></div></div></div><p>NSX Edge is a feature rich gateway Virtual Machines which offers L3-L7 services. Edge Gateway is the glue that connects all logical networks provide DHCP, NAT, Routing, VPN, Firewalling, Load Balancing and HA functionality. Ideally these devices will be configured at the perimeter level of vSphere Datacenter.</p><p>In this chapter, we will cover the following topics:</p><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc">Introducing Edge services</li><li class="listitem" style="list-style-type: disc">Introducing Edge service form factors</li><li class="listitem" style="list-style-type: disc">Introducing OSPF, BGP, and ISIS protocols</li><li class="listitem" style="list-style-type: disc">Routing between DLR and NSX Edge router</li><li class="listitem" style="list-style-type: disc">NSX Edge service use cases</li></ul></div><div class="section" title="Introducing Edge services"><div class="titlepage"><div><div><h1 class="title"><a id="ch05lvl1sec33"/>Introducing Edge services</h1></div></div></div><p>NSX Edge gateway is a virtual machine that provides services such as Network Address Translation, Dynamic Host Configuration Protocol, DNS relay, Virtual Private Network, load balancing, and routing functionality. Firstly, there is no rule of thumb that says we should leverage all these features using one single Edge. For true multi-tenancy, we can deploy multiple Edges for different features' use cases. Let's have a look at Edge gateway form factor before we start with routing and other topics.</p></div></div>
<div class="section" title="Introducing Edge form factor"><div class="titlepage"><div><div><h1 class="title"><a id="ch05lvl1sec34"/>Introducing Edge form factor</h1></div></div></div><p>There have been countless times when we would have deployed a virtual machine, assuming some specific value is enough for compute and storage. Later, when we start facing performance issues, we are forced to go back and recheck the application requirements. As far as the impact is concerned, it would be specific to one VM, so going back and forth and making changes is just about feasible. Well, this doesn't work with NSX Edge, primarily because it would be a perimeter device and the impact would be much higher. For the same reason, selecting the right form factor is critical in order to get the best performance. The following screenshot depicts the default compute capacity, which each Edge form factor offers:</p><p>
</p><div class="mediaobject"><img src="graphics/image_05_001.jpg" alt="Introducing Edge form factor"/></div><p>
</p><p>The positive aspect to note is that we can always go back and change these form factors. For example, during initial deployment time, we have deployed NSX Edge in <span class="strong"><strong>large form factor</strong></span>. Later, we can go ahead and change the form factor from <span class="strong"><strong>large to any higher version</strong></span>. However, the negative side is that there will be an NSX Edge service outage during that time. Hence, the recommended deployment option would be selecting the right form factor Edge. For services such as, load balancers, wherein we have a lot of SSL termination and offload tasks, which would consume a lot of vCPU cycles, the preferred form factor would be Edge <span class="strong"><strong>X-Large</strong></span>. With that said, we will start with one of the most exciting topics in the NSX world. Routing simplicity and feature-rich integration makes NSX an ideal platform for all vSphere architects.</p></div>
<div class="section" title="Introducing OSP, BGP, and ISIS"><div class="titlepage"><div><div><h1 class="title"><a id="ch05lvl1sec35"/>Introducing OSP, BGP, and ISIS</h1></div></div></div><p>As we know, distributed routing capability in the VMware NSX provides an optimized and scalable way of handling East-West traffic in a data center. The NSX Edge services router provides the traditional centralized routing. What more could we need in an enterprise environment? Both these components, <span class="strong"><strong>Distributed Logical Router</strong></span> (<span class="strong"><strong>DLR</strong></span>) and Edge, give a cutting-edge solution in an enterprise's routing architecture. Before we start with how routing works between these solutions, let me give some quick background on routing protocols that are supported in an NSX environment, and together, we will explore an OSPF routing protocol configuration between DLR and NSX Edge. Sounds interesting? Let's get started.</p><div class="section" title="Exploring Open Shortest Path First"><div class="titlepage"><div><div><h2 class="title"><a id="ch05lvl2sec29"/>Exploring Open Shortest Path First</h2></div></div></div><p>From my experience, while teaching and doing labs, people often find it really difficult to understand the <span class="strong"><strong>Open Shortest Path First</strong></span> (<span class="strong"><strong>OSPF</strong></span>) protocol. So, let's split this abbreviation into its component parts:</p><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc"><span class="strong"><strong>Open</strong></span>: Yes, this is an open standard protocol developed by a wide range of network vendors. This means that it is publicly available on any dynamic routing protocol-supported routers. Again, we are not limited to running OSPF on CISCO or Juniper, or any other vendor routers in an OSPF routing environment. This is certainly configurable in multivendor deployment scenarios.</li><li class="listitem" style="list-style-type: disc"><span class="strong"><strong>Shortest Path First</strong></span>: <span class="strong"><strong>Shortest Path First</strong></span> (<span class="strong"><strong>SPF</strong></span>) uses a Dijkstra algorithm to find the single shortest path to reach a destination network.</li></ul></div><p>So, in a nutshell, we have an open standard routing protocol that calculates the shortest path to reach a destination. For now, we will pause for some time and understand routing classes, and we will come back to the topic of OSPF. There are three classes of routing protocols, as follows:</p><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc"><span class="strong"><strong>Distance vector</strong></span>: A distance vector protocol finds the best path to a remote network by judging distance. RIP is a distance vector routing protocol. In RIP routing, to reach the destination network, the router will choose the path that has the least number of hops. The term vector means the direction to the destination network.</li><li class="listitem" style="list-style-type: disc"><span class="strong"><strong>Link state</strong></span>: Link state protocols are also called Shortest Path First protocols. In a link state protocol environment, routers create three separate tables:<div class="itemizedlist"><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc">Directly-attached neighbors</li><li class="listitem" style="list-style-type: disc">Topology of the entire network</li><li class="listitem" style="list-style-type: disc">Routing table</li><li class="listitem" style="list-style-type: disc">Behind the scenes, link state protocols send updates containing the state of their own links to all other directly connected routers on the network.</li></ul></div><p>
</p></li><li class="listitem" style="list-style-type: disc"><span class="strong"><strong>Hybrid</strong></span>: A hybrid protocol is a mix of distance vector and link state protocols, and <span class="strong"><strong>Enhanced Interior Gateway Routing Protocol</strong></span> (<span class="strong"><strong>EIGRP</strong></span>) is a great example.</li></ul></div><div class="section" title="Understanding basic OSPF terminology"><div class="titlepage"><div><div><h3 class="title"><a id="ch05lvl3sec15"/>Understanding basic OSPF terminology</h3></div></div></div><p>To understand the fundamentals of OSPF, let's clarify some basic OSPF terminology:</p><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc"><span class="strong"><strong>Link</strong></span>: A link is a network, or OSPF router interface, assigned to any given network. Yes, it is important to understand if we have multiple interfaces in an up-and-running state; OSPF wont treat them as link. Only when an interface is added to the OSPF process is it considered to be a link.</li><li class="listitem" style="list-style-type: disc"><span class="strong"><strong>Router ID</strong></span>: The <span class="strong"><strong>router ID</strong></span> (<span class="strong"><strong>RID</strong></span>) is an IP address used to identify the OSPF router.</li><li class="listitem" style="list-style-type: disc"><span class="strong"><strong>Neighbor</strong></span>: Neighbors are two or more OSPF routers that have an interface on a common network:<div class="itemizedlist"><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc">Area ID</li><li class="listitem" style="list-style-type: disc">Stub area flag</li><li class="listitem" style="list-style-type: disc">Authentication password</li><li class="listitem" style="list-style-type: disc">Hello and dead intervals</li></ul></div><p>
</p><div class="note" title="Note" style=""><div class="inner"><h3 class="title"><a id="note11"/>Note</h3><p>All the preceding parameters should be matching to form a neighbor ship.</p></div></div></li><li class="listitem" style="list-style-type: disc"><span class="strong"><strong>Adjacency</strong></span>: Adjacency is a relationship between two OSPF routers that permits the direct exchange of route updates. This totally depends upon both the type of network and the configuration of the routers:<div class="itemizedlist"><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc"><span class="strong"><strong>Designated Router</strong></span>: A <span class="strong"><strong>Designated Router</strong></span> (<span class="strong"><strong>DR</strong></span>) is elected whenever OSPF routers are connected to the same broadcast network to minimize the number of adjacencies formed. Selection can be either manual or automated, based on priority value as the first pararmeter. All routers on the same network will establish adjacencies with the DR and the BDR, which ensures that all router's topology tables are synchronized.</li><li class="listitem" style="list-style-type: disc"><span class="strong"><strong>Backup Designated Router</strong></span>: A <span class="strong"><strong>Backup Designated Router</strong></span> (<span class="strong"><strong>BDR</strong></span>) is a backup for the DR router.</li><li class="listitem" style="list-style-type: disc"><span class="strong"><strong>Hello protocol</strong></span>: The OSPF Hello protocol provides dynamic neighbor discovery and maintains neighbor relationships. Hello packets are addressed to multicast address <code class="literal">224.0.0.5</code>. Hello packets and <span class="strong"><strong>Link State Advertisements</strong></span> (<span class="strong"><strong>LSAs</strong></span>) build the topological database.</li><li class="listitem" style="list-style-type: disc"><span class="strong"><strong>Neighborship database</strong></span>: A neighborship database is a list of all OSPF routers for which Hello packets are visible. Lets discuss about how OSPF database is getting updated.</li></ul></div></li></ul></div></div><div class="section" title="Updating a topology database"><div class="titlepage"><div><div><h3 class="title"><a id="ch05lvl3sec16"/>Updating a topology database</h3></div></div></div><p>We are aware that the OSPF router teaches <span class="strong"><strong>directly attached neighbors</strong></span>, <span class="strong"><strong>topology of the entire internetwork</strong></span>, and finally, a <span class="strong"><strong>routing table</strong></span>. Let's discuss how a topology database is updated in an OSPF router:</p><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc"><span class="strong"><strong>Link state advertisement</strong></span>: I would simply call it an OSPF language; the way OSPF routers communicate. LSA is an OSPF data packet containing link state and routing information that's shared among OSPF routers.</li><li class="listitem" style="list-style-type: disc"><span class="strong"><strong>Areas</strong></span>: An OSPF area is a grouping of contiguous networks and routers. All routers in the same area share a common area ID. The following figure depicts a simple OSPF topology:</li></ul></div><p>
</p><div class="mediaobject"><img src="graphics/image_05_002.jpg" alt="Updating a topology database"/></div><p>
</p><p>There is a total of eight important LSA types in OSPF:</p><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc"><span class="strong"><strong>LSA Type 1: Router LSA</strong></span>: Each router within the area will flood a type 1 router LSA within the area.</li><li class="listitem" style="list-style-type: disc"><span class="strong"><strong>LSA Type 2: Network LSA</strong></span>: The network LSA or type 2 is created for each multi-access network. Network LSAs are generated by the designated router.</li><li class="listitem" style="list-style-type: disc"><span class="strong"><strong>LSA Type 3: Summary LSA</strong></span>: <span class="strong"><strong>Area Border Router</strong></span> (<span class="strong"><strong>ABR</strong></span>) will create a LSA 3 summary and will pass the LSA information to other areas.</li><li class="listitem" style="list-style-type: disc"><span class="strong"><strong>LSA Type 4: Summary ASBR LSA</strong></span>: Routers need to know where to find the ASBR. In such cases, ABR will generate a summary.</li><li class="listitem" style="list-style-type: disc"><span class="strong"><strong>LSA Type 5: Autonomous system external LSA</strong></span>: A type 5 LSA will be sent by a border router to let other routers know how to reach the border router through the internal network.</li><li class="listitem" style="list-style-type: disc"><span class="strong"><strong>LSA Type 7: Not-so-stubby area LSA</strong></span>: This doesn't allow external LSAs (type 5). All it will do is generate type 7 LSAs instead</li></ul></div><p>How about type 6 and type 8? Well, type 6 is no longer supported in OSPF v2 and, type 8 LSA is a link-local only LSA for OSPF v3. A type 8 LSA is used to give information about link-local addresses and a list of IPv6 addresses on the link. In this module, we have a practical use case discussion on OSPF in the NSX world by establishing a dynamic routing between NSX Edge and DLR.</p><p>For now, let's move on and discuss ISIS protocol.</p></div></div><div class="section" title="Exploring Intermediate System to Intermediate System"><div class="titlepage"><div><div><h2 class="title"><a id="ch05lvl2sec30"/>Exploring Intermediate System to Intermediate System</h2></div></div></div><p>An Intermediate System routing protocol is a link state protocol similar to OSPF. It is also called an ISP scale protocol, primarily because of its ability to support more areas than OSPF. An intermediate system is a <span class="strong"><strong>router</strong></span>, and <span class="strong"><strong>Intermediate System to Intermediate System</strong></span> (<span class="strong"><strong>IS-IS</strong></span>) is the routing protocol that routes packets between intermediate systems. IS-IS routers are of three types: Level 1 (intra area), Level 2 (inter area), or Level 1-2 (both). Routing information is exchanged between Level 1 routers and other Level 1 routers of the same area, and Level 2 routers can only form relationships and exchange information with other Level 2 routers. Level 1-2 routers exchange information with both levels and are used to connect the inter area routers with the intra area routers, as shown in the following screenshot:</p><p>
</p><div class="mediaobject"><img src="graphics/image_05_003.jpg" alt="Exploring Intermediate System to Intermediate System"/></div><p>
</p><p>After having a brief glimpse at the ISIS protocol, let us now understand the <span class="strong"><strong>Border Gateway Protocol</strong></span> (<span class="strong"><strong>BGP</strong></span>).</p><div class="section" title="Exploring Border Gateway Protocol"><div class="titlepage"><div><div><h3 class="title"><a id="ch05lvl3sec17"/>Exploring Border Gateway Protocol</h3></div></div></div><p>First and foremost, this is an exterior gateway protocol. BGP is primarily used by <span class="strong"><strong>Internet Service Providers</strong></span> (<span class="strong"><strong>ISP</strong></span>) and large enterprise companies when they have connections with multiple ISPs. All it does is bind smaller, autonomous (internetworks) to ensure efficient routing is possible regardless of the location. BGP is basically a group of autonomous systems. This raises another question: what are autonomous systems? <span class="strong"><strong>Autonomous Systems</strong></span> (<span class="strong"><strong>AS</strong></span>) are groups of networks under a common administration. Just like private and public IP concepts, AS also have private and public numbers. Public AS numbers range from 1 to 64511, and private AS numbers range from 64512 to 65535. When we do a routing within an AS it is called iBGP routing, and eGBP is routing between two different autonomous systems. The process for forming a BGP peering is very simple. A TCP session needs to established, with the BGP source port being an emphemeral port, and the destination being TCP port 179. The following figure depicts a iBGP and eBGP topology:</p><p>
</p><div class="mediaobject"><img src="graphics/image_05_004.jpg" alt="Exploring Border Gateway Protocol"/></div><p>
</p><p>I have limited the explanation of BGP, ISIS, and OSPF, primarily because it would demand writing a different book to cover all aspects of routing protocol. Enough said-let's finish of our network topology by configuring OSPF routing. Before we start with routing between the Distributed Logical Router and the NSX Edge gateway, let's go back to the lab topology that we used in 
<a class="link" href="ch04.html" title="Chapter 4. NSX Virtual Networks and Logical Router">Chapter 4</a>, 
<span class="emphasis"><em>NSX Virtual Network and Logical Router</em></span>, and understand where we are and what the next requirement is. From the following figure, it is clear that we have established a routing between web, app, and DB networks. It's time to ask a few questions. We need all these networks to communicate with another network (192.168.100.0/24) through a transit network. How do we do that? Can we connect the transit network to NSX Edge and leverage dynamic routing capability so that an app, web, and DB can communicate with external networks?</p><p>The following figure depicts a three-tier application leveraging DLR functionality:</p><p>
</p><div class="mediaobject"><img src="graphics/image_05_005.jpg" alt="Exploring Border Gateway Protocol"/></div><p>
</p></div></div></div>
<div class="section" title="Deploying an NSX Edge gateway"><div class="titlepage"><div><div><h1 class="title"><a id="ch05lvl1sec36"/>Deploying an NSX Edge gateway</h1></div></div></div><p>An NSX Edge gateway is a perimeter device and for the same reason, all ingress and egress traffic from a network virtualized data center has to go through Edge devices and finally hit the upstream router. In our case three tier application is in need of communicating with an external network-192.168.100.0/24 which demands an Edge gateway to deployed. Let's deploy an NSX Edge gateway and connect with Distributed Logical Router. In a nutshell, all we are doing is connecting two routers together and creating a dynamic routing environment for them to exchange the networks, so that eventually, our three-tier application can communicate with network 192.168.100.0/24.</p><p>The steps are as follows:</p><div class="orderedlist"><ol class="orderedlist arabic"><li class="listitem">On the vSphere web client home tab, click <span class="strong"><strong>Inventories</strong></span> | <span class="strong"><strong>Networking &amp; Security</strong></span>.</li><li class="listitem">In the left-hand navigation pane, select <span class="strong"><strong>NSX Edges</strong></span>.</li><li class="listitem">In the middle pane, click the green plus sign to open the <span class="strong"><strong>New NSX Edge</strong></span> dialog box.</li><li class="listitem">On the <span class="strong"><strong>Name and description</strong></span> page, leave <span class="strong"><strong>Edge Services Gateway</strong></span> selected.</li><li class="listitem">Enter <code class="literal">Perimeter Gateway</code> in the <span class="strong"><strong>Name</strong></span> text box and click <span class="strong"><strong>Next</strong></span>.<p>The following screenshot shows NSX Edge:</p><p>
</p><div class="mediaobject"><img src="graphics/image_05_006.jpg" alt="Deploying an NSX Edge gateway"/></div><p>
</p></li><li class="listitem">On the CLI credentials page, enter the password in the <span class="strong"><strong>Password</strong></span> text box.</li><li class="listitem">Enter the password correctly because a verification box is not provided:<p>
</p><div class="mediaobject"><img src="graphics/image_05_007.jpg" alt="Deploying an NSX Edge gateway"/></div><p>
</p></li><li class="listitem">On the <span class="strong"><strong>Configure deployment</strong></span> page, verify that the <span class="strong"><strong>Datacenter</strong></span> selection is our Edge Cluster that we created during the initial vSphere Cluster design phase.</li><li class="listitem">Verify that the <span class="strong"><strong>Appliance Size</strong></span> selection is <span class="strong"><strong>Compact</strong></span>.</li><li class="listitem">Verify that the <span class="strong"><strong>Enable auto rule generation</strong></span> checkbox is selected.<div class="note" title="Note" style=""><div class="inner"><h3 class="title"><a id="note12"/>Note</h3><p>NSX Edge adds firewall, NAT, and routing routes, to enable control traffic to flow for these services. If this option is disabled, we need to manually create firewall rules, which is tedious work.</p></div></div></li><li class="listitem">Under <span class="strong"><strong>NSX Edge Appliances</strong></span>, click the green plus sign, as highlighted in the following screenshot, to open the <span class="strong"><strong>Add NSX Edge Appliance</strong></span> dialog box, and perform the following actions:<div class="orderedlist"><ol class="orderedlist arabic"><li class="listitem">Select <span class="strong"><strong>Management and Edge Cluster</strong></span> from the <span class="strong"><strong>Cluster/Resource Pool</strong></span> drop-down menu.</li><li class="listitem">Select <span class="strong"><strong>shared datastore</strong></span> from the <span class="strong"><strong>Datastore</strong></span> drop-down menu.</li><li class="listitem">Leave all other fields at the default value and click <span class="strong"><strong>OK</strong></span>.</li><li class="listitem">Click <span class="strong"><strong>Next, </strong></span>as shown in the following sreenshot:</li></ol></div><p>
</p><div class="mediaobject"><img src="graphics/image_05_008.jpg" alt="Deploying an NSX Edge gateway"/></div><p>
</p></li><li class="listitem">On the <span class="strong"><strong>Configure interfaces</strong></span> page, click the green plus sign to open the <span class="strong"><strong>Add NSX Edge Interface</strong></span> dialog box and perform the following actions to configure the first of two interfaces:<div class="orderedlist"><ol class="orderedlist arabic"><li class="listitem">Enter <code class="literal">Uplink-Interface</code> in the <span class="strong"><strong>Name</strong></span> text box.</li><li class="listitem">For <span class="strong"><strong>Type</strong></span>, leave <span class="strong"><strong>UpLink</strong></span> selected.</li><li class="listitem">Click the <span class="strong"><strong>Connected To</strong></span> | <span class="strong"><strong>Select</strong></span> link.</li><li class="listitem">Click <span class="strong"><strong>Distributed Portgroup</strong></span>.</li><li class="listitem">Click the <span class="strong"><strong>Mgmt-Edge-VDS-HQ Uplink</strong></span> button and click <span class="strong"><strong>OK</strong></span>.</li><li class="listitem">Click the green plus sign under <span class="strong"><strong>Configure Subnets</strong></span>.</li><li class="listitem">In the <span class="strong"><strong>Add Subnet</strong></span> dialog box, click the green plus sign to add an IP address field.</li><li class="listitem">Enter <code class="literal">192.168.100.3</code> in the <span class="strong"><strong>IP Address</strong></span> text box and click <span class="strong"><strong>OK</strong></span> to confirm the entry.</li><li class="listitem">Enter <span class="strong"><strong>24</strong></span> in the <span class="strong"><strong>Subnet prefix length</strong></span> text box.</li><li class="listitem">Click <span class="strong"><strong>OK</strong></span> to close the <span class="strong"><strong>Add Subnet</strong></span> dialog box.</li><li class="listitem">Leave all other settings at default value and click <span class="strong"><strong>OK</strong></span>.</li></ol></div><p>
</p></li><li class="listitem">Click the green plus sign to open the <span class="strong"><strong>Add NSX Edge Interface</strong></span> dialog box, and perform the following actions to configure the second interface:<div class="orderedlist"><ol class="orderedlist arabic"><li class="listitem">Enter <code class="literal">Transit-Interface</code> in the <span class="strong"><strong>Name</strong></span> text box.</li><li class="listitem">For <span class="strong"><strong>Type</strong></span>, click <span class="strong"><strong>Internal</strong></span>.</li><li class="listitem">Click the <span class="strong"><strong>Connected To</strong></span> | <span class="strong"><strong>Select</strong></span> link.</li><li class="listitem">Click the <span class="strong"><strong>Transit-Network</strong></span> button and click <span class="strong"><strong>OK</strong></span></li></ol></div><p>
</p><p>The following screenshot shows the NSX Edge Interface selection:</p><p>
</p><div class="mediaobject"><img src="graphics/image_05_009.jpg" alt="Deploying an NSX Edge gateway"/></div><p>
</p></li><li class="listitem">Click <span class="strong"><strong>Next</strong></span>.</li><li class="listitem">On the <span class="strong"><strong>Default gateway settings</strong></span> page, select the <span class="strong"><strong>Configure Default Gateway</strong></span> check box.</li><li class="listitem">Verify that the <span class="strong"><strong>vNIC</strong></span> selection is <span class="strong"><strong>Uplink-Interface</strong></span>.</li><li class="listitem">Enter <code class="literal">192.168.100.2</code> in the <span class="strong"><strong>Gateway IP</strong></span> text box.</li><li class="listitem">This value is the IP address of a router that is available on the HQ uplink port group.</li><li class="listitem">Leave all the other settings at the default value and click <span class="strong"><strong>Next</strong></span>, as shown in the following screenshot:<p>
</p><div class="mediaobject"><img src="graphics/image_05_010.jpg" alt="Deploying an NSX Edge gateway"/></div><p>
</p></li><li class="listitem">On the <span class="strong"><strong>Firewall and HA</strong></span> page, select the <span class="strong"><strong>Configure Firewall default policy</strong></span> check box.</li><li class="listitem">For the <span class="strong"><strong>Default Traffic Policy</strong></span>, click <span class="strong"><strong>Accept</strong></span>.<div class="note" title="Note" style=""><div class="inner"><h3 class="title"><a id="note13"/>Note</h3><p>This is a very important step, as you can see that, by default, all traffic is blocked.</p></div></div><p>
<span class="strong"><strong>Configure HA parameters</strong></span>. High Availability (HA) ensures that an NSX Edge appliance is always available by installing an active pair of Edges on your virtualized infrastructure, which will be discussed further during Edge HA modules. Hence, for the time being, we are leaving the rest of the settings as they are. The following screenshot depicts Edge firewall and HA settings:</p><p>
</p><div class="mediaobject"><img src="graphics/image_05_011.jpg" alt="Deploying an NSX Edge gateway"/></div><p>
</p></li><li class="listitem">On the <span class="strong"><strong>Ready to complete page</strong></span>, review the configuration report and click <span class="strong"><strong>Finish</strong></span>.</li></ol></div><p>So, we have deployed <span class="strong"><strong>Distributed Logical Router</strong></span> and, later, the <span class="strong"><strong>NSX Edge gateway</strong></span>. Once again, the prime aim here is to have our web, app, and DB servers communicating with network 192.168.100.0/24, and we know for sure these networks are not a directly-connected network. Before moving forward with routing, let's have a quick look at the following figure to see our current topology.</p><p>The following figure depicts a three-tier application connected to DLR, and a DLR to Edge connection:</p><p>
</p><div class="mediaobject"><img src="graphics/image_05_012.jpg" alt="Deploying an NSX Edge gateway"/></div><p>
</p><p>Now that we have completed the NSX Edge deployment, we will go ahead with configuring OSPF on NSX Edge.</p></div>
<div class="section" title="Configuring OSPF on NSX Edge"><div class="titlepage"><div><div><h1 class="title"><a id="ch05lvl1sec37"/>Configuring OSPF on NSX Edge</h1></div></div></div><p>Configuring OSPF routing on NSX Edge (Perimeter Edge) allows logical networks to be learned by the logical router and distributed through a transit network. The steps are as follows:</p><div class="orderedlist"><ol class="orderedlist arabic"><li class="listitem">In the routing categories list, select <span class="strong"><strong>Global Configuration</strong></span>.</li><li class="listitem">In the <span class="strong"><strong>Dynamic Routing Configuration</strong></span> panel, click <span class="strong"><strong>Edit</strong></span> to open <span class="strong"><strong>Edit Dynamic Routing</strong></span>, as shown in the following screenshot:<p>
</p><div class="mediaobject"><img src="graphics/image_05_013.jpg" alt="Configuring OSPF on NSX Edge"/></div><p>
</p></li><li class="listitem">In the <span class="strong"><strong>Dynamic Routing Configuration</strong></span> dialog box, perform the following actions:<div class="itemizedlist"><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc">Select <span class="strong"><strong>Uplink - <span class="strong"><strong>192.168.100.3</strong></span>
</strong></span> from the <span class="strong"><strong>Router ID</strong></span> drop-down menu.</li><li class="listitem" style="list-style-type: disc">Check the <span class="strong"><strong>Enable OSPF</strong></span> checkbox.</li><li class="listitem" style="list-style-type: disc">Leave all other fields at the default value and click <span class="strong"><strong>Save</strong></span>, as shown in the following screenshot:</li></ul></div><p>
</p><p>
</p><div class="mediaobject"><img src="graphics/image_05_014.jpg" alt="Configuring OSPF on NSX Edge"/></div><p>
</p></li><li class="listitem">At the top of the <span class="strong"><strong>Global Configuration</strong></span> page, click <span class="strong"><strong>Publish Changes</strong></span>.</li><li class="listitem">In the routing category panel, select <span class="strong"><strong>OSPF</strong></span>.</li><li class="listitem">In the area definitions list, verify that an area with the following properties appears in the list, as shown in the following screenshot:<div class="itemizedlist"><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc"><span class="strong"><strong>Area ID</strong></span>: <span class="strong"><strong>0</strong></span></li><li class="listitem" style="list-style-type: disc"><span class="strong"><strong>Type</strong></span>: <span class="strong"><strong>Normal</strong></span></li><li class="listitem" style="list-style-type: disc"><span class="strong"><strong>Authentication</strong></span>: <span class="strong"><strong>None</strong></span></li></ul></div><p>
</p><p>
</p><div class="mediaobject"><img src="graphics/image_05_015.jpg" alt="Configuring OSPF on NSX Edge"/></div><p>
</p><div class="note" title="Note" style=""><div class="inner"><h3 class="title"><a id="note14"/>Note</h3><p>Area 0 is the default area in OSPF and all other areas will be connected to Area 0.</p></div></div></li><li class="listitem">Above the area definitions list, click the green plus sign to open the <span class="strong"><strong>New Area Definition</strong></span> dialog box, and perform the following actions:<div class="itemizedlist"><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc">Enter <span class="strong"><strong>10</strong></span> in the <span class="strong"><strong>Area ID</strong></span> text box.</li><li class="listitem" style="list-style-type: disc">Leave all other settings at the default value and click <span class="strong"><strong>OK</strong></span>.</li></ul></div><p>
</p></li><li class="listitem">Under <span class="strong"><strong>Area Interface Mapping</strong></span>, at the bottom of the <span class="strong"><strong>OSPF</strong></span> page, click the green plus sign to open the <span class="strong"><strong>New Area to Interface Mapping</strong></span> dialog box, and perform the following actions:<div class="itemizedlist"><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc">Verify that the<span class="strong"><strong> vNIC </strong></span>selection is <span class="strong"><strong>Uplink-Interface</strong></span>.</li><li class="listitem" style="list-style-type: disc">Select <span class="strong"><strong>0</strong></span> from the <span class="strong"><strong>Area</strong></span> drop-down menu.</li><li class="listitem" style="list-style-type: disc">Leave all other fields at the default value and click <span class="strong"><strong>OK</strong></span>.</li></ul></div><p>
</p></li><li class="listitem">Under <span class="strong"><strong>Area Interface Mapping</strong></span>, at the bottom of the <span class="strong"><strong>OSPF</strong></span> page, click the green plus sign to open the <span class="strong"><strong>New Area to Interface Mapping</strong></span> dialog box, and perform the following actions, as shown in the following screenshot:<div class="itemizedlist"><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc">Select <span class="strong"><strong>Transit</strong></span>-Interface from the drop-down menu.</li><li class="listitem" style="list-style-type: disc">Select <span class="strong"><strong>10</strong></span> from the <span class="strong"><strong>Area</strong></span> drop-down menu.</li><li class="listitem" style="list-style-type: disc">Leave all other fields at the default value and click <span class="strong"><strong>OK</strong></span>:</li></ul></div><p>
</p><p>
</p><div class="mediaobject"><img src="graphics/image_05_016.jpg" alt="Configuring OSPF on NSX Edge"/></div><p>
</p></li><li class="listitem">At the top of the OSPF page, click <span class="strong"><strong>Publish Changes</strong></span>.<div class="note" title="Note" style=""><div class="inner"><h3 class="title"><a id="note15"/>Note</h3><p>We can configure the type of subnets that are advertised by Perimeter Gateway through OSPF.</p></div></div></li><li class="listitem">In the <span class="strong"><strong>Routing</strong></span> category panel, select <span class="strong"><strong>Route Redistribution Status</strong></span>.</li><li class="listitem">Under <span class="strong"><strong>Route Redistribution table</strong></span>, at the bottom of the page, click the green plus sign to open the N<span class="strong"><strong>ew Redistribution criteria</strong></span> dialog box, and perform the following actions:<div class="itemizedlist"><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc">Under <span class="strong"><strong>Allow learning from</strong></span>, select the <span class="strong"><strong>Connected</strong></span> checkbox.</li><li class="listitem" style="list-style-type: disc">Subnets connected to Perimeter Gateway can now be learned.</li><li class="listitem" style="list-style-type: disc">Leave all other settings at the default value and click <span class="strong"><strong>OK</strong></span>, as shown in the following screenshot:</li></ul></div><p>
</p><p>
</p><div class="mediaobject"><img src="graphics/image_05_017.jpg" alt="Configuring OSPF on NSX Edge"/></div><p>
</p></li><li class="listitem">In the <span class="strong"><strong>Route Redistribution Status</strong></span> panel, at the top of the page, determine if a green check mark appears next to OSPF. For now, it is not, as shown in the following screenshot:<p>
</p><div class="mediaobject"><img src="graphics/image_05_018.jpg" alt="Configuring OSPF on NSX Edge"/></div><p>
</p></li><li class="listitem">If a green check mark does not appear, perform the following actions:<div class="itemizedlist"><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc">On the right-hand side of the <span class="strong"><strong>Route Redistribution Status</strong></span> panel, click <span class="strong"><strong>Change</strong></span>.</li><li class="listitem" style="list-style-type: disc">In the <span class="strong"><strong>Change redistribution settings</strong></span> dialog box, select the <span class="strong"><strong>OSPF</strong></span> checkbox, as shown in the following screenshot:</li><li class="listitem" style="list-style-type: disc">Click <span class="strong"><strong>Save</strong></span>.</li><li class="listitem" style="list-style-type: disc">In the <span class="strong"><strong>Route Redistribution Status</strong></span> panel, at the top of the page, verify that a green check mark appears next to <span class="strong"><strong>OSPF</strong></span>:</li></ul></div><p>
</p><p>
</p><div class="mediaobject"><img src="graphics/image_05_019.jpg" alt="Configuring OSPF on NSX Edge"/></div><p>
</p></li><li class="listitem">At the top of the page, click <span class="strong"><strong>Publish Changes</strong></span>:<p>
</p><div class="mediaobject"><img src="graphics/image_05_020.jpg" alt="Configuring OSPF on NSX Edge"/></div><p>
</p></li></ol></div><p>With the preceding steps, we have successfully configured OSPF on Perimeter Edge. All we have done so far is select a <span class="strong"><strong>Router-ID</strong></span> for Perimeter Gateway and enable OSPF. Later, we created Area-10 and performed an Area-to-interface mapping, and finished by enabling <span class="strong"><strong>Route Redistribution</strong></span>. It's time to recollect the firewall policy that we selected during NSX Edge deployment; we have allowed the traffic and also selected the <span class="strong"><strong>Enable auto rule generation</strong></span> checkbox. In this example, we have configured OSPF on NSX Edge and we would expect OSPF auto rules to be configured in the firewall table. Let's verify that by switching to the <span class="strong"><strong>Perimeter Gateway</strong></span> | <span class="strong"><strong>Manage</strong></span> | <span class="strong"><strong>Firewall</strong></span> tab, as shown in the following screenshot:</p><p>
</p><div class="mediaobject"><img src="graphics/image_05_021.jpg" alt="Configuring OSPF on NSX Edge"/></div><p>
</p><p>As we can see, there are three firewall rules auto-configured: two <span class="strong"><strong>Internal</strong></span> rules and one <span class="strong"><strong>Default</strong></span> rule. Now that we have an OSPF process running on the NSX Edge and firewall rules are auto-configured, let's move forward and configure OSPF on Distributed Logical Router.</p></div>
<div class="section" title="Configuring OSPF routing on Distributed Logical Router"><div class="titlepage"><div><div><h1 class="title"><a id="ch05lvl1sec38"/>Configuring OSPF routing on Distributed Logical Router</h1></div></div></div><p>Let me re-emphasize the Distributed Logical Router use case. The whole purpose of DLR is to do an intelligent East-West routing, which allows virtual machine to virtual machine communication without going through traditional data center hop-by-hop routing. Let's go ahead and configure OSPF on DLR:</p><div class="orderedlist"><ol class="orderedlist arabic"><li class="listitem">In the <span class="strong"><strong>Routing</strong></span> category panel, select <span class="strong"><strong>Global Configuration</strong></span>.</li><li class="listitem">On the right-hand side of the <span class="strong"><strong>Dynamic Routing Configuration</strong></span> panel, click <span class="strong"><strong>Edit.</strong></span></li><li class="listitem">In the <span class="strong"><strong>Edit Dynamic Routing Configuration</strong></span> dialog box, select Interface as <span class="strong"><strong>Transit and 192.168.10.2</strong></span> from the <span class="strong"><strong>Router ID</strong></span> drop-down menu, as shown in the following screenshot:<p>
</p><div class="mediaobject"><img src="graphics/image_05_022.jpg" alt="Configuring OSPF routing on Distributed Logical Router"/></div><p>
</p></li><li class="listitem">This setting must be specified before OSPF can be configured.</li><li class="listitem">Leave all other fields at the default value and click <span class="strong"><strong>Save</strong></span>.</li><li class="listitem">At the top of the <span class="strong"><strong>Global Configuration</strong></span> page, click <span class="strong"><strong>Publish Changes</strong></span>.</li><li class="listitem">In the <span class="strong"><strong>Routing</strong></span> category panel, select <span class="strong"><strong>OSPF</strong></span>.</li><li class="listitem">On the right-hand side of the <span class="strong"><strong>OSPF Configuration</strong></span> panel, click <span class="strong"><strong>Edit</strong></span> to open the <span class="strong"><strong>OSPF Configuration</strong></span> dialog box, and perform the following actions:<div class="orderedlist"><ol class="orderedlist arabic"><li class="listitem">Select the <span class="strong"><strong>Enable OSPF</strong></span> checkbox.</li><li class="listitem">Enter <code class="literal">192.168.10.3</code> in the <span class="strong"><strong>Protocol Address</strong></span> text box.</li><li class="listitem">Enter <code class="literal">192.168.10.2</code> in the <span class="strong"><strong>Forwarding Address</strong></span> text box.<div class="note" title="Note" style=""><div class="inner"><h3 class="title"><a id="note16"/>Note</h3><p>
<span class="strong"><strong>Protocol Address</strong></span>: Establishing routing protocol sessions with other routers. In our example, this address would be used for establishing a routing protocol session with the NSX Edge Perimeter Gateway.
<span class="strong"><strong>Forwarding Address</strong></span>: IP address that is to be used by the router data path module in the hosts to forward data path packets.</p></div></div></li></ol></div></li><li class="listitem">Click <span class="strong"><strong>OK</strong></span>:<p>
</p><div class="mediaobject"><img src="graphics/image_05_023.jpg" alt="Configuring OSPF routing on Distributed Logical Router"/></div><p>
</p></li><li class="listitem">In the <span class="strong"><strong>Area Definitions</strong></span> panel, click the green plus sign to open the <span class="strong"><strong>New Area Definition</strong></span> dialog box.</li><li class="listitem">Enter <span class="strong"><strong>10</strong></span> in the <span class="strong"><strong>Area ID</strong></span> text box.</li><li class="listitem">Leave all other fields at the default value and click <span class="strong"><strong>OK</strong></span>.</li><li class="listitem">In the <span class="strong"><strong>Area to Interface Mapping</strong></span> panel, click the green plus sign to open the <span class="strong"><strong>New Area to Interface Mapping</strong></span> dialog box.</li><li class="listitem">Verify that the <span class="strong"><strong>Interface</strong></span> selection is <span class="strong"><strong>Transit</strong></span>.</li><li class="listitem">Select <span class="strong"><strong>10</strong></span> from the <span class="strong"><strong>Area</strong></span> drop-down menu.</li><li class="listitem">Leave all other fields at the default value and click <span class="strong"><strong>OK</strong></span>.</li><li class="listitem">At the top of the <span class="strong"><strong>OSPF configuration</strong></span> page, click <span class="strong"><strong>Publish Changes</strong></span>.</li><li class="listitem">After the changes have been published, verify that the <span class="strong"><strong>OSPF Configuration Status</strong></span> is <span class="strong"><strong>Enabled</strong></span>, as shown in the following screenshot:<p>
</p><div class="mediaobject"><img src="graphics/image_05_024.jpg" alt="Configuring OSPF routing on Distributed Logical Router"/></div><p>
</p></li><li class="listitem">We can configure the type of subnets that are advertised by the distributed router, through OSPF:<div class="itemizedlist"><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc">In the <span class="strong"><strong>Routing</strong></span> category panel, select <span class="strong"><strong>Route Redistribution</strong></span>.</li><li class="listitem" style="list-style-type: disc">In the <span class="strong"><strong>Route Redistribution table</strong></span>, select the single entry that appears, click the pencil icon to open the <span class="strong"><strong>Edit Redistribution criteria</strong></span> dialog box, and verify the following settings:<div class="itemizedlist"><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc"><span class="strong"><strong>Prefix Name</strong></span>: Any</li><li class="listitem" style="list-style-type: disc"><span class="strong"><strong>Learner Protocol</strong></span>: <span class="strong"><strong>OSPF</strong></span></li><li class="listitem" style="list-style-type: disc"><span class="strong"><strong>Allow Learning From</strong></span>: <span class="strong"><strong>Connected</strong></span></li><li class="listitem" style="list-style-type: disc"><span class="strong"><strong>Action</strong></span>: <span class="strong"><strong>Permit</strong></span></li></ul></div><p>
</p></li></ul></div><p>
</p></li><li class="listitem">Click <span class="strong"><strong>Cancel</strong></span>.</li><li class="listitem">If the default route redistribution entry does not appear in the list or is not configured as specified, create a new route redistribution by clicking the green plus sign and configuring the criteria as specified in Step 13. The following screenshot shows an OSPF route redistribution table:<p>
</p><div class="mediaobject"><img src="graphics/image_05_025.jpg" alt="Configuring OSPF routing on Distributed Logical Router"/></div><p>
</p></li></ol></div><p>Let's verify the distributed router firewall policy to confirm if we have required rules for OSPF learning. We certainly have OSPF auto rule populated; however, the only difference is that the default rule is <span class="strong"><strong>Deny,</strong></span> as shown in the following screenshot<span class="strong"><strong>. </strong></span>We will certainly check if that rule is blocking any traffic in our example. For now, we are not changing that rule:</p><p>
</p><div class="mediaobject"><img src="graphics/image_05_026.jpg" alt="Configuring OSPF routing on Distributed Logical Router"/></div><p>
</p><p>Even though the NSX GUI is nice and cool, there is no way we can view the routing table; we are limited to running CLI commands to check, and we have two methods to do that:</p><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc">Direct console to NSX Edge and logical router</li><li class="listitem" style="list-style-type: disc">SSH session to NSX Edge and logical router.</li></ul></div><p>Let's SSH to NSX Edge. We are connecting to NSX edge with the IP address <code class="literal">192.168.100.3</code>. There are a few interesting things to note from this output, as shown in the following screenshot:</p><p>
</p><div class="mediaobject"><img src="graphics/image_05_027.jpg" alt="Configuring OSPF routing on Distributed Logical Router"/></div><p>
</p><p>The name is mentioned as <span class="strong"><strong>vShield Edge</strong></span>. Let's not get embarrassed with that output. As explained in 
<a class="link" href="ch01.html" title="Chapter 1. Introduction to Network Virtualization">Chapter 1</a>, 
<span class="emphasis"><em>Introduction to Network Virtualization</em></span>, NSX is a product that is created from VMware <span class="strong"><strong>vCloud Networking Security</strong></span> (<span class="strong"><strong>vCNS</strong></span>). Irrespective we are doing a greenfield deployment of NSX, or a brownfield deployment where older VCNS was upgraded to NSX, edges would still show as vShield Edge. However, the version would certainly be different based on the VCNS/NSX management version. Let's list a few display commands and make a note of a few configurations:</p><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc"><code class="literal">Show IP OSPF interface</code>: This command would display the interfaces where the OSPF process is running. For example, if a router has 10 interfaces and out of that only two interfaces are connected to OSPF AREA, only those interfaces would be listed:<p>
</p><div class="mediaobject"><img src="graphics/image_05_028.jpg" alt="Configuring OSPF routing on Distributed Logical Router"/></div><p>
</p><p>We have two interfaces in our OSPF configuration:</p><p>192.168.10.1 (Transit Interface)</p><p>192.168.100.3 (Uplink)</p></li><li class="listitem" style="list-style-type: disc"><code class="literal">Show IP OSPF neighbor</code>: This command shows the IP address of our OSPF neighbor, as shown in the following screenshot of the output:<p>
</p><div class="mediaobject"><img src="graphics/image_05_029.jpg" alt="Configuring OSPF routing on Distributed Logical Router"/></div><p>
</p><p>The neighbor ID is <code class="literal">192.168.10.2</code>. The transit interface (<code class="literal">192.168.10.1</code>) of NSX Edge is connected to a neighbor DLR, whose IP address is <code class="literal">192.168.10.2</code>, and their OSPF state is <code class="literal">Full</code> (in this state, both NSX Edge and DLR are fully adjacent with each other). When OSPF adjacency is formed, a router goes through several state changes before it becomes fully adjacent with its neighbor. The states are <code class="literal">Down</code>, <code class="literal">Attempt</code>, <code class="literal">Init</code>, <code class="literal">2-Way</code>, <code class="literal">Exstart</code>, <code class="literal">Exchange</code>, <code class="literal">Loading</code>, and <code class="literal">Full</code>. It took me lot of practice sessions to understand the basics of OSPF. I have done numerous sessions using GNS3, and did a lot of Wireshark capture, which gives a precise picture of how communication is happening and in-depth information on LSA packets. To those of you who are finding it difficult to follow my steps, my request would be to make a note of all these steps and keep drawing the topology.</p></li><li class="listitem" style="list-style-type: disc"><code class="literal">Show IP route</code>: Show IP route will display the full routing table for that router:<p>
</p><div class="mediaobject"><img src="graphics/image_05_030.jpg" alt="Configuring OSPF routing on Distributed Logical Router"/></div><p>
</p><p>From the preceding screenshot, we see that:</p><p>A total of eight routes are populated and out of that, we have three OSPF routes for networks 172.16.10.0, 172.16.20.0, and 172.16.30.0/24</p><p>Have a look at the yellow highlighted column to know through which IP address NSX Edge perimeter gateway is learning it- 192.168.10.2(DLR Transit Interface)</p></li><li class="listitem" style="list-style-type: disc"><code class="literal">Show IP OSPF database</code>: This command shows the IPv4 OSPF database. The worst way to troubleshoot an OSPF would be by not looking at the database. The fundamental problem I have seen is that we find the output very lengthy and we are unsure where to start and what to look at. Have a look at the following OSPF database output, which we have captured from NSX Edge. Even in a simple network, the topology table looks very lengthy and confusing, just assume an enterprise network OSPF database? The following screenshot depicts an OSPF database:<p>
</p><div class="mediaobject"><img src="graphics/image_05_031.jpg" alt="Configuring OSPF routing on Distributed Logical Router"/></div><p>
</p></li></ul></div><p>For now, we will make a note of a few configuration details:</p><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc">OSPF is a link state routing protocol. Based on the types of Network and Area, it will have a unique Link State table. Hence, we are seeing the same in the output.</li><li class="listitem" style="list-style-type: disc">In our example, we have two Areas:<div class="itemizedlist"><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc">Link ID - This is the OSPF router ID for L1 and type L2. However, for L3, an L5 type LSA, link ID is a network address.</li><li class="listitem" style="list-style-type: disc">Types of link state for Area-10:<div class="itemizedlist"><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc">Router link state</li><li class="listitem" style="list-style-type: disc">Network link state</li><li class="listitem" style="list-style-type: disc">Summary link state</li><li class="listitem" style="list-style-type: disc">Opaque area link state</li></ul></div><p>
</p></li><li class="listitem" style="list-style-type: disc">Area 0 (backbone area)</li><li class="listitem" style="list-style-type: disc">Area 10 (normal area we created)</li></ul></div><p>
</p></li></ul></div><p>Here's another brain twisting question: Why do we have Network Link State LSA for Area 10? All we have done is connect a DLR OSPF router to NSX Edge through a transit network, which is a point-to-point connection. Well, this is where I need more focus from everyone. Transit-Network is a logical switch, which is nothing but a vSphere PortGroup (L2 segment). This is the prime reason we have a network LSA in Area 10. Routers are not connected as point-to-point; rather, they are connected to one logical switch and <span class="strong"><strong>Designated Router</strong></span> (<span class="strong"><strong>DR</strong></span>) will send the type 2 LSA. In summary LSA will help the router reach the prefix from one area to another area. Opaque LSA is used in practical applications on a routing platform (MPLS traffic engineering).</p><p>Enough talk-the whole purpose of explaining this picture is that ideally, when the OSPF routing tables are populated, we end up by doing a simple ping test and we never think about how they actually work. There is lot more we can discuss about OSPF; however, it is really out of the scope of this book. Let's take a look at the following diagram, which showcases the entire topology with the OSPF routing table:</p><p>
</p><div class="mediaobject"><img src="graphics/image_05_032.jpg" alt="Configuring OSPF routing on Distributed Logical Router"/></div><p>
</p><p>With dynamic routing capability between DLR and NSX Edge, our three-tier applications should be able to reach the <code class="literal">192.168.110.10</code> machine and vice versa. Let's log in to the application server and confirm if we can reach <code class="literal">192.168.110.10</code>.</p><p>The following screenshot shows successful connectivity from the application server (172.16.20.11) to external network 192.168.110.0/24, which was not possible earlier:</p><p>
</p><div class="mediaobject"><img src="graphics/image_05_033.jpg" alt="Configuring OSPF routing on Distributed Logical Router"/></div><p>
</p><p>That concludes our routing module. I know it is hard to recollect all we did so far to establish a virtualized routing environment. I would summarize it in six steps to make it easy to remember:</p><div class="orderedlist"><ol class="orderedlist arabic"><li class="listitem">Created three logical switches.</li><li class="listitem">Deployed a distributed logical router from the NSX Manager.</li><li class="listitem">NSX Controller pushed the DLR configuration to underlying ESXi host.</li><li class="listitem">Deployed an NSX Edge device and configuring OSPF on Edge and DLR.</li><li class="listitem">All learned routes get pushed to NSX Controller.</li><li class="listitem">NSX Controller updates the ESXi host DLR routing table.</li></ol></div><p>We will now move on to the next sections.</p></div>
<div class="section" title="NSX routing design decisions"><div class="titlepage"><div><div><h1 class="title"><a id="ch05lvl1sec39"/>NSX routing design decisions</h1></div></div></div><p>Assume that we have already decided what routing protocol is required for a particular use case. Design factors are key in ensuring that they work flawlessly:</p><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc">If we are a service provider, and multi tenancy is required for DLR control VM and <span class="strong"><strong>Edge Services Gateway</strong></span> (<span class="strong"><strong>ESG</strong></span>), we should deploy a separate instance, which would ease the management. We can also achieve true isolation between the tenants.</li><li class="listitem" style="list-style-type: disc"><span class="strong"><strong>Area Border Router</strong></span> (<span class="strong"><strong>ABR</strong></span>) should be a physical router.</li><li class="listitem" style="list-style-type: disc">If we are not leveraging the <span class="strong"><strong>High Availability</strong></span> (<span class="strong"><strong>HA</strong></span>) feature for ESG and DLR, ensure that tenant ESG and DLR VM are not residing on the same ESXi host. However, recommended practice would be to leverage HA for DLR control VM and ESG with vSphere HA.</li><li class="listitem" style="list-style-type: disc">If there is a shortage of interfaces in ESG, we should leverage the trunk interface so that multiple DLR can be connected to the same ESG.</li><li class="listitem" style="list-style-type: disc">DLR to DLR peering is not possible.</li><li class="listitem" style="list-style-type: disc"><span class="strong"><strong>IPsec</strong></span> with dynamic routing is not supported.</li><li class="listitem" style="list-style-type: disc">Use route summarization wherever we can.</li><li class="listitem" style="list-style-type: disc">DLR control VM doesn't support ABR configuration; however, it supports normal and NSSA areas.</li></ul></div><p>Based on the type of physical network and vendors that we choose, there are a lot of other design parameters, which we need to follow explicitly to ensure we are getting the best of both worlds. I would highly recommend reading vendor design guides before implementing NSX. I don't expect everyone to do a Google search. In the <a class="link" href="ch08.html" title="Chapter 8.  NSX Troubleshooting">Chapter 8</a>, <span class="emphasis"><em>NSX Troubleshooting</em></span>, I will provide all external guide links, to which we should refer before deploying an NSX setup.</p></div>
<div class="section" title="NSX Edge NAT"><div class="titlepage"><div><div><h1 class="title"><a id="ch05lvl1sec40"/>NSX Edge NAT</h1></div></div></div><p>How do we merge two intranets with duplicate addresses and ensure that the host assigned with a private IP can communicate with other hosts through the Internet? There is only one solution for it: <span class="strong"><strong>Network Address Translation</strong></span> (<span class="strong"><strong>NAT</strong></span>).</p><p>NSX Edge NAT supports two types of NAT services:</p><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc"><span class="strong"><strong>Source NAT (SNAT)</strong></span>: Translates the internal private IP address to a public address for outbound access</li><li class="listitem" style="list-style-type: disc"><span class="strong"><strong>Destination NAT (DNAT)</strong></span>: Translates the public IP address to an internal private address for inbound access</li></ul></div><p>Okay, let's have a look at how this whole feature works. In the following figure, one of our application servers is in need of communicating with the public network. We can see the application server <span class="strong"><strong>172.16.20.1</strong></span> sending an outbound packet to NSX Edge. Based on the NAT entries, which the NSX administrator would have configured earlier, Edge will perform a NAT table lookup. Since we have a <span class="strong"><strong>Source NAT</strong></span>, which is configured for <span class="strong"><strong>172.16.20.1</strong></span>, it will translate the IP to <span class="strong"><strong>170.168.2.1</strong></span>, which is the public IP. This is a very simple example of 1:1 NAT configuration for outbound access. But remember, Edge also has a firewall feature, and by default, it will block all traffic. So, doing a NAT alone won't do the trick; we need to allow respective source and destination IP in the firewall table:</p><p>
</p><div class="mediaobject"><img src="graphics/image_05_034.jpg" alt="NSX Edge NAT"/></div><p>
</p><p>Now let's go ahead and check how a NAT table configuration looks in NSX Edge:</p><div class="orderedlist"><ol class="orderedlist arabic"><li class="listitem">Log into VMware vSphere web client and switch to the <span class="strong"><strong>Networking &amp; Security</strong></span> solution page.</li><li class="listitem">On the <span class="strong"><strong>NSX Edge management</strong></span> page, double-click the NSX Edge instance that handles the NAT. The following screenshot shows the NSX Edge NAT configuration:<p>
</p><div class="mediaobject"><img src="graphics/image_05_035.jpg" alt="NSX Edge NAT"/></div><p>
</p><p>Since we don't have any rule created, as of now, nothing is populated there. Let's explore DNAT and SNAT options further:</p></li></ol></div><p>Click the add icon, select <span class="strong"><strong>Add DNAT Rule</strong></span>, and configure the following settings based on the business use case:</p><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc"><span class="strong"><strong>Applied On</strong></span>: The interface on which to apply the destination NAT rule, for example, external link. The drop-down menu will display the names of all 10 interfaces of this NSX Edge instance.</li><li class="listitem" style="list-style-type: disc"><span class="strong"><strong>Orginal IP</strong></span>: The original (public) IP address in one of the following formats:<div class="itemizedlist"><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc">IP address 172.168.2.1</li><li class="listitem" style="list-style-type: disc">IP address range172.168.2.1-172.168.2.3</li><li class="listitem" style="list-style-type: disc">IP address/Subnet 172.168.2.1/24</li></ul></div><p>
</p></li><li class="listitem" style="list-style-type: disc"><span class="strong"><strong>Protocol</strong></span>: The protocols that are used by the application (we could simply update as <span class="strong"><strong>Any)</strong></span></li><li class="listitem" style="list-style-type: disc"><span class="strong"><strong>Original Port/Range</strong></span>: The original port, a range of ports, or <span class="strong"><strong>
<span class="strong"><strong>Any</strong></span>
</strong></span> port</li><li class="listitem" style="list-style-type: disc"><span class="strong"><strong>Translated IP/Range</strong></span>: Since this is a DNAT rule, the translated IP would be the internal/private IP range</li><li class="listitem" style="list-style-type: disc"><span class="strong"><strong>Translated Port/Range</strong></span>: The translated port or range of ports in the internal/private network</li></ul></div><p>If all the preceding parameters are configured properly, with firewall rules enabled for the same configuration, our internal machines would be accessible from the public network.In our example we have a done a 1:1 DNAT configuration. This is shown in the following screenshot:</p><p>
</p><div class="mediaobject"><img src="graphics/39.jpg" alt="NSX Edge NAT"/></div><p>
</p><p>The NAT is an integral part of NSX load balancer functionality, and we need that basic understanding of how NAT works to understand the feature. Last but not least, we are living in a world where nothing is perfect; when something goes wrong, we need to start troubleshooting it. One of the common problems I have seen is not an issue of wrong NAT configuration, it is the intermediate culprit, firewall, which blocks all the traffic, and one would simply wonder, <span class="emphasis"><em>What the heck am I missing in this setup?</em></span> Okay, enough talk. Let's move on and discuss NSX Edge logical load balancer.</p></div>
<div class="section" title="NSX Edge logical load balancer"><div class="titlepage"><div><div><h1 class="title"><a id="ch05lvl1sec41"/>NSX Edge logical load balancer</h1></div></div></div><p>When we talk about load balancers, traditional load balancers are typically placed in the aggregation layer. Load balancing can be implemented with hardware, software, or a combination of both. One of the first methods of load balancing was round-robin DNS. In the current cloud era, we have applications running in multitenant environments and the number of load balancer requirements also gets increased. In a nutshell, if every application tier needs a load balancer, it is extremely difficult to get an optimal performance. This is where virtual load balancers are really making a difference, compared with physical load balancers.</p><p>The NSX Edge load balancer enables network traffic to follow multiple paths to a specific destination. A load balancer distributes incoming service requests evenly among multiple servers (virtual machines). Load balancing thus helps to achieve optimal resource use, maximizing throughput, minimizing response time, and avoiding overload. NSX Edge provides load balancing up to Layer 7. Let's get familiarized with some load balancer terms and terminology that is very common in all load balancers.</p><div class="section" title="Server pools"><div class="titlepage"><div><div><h2 class="title"><a id="ch05lvl2sec31"/>Server pools</h2></div></div></div><p>Groups of machines that are running similar applications get added to this pool. This is one of the key design decisions to plan while deploying a load balancer. Firstly, identify the set of virtual machines that are required to be in the server pool.</p></div><div class="section" title="Virtual server"><div class="titlepage"><div><div><h2 class="title"><a id="ch05lvl2sec32"/>Virtual server</h2></div></div></div><p>This is the address from which server pool machines will receive sessions from the load balancer. Each virtual server will have a unique <span class="strong"><strong>Virtual IP</strong></span> (<span class="strong"><strong>vIP</strong></span>). The vIP is an IP address and also contains the service port number.</p></div><div class="section" title="Application profile"><div class="titlepage"><div><div><h2 class="title"><a id="ch05lvl2sec33"/>Application profile</h2></div></div></div><p>The application profile is where we would configure what type of access protocol (TCP, HTTP, and HTTPS) is used and what type of load balancing algorithm we should use. NSX load balancer supports a wide range of load balancing algorithms.</p><p>NSX load balancer operates in two modes:</p><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc"><span class="strong"><strong>Proxy mode</strong></span>: The one-arm load balancer mode is also called proxy mode. The NSX Edge gateway uses one interface to advertise the vIP address and to connect to the web servers.</li><li class="listitem" style="list-style-type: disc"><span class="strong"><strong>Inline mode</strong></span>: Inline load balancer mode is also called transparent mode. The NSX Edge gateway uses the following interfaces:<div class="itemizedlist"><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc">An interface to advertise the vIP address</li><li class="listitem" style="list-style-type: disc">An interface to connect to the web servers</li><li class="listitem" style="list-style-type: disc">Web servers must point to the NSX Edge gateway as the default gateway</li></ul></div><p>
</p></li></ul></div></div></div>
<div class="section" title="Design considerations while load balancing"><div class="titlepage"><div><div><h1 class="title"><a id="ch05lvl1sec42"/>Design considerations while load balancing</h1></div></div></div><p>Several best practices should be followed when setting up an NSX load balancer. Let's read the following points carefully before doing a lab exercise:</p><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc">Based on the number of server pools, load balancer numbers will also get increased. However, that way, since each tenant has its own load balancer, management and configuration changes will have no impact on other tenants' load balancers.</li><li class="listitem" style="list-style-type: disc">Deploy load balancers in HA mode for High Availability.</li><li class="listitem" style="list-style-type: disc">Ensure you don't deploy a load balancer on the same machine where the underlying load-balanced machines are running. Follow the best practice of deploying on a different ESXi host or in a separate management edge cluster.</li><li class="listitem" style="list-style-type: disc">Select the right load balancing protocol based on application characteristics. For example, round robin, least connected, hashing, and least loaded are some of the common algorithms.</li><li class="listitem" style="list-style-type: disc">One common question is, <span class="emphasis"><em>do we need an end-to-end SSL connection, or do we need to terminate or offload SSL traffic?</em></span></li><li class="listitem" style="list-style-type: disc">Watch out for bandwidth and number of <span class="strong"><strong>connections per second</strong></span> (<span class="strong"><strong>CPS</strong></span>) that the load balancer is capable of.</li><li class="listitem" style="list-style-type: disc">A rule of thumb is to test the load balancer functionality before hitting production, especially if this is the first time we are load balancing an application request in an NSX world.</li><li class="listitem" style="list-style-type: disc">Lastly, we need to decide whether we are perfectly okay with having too many eggs in one basket. How does that relate to an NSX load balancer? Well, remember that nothing is stopping us configuring routing/NAT/VPN/DHCP and other Edge/DLR services features on the same Edge/DLR. So, carefully plan what type of services are required to run on Edge/DLR.</li></ul></div><p>It's time to recollect all that we have discussed so far in relation to NSX load balancers, and now we have an objective to perform an SSL load balancing against our web servers. However, in this lab, I'm not leveraging SSL certificates for web servers; hence, we will stick with client to load balancer SSL configuration. So let's get started. First and foremost, we don't have any SSL certificate generated so far. In this example, we will use a self-signed certificate and will leverage the same.</p></div>
<div class="section" title="Generating a certificate"><div class="titlepage"><div><div><h1 class="title"><a id="ch05lvl1sec43"/>Generating a certificate</h1></div></div></div><p>We will generate a certificate request and instruct the VMware NSX Edge instance to create a self-signed certificate from that request:</p><div class="orderedlist"><ol class="orderedlist arabic"><li class="listitem">In the left-hand navigation pane, select <span class="strong"><strong>NSX Edges</strong></span>.</li><li class="listitem">In the edge list, double-click the <span class="strong"><strong>Perimeter Gateway</strong></span> entry to manage that object.</li><li class="listitem">Click the <span class="strong"><strong>Manage</strong></span> tab and click <span class="strong"><strong>Settings</strong></span>.</li><li class="listitem">In the settings category panel, select <span class="strong"><strong>Certificates</strong></span>.</li><li class="listitem">Select <span class="strong"><strong>Generate CSR</strong></span> from the <span class="strong"><strong>Actions</strong></span> drop-down menu to open the <span class="strong"><strong>Generate CSR</strong></span> dialog box, and perform the following actions:<div class="itemizedlist"><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc">Enter <span class="strong"><strong>Webload</strong></span> in the <span class="strong"><strong>Common Name</strong></span> text box.</li><li class="listitem" style="list-style-type: disc">Enter <span class="strong"><strong>Loadbalancer</strong></span> in the <span class="strong"><strong>Organization Name</strong></span> text box.</li><li class="listitem" style="list-style-type: disc">Verify that <span class="strong"><strong>RSA</strong></span> is the selected <span class="strong"><strong>Message Algorithm</strong></span>.</li><li class="listitem" style="list-style-type: disc">Verify that <span class="strong"><strong>2048</strong></span> is the selected <span class="strong"><strong>Key Size</strong></span>.</li><li class="listitem" style="list-style-type: disc">Leave all other settings at the default value and click <span class="strong"><strong>OK</strong></span>.</li></ul></div><p>
</p></li><li class="listitem">In the certificate list, select the newly generated signing request and select <span class="strong"><strong>Self Sign Certificate</strong></span> from the <span class="strong"><strong>Actions</strong></span> drop-down menu.</li><li class="listitem">When prompted, enter <span class="strong"><strong>365</strong></span> in the <span class="strong"><strong>Number of days</strong></span> text box, and click <span class="strong"><strong>OK</strong></span>.</li></ol></div><p>The following screenshot depicts the <span class="strong"><strong>Generate CSR</strong></span> screen where we need to update all the steps that we have discussed so far:</p><p>
</p><div class="mediaobject"><img src="graphics/image_05_037.jpg" alt="Generating a certificate"/></div><p>
</p><p>Now that we have a certificate created, we will go ahead and self sign the certificate and use it in our load balancer configuration. The following screenshot depicts the self signed certificate step:</p><p>
</p><div class="mediaobject"><img src="graphics/image_05_038.jpg" alt="Generating a certificate"/></div><p>
</p></div>
<div class="section" title="Setting up a load balancer"><div class="titlepage"><div><div><h1 class="title"><a id="ch05lvl1sec44"/>Setting up a load balancer</h1></div></div></div><p>We will perform the following steps in the same order to set up and test a load balancer.</p><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc">Set global option for the load balancer</li><li class="listitem" style="list-style-type: disc">Create an application profile</li><li class="listitem" style="list-style-type: disc">Create a service monitor to define health check performance</li><li class="listitem" style="list-style-type: disc">Create a server pool</li><li class="listitem" style="list-style-type: disc">Test the load balancer</li></ul></div><div class="section" title="Setting global options"><div class="titlepage"><div><div><h2 class="title"><a id="ch05lvl2sec34"/>Setting global options</h2></div></div></div><p>The procedure for setting global options for the load balancer is as follows:</p><div class="orderedlist"><ol class="orderedlist arabic"><li class="listitem">Log in to the vSphere web client.</li><li class="listitem">Click <span class="strong"><strong>Networking &amp; Security</strong></span> and then click <span class="strong"><strong>NSX Edges</strong></span>.</li><li class="listitem">Double-click an NSX Edge.</li><li class="listitem">Click <span class="strong"><strong>Manage</strong></span> and then click the <span class="strong"><strong>Load Balancer</strong></span> tab.</li><li class="listitem">Click <span class="strong"><strong>Edit</strong></span>.</li><li class="listitem">Select the check boxes next to the options you want to enable:<div class="itemizedlist"><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc"><span class="strong"><strong>Enable Load balancer</strong></span>: Allows the NSX Edge load balancer to distribute traffic to internal servers for load balancing</li><li class="listitem" style="list-style-type: disc"><span class="strong"><strong>Enable Service Insertion</strong></span>: Allows the load balancer to work with third-party vendor appliances.</li><li class="listitem" style="list-style-type: disc"><span class="strong"><strong>Acceleration Enabled</strong></span>: When enabled, the NSX Edge load balancer uses the faster L4 LB engine rather than the L7 LB engine.</li><li class="listitem" style="list-style-type: disc"><span class="strong"><strong>Logging</strong></span>: The NSX Edge load balancer collects traffic logs. You can also choose the log level.</li></ul></div><p>
</p></li><li class="listitem">Click <span class="strong"><strong>OK</strong></span>.</li></ol></div></div><div class="section" title="Creating an application profile"><div class="titlepage"><div><div><h2 class="title"><a id="ch05lvl2sec35"/>Creating an application profile</h2></div></div></div><p>Since we have enabled the load balancer service, in this step, we will configure for HTTPS traffic:</p><div class="orderedlist"><ol class="orderedlist arabic"><li class="listitem">Under the <span class="strong"><strong>Manage</strong></span> tab, click <span class="strong"><strong>Load Balancer</strong></span>.</li><li class="listitem">In the load balancer category panel, select <span class="strong"><strong>Global Configuration</strong></span>.</li><li class="listitem">Click <span class="strong"><strong>Edit</strong></span>, on the right-hand side of the global configuration page.</li><li class="listitem">On the <span class="strong"><strong>Edit load balancer global configuration</strong></span> page, select the <span class="strong"><strong>Enable Load Balancer</strong></span> checkbox and click <span class="strong"><strong>OK</strong></span>. Select the certificate that we created earlier and leave all other fields at the default value.</li><li class="listitem">The <span class="strong"><strong>Insert X-Forwarded-For HTTP header</strong></span> helps you identify the IP address of a client when you use an HTTP load balancer.</li><li class="listitem">In the load balancer category panel, select <span class="strong"><strong>Application Profiles</strong></span>.</li><li class="listitem">Above the top panel, click the green plus sign to open the <span class="strong"><strong>New Profile</strong></span> dialog box, and perform the following actions:<div class="orderedlist"><ol class="orderedlist arabic"><li class="listitem">Enter <span class="strong"><strong>Web-Server</strong></span> in the <span class="strong"><strong>Name</strong></span> text box.</li><li class="listitem">Click <span class="strong"><strong>HTTPS</strong></span>.</li><li class="listitem">Leave all other fields at the default value and click <span class="strong"><strong>OK</strong></span>.</li></ol></div><p>
</p></li></ol></div><p>The following screenshot shows the <span class="strong"><strong>Application Profile Configuration</strong></span> for the load balancer:</p><p>
</p><div class="mediaobject"><img src="graphics/image_05_039.jpg" alt="Creating an application profile"/></div><p>
</p></div><div class="section" title="Creating a service monitor"><div class="titlepage"><div><div><h2 class="title"><a id="ch05lvl2sec36"/>Creating a service monitor</h2></div></div></div><p>We can create a service monitor to define health check parameters for a particular type of network traffic. When you associate a service monitor with a pool, the pool members are monitored according to the service monitor parameters. The following screenshot shows the default service monitoring pools:</p><p>
</p><div class="mediaobject"><img src="graphics/image_05_040.jpg" alt="Creating a service monitor"/></div><p>
</p></div><div class="section" title="Creating a server pool"><div class="titlepage"><div><div><h2 class="title"><a id="ch05lvl2sec37"/>Creating a server pool</h2></div></div></div><p>In this step, we will create a round-robin server pool that contains the two web server virtual machines as members:</p><div class="orderedlist"><ol class="orderedlist arabic"><li class="listitem">Above the top panel, click the green plus sign to open the <span class="strong"><strong>New Pool</strong></span> dialog box, and perform the following actions:</li><li class="listitem">In the load balancer category panel, select <span class="strong"><strong>Pools</strong></span>.<div class="orderedlist"><ol class="orderedlist arabic"><li class="listitem">Enter <span class="strong"><strong>
<span class="strong"><strong>Web-Pool</strong></span>
</strong></span> in the <span class="strong"><strong>Name</strong></span> text box.</li><li class="listitem">Verify that the <span class="strong"><strong>Algorithm</strong></span> selection is <span class="strong"><strong>
<span class="strong"><strong>ROUND-ROBIN</strong></span>
</strong></span>.</li><li class="listitem">In the monitoring selection, we can either select <span class="strong"><strong>
<span class="strong"><strong>NONE</strong></span>
</strong></span>, one of the default monitoring pools, or something that we manually created.</li><li class="listitem">Below <span class="strong"><strong>Members</strong></span>, click the green plus sign to open the <span class="strong"><strong>New Member</strong></span> dialog box, and add the first server.</li><li class="listitem">Click <span class="strong"><strong>OK</strong></span> to close the <span class="strong"><strong>New Member</strong></span> dialog box.</li><li class="listitem">Under <span class="strong"><strong>Members</strong></span>, click the green plus sign to open the <span class="strong"><strong>New Member</strong></span> dialog box, and add a second server.</li><li class="listitem">Click <span class="strong"><strong>OK</strong></span> to close the <span class="strong"><strong>New Member</strong></span> dialog box.</li><li class="listitem">Click <span class="strong"><strong>OK</strong></span> to close the <span class="strong"><strong>New Pool</strong></span> dialog box.</li></ol></div><p>
</p></li><li class="listitem">In the Name field enter <span class="strong"><strong>Web -01a</strong></span>.</li><li class="listitem">In the IP Address field enter <span class="strong"><strong>172.16.10.11</strong></span>.</li><li class="listitem">In <span class="strong"><strong>Port</strong></span> field enter <span class="strong"><strong>443</strong></span> in the text box.</li><li class="listitem">Leave all other settings at the default value.</li><li class="listitem">Repeat the same steps and add our second web server, <code class="literal">172.16.20.11</code>. The following screenshot shows the pool settings that we configured:</li></ol></div><p>
</p><div class="mediaobject"><img src="graphics/image_05_041.jpg" alt="Creating a server pool"/></div><p>
</p></div><div class="section" title="Creating a virtual server"><div class="titlepage"><div><div><h2 class="title"><a id="ch05lvl2sec38"/>Creating a virtual server</h2></div></div></div><p>The virtual server is positioned on the external network attached to the uplink interface of the perimeter:</p><div class="orderedlist"><ol class="orderedlist arabic"><li class="listitem">In the load balancer category panel, select <span class="strong"><strong>Virtual Servers</strong></span>.</li><li class="listitem">Above the top panel, click the green plus sign to open the <span class="strong"><strong>New Virtual Server</strong></span> dialog box, and perform the following actions:<div class="orderedlist"><ol class="orderedlist arabic"><li class="listitem">Verify that the <span class="strong"><strong>Enabled</strong></span> check box is selected.</li><li class="listitem">Enter <span class="strong"><strong>VIP</strong></span> in the <span class="strong"><strong>Name</strong></span> text box.</li><li class="listitem">Enter <span class="strong"><strong>192.168.100.9</strong></span> in the <span class="strong"><strong>IP Address</strong></span> text box.</li><li class="listitem">Select <span class="strong"><strong>HTTPS</strong></span> from the <span class="strong"><strong>Protocol</strong></span> drop-down menu.</li><li class="listitem">Verify that the <span class="strong"><strong>Port</strong></span> setting has changed to 443.</li><li class="listitem">Select <span class="strong"><strong>Web-Pool</strong></span> from the <span class="strong"><strong>Default Pool</strong></span> drop-down menu.</li><li class="listitem">Verify that the <span class="strong"><strong>Application Profile</strong></span> selection is <span class="strong"><strong>Web-Server</strong></span>.</li><li class="listitem">Leave all other settings at the default value and click <span class="strong"><strong>OK</strong></span></li></ol></div><p>
</p></li></ol></div><p>The following screenshot depicts the virtual server configuration for the web-pool that we are trying to load balance:</p><p>
</p><div class="mediaobject"><img src="graphics/image_05_042.jpg" alt="Creating a virtual server"/></div><p>
</p><p>We are not leveraging an <span class="strong"><strong>application</strong></span> rule in the load balancing setup. With application rules, we have the flexibility to specify HTTP/HTTPS redirection; regardless of the URL, the traffic will always redirect based on the rules. All we need to do now for testing is just go ahead and enter the VIP <code class="literal">192.168.100.9</code> in the browser, and we should see the traffic getting redirected to one of the web servers.</p><p>The following screenshot shows the load balancing done against web-sv-02a:</p><p>
</p><div class="mediaobject"><img src="graphics/image_05_043.jpg" alt="Creating a virtual server"/></div><p>
</p><p>I personally hate learning things from looking at a GUI. CLI is my best friend, and I have captured a debug output of our load balancing scenario with the lab topology to ensure that the concepts are crystal clear for everyone:</p><p>
</p><div class="mediaobject"><img src="graphics/image_05_044.jpg" alt="Creating a virtual server"/></div><p>
</p><p>That concludes the topic of load balancing, and we all know that we certainly need a working NSX Edge instance to load balance any traffic.</p></div></div>
<div class="section" title="Virtual Private Network&#xA0;"><div class="titlepage"><div><div><h1 class="title"><a id="ch05lvl1sec45"/>Virtual Private Network </h1></div></div></div><p>NSX Edge supports several types of VPN service, such as SSL-VPN, L2-VPN, and IPsec VPN. They are as follows:</p><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc"><span class="strong"><strong>SSL VPN-plus</strong></span>: The prime reason someone would go for an SSL VPN connection would be for users (roaming profiles) who need to access private networks that are behind a perimeter device.</li><li class="listitem" style="list-style-type: disc"><span class="strong"><strong>IPsec VPN</strong></span>: NSX supports site to site VPN between the NSX Edge gateway and most of the third-party IPsec VPN devices.</li><li class="listitem" style="list-style-type: disc"><span class="strong"><strong>L2 VPN</strong></span>: In the current cloud era, we have a lot of use cases where an on-premises network needs an extension all the way to another site, which can be a private cloud or any other public cloud service, such as vCloud Air, AWS, and Azure. Please don't confuse this with a direct connect solution. Virtual machines in L2 VPN will be on the same subnet, irrespective of being moved between the sites.</li></ul></div><p>Let's discuss these topics a bit more in depth to learn about their features and where NSX would fit, and finally, we will focus on a few design decisions.</p><div class="section" title="SSL VPN"><div class="titlepage"><div><div><h2 class="title"><a id="ch05lvl2sec39"/>SSL VPN</h2></div></div></div><p>The NSX SSL VPN feature provides remote users a secure connection to a private network, which is residing behind an NSX Edge gateway. We can either have a web-based connection, or we need to install an SSL client and access the private network. Behind the scenes, traffic will be tunneled and securely directed to private networks. The following steps would be done in the same order to configure an SSL VPN connection:</p><div class="orderedlist"><ol class="orderedlist arabic"><li class="listitem">Configure SSL VPN server settings.</li><li class="listitem">Add an IP pool.</li><li class="listitem">Add a private network.</li><li class="listitem">Add authentication.</li><li class="listitem">Add an installation package.</li><li class="listitem">Add a user.</li><li class="listitem">Verify all the configurations and enable SSL VPN.</li></ol></div><p>The following figure depicts three sites (A, B, C), which are in need of connecting to other sites through SSL-VPN, IPSEC, and L2 VPN setups:</p><p>
</p><div class="mediaobject"><img src="graphics/52.jpg" alt="SSL VPN"/></div><p>
</p><p>We will start with SITE-A's SSL VPN configuration.</p><div class="section" title="Configure SSL VPN server settings"><div class="titlepage"><div><div><h3 class="title"><a id="ch05lvl3sec18"/>Configure SSL VPN server settings</h3></div></div></div><p>As mentioned previously, we need to follow Steps 1 to 7 to configure SSL-VPN settings:</p><div class="orderedlist"><ol class="orderedlist arabic"><li class="listitem">In the <span class="strong"><strong>SSL VPN-Plus</strong></span> tab, select <span class="strong"><strong>Server Settings</strong></span> from the left-hand panel.</li><li class="listitem">Click <span class="strong"><strong>Change</strong></span>.</li><li class="listitem">Select the <span class="strong"><strong>IPv4 Address</strong></span> or <span class="strong"><strong>IPv6 Address</strong></span>.</li><li class="listitem">Edit the port number if required. This port number is required to configure the installation package.</li><li class="listitem">Select the encryption method.</li><li class="listitem">From the <span class="strong"><strong>Server certificate</strong></span> table, select the server certificate that you want to add. This is an optional step; adding to that, let's not get embarrassed that we are seeing a web-load SSL certificate. This is the same certificate that we created earlier during the SSL-load balancer topic.</li><li class="listitem">Click <span class="strong"><strong>OK</strong></span>.</li></ol></div><p>The following screenshot shows the SSL VPN server settings:</p><p>
</p><div class="mediaobject"><img src="graphics/image_05_046.jpg" alt="Configure SSL VPN server settings"/></div><p>
</p></div><div class="section" title="Adding ID pool"><div class="titlepage"><div><div><h3 class="title"><a id="ch05lvl3sec19"/>Adding ID pool</h3></div></div></div><p>The whole purpose of adding this pool is to assign a <span class="strong"><strong>Virtual IP</strong></span> (<span class="strong"><strong>VIP</strong></span>) from the pool of IP addresses to the remote user. The following screenshot depicts an IP pool page:</p><p>
</p><div class="mediaobject"><img src="graphics/image_05_047.jpg" alt="Adding ID pool"/></div><p>
</p><p>In our example, we are taking the range as <code class="literal">192.168.170.2</code> to <code class="literal">192.168.170.254</code> and the gateway as <code class="literal">192.168.170.1</code>. DNS/WINS settings are optional; hence, we are skipping that configuration.</p></div><div class="section" title="Private network"><div class="titlepage"><div><div><h3 class="title"><a id="ch05lvl3sec20"/>Private network</h3></div></div></div><p>The private network is the network that we want our remote users to connect to and access. The following screenshot depicts the private network configuration. We are taking 192.168.1.0/24 as our network for SSL VPN access:</p><p>
</p><div class="mediaobject"><img src="graphics/image_05_048.jpg" alt="Private network"/></div><p>
</p><p>Please take a look at the following steps:</p><div class="orderedlist"><ol class="orderedlist arabic"><li class="listitem"><span class="strong"><strong>Add authentication</strong></span>: External authentication servers like AD, LDAP, Radius, or RSA are supported, or we can simply create a local user and use the same local user name and password to connect to the private network.</li><li class="listitem"><span class="strong"><strong>Add an installation package</strong></span>: We can create an installation package of the SSL-VPN client for remote users based on the type of operating system from which we need to access the private network. There are several logon settings we can select during the package selection.</li><li class="listitem"><span class="strong"><strong>Add a user</strong></span>: Since we have already added the authentication method, we can go ahead and add those users for accessing the private network.</li><li class="listitem"><span class="strong"><strong>Enable SSL VPN service</strong></span>: After verifying the entire configuration, we need to enable the SSL VPN service by switching to the <span class="strong"><strong>SSL VPN-Plus</strong></span> tab. Select <span class="strong"><strong>Dashboard</strong></span> from the left-hand panel. The following screenshot shows a <span class="strong"><strong>Service enabled successfully</strong></span> message:</li></ol></div><p>
</p><div class="mediaobject"><img src="graphics/image_05_049.jpg" alt="Private network"/></div><p>
</p><p>Now that we have successfully enabled an SSL-service, remote user (192.168.7.1) can initiate an SSL-VPN connection to the private network (192.168.1.0/24) after authentication, based on the type of authentication we selected earlier. There are several ways in which we can check the SSL session. The best and easiest way would be from the client machine itself (192.168.7.1), by doing a <span class="strong"><strong>route lookup</strong></span> on the local operating system; we would see a new route added all the way to the private network. With that, we are moving on to IPsec VPN for <span class="strong"><strong>Site-B</strong></span>.</p></div></div><div class="section" title="IPsec VPN"><div class="titlepage"><div><div><h2 class="title"><a id="ch05lvl2sec40"/>IPsec VPN</h2></div></div></div><p>NSX Edge Gateway supports Site-Site VPN between NSX Edge and remote sites. In a nutshell, the original packet will be authenticated and encrypted, and it will be encapsulated with an <span class="strong"><strong>Encapsulation Security Payload</strong></span> (<span class="strong"><strong>ESP</strong></span>) header, trailer, and authentication data. The following screenshot depicts initial IPsec VPN configuration:</p><p>
</p><div class="mediaobject"><img src="graphics/image_05_050.jpg" alt="IPsec VPN"/></div><p>
</p><p>Since we already have a topology shared earlier, the requirement is to establish an IPsec tunnel between Site-B and the remote site (192.168.5.0/24). Let's get started.</p><p>Following is the procedure for configuring IPsec:</p><div class="orderedlist"><ol class="orderedlist arabic"><li class="listitem">Log in to the vSphere web client.</li><li class="listitem">Click <span class="strong"><strong>Networking &amp; Security</strong></span> and then click <span class="strong"><strong>NSX Edges</strong></span>.</li><li class="listitem">Double-click an NSX Edge.</li><li class="listitem">Click the <span class="strong"><strong>Monitor</strong></span> tab and then click the <span class="strong"><strong>VPN</strong></span> tab.</li><li class="listitem">Click <span class="strong"><strong>IPSec VPN</strong></span>.</li><li class="listitem">Click the add icon.</li><li class="listitem">Type a name for the IPsec VPN.</li><li class="listitem">Type the IP address of the NSX Edge instance in <span class="strong"><strong>Local Id</strong></span>. This will be the <span class="strong"><strong>Peer Id</strong></span> on the remote site.</li><li class="listitem">Type the IP address of the local endpoint.<div class="note" title="Note" style=""><div class="inner"><h3 class="title"><a id="tip17"/>Tip</h3><p>If you are adding an IP-to-IP tunnel using a pre-shared key, the local ID and local endpoint IP can be the same.</p></div></div></li><li class="listitem">Type the subnets to share between the sites in CIDR format. Use a comma separator to type multiple subnets.</li><li class="listitem">Type the <span class="strong"><strong>Peer Id</strong></span> to uniquely identify the peer site. For peers using certificate authentication, this ID must be the common name in the peer's certificate. For PSK peers, this ID can be any string. VMware recommends that you use the public IP address of the VPN or a FQDN for the VPN service as the peer ID.</li><li class="listitem">Type the IP address of the peer site in <span class="strong"><strong>Peer Endpoint</strong></span>. If you leave this blank, NSX Edge waits for the peer device to request a connection.</li><li class="listitem">Type the internal IP address of the peer subnet in CIDR format. Use a comma separator to type multiple subnets.</li><li class="listitem">Select the <span class="strong"><strong>Encryption Algorithm</strong></span>.<div class="note" title="Note" style=""><div class="inner"><h3 class="title"><a id="note18"/>Note</h3><p>
<span class="strong"><strong>Pre-Shared Key (PSK)</strong></span>: This indicates that the secret key shared between NSX Edge and the peer site is to be used for authentication. The secret key can be a string with a maximum length of 128 bytes. NSX IPsec VPN supports symmetric keys. <span class="strong"><strong>Certificate</strong></span>: This indicates that the certificate defined at the global level is to be used for authentication.</p></div></div></li><li class="listitem">Type in the shared key if anonymous sites are to connect to the VPN service.</li><li class="listitem">Click <span class="strong"><strong>Display Shared Key</strong></span> to display the key on the peer site.</li><li class="listitem">In <span class="strong"><strong>Diffie-Hellman (DH) Group</strong></span>, select the cryptography scheme that will allow the peer site and the NSX Edge to establish a shared secret over an insecure communications channel.</li><li class="listitem">Edit the default MTU if required.</li><li class="listitem">Select whether to enable or disable the <span class="strong"><strong>Perfect Forward Secrecy</strong></span> (<span class="strong"><strong>PFS</strong></span>) threshold. In IPsec negotiations, PFS ensures that each new cryptographic key is unrelated to any previous key.</li><li class="listitem">Click <span class="strong"><strong>OK</strong></span>.</li><li class="listitem">Enable VPN.</li><li class="listitem">As per our topology, we have updated our IPsec configuration in the Edge. Once we configure the partner device, the IPsec tunnel will get established:</li></ol></div><p>
</p><div class="mediaobject"><img src="graphics/image_05_051.jpg" alt="IPsec VPN"/></div><p>
</p><p>The IKE phase 1 parameters used by the NSX Edge include:</p><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc">Main mode</li><li class="listitem" style="list-style-type: disc">AES / AES 256 preferred / TripleDES /</li><li class="listitem" style="list-style-type: disc">SHA-1</li><li class="listitem" style="list-style-type: disc">MODP (DH) group 2 (MODP1024 bits)</li><li class="listitem" style="list-style-type: disc">Pre-shared secret [Configurable]</li><li class="listitem" style="list-style-type: disc">SA lifetime of 28800 seconds (eight hours) with no kilobytes rekeying</li><li class="listitem" style="list-style-type: disc">ISAKMP aggressive mode disabled</li></ul></div><p>The IKE phase 2 parameters supported by NSX Edge include:</p><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc">AES / AES 256 Preferred / TripleDES / [Will match the Phase 1 setting]</li><li class="listitem" style="list-style-type: disc">SHA-1</li><li class="listitem" style="list-style-type: disc">ESP tunnel mode</li><li class="listitem" style="list-style-type: disc">MODP (DH) group 2 (MODP1024 bits)</li><li class="listitem" style="list-style-type: disc">Perfect forwarding secrecy for rekeying</li><li class="listitem" style="list-style-type: disc">SA lifetime of 3600 seconds (one hour) with no kilobytes rekeying</li><li class="listitem" style="list-style-type: disc">Selectors for all IP protocols and all ports between the two networks using IPv4 subnets</li></ul></div></div><div class="section" title="L2 VPN"><div class="titlepage"><div><div><h2 class="title"><a id="ch05lvl2sec41"/>L2 VPN</h2></div></div></div><p>L2 VPN allows us to configure a tunnel between two sites. As I said earlier, virtual machines will be on the same subnet irrespective of where they are moving. As per our topology, we need to establish a L2-VPN between Site-C and remote site 192.168.5.0/24. In our example, we are taking Site-C as the L2 VPN server, and the remote site is the L2 VPN client. The L2 VPN server is the source NSX Edge server to which destination L2 VPN Client is getting connected.</p><div class="section" title="Prerequisites"><div class="titlepage"><div><div><h3 class="title"><a id="ch05lvl3sec21"/>Prerequisites</h3></div></div></div><p>The internal IP address assigned to the L2 VPN server and client must be different. They can be on the same subnet.</p><p>Following is the procedure for L2 VPN server:</p><div class="orderedlist"><ol class="orderedlist arabic"><li class="listitem">Log in to the vSphere web client.</li><li class="listitem">Click <span class="strong"><strong>Networking &amp; Security</strong></span> and then click <span class="strong"><strong>NSX Edges</strong></span>.</li><li class="listitem">Double-click an NSX Edge.</li><li class="listitem">Click the <span class="strong"><strong>Manage</strong></span> tab and then click the <span class="strong"><strong>VPN</strong></span> tab.</li><li class="listitem">Click <span class="strong"><strong>L2 VPN</strong></span>, select <span class="strong"><strong>Server</strong></span>, and click <span class="strong"><strong>Change</strong></span>.</li><li class="listitem">Expand <span class="strong"><strong>Server Details</strong></span>.</li><li class="listitem">In <span class="strong"><strong>Listener IP</strong></span>, type the primary or secondary IP address of an external interface of the NSX Edge. In our example, the IP would be <code class="literal">192.168.9.1</code>.</li><li class="listitem">The default port for the L2 VPN service is <span class="strong"><strong>443</strong></span>. Edit this if required.</li><li class="listitem">Select the encryption method.</li><li class="listitem">Select the internal interface of the NSX Edge that is being stretched .This interface must be connected to a DV port group or logical switch.</li><li class="listitem">Type a description.</li><li class="listitem">Expand <span class="strong"><strong>User Details</strong></span> and type the username and password.</li><li class="listitem">In server certificates, do one of the following:<div class="orderedlist"><ol class="orderedlist arabic"><li class="listitem">Select <span class="strong"><strong>Use System Generated Certificate</strong></span> to use a self signed certificate for authentication.</li><li class="listitem">Select the signed certificate to be used for authentication.</li></ol></div><p>
</p></li><li class="listitem">Click <span class="strong"><strong>OK</strong></span>:</li></ol></div><p>
</p><div class="mediaobject"><img src="graphics/B03244_05_52-1024x492.jpg" alt="Prerequisites"/></div><p>
</p><p>
<span class="strong"><strong>Listener IP</strong></span>: <span class="strong"><strong>192.168.9.1</strong></span></p><p><span class="strong"><strong>Listener Port</strong></span>: <span class="strong"><strong>443</strong></span></p><p><span class="strong"><strong>Encryption Algorithm</strong></span>: <span class="strong"><strong>AES256-SHA</strong></span></p><p><span class="strong"><strong>Internal Interface</strong></span>: <span class="strong"><strong>Internal Interface-A</strong></span></p><p><span class="strong"><strong>User Id</strong></span>: <span class="strong"><strong>vpn-user</strong></span></p><p><span class="strong"><strong>Server Certificate</strong></span>: <span class="strong"><strong>TEST.LOCAL</strong></span>
</p><p>To configure the L2-VPN client, all we need to update is the server address to which the client is supposed to be connected, and the internal interface that needs to be stretched. Apart from these details, the rest of the configuration is the same, and the L2 tunnel will be up and running after that</p><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc"><span class="strong"><strong>L2VPN Service Status</strong></span>: <span class="strong"><strong>Enabled</strong></span></li><li class="listitem" style="list-style-type: disc"><span class="strong"><strong>Server Address</strong></span>: <span class="strong"><strong>192.168.9.1</strong></span></li><li class="listitem" style="list-style-type: disc"><span class="strong"><strong>Server Port</strong></span>: <span class="strong"><strong>443</strong></span></li><li class="listitem" style="list-style-type: disc"><span class="strong"><strong>Internal Interface</strong></span>: <span class="strong"><strong>Internal Interface-B</strong></span></li><li class="listitem" style="list-style-type: disc"><span class="strong"><strong>User Id</strong></span>: <span class="strong"><strong>vpn-user</strong></span></li></ul></div></div></div><div class="section" title="Design decisions while configuring VPN"><div class="titlepage"><div><div><h2 class="title"><a id="ch05lvl2sec42"/>Design decisions while configuring VPN</h2></div></div></div><p>The following are a few key points we should be aware of while configuring the VPN:</p><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc">Route-based VPN is not supported, NSX Edge supports only policy-based VPN</li><li class="listitem" style="list-style-type: disc">We can have a maximum of 64 tunnels across a maximum of 10 sites</li><li class="listitem" style="list-style-type: disc">NAT-traversal is supported in VPN configuration</li><li class="listitem" style="list-style-type: disc">Overlapping of subnets is not allowed</li><li class="listitem" style="list-style-type: disc">Route summarization is supported for both peer and local subnets</li><li class="listitem" style="list-style-type: disc">Dynamic routing through IPsec tunnels is not supported</li><li class="listitem" style="list-style-type: disc">NSX Edge supports pre-shared key and certificate-based authentication.</li><li class="listitem" style="list-style-type: disc">There are a few exceptions with special characters in a pre-shared key that I have seen with a few third-party vendors. Hence, watch out for special characters.</li></ul></div><p>That concludes VPN key design decisions, and it is always advisable not to deviate and start configuring VPN from what the product doesn't support.</p></div><div class="section" title="DHCP relay"><div class="titlepage"><div><div><h2 class="title"><a id="ch05lvl2sec43"/>DHCP relay</h2></div></div></div><p>Dynamic Host Configuration Protocol automatically assigns an IP address. This is something we all know. But there is certainly a drawback with that model: the DHCP server and client should be on the same broadcast domain. In a nutshell, the DHCP relay agent relays DHCP messages between client and server on different networks. This is a new feature, which was added in <span class="strong"><strong>NSX 6.1</strong></span> and can be applied on <span class="strong"><strong>DLR or NSX Edge</strong></span>. In earlier versions of NSX and VCNS, we were limited to configuring traditional DHCP servers. It is important to know that we cannot have overlapping subnets. But what if we need the same IP every time a virtual machine boots? NSX DHCP static binding would do the trick in that case. We can simply bind the IP with the MAC of a virtual machine.</p></div></div>
<div class="section" title="Summary"><div class="titlepage"><div><div><h1 class="title"><a id="ch05lvl1sec46"/>Summary</h1></div></div></div><p>We started this chapter with an introduction to NSX Edge, and later, we covered routing protocols and NSX Edge services, use cases, and a few design considerations. This was certainly a lengthy topic, and the whole purpose of explaining the topics with a few labs and topologies was to make it as informative as possible. I strongly believe that in the near future, we will see lot of new features getting added to NSX Edge services. For example, NSX Edge being a Perimeter Device, we would be more than happy to see WAN acceleration features or Policy Based Routing.</p><p>With the skills that we have gained so far, we are good to start with our next chapter, on NSX security features and design decisions. We will have a close look at NSX security policies, groups, and a few use cases.</p></div></body></html>