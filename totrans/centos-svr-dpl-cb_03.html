<html><head></head><body><div class="chapter" title="Chapter&#xA0;3.&#xA0;User and Permission Management"><div class="titlepage"><div><div><h1 class="title"><a id="ch03"/>Chapter 3. User and Permission Management</h1></div></div></div><p>This chapter contains the following recipes:</p><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc">Escalating privileges with sudo</li><li class="listitem" style="list-style-type: disc">Enforcing password restrictions</li><li class="listitem" style="list-style-type: disc">Setting default permissions for new files and directories</li><li class="listitem" style="list-style-type: disc">Running binaries as a different user</li><li class="listitem" style="list-style-type: disc">Working with SELinux for greater security</li></ul></div><div class="section" title="Introduction"><div class="titlepage"><div><div><h1 class="title"><a id="ch03lvl1sec26"/>Introduction</h1></div></div></div><p>Each of the recipes in this chapter pertain to users and permissions. You'll learn how to let users temporarily escalate their privileges without requiring the root password and how to enforce complexity requirements for users. You'll also learn how to specify what access permissions are given to new files and directories by default and how the traditional Unix permission system can allow a program to run under a different security context than that of the user who launched it. Finally, we'll look at SELinux, a secondary permission system that hardens the security of your CentOS server.</p></div></div>
<div class="section" title="Escalating privileges with sudo"><div class="titlepage"><div><div><h1 class="title"><a id="ch03lvl1sec27"/>Escalating privileges with sudo</h1></div></div></div><p>The<code class="literal"> root</code> account is Linux's <span class="strong"><strong>god account</strong></span>, and it has the ability to perform pretty much any activity on the system. For security reasons, you should use an unprivileged user account for your day-to-day activities and use <code class="literal">root</code> only when it's necessary for administration tasks. It's also important to keep the root's password secret; the more people who know its password, the harder it is to keep it secret. A quote by Benjamin Franklin comes to mind: Three can keep a secret if two of them are dead.</p><p>If more than one administrator has been tasked with managing a system, keeping <code class="literal">root</code> secure can be difficult. <code class="literal">sudo</code> solves this problem by giving users a way to execute commands with the privileges of another user (most commonly <code class="literal">root</code>). Each of the administrator accounts can be configured using one of the methods presented in this recipe to escalate their privileges temporarily with <code class="literal">sudo</code>, and root's password can remain secret.</p><div class="section" title="Getting ready"><div class="titlepage"><div><div><h2 class="title"><a id="ch03lvl2sec73"/>Getting ready</h2></div></div></div><p>This recipe requires a CentOS system and administrative access provided by logging in with the <code class="literal">root</code> account. You'll also need one or two unprivileged user accounts to configure (refer to the <code class="literal">useradd</code> man page <code class="literal">man 8 useradd</code> for information on creating user accounts).</p></div><div class="section" title="How to do it..."><div class="titlepage"><div><div><h2 class="title"><a id="ch03lvl2sec74"/>How to do it...</h2></div></div></div><p>One way to allow an unprivileged account the use of <code class="literal">sudo</code> is to assign it a membership in the <code class="literal">wheel</code> group. This is done with the following steps:</p><div class="orderedlist"><ol class="orderedlist arabic"><li class="listitem">Use <code class="literal">usermod</code> to add the user account to <code class="literal">wheel</code>:<pre class="programlisting">
<span class="strong"><strong>usermod -a -G wheel tboronczyk</strong></span>
</pre></li><li class="listitem">Verify the update using the <code class="literal">groups</code> command. <code class="literal">wheel</code> should list one of the groups which the account is a member of:<pre class="programlisting">
<span class="strong"><strong>groups tboronczyk</strong></span>
</pre></li></ol></div><p>Another way to grant access to <code class="literal">sudo</code> is by configuring the sudoers policy which identifies which accounts can use <code class="literal">sudo</code> and in what manner. You can easily add an account to the policy with the following steps:</p><div class="orderedlist"><ol class="orderedlist arabic"><li class="listitem">Create a new file in the <code class="literal">/etc/sudoers.d</code> directory named after the user account:<pre class="programlisting">
<span class="strong"><strong>touch /etc/sudoers.d/tboronczyk</strong></span>
</pre></li><li class="listitem">Open the file and add the following directive. When finished, save your update and close the file:<pre class="programlisting">
<span class="strong"><strong>tboronczyk ALL = ALL</strong></span>
</pre></li></ol></div></div><div class="section" title="How it works..."><div class="titlepage"><div><div><h2 class="title"><a id="ch03lvl2sec75"/>How it works...</h2></div></div></div><p>For a user to use the <code class="literal">sudo</code> command they must be somehow listed in the sudoers policy. This is checked by <code class="literal">sudo</code> to verify whether the account is authorized to perform the attempted action. This recipe presented two ways of accomplishing this: by assigning the user account to the <code class="literal">wheel</code> group (which is already registered in the policy) or by adding the account directly to the policy.</p><p>In the first approach, the <code class="literal">usermod</code> command assigns the user membership in <code class="literal">wheel</code>. The <code class="literal">-G</code> option specifies the name of the group and <code class="literal">-a</code> instructs <code class="literal">usermod</code> to add the user to that group. It's important that you provide <code class="literal">-a</code> since without it the list of assigned groups is overwritten with only what is given with <code class="literal">-G</code> (that is, the account would belong only to <code class="literal">wheel</code>).</p><pre class="programlisting">
<span class="strong"><strong>usermod -a -G wheel tboronczyk</strong></span>
</pre><p>The second approach registers the account with the sudoers policy by creating a file for the user under <code class="literal">/etc/sudoers.d</code>. We alternatively could have added the user's information to the <code class="literal">/etc/sudoers</code> configuration file, but the policy already includes any files found in the <code class="literal">sudoers.d</code> directory as part of its configuration. Creating a file for each user in the directory will be more manageable given a large number of users when it is time to revoke access.</p><p>Both approaches allow a user the use of <code class="literal">sudo</code> to execute commands they wouldn't ordinarily have sufficient rights to. For example:</p><pre class="programlisting">
<span class="strong"><strong>sudo umount /media</strong></span>
</pre><p>The first time a user invokes <code class="literal">sudo</code>, a message is displayed that reminds them to be responsible with their new-found power. The user must provide their password to verify their identity; the verification is cached for five minutes from the last invocation as an extra bit of protection against malicious users who might walk up to a terminal that was carelessly left logged in.</p><div class="mediaobject"><img alt="How it works..." src="graphics/image_03_001.jpg"/><div class="caption"><p>sudo reminds the user that with great power comes great responsibly</p></div></div><p>The sudoers policy is flexible enough to allow a user account to execute certain commands instead of giving carte blanche access. Recall the configuration directive for our unprivileged user account:</p><pre class="programlisting">
<span class="strong"><strong>tboronczyk ALL = ALL</strong></span>
</pre><p>The username is specified followed by assigning the <code class="literal">ALL</code> alias to <code class="literal">ALL</code>. As you might determine by looking at this, <code class="literal">ALL</code> is the predefined alias that represents all commands. We can redefine the alias for the given user as a list of allowed commands:</p><pre class="programlisting">
<span class="strong"><strong>tboronczyk ALL = /bin/mount /bin/umount</strong></span>
</pre><p>Now the account can invoke any command it normally has access to, but only the <code class="literal">mount</code> and <code class="literal">umount</code> commands with elevated privileges (assuming the account isn't a member of <code class="literal">wheel</code>).</p><div class="note" style="" title="Note"><div class="inner"><h3 class="title"><a id="tip17"/>Tip</h3><p>Are you tired of typing <code class="literal">sudo</code> before your commonly-used administrative commands? You can create aliases for a smoother command line experience. Suppose your unprivileged account is allowed to use the <code class="literal">mount</code> and <code class="literal">umount</code> commands with <code class="literal">sudo</code>. Adding the following lines to your <code class="literal">~/.bashrc</code> file will let you invoke them commands without explicitly typing <code class="literal">sudo</code>:</p><p>
</p><pre class="programlisting"><span class="strong"><strong>alias mount sudo /bin/mount</strong></span>
<span class="strong"><strong>alias umount sudo /bin/umount</strong></span>
</pre><p>
</p></div></div><p>Multiple directives in the policy can apply to an account in which case they are applied additively, first to last. To see this in action, suppose an account already has full <code class="literal">sudo</code> usage by assignment in the <code class="literal">wheel</code> group. By default, the user needs to provide their password to execute a command. We can relax this requirement and allow the user to use <code class="literal">ls</code> to display the contents of restricted directories without a password:</p><pre class="programlisting">
<span class="strong"><strong>tboronczyk ALL = NOPASSWD: /bin/ls</strong></span>
</pre><p>The <code class="literal">wheel</code> group's policy is applied first, establishing the default behavior. Then our new directive uses the <code class="literal">NOPASSWD</code> tag to grant the user unauthenticated access to the <code class="literal">ls</code> command. The user will still need to provide their password for commands such as <code class="literal">mount</code> and <code class="literal">passwd</code> but won't need to provide it to list restricted directories.</p></div><div class="section" title="See also"><div class="titlepage"><div><div><h2 class="title"><a id="ch03lvl2sec76"/>See also</h2></div></div></div><p>Refer to the following resources for more information on working with <code class="literal">sudo</code> to temporarily elevate an account's privileges:</p><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc">The <code class="literal">sudo</code> man page (<code class="literal">man 8 sudo</code>)</li><li class="listitem" style="list-style-type: disc">The <code class="literal">sudoers</code> man page (<code class="literal">man 5 sudoers</code>)</li><li class="listitem" style="list-style-type: disc">Code Snipcademy: Using <code class="literal">sudo</code> and <code class="literal">su</code> and their differences (<a class="ulink" href="https://code.snipcademy.com/tutorials/linux-command-line/permissions/sudo">https://code.snipcademy.com/tutorials/linux-command-line/permissions/sudo</a>)</li></ul></div></div></div>
<div class="section" title="Enforcing password restrictions"><div class="titlepage"><div><div><h1 class="title"><a id="ch03lvl1sec28"/>Enforcing password restrictions</h1></div></div></div><p>A weak password can be one of the weakest security points of any system. Simple passwords are susceptible to brute-force attacks and long-lived passwords, if they are compromised, provide a wide window of opportunity for malicious activity. Because of this, it's important to ensure that your users choose sufficiently complex passwords and change them regularly. This recipe shows you how to strengthen your system's security by enforcing various restrictions on users' passwords. You'll learn how to specify the minimum complexity requirements for a password, how long before a password must be changed, and how to lock down an account after a number of failed login attempts.</p><div class="section" title="Getting ready"><div class="titlepage"><div><div><h2 class="title"><a id="ch03lvl2sec77"/>Getting ready</h2></div></div></div><p>This recipe requires a CentOS system and administrative access, either provided by logging in with the <code class="literal">root</code> account or by using <code class="literal">sudo</code>.</p></div><div class="section" title="How to do it..."><div class="titlepage"><div><div><h2 class="title"><a id="ch03lvl2sec78"/>How to do it...</h2></div></div></div><p>Follow these steps to enforce password restrictions that will increase the security of your CentOS system:</p><div class="orderedlist"><ol class="orderedlist arabic"><li class="listitem">The parameters governing password aging are found in <code class="literal">/etc/login.defs</code>; open the file using your text editor of choice:<pre class="programlisting">
<span class="strong"><strong>vi /etc/login.defs</strong></span>
</pre></li><li class="listitem">Locate the password aging controls section and update the value of <code class="literal">PASS_MAX_DAYS</code>, <code class="literal">PASS_MIN_DAYS</code>, <code class="literal">PASS_MIN_LEN</code>, and <code class="literal">PASS_WARN_AGE</code>:<pre class="programlisting">
<span class="strong"><strong>PASS_MAX_DAYS  90</strong></span>
<span class="strong"><strong>PASS_MIN_DAYS  0</strong></span>
<span class="strong"><strong>PASS_MIN_LEN   8</strong></span>
<span class="strong"><strong>PASS_WARN_AGE  15</strong></span>
</pre></li><li class="listitem">Save your changes and close the file.</li><li class="listitem">The values specified in <code class="literal">login.defs</code> will be applied to new accounts when they are created. Existing users must have their password parameters set separately using the <code class="literal">chage</code> command:<pre class="programlisting">
<span class="strong"><strong>chage --maxdays 90 --mindays 0 --warndays 15 tboronczyk</strong></span>
</pre></li><li class="listitem">The parameters governing the acceptable complexity for passwords are found in <code class="literal">/etc/security/pwquality.conf</code>; open the file for editing:<pre class="programlisting">
<span class="strong"><strong>vi /etc/security/pwquality.conf</strong></span>
</pre></li><li class="listitem">Uncomment the <code class="literal">minlen</code> value to specify the desired minimum password complexity plus 1. For example, an eight-character password consisting of all lowercase characters would require a <code class="literal">minlen</code> of <code class="literal">9</code>:<pre class="programlisting">
<span class="strong"><strong>minlen = 9</strong></span>
</pre></li><li class="listitem">You may uncomment other values and set them as well if you like. Each value is preceded by a brief descriptive comment of what it does. To require a minimum number of characters to be from a certain class (uppercase, lowercase, digits, and other/special), specify the value as a negative number. For example, if passwords require at least one numeric digit and one uppercase character then both <code class="literal">dcredit</code> and <code class="literal">ucredit</code> would be set to <code class="literal">-1</code>:<div class="mediaobject"><img alt="How to do it..." src="graphics/image_03_002.jpg"/><div class="caption"><p>Options for configuring your system's password complexity requirements are found in pwquality.conf</p></div></div></li><li class="listitem">Save your changes and close the file.</li><li class="listitem">Next we'll update PAM's <code class="literal">password-auth</code> and <code class="literal">system-auth</code> module configurations to lock out an account after a number of unsuccessful login-attempts. Open the file <code class="literal">/etc/pam.d/password-auth</code>:<pre class="programlisting">
<span class="strong"><strong>vi /etc/pam.d/password-auth</strong></span>
</pre></li><li class="listitem">Update the group of <code class="literal">auth</code> lines at the beginning of the file to read as follows. The second and fourth lines have been added and include <code class="literal">pam_faillock</code> to the authentication stack:<pre class="programlisting">
<span class="strong"><strong>auth   required      pam_env.so</strong></span>
<span class="strong"><strong>auth   required      pam_faillock.so preauth silent audit  deny=3  &#13;
       unlock_time=600</strong></span>
<span class="strong"><strong>auth   sufficient    pam_unix.so nullok try_first_pass</strong></span>
<span class="strong"><strong>auth   [default=die] pam_faillock.so authfail audit deny=3  &#13;
       unlock_time=600</strong></span>
<span class="strong"><strong>auth   requisite     pam_succeed_if.so uid &gt;= 1000  quiet_success</strong></span>
<span class="strong"><strong>auth   required      pam_deny.so</strong></span>
</pre></li><li class="listitem">Update the group of <code class="literal">account</code> lines to read as follows. The second line has been added to include <code class="literal">pam_faillock</code> to the account stack:<pre class="programlisting">
<span class="strong"><strong>account  required   pam_unix.so</strong></span>
<span class="strong"><strong>account  required   pam_faillock.so</strong></span>
<span class="strong"><strong>account  sufficient pam_localuser.com</strong></span>
<span class="strong"><strong>account  sufficient pam_succeed_if.so uid &lt; 1000 quiet</strong></span>
<span class="strong"><strong>account  required   pam_permit.so</strong></span>
</pre><div class="note" style="" title="Note"><div class="inner"><h3 class="title"><a id="note18"/>Note</h3><p>Be careful when updating the <code class="literal">password-auth</code> and <code class="literal">system-auth</code> files. The order in which modules are listed in a stack is significant!</p></div></div></li><li class="listitem">Save your changes and close the file. Then repeat steps 9 to 11 with the file <code class="literal">/etc/pam.d/system-auth</code>.</li></ol></div></div><div class="section" title="How it works..."><div class="titlepage"><div><div><h2 class="title"><a id="ch03lvl2sec79"/>How it works...</h2></div></div></div><p>Properly configuring the authentication requirements for local accounts is a bit of a fractured experience. First, there's the traditional Unix password files (<code class="literal">/etc/passwd</code> and <code class="literal">/etc/groups</code>) and the <code class="literal">shadow-utils</code> package, which adds shadowing support (<code class="literal">/etc/shadow</code>). Together, these form the core database for local account credentials. In addition, similar to most other modern Linux systems, CentOS uses PAM, a collection of pluggable authentication modules. The PAM stack is configured by default to lookup account information in the shadow file, but it also provides additional functionality that PAM-aware programs can leverage, such as password-strength checking. As an administrator, you're responsible for configuring these services so that they work properly in tandem and operate within the acceptable security guidelines set by your organization.</p><p>In this recipe, we first updated the password aging related controls found in <code class="literal">/etc/logins.def</code>:</p><pre class="programlisting">
<span class="strong"><strong>PASS_MAX_DAYS  90</strong></span>
<span class="strong"><strong>PASS_MIN_DAYS  0</strong></span>
<span class="strong"><strong>PASS_MIN_LEN   8</strong></span>
<span class="strong"><strong>PASS_WARN_AGE  15</strong></span>
</pre><p><code class="literal">PASS_MAX_DAYS</code> defines how much time can pass before a password must be changed. By setting the value to <code class="literal">90</code>, a user must change their password at least once every three months (90 days). <code class="literal">PASS_MIN_DAYS</code> specifies how many days a user must wait to change a new password. Since this value is 0, a user can change their password any time they want-even several times a day if they like. <code class="literal">PASS_WARN_AGE</code> defines how many days in advance a user will be notified of their password's pending expiration as <code class="literal">PASS_MAX_DAYS</code> approaches.</p><div class="note" style="" title="Note"><div class="inner"><h3 class="title"><a id="note19"/>Note</h3><p><code class="literal">PASS_MIN_LEN</code> is supposed to set the minimum password length, but you'll find PAM's password complexity requirements supersede this, making the setting pretty much worthless.</p></div></div><p>Utilities such as <code class="literal">useradd</code> use these settings as the defaults when creating entries in the password and shadow files. They aren't applied retroactively to existing users so we need to use <code class="literal">chage</code> to update their accounts:</p><pre class="programlisting">
<span class="strong"><strong>chage --maxdays 90 --mindays 0 --warndays 15 tboronczyk</strong></span>
</pre><p><code class="literal">chage</code> can set the minimum and maximum age of a user's password and the notification window for pending expirations, but note the absence of a minimum length requirement.</p><p>We can also use <code class="literal">chage</code> to make a user's password expire immediately so that they must specify a new one the next time they log in. To do so, we provide the <code class="literal">--lastdays</code> argument with a value of 0:</p><pre class="programlisting">
<span class="strong"><strong>chage --lastdays 0 tboronczyk</strong></span>
</pre><div class="note" style="" title="Note"><div class="inner"><h3 class="title"><a id="tip20"/>Tip</h3><p>If you have more than a handful of accounts, you may want to automate using <code class="literal">chage</code> with some basic shell scripting. Here's a series of commands piped together that update all of the existing user accounts in an automated fashion:</p><p>
</p><pre class="programlisting"><span class="strong"><strong>getent shadow | awk -F : 'substr($2, 0, 1) == "$" { print $1 }' | xargs -n 1 chage --maxdays 90 --mindays 0  </strong></span>
<span class="strong"><strong>--warndays 15</strong></span>
</pre><p>
</p><p>This works by retrieving the contents of the shadow file and using <code class="literal">awk</code> to split each record using <code class="literal">:</code> as the field separator. <code class="literal">awk</code> looks at the value in the second field (the encrypted password) to see if it begins with <code class="literal">$</code>, indicating the account has a password, to filter out disabled accounts and system accounts without a password. The username from each matching record is then piped to <code class="literal">xargs</code> which then feeds the names one at a time to <code class="literal">chage</code>.</p></div></div><p>As the PAM module <code class="literal">pam_pwquality</code> checks the complexity of passwords, we specify our password complexity requirements in the module's configuration file, <code class="literal">/etc/security/pwquality.conf</code>. It gauges the quality of a password using a credit system where each character credits a point towards the password's total score. This score then must meet or exceed the value we gave for <code class="literal">minlen</code>.</p><p>The page at <a class="ulink" href="http://wpollock.com/AUnix2/PAM-Help.htm">http://wpollock.com/AUnix2/PAM-Help.htm</a> has a good explanation of how <code class="literal">pam_pwquality</code> calculates a password's complexity. It explains the algorithm as follows:</p><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc">Add one for each character in the password regardless of the type of the character</li><li class="listitem" style="list-style-type: disc">Add one to that for each lowercase letter used, up to a maximum of <code class="literal">lcredit</code></li><li class="listitem" style="list-style-type: disc">Add one to that for each uppercase letter used, up to a maximum of <code class="literal">ucredit</code></li><li class="listitem" style="list-style-type: disc">Add one to that for each digit used, up to a maximum of <code class="literal">dcredit</code></li><li class="listitem" style="list-style-type: disc">Add one to that for each symbol used, up to a maximum of <code class="literal">ocredit</code></li></ul></div><p>The page also presents a few complexity calculations for different passwords and is worth reading.</p><p>Then we updated the <code class="literal">password-auth</code> and <code class="literal">system-auth</code> files to lock a user's account after three unsuccessful login attempts. Different authentication stacks need to be configured because different login methods will invoke a different authentication stack (that is, a logging in over SSH as opposed to logging in locally):</p><pre class="programlisting">
<span class="strong"><strong>auth   required      pam_env.so</strong></span>
<span class="strong"><strong>auth   required      pam_faillock.so preauth silent audit deny=3    &#13;
    unlock_time=600</strong></span>
<span class="strong"><strong>auth   sufficient    pam_unix.so nullok try_first_pass</strong></span>
<span class="strong"><strong>auth   [default=die] pam_faillock.so authfail audit deny=3&#13;
    unlock_time=600</strong></span>
<span class="strong"><strong>auth   requisite     pam_succeed_if.so uid &gt;= 1000 quiet_success</strong></span>
<span class="strong"><strong>auth   required      pam_deny.so</strong></span>
<span class="strong"><strong>account  required   pam_unix.so</strong></span>
<span class="strong"><strong>account  required   pam_faillock.so</strong></span>
<span class="strong"><strong>account  sufficient pam_localuser.com</strong></span>
<span class="strong"><strong>account  sufficient pam_succeed_if.so uid &lt; 1000 quiet</strong></span>
<span class="strong"><strong>account  required   pam_permit.so</strong></span>
</pre><p>The <code class="literal">pam_faillock</code> module is added at multiple positions in the authentication stack. The first appearance in the <code class="literal">auth</code> block performs a precheck (<code class="literal">preauth</code>) to see if the account is already locked out The second appearance tallies the failed attempt (<code class="literal">authfail</code>). The argument specified by <code class="literal">deny</code> is the number of failed attempts permitted before locking the account. <code class="literal">unlock_time</code> specifies how much time the module should wait (in seconds) before unlocking the account so that another login attempt can be made. As the example specifies 600 seconds, a user will have to wait 10 minutes for the lockout to expire. The module's appearance in the <code class="literal">account</code> block denies authentication to the locked account.</p><p>The <code class="literal">faillock</code> command is used to view the number of failed login attempts and to unlock an account. To see the failed attempts, invoke the command using the <code class="literal">--user</code> argument to specify the account's username:</p><pre class="programlisting">
<span class="strong"><strong>faillock --user tboronczyk</strong></span>
</pre><p>To manually unlock the account before <code class="literal">unlock_time</code> has elapsed, invoke the command with the <code class="literal">--reset</code> argument:</p><pre class="programlisting">
<span class="strong"><strong>faillock --user tboronczyk --reset</strong></span>
</pre></div><div class="section" title="See also"><div class="titlepage"><div><div><h2 class="title"><a id="ch03lvl2sec80"/>See also</h2></div></div></div><p>Refer to the following resources for more information on how user accounts are authenticated and how to enforce password restrictions:</p><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc">The <code class="literal">chage</code> man page (<code class="literal">man 1 chage</code>)</li><li class="listitem" style="list-style-type: disc">The shadow file man page (<code class="literal">man 5 shadow</code>)</li><li class="listitem" style="list-style-type: disc">The <code class="literal">pam_faillock</code> man page (<code class="literal">man 8 pam_faillock</code>)</li><li class="listitem" style="list-style-type: disc">Linux Documentation Project: Putting the Shadow suite to use (<a class="ulink" href="http://tldp.org/HOWTO/Shadow-Password-HOWTO-7.html">http://tldp.org/HOWTO/Shadow-Password-HOWTO-7.html</a>)</li><li class="listitem" style="list-style-type: disc">The Linux-PAM System Administrator's Guide (<a class="ulink" href="http://www.linux-pam.org/Linux-PAM-html/Linux-PAM_SAG.html">http://www.linux-pam.org/Linux-PAM-html/Linux-PAM_SAG.html</a>)</li><li class="listitem" style="list-style-type: disc">RHEL Security Guide: Password Security (<a class="ulink" href="https://access.redhat.com/documentation/en-US/Red_Hat_Enterprise_Linux/7/html-single/Security_Guide/index.html#sec-Password_Security">https://access.redhat.com/documentation/en-US/Red_Hat_Enterprise_Linux/7/html-single/Security_Guide/index.html#sec-Password_Security</a>)</li></ul></div></div></div>
<div class="section" title="Setting default permissions for new files and directories"><div class="titlepage"><div><div><h1 class="title"><a id="ch03lvl1sec29"/>Setting default permissions for new files and directories</h1></div></div></div><p>Linux's permissions system governs whether a user can enter a directory or read, write, or execute a file. By setting the permission bits on files and directories, access can be granted or revoked to different users and groups of users. However, it's possible for a user to create a file and expect others in their group to access it, but the initial file permissions prevents this. To help avoid this situation, this recipe teaches you how to set the default permissions for new files and directories by specifying a mask value.</p><div class="section" title="Getting ready"><div class="titlepage"><div><div><h2 class="title"><a id="ch03lvl2sec81"/>Getting ready</h2></div></div></div><p>This recipe requires a CentOS system and administrative access, either provided by logging in with the <code class="literal">root</code> account or by using <code class="literal">sudo</code>.</p></div><div class="section" title="How to do it..."><div class="titlepage"><div><div><h2 class="title"><a id="ch03lvl2sec82"/>How to do it...</h2></div></div></div><p>Follow these steps to specify the default permissions for new files and directories:</p><div class="orderedlist"><ol class="orderedlist arabic"><li class="listitem">To set the mask value globally, open the <code class="literal">/etc/profile</code> file:<pre class="programlisting">
<span class="strong"><strong>vi /etc/profile</strong></span>
</pre></li><li class="listitem">At the end of the file, add the following directive (adjusting the value as desired). When finished, save and close the file:<pre class="programlisting">
<span class="strong"><strong>umask 0007</strong></span>
</pre></li><li class="listitem">To override the global mask and set the mask on a per-user basis, open the user's <code class="literal">~/.bashrc</code> file:<pre class="programlisting">
<span class="strong"><strong>vi /home/tboronczyk/.bashrc</strong></span>
</pre></li><li class="listitem">At the end of the file, add the following (again adjusting the value as necessary). Then save and close the file:<pre class="programlisting">
<span class="strong"><strong>umask 0007</strong></span>
</pre></li><li class="listitem">To temporarily set the mask only for the duration of your session, execute the <code class="literal">umask</code> command at the command prompt:<pre class="programlisting">
<span class="strong"><strong>umask 0007</strong></span>
</pre><div class="note" style="" title="Note"><div class="inner"><h3 class="title"><a id="note21"/>Note</h3><p>You can execute <code class="literal">umask</code> at the command prompt without providing a mask value to see what your current mask value is.</p></div></div></li></ol></div></div><div class="section" title="How it works..."><div class="titlepage"><div><div><h2 class="title"><a id="ch03lvl2sec83"/>How it works...</h2></div></div></div><p>This recipe presents three ways a mask value can be set, which is responsible for determining what permissions are set on newly created files and directories. However, to understand how the mask works, you need to understand the traditional read, write, and execute permission system.</p><p>Directories and files in the Linux file system are owned by a user and group, and they are assigned a set of permissions that describe who can access it. When a user tries to access a resource, the system compares its ownership information with requesting user and determines if the requested access should be granted according to the permissions.</p><p>The three permissions are read, write, and execute. Since access to each can be only one of the two values (allowed or disallowed), and because such binary options can be represented with 1 for yes and 0 for no, a sequence of 1's and 0's can be viewed as a bit pattern where each permission is given a different position in the sequence. The following figure shows how a list of binary yes's and no's can be converted to a human-friendly value:</p><div class="mediaobject"><img alt="How it works..." src="graphics/image_03_003.jpg"/><div class="caption"><p>Binary values represent whether a user has permission to access a resource</p></div></div><p>From the file or directory's perspective, there are three types of users. The user is either the file's owner, a member of the owning group, or neither (everyone else).</p><p>The resource is given a set of permissions for each type of users, as shown in the following figure:</p><div class="mediaobject"><img alt="How it works..." src="graphics/image_03_004.jpg"/><div class="caption"><p>The full permission set of a file or directory includes the three types of users</p></div></div><p>This is the logic behind the traditional Unix permission system, but don't worry if this seems intimidating at first. Determining the permissions for a class of users is really just a matter of addition. Start with 0 for no access at all. To allow read access, add <code class="literal">4</code>. For write access, add <code class="literal">2</code>. For execute, add <code class="literal">1</code>. These values come from viewing the value of the permission in the bit string as a binary number, but they are easy enough to memorize. Thus, to allow all access, we add <code class="literal">4</code> + <code class="literal">2</code> + <code class="literal">1</code> which equals <code class="literal">7</code>. To allow only read and execute access, <code class="literal">
4
</code> + <code class="literal">1</code> equals <code class="literal">5</code>. The more you work with permissions, the more you'll come to recognize certain combinations automatically.</p><p>When a file is created, the system begins with <code class="literal">666</code> as a default value, giving read and write access to all three classes of users. Directories start with <code class="literal">777</code> since the executable permission on a directory is what allows a user to traverse into it. The system then subtracts the creating user's umask value and the result determines what permissions will be assigned to the resource when it's created.</p><p>Suppose we create a new directory and our umask value is <code class="literal">0027</code>. The system subtracts <code class="literal">7</code> from the all other users' field and <code class="literal">2</code> from the group's field. <code class="literal">7</code> - <code class="literal">7</code> is <code class="literal">0</code>, and <code class="literal">7</code> - <code class="literal">2</code> is <code class="literal">5</code>, so the default permission for a new directory is <code class="literal">750</code>.</p><p>Because we start with one bit less in the default value for files, it's possible to end up with a negative permission number. If umask masks out all of the permissions using the value <code class="literal">7</code>, but the starting value is <code class="literal">666</code> for files, <code class="literal">6</code> - <code class="literal">7</code> gives <code class="literal">-1</code>. It doesn't make sense to go beyond 0 so the system treats it as 0. So, a mask of <code class="literal">0027</code> gives us <code class="literal">650</code> for the file's permissions.</p><p>The <code class="literal">/etc/profile</code> and <code class="literal">~/.bashrc</code> files are executed whenever a user logs in to configure their session's environment. Calling <code class="literal">umask</code> in <code class="literal">profile</code> has the effect of setting the mask for all users. <code class="literal">.bashrc</code> is executed after <code class="literal">profile</code> and is user specific; so, its call to <code class="literal">umask</code> overrides the previously set value, setting the mask for that specific user.</p></div><div class="section" title="See also"><div class="titlepage"><div><div><h2 class="title"><a id="ch03lvl2sec84"/>See also</h2></div></div></div><p>Refer to the following resources for more information about umask:</p><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc">Wikipedia: Umask (<a class="ulink" href="http://unix.stackexchange.com/questions/102075/why-are-666-the-default-file-creation-permissions">http://unix.stackexchange.com/questions/102075/why-are-666-the-default-file-creation-permissions</a>)</li><li class="listitem" style="list-style-type: disc">Why are 666 the default file creation permissions? (<a class="ulink" href="https://en.wikipedia.org/wiki/Umask">https://en.wikipedia.org/wiki/Umask</a>)</li><li class="listitem" style="list-style-type: disc">Controlling file permissions with umask (<a class="ulink" href="http://linuxzoo.net/page/sec_umask.html">http://linuxzoo.net/page/sec_umask.html</a>)</li></ul></div></div></div>
<div class="section" title="Running binaries as a different user"><div class="titlepage"><div><div><h1 class="title"><a id="ch03lvl1sec30"/>Running binaries as a different user</h1></div></div></div><p>Every program on CentOS runs within the environment of a user account regardless of whether the program is executed by a user or run as an automated system process. However, sometimes we want the program to run with different restrictions and access those rights the account is allowed. For example, a user should be able to use the <code class="literal">passwd</code> command to reset their password. The command needs write access to <code class="literal">/etc/passwd</code> but we don't want the user running the command to have such access. This recipe teaches you how setting a program's SUID and SGID permission bits allows it to execute within the environment of a different user.</p><div class="section" title="Getting ready"><div class="titlepage"><div><div><h2 class="title"><a id="ch03lvl2sec85"/>Getting ready</h2></div></div></div><p>This recipe requires a CentOS system. Administrative privileges are also required, either by logging in with the <code class="literal">root</code> account or by the use of <code class="literal">sudo</code>.</p></div><div class="section" title="How to do it..."><div class="titlepage"><div><div><h2 class="title"><a id="ch03lvl2sec86"/>How to do it...</h2></div></div></div><p>Follow these steps to allow a program to execute as a different user:</p><div class="orderedlist"><ol class="orderedlist arabic"><li class="listitem">Identify the file's owner and group details using the <code class="literal">ls</code> command. The third field in its output lists the owner and the fourth field lists the group:<pre class="programlisting">
<span class="strong"><strong>ls -l myscript.sh</strong></span>
</pre><div class="mediaobject"><img alt="How to do it..." src="graphics/image_03_005.jpg"/><div class="caption"><p>The -l option displays the file listing in long-form which includes ownership information</p></div></div></li><li class="listitem">If necessary, change the file's ownership using <code class="literal">chown</code> so that the owner is the one whose environment you want the script to execute in:<pre class="programlisting">
<span class="strong"><strong>chown newuser:newgroup myscript.sh</strong></span>
</pre></li><li class="listitem">Set the SUID bit to allow the program to run as if it were invoked by its owner:<pre class="programlisting">
<span class="strong"><strong>chmod u+s myscript.sh</strong></span>
</pre></li><li class="listitem">Set the SGID bit to allow the program to run as if it were invoked by a member of its group:<pre class="programlisting">
<span class="strong"><strong>chmod g+s myscript.sh</strong></span>
</pre></li></ol></div></div><div class="section" title="How it works..."><div class="titlepage"><div><div><h2 class="title"><a id="ch03lvl2sec87"/>How it works...</h2></div></div></div><p>When a file's SUID and SGID bits are set, the program runs within the environment of its owner or group instead of the user who invoked it. This is usually done with administrative programs that an unprivileged user should have access to but the program itself requires administrative permissions to function properly.</p><p>The bits are set using <code class="literal">chown</code> with <code class="literal">u</code> set to target the SUID bit. A script with the SUID bit set will execute with the privileges its owner has. <code class="literal">g</code> is set to target the SGID bit which allows the script to execute with the privileges of a member of its group. Intuitively, <code class="literal">+</code> sets the bit and <code class="literal">-</code> removes the bit, later allowing the program to execute in the invoking user's environment.</p><pre class="programlisting">
<span class="strong"><strong>chmod u-s myscript.sh</strong></span>
<span class="strong"><strong>chmod g-s myscript.sh</strong></span>
</pre><p>SUID and SGID may be set numerically as well-the value for SUID is 4 and the value for SGID is 2. These can be summed together and appear as the left-most digit in the numeric permission value. For example, the following sets the SUID bit, the read, write, and execute bits for the file's owner; read, write, and execute bits for group members; and read and execute bits for everyone else:</p><pre class="programlisting">
<span class="strong"><strong>chmod 4775 myscript.sh</strong></span>
</pre><p>However, the numeric approach requires you to specify all of the file's permissions. If you need to do that and want to set the SUID or SGID bits at the same time, it's not a problem. Otherwise, it's probably more convenient to use <code class="literal">+</code> or <code class="literal">-</code> to add or subtract the indented bits.</p><p>Setting bits using mnemonic characters with <code class="literal">chmod</code> also works with the standard permissions. <code class="literal">u</code>, <code class="literal">g</code>, and <code class="literal">a</code> target the desired bits for its owner (u for user), group (g for group), and everybody else (a for all). The characters for read access is <code class="literal">r</code>, write <code class="literal">w</code>, and execute <code class="literal">x</code>. Here are a few examples using mnemonic characters:</p><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc">Allow the file's owner to execute the file:<pre class="programlisting">
<span class="strong"><strong>chmod o+x myscript.sh</strong></span>
</pre></li><li class="listitem" style="list-style-type: disc">Allow a group member to read the file:<pre class="programlisting">
<span class="strong"><strong>chmod g+r myfile.txt</strong></span>
</pre></li><li class="listitem" style="list-style-type: disc">Prevent everyone who is not the owner or a member of the group from writing to the file:<pre class="programlisting">
<span class="strong"><strong>chmod a-w readonly.txt</strong></span>
</pre></li></ul></div></div><div class="section" title="See also"><div class="titlepage"><div><div><h2 class="title"><a id="ch03lvl2sec88"/>See also</h2></div></div></div><p>Refer to the following resource for more information about <code class="literal">chmod</code> and setting the SUID and SGID bits.</p><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc">The <code class="literal">chmod</code> man page (<a class="ulink" href="https://linux.die.net/man/1/chmod">https://linux.die.net/man/1/chmod</a>)</li><li class="listitem" style="list-style-type: disc">How to set the SetUID and SetGID bit for files in Linux and Unix (<a class="ulink" href="http://linuxg.net/how-to-set-the-setuid-and-setgid-bit-for-files-in-linux-and-unix/">http://linuxg.net/how-to-set-the-setuid-and-setgid-bit-for-files-in-linux-and-unix/</a>)</li><li class="listitem" style="list-style-type: disc">Wikipedia: Setuid (<a class="ulink" href="https://en.wikipedia.org/wiki/Setuid">https://en.wikipedia.org/wiki/Setuid</a>)</li></ul></div></div></div>
<div class="section" title="Working with SELinux for greater security"><div class="titlepage"><div><div><h1 class="title"><a id="ch03lvl1sec31"/>Working with SELinux for greater security</h1></div></div></div><p>This recipe shows you the basics of working with Security-Enhanced Linux (SELinux), a kernel extension that adds an extra layer of security to your CentOS installation. Because it runs at the kernel level, SELinux can control access beyond the reach of the traditional filesystem permissions, including restricting running processes and other resources.</p><p>Unfortunately, some administrators disable SELinux because admittedly it can be a source of frustration. They're comfortable with the user/group/all and read/write/execute approach and suddenly find themselves at a loss when SELinux blocks something that seems as it should be available. However, the extra layer of security that SELinux provides is worth the effort of investigating such problems and adjusting its policies if necessary.</p><div class="section" title="Getting ready"><div class="titlepage"><div><div><h2 class="title"><a id="ch03lvl2sec89"/>Getting ready</h2></div></div></div><p>This recipe requires a CentOS system. Administrative privileges are also required, either by logging in with the <code class="literal">root</code> account or through the use of <code class="literal">sudo</code>. The demonstrated commands come from the <code class="literal">policycoreutils-python</code> package, so be sure to install the package first using the <code class="literal">yum install policycoreutils-python</code> command.</p></div><div class="section" title="How to do it..."><div class="titlepage"><div><div><h2 class="title"><a id="ch03lvl2sec90"/>How to do it...</h2></div></div></div><p>This collection of commands will introduce you to working with SELinux in various contexts, which are as follows:</p><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc">Use <code class="literal">sestatus</code> to verify whether SELinux is enabled and to see what policy is loaded:<div class="mediaobject"><img alt="How to do it..." src="graphics/image_03_006.jpg"/><div class="caption"><p>SELinux is enabled on this system and currently enforcing the targeted policy</p></div></div></li><li class="listitem" style="list-style-type: disc">Use <code class="literal">id -Z</code> to see which SELinux account, role, and domain your account is mapped to.</li><li class="listitem" style="list-style-type: disc">Use <code class="literal">ls -Z</code> to see the security context of a file or directory:<div class="mediaobject"><img alt="How to do it..." src="graphics/image_03_007.jpg"/><div class="caption"><p>Both id and ls can display security context related information</p></div></div></li><li class="listitem" style="list-style-type: disc">Use <code class="literal">semodule -l</code> to review the list of loaded policy modules in the current policy. The output can be quite lengthy and you may find it beneficial to paginate it using <code class="literal">less</code> or <code class="literal">more</code>:<pre class="programlisting">
<span class="strong"><strong>semodule -l | less</strong></span>
</pre></li><li class="listitem" style="list-style-type: disc">Use <code class="literal">semodule -d</code> and provide a module's name to disable a specific policy module:<pre class="programlisting">
<span class="strong"><strong>semodule -d mysql</strong></span>
</pre></li></ul></div><p>You can verify that the module is disabled by reviewing the list of policy modules with <code class="literal">semodule -l</code> again. The word <code class="literal">disabled</code> should appear to the right of the module name.</p><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc">Use <code class="literal">semodule -e</code> to enable a specific policy module:<pre class="programlisting">
<span class="strong"><strong>semodule -e mysql</strong></span>
</pre></li><li class="listitem" style="list-style-type: disc">Use <code class="literal">semanage boolean</code> to selectively enable or disable features of an active module. The <code class="literal">-l</code> argument outputs list of available features with their current and default values:<pre class="programlisting">
<span class="strong"><strong>semanage boolean -l | less</strong></span>
</pre></li><li class="listitem" style="list-style-type: disc">Use <code class="literal">-m</code> followed by <code class="literal">--on</code> or <code class="literal">--off</code> and the feature name to affect the desired feature:<pre class="programlisting">
<span class="strong"><strong>semanage boolean -m --on deny_ptrace</strong></span>
</pre><div class="mediaobject"><img alt="How to do it..." src="graphics/image_03_008.jpg"/><div class="caption"><p>semanage boolean -l shows which features of a policy module can be toggled on and off</p></div></div></li></ul></div></div><div class="section" title="How it works..."><div class="titlepage"><div><div><h2 class="title"><a id="ch03lvl2sec91"/>How it works...</h2></div></div></div><p>SELinux views the system in terms of objects, subjects, domains, and types. An object is any resource whether it's a file, directory, network port, memory space, and so on. A subject is anything that acts on an object, such as a user or a running program. A domain is the environment in which the subject operates, or in other words the collection of resources available to the subject. Types are simply categories that identify the purpose of an object. Within this framework, SELinux's security policies organize objects into roles and roles into domains.</p><p>Domains are granted or denied access to types. A user is allowed to open a specific file, for example, because they belong to a role in a domain that has permission to open that type of object. To decide whether a user has the ability to do something, SELinux maps the system's user accounts to one of the users (and roles and domains) in its own database. By default, accounts map to SELinux's <code class="literal">unconfined_u</code> user which is assigned the <code class="literal">unconfined_r</code> role and operates in the <code class="literal">unconfined_t</code> domain.</p><p>This recipe showed us that <code class="literal">id -Z</code> can be used to retrieve the user, role, and domain that our user account maps to and <code class="literal">ls -Z</code> retrieves a file's security labeling. Of course, the values displayed by the commands are different depending on the file. For example, the binary file <code class="literal">/bin/cp</code> executes as the <code class="literal">system_u</code> user, is a member of the <code class="literal">object_r</code> role, and is in the <code class="literal">bin_t</code> domain.</p><p>The <code class="literal">sestatus</code> command outputs basic status information about SELinux, such as whether it's enabled, enforcing its policies, and how it's enforcing them. SELinux can run in enforcing mode, in which it actively enforces its policies, or in permissive mode, in which it will not prevent any actions but will log a message if an action would have been prevented by the policy. You can set SELinux to permissive mode with <code class="literal">setenforce 0</code>.</p><p>The <code class="literal">semodule</code> command is used to manage policy modules. For the sake of keeping everything organized, a policy is a collection of modules and each module is concerned with a specific program or activity. There are dedicated modules for the most common applications, such as MySQL, Apache HTTP server, and SSHd, which describe which domains have access to which types. This recipe showed us how we can enable or disable these modules using the <code class="literal">-e</code> and <code class="literal">-d</code> arguments to <code class="literal">semodule</code>:</p><pre class="programlisting">
<span class="strong"><strong>semodule -d mysql</strong></span>
<span class="strong"><strong>semodule -e mysql</strong></span>
</pre><p>Finally, the recipe presented the <code class="literal">semanage</code> command, which manages various aspects of SELinux. We saw its <code class="literal">boolean</code> subcommand, using it to list the specific protections we can toggle on or off.</p><p>It probably goes without saying that while SELinux does a great job in protecting your system by adding an extra layer of access controls, fully understanding it and writing custom policies is a serious undertaking. Entire books have been written on this subject and there is a plethora of resources available online. The SELinux Users and Administrator's Guide that is part of the Red Hat Enterprise Linux 7 documentation and a three-part series introducing the basic concepts of SELinux by DigitalOcean are great starting points, and I've listed their URLs here. I also recommend the book <span class="emphasis"><em>SELinux by Example: Using Security Enhanced Linux</em></span> by David Caplan, Karl MacMillan, and Frank Mayer.</p></div><div class="section" title="See also"><div class="titlepage"><div><div><h2 class="title"><a id="ch03lvl2sec92"/>See also</h2></div></div></div><p>Refer to the following resources for more information on working with and better understanding SELinux:</p><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc">Wikipedia: Security-Enhanced Linux (<a class="ulink" href="https://en.wikipedia.org/wiki/Security-Enhanced_Linux">https://en.wikipedia.org/wiki/Security-Enhanced_Linux</a>)</li><li class="listitem" style="list-style-type: disc">SELinux Project Wiki (<a class="ulink" href="http://selinuxproject.org/page/Main_Page">http://selinuxproject.org/page/Main_Page</a>)</li><li class="listitem" style="list-style-type: disc">RHEL7 SELinux User's and Administrator's Guide (<a class="ulink" href="https://access.redhat.com/documentation/en-US/Red_Hat_Enterprise_Linux/7/html/SELinux_Users_and_Administrators_Guide/part_I-SELinux.html">https://access.redhat.com/documentation/en-US/Red_Hat_Enterprise_Linux/7/html/SELinux_Users_and_Administrators_Guide/part_I-SELinux.html</a>)</li><li class="listitem" style="list-style-type: disc">CentOS Wiki: SELinux (<a class="ulink" href="http://wiki.centos.org/HowTos/SELinux">http://wiki.centos.org/HowTos/SELinux</a>)</li><li class="listitem" style="list-style-type: disc">An Introduction to SELinux on CentOS 7 (<a class="ulink" href="http://www.digitalocean.com/community/tutorials/an-introduction-to-selinux-on-centos-7-part-1-basic-concepts">http://www.digitalocean.com/community/tutorials/an-introduction-to-selinux-on-centos-7-part-1-basic-concepts</a>)</li></ul></div></div></div></body></html>