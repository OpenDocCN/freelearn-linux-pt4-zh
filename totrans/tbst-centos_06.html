<html><head></head><body><div class="chapter" title="Chapter&#xA0;6.&#xA0;Troubleshooting Shared Resources"><div class="titlepage"><div><div><h1 class="title"><a id="ch06"/>Chapter 6. Troubleshooting Shared Resources</h1></div></div></div><p>In today's world, the need to share information is pervasive. From the home office to the small office, corporate and enterprise offices to public spaces, maintaining the ability to collaborate information is an important part of fulfilling the role provided by a troubleshooter. Without prejudice, sharing resources or providing access to remote locations is now viewed as an expectation across the spectrum, and it is the purpose of this chapter to discuss and highlight a selection of issues associated with access to shared resources over a network.</p><p>In this chapter, we will:</p><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc">Discover how to provide NFS shares on a CentOS 7 server</li><li class="listitem" style="list-style-type: disc">Learn more about NFS exports</li><li class="listitem" style="list-style-type: disc">Learn how to access NFS shared resources on a CentOS 7 client workstation</li><li class="listitem" style="list-style-type: disc">Learn how to mount an external drive with CIFS</li><li class="listitem" style="list-style-type: disc">Learn how to use <code class="literal">autofs</code> in order to provide a persistent mount</li></ul></div><div class="section" title="Providing NFS shares on a CentOS 7 server"><div class="titlepage"><div><div><h1 class="title"><a id="ch06lvl1sec59"/>Providing NFS shares on a CentOS 7 server</h1></div></div></div><p>NFS shares <a id="id249" class="indexterm"/>have been with us for some time and, as in <a id="id250" class="indexterm"/>most matters of this type, troubleshooting a file sharing service is fundamentally based on your knowledge of the installation process, as you will spend much of your time reviewing permissions and the network environment, and diagnosing the failure of a service to start.</p><p>To begin, you should ensure that both the client workstation and server are able to ping each other:</p><div class="informalexample"><pre class="programlisting">
<span class="strong"><strong># ping -c 4 XXX.XXX.XXX.XXX</strong></span>
</pre></div><p>If <code class="literal">ping</code> is successful for both the server and client workstation, to proceed you will need to install the <code class="literal">nfs-utils</code> package on the server like this:</p><div class="informalexample"><pre class="programlisting">
<span class="strong"><strong># yum install nfs-utils</strong></span>
</pre></div><p>Having <a id="id251" class="indexterm"/>completed the installation, we will now want to create a permanent publication directory in the following way:</p><div class="informalexample"><pre class="programlisting">
<span class="strong"><strong># mkdir /path/to/nfs/publication/directory</strong></span>
</pre></div><p>For example, one<a id="id252" class="indexterm"/> approach is to use the <code class="literal">/home</code> directory like this:</p><div class="informalexample"><pre class="programlisting">
<span class="strong"><strong># mkdir /home/nfs-share</strong></span>
</pre></div><p>As this location is where the client files will be stored, you will want to ensure the privileges are correct by typing:</p><div class="informalexample"><pre class="programlisting">
<span class="strong"><strong># chmod -R 775 /path/to/nfs/publication/directory</strong></span>
</pre></div><div class="note" title="Note" style=""><div class="inner"><h3 class="title"><a id="tip02"/>Tip</h3><p>Remember, if you do intend to use the <code class="literal">/home</code> directory on the server, be careful when modifying the permissions of the <code class="literal">/home</code> directory and target the appropriate subdirectory directly as you will not want to affect any other folders.</p></div></div><p>The next step is to start the relevant services in the following way:</p><div class="informalexample"><pre class="programlisting">
<span class="strong"><strong># systemctl enable rpcbind</strong></span>
<span class="strong"><strong># systemctl enable nfs-server</strong></span>
<span class="strong"><strong># systemctl enable nfs-lock</strong></span>
<span class="strong"><strong># systemctl enable nfs-idmap</strong></span>
<span class="strong"><strong># systemctl start rpcbind</strong></span>
<span class="strong"><strong># systemctl start nfs-server</strong></span>
<span class="strong"><strong># systemctl start nfs-lock</strong></span>
<span class="strong"><strong># systemctl start nfs-idmap</strong></span>
</pre></div><p>At this point, we will now decide to share the NFS directory over the network by making a few additions to the following file:</p><div class="informalexample"><pre class="programlisting">
<span class="strong"><strong># nano /etc/exports</strong></span>
</pre></div><p>Where <code class="literal">XXX.XXX.XXX.XXX</code> is the IP address of the client workstation, add your network share points in the following way:</p><div class="informalexample"><pre class="programlisting">/path/to/nfs/publication/directory    XXX.XXX.XXX.XXX(rw,sync,root_squash,no_all_squash)</pre></div><p>Naturally, you can add as many publication directories as required to one or more users; and each user can have a unique directory based on their IP address. However, if you wish to create a <a id="id253" class="indexterm"/>global publication—that is, a single directory that serves all client workstations—then you should use the following syntax:</p><div class="informalexample"><pre class="programlisting">/path/to/nfs/publication/directory    *(rw,sync,no_root_squash,no_all_squash)</pre></div><p>Note that a star symbol (<code class="literal">*</code>) has replaced the IP address. On a production server or similar, you should avoid this practice and use the network/subnet you are trying to share. This is a particular point for troubleshooters to notice but, for the purpose of explaining the installation procedure, we will use this method for the simple reason that it is a common occurrence.</p><p>So, based <a id="id254" class="indexterm"/>on our original working example detailed here, the entry could look like this:</p><div class="informalexample"><pre class="programlisting">/home/nfs-share    *(rw,sync,no_root_squash,no_all_squash)</pre></div><p>Finally, you may need to account for the required firewall changes. To do this, add the following lines one at a time:</p><div class="informalexample"><pre class="programlisting">
<span class="strong"><strong># firewall-cmd --permanent --zone=public --add-service=nfs</strong></span>
<span class="strong"><strong># firewall-cmd --reload</strong></span>
</pre></div><p>Then restart the NFS service as follows:</p><div class="informalexample"><pre class="programlisting">
<span class="strong"><strong># systemctl restart nfs-server</strong></span>
</pre></div></div></div>
<div class="section" title="About NFS exports"><div class="titlepage"><div><div><h1 class="title"><a id="ch06lvl1sec60"/>About NFS exports</h1></div></div></div><p>At this<a id="id255" class="indexterm"/> stage I would like to approach the subject of NFS exports on CentOS 7. As it was noted in the preceding example, we used the following syntax:</p><div class="informalexample"><pre class="programlisting">(rw,sync,root_squash,no_all_squash)</pre></div><p>Here, most of the options will be obvious to you; <code class="literal">root_squash</code> will allow the root user on the client to both access and create files on the NFS server as root. Technically speaking, this option will force NFS to change the client's root to an anonymous ID and, in effect, this will increase security by preventing ownership of the root account on one system migrating to the other system. This is needed if you are hosting root filesystems on the NFS server (especially for diskless clients); with this in mind, it can be used (sparingly) for selected hosts, but you should not use <code class="literal">no_root_squash</code> unless you are aware of the consequences.</p><div class="note" title="Note" style=""><div class="inner"><h3 class="title"><a id="note10"/>Note</h3><p><span class="strong"><strong>Other basic options for exports can include:</strong></span></p><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc"><code class="literal">no_all_squash</code>: This <a id="id256" class="indexterm"/>option disables all squashing.</li><li class="listitem" style="list-style-type: disc"><code class="literal">rw</code>: This <a id="id257" class="indexterm"/>option enables the NFS server to use both read and write requests on a NFS volume.</li><li class="listitem" style="list-style-type: disc"><code class="literal">ro</code>: This option<a id="id258" class="indexterm"/> enables the NFS server to use read-only requests on a NFS volume.</li><li class="listitem" style="list-style-type: disc"><code class="literal">sync</code>: This<a id="id259" class="indexterm"/> option enables the NFS server to reply to requests only after the changes have been committed to stable storage.</li><li class="listitem" style="list-style-type: disc"><code class="literal">async</code>: This<a id="id260" class="indexterm"/> option enables the NFS server to violate the NFS protocol and reply to requests before any changes have been committed to stable storage.</li><li class="listitem" style="list-style-type: disc"><code class="literal">secure</code>: This <a id="id261" class="indexterm"/>option requires that requests originate on an Internet port.</li><li class="listitem" style="list-style-type: disc"><code class="literal">insecure</code>: This <a id="id262" class="indexterm"/>option accepts any or all ports.</li><li class="listitem" style="list-style-type: disc"><code class="literal">wdelay</code>: This<a id="id263" class="indexterm"/> option enables the NFS server to delay committing a write request to a disc if it suspects that another related write request may be in progress or may arrive soon.</li><li class="listitem" style="list-style-type: disc"><code class="literal">no_wdelay</code>: This <a id="id264" class="indexterm"/>option enables the NFS server to allow multiple write requests to be committed to disc within a single operation. This feature can improve performance, but if an NFS server receives many small requests, this behavior can serve to degrade performance. You should be aware that this option has no effect if <code class="literal">async</code> is also set.</li><li class="listitem" style="list-style-type: disc"><code class="literal">subtree_check</code>: This <a id="id265" class="indexterm"/>option enables <code class="literal">subtree</code> checking.</li><li class="listitem" style="list-style-type: disc"><code class="literal">no_subtree_check</code>: This <a id="id266" class="indexterm"/>option disables <code class="literal">subtree</code> checking, which has some implied security issues, but it can improve reliability.</li><li class="listitem" style="list-style-type: disc"><code class="literal">anonuid=UID</code>: These <a id="id267" class="indexterm"/>options explicitly set the <code class="literal">uid</code> and <code class="literal">gid</code> of the anonymous account; this can be useful when you want all requests to appear as though they are from a single user.</li><li class="listitem" style="list-style-type: disc"><code class="literal">anongid=GID</code>: This <a id="id268" class="indexterm"/>option will disable <code class="literal">anonuid=UID</code>.</li></ul></div></div></div></div>
<div class="section" title="Mounting NFS shares on a CentOS client"><div class="titlepage"><div><div><h1 class="title"><a id="ch06lvl1sec61"/>Mounting NFS shares on a CentOS client</h1></div></div></div><p>Assuming<a id="id269" class="indexterm"/> that your server is currently providing <a id="id270" class="indexterm"/>NFS shares, we will now investigate the client workstation in order to ensure that everything is working correctly. This is a task that every troubleshooter needs to know and perfect.</p><p>To begin, the client must be using the <code class="literal">nfs-utils</code> package like this:</p><div class="informalexample"><pre class="programlisting">
<span class="strong"><strong># yum install nfs-utils</strong></span>
</pre></div><p>Having completed the installation for the <code class="literal">nfs-utils</code> package, you must now create mount points in the following way:</p><div class="informalexample"><pre class="programlisting">
<span class="strong"><strong># mkdir -p /path/to/mount/point</strong></span>
</pre></div><p>For example, to suit your needs, the preceding command may read as follows:</p><div class="informalexample"><pre class="programlisting">
<span class="strong"><strong># mkdir -p /mnt/nfs/home</strong></span>
</pre></div><p>Now start the relevant services like this:</p><div class="informalexample"><pre class="programlisting">
<span class="strong"><strong># systemctl enable rpcbind</strong></span>
<span class="strong"><strong># systemctl enable nfs-server</strong></span>
<span class="strong"><strong># systemctl enable nfs-lock</strong></span>
<span class="strong"><strong># systemctl enable nfs-idmap</strong></span>
<span class="strong"><strong># systemctl start rpcbind</strong></span>
<span class="strong"><strong># systemctl start nfs-server</strong></span>
<span class="strong"><strong># systemctl start nfs-lock</strong></span>
<span class="strong"><strong># systemctl start nfs-idmap</strong></span>
</pre></div><p>Finally, we can now mount the NFS share on the client workstation in the following way:</p><div class="informalexample"><pre class="programlisting">
<span class="strong"><strong># mount -t nfs XXX.XXX.XXX.XXX:/path/to/folder /path/to/mount/point</strong></span>
</pre></div><p>Here, <code class="literal">XXX.XXX.XXX.XXX</code> is the IP address of the NFS server and <code class="literal">:/path/to/folder</code> is the location of the shared resource. The <code class="literal">/path/to/mount/point</code> part represents the location of where the shared resource should be found on the client workstation.</p><p>A working example of this command may look like this:</p><div class="informalexample"><pre class="programlisting">
<span class="strong"><strong># mount -t nfs 192.168.1.100:/home /mnt/nfs/home/</strong></span>
</pre></div><p>In order to confirm that everything is now working, you may want to run the following command:</p><div class="informalexample"><pre class="programlisting">
<span class="strong"><strong># df -h</strong></span>
</pre></div><p>Based on the working example provided here, the command output should result in showing the addition of one or more filesystems like this:</p><div class="informalexample"><pre class="programlisting">
<span class="strong"><strong>192.168.1.100:/home           21G   33M   21G   1% /mnt/nfs/home</strong></span>
</pre></div><p>Then you <a id="id271" class="indexterm"/>can easily confirm the read-write permissions of the NFS resource by creating a new text file in the following way:</p><div class="informalexample"><pre class="programlisting">
<span class="strong"><strong># touch /path/to/mount/point/nfs-test.txt</strong></span>
</pre></div><p>Using the <code class="literal">ls</code> command, you should be able to see this file on both the server and the client workstation. However, as this is only a temporary solution, if you decide to make this a permanent or persistent mount, then you should open the following file:</p><div class="informalexample"><pre class="programlisting">
<span class="strong"><strong># nano /etc/fstab</strong></span>
</pre></div><p>Now add an entry for each mount point, as follows:</p><div class="informalexample"><pre class="programlisting">XXX.XXX.XXX.XXX:/path/to/folder   /path/to/mount/point   nfs defaults 0 0</pre></div><p>Having <a id="id272" class="indexterm"/>completed these steps, you will now be able to reboot the client machine in the full knowledge that the NFS service will be available at all times.</p></div>
<div class="section" title="Mounting an external drive with CIFS"><div class="titlepage"><div><div><h1 class="title"><a id="ch06lvl1sec62"/>Mounting an external drive with CIFS</h1></div></div></div><p>Mounting <a id="id273" class="indexterm"/>an external drive on a CentOS 7 workstation or server is considered to be a relatively simple procedure and, in many respects, this <a id="id274" class="indexterm"/>will be a daily task for a seasoned troubleshooter. However, on some occasions the process itself does give rise to much confusion as to what steps are required and, with this in mind, it is our purpose to provide some much needed clarity.</p><p>We will begin by confirming whether <code class="literal">cifs</code> is installed. To do this, type the following command:</p><div class="informalexample"><pre class="programlisting">
<span class="strong"><strong># rpm -q cifs-utils</strong></span>
</pre></div><p>CIFS, also known as the Common Internet File System, is a file sharing protocol that enables a standard for remote file access across many filesystems. Based on <a id="id275" class="indexterm"/>
<span class="strong"><strong>Server Message Block</strong></span> (<span class="strong"><strong>SMB</strong></span>) and running over TCP/IP, <code class="literal">cifs</code> provides typical file operations such as open, close, read, write, safe caching, and seek. It supports extended non-filesystem attributes, batch requests, and distributed replicated virtual volumes. However, if the system replies in the following way, you will know that <code class="literal">cifs</code> is not currently installed:</p><div class="informalexample"><pre class="programlisting">
<span class="strong"><strong>package cifs-utils is not installed</strong></span>
</pre></div><p>To fix this issue, simply type the following command to install the <code class="literal">cifs</code> package:</p><div class="informalexample"><pre class="programlisting">
<span class="strong"><strong># yum install cifs-utils</strong></span>
</pre></div><p>At this point, you <a id="id276" class="indexterm"/>will need to decide where you want to mount the device, a simple process that can be achieved in the following way:</p><div class="informalexample"><pre class="programlisting">
<span class="strong"><strong># mkdir /path/to/mount/folder</strong></span>
</pre></div><p>Then use the <code class="literal">cifs-utils</code> package to mount the external drive by typing:</p><div class="informalexample"><pre class="programlisting">
<span class="strong"><strong># mount -t cifs //XXX.XXX.XXX.XXX/path/to/folder /path/to/mount/folder</strong></span>
</pre></div><p>However, if you want to pass a string or a series of variables such as a username and password, then the complete command should call the <code class="literal">-o</code> options like this:</p><div class="informalexample"><pre class="programlisting">
<span class="strong"><strong># mount -t cifs //XXX.XXX.XXX.XXX/path/to/folder /path/to/mount/folder -o user=&lt;username&gt; password=&lt;password&gt;</strong></span>
</pre></div><p>It is<a id="id277" class="indexterm"/> important to realize that this same process can be used to mount many different types of shared resources, and if the external resource contains spaces in the relevant folder names, then this can be accounted for in the usual way:</p><div class="informalexample"><pre class="programlisting">
<span class="strong"><strong># mount -t cifs //XXX.XXX.XXX.XXX/path/to/folder\ name /path/to/mount/folder -o user=&lt;username&gt;,password=&lt;password&gt;</strong></span>
</pre></div><p>The type of string you use can also take advantage of other features that are addressed by the manual. However, the important point to remember is that the preceding solution will only maintain the mounted drive until the drive is unmounted, disconnected, or a reboot occurs. So, nothing at this stage is permanent or persistent.</p></div>
<div class="section" title="Using autofs to mount an external drive"><div class="titlepage"><div><div><h1 class="title"><a id="ch06lvl1sec63"/>Using autofs to mount an external drive</h1></div></div></div><p>If you <a id="id278" class="indexterm"/>wish to make the process of attaching an<a id="id279" class="indexterm"/> external drive (through <code class="literal">cifs</code>) permanent (persistent), then you will need to begin by installing the <code class="literal">autofs</code> package in the following way:</p><div class="informalexample"><pre class="programlisting">
<span class="strong"><strong># yum install autofs</strong></span>
</pre></div><p>Having installed the package, you will then need to ensure that you start and enable the <code class="literal">autofs</code> service like this:</p><div class="informalexample"><pre class="programlisting">
<span class="strong"><strong># systemctl start autofs</strong></span>
<span class="strong"><strong># systemctl enable autofs</strong></span>
</pre></div><p>Having done this, and assuming we will be using the same mount point as discussed here, you should begin the configuration of the <code class="literal">autofs</code> service by creating a credentials file in your favorite text editor by typing this:</p><div class="informalexample"><pre class="programlisting">
<span class="strong"><strong># nano /path/to/credentials.txt</strong></span>
</pre></div><p>Now, add the required network credentials like this:</p><div class="informalexample"><pre class="programlisting">username=&lt;access_username&gt;
password=&lt;access_password&gt;</pre></div><p>Having <a id="id280" class="indexterm"/>saved and closed this file, make sure that<a id="id281" class="indexterm"/> the permissions are modified to ensure system security:</p><div class="informalexample"><pre class="programlisting">
<span class="strong"><strong># chmod 600 /path/to/credentials.txt</strong></span>
</pre></div><p>The next stage of this process is to open the <code class="literal">autofs</code> configuration file:</p><div class="informalexample"><pre class="programlisting">
<span class="strong"><strong># nano /etc/auto.master</strong></span>
</pre></div><p>Add the following line at the end of this file, but be sure to customize the values shown here:</p><div class="informalexample"><pre class="programlisting">/path/to/mount/folder  /etc/auto.cifs  --timeout=600 --ghost</pre></div><p>As you can see, we have used various options, where the <code class="literal">--timeout</code> option sets the idle time (in seconds) before unmounting the share if it is not accessed (the default period is 10 minutes). The use of the <code class="literal">--ghost</code> option is recommended as it creates a <code class="literal">ghost</code> or empty holding folder for the mount point during periods when it isn't mounted.</p><p>Now, create and edit the following mount file:</p><div class="informalexample"><pre class="programlisting">
<span class="strong"><strong># nano /etc/auto.cifs</strong></span>
</pre></div><p>Add and customize the following line to suit your needs:</p><div class="informalexample"><pre class="programlisting">&lt;Local-Name&gt;  -fstype=cifs,rw,noperm,credentials=/path/to/credentials.txt    ://XXX.XXX.XXX.XXX/path/to/share/folder</pre></div><p>The <code class="literal">Local-Name</code> used will be displayed in the mount point directory (<code class="literal">/path/to/mount/point/Local-Name</code>), while the arguments that follow simply call on the filesystem type, irrespective of whether you are providing read-write access and the expected access credentials. So, if you plan to provide read-only access, remember to swap out <code class="literal">rw</code> for <code class="literal">ro</code>. Moreover, given the structure of the customization made, you can see how multiple locations can be added (this also implies that multiple credentials can be called) in the following way:</p><div class="informalexample"><pre class="programlisting">&lt;Local-Name&gt;  -fstype=cifs,rw,noperm,credentials=/path/to/credentials1.txt    ://XXX.XXX.XXX.XXX/path/to/share/folder1
&lt;Local-Name&gt;  -fstype=cifs,rw,noperm,credentials=/path/to/credentials2.txt    ://XXX.XXX.XXX.XXX/path/to/share/folder2
&lt;Local-Name&gt;  -fstype=cifs,rw,noperm,credentials=/path/to/credentials3.txt    ://XXX.XXX.XXX.XXX/path/to/share/folder3</pre></div><p>Finally, if <a id="id282" class="indexterm"/>you wish to avoid the use of an IP address, then you should ensure that the hostname is mapped to your system via <code class="literal">/etc/hosts</code> or DNS in order for you to use the following syntax changes:</p><div class="informalexample"><pre class="programlisting">&lt;Local-Name&gt;  -fstype=cifs,rw,noperm,credentials=/path/to/credentials.txt    ://hostname/path/to/share/folder</pre></div><p>Having completed <a id="id283" class="indexterm"/>these steps, the next task is to reboot your system but, as an alternative, you can simply restart the <code class="literal">autofs</code> service in order to enjoy the benefits of your work:</p><div class="informalexample"><pre class="programlisting">
<span class="strong"><strong># systemctl restart autofs</strong></span>
</pre></div></div>
<div class="section" title="Summary"><div class="titlepage"><div><div><h1 class="title"><a id="ch06lvl1sec64"/>Summary</h1></div></div></div><p>In this chapter, we have considered a unique approach to the provision and access of shared resources across a network. From NFS to <code class="literal">cifs</code>, <code class="literal">fstab</code> to <code class="literal">autofs</code>, we have covered the process of making our mounts temporary or permanent and ensured we have argued the case to prove that CentOS can serve all operating systems. However, unlike the other chapters so far, instead of taking the direct approach to diagnosis, we have defined the role of a troubleshooter as a review of the installation process so that your understanding and appreciation of the problems typically associated with shared resources is based on the initial install rather than an event that happens post-installation. In this way, and by knowing the installation procedure, you will also know how to fix any issues associated with that service. With that in mind we will now move on to the subject of troubleshooting security issues.</p></div>
<div class="section" title="References"><div class="titlepage"><div><div><h1 class="title"><a id="ch06lvl1sec65"/>References</h1></div></div></div><p>The Red Hat customer portal: <a class="ulink" href="https://access.redhat.com/documentation/en-US/Red_Hat_Enterprise_Linux/">https://access.redhat.com/documentation/en-US/Red_Hat_Enterprise_Linux/</a></p></div></body></html>