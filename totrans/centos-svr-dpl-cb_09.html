<html><head></head><body><div class="chapter" title="Chapter&#xA0;9.&#xA0;Managing E-mails"><div class="titlepage"><div><div><h1 class="title"><a id="ch09"/>Chapter 9. Managing E-mails</h1></div></div></div><p>This chapter contains the following recipes:</p><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc">Configuring Postfix to provide SMTP services</li><li class="listitem" style="list-style-type: disc">Adding SASL to Postfix with Dovecot</li><li class="listitem" style="list-style-type: disc">Configuring Postfix to use TLS</li><li class="listitem" style="list-style-type: disc">Configuring Dovecot for secure POP3 and IMAP access</li><li class="listitem" style="list-style-type: disc">Targeting spam with SpamAssassin</li><li class="listitem" style="list-style-type: disc">Routing messages with Procmail</li></ul></div><div class="section" title="Introduction"><div class="titlepage"><div><div><h1 class="title"><a id="ch09lvl1sec73"/>Introduction</h1></div></div></div><p>In this chapter, you'll find recipes to help you set up and secure e-mail services for your domain. You'll learn how to set up Postfix to run as an SMTP server and then learn how to configure it to support SASL authentication and TLS encryption. Then we'll configure Dovecot which will provide users access to their e-mail over the POP3 and IMAP protocols. Finally, you'll learn how to set up SpamAssassin and Procmail to reduce the amount of spam that makes it way to your inbox.</p></div></div>
<div class="section" title="Configuring Postfix to provide SMTP services"><div class="titlepage"><div><div><h1 class="title"><a id="ch09lvl1sec74"/>Configuring Postfix to provide SMTP services</h1></div></div></div><p>This recipe teaches you how to configure Postfix as a basic e-mail server for your domain. E-mail is one of the oldest Internet services and has become one its most pervasive services. Moreover, e-mail can be one of the most difficult services to manage.</p><p>Using the Simple Mail Transport Protocol (SMTP), an e-mail message passes through many processes from its starting point on its way to your inbox. When someone writes you a message, they use an e-mail client to compose the message. The client sends the message to their mail server which looks up the <code class="literal">MX</code> records for your domain and relays the message to your mail server for delivery. Once the message is received by your mail server, it's delivered to your mail directory on the server. At least that's the basic idea. A message can be relayed by any number of intermediate servers between the sender's server and your mail server; servers can be configured to send mail, receive mail, or both. Different protocols are used to retrieve the messages from the server (POP3 and IMAP) than those used to send them, and trying to stay one step ahead of spammers can add a fair amount of complexity.</p><div class="note" style="" title="Note"><div class="inner"><h3 class="title"><a id="note60"/>Note</h3><p>Because of the complexity of the e-mail ecosystem and being a mail server administrator is often more than a full-time job, I can only present to you the basics. Later recipes will teach you how to add authentication and encryption to your setup, there will still be much to explore and learn. I strongly recommend that you take advantage of the additional resources mentioned in the <span class="emphasis"><em>See also</em></span> section after each recipe.</p></div></div><div class="section" title="Getting ready"><div class="titlepage"><div><div><h2 class="title"><a id="ch09lvl2sec237"/>Getting ready</h2></div></div></div><p>This recipe requires a CentOS system with a working network connection. Administrative privileges are also required, either by logging in with the <code class="literal">root</code> account or through the use of <code class="literal">sudo</code>. You'll want to have a couple of user accounts available on the system for testing purposes as well.</p><p>Because <code class="literal">MX</code> records are used to resolve the mail server's address during the delivery process, it's assumed that you have either completed the previous chapter's recipes or have, otherwise, configured your own DNS records. The IP address <code class="literal">192.168.56.20</code> is used here in keeping with the example network outlined in the <span class="emphasis"><em>Configuring BIND as an authoritative DNS server</em></span> recipe in <a class="link" href="ch08.html" title="Chapter 8. Managing Domains and DNS">Chapter 8</a>, <span class="emphasis"><em>Managing Domains and DNS</em></span>.</p></div><div class="section" title="How to do it..."><div class="titlepage"><div><div><h2 class="title"><a id="ch09lvl2sec238"/>How to do it...</h2></div></div></div><p>Follow these steps to set up Postfix:</p><div class="orderedlist"><ol class="orderedlist arabic"><li class="listitem">Use a text editor to open Postfix's configuration file <code class="literal">/etc/postfix/main.cf</code>:<pre class="programlisting">
<span class="strong"><strong>vi /etc/postfix/main.cf</strong></span>
</pre></li><li class="listitem">Find the example <code class="literal">myhostname</code> parameters. Delete the leading <code class="literal">#</code> character to uncomment one of the examples and update its value with your qualified hostname:<pre class="programlisting">
<span class="strong"><strong>myhostname = mail.example.com</strong></span>
</pre></li><li class="listitem">Locate the example <code class="literal">mydomain</code> parameter and uncomment and edit it, setting your domain name as its value:<pre class="programlisting">
<span class="strong"><strong>       mydomain = example.com &#13;
</strong></span>
</pre></li><li class="listitem">Find the <code class="literal">inet_interfaces</code> parameters. Place an <code class="literal">#</code> in front of the <code class="literal">localhost</code> entry to comment it out and then uncomment the <code class="literal">all</code> entry:<pre class="programlisting">
<span class="strong"><strong>inet_interfaces = all</strong></span>
<span class="strong"><strong>#inet_interfaces = $myhostname</strong></span>
<span class="strong"><strong>#inet_interfaces = $myhostname, localhost</strong></span>
<span class="strong"><strong>#inet_interfaces = localhost</strong></span>
</pre></li><li class="listitem">Find the <code class="literal">mydestination</code> parameters and comment out the first entry. Uncomment the one that includes <code class="literal">$mydomain</code> in its list:<pre class="programlisting">
<span class="strong"><strong>#mydestination = $myhostname, localhost.$mydomain,  localhost</strong></span>
<span class="strong"><strong>mydestination = $myhostname, localhost.$mydomain,  localhost,  &#13;
       $mydomain</strong></span>
<span class="strong"><strong>#mydestination = $myhostname, localhost.$mydomain,  localhost,</strong></span>
<span class="strong"><strong>#       $mydomain mail.$mydomain, www.$mydomain,  ftp.$mydomain</strong></span>
</pre></li><li class="listitem">Find the example <code class="literal">mynetworks</code> parameters. Uncomment one of the entries and edit it so that the value reflects your network:<pre class="programlisting">
<span class="strong"><strong>mynetworks = 192.168.56.0/24, 127.0.0.0/8</strong></span>
</pre></li><li class="listitem">Find the example <code class="literal">home_mailbox</code> parameters and uncomment the entry with the <code class="literal">Maildir/</code> value:<pre class="programlisting">
<span class="strong"><strong>home_mailbox = Maildir/</strong></span>
</pre></li><li class="listitem">Save your changes and close the file.</li><li class="listitem">Start the Postfix server and optionally enable it to start automatically whenever the system reboots:<pre class="programlisting">
<span class="strong"><strong>systemctl start postfix.service</strong></span>
<span class="strong"><strong>systemctl enable postfix.service</strong></span>
</pre></li><li class="listitem">Open port <code class="literal">25</code> in the system's firewall to allow outside connections to Postfix:<pre class="programlisting">
<span class="strong"><strong>firewall-cmd --zone=public --permanent --add-service=smtp</strong></span>
<span class="strong"><strong>firewall-cmd --reload</strong></span>
</pre></li></ol></div></div><div class="section" title="How it works..."><div class="titlepage"><div><div><h2 class="title"><a id="ch09lvl2sec239"/>How it works...</h2></div></div></div><p>CentOS systems have Postfix installed by default, using it as a local mail transfer agent. To reconfigure it to act as our domain's mail server, we updated several parameters in its configuration file, <code class="literal">/etc/postfix/main.cf</code>.</p><p>First, we updated the <code class="literal">myhostname</code> parameter to provide our system's qualified domain name (the hostname and domain name):</p><pre class="programlisting">
<span class="strong"><strong>myhostname = mail.example.com</strong></span>
</pre><div class="note" style="" title="Note"><div class="inner"><h3 class="title"><a id="note61"/>Note</h3><p>Comments in the configuration file refer to a FQDN, but we know better because FQDNs require a trailing dot. If you do provide a true FQDN as the value, Postfix will fail to start stating that the parameter's value is bad.</p></div></div><p>The <code class="literal">mydomain</code> parameter specifies the domain that this system is a member of and that Postfix is handling e-mail for. Although Postfix will try to determine the domain name based on the system's qualified hostname, it's not a bad idea to explicitly define it with <code class="literal">mydomain</code> to be certain it's correct:</p><pre class="programlisting">
<span class="strong"><strong>mydomain = example.com</strong></span>
</pre><p>The <code class="literal">inet_interface</code> parameter identifies the network interfaces that Postfix will listen on for connections. The original configuration accepts connections only from the localhost; so we updated it to listen on all interfaces, although you may want to specify something more specific if your system is connected to multiple networks:</p><pre class="programlisting">
<span class="strong"><strong>inet_interfaces = all</strong></span>
</pre><p>The <code class="literal">mydestination</code> parameter lists the zones for which Postfix will accept mail for final delivery. We changed the original configuration to include our domain:</p><pre class="programlisting">
<span class="strong"><strong>mydestination = $myhostname, localhost.$mydomain, localhost,  $mydomain</strong></span>
</pre><p>If necessary, you should add other values to the list to identify all of the system's hostnames, similar to what's shown in the last example, <code class="literal">mydestination</code>, in the set. This is important to prevent Postfix from trying to relay messages to itself, thinking they're destined for a different domain when they're really not:</p><pre class="programlisting">
<span class="strong"><strong>mydestination = $myhostname, localhost.$mydomain, localhost,  &#13;
    $mydomain, mail.$mydomain, www.$mydomain, ftp.$mydomain</strong></span>
</pre><p>The <code class="literal">mynetworks</code> parameter identifies the trusted networks Postfix can relay messages for. This is the first line of defense against spammers abusing your mail server because Postfix will refuse to accept messages for delivery if they're not for our domain and if they're received from a system outside one of the trusted networks:</p><pre class="programlisting">
<span class="strong"><strong>mynetworks = 192.168.56.0/24, 127.0.0.0/8</strong></span>
</pre><p>Finally, we set the messages' delivery destination using the <code class="literal">home_mailbox</code> parameter:</p><pre class="programlisting">
<span class="strong"><strong>home_mailbox = Maildir/</strong></span>
</pre><p>Messages are traditionally appended to the user's file in <code class="literal">/var/spool/mail</code> in what is known as the <span class="strong"><strong>mbox</strong></span> format. The Maildir format stores messages individually in a subdirectory in the user's Maildir directory. Postfix delivers mail to the spool by default. We can convert messages between the two formats, but choosing Maildir now makes things a bit easier when we configure user access over IMAP in a later recipe.</p><p>Once Postfix is restarted, we can send a test message to verify that the server's configuration is correct. There are several ways to do this of course. The easiest is to use a command-line e-mail client such as <code class="literal">mailx</code> to send the message. <code class="literal">mailx</code> isn't installed by default but is available via <code class="literal">yum</code>:</p><pre class="programlisting">
<span class="strong"><strong>yum install mailx</strong></span>
</pre><p>Invoke <code class="literal">mailx</code> to send a message. The <code class="literal">-s</code> argument provides the message's subject and <code class="literal">-r</code> provides the sender's address (your own e-mail address). Then the recipient's address follows after the arguments:</p><pre class="programlisting">
<span class="strong"><strong>mailx -r abell@example.com -s "Test email" tboronczyk@example.com</strong></span>
</pre><p><code class="literal">mailx</code> reads the message from <code class="literal">stdin</code>. A simple "hello world" or "this is a test" should be sufficient for testing purposes; when you're done typing, type a period on its own line or press <span class="emphasis"><em>Ctrl</em></span> + <span class="emphasis"><em>D</em></span>:</p><p>If all goes well, <code class="literal">mailx</code> sends the mail to Postfix for delivery which in turn delivers it to the user's mail directory in <code class="literal">/home/&lt;username&gt;/Maildir/new</code>. Check the directory and output the file's contents to make sure the message was delivered:</p><pre class="programlisting">
<span class="strong"><strong>ls /home/tboronczyk/Maildir/new</strong></span>
<span class="strong"><strong>cat /home/tboronczyk/Maildir/new/146284221.Vfd00I188f5ceM9593.mail</strong></span>
</pre><div class="mediaobject"><img alt="How it works..." src="graphics/image_09_001.jpg"/><div class="caption"><p>Received messages are delivered to the user's Maildir directory</p></div></div><p>Alternatively, we can connect directly to Postfix using a Telnet client. Typing raw commands to send an e-mail is slightly more involved than sending one using <code class="literal">mailx,</code> but is preferred because it offers you more flexibility and greater visibility into how Postfix responds. This can prove invaluable when trying to troubleshoot a problem.</p><p>No Telnet client is installed by default, so first you'll need to use <code class="literal">yum</code> to install <code class="literal">telnet</code>:</p><pre class="programlisting">
<span class="strong"><strong>yum install telnet</strong></span>
</pre><p>Then use <code class="literal">telnet</code> to connect to the server on port <code class="literal">25</code>, the port reserved for SMTP:</p><pre class="programlisting">
<span class="strong"><strong>telnet mail.example.com 25</strong></span>
</pre><p>The <code class="literal">MAIL FROM</code> command is used to provide the sender's e-mail address and <code class="literal">RCPT TO</code> to provide the recipient's address. After each is entered, Postfix should respond with a <code class="literal">250 Ok</code> status:</p><pre class="programlisting">
<span class="strong"><strong>MAIL FROM: tboronczyk@example.com</strong></span>
<span class="strong"><strong>250 2.1.0 Ok</strong></span>
<span class="strong"><strong>RCPT TO: abell@example.com</strong></span>
<span class="strong"><strong>250 2.1.0 Ok</strong></span>
</pre><p><code class="literal">DATA</code> begins the message's content. Postfix accepts everything we type as the message until we type a single period on its own line:</p><pre class="programlisting">
<span class="strong"><strong>DATA</strong></span>
<span class="strong"><strong>352 End data with &lt;CR&gt;&lt;LF&gt;.&lt;CR&gt;&lt;LF&gt;</strong></span>
<span class="strong"><strong>Subject: Test email</strong></span>
<span class="strong"><strong>Hello world! This is a test.</strong></span>
<span class="strong"><strong>.</strong></span>
<span class="strong"><strong>250 2.0.0 Ok: queued as 705486E22E</strong></span>
</pre><p>Then, to close the connection, type <code class="literal">QUIT</code>:</p><pre class="programlisting">
<span class="strong"><strong>QUIT</strong></span>
<span class="strong"><strong>221 2.0.0 Bye</strong></span>
<span class="strong"><strong>Connection closed by foreign host.</strong></span>
</pre></div><div class="section" title="See also"><div class="titlepage"><div><div><h2 class="title"><a id="ch09lvl2sec240"/>See also</h2></div></div></div><p>Refer to the following resources for more information on working with Postfix:</p><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc">RHEL 7 System Administrator's Guide: Mail Transport Agents (<a class="ulink" href="https://access.redhat.com/documentation/en-US/Red_Hat_Enterprise_Linux/7/html/System_Administrators_Guide/s1-email-mta.html">https://access.redhat.com/documentation/en-US/Red_Hat_Enterprise_Linux/7/html/System_Administrators_Guide/s1-email-mta.html</a>)</li><li class="listitem" style="list-style-type: disc">RFC-5321: Simple Mail Transport Protocol (<a class="ulink" href="https://tools.ietf.org/html/rfc5321">https://tools.ietf.org/html/rfc5321</a>)</li><li class="listitem" style="list-style-type: disc">Mbox vs Maildir: Mail Storage Formats (<a class="ulink" href="http://www.linuxmail.info/mbox-maildir-mail-storage-formats/">http://www.linuxmail.info/mbox-maildir-mail-storage-formats/</a>)</li><li class="listitem" style="list-style-type: disc">Setup a Local Mail Server in CentOS 7 (<a class="ulink" href="http://www.unixmen.com/setup-a-local-mail-server-in-centos-7">http://www.unixmen.com/setup-a-local-mail-server-in-centos-7</a>)</li></ul></div></div></div>
<div class="section" title="Adding SASL to Postfix with Dovecot"><div class="titlepage"><div><div><h1 class="title"><a id="ch09lvl1sec75"/>Adding SASL to Postfix with Dovecot</h1></div></div></div><p>If a mail server relays a message to another domain (that is, the recipient's address is not in our domain) and the message originates from outside our network, the server is known as an open relay. Spammers are constantly on the lookout for open relays because such permissive behavior is easy to take advantage of, and Postfix tries to protect us by default by only relaying messages that come from our network. Unfortunately, it's not practical to restrict legitimate users from sending e-mail through the server only when they're on our network. This recipe teaches you how to add Simple Authentication and Security Layer (SASL) authentication to Postfix's configuration using Dovecot. Postfix will then happily relay messages for our users authenticated users, regardless of their network location, while still refusing to do so for anyone else.</p><div class="section" title="Getting ready"><div class="titlepage"><div><div><h2 class="title"><a id="ch09lvl2sec241"/>Getting ready</h2></div></div></div><p>This recipe requires a CentOS system with Postfix configured as described in the previous recipe. Administrative privileges are also required, either by logging in with the root account or through the use of <code class="literal">sudo</code>.</p></div><div class="section" title="How to do it..."><div class="titlepage"><div><div><h2 class="title"><a id="ch09lvl2sec242"/>How to do it...</h2></div></div></div><p>Follow these steps to secure Postfix to SASL:</p><div class="orderedlist"><ol class="orderedlist arabic"><li class="listitem">Install the <code class="literal">dovecot</code> package:<pre class="programlisting">
<span class="strong"><strong>yum install dovecot</strong></span>
</pre></li><li class="listitem">Open the <code class="literal">/etc/dovecot/conf.d/10-master.conf</code> file with your text editor:<pre class="programlisting">
<span class="strong"><strong>vi /etc/dovecot/conf.d/10-master.conf</strong></span>
</pre></li><li class="listitem">Locate the <code class="literal">unix_listener</code> section for /<code class="literal">var/spool/postfix/private/auth</code>. Uncomment the section by removing the leading <code class="literal">#</code> characters:<pre class="programlisting">
<span class="strong"><strong># Postfix smtp-auth</strong></span>
<span class="strong"><strong>unix_listener /var/spool/postfix/private/auth {</strong></span>
<span class="strong"><strong>     mode = 0666</strong></span>
<span class="strong"><strong>}</strong></span>
</pre></li><li class="listitem">Update <code class="literal">mode</code> to <code class="literal">0660</code> and add the parameters <code class="literal">user</code> and <code class="literal">group</code> to the section with the value <code class="literal">postfix</code>:<pre class="programlisting">
<span class="strong"><strong># Postfix smtp-auth</strong></span>
<span class="strong"><strong>unix_listener /var/spool/postfix/private/auth {</strong></span>
<span class="strong"><strong>     mode = 0660</strong></span>
<span class="strong"><strong>     user = postfix</strong></span>
<span class="strong"><strong>     group = postfix</strong></span>
<span class="strong"><strong>}</strong></span>
</pre></li><li class="listitem">Save your changes and close the file.</li><li class="listitem">Open the <code class="literal">/etc/dovecot/conf.d/10-auth.conf</code> file with your text editor:<pre class="programlisting">
<span class="strong"><strong>vi /etc/dovecot/conf.d/10-auth.conf</strong></span>
</pre></li><li class="listitem">Locate the <code class="literal">auth_mechanisms</code> option and add <code class="literal">login</code> to its value:<pre class="programlisting">
<span class="strong"><strong>auth_mechanisms = plain login</strong></span>
</pre></li><li class="listitem">Save the changes and close the file.</li><li class="listitem">Start the Dovecot server and optionally enable it to start automatically whenever the system reboots:<pre class="programlisting">
<span class="strong"><strong>systemctl start dovecot.service</strong></span>
<span class="strong"><strong>systemctl enable dovecot.service</strong></span>
</pre></li><li class="listitem">Open the <code class="literal">/etc/postfix/main.cf</code> file with your text editor:<pre class="programlisting">
<span class="strong"><strong>vi /etc/postfix/main.cf</strong></span>
</pre></li><li class="listitem">At the end of the configuration file, add the following options and values:<pre class="programlisting">
<span class="strong"><strong>smtpd_sasl_auth_enable = yes</strong></span>
<span class="strong"><strong>smtpd_sasl_type = dovecot</strong></span>
<span class="strong"><strong>smtpd_sasl_path = private/auth</strong></span>
<span class="strong"><strong>smtpd_sasl_security_options = noanonymous</strong></span>
</pre></li><li class="listitem">Save the changes and close the file.</li><li class="listitem">Restart Postfix:<pre class="programlisting">
<span class="strong"><strong>systemctl restart postfix.service</strong></span>
</pre></li></ol></div></div><div class="section" title="How it works..."><div class="titlepage"><div><div><h2 class="title"><a id="ch09lvl2sec243"/>How it works...</h2></div></div></div><p>Dovecot is a primarily a mail retrieval server offering users access to their e-mail using the POP and IMAP protocols, and it also allows Postfix to hook into its SASL authentication mechanism. We'll need a retrieval server for users to fetch their e-mail from the system, and Dovecot and Postfix integrate nicely, so choosing Dovecot over other options makes sense.</p><p>Dovecot's configuration is organized into various files, each file addressing a particular feature or bit of functionality. For this recipe, we needed to update the master configuration file <code class="literal">/etc/dovecot/conf.d/10-master.conf</code> and the authentication configuration file <code class="literal">/etc/dovecot/conf.d/10-auth.conf</code>.</p><p>In <code class="literal">10-master.conf</code>, we located the <code class="literal">unix_listener</code> parameter that defines the SMTP authentication service that will be shared with Postfix. Uncommenting it will create the socket file <code class="literal">/var/spool/postfix/private/auth</code> over which Dovecot and Postfix will communicate. We then updated the <code class="literal">mode</code> parameter and added the <code class="literal">user</code> and <code class="literal">group</code> parameters to secure the socket's ownership and access permissions:</p><pre class="programlisting">
<span class="strong"><strong>unix_listener /var/spool/postfix/private/auth {</strong></span>
<span class="strong"><strong>  mode = 0660</strong></span>
<span class="strong"><strong>  user = postfix</strong></span>
<span class="strong"><strong>  group = postfix</strong></span>
<span class="strong"><strong>}</strong></span>
</pre><p>In <code class="literal">10-auth.conf</code>, we located the <code class="literal">auth_mechanism</code> parameter and added <code class="literal">login</code> to its value. This parameter sets the list of mechanisms Dovecot uses, and <code class="literal">login</code> is the mechanism used specifically for SMTP authentication:</p><pre class="programlisting">
<span class="strong"><strong>auth_mechanisms = plain login</strong></span>
</pre><p><code class="literal">plain</code> allows users to provide their username and password in plain text. <code class="literal">login</code> is also considered a plain text mechanism, but don't worry; you'll learn how to secure that in the next recipe.</p><p>The final bit of configuration involves adding the necessary SASL-related parameters to Postfix's <code class="literal">main.cf</code> file:</p><pre class="programlisting">
<span class="strong"><strong>smtpd_sasl_auth_enable = yes</strong></span>
<span class="strong"><strong>smtpd_sasl_type = dovecot</strong></span>
<span class="strong"><strong>smtpd_sasl_path = private/auth</strong></span>
<span class="strong"><strong>smtpd_sasl_security_options = noanonymous</strong></span>
</pre><p><code class="literal">smtpd_sasl_auth_enable</code> enables SASL authentication and <code class="literal">smtpd_sasl_type</code> informs Postfix that it will be using Dovecot's authentication service. The <code class="literal">smtpd_sasl_path</code> parameter specifies the path to the socket file that is used to communicate with Dovecot relative to Postfix's working directory. <code class="literal">smtpd_sasl_security_options</code> prohibits anonymous connections and requires everyone to be authenticated.</p><p>Postfix expects the username and password to be Base64 encoded so that we need to encode them before we can test our configuration with Telnet. <code class="literal">base64</code> can be used, but be careful not to introduce a trailing newline when you provide the original values. After invoking <code class="literal">base64</code>, you can enter your username or password on <code class="literal">stdin</code> and immediately press <span class="emphasis"><em>Ctrl</em></span> + <span class="emphasis"><em>D</em></span> twice, but do not press <span class="emphasis"><em>Enter</em></span>. You may want to redirect base64's output to a separate file you can dump later to more readily distinguish the encoded value from the original, since they'll appear to run together in the terminal without the newline:</p><pre class="programlisting">
<span class="strong"><strong>base64 &gt; ./username</strong></span>
<span class="strong"><strong>tboronczyk</strong></span>
<span class="strong"><strong>base64 &gt; ./password</strong></span>
<span class="strong"><strong>P@$$W0rd</strong></span>
<span class="strong"><strong>cat ./username ./password</strong></span>
</pre><div class="note" style="" title="Note"><div class="inner"><h3 class="title"><a id="note62"/>Note</h3><p>Despite the hassle of "newline vigilance", this approach is better than piping the value as follows:</p><p>
</p><p><code class="literal"><span class="strong"><strong>echo -n tboronczyk | base64</strong></span></code></p><p>
</p><p>The command's invocation will be retained in your shell's history. While this is fine for usernames, sensitive data such as passwords should never be provided on the command line as part of a command for this very reason.</p></div></div><p>After connecting to the server with <code class="literal">telnet</code> on port <code class="literal">25</code>, send the <code class="literal">AUTH LOGIN</code> command to initiate the authentication. Postfix should respond with <code class="literal">VXNlcm5hbWU6</code> which is the Base64 encoded value for <code class="literal">Username:</code>:</p><pre class="programlisting">
<span class="strong"><strong>AUTH LOGIN</strong></span>
<span class="strong"><strong>334 VXNlcm5hbWU6</strong></span>
</pre><p>Provide your encoded username and press <span class="emphasis"><em>Enter</em></span>. Postfix then responds with <code class="literal">UGFzc3dvcmQ6</code>, which, as you probably have already guessed, is the encoded version of <code class="literal">Password:</code>. After you provide the encoded password, you'll be informed if the authentication was successful:</p><div class="mediaobject"><img alt="How it works..." src="graphics/image_09_002.jpg"/><div class="caption"><p>The authentication exchange expects credentials to be Base64 encoded</p></div></div></div><div class="section" title="See also"><div class="titlepage"><div><div><h2 class="title"><a id="ch09lvl2sec244"/>See also</h2></div></div></div><p>Refer to the following resources for more information on Postfix, Dovecot, and SASL:</p><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc">The Dovecot Homepage (<a class="ulink" href="http://www.dovecot.org/">http://www.dovecot.org/</a>)</li><li class="listitem" style="list-style-type: disc">RFC 4422: Simple Authentication and Security Layer (<a class="ulink" href="https://tools.ietf.org/html/rfc4422">https://tools.ietf.org/html/rfc4422</a>)</li><li class="listitem" style="list-style-type: disc">Postfix SASL How-To (<a class="ulink" href="http://www.postfix.org/SASL_README.html">http://www.postfix.org/SASL_README.html</a>)</li><li class="listitem" style="list-style-type: disc">25, 465, 587... What Port Should I Use? (<a class="ulink" href="http://blog.mailgun.com/25-465-587-what-port-should-i-use/">http://blog.mailgun.com/25-465-587-what-port-should-i-use/</a>)</li></ul></div></div></div>
<div class="section" title="Configuring Postfix to use TLS"><div class="titlepage"><div><div><h1 class="title"><a id="ch09lvl1sec76"/>Configuring Postfix to use TLS</h1></div></div></div><p>Implementing authentication for mail relaying is an important step in securing your mail server. But as you learned in the previous recipe, the user's name and password are sent in clear text. Base64-encoding encodes binary data using only ASCII characters, which allows for non-ASCII characters in a user's password for example, but encoding isn't encryption. If traffic between the user's mail client and the server happens over an untrusted network, a malicious user can easily capture the credentials and masquerade as the user. This recipe further secures Postfix by configuring Transport Layer Security (TLS) encryption to protect the communication from eavesdropping.</p><div class="section" title="Getting ready"><div class="titlepage"><div><div><h2 class="title"><a id="ch09lvl2sec245"/>Getting ready</h2></div></div></div><p>This recipe requires a CentOS system with Postfix configured as described in previous recipes. Administrative privileges are also required, either by logging in with the <code class="literal">root</code> account or through the use of <code class="literal">sudo</code>.</p></div><div class="section" title="How to do it..."><div class="titlepage"><div><div><h2 class="title"><a id="ch09lvl2sec246"/>How to do it...</h2></div></div></div><p>Follow these steps to configure Postfix to use TLS:</p><div class="orderedlist"><ol class="orderedlist arabic"><li class="listitem">Generate a new key file and security certificate with <code class="literal">openssl</code>:<pre class="programlisting">
<span class="strong"><strong>openssl req -newkey rsa:2048 -nodes \</strong></span>
<span class="strong"><strong>     -keyout /etc/pki/tls/private/mail.example.key \</strong></span>
<span class="strong"><strong>     -x509 -days 730 -subj "/CN=mail.example.com" -text \</strong></span>
<span class="strong"><strong>     -out /etc/pki/tls/certs/mail.example.pem</strong></span>
</pre></li><li class="listitem">Use your text editor to open the <code class="literal">/etc/postfix/main.cf</code> file:<pre class="programlisting">
<span class="strong"><strong>vi /etc/postfix/main.cf</strong></span>
</pre></li><li class="listitem">At the end of the file, add the following options and values:<pre class="programlisting">
<span class="strong"><strong>smtpd_tls_security_level = may</strong></span>
<span class="strong"><strong>smtpd_tls_cert_file = /etc/pki/tls/certs/mail.example.pem</strong></span>
<span class="strong"><strong>smtpd_tls_key_file = /etc/pki/tls/private/mail.example.key</strong></span>
</pre></li><li class="listitem">Save your changes and close the file.</li><li class="listitem">Restart Postfix:<pre class="programlisting">
<span class="strong"><strong>systemctl restart postfix.service</strong></span>
</pre></li></ol></div></div><div class="section" title="How it works..."><div class="titlepage"><div><div><h2 class="title"><a id="ch09lvl2sec247"/>How it works...</h2></div></div></div><p>An encryption key and a security certificate that confirms the ownership of the key are needed for SSL/TLS communications. A self-signed certificate is sufficient for personal use or for use with services on a private network, so this recipe shows us how to generate this ourselves using <code class="literal">openssl</code>:</p><pre class="programlisting">
<span class="strong"><strong>openssl req -newkey rsa:2048 -nodes \ &#13;
  -keyout /etc/pki/tls/private/mail.example.key \ &#13;
  -x509 -days 730 -subj "/CN=mail.example.com" -text \ &#13;
  -out /etc/pki/tls/certs/mail.example.pem</strong></span>
</pre><p>The <code class="literal">req</code> option makes a new certificate request and <code class="literal">-newkey</code> asks <code class="literal">openssl</code> to generate a new private key and to use that key when it signs the certificate (this is what we mean when we say self-signed certificate). <code class="literal">rsa:2048</code> says the key will be a 2,048-bit RSA key. 2,048-bit keys are generally considered sufficiently resistant against attacks until around the year 2030 based on estimates of the rate at which computing power increases. 3,072-bit keys are considered suitable beyond that. <code class="literal">-nodes</code> prevents the key file from being encrypted with a passphrase. It's important not to encrypt the key file with a passphrase because Postfix needs to access the key. If it were encrypted, we'd need to provide the passphrase to decrypt the key every time we start Postfix.</p><p><code class="literal">-x509</code> specifies that the certificate will be an X.509 certificate (the type used by SSL and TLS connections) and <code class="literal">-days</code> sets the certificate's expiration date to a number of days in the future, in this case 730 days (3 years). <code class="literal">-subj</code> is used to specify the value for the certificate's <code class="literal">CN</code> (common name) field, which should be the hostname or the IP address of the system the certificate identifies. Alternatively, you can omit the argument and <code class="literal">openssl</code> will prompt you interactively for values for a number of other fields as well. Finally, the <code class="literal">-text</code> argument specifies that the certificate should be encoded as text as this is the format Postfix expects:</p><div class="mediaobject"><img alt="How it works..." src="graphics/image_09_003.jpg"/><div class="caption"><p>More identifying information can be embedded within a certificate</p></div></div><p>A self-signed certificate basically says, <span class="emphasis"><em>here's my encryption key. You know it's mine because I said so.</em></span> If your system's services are intended for public consumption, you'll most likely need to invest in a certificate signed by a trusted Certificate Authority (CA). Trusted certificates say, <span class="emphasis"><em>you can trust the key is mine because a mutual friend will vouch for me</em></span>. To obtain a trusted certificate, you need a certificate signing request (CSR):</p><pre class="programlisting">
<span class="strong"><strong>openssl req -new -newkey rsa:2048 -nodes \</strong></span>
<span class="strong"><strong>  -keyout mail.example.key -out mail.example.csr</strong></span>
</pre><p>Then, you send your money and the CSR to the CA. After a short wait, you'll receive your certificate.</p><div class="note" style="" title="Note"><div class="inner"><h3 class="title"><a id="note63"/>Note</h3><p>By depending on the CA and the specifics of the request, trusted certificates can become quite expensive. And trust isn't what it used to be either. A scandal erupted when it was uncovered that employees at a prominent CA were signing forged certificates, reportedly for internal testing purposes. One can only wonder at the lack of oversight given to the Web of trust. Hopefully, the worst is behind us. Browser vendors are starting to push for stricter guidelines and more auditing. There are also projects such as <span class="emphasis"><em>Let's Encrypt</em></span> which enable secure trusted certificates to be automatically generated for free.</p></div></div><p>Next, we added the necessary configuration parameters to Postfix's <code class="literal">main.cf</code> file:</p><pre class="programlisting">
<span class="strong"><strong>    smtpd_tls_security_level = may&#13;
    smtpd_tls_cert_file = /etc/pki/tls/certs/mail.example.pem&#13;
    smtpd_tls_key_file = /etc/pki/tls/private/mail.example.key&#13;
</strong></span>
</pre><p><code class="literal">smtp_tls_security_level</code> configures Postfix's enforcing behavior in relation to the encrypted connection. <code class="literal">may</code> enables opportunistic TLS—the server advertises that encryption and clients can take advantage of it but its use is not required. You may also set the parameter to <code class="literal">encrypt</code> to make the use of encryption mandatory.</p><p><code class="literal">smtpd_tls_cert_file</code> and <code class="literal">smtpd_tls_key_file</code> specify the paths to the self-signed certificate and the encryption key we generated earlier, respectively. If you're using trusted certificates then you'll also need to provide the <code class="literal">smtpd_tls_CAfile</code> parameter with a value that identifies the signing CA's public certificate.</p><p>If you find that negotiating the secure connection is slow, there are a few tuning parameters you can try. For example, we can explicitly specify the source of entropy that Postfix is using with <code class="literal">tls_random_source</code>:</p><pre class="programlisting">
<span class="strong"><strong>    tls_random_source = dev:/dev/urandom&#13;
</strong></span>
</pre><p>Also, we can cache details of the encrypted session between the server and mail client. The <code class="literal">smtpd_tls_session_cache_database</code> parameter defines the file in which Postfix will store the cached details and <code class="literal">smtpd_tls_session_cache_timeout</code> specifies how long the session can be cached. This reduces the overhead of establishing a new session each time the client connects:</p><pre class="programlisting">
<span class="strong"><strong>    smtpd_tls_session_cache_database =&#13;
      btree:/var/lib/postfix/smtpd_tls_cache&#13;
    smtpd_tls_session_cache_timeout = 3600s&#13;
</strong></span>
</pre><p>To test the configuration, you can connect using telnet and issue the <code class="literal">STARTTLS</code> command. Postfix should respond that it's ready to start negotiating the secure connection:</p><pre class="programlisting">
<span class="strong"><strong>STARTTLS</strong></span>
<span class="strong"><strong>220 Ready to start TLS</strong></span>
</pre></div><div class="section" title="See also"><div class="titlepage"><div><div><h2 class="title"><a id="ch09lvl2sec248"/>See also</h2></div></div></div><p>Refer to the following resources for working with Postfix and TLS:</p><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc">Postfix TLS Support (<a class="ulink" href="http://www.postfix.org/TLS_README.html">http://www.postfix.org/TLS_README.html</a>)</li><li class="listitem" style="list-style-type: disc">Wikipedia: Public Key Infrastructure (<a class="ulink" href="https://en.wikipedia.org/wiki/Public_key_infrastructure">https://en.wikipedia.org/wiki/Public_key_infrastructure</a>)</li><li class="listitem" style="list-style-type: disc">OpenSSL Essentials: Working with SSL Certificates, Private Keys, and CSRs (<a class="ulink" href="https://www.digitalocean.com/community/tutorials/openssl-essentials-working-with-ssl-certificates-private-keys-and-csrs">https://www.digitalocean.com/community/tutorials/openssl-essentials-working-with-ssl-certificates-private-keys-and-csrs</a>)</li></ul></div></div></div>
<div class="section" title="Configuring Dovecot for secure POP3 and IMAP access"><div class="titlepage"><div><div><h1 class="title"><a id="ch09lvl1sec77"/>Configuring Dovecot for secure POP3 and IMAP access</h1></div></div></div><p>When you check your e-mail, the e-mail program connects to your mail server to see if there are any new messages in your mail directory. If its configured to used the Post Office Protocol (POP3), it downloads the messages locally and deletes them from the server. If it's configured to use Internet Message Access Protocol (IMAP), the mail remains on the server and you manage it remotely.</p><p>Dovecot handles both protocols out of the box. Since we've already installed Dovecot for its SASL functionality, we could just open the standard ports for POP3 and IMAP traffic in the system's firewall and be done. However, the connections would be unencrypted and information would be transmitted across the network in plain text. This recipe teaches you how to secure these connections with SSL.</p><div class="section" title="Getting ready"><div class="titlepage"><div><div><h2 class="title"><a id="ch09lvl2sec249"/>Getting ready</h2></div></div></div><p>This recipe requires a CentOS system with Postfix and Dovecot configured as described in previous recipes. Administrative privileges are also required, either by logging in with the <code class="literal">root</code> account or through the use of <code class="literal">sudo</code>.</p></div><div class="section" title="How to do it..."><div class="titlepage"><div><div><h2 class="title"><a id="ch09lvl2sec250"/>How to do it...</h2></div></div></div><p>Follow these steps to configure access to Dovecot:</p><div class="orderedlist"><ol class="orderedlist arabic"><li class="listitem">Open <code class="literal">/etc/dovecot/dovecot.conf</code> with your text editor:<pre class="programlisting">
<span class="strong"><strong>vi /etc/dovecot/dovecot.conf</strong></span>
</pre></li><li class="listitem">Locate the <code class="literal">protocols</code> parameter. Remove the leading <code class="literal">#</code> character and set its value to <code class="literal">imaps pop3s</code>:<pre class="programlisting">
<span class="strong"><strong>protocols = imaps pop3s</strong></span>
</pre></li><li class="listitem">Save the changes and close the file.</li><li class="listitem">Open <code class="literal">/etc/dovecot/conf.d/10-ssl.conf</code> with your text editor:<pre class="programlisting">
<span class="strong"><strong>vi /etc/dovecot/conf.d/10-ssl.conf</strong></span>
</pre></li><li class="listitem">Locate the <code class="literal">ssl</code> parameter and set its value to <code class="literal">yes</code>:<pre class="programlisting">
<span class="strong"><strong>       ssl = yes</strong></span>
</pre></li><li class="listitem">Locate the <code class="literal">ssl_cert</code> and <code class="literal">ssl_key</code> parameters. Update their values with the paths to your certificate and key files (note that both paths are preceded with <code class="literal">&lt;</code>):<pre class="programlisting">
<span class="strong"><strong>ssl_cert = &lt;/etc/pki/tls/certs/mail.example.pem</strong></span>
<span class="strong"><strong>ssl_key = &lt;/etc/pki/tls/private/mail.example.key</strong></span>
</pre></li><li class="listitem">Save the changes and close the file.</li><li class="listitem">Restart Dovecot for the changes to take effect:<pre class="programlisting">
<span class="strong"><strong>systemctl restart dovecot.service</strong></span>
</pre></li><li class="listitem">Open port <code class="literal">993</code> for IMAP over SSL and port <code class="literal">995</code> for POP3 over SSL in the firewall:<pre class="programlisting">
<span class="strong"><strong>firewall-cmd --permanent --add-service=imaps \</strong></span>
<span class="strong"><strong>     --add-service=pop3s</strong></span>
<span class="strong"><strong>firewall-cmd --reload</strong></span>
</pre></li></ol></div></div><div class="section" title="How it works..."><div class="titlepage"><div><div><h2 class="title"><a id="ch09lvl2sec251"/>How it works...</h2></div></div></div><p>Dovecot makes it easy to secure the traffic for POP3 and IMAP connections; in fact, configuring it only took a few seconds. We first edited the <code class="literal">protocols</code> parameter <code class="literal">/etc/dovecot/dovecot.conf</code> to let Dovecot know that we want these protocols to be secured:</p><pre class="programlisting">
<span class="strong"><strong>protocols = imaps pop3s</strong></span>
</pre><p>Then we updated <code class="literal">/etc/dovecot/conf.d/10-ssl.conf</code> to enable SSL to use the <code class="literal">ssl</code> parameter and to identify a certificate and encryption key using <code class="literal">ssl_cert</code> and <code class="literal">ssl_key</code>. Since Postfix and Dovecot are running on the same system and we already generated a key and certificate for Postfix, we can reference the same files in Dovecot's configuration. Dovecot uses the leading <code class="literal">&lt;</code> in front of the paths to specify that it should use the file's content for the parameter's value and not the literal string itself:</p><pre class="programlisting">
<span class="strong"><strong>ssl = yes</strong></span>
<span class="strong"><strong>ssl_cert = &lt;/etc/pki/tls/certs/mail.example.pem</strong></span>
<span class="strong"><strong>ssl_key = &lt;/etc/pki/tls/private/mail.example.key</strong></span>
</pre><p>Dovecot will still allow non-SSL access to POP and IMAP (on ports <code class="literal">110</code> and <code class="literal">143</code>, respectively) from connections originating from the localhost, but once we restart it for the configuration changes to take effect, all other users will need to use SSL to access their messages.</p><p>We can use <code class="literal">mailx</code> to test the configuration. First, we'll check POP3:</p><pre class="programlisting">
<span class="strong"><strong>mailx -f pop3s://tboronczyk@mail.example.com</strong></span>
</pre><p>The <code class="literal">-f</code> argument specifies the directory that <code class="literal">mailx</code> will read from to retrieve our messages. Given as a URI, the value instructs <code class="literal">mailx</code> to read the default directory for our user on the <code class="literal">mail.example.com</code> system using POP3 over SSL (<code class="literal">pop3s</code>).</p><p>The command is the same to check IMAP apart from changing the URI's protocol:</p><pre class="programlisting">
<span class="strong"><strong>mailx -f imaps://tboronczyk@mail.example.com</strong></span>
</pre><p>Because we're using a self-signed certificate, <code class="literal">mailx</code> will complain that the certificate has not been marked as trusted by the user and prompt us whether we want to continue. Respond with <code class="literal">y </code>to this and you'll then be prompted for the user's password. <code class="literal">mailx</code> then displays the user's inbox. Exit the program by entering <code class="literal">quit</code> at the prompt:</p><div class="mediaobject"><img alt="How it works..." src="graphics/image_09_004.jpg"/><div class="caption"><p>mailx can be used to test our configuration of POP3 and IMAP over SSL</p></div></div><div class="note" style="" title="Note"><div class="inner"><h3 class="title"><a id="note64"/>Note</h3><p>If <code class="literal">mailx</code> complains that it's missing the <code class="literal">nss-config-dir</code> variable, you can define it on the command line using <code class="literal">-S</code>. The value should be a path to the certificate databases that <code class="literal">mailx</code> can use to verify certificate trust:</p><p>
</p><pre class="programlisting"><span class="strong"><strong>mailx -S nss-config-dir=/etc/pki/nssdb \</strong></span>
<span class="strong"><strong>   -f pop3s://tboronczyk@mail.example.com</strong></span></pre><p>
</p></div></div><p>When we first configured Postfix, we adjusted its <code class="literal">home_mailbox</code> parameter to store messages in separate directories. I acknowledged this was optional at that time but it would make things easier and cleaner when we set up retrieval access. If you didn't set <code class="literal">home_mailbox</code> at that time, incoming messages are appended to the user's mail spool file under <code class="literal">/var/spool/mail</code> and some additional configuration is necessary for Dovecot to access them. These changes can be made in <code class="literal">/etc/dovecot/conf.d/10-mail.conf</code>.</p><p>Alternatively, you can convert the spool file to separate messages in a <code class="literal">Maildir</code> directory at this time. First, install the <code class="literal">mb2md</code> package:</p><pre class="programlisting">
<span class="strong"><strong>yum install ftp://ftp.pbone.net/mirror/atrpms.net/el7- &#13;
    x86_64/atrpms/stable/mb2md-3.20-2.at.noarch.rpm</strong></span>
</pre><p>Open the <code class="literal">/etc/postfix/main.cf</code> file and locate the <code class="literal">home_mailbox</code> parameter. Remove the leading <code class="literal">#</code> character from the entry with the value <code class="literal">Maildir/</code>:</p><pre class="programlisting">
<span class="strong"><strong>home_mailbox = Maildir/</strong></span>
</pre><p>Save your changes and then restart Postfix for the update to take effect. Then, for each account, invoke <code class="literal">mb2md</code> to convert the spool file. The utility needs to be run as the target user, so use <code class="literal">su</code> to temporarily switch to that user's context:</p><pre class="programlisting">
<span class="strong"><strong>su -l -c "mb2md -m" tboronczyk</strong></span>
</pre></div><div class="section" title="See also"><div class="titlepage"><div><div><h2 class="title"><a id="ch09lvl2sec252"/>See also</h2></div></div></div><p>Refer to the following resources for more information on the different topics discussed in this recipe, including Dovecot, POP3, and IMAP.</p><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc">The<code class="literal"> mailx</code> manual page (<code class="literal">man 1 mailx</code>)</li><li class="listitem" style="list-style-type: disc">The Dovecot Homepage (<a class="ulink" href="http://www.dovecot.org/">http://www.dovecot.org/</a>)</li><li class="listitem" style="list-style-type: disc">RFC 3501: Internet Message Access Protocol (<a class="ulink" href="https://tools.ietf.org/html/rfc3501">https://tools.ietf.org/html/rfc3501</a>)</li><li class="listitem" style="list-style-type: disc">RFC 1939: Post Office Protocol (<a class="ulink" href="https://tools.ietf.org/html/rfc1939">https://tools.ietf.org/html/rfc1939</a>)</li><li class="listitem" style="list-style-type: disc">Converting Mbox Mailboxes to Maildir format (<a class="ulink" href="http://batleth.sapienti-sat.org/projects/mb2md/">http://batleth.sapienti-sat.org/projects/mb2md/</a>)</li></ul></div></div></div>
<div class="section" title="Targeting spam with SpamAssassin"><div class="titlepage"><div><div><h1 class="title"><a id="ch09lvl1sec78"/>Targeting spam with SpamAssassin</h1></div></div></div><p>Some estimates propose that over 90% of all e-mail is unsolicited advertisements (spam)! Regardless of whether these estimates are correct or not, there's no denying that spam is a huge problem. Unwanted messages cause extra load on mail servers, consume storage space, and can even be a security risk. Also, while there have been many attempts to legally manage spam, such attempts have largely failed.</p><p>This recipe teaches you how to set up SpamAssassin to identify spam messages. SpamAssassin filters incoming messages by checking for various spam hallmarks, such as missing headers and invalid return addresses, and uses heuristics to analyze the message content. Each check contributes to the message's overall spam score, and if this score exceeds the defined threshold then the message is labeled spam.</p><div class="section" title="Getting ready"><div class="titlepage"><div><div><h2 class="title"><a id="ch09lvl2sec253"/>Getting ready</h2></div></div></div><p>This recipe requires a CentOS system with Postfix configured as described in the previous recipe. Administrative privileges are also required, either by logging in with the root account or through the use of <code class="literal">sudo</code>.</p></div><div class="section" title="How to do it..."><div class="titlepage"><div><div><h2 class="title"><a id="ch09lvl2sec254"/>How to do it...</h2></div></div></div><p>Follow these steps to identify spam using SpamAssassin:</p><div class="orderedlist"><ol class="orderedlist arabic"><li class="listitem">Install the <code class="literal">spamassassin</code> package:<pre class="programlisting">
<span class="strong"><strong>yum install spamassassin</strong></span>
</pre></li><li class="listitem">Start SpamAssassin and optionally enable it to start automatically whenever the system reboots:<pre class="programlisting">
<span class="strong"><strong>systemctl start spamassassin.service</strong></span>
<span class="strong"><strong>systemctl enable spamassassin.service</strong></span>
</pre></li><li class="listitem">Create SpamAssassin's Bayesian classifier database:<pre class="programlisting">
<span class="strong"><strong>sa-learn --sync</strong></span>
</pre></li><li class="listitem">Create an unprivileged system user account that Postfix can use to communicate with SpamAssassin:<pre class="programlisting">
<span class="strong"><strong>useradd -r -s /sbin/nologin spamd</strong></span>
</pre></li><li class="listitem">Open Postfix's <code class="literal">master.cf</code> file for editing:<pre class="programlisting">
<span class="strong"><strong>vi /etc/postfix/master.cf</strong></span>
</pre></li><li class="listitem">Locate the line that defines the <code class="literal">smtp</code> service and append the <code class="literal">-o</code> argument specifying <code class="literal">spamassassin</code> as a content filter:<pre class="programlisting">
<span class="strong"><strong>smtp inet n - n - - smtpd -o content_filter=spamassassin</strong></span>
</pre></li><li class="listitem">At the end of the configuration file, add the definition for the <code class="literal">spamassassin</code> filter:<pre class="programlisting">
<span class="strong"><strong>spamassassin unix - n n - - pipe user=spamd  argv=/usr/bin/spamc -e &#13;
       /usr/sbin/sendmail -oi -f ${sender}  ${recipient}</strong></span>
</pre></li><li class="listitem">Save your changes and close the file.</li><li class="listitem">Restart Postfix for the updates to the configuration to take effect:<pre class="programlisting">
<span class="strong"><strong>systemctl restart postfix.service</strong></span>
</pre></li></ol></div></div><div class="section" title="How it works..."><div class="titlepage"><div><div><h2 class="title"><a id="ch09lvl2sec255"/>How it works...</h2></div></div></div><p>The initial installation of SpamAssassin is pretty straightforward. We installed the <code class="literal">spamassassin</code> package and started and enabled the <code class="literal">spamassassin</code> service which runs the <code class="literal">spamd</code> daemon. The client program <code class="literal">spamc</code> is used to communicate with the daemon, and the rest of the recipe's steps focused on configuring Postfix to use <code class="literal">spamc</code> to score the e-mail message.</p><p>We created a new user account named <code class="literal">spamd</code> for Postfix to use when it invokes <code class="literal">spamc</code>. The account is intended to be a noninteractive system account, so we provided the <code class="literal">-r</code> argument. This causes no <code class="literal">home</code> directory to be created and the account's user ID to be assigned a value less than 100. The <code class="literal">-s</code> argument gives <code class="literal">/sbin/nologin</code> as the account's shell to prevent someone from logging in using the account:</p><pre class="programlisting">
<span class="strong"><strong>useradd -r -s /sbin/nologin spamd</strong></span>
</pre><p>For Postfix to pass messages to SpamAssassin, we need to define a new <code class="literal">spamassassin</code> service in its <code class="literal">master.cf</code> configuration file and ask Postfix to use the service as a content filter. The organization of <code class="literal">master.cf</code> is much different from the configuration files we've seen before—each line defines a process in the mail delivery pipeline and certain properties about it.</p><p>The first active entry in the file is for the <code class="literal">smtp</code> service and looks like this:</p><pre class="programlisting">
<span class="strong"><strong>smtp inet n - n - - smtpd</strong></span>
</pre><p>The first column is the name of the service and the second column specifies how the service will communicate. For example, <code class="literal">inet</code> signifies that the process uses a TCP/IP socket while <code class="literal">unix</code> signifies that it uses a local unix-domain socket. The next three columns indicate whether the process is private (only accessible to Postfix), runs without administrative privileges, and is chrooted. Their values can be <code class="literal">y</code> for yes, <code class="literal">n</code> for no, or <code class="literal">-</code> for Postfix's default value. The remaining columns provide a wakeup timer for processes that run at time intervals, the limit for the number of instances that can be running at the same time, and the command that's invoked to provide the service.</p><p>To set our <code class="literal">spamassassin</code> service as a filter, we updated the <code class="literal">smtp</code> service's command with the <code class="literal">-o</code> option to set the <code class="literal">content_filter</code> parameter with the name of our service:</p><pre class="programlisting">
<span class="strong"><strong>smtp inet n - n - - smtpd -o content_filter=spamassassin</strong></span>
</pre><p>Then we defined the <code class="literal">spamassassin</code> service at the bottom of the file:</p><pre class="programlisting">
<span class="strong"><strong>spamassassin unix - n n - - pipe user=spamd argv=/usr/bin/spamc -e  &#13;
/usr/sbin/sendmail -oi -f ${sender} ${recipient}</strong></span>
</pre><p>The <code class="literal">pipe</code> command is part of Postfix's delivery system with the purpose of piping messages to external processes. The <code class="literal">user</code> argument specifies the name of the user account the invoked process will run under and <code class="literal">argv</code> is the command and its arguments that will be run. Our definition references the <code class="literal">spamd</code> user we created earlier and pipes the message to the <code class="literal">spamc</code> client.</p><p>After the message is reviewed by <code class="literal">spamd</code>, <code class="literal">spamc</code> returns the message to stdout by default. To avoid losing the message, we pipe the output to another process to deliver the message. <code class="literal">-e</code> instructs <code class="literal">spamc</code> to pipe the output for handling, in this case to a program named <code class="literal">sendmail</code>.</p><p>Sendmail is another mail server that's quite older than Postfix. It dominated the e-mail landscape for decades, and as such many programs attempt to interface with it to send mail. This instance of <code class="literal">sendmail</code> is actually Postfix's Sendmail compatibility interface which allows other processes to think they're calling Sendmail when in fact they're really working with Postfix. The <code class="literal">-oi</code> argument for <code class="literal">sendmail</code> instructs the mail server to treat lines with a single dot as regular input and not interpret it as the end of the message. The <code class="literal">-f</code> argument sets the from address of the message to the value of <code class="literal">${sender}</code>, a special variable populated by Postfix with the sender's e-mail address, and the message is sent to <code class="literal">${recipient}</code>, the recipient's e-mail address.</p><p>To test the configuration, we can send an e-mail message with the following subject—it's a known value that SpamAssassin always marks as spam:</p><pre class="programlisting">
<span class="strong"><strong>XJS*C4JDBQADN1.NSBN3*2IDNEN*GTUBE-STANDARD-ANTI-UBE-TEST- EMAIL*C.34X</strong></span>
</pre><div class="mediaobject"><img alt="How it works..." src="graphics/image_09_005.jpg"/><div class="caption"><p>An e-mail is sent with a known signature in the subject line to test SpamAssassin</p></div></div><p>When you check the message in your inbox, you'll notice that SpamAssassin will have prepended <code class="literal">[SPAM]</code> to the subject line, allowing you to easily identify unwanted messages. It also adds additional headers to the message that summarizes its findings that lead it to the conclusion that the message is spam:</p><div class="mediaobject"><img alt="How it works..." src="graphics/image_09_006.jpg"/><div class="caption"><p>SpamAssassin updates a message's subject line and adds additional headers to explain why it thinks the message is spam</p></div></div><p>Keep in mind that the world of spam is constantly in flux; programmers are working hard to build better spam filters, but spammers are working just as hard to find ways to circumvent them. For this reason, it's important to keep SpamAssassin's database up to date. A cron job is added when SpamAssassin is installed that will update its database daily, but you can also run an update manually any time you like by running:</p><pre class="programlisting">
<span class="strong"><strong>sa-update</strong></span>
</pre><p>If SpamAssassin is falsely identifying a large amount of legitimate messages as spam or vice versa, you can train it's Bayesian classifier to better identify unwanted messages using <code class="literal">sa-learn</code>. We can provide a collection of messages we know are spam and identify them as such with the <code class="literal">--spam</code> argument, and good messages with <code class="literal">--ham</code> for the program to study:</p><pre class="programlisting">
<span class="strong"><strong>sa-learn --ham /home/tboronczyk/Maildir/cur</strong></span>
<span class="strong"><strong>sa-learn --spam /home/tboronczyk/Mail/.Spam</strong></span>
</pre><p><code class="literal">sa-learn</code> keeps track of the messages it's seen. If you have previously indicated that a message is spam and then later use it as ham, the program will remove it from its spam database, and vice versa if you indicate an e-mail is good but later decide it should be used as spam.</p></div><div class="section" title="See also"><div class="titlepage"><div><div><h2 class="title"><a id="ch09lvl2sec256"/>See also</h2></div></div></div><p>Refer to the following resources for more information on working with SpamAssassin:</p><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc">The <code class="literal">sa-learn</code> manual page (<code class="literal">man 1 sa-learn</code>)</li><li class="listitem" style="list-style-type: disc">SpamAssassin Home Page (<a class="ulink" href="http://spamassassin.apache.org/">http://spamassassin.apache.org/</a>)</li><li class="listitem" style="list-style-type: disc">Rum SpamAssassin with Postfix (<a class="ulink" href="http://howto.gumph.org/content/run-spamassassin-with-postfix/">http://howto.gumph.org/content/run-spamassassin-with-postfix/</a>)</li><li class="listitem" style="list-style-type: disc">Stop Spam on your Postfix Server with SpamAssassin (<a class="ulink" href="https://www.linux.com/learn/stop-spam-your-postfix-server-spamassassin">https://www.linux.com/learn/stop-spam-your-postfix-server-spamassassin</a>)</li><li class="listitem" style="list-style-type: disc">Bayes Theorem Explained Like You're Five (<a class="ulink" href="https://www.youtube.com/watch?v=2Df1sDAyRvQ">https://www.youtube.com/watch?v=2Df1sDAyRvQ</a>)</li></ul></div></div></div>
<div class="section" title="Routing messages with Procmail"><div class="titlepage"><div><div><h1 class="title"><a id="ch09lvl1sec79"/>Routing messages with Procmail</h1></div></div></div><p>Depending on your preferences, tagging messages as spam may not be enough. Maybe you'll want to set up a rule in your e-mail client that moves any unwanted messages from your inbox to a dedicated spam directory. Or maybe you want such routing to happen automatically on the server. We can configure this using Procmail, a mail filtering and delivery agent.</p><p>In this recipe, we'll look at how to configure Procmail to route messages. We'll scan incoming mail, looking for a special header that SpamAssassin adds to messages if it thinks they're spam and then deliver them to a separate directory instead of the inbox.</p><div class="section" title="Getting ready"><div class="titlepage"><div><div><h2 class="title"><a id="ch09lvl2sec257"/>Getting ready</h2></div></div></div><p>This recipe requires a CentOS system with Postfix configured as described in the previous recipes. Administrative privileges are also required, either by logging in with the <code class="literal">root</code> account or through the use of <code class="literal">sudo</code>.</p></div><div class="section" title="How to do it..."><div class="titlepage"><div><div><h2 class="title"><a id="ch09lvl2sec258"/>How to do it...</h2></div></div></div><p>Follow these steps to set up Procmail to route messages:</p><div class="orderedlist"><ol class="orderedlist arabic"><li class="listitem">Create the <code class="literal">/etc/procmailrc</code> file with the following content:<pre class="programlisting">
<span class="strong"><strong>MAILDIR=$HOME/Maildir</strong></span>
<span class="strong"><strong>DEFAULT=$MAILDIR/new</strong></span>
<span class="strong"><strong>INCLUDERC=/etc/mail/spamassassin/spamassassin-spamc.rc</strong></span>
<span class="strong"><strong>:0</strong></span>
<span class="strong"><strong>* ^X-Spam-Status: Yes</strong></span>
<span class="strong"><strong>.Spam</strong></span>
</pre></li><li class="listitem">Create each user's spam directory:<pre class="programlisting">
<span class="strong"><strong>echo Spam &gt;&gt; /home/tboronczyk/Maildir/subscriptions</strong></span>
<span class="strong"><strong>mkdir /home/tboronczyk/Maildir/.Spam</strong></span>
</pre></li><li class="listitem">If you created the user's spam directory as <code class="literal">root</code>, fix the directory and subscription file's ownership and permissions:<pre class="programlisting">
<span class="strong"><strong>chown tboronczyk /home/tboronczyk/Maildir/subscriptions</strong></span>
<span class="strong"><strong>chmod 0600 /home/tboronczyk/Maildir/subscriptions</strong></span>
<span class="strong"><strong>chown tboronczyk.tboronczyk /home/tboronczyk/Maildir/.Spam</strong></span>
<span class="strong"><strong>chmod 0700 /home/tboronczyk/Maildir/.Spam</strong></span>
</pre></li><li class="listitem">Open Postfix's <code class="literal">main.cf</code> configuration file with your editor:<pre class="programlisting">
<span class="strong"><strong>vi /etc/postfix/main.cf</strong></span>
</pre></li><li class="listitem">Locate the example <code class="literal">mailbox_command</code> parameters. Uncomment the second example and correct its path to the <code class="literal">procmail</code> executable:<pre class="programlisting">
<span class="strong"><strong>mailbox_command = /bin/procmail -a "$EXTENSION"</strong></span>
</pre></li><li class="listitem">Save the changes and close the file.</li><li class="listitem">Restart Postfix for the updated configuration to take effect:<pre class="programlisting">
<span class="strong"><strong>systemctl restart postfix.service</strong></span>
</pre></li></ol></div></div><div class="section" title="How it works..."><div class="titlepage"><div><div><h2 class="title"><a id="ch09lvl2sec259"/>How it works...</h2></div></div></div><p>Like Postfix, Procmail is installed by default on CentOS systems. However, we need to create its configuration file for it to be useful to us. The main configuration file is <code class="literal">/etc/procmailrc</code> and we start it by defining the <code class="literal">MAILDIR</code>, <code class="literal">DEFAULT</code>, and <code class="literal">INCLUDERC</code> variables.</p><pre class="programlisting">
<span class="strong"><strong>MAILDIR=$HOME/Maildir</strong></span>
<span class="strong"><strong>DEFAULT=$MAILDIR/new</strong></span>
<span class="strong"><strong>INCLUDERC=/etc/mail/spamassassin/spamassassin-spamc.rc</strong></span>
</pre><p><code class="literal">MAILDIR</code> provides the location of the user's mail directory. <code class="literal">procmailrc</code> is a global configuration file and we use <code class="literal">$HOME</code> to denote the user's home directory in which <code class="literal">Maildir</code> resides. <code class="literal">DEFAULT</code> provides the default location for incoming mail, which is the mail directory's <code class="literal">new</code> directory.</p><p><code class="literal">INCLUDERC</code> gives the name of other files that should be included when Procmail processes the configuration file. In this case, SpamAssassin installs a configuration file to integrate with Procmail which we reference.</p><p>The second part of the configuration appears as a cryptic incantation—the definition of a matching rule. In Procmail parlance, they're called recipes:</p><pre class="programlisting">
<span class="strong"><strong>:0</strong></span>
<span class="strong"><strong>* ^X-Spam-Status: Yes</strong></span>
<span class="strong"><strong>.Spam</strong></span>
</pre><p>More than one rule can be given in the configuration file, in which case they are processed in the order in which they appear, top to bottom.</p><p>All rules begin with <code class="literal">:0</code> and contain conditions followed by an action. Here, the condition starts with <code class="literal">*</code> to specify a regular expression pattern that Procmail will search the message and its headers for. The action line then lists the directory that matching messages will be delivered to. If it's given as a relative path, the directory considered will be relative to <code class="literal">$MAILDIR</code>. Thus, the rule asks Procmail to route any messages flagged with the <code class="literal">X-Spam-Status</code> header by SpamAssassin to the user's <code class="literal">Maildir/.Spam</code> directory.</p><p>The original Maildir specification only allows the <code class="literal">new</code>, <code class="literal">cur</code>, and <code class="literal">tmp</code> directories, but others have augmented it to support additional directories. The user can either create their spam directory through their e-mail client over IMAP, in which case all of the details are worked out by Dovecot. Alternatively, we can create it for them in the filesystem. When we create a directory manually, the <code class="literal">subscriptions</code> file must list the additional directories, one entry per line, for them to be visible in the user's mail client. The directories themselves are then named with a leading dot:</p><pre class="programlisting">
<span class="strong"><strong>echo Spam &gt;&gt; /home/tboronczyk/Maildir/subscriptions</strong></span>
<span class="strong"><strong>mkdir /home/tboronczyk/Maildir/.Spam</strong></span>
</pre><p>Procmail also allows for per-user actions as well. For example, if only one user wants to have flagged messages moved to their spam folder, the matching rule can be moved from the global configuration under <code class="literal">/etc</code> to a file named <code class="literal">.procmailrc</code> in their <code class="literal">home</code> directory. It's still recommended that you keep the variable definitions in the global configuration so that they'll be available to all users, as Procmail executes the global file first and then the user's local <code class="literal">.procmailrc</code> if it's available.</p><p>Various flags can be given after <code class="literal">:0</code> that modify how Procmail behaves or how the rule is interpreted. For example, Procmail only search the message's headers by default. To search the message's body, we need to provide the <code class="literal">B</code> flag. The following rule is an example that searches the message's body for the text "Hello World" and routes the matching messages to <code class="literal">/dev/null</code>:</p><pre class="programlisting">
<span class="strong"><strong>:0 B</strong></span>
<span class="strong"><strong>* Hello World</strong></span>
<span class="strong"><strong>/dev/null</strong></span>
</pre><p>Some flags you may find useful are:</p><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc"><code class="literal">H</code>: Search the message's headers</li><li class="listitem" style="list-style-type: disc"><code class="literal">B</code>: Search the message's body</li><li class="listitem" style="list-style-type: disc"><code class="literal">D</code>: Match the regular expression in a case-sensitive manner</li><li class="listitem" style="list-style-type: disc"><code class="literal">e</code>: Only execute the rule if the rule immediately preceding it was unsuccessful</li><li class="listitem" style="list-style-type: disc"><code class="literal">c</code>: Create a copy of the message</li><li class="listitem" style="list-style-type: disc"><code class="literal">h</code>: Only send the message's header to a piped program</li><li class="listitem" style="list-style-type: disc"><code class="literal">b</code>: Only send the message's body to a piped program</li></ul></div><p>If the action begins with <code class="literal">|</code> then the value is interpreted as a command and the message is piped to it. Here's an example that sends a copy of any messages received from the human resources department to the printer by piping it through <code class="literal">lpr</code>:</p><pre class="programlisting">
<span class="strong"><strong>:0 c</strong></span>
<span class="strong"><strong>* ^From: hr-dept@example.com</strong></span>
<span class="strong"><strong>| lpr</strong></span>
</pre><p>If the action begins with <code class="literal">!</code> then the value is seen as an e-mail and the message is forwarded. This example routes an e-mail from a known recipient to a personal e-mail account instead:</p><pre class="programlisting">
<span class="strong"><strong>:0</strong></span>
<span class="strong"><strong>* ^From: secret-admirer@example.com</strong></span>
<span class="strong"><strong>! tboronczyk@another-example.com</strong></span>
</pre></div><div class="section" title="See also"><div class="titlepage"><div><div><h2 class="title"><a id="ch09lvl2sec260"/>See also</h2></div></div></div><p>Refer to the following resources for more information on Procmail:</p><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc">The<code class="literal"> procmail</code> manual page (<code class="literal">man 1 procmail</code>)</li><li class="listitem" style="list-style-type: disc">The <code class="literal">procmailrc</code> file manual page (<code class="literal">man 5 procmailrc</code>)</li><li class="listitem" style="list-style-type: disc">Timo's Promail tips and recipes (<a class="ulink" href="http://www.netikka.net/tsneti/info/proctips.php">http://www.netikka.net/tsneti/info/proctips.php</a>)</li></ul></div></div></div></body></html>