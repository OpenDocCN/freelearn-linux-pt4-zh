- en: Chapter 10. Troubleshooting DNS Services
  prefs:
  - PREF_H1
  type: TYPE_NORMAL
- en: As the Domain Name System (DNS) is probably the most influential technology
    in the world of IT, at some point in your career you should expect that it will
    be presented to you as an ongoing issue that needs to be managed and resolved.
    DNS servers come in various forms, and your level of control may vary depending
    on the type of infrastructure you have access to but, regardless of this, the
    issues will undoubtedly remain the same, in whole or part.
  prefs: []
  type: TYPE_NORMAL
- en: Having already reviewed the virtue of `dig` and the various other networking
    tools, in the final few pages of this book we will now discuss the process of
    troubleshooting CentOS 7 with specific regard to monitoring issues related to
    DNS as a function of the overall system health check.
  prefs: []
  type: TYPE_NORMAL
- en: 'In this chapter, we will:'
  prefs: []
  type: TYPE_NORMAL
- en: Learn how to change the hostname of the system using `hostnamectl` and managing
    the `fqdn` with `/etc/hosts`
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
- en: Learn how to perform a few basic system and BIND-based sanity checks before
    hitting the panic button
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
- en: Learn how to monitor bandwidth with `iftop`
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
- en: Learn how to flush the cache
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
- en: Changing the hostname and managing the FQDN
  prefs:
  - PREF_H1
  type: TYPE_NORMAL
- en: Changing the hostname of an authoritative or a recursive (caching) server may
    not necessarily be a DNS issue (per se), but, as a rule of thumb, the hostname
    of your system is inextricably linked to the DNS as a function of the overall
    system in question; for this reason, we will now review the procedure to change
    the hostname of the host system.
  prefs: []
  type: TYPE_NORMAL
- en: 'To review the current hostname, you can use the following syntax:'
  prefs: []
  type: TYPE_NORMAL
- en: '[PRE0]'
  prefs: []
  type: TYPE_PRE
- en: 'However, you can choose to view the static, transient, or pretty name with
    one of the following commands:'
  prefs: []
  type: TYPE_NORMAL
- en: '[PRE1]'
  prefs: []
  type: TYPE_PRE
- en: 'Based on this, to change the hostname you should use the following command:'
  prefs: []
  type: TYPE_NORMAL
- en: '[PRE2]'
  prefs: []
  type: TYPE_PRE
- en: 'Alternatively, you can choose to update the static hostname with this:'
  prefs: []
  type: TYPE_NORMAL
- en: '[PRE3]'
  prefs: []
  type: TYPE_PRE
- en: Having completed this action, the hostname change will be applied to the kernel
    automatically without any need to reboot. Subsequently, any change to the hostname
    must be reflected in the system's networking configuration.
  prefs: []
  type: TYPE_NORMAL
- en: 'To do this, you will have to check and confirm `/etc/hosts` is up-to-date by
    typing:'
  prefs: []
  type: TYPE_NORMAL
- en: '[PRE4]'
  prefs: []
  type: TYPE_PRE
- en: 'A typical post-installation (or default) file will look like this:'
  prefs: []
  type: TYPE_NORMAL
- en: '[PRE5]'
  prefs: []
  type: TYPE_PRE
- en: 'To proceed, simply change the file to read as follows by substituting the relevant
    values that suit your system configuration:'
  prefs: []
  type: TYPE_NORMAL
- en: '[PRE6]'
  prefs: []
  type: TYPE_PRE
- en: 'For example, if your server name is `centos7` (hostname) and it is on the `centos.local`
    domain, then your file will look like this:'
  prefs: []
  type: TYPE_NORMAL
- en: '[PRE7]'
  prefs: []
  type: TYPE_PRE
- en: 'Once this is complete, you can confirm the hostname by typing this:'
  prefs: []
  type: TYPE_NORMAL
- en: '[PRE8]'
  prefs: []
  type: TYPE_PRE
- en: 'Then you can confirm and print the current FQDN by typing the following command:'
  prefs: []
  type: TYPE_NORMAL
- en: '[PRE9]'
  prefs: []
  type: TYPE_PRE
- en: 'However, if you discover that the new hostname has not been accepted or updated,
    then simply type the following command to resolve any outstanding issues:'
  prefs: []
  type: TYPE_NORMAL
- en: '[PRE10]'
  prefs: []
  type: TYPE_PRE
- en: 'You can then confirm these changes by running `ping` on the server in the following
    way:'
  prefs: []
  type: TYPE_NORMAL
- en: '[PRE11]'
  prefs: []
  type: TYPE_PRE
- en: 'Based on the preceding example, if you run:'
  prefs: []
  type: TYPE_NORMAL
- en: '[PRE12]'
  prefs: []
  type: TYPE_PRE
- en: 'The output of `ping` should now show the FQDN like this:'
  prefs: []
  type: TYPE_NORMAL
- en: '[PRE13]'
  prefs: []
  type: TYPE_PRE
- en: Performing system sanity checks with BIND
  prefs:
  - PREF_H1
  type: TYPE_NORMAL
- en: DNS failures can be the result of some fairly innocuous issues that arise due
    to fundamental configuration flaws or recent changes (and updates) to a system.
    This type of event can happen and, for this reason, it is always useful to run
    through a checklist of sanity checks before you hit the panic button.
  prefs: []
  type: TYPE_NORMAL
- en: 'So, by starting with a basic tool such as `ping`, `nslookup`, or `dig`, you
    can begin testing for areas of concern. For example, you can use `telnet` like
    this:'
  prefs: []
  type: TYPE_NORMAL
- en: '[PRE14]'
  prefs: []
  type: TYPE_PRE
- en: The `telnet` command is a nice and easy tool to use, and if the connection is
    refused or takes too long, then you can rule out the possibility of RDNS errors
    by simply renaming the reverse DNS file and trying again.
  prefs: []
  type: TYPE_NORMAL
- en: 'Now, if you do this, make sure that the forward DNS remains functional and
    reattempts a telnet connection. If this works, you will know that the RDNS is
    at fault and you can double-check this by confirming the forward zones with `nslookup`:'
  prefs: []
  type: TYPE_NORMAL
- en: '[PRE15]'
  prefs: []
  type: TYPE_PRE
- en: 'However, if you are still unable to connect, then you should restore the RDNS
    file, check your firewall configuration (and `SELinux`, if used), and then use
    the following command to view the current status of port 53:'
  prefs: []
  type: TYPE_NORMAL
- en: '[PRE16]'
  prefs: []
  type: TYPE_PRE
- en: 'If you are still encountering difficulties, then you should also check the
    log files like this:'
  prefs: []
  type: TYPE_NORMAL
- en: '[PRE17]'
  prefs: []
  type: TYPE_PRE
- en: 'Now confirm the status of the named service:'
  prefs: []
  type: TYPE_NORMAL
- en: '[PRE18]'
  prefs: []
  type: TYPE_PRE
- en: 'However, it is far more informative if you use the following code:'
  prefs: []
  type: TYPE_NORMAL
- en: '[PRE19]'
  prefs: []
  type: TYPE_PRE
- en: 'The output of this command may begin with the following notice before listing
    any current resolving errors:'
  prefs: []
  type: TYPE_NORMAL
- en: '[PRE20]'
  prefs: []
  type: TYPE_PRE
- en: 'If all is well, the next step will be to check your zone files for errors:'
  prefs: []
  type: TYPE_NORMAL
- en: '[PRE21]'
  prefs: []
  type: TYPE_PRE
- en: 'Remember, if no errors are found, then no output will be provided. However,
    if you do encounter an error, depending on the system in question, the output
    may look like this:'
  prefs: []
  type: TYPE_NORMAL
- en: '[PRE22]'
  prefs: []
  type: TYPE_PRE
- en: Moving beyond this, you can also use the provided package called `named-checkzone`
    to check and confirm the overall integrity and syntax of a zone file. It works
    by creating a false load situation and thereby runs the same validation rules
    as it would before it is loaded into the system. In this way, it makes a remarkably
    reliable approach to confirming new zone files before adding them to a production
    server.
  prefs: []
  type: TYPE_NORMAL
- en: 'To use `named-checkzone`, you have to type:'
  prefs: []
  type: TYPE_NORMAL
- en: '[PRE23]'
  prefs: []
  type: TYPE_PRE
- en: 'Alternatively, you can check a specific hostname with:'
  prefs: []
  type: TYPE_NORMAL
- en: '[PRE24]'
  prefs: []
  type: TYPE_PRE
- en: 'On the other hand, if you are in a situation where no nameserver is currently
    configured or the nameserver is found to be inaccessible, the first port of call
    is to check the system''s resolver in order to confirm that it is configured correctly
    by opening the following file:'
  prefs: []
  type: TYPE_NORMAL
- en: '[PRE25]'
  prefs: []
  type: TYPE_PRE
- en: 'Having opened this file, you will notice that the first entry should point
    to the primary or master nameserver followed by an entry for the secondary or
    slave nameserver. Generally speaking, you should expect to see at least two nameservers,
    but three is also common. Depending on the system''s configuration, an example
    of `/etc/resolv.conf` may look like this:'
  prefs: []
  type: TYPE_NORMAL
- en: '[PRE26]'
  prefs: []
  type: TYPE_PRE
- en: 'For example, if you were using Google''s DNS, then the primary nameserver will
    be 8.8.8.8 and the secondary nameserver will be 8.8.4.4\. Consequently, your file
    will look like this:'
  prefs: []
  type: TYPE_NORMAL
- en: '[PRE27]'
  prefs: []
  type: TYPE_PRE
- en: 'On the off chance that the system is using `127.0.0.1` or `localhost` as the
    primary or sole nameserver, then you should also expect to find forwarders being
    used in the main DNS configuration file. The exact nature of how this is to be
    done will depend on what DNS application you are currently using. However, in
    the case of `BIND`, this would be found within the `options` section of `/etc/named.conf`
    as follows:'
  prefs: []
  type: TYPE_NORMAL
- en: '[PRE28]'
  prefs: []
  type: TYPE_PRE
- en: 'Moreover, while you are reviewing the `BIND` configuration file, you should
    also ensure that recursion is disabled in order to reduce recursive queries, and
    thereby protect the system from the risk of `DDoS Amplication` attacks like this:'
  prefs: []
  type: TYPE_NORMAL
- en: '[PRE29]'
  prefs: []
  type: TYPE_PRE
- en: 'Now, confirm that BIND is actually listening on port 53:'
  prefs: []
  type: TYPE_NORMAL
- en: '[PRE30]'
  prefs: []
  type: TYPE_PRE
- en: Remember, when you are testing DNS, you should ensure that port 53 is open on
    both UDP and TCP ports. This is because UDP queries larger than 512 bytes can
    be truncated and TCP is used as a failover solution. So, remember to check the
    firewall configuration in order to see whether you need to make any required changes;
    and if you do, remember to restart the firewall.
  prefs: []
  type: TYPE_NORMAL
- en: 'Having done this, you can then check the current status of `BIND` by typing
    this:'
  prefs: []
  type: TYPE_NORMAL
- en: '[PRE31]'
  prefs: []
  type: TYPE_PRE
- en: 'Then, start or stop the service as required by using one or more of the following
    system commands:'
  prefs: []
  type: TYPE_NORMAL
- en: '[PRE32]'
  prefs: []
  type: TYPE_PRE
- en: Following this, and based on the assumption that the zone files are not only
    correct (including the forward and reverse zones), but also maintain the correct
    permissions, you should also check `/etc/hosts` in order to confirm that the appropriate
    configuration is available to the system.
  prefs: []
  type: TYPE_NORMAL
- en: 'To do this, open `/etc/hosts` in your favorite text editor like this:'
  prefs: []
  type: TYPE_NORMAL
- en: '[PRE33]'
  prefs: []
  type: TYPE_PRE
- en: 'An example of this file looks like this:'
  prefs: []
  type: TYPE_NORMAL
- en: '[PRE34]'
  prefs: []
  type: TYPE_PRE
- en: 'If you need to add any specific or dedicated IP address to the host file, then
    simply add them underneath the first three lines like this:'
  prefs: []
  type: TYPE_NORMAL
- en: '[PRE35]'
  prefs: []
  type: TYPE_PRE
- en: Finally, you should also check and confirm the configuration for your Ethernet
    device, which can be accessed by opening the relevant Ethernet connection at `/etc/sysconfig/network-scripts`.
    As you can see, this configuration file often indicates a preference for a specific
    `Gateway`, `DNS`, and `Domain` setting. In this respect, ensuring that these settings
    are accurate can be seen as good practice.
  prefs: []
  type: TYPE_NORMAL
- en: 'As shown here, based on the previous example, the output of `cat /etc/sysconfig/network-scripts/ifcfg-eth0`
    may look like this:'
  prefs: []
  type: TYPE_NORMAL
- en: '[PRE36]'
  prefs: []
  type: TYPE_PRE
- en: In this example, it is important to remember that the DNS entries must be added
    if the system uses the CentOS Network Manager. Moreover, as this only shows a
    single Ethernet interface, if the system in question has multiple NICs, then do
    make sure that this checklist includes the additional Ethernet configuration files.
  prefs: []
  type: TYPE_NORMAL
- en: 'Finally, if you do make any network changes, run the following command to ensure
    the new settings take effect:'
  prefs: []
  type: TYPE_NORMAL
- en: '[PRE37]'
  prefs: []
  type: TYPE_PRE
- en: 'Now, where `XXX.XXX.XXX.XXX` is the IP address of the nameserver in question,
    having run through these basic sanity checks, you should be able to perform or
    reconfirm your system''s configuration by running a successful `nslookup` request
    like this:'
  prefs: []
  type: TYPE_NORMAL
- en: '[PRE38]'
  prefs: []
  type: TYPE_PRE
- en: 'Alternatively, you can use `dig` in the following way:'
  prefs: []
  type: TYPE_NORMAL
- en: '[PRE39]'
  prefs: []
  type: TYPE_PRE
- en: So, having checked the key components of the system and made sure that the firewall
    is not blocking any important UDP and TCP traffic, you should be confident that
    any nonrecursive issues or warnings reported at this stage will (more than likely)
    be based on a specific configuration issue related to the DNS application itself.
  prefs: []
  type: TYPE_NORMAL
- en: Monitoring bandwidth with iftop
  prefs:
  - PREF_H1
  type: TYPE_NORMAL
- en: A poorly configured or troublesome DNS server can result in a variety of issues
    that includes the failure of application servers and an overall network slowdown.
    However, before we dive into the inner workings of DNS, it is important to realize
    that network slowdowns can be attributed to various causes; and with this in mind,
    it is often a good idea to refer to a package known as `iftop`.
  prefs: []
  type: TYPE_NORMAL
- en: As discussed in a previous chapter, you will notice that `iftop` is similar
    to the `top` command, but unlike the `top` command, you will discover that its
    purpose is to remain specifically interested in measuring the bandwidth of network
    connections between the host server and an external reference point (IP address).
  prefs: []
  type: TYPE_NORMAL
- en: 'To install this package, you will need the EPEL repository and, after you have
    enabled this repository by reading the instructions from a previous chapter, `iftop`
    can be installed with the following command:'
  prefs: []
  type: TYPE_NORMAL
- en: '[PRE40]'
  prefs: []
  type: TYPE_PRE
- en: 'Running the basic package needs no arguments. In fact, a typical `iftop` session
    can be started with the following command:'
  prefs: []
  type: TYPE_NORMAL
- en: '[PRE41]'
  prefs: []
  type: TYPE_PRE
- en: 'Otherwise, on servers with multiple Ethernet interfaces, where `X` is the name
    assigned to your Ethernet interface, you can use the following argument to display
    the results for a specific device:'
  prefs: []
  type: TYPE_NORMAL
- en: '[PRE42]'
  prefs: []
  type: TYPE_PRE
- en: 'By default, `iftop` will attempt to resolve all IP addresses into hostname,
    but you can avoid this with the `-n` option like this:'
  prefs: []
  type: TYPE_NORMAL
- en: '[PRE43]'
  prefs: []
  type: TYPE_PRE
- en: Moreover, given that the default display is used to show the overall bandwidth
    between hosts, a useful feature is to swap this display to show the ports that
    each host is using for communication purposes. To do this, simply use the *P*
    key during an `iftop` session to toggle between displaying all ports and the standard
    bandwidth readouts.
  prefs: []
  type: TYPE_NORMAL
- en: Note
  prefs:
  - PREF_H3
  type: TYPE_NORMAL
- en: '**Other useful keyboard shortcuts include:**'
  prefs: []
  type: TYPE_NORMAL
- en: Use the *T* key to toggle between display types
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
- en: Use the *Shift* + *P* key to pause a current display
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
- en: Use the *J* and *K* keys to scroll the display
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
- en: 'As the display screen is relatively verbose and self-explanatory, I will not
    detail the package itself. However, in certain situations, you should be aware
    that you can use `iftop` to investigate the flow of packets across a network range
    by initializing the appropriate filter like this:'
  prefs: []
  type: TYPE_NORMAL
- en: '[PRE44]'
  prefs: []
  type: TYPE_PRE
- en: 'You can choose to show the results for a specific port with the following syntax:'
  prefs: []
  type: TYPE_NORMAL
- en: '[PRE45]'
  prefs: []
  type: TYPE_PRE
- en: 'Alternatively, rather than displaying the results in bits per second, using
    the `-B` option in the following way the display will now show bandwidth rates
    in bytes per second:'
  prefs: []
  type: TYPE_NORMAL
- en: '[PRE46]'
  prefs: []
  type: TYPE_PRE
- en: Remember, the art of troubleshooting is based on the ability to identify the
    cause as quickly as possible. It is true that network slowdowns can be caused
    by misconfigured or troublesome DNS issues, but it is also true to say that DNS
    can be wrongly accused and that such issues can be the result of bandwidth. So,
    by using this small, but incredibly useful package, you may have saved yourself
    a lot of time and effort and made a permanent fix to what was previously assumed
    to be a DNS issue.
  prefs: []
  type: TYPE_NORMAL
- en: 'You can learn more about `iftop` by typing:'
  prefs: []
  type: TYPE_NORMAL
- en: '[PRE47]'
  prefs: []
  type: TYPE_PRE
- en: Flushing the cache
  prefs:
  - PREF_H1
  type: TYPE_NORMAL
- en: The Time to Live (TTL) factor can also have a bearing on the issues at hand.
    In instances where a simple dig request will show that the nameserver displays
    a different record to the local DNS, then (beyond waiting for the automated update
    to take place) a different course of action is to flush the cache.
  prefs: []
  type: TYPE_NORMAL
- en: 'In the case of BIND, it is simply a matter of restarting the service like this:'
  prefs: []
  type: TYPE_NORMAL
- en: '[PRE48]'
  prefs: []
  type: TYPE_PRE
- en: 'However, without being so drastic, you can also use the following syntax:'
  prefs: []
  type: TYPE_NORMAL
- en: '[PRE49]'
  prefs: []
  type: TYPE_PRE
- en: 'Then run a service status check:'
  prefs: []
  type: TYPE_NORMAL
- en: '[PRE50]'
  prefs: []
  type: TYPE_PRE
- en: 'In this respect, you should now see the following notices:'
  prefs: []
  type: TYPE_NORMAL
- en: '[PRE51]'
  prefs: []
  type: TYPE_PRE
- en: 'Alternatively, you can target a specific domain with the following syntax:'
  prefs: []
  type: TYPE_NORMAL
- en: '[PRE52]'
  prefs: []
  type: TYPE_PRE
- en: 'And, having run the `systemctl status named` command, you will see the following
    reports:'
  prefs: []
  type: TYPE_NORMAL
- en: '[PRE53]'
  prefs: []
  type: TYPE_PRE
- en: Now, in the case of propagating immediate changes to local desktop clients,
    you will need to close all running applications, and then follow one of these
    procedures.
  prefs: []
  type: TYPE_NORMAL
- en: 'For Windows users, simply open Command Prompt and use:'
  prefs: []
  type: TYPE_NORMAL
- en: '[PRE54]'
  prefs: []
  type: TYPE_PRE
- en: 'For Mac OS-X 10.10, open Terminal and use the following command:'
  prefs: []
  type: TYPE_NORMAL
- en: '[PRE55]'
  prefs: []
  type: TYPE_PRE
- en: 'For Mac OS-X 10.5.2 to 10.6, use the following command:'
  prefs: []
  type: TYPE_NORMAL
- en: '[PRE56]'
  prefs: []
  type: TYPE_PRE
- en: 'For older versions of OS-X, use this:'
  prefs: []
  type: TYPE_NORMAL
- en: '[PRE57]'
  prefs: []
  type: TYPE_PRE
- en: Summary
  prefs:
  - PREF_H1
  type: TYPE_NORMAL
- en: The purpose of this chapter was not necessarily to tackle the issues associated
    with DNS configuration, as there are many books that deal with this subject comprehensively.
    However, it was engendered to approach the subject of DNS in relation to it being
    a function of the services available on a network. The consequence of this was
    to illustrate a few basic techniques associated with the art of troubleshooting
    an authoritative or caching domain nameserver that may be exhibiting difficulties
    during the performance of its role.
  prefs: []
  type: TYPE_NORMAL
- en: So, from changing the hostname to checking the bandwidth, flushing the cache
    to running some standard sanity checks, you should be aware that troubleshooting
    is not always about installing and configuring packages. In many respects, very
    few professional troubleshooters will find themselves building a system from scratch,
    but they will be asked to fix an apparent issue that, in the context of this book,
    is typically something more immediate, if not intrinsic to the network environment
    as a whole.
  prefs: []
  type: TYPE_NORMAL
- en: References
  prefs:
  - PREF_H1
  type: TYPE_NORMAL
- en: 'The Red Hat customer portal: [https://access.redhat.com/documentation/en-US/Red_Hat_Enterprise_Linux/](https://access.redhat.com/documentation/en-US/Red_Hat_Enterprise_Linux/)'
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
- en: 'The iftop Wikipedia home page: [http://en.wikipedia.org/wiki/Iftop](http://en.wikipedia.org/wiki/Iftop)'
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
- en: 'The Domain Name System Security Extensions Wikipedia home page: [http://en.wikipedia.org/wiki/Domain_Name_System_Security_Extensions](http://en.wikipedia.org/wiki/Domain_Name_System_Security_Extensions)'
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
- en: 'The BIND project home page: [https://www.isc.org/downloads/bind/](https://www.isc.org/downloads/bind/)'
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
- en: 'The BIND Wikipedia home page: [http://en.wikipedia.org/wiki/BIND](http://en.wikipedia.org/wiki/BIND)'
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
- en: 'The RHEL customer portal – Chapter 19: [https://access.redhat.com/documentation/en-US/Red_Hat_Enterprise_Linux/5/html/Deployment_Guide/ch-bind.html](https://access.redhat.com/documentation/en-US/Red_Hat_Enterprise_Linux/5/html/Deployment_Guide/ch-bind.html)'
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
