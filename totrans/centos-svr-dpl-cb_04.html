<html><head></head><body><div class="chapter" title="Chapter&#xA0;4.&#xA0;Software Installation Management"><div class="titlepage"><div><div><h1 class="title"><a id="ch04"/>Chapter 4. Software Installation Management</h1></div></div></div><p>This chapter contains the following recipes:</p><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc">Registering the EPEL and Remi repositories</li><li class="listitem" style="list-style-type: disc">Prioritizing repositories using the Priorities plugin</li><li class="listitem" style="list-style-type: disc">Automating software updates with <code class="literal">yum-cron</code></li><li class="listitem" style="list-style-type: disc">Verifying installed RPM packages</li><li class="listitem" style="list-style-type: disc">Compiling a program from source</li></ul></div><div class="section" title="Introduction"><div class="titlepage"><div><div><h1 class="title"><a id="ch04lvl1sec32"/>Introduction</h1></div></div></div><p>This chapter presents recipes for managing the installation of software on your CentOS system. You'll learn how to add new package repositories to provide a wider selection of software than what's found in the main CentOS repositories, and also how to prioritize the repositories to control those from which a package is installed. You'll also learn how to automate software updates to keep up with the latest security patches and bug fixes, and how to verify the installed packages to make sure a malicious user hasn't tampered with your software. Finally, you'll learn a skill that's slowly fading but is essential if you want to modify the open source software on your system: how to compile software from source.</p></div></div>
<div class="section" title="Registering the EPEL and Remi repositories"><div class="titlepage"><div><div><h1 class="title"><a id="ch04lvl1sec33"/>Registering the EPEL and Remi repositories</h1></div></div></div><p>A clean CentOS installation will have the main supported repositories enabled, from which we can install a wide variety of software. We can also register third-party repositories to make additional (or newer) software available to us. This recipe teaches you how to add two such repositories, specifically the popular <span class="strong"><strong>Extra Packages for Enterprise Linux</strong></span> (<span class="strong"><strong>EPEL</strong></span>) and Remi repositories.</p><div class="section" title="Getting ready"><div class="titlepage"><div><div><h2 class="title"><a id="ch04lvl2sec93"/>Getting ready</h2></div></div></div><p>This recipe requires a CentOS system with a working network connection. Administrative privileges are also required, either by logging in with the <code class="literal">root</code> account or through the use of <code class="literal">sudo</code>.</p></div><div class="section" title="How to do it..."><div class="titlepage"><div><div><h2 class="title"><a id="ch04lvl2sec94"/>How to do it...</h2></div></div></div><p>To register the EPEL repository, install the epel-release package:</p><pre class="programlisting">
<span class="strong"><strong>yum install epel-release</strong></span>
</pre><p>To register and enable the REMI repository, follow these steps:</p><div class="orderedlist"><ol class="orderedlist arabic"><li class="listitem">Download the repository's configuration package:<pre class="programlisting">
<span class="strong"><strong>curl -O http://rpms.famillecollet.com/enterprise/remi-release-7.rpm</strong></span>
</pre></li><li class="listitem">Install the downloaded package:<pre class="programlisting">
<span class="strong"><strong>yum install remi-release-7.rpm</strong></span>
</pre></li><li class="listitem">Delete the file since it's no longer needed:<pre class="programlisting">
<span class="strong"><strong>rm remi-release-7.rpm</strong></span>
</pre></li><li class="listitem">Open the Remi repository's configuration file:<pre class="programlisting">
<span class="strong"><strong>      vi /etc/yum.repos.d/remi.repo &#13;
</strong></span>
</pre></li><li class="listitem">Locate the <code class="literal">enabled</code> option in the <code class="literal">[remi]</code> section and change it's value to <code class="literal">1</code> to enable it:<pre class="programlisting">
<span class="strong"><strong>enabled=1</strong></span>
</pre></li><li class="listitem">Save your changes and close the file.</li></ol></div></div><div class="section" title="How it works..."><div class="titlepage"><div><div><h2 class="title"><a id="ch04lvl2sec95"/>How it works...</h2></div></div></div><p>The EPEL repository hosts software packages that complement those in the official CentOS repositories. It can be automatically configured by installing the <code class="literal">epel-release</code> package available in the official repositories:</p><pre class="programlisting">
<span class="strong"><strong>yum install epel-release</strong></span>
</pre><p>Remi is a popular third-party repository providing newer versions of software found in the official repositories. We downloaded the configuration package for the repository from the project's server using <code class="literal">curl</code>:</p><pre class="programlisting">
<span class="strong"><strong>curl -O http://rpms.famillecollet.com/enterprise/remi-release-7.rpm</strong></span>
</pre><p>We used the <code class="literal">-O</code> argument (an uppercase letter <code class="literal">O</code>, not zero) so that the file will be saved to disk, otherwise its contents would be dumped to the screen. The recipe didn't identify a specific directory you should download the file to. You can download it to your <code class="literal">home</code> directory, or even <code class="literal">/tmp</code> if you like, since the file isn't needed after the package is installed.</p><p>After the package is downloaded, we can install it using <code class="literal">yum</code>:</p><pre class="programlisting">
<span class="strong"><strong>yum install remi-release-7.rpm</strong></span>
</pre><div class="note" style="" title="Note"><div class="inner"><h3 class="title"><a id="note22"/>Note</h3><p>Many times there are alternative ways to accomplish the same task. For instance, the <code class="literal">rpm</code> command can also be used to install the package after it is downloaded:</p><p>
</p><p><code class="literal">
<span class="strong"><strong>rpm -iv remi-release-7.rpm</strong></span>
</code></p><p>
</p><p>The <code class="literal">-i</code> argument installs the package and <code class="literal">-v</code> instructs <code class="literal">rpm</code> to be verbose in its output so we can see it's activities.</p></div></div><p>The <code class="literal">remi-release</code> package installs the configurations for three Remi repositories: the Remi, Safe Remi, and Remi's PHP 7 repositories. Safe Remi is enabled by default because its packages are considered safe to use with the official CentOS-Base repository. However, the Remi repository is disabled so we need to edit <code class="literal">/etc/yum.repos.d/remi.repo</code>:</p><div class="mediaobject"><img alt="How it works..." src="graphics/image_04_001.jpg"/><div class="caption"><p>The Remi repository is enabled by updating its configuration file</p></div></div><p>REMI is popular for providing newer releases of PHP. If you want to upgrade your existing PHP installation with a version found in Remi you can enable the desired section in <code class="literal">remi.repo</code> or in <code class="literal">remi-php70.repo</code>.</p><p>After you've installed the EPEL repository and installed and enabled the Remi repository, you can ask yum to list the available repositories. The EPEL and Remi repositories should appear in its output:</p><pre class="programlisting">
<span class="strong"><strong>yum repolist</strong></span>
</pre><div class="mediaobject"><img alt="How it works..." src="graphics/image_04_002.jpg"/><div class="caption"><p>The EPEL and Remi repositories are enabled and ready to go!</p></div></div><div class="note" style="" title="Note"><div class="inner"><h3 class="title"><a id="tip23"/>Tip</h3><p>Remi uses the same package names as those found in the official CentOS repositories. Like Remi, the IUS repository provides newer versions of software found in the official repositories, but uses different package names. Some managed service providers recommend using IUS over Remi because they update servers nightly and the differing package names help prevent unplanned upgrades. If you're contracted with such a provider and not using the Priorities plugin (discussed in the next recipe), be sure to heed their advice. More information on IUS can be found at their website, <a class="ulink" href="https://ius.io/">https://ius.io/</a>.</p></div></div></div><div class="section" title="See also"><div class="titlepage"><div><div><h2 class="title"><a id="ch04lvl2sec96"/>See also</h2></div></div></div><p>For more information on the EPEL and Remi repositories, refer to the following resources:</p><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc">Fedora Project: EPEL (<a class="ulink" href="http://fedoraproject.org/wiki/EPEL">http://fedoraproject.org/wiki/EPEL</a>)</li><li class="listitem" style="list-style-type: disc">Remi's RPM repository (<a class="ulink" href="http://rpms.famillecollet.com/">http://rpms.famillecollet.com/</a>)</li><li class="listitem" style="list-style-type: disc">Install EPEL and additional repositories on CentOS and Red Hat (<a class="ulink" href="http://www.rackspace.com/knowledge_center/article/install-epel-and-additional-repositories-on-centos-and-red-hat">http://www.rackspace.com/knowledge_center/article/install-epel-and-additional-repositories-on-centos-and-red-hat</a>)</li></ul></div></div></div>
<div class="section" title="Prioritizing repositories using the Priorities plugin"><div class="titlepage"><div><div><h1 class="title"><a id="ch04lvl1sec34"/>Prioritizing repositories using the Priorities plugin</h1></div></div></div><p>Although package managers make installing and updating software an almost trivial task, there can still be some pain points if we're not careful. For example, we can configure multiple repositories, including third-party repositories not maintained by CentOS, and the version of a package in one repository can conflict with the same in another. This recipe uses the Priorities plugin to prioritize the repositories we use to help avoid such pitfalls.</p><div class="section" title="Getting ready"><div class="titlepage"><div><div><h2 class="title"><a id="ch04lvl2sec97"/>Getting ready</h2></div></div></div><p>This recipe requires a CentOS system with a working network connection. Administrative privileges are also required, either by logging in with the <code class="literal">root</code> account or through the use of <code class="literal">sudo</code>.</p></div><div class="section" title="How to do it..."><div class="titlepage"><div><div><h2 class="title"><a id="ch04lvl2sec98"/>How to do it...</h2></div></div></div><p>Follow these steps to prioritize which repositories <code class="literal">yum</code> downloads software from:</p><div class="orderedlist"><ol class="orderedlist arabic"><li class="listitem">Open the <code class="literal">/etc/yum.conf</code> file with your text editor. Locate the <code class="literal">plugins</code> option and verify that its value is set to <code class="literal">1</code> to enable plugin support. Update the value if necessary:<pre class="programlisting">
<span class="strong"><strong>plugins = 1</strong></span>
</pre></li><li class="listitem">Install the <code class="literal">yum-plugin-priorities</code> package:<pre class="programlisting">
<span class="strong"><strong>yum install yum-plugin-priorities</strong></span>
</pre></li><li class="listitem">To set a repository's priority, open its respective configuration file found under <code class="literal">/etc/yum.repos.d</code>. Add the <code class="literal">priority</code> option as a new entry within each desired section:<pre class="programlisting">
<span class="strong"><strong>priority=10</strong></span>
</pre></li><li class="listitem">When you're finished, save and close the repository's configuration file.<div class="mediaobject"><img alt="How to do it..." src="graphics/image_04_003.jpg"/><div class="caption"><p>The CentOS-Base repository is given a relatively high priority for base packages</p></div></div></li></ol></div></div><div class="section" title="How it works..."><div class="titlepage"><div><div><h2 class="title"><a id="ch04lvl2sec99"/>How it works...</h2></div></div></div><p>In this recipe, we installed the Priorities plugin and prioritized our repositories by updating their configuration files. By prioritizing one repository over another, we can more easily control the packages and software versions installed on our system.</p><p>First, we checked to make sure Yum's plugin support is enabled. We opened its configuration file at <code class="literal">/etc/yum.conf</code> and verified the value of the <code class="literal">plugins</code> option:</p><pre class="programlisting">
<span class="strong"><strong>plugins = 1</strong></span>
</pre><p>Next, we installed the <code class="literal">yum-plugin-priorities</code> package:</p><pre class="programlisting">
<span class="strong"><strong>yum install yum-plugin-priorities</strong></span>
</pre><p>Priorities comes with its own minimal configuration file at <code class="literal">/etc/yum/plugins/ priorities.conf</code>. There, the <code class="literal">enabled</code> option let's us toggle whether the plugin is active or not. This means we can prioritize the repositories as we like, but temporarily disable prioritization for any reason without removing and then re-adding priority values in the repositories' configuration files:</p><pre class="programlisting">
<span class="strong"><strong>enabled = 1</strong></span>
</pre><p>The last step is to edit the repositories' configuration files found in the <code class="literal">/etc/ yum.repos.d</code> directory. Each repository has its own file, for example, the CentOS-Base repository's file is <code class="literal">/etc/yum.repos.d/CentOS-Base.repo</code>, which configures details about connections and security keys for each channel. To prioritize our repositories, we simply open the desired files and add a new line for the <code class="literal">priority</code> option in the desired sections:</p><pre class="programlisting">
<span class="strong"><strong>priority = 10</strong></span>
</pre><p>Priorities are assigned as a number in the range of <code class="literal">1</code> to <code class="literal">99</code>, where <code class="literal">1</code> is the highest priority and <code class="literal">99</code> is the lowest priority. Any repository or channel we don't explicitly set a priority for will default to priority <code class="literal">99</code>. Repositories that are meant to work together (like EPEL and Remi) can be assigned the same priority.</p><div class="note" style="" title="Note"><div class="inner"><h3 class="title"><a id="note24"/>Note</h3><p>Don't use consecutive priority numbers, like 1, 2, 3.... Setting priorities as multiples of 5 or 10, for example 5, 10, 15... or 10, 20, 30... allows you to later add additional repositories without re-prioritizing existing ones.</p></div></div><p>When priorities are assigned and enabled and when we try to install or update a package which is found in multiple repositories, the package will be retrieved from whichever repository that has the highest priority. In this way, we can control if a third-party repository can replace important base packages, or if updates from supported CentOS repositories can replace third-party packages on a highly-customized system.</p></div><div class="section" title="See also"><div class="titlepage"><div><div><h2 class="title"><a id="ch04lvl2sec100"/>See also</h2></div></div></div><p>Refer to the CentOS Wiki's <code class="literal">yum-plugin-priorities</code> article for more information on the Priorities plugin at <a class="ulink" href="https://wiki.centos.org/PackageManagement/Yum/Priorities">https://wiki.centos.org/PackageManagement/Yum/Priorities</a>.</p></div></div>
<div class="section" title="Automating software updates with yum-cron"><div class="titlepage"><div><div><h1 class="title"><a id="ch04lvl1sec35"/>Automating software updates with yum-cron</h1></div></div></div><p>We know the importance of staying on top of any security alerts and applying important updates, but it can be a tedious and time-consuming task to make sure all of the software on your CentOS system is updated, especially when you're managing more than one server. This recipe shows you how to automate the update process ensuring your system stays up to date without the need for daily interaction.</p><div class="section" title="Getting ready"><div class="titlepage"><div><div><h2 class="title"><a id="ch04lvl2sec101"/>Getting ready</h2></div></div></div><p>This recipe requires a CentOS system with a working network connection. Administrative privileges are also required, either by logging in with the <code class="literal">root</code> account or through the use of <code class="literal">sudo</code>.</p></div><div class="section" title="How to do it..."><div class="titlepage"><div><div><h2 class="title"><a id="ch04lvl2sec102"/>How to do it...</h2></div></div></div><p>To automate software updates using <code class="literal">yum-cron</code>, perform the following steps:</p><div class="orderedlist"><ol class="orderedlist arabic"><li class="listitem">Install the <code class="literal">yum-cron</code> package:<pre class="programlisting">
<span class="strong"><strong>yum install yum yum-cron</strong></span>
</pre></li><li class="listitem">Start and enable the service:<pre class="programlisting">
<span class="strong"><strong>systemctl start yum-cron</strong></span>
<span class="strong"><strong>systemctl enable yum-cron</strong></span>
</pre></li><li class="listitem">Perform a system update to ensure everything is up to date before <code class="literal">yum-cron</code> takes over:<pre class="programlisting">
<span class="strong"><strong>yum update</strong></span>
</pre></li></ol></div></div><div class="section" title="How it works..."><div class="titlepage"><div><div><h2 class="title"><a id="ch04lvl2sec103"/>How it works...</h2></div></div></div><p>Our first action step was to install the <code class="literal">yum-cron</code> package, but you'll notice that the invocation also updates Yum itself. Although we only have to specify <code class="literal">yum-cron</code>, including <code class="literal">yum</code> works around a particular versioning bug (you can read the bug report at <a class="ulink" href="https://bugzilla.redhat.com/show_bug.cgi?id=1293713">https://bugzilla.redhat.com/show_bug.cgi?id=1293713</a>):</p><pre class="programlisting">
<span class="strong"><strong>yum install yum yum-cron</strong></span>
</pre><p>The package installs the <code class="literal">yum-cron</code> command and a daily cron job to trigger it and a <code class="literal">systemctl</code> unit used to enable and disable updating. Starting the service with <code class="literal">systemctl</code> results in the creation of a special lock file. Cron runs the daily cron job every day to invoke <code class="literal">yum-cron</code>, which checks whether the lock file exists. If the file exists, then it knows it should check for updates. Otherwise, it knows daily updating is disabled (the service is stopped) and does nothing.</p><p>The <code class="literal">yum-cron.config</code> configuration file in <code class="literal">/etc/yum</code> can be used to modify the general behavior of <code class="literal">yum-cron</code>. The most important option is <code class="literal">update_cmd</code> because it lets us specify what type of update to perform. It's possible for <code class="literal">yum-cron</code> to perform different update strategies, and if you want to perform a more targeted update beyond the default then you can change the value of the <code class="literal">update_cmd</code> option.</p><p>Servers that fill different roles may require different update strategies; for example, you might want to apply only critical security updates on a production server and leave the other software installed at their specific versions. Comments in the configuration file list what values are valid for <code class="literal">update_cmd</code> and what they mean. <code class="literal">default</code> performs a general system-wide update, whereas a value such as <code class="literal">security</code> only applies security-related updates:</p><pre class="programlisting">
<span class="strong"><strong>update_cmd = security</strong></span>
</pre><p>Also of interest in <code class="literal">yum-cron.conf</code> is the <code class="literal">emit_via</code> option. The <code class="literal">stdio</code> value means any logging messages that may be generated by <code class="literal">yum-cron</code> will be passed through a standard output. Usually, this is captured by cron and written to <code class="literal">/var/log/cron</code>. Cron can be configured to e-mail the output, but you can also specifically configure <code class="literal">yum-cron</code> to e-mail the messages. If you want the output sent to you by <code class="literal">yum-cron</code>, change the value of <code class="literal">emit_via</code> to <code class="literal">email</code> and the value of <code class="literal">email_to</code> to your e-mail address:</p><pre class="programlisting">
<span class="strong"><strong>emit_via = email</strong></span>
<span class="strong"><strong>email_to = tboronczyk@example.com</strong></span>
</pre><div class="mediaobject"><img alt="How it works..." src="graphics/image_04_004.jpg"/><div class="caption"><p>yum-cron's configuration file lets us specify a specific update policy and notification options</p></div></div></div><div class="section" title="See also"><div class="titlepage"><div><div><h2 class="title"><a id="ch04lvl2sec104"/>See also</h2></div></div></div><p>Refer to the following resources for more information on automating software updates:</p><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc">Configure automatic updates (<a class="ulink" href="http://www.certdepot.net/rhel7-configure-automatic-updates">http://www.certdepot.net/rhel7-configure-automatic-updates</a>)</li><li class="listitem" style="list-style-type: disc">Enabling automatic updates in CentOS 7 and RHEL 7 (<a class="ulink" href="http://linuxaria.com/howto/enabling-automatic-updates-in-centos-7-and-rhel-7">http://linuxaria.com/howto/enabling-automatic-updates-in-centos-7-and-rhel-7</a>)</li></ul></div></div></div>
<div class="section" title="Verifying installed RPM packages"><div class="titlepage"><div><div><h1 class="title"><a id="ch04lvl1sec36"/>Verifying installed RPM packages</h1></div></div></div><p>It's been said the safest system is one that's <span class="emphasis"><em>"powered off, cast in a block of concrete, and sealed in a lead-lined room with armed guards."</em></span> (Gene Spafford) Your CentOS system is probably concrete-free, which means it's at the risk of attack. This recipe shows you how to audit your system using <code class="literal">rpm</code> to make sure its installed software hasn't been compromised by an attacker.</p><div class="section" title="Getting ready"><div class="titlepage"><div><div><h2 class="title"><a id="ch04lvl2sec105"/>Getting ready</h2></div></div></div><p>This recipe requires a CentOS system with a working network connection. Administrative privileges are also required, either by logging in with the <code class="literal">root</code> account or through the use of <code class="literal">sudo</code>.</p></div><div class="section" title="How to do it..."><div class="titlepage"><div><div><h2 class="title"><a id="ch04lvl2sec106"/>How to do it...</h2></div></div></div><p>It is important to first make a backup of the RPM database at <code class="literal">/var/lib/rpm</code>. There are many ways to do this, but for the sake of this example, we'll make an ISO image of the directory which you can then archive or burn to disc:</p><div class="orderedlist"><ol class="orderedlist arabic"><li class="listitem">Install the <code class="literal">genisoimage</code> and <code class="literal">wodim</code> packages for the necessary tools to create ISO images and to burn them to disc:<pre class="programlisting">
<span class="strong"><strong>yum install genisoimage wodim</strong></span>
</pre></li><li class="listitem">Create the ISO image with <code class="literal">genisoimage</code>:<pre class="programlisting">
<span class="strong"><strong>genisoimage -o rpm-db-bckup.iso -R -v /var/lib/rpm</strong></span>
</pre><p>If desired, burn the image with <code class="literal">wodim</code>:</p><pre class="programlisting">
<span class="strong"><strong>wodim -v dev=/dev/cdrom rpm-db-bckup.iso</strong></span>
</pre></li></ol></div><p>You can delete the ISO file after burning it to disc if you have no plans to use it in the future.</p><p>When the time comes to verify your system, follow these steps:</p><div class="orderedlist"><ol class="orderedlist arabic"><li class="listitem">Make the backup database available. If you've burned the ISO file to disc, and assuming that it's located at <code class="literal">/dev/cdrom</code>, use <code class="literal">mount</code> like this:<pre class="programlisting">
<span class="strong"><strong>mount /media /dev/cdrom</strong></span>
</pre></li><li class="listitem">If the backup is an ISO file, use <code class="literal">mount</code> like this:<pre class="programlisting">
<span class="strong"><strong>mount -o loop rpm-db-bckup.iso /media</strong></span>
</pre></li><li class="listitem">Verify the integrity of the installed <code class="literal">rpm</code> package against the backup copy of the database. <code class="literal">rpm</code> returns a list of the files that are different from the original package, so a successful audit should have no output:<pre class="programlisting">
<span class="strong"><strong>rpm -V --dbpath=/media rpm</strong></span>
</pre></li><li class="listitem">Verify the integrity of all of the packages installed on the system:<pre class="programlisting">
<span class="strong"><strong>rpm -Va --dbpath=/media</strong></span>
</pre></li></ol></div></div><div class="section" title="How it works..."><div class="titlepage"><div><div><h2 class="title"><a id="ch04lvl2sec107"/>How it works...</h2></div></div></div><p>An attacker can alter files and replace programs with malicious copies on your system. Luckily, we can identify these changes using <code class="literal">rpm</code> to verify the integrity of files installed from a package. But to do this, we also need a database that we can trust. The integrity of the database used to compare file details is important because a smart attacker may also think to make changes there as well. It's important to make a read-only backup of the database regularly, perhaps before and after every time you install a new package or install updates. Then you can compare the state of the system's software against a trusted backup and be fully confident with the results.</p><p>You can back up to any medium you wish: a removable USB thumb drive, a writable CD or DVD disc, remote storage, or even a high-capacity tape cartridge. The important thing is that it's trustworthy. The recipe demonstrated making a backup of the <code class="literal">/var/lib/rpm</code> database as an ISO file, which can be burned to disc or copied around as-is and mounted read-only when needed.</p><pre class="programlisting">
<span class="strong"><strong>genisoimage -o rpm-db-bckup.iso -R -v /var/lib/rpm</strong></span>
</pre><div class="note" style="" title="Note"><div class="inner"><h3 class="title"><a id="note25"/>Note</h3><p>Long-time Linux users may remember the <code class="literal">mkisofs</code> and <code class="literal">cdrecord</code> programs. <code class="literal">genisoimage</code> and <code class="literal">cdrecord</code> are clones, and the former still exists in CentOS in the form of symlinks pointing to <code class="literal">genisoimage</code> and <code class="literal">cdrecord</code>.</p></div></div><p>The <code class="literal">-o</code> argument gives the name of the ISO file that will be created. <code class="literal">-R</code> creates the indexes necessary to preserve the length and casing of the filenames in our image, and <code class="literal">-v</code> indicates that <code class="literal">genisoimage</code> should be verbose so that we can see its progress. When it's finished, we'll have the <code class="literal">rpm-db-backup.iso</code> file.</p><div class="note" style="" title="Note"><div class="inner"><h3 class="title"><a id="note26"/>Note</h3><p><code class="literal">rpm-db-bckup.iso</code> is a suitable name if you're going to burn the file to disc and delete it. If you plan on archiving the ISO file instead, you'll want to consider including a timestamp in the name of when the backup was taken so that you can keep things organized. For example, the following command uses <code class="literal">date</code> to include the date and time in the filename:</p><p>
</p><p><code class="literal">
<span class="strong"><strong>genisoimage -o rpm-db-bckup-$(date +"%Y-%m-%d_%H%M").iso -R -v /var/lib/rpm</strong></span>
</code></p></div></div><p>Next, the recipe showed how to use <code class="literal">wodim</code> to burn the ISO to disc:</p><pre class="programlisting">
<span class="strong"><strong>wodim -v dev=/dev/cdrom rpm-db-bckup.iso</strong></span>
</pre><p>The <code class="literal">-v</code> argument puts <code class="literal">wodim</code> in verbose mode and the <code class="literal">dev</code> argument identifies the CD/DVD drive. The recipe assumed that <code class="literal">/dev/cdrom</code> is the appropriate device and you may need to modify the command depending on your system's configuration.</p><p>To make the trusted database available, we mounted the disc or ISO file. To mount the disc, we would place the disc in the drive and issue the following command (<code class="literal">/dev/cdrom</code> is the device and <code class="literal">/media</code> is the mount point its filesystem will be made available on):</p><pre class="programlisting">
<span class="strong"><strong>mount /dev/cdrom /media</strong></span>
</pre><p>To mount an ISO file, we issue the following command instead:</p><pre class="programlisting">
<span class="strong"><strong>mount -o loop rpm-db-bckup.iso /media</strong></span>
</pre><p>After the trusted database was made available, we used <code class="literal">rpm</code> with the <code class="literal">-V</code> option, which verifies an installed package. By default, <code class="literal">rpm</code> uses the files in <code class="literal">/var/lib/rpm</code> as the database, so we used the <code class="literal">--dbpath</code> option to override this and instead point to our trusted copy:</p><pre class="programlisting">
<span class="strong"><strong>rpm -V -dbpath=/media rpm</strong></span>
</pre><p>While we can provide one or more package names to check, the <code class="literal">-a</code> option will verify all of the packages installed on the system:</p><pre class="programlisting">
<span class="strong"><strong>rpm -Va --dbpath=/media</strong></span>
</pre><p><code class="literal">rpm</code> runs through a series of tests, checking the size of files and their permissions, and reports those that fail one or more tests. No output means the files installed on your system are exactly as they were when they were first installed by the package(s). Otherwise, <code class="literal">rpm</code> displays a dot for those tests that pass and one of the following mnemonic indicators to show which tests fail:</p><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc"><code class="literal">S</code>: The size of the file has changed</li><li class="listitem" style="list-style-type: disc"><code class="literal">M</code>: The file's permissions have changed</li><li class="listitem" style="list-style-type: disc"><code class="literal">5</code>: The MD5 checksum of the file does not match the expected checksum</li><li class="listitem" style="list-style-type: disc"><code class="literal">L</code>: The symlink has changed</li><li class="listitem" style="list-style-type: disc"><code class="literal">D</code>: The device has changed</li><li class="listitem" style="list-style-type: disc"><code class="literal">U</code>: The user owner of the file has changed</li><li class="listitem" style="list-style-type: disc"><code class="literal">G</code>: The owning group of the file has changed</li><li class="listitem" style="list-style-type: disc"><code class="literal">T</code>: The file's timestamp has changed</li></ul></div><p><code class="literal">rpm</code> will also report if a file is missing.</p><p>However, not all discrepancies are bad. It's up to us to know what changes are acceptable or not. Changes to a configuration file, for example, may be acceptable, but changes to a binary utility are certainly an indication of trouble. <code class="literal">rpm</code> differentiates configuration files by listing <code class="literal">c</code> next to the test results, which helps us differentiate them from other types of files:</p><div class="mediaobject"><img alt="How it works..." src="graphics/image_04_005.jpg"/><div class="caption"><p>Differences are reported when verifying the integrity of this system's packages</p></div></div></div><div class="section" title="See also"><div class="titlepage"><div><div><h2 class="title"><a id="ch04lvl2sec108"/>See also</h2></div></div></div><p>Refer to the following resources for more information on verifying the integrity of installed software:</p><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc">The <code class="literal">rpm</code> manual page (<code class="literal">man 8 rpm</code>)</li><li class="listitem" style="list-style-type: disc">Verifying files with Red Hat's RPM (<a class="ulink" href="http://www.sans.org/security-resources/idfaq/rpm.php">http://www.sans.org/security-resources/idfaq/rpm.php</a>)</li><li class="listitem" style="list-style-type: disc">wodim cannot open SCSI drive (<a class="ulink" href="http://www.linuxquestions.org/questions/linux-software-2/wodim-cdrecord-cannot-open-scsi-drive-4175544944/">http://www.linuxquestions.org/questions/linux-software-2/wodim-cdrecord-cannot-open-scsi-drive-4175544944/</a>)</li></ul></div></div></div>
<div class="section" title="Compiling a program from source"><div class="titlepage"><div><div><h1 class="title"><a id="ch04lvl1sec37"/>Compiling a program from source</h1></div></div></div><p>Modern-day package managers make it easy to install software; with just a single command, we can install a program and its dependencies from any of our configured repositories. Yet an important value in the Linux community and free software movement is the ability to modify your software as you see fit (perhaps you want to fix a bug or add a new feature). For software written in a compiled language, such as C, this often means modifying the program's source code and compiling the code into an executable binary. This recipe walks you through compiling and installing the GNU Hello program.</p><div class="section" title="Getting ready"><div class="titlepage"><div><div><h2 class="title"><a id="ch04lvl2sec109"/>Getting ready</h2></div></div></div><p>This recipe requires a CentOS system with a working network connection. An unprivileged user account capable of escalating its privileges using <code class="literal">sudo</code> should also be available.</p></div><div class="section" title="How to do it..."><div class="titlepage"><div><div><h2 class="title"><a id="ch04lvl2sec110"/>How to do it...</h2></div></div></div><p>Perform the following steps to compile and install the program from the source code:</p><div class="orderedlist"><ol class="orderedlist arabic"><li class="listitem">Using <code class="literal">sudo</code> to elevate your account's privileges, install the <code class="literal">gcc</code> package:<pre class="programlisting">
<span class="strong"><strong>sudo yum install gcc</strong></span>
</pre></li><li class="listitem">Download the GNU Hello source code:<pre class="programlisting">
<span class="strong"><strong>curl ftp://ftp.gnu.org/gnu/hello/hello-2.10.tar.gz | tar - zx</strong></span>
</pre></li><li class="listitem">Enter the project's directory:<pre class="programlisting">
<span class="strong"><strong>cd hello-2.10</strong></span>
</pre></li><li class="listitem">Run the <code class="literal">configure</code> script using the <code class="literal">--help</code> argument to view the project's build options. The output can be quite lengthy and you may find it beneficial to paginate the content using <code class="literal">less</code>:<pre class="programlisting">
<span class="strong"><strong>./configure --help | less</strong></span>
</pre></li><li class="listitem">Run the <code class="literal">configure</code> script again, this time specifying any desired build options to generate a <code class="literal">Makefile</code> file:<pre class="programlisting">
<span class="strong"><strong>./configure --prefix=/usr/local</strong></span>
</pre></li><li class="listitem">Invoke <code class="literal">make</code> which uses <code class="literal">Makefile</code> as a guide to compile the project:<pre class="programlisting">
<span class="strong"><strong>make</strong></span>
</pre></li><li class="listitem">Using <code class="literal">sudo</code> to again escalate your privileges, install the program and its supporting files:<pre class="programlisting">
<span class="strong"><strong>sudo make install</strong></span>
</pre></li><li class="listitem">Now, we can run the <code class="literal">hello</code> program to display a friendly greeting:<pre class="programlisting">
<span class="strong"><strong>hello</strong></span>
</pre></li></ol></div></div><div class="section" title="How it works..."><div class="titlepage"><div><div><h2 class="title"><a id="ch04lvl2sec111"/>How it works...</h2></div></div></div><p>This recipe taught you the canonical <code class="literal">configure</code>, <code class="literal">make</code>, and <code class="literal">make install</code> route of compiling and installing software from the source code.</p><p>The minimal CentOS installation does not include a C compiler (a program that translates source code written in the C programming language into a binary, machine-executable format), so the first thing we did was install the GNU Compiler Collection. Because the package will be installed system-wide, elevated privileges were needed for <code class="literal">yum</code>:</p><pre class="programlisting">
<span class="strong"><strong>sudo yum install gcc</strong></span>
</pre><div class="note" style="" title="Note"><div class="inner"><h3 class="title"><a id="note27"/>Note</h3><p>Since the GNU Hello project is written in C and includes a pregenerated <code class="literal">configure</code> script, <code class="literal">gcc</code> is all we need. There may be other projects though for which you'll need additional software, such as <code class="literal">autoconf</code>, to generate a <code class="literal">configure</code> scripts, or compiler support for other languages like Fortran, C++, Objective-C, and Go. For a more capable build environment, consider installing the <code class="literal">Development Tools</code> package group:</p><p>
</p><p><code class="literal">
<span class="strong"><strong>sudo yum groupinstall "Development Tools"</strong></span>
</code></p></div></div><p>Next, we downloaded a copy of the project's source code from its FTP server. The code is distributed as a compressed archive which we retrieved using <code class="literal">curl</code>. We omitted the <code class="literal">-O</code> argument that we used in previous recipes but piped the output directly to <code class="literal">tar</code> to decompress it. This results in the creation of a directory named <code class="literal">hello-2.10</code> that contains the project's source code:</p><pre class="programlisting">
<span class="strong"><strong>curl ftp://ftp.gnu.org/gnu/hello/hello-2.10.tar.gz | tar -zx</strong></span>
</pre><p>Quite often, a project will include several informative text files, so feel free to look around at the directory's content. Some common files are:</p><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc"><code class="literal">README</code>: This gives a general overview of the project (name, version, description, and so on)</li><li class="listitem" style="list-style-type: disc"><code class="literal">CHANGELOG</code>: This lists the changes made in each release</li><li class="listitem" style="list-style-type: disc"><code class="literal">INSTALL</code>: This contains installation instructions</li><li class="listitem" style="list-style-type: disc"><code class="literal">LICENCE</code>: This contains license information governing the use and distribution of the project's code</li></ul></div><p>If the project uses the GNU Autotools build system (which GNU Hello uses), we can expect to find a <code class="literal">configure</code> script in the collection of source files. The job of <code class="literal">configure</code> is to scan our system's build environment to ensure that any necessary tools and dependencies are available and to generate the <code class="literal">Makefile</code> file. <code class="literal">Makefile</code> will contain instructions that compile and install the program, and any options we pass to <code class="literal">configure</code> ultimately find their way into <code class="literal">Makefile</code>.</p><p>To see what options are available to us, we first ran <code class="literal">configure</code> with <code class="literal">--help</code>:</p><pre class="programlisting">
<span class="strong"><strong>./configure --help | less</strong></span>
</pre><p>Some of the options may be unique to the project while others are more general, having to do with setting paths and such as used in later parts of the build process. Some important general options are as follows:</p><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc"><code class="literal">--prefix</code>: The base hierarchy in which the program and its files will be installed</li><li class="listitem" style="list-style-type: disc"><code class="literal">--disable-FEATURE</code>: This compiles the program without enabling the target feature that would otherwise be enabled</li><li class="listitem" style="list-style-type: disc"><code class="literal">--enable-FEATURE</code>: This compiles the program with the optional target feature enabled</li><li class="listitem" style="list-style-type: disc"><code class="literal">--with-PACKAGE</code>: This links to a specific library needed for some feature</li></ul></div><p>The second time we ran <code class="literal">configure</code>, we did so providing the <code class="literal">--prefix</code> option:</p><pre class="programlisting">
<span class="strong"><strong>./configure --prefix=/usr/local</strong></span>
</pre><p>The prefix value of <code class="literal">/usr/local</code> means that this directory will be prefixed to the various paths where the different files will be installed to. For example, when we install the program, the compiled <code class="literal">hello</code> file is copied to <code class="literal">PREFIX/bin</code>, which is <code class="literal">/usr/local/bin</code>, the project's manual page will be installed under <code class="literal">PREFIX/share/man</code>, which is <code class="literal">/usr/local/share/man</code>, and so on.</p><div class="note" style="" title="Note"><div class="inner"><h3 class="title"><a id="note28"/>Note</h3><p>This recipe installs GNU Hello as a system-wide accessible program. But don't forget, you can use the <code class="literal">--prefix </code>option to compile and install files to personal directories too:</p><p>
</p><p><code class="literal">
<span class="strong"><strong>./configure --prefix=/home/tboronczyk/.personal</strong></span>
</code></p></div></div><p>Once <code class="literal">configure</code> generated <code class="literal">Makefile</code>, we executed those statements with <code class="literal">make</code> to compile the project:</p><pre class="programlisting">
<span class="strong"><strong>make</strong></span>
</pre><p>By default, <code class="literal">make</code> looks for a file named <code class="literal">Makefile</code> in the current directory to run. If for whatever reason the target script is named differently, we can tell <code class="literal">make</code> which file to use with its <code class="literal">-f</code> option:</p><pre class="programlisting">
<span class="strong"><strong>make -f ./Makefile</strong></span>
</pre><p>Also, <code class="literal">Makefile</code> files often contain several sets of instructions or targets. Some common targets are as follows:</p><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc"><code class="literal">all</code>: Compiles the program</li><li class="listitem" style="list-style-type: disc"><code class="literal">check</code>: Runs any test suites that accompany the project to verify its proper functioning</li><li class="listitem" style="list-style-type: disc"><code class="literal">clean</code>: Deletes any intermediate files created during the compilation process</li><li class="listitem" style="list-style-type: disc"><code class="literal">distclean</code>: Deletes the files created during the configuration process or compilation process, leaving only those files in the original distribution</li><li class="listitem" style="list-style-type: disc"><code class="literal">dist</code>: Creates an archive to distribute the program</li><li class="listitem" style="list-style-type: disc"><code class="literal">install</code>: Installs the compiled program and any other necessary files to their final home on the system</li><li class="listitem" style="list-style-type: disc"><code class="literal">uninstall</code>: Deletes files that were installed by <code class="literal">install</code></li></ul></div><p>The default target if none are provided is <code class="literal">all</code>.</p><p>Ideally, we don't want to compile software as <code class="literal">root</code> because it's possible for a <code class="literal">Makefile</code> to create arbitrary files in any location, something which can be taken advantage of by an attacker. Executing the file as a standard user blocks this attack vector simply because the unprivileged account doesn't have write-access to sensitive directories. This is why we used <code class="literal">sudo</code> only for the <code class="literal">install</code> target when we moved the program and its files to the directories under <code class="literal">/usr/local</code>.</p></div><div class="section" title="See also"><div class="titlepage"><div><div><h2 class="title"><a id="ch04lvl2sec112"/>See also</h2></div></div></div><p>Refer to the following resources for more information on building software:</p><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc">GNU Hello (<a class="ulink" href="http://www.gnu.org/software/hello">http://www.gnu.org/software/hello</a>)</li><li class="listitem" style="list-style-type: disc">RHEL7 Developer Guide (<a class="ulink" href="https://access.redhat.com/documentation/en-US/Red_Hat_Enterprise_Linux/7/html/Developer_Guide/index.html">https://access.redhat.com/documentation/en-US/Red_Hat_Enterprise_Linux/7/html/Developer_Guide/index.html</a>)</li><li class="listitem" style="list-style-type: disc">Autotools Mythbuster (<a class="ulink" href="http://autotools.io/">http://autotools.io/</a>)</li><li class="listitem" style="list-style-type: disc">CentOS Wiki: Set up an RPM Build Environment (<a class="ulink" href="http://wiki.centos.org/HowTos/SetupRpmBuildEnvironment">http://wiki.centos.org/HowTos/SetupRpmBuildEnvironment</a>)</li></ul></div></div></div></body></html>