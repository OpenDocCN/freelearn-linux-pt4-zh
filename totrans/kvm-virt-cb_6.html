<html><head></head><body>
        <section class="calibre1">

            <header class="calibre1">
                </header><h1 class="header-title" id="calibre_pb_0">Deploying KVM Instances with OpenStack</h1>
            

            <article class="calibre1">
                
<p class="calibre26">In this chapter, we are going to cover the following topics:</p>
<ul class="calibre16">
<li class="calibre17">Preparing the host for the OpenStack deployment</li>
<li class="calibre17">Installing and configuring the OpenStack Keystone identity service</li>
<li class="calibre17">Installing and configuring the OpenStack Glance image service</li>
<li class="calibre17">Installing and configuring the OpenStack Nova compute service</li>
<li class="calibre17">Installing and configuring the OpenStack Neutron networking service</li>
<li class="calibre17">Building and inspecting KVM instances with OpenStack</li>
<li class="calibre17">Stopping KVM instances with OpenStack</li>
<li class="calibre17">Terminating KVM instances with OpenStack</li>
</ul>


            </article>

            <footer class="calibre5">
                
            </footer>

        </section>
    

        <section class="calibre1">

            <header class="calibre1">
                </header><h1 class="header-title" id="calibre_pb_0">Introduction</h1>
            

            <article class="calibre1">
                
<p class="calibre3">OpenStack is a cloud operating system that simplifies the deployment and management of virtual machines or containers in a scalable and highly available way. It operates on pools of compute resources (physical or virtual servers) and provides an intelligent scheduling mechanism to select appropriate hosts, and to build or migrate VMs.</p>
<p class="calibre3">OpenStack allows an easier management of virtual images and provides a centralized way of creating and managing software-defined networks. It integrates well with a variety of external and internal projects in order to deliver user and service authentication. OpenStack modular design allows adding and removing services as needed where a minimal production deployment may consist of as few as two projects an image and compute service.</p>
<p class="calibre3">The following diagram shows the ever-growing list of OpenStack projects and the interaction between them:</p>
<div class="cdpaligncenter"><img class="image-border4" src="../images/00012.jpeg"/></div>
<div class="cdpaligncenter1"><span> The OpenStack components and how they interact with each other</span></div>
<p class="calibre3">In this chapter, we are going to create a simple OpenStack deployment on two compute nodes using the Keystone, Glance, Nova, and Neutron projects from the Newton release of OpenStack, on an Ubuntu Xenial 16.04 server.</p>
<div class="packt_infobox">For more information on the OpenStack project, please visit <a href="https://www.openstack.org/software/" class="calibre30">https://www.openstack.org/software/</a>.</div>


            </article>

            <footer class="calibre5">
                
            </footer>

        </section>
    

        <section class="calibre1">

            <header class="calibre1">
                </header><h1 class="header-title" id="calibre_pb_0">Preparing the host for the OpenStack deployment</h1>
            

            <article class="calibre1">
                
<p class="calibre3">In this recipe, we are going to install the infrastructure components that OpenStack depends on, such as the database server, the message queue, and the caching service. The projects that we are going to use throughout this chapter depend on these services for communication and persistent storage.</p>


            </article>

            <footer class="calibre5">
                
            </footer>

        </section>
    

        <section class="calibre1">

            <header class="calibre1">
                </header><h1 class="header-title" id="calibre_pb_0">Getting ready</h1>
            

            <article class="calibre1">
                
<p class="calibre3">For this recipe, we are going to need the following components:</p>
<ul class="calibre16">
<li class="calibre17"><span><span>An Ubuntu server with great virtualization capabilities</span></span></li>
<li class="calibre17">Access to the internet for package installation</li>
</ul>


            </article>

            <footer class="calibre5">
                
            </footer>

        </section>
    

        <section class="calibre1">

            <header class="calibre1">
                </header><h1 class="header-title" id="calibre_pb_0">How to do it...</h1>
            

            <article class="calibre1">
                
<p class="calibre3">In order to keep the deployment simple and focus on the provisioning aspect of OpenStack, we are going to use a single physical server to host all services. In production environments, it is a common approach to separate each service onto their own set of servers, for scalability and high availability. By following the steps outlined in this chapter, you should be able to deploy all services on multiple hosts, by replacing the IP addresses and hostnames in the configuration files, as needed.</p>
<ol class="calibre18">
<li value="1" class="calibre17"><span>Update the host and install the package repository for the Newton release:</span></li>
</ol>
<pre class="calibre25">
<strong class="calibre4">root@controller:~# apt install software-properties-common</strong><br class="calibre7"/><strong class="calibre4">root@controller:~# add-apt-repository cloud-archive:newton</strong><br class="calibre7"/><strong class="calibre4">root@controller:~# apt update &amp;&amp; apt dist-upgrade</strong><br class="calibre7"/><strong class="calibre4">root@controller:~# reboot</strong><br class="calibre7"/><strong class="calibre4">root@controller:~# apt install python-openstackclient</strong>
</pre>
<ol start="2" class="calibre18">
<li value="2" class="calibre17">Install the MariaDB database server:</li>
</ol>
<pre class="calibre25">
<strong class="calibre4">root@controller:~# apt install mariadb-server python-pymysql</strong><br class="calibre7"/><strong class="calibre4">root@controller:~# cat /etc/mysql/mariadb.conf.d/99-openstack.cnf</strong><br class="calibre7"/><strong class="calibre4">[mysqld]</strong><br class="calibre7"/><strong class="calibre4">bind-address = 10.208.130.36</strong><br class="calibre7"/><strong class="calibre4">default-storage-engine = innodb</strong><br class="calibre7"/><strong class="calibre4">innodb_file_per_table</strong><br class="calibre7"/><strong class="calibre4">max_connections = 4096</strong><br class="calibre7"/><strong class="calibre4">collation-server = utf8_general_ci</strong><br class="calibre7"/><strong class="calibre4">character-set-server = utf8</strong><br class="calibre7"/><strong class="calibre4">root@controller:~#</strong>
</pre>
<div class="packt_infobox">Replace the IP address of the network interface the database server binds to, as per your host.</div>
<ol start="3" class="calibre18">
<li value="3" class="calibre17">Restart the service and secure the installation:</li>
</ol>
<pre class="calibre25">
<strong class="calibre4">root@controller:~# service mysql restart</strong><br class="calibre7"/><strong class="calibre4">root@controller:~# mysql_secure_installation</strong>
</pre>
<div class="packt_infobox">For simplicity, we are going to use <kbd class="calibre27">lxcpassword</kbd> as a password for all services throughout the chapter.</div>
<ol start="4" class="calibre18">
<li value="4" class="calibre17">Install the RabbitMQ messaging service, create a new user, password, and set permissions:</li>
</ol>
<pre class="calibre25">
<strong class="calibre4">root@controller:~# apt install rabbitmq-server</strong><br class="calibre7"/><strong class="calibre4">root@controller:~# rabbitmqctl add_user openstack lxcpassword</strong><br class="calibre7"/><strong class="calibre4">Creating user "openstack" ...</strong><br class="calibre7"/><strong class="calibre4">root@controller:~# rabbitmqctl set_permissions openstack ".*" ".*" ".*"</strong><br class="calibre7"/><strong class="calibre4">Setting permissions for user "openstack" in vhost "/" ...</strong><br class="calibre7"/><strong class="calibre4">root@controller:~#</strong>
</pre>
<ol start="5" class="calibre18">
<li value="5" class="calibre17">Install and configure the <kbd class="calibre13">memcached</kbd> service:</li>
</ol>
<pre class="calibre25">
<strong class="calibre4">root@controller:~# apt install memcached python-memcache</strong><br class="calibre7"/><strong class="calibre4">root@controller:~# sed -i 's/127.0.0.1/10.208.130.36/g'   <br class="calibre7"/>/etc/memcached.conf</strong><br class="calibre7"/><strong class="calibre4">root@controller:~# cat /etc/memcached.conf | grep -vi "#" | sed <br class="calibre7"/>'/^$/d'</strong><br class="calibre7"/><strong class="calibre4">-d</strong><br class="calibre7"/><strong class="calibre4">logfile /var/log/memcached.log</strong><br class="calibre7"/><strong class="calibre4">-m 64</strong><br class="calibre7"/><strong class="calibre4">-p 11211</strong><br class="calibre7"/><strong class="calibre4">-u memcache</strong><br class="calibre7"/><strong class="calibre4">-l 10.208.130.36</strong><br class="calibre7"/><strong class="calibre4">root@controller:~# service memcached restart</strong><br class="calibre7"/><strong class="calibre4">root@controller:~#</strong>
</pre>


            </article>

            <footer class="calibre5">
                
            </footer>

        </section>
    

        <section class="calibre1">

            <header class="calibre1">
                </header><h1 class="header-title" id="calibre_pb_0">How it works...</h1>
            

            <article class="calibre1">
                
<p class="calibre3">OpenStack uses a SQL database, such as Mysql/MariaDB/Percona, to store information about its services. In the following recipes, we are going to create databases for the Keystone, Glance, Nova, and Neutron projects. We install and configure MariaDB in steps 1 through 3.</p>
<p class="calibre3">The messaging queue we install and configure in step 4 provides a centralized way for the services to communicate with each other by producing and consuming messages. OpenStack supports a few different message bus implementations, such as RabbitMQ, Qpid, and ZeroMQ.</p>
<p class="calibre3">The identity service Keystone caches authentication tokens using the <kbd class="calibre13">memcached</kbd> daemon. We install and configure it in step 5.</p>


            </article>

            <footer class="calibre5">
                
            </footer>

        </section>
    

        <section class="calibre1">

            <header class="calibre1">
                </header><h1 class="header-title" id="calibre_pb_0">Installing and configuring the OpenStack Keystone identity service</h1>
            

            <article class="calibre1">
                
<p class="calibre3">The identity service provided by the Keystone project is a centralized point in order to manage authentication and authorization, used by other OpenStack components, such as Nova compute and the image service Glance. Keystone also keeps a catalog of services and the endpoints they provide that the user can locate by sending queries to it.</p>
<p class="calibre3">In this recipe, we are going to install and configure Keystone, create two projects (a unit of ownership) for our services and assign users and roles to those projects.</p>


            </article>

            <footer class="calibre5">
                
            </footer>

        </section>
    

        <section class="calibre1">

            <header class="calibre1">
                </header><h1 class="header-title" id="calibre_pb_0">Getting ready</h1>
            

            <article class="calibre1">
                
<p class="calibre3">For this recipe, we are going to need the following:</p>
<ul class="calibre16">
<li class="calibre17"><span><span>An Ubuntu Server with Great virtualization capabilities</span></span></li>
<li class="calibre17">Access to the Internet for package installation</li>
<li class="calibre17">A database server, a message queue, and <kbd class="calibre13">memcached</kbd> installed and configured, as described in the <em class="calibre22">Preparing the host for the OpenStack deployment</em> recipe</li>
</ul>


            </article>

            <footer class="calibre5">
                
            </footer>

        </section>
    

        <section class="calibre1">

            <header class="calibre1">
                </header><h1 class="header-title" id="calibre_pb_0">How to do it...</h1>
            

            <article class="calibre1">
                
<p class="calibre3">To install, configure, create new projects, user roles, and credentials, perform the following steps in the order presented here:</p>
<ol class="calibre18">
<li value="1" class="calibre17">Create the keystone database and grant permissions to the keystone user:</li>
</ol>
<pre class="calibre25">
<strong class="calibre4">root@controller:~# mysql -u root -plxcpassword</strong><br class="calibre7"/><strong class="calibre4">MariaDB [(none)]&gt; CREATE DATABASE keystone;</strong><br class="calibre7"/><strong class="calibre4">Query OK, 1 row affected (0.01 sec)</strong><br class="calibre7"/><strong class="calibre4">MariaDB [(none)]&gt; GRANT ALL PRIVILEGES ON keystone.* TO<br class="calibre7"/>'keystone'@'localhost' IDENTIFIED BY 'lxcpassword';</strong><br class="calibre7"/><strong class="calibre4">Query OK, 0 rows affected (0.00 sec)</strong><br class="calibre7"/><strong class="calibre4">MariaDB [(none)]&gt; GRANT ALL PRIVILEGES ON keystone.* TO <br class="calibre7"/>'keystone'@'%' IDENTIFIED BY 'lxcpassword';</strong><br class="calibre7"/><strong class="calibre4">Query OK, 0 rows affected (0.01 sec)</strong><br class="calibre7"/><strong class="calibre4">MariaDB [(none)]&gt; exit</strong><br class="calibre7"/><strong class="calibre4">Bye</strong><br class="calibre7"/><strong class="calibre4">root@controller:~#</strong>
</pre>
<ol start="2" class="calibre18">
<li value="2" class="calibre17">Install the identity service Keystone from the repository we configured earlier:</li>
</ol>
<pre class="calibre25">
<strong class="calibre4">root@controller:~# apt install keystone</strong>
</pre>
<ol start="3" class="calibre18">
<li value="3" class="calibre17">Create the following minimal Keystone configuration:</li>
</ol>
<pre class="calibre25">
<strong class="calibre4">root@controller:~# cat /etc/keystone/keystone.conf</strong><br class="calibre7"/><strong class="calibre4">[DEFAULT]</strong><br class="calibre7"/><strong class="calibre4">log_dir = /var/log/keystone</strong><br class="calibre7"/><br class="calibre7"/><strong class="calibre4">[assignment]</strong><br class="calibre7"/><strong class="calibre4">[auth]</strong><br class="calibre7"/><strong class="calibre4">[cache]</strong><br class="calibre7"/><strong class="calibre4">[catalog]</strong><br class="calibre7"/><strong class="calibre4">[cors]</strong><br class="calibre7"/><strong class="calibre4">[cors.subdomain]</strong><br class="calibre7"/><strong class="calibre4">[credential]</strong><br class="calibre7"/><strong class="calibre4">[database]</strong><br class="calibre7"/><strong class="calibre4">connection = mysql+pymysql://keystone:lxcpassword@controller/keystone</strong><br class="calibre7"/><br class="calibre7"/><strong class="calibre4">[domain_config]</strong><br class="calibre7"/><strong class="calibre4">[endpoint_filter]</strong><br class="calibre7"/><strong class="calibre4">[endpoint_policy]</strong><br class="calibre7"/><strong class="calibre4">[eventlet_server]</strong><br class="calibre7"/><strong class="calibre4">[federation]</strong><br class="calibre7"/><strong class="calibre4">[fernet_tokens]</strong><br class="calibre7"/><strong class="calibre4">[identity]</strong><br class="calibre7"/><strong class="calibre4">[identity_mapping]</strong><br class="calibre7"/><strong class="calibre4">[kvs]</strong><br class="calibre7"/><strong class="calibre4">[ldap]</strong><br class="calibre7"/><strong class="calibre4">[matchmaker_redis]</strong><br class="calibre7"/><strong class="calibre4">[memcache]</strong><br class="calibre7"/><strong class="calibre4">[oauth1]</strong><br class="calibre7"/><strong class="calibre4">[os_inherit]</strong><br class="calibre7"/><strong class="calibre4">[oslo_messaging_amqp]</strong><br class="calibre7"/><strong class="calibre4">[oslo_messaging_notifications]</strong><br class="calibre7"/><strong class="calibre4">[oslo_messaging_rabbit]</strong><br class="calibre7"/><strong class="calibre4">[oslo_messaging_zmq]</strong><br class="calibre7"/><strong class="calibre4">[oslo_middleware]</strong><br class="calibre7"/><strong class="calibre4">[oslo_policy]</strong><br class="calibre7"/><strong class="calibre4">[paste_deploy]</strong><br class="calibre7"/><strong class="calibre4">[policy]</strong><br class="calibre7"/><strong class="calibre4">[profiler]</strong><br class="calibre7"/><strong class="calibre4">[resource]</strong><br class="calibre7"/><strong class="calibre4">[revoke]</strong><br class="calibre7"/><strong class="calibre4">[role]</strong><br class="calibre7"/><strong class="calibre4">[saml]</strong><br class="calibre7"/><strong class="calibre4">[security_compliance]</strong><br class="calibre7"/><strong class="calibre4">[shadow_users]</strong><br class="calibre7"/><strong class="calibre4">[signing]</strong><br class="calibre7"/><strong class="calibre4">[token]</strong><br class="calibre7"/><strong class="calibre4">provider = fernet</strong><br class="calibre7"/><strong class="calibre4">[tokenless_auth]</strong><br class="calibre7"/><strong class="calibre4">[trust]</strong><br class="calibre7"/><strong class="calibre4">[extra_headers]</strong><br class="calibre7"/><strong class="calibre4">Distribution = Ubuntu</strong><br class="calibre7"/><strong class="calibre4">root@controller:~#</strong>
</pre>
<ol start="4" class="calibre18">
<li value="4" class="calibre17">Populate the Keystone database:</li>
</ol>
<pre class="calibre25">
<strong class="calibre4">root@controller:~# su -s /bin/sh -c "keystone-manage db_sync" keystone</strong><br class="calibre7"/><strong class="calibre4">...</strong><br class="calibre7"/><strong class="calibre4">root@controller:~#</strong>
</pre>
<ol start="5" class="calibre18">
<li value="5" class="calibre17">Initialize the Fernet key repositories:</li>
</ol>
<pre class="calibre25">
<strong class="calibre4">root@controller:~# keystone-manage fernet_setup --keystone-user keystone --keystone-group keystone</strong><br class="calibre7"/><strong class="calibre4">root@controller:~# keystone-manage credential_setup --keystone-user keystone --keystone-group keystone</strong><br class="calibre7"/><strong class="calibre4">root@controller:~#</strong>
</pre>
<ol start="6" class="calibre18">
<li value="6" class="calibre17">Bootstrap the Keystone service:</li>
</ol>
<pre class="calibre25">
<strong class="calibre4">root@controller:~# keystone-manage bootstrap --bootstrap-password lxcpassword --bootstrap-admin-url http://controller:35357/v3/ --bootstrap-internal-url http://controller:35357/v3/ --bootstrap-public-url http://controller:5000/v3/ --bootstrap-region-id RegionOne</strong><br class="calibre7"/><strong class="calibre4">root@controller:~#</strong>
</pre>
<ol start="7" class="calibre18">
<li value="7" class="calibre17">Add the following stanza in Apache and restart the service:</li>
</ol>
<pre class="calibre25">
<strong class="calibre4">root@controller:~# cat /etc/apache2/apache2.conf</strong><br class="calibre7"/><strong class="calibre4">...</strong><br class="calibre7"/><strong class="calibre4">ServerName controller </strong><br class="calibre7"/><strong class="calibre4">...</strong><br class="calibre7"/><strong class="calibre4">root@controller:~# service apache2 restart</strong>
</pre>
<ol start="8" class="calibre18">
<li value="8" class="calibre17">Delete the default SQLite database that Keystone is packaged with:</li>
</ol>
<pre class="calibre25">
<strong class="calibre4">root@controller:~# rm -f /var/lib/keystone/keystone.db</strong>
</pre>
<ol start="9" class="calibre18">
<li value="9" class="calibre17">Create an administrative account by defining the following environment variables:</li>
</ol>
<pre class="calibre25">
<strong class="calibre4">root@controller:~# export OS_USERNAME=admin</strong><br class="calibre7"/><strong class="calibre4">root@controller:~# export OS_PASSWORD=lxcpassword</strong><br class="calibre7"/><strong class="calibre4">root@controller:~# export OS_PROJECT_NAME=admin</strong><br class="calibre7"/><strong class="calibre4">root@controller:~# export OS_USER_DOMAIN_NAME=default</strong><br class="calibre7"/><strong class="calibre4">root@controller:~# export OS_PROJECT_DOMAIN_NAME=default</strong><br class="calibre7"/><strong class="calibre4">root@controller:~# export OS_AUTH_URL=http://controller:35357/v3</strong><br class="calibre7"/><strong class="calibre4">root@controller:~# export OS_IDENTITY_API_VERSION=3</strong><br class="calibre7"/><strong class="calibre4">root@controller:~#</strong>
</pre>
<ol start="10" class="calibre18">
<li value="10" class="calibre17">Create a project in Keystone for the services to use and list it:</li>
</ol>
<pre class="calibre25">
<strong class="calibre4">root@controller:~# openstack project create --domain default --description "KVM Project" service</strong><br class="calibre7"/><strong class="calibre4">+-------------+-----------------------------------+</strong><br class="calibre7"/><strong class="calibre4">| Field        | Value                            |</strong><br class="calibre7"/><strong class="calibre4">+-------------+-----------------------------------+</strong><br class="calibre7"/><strong class="calibre4">| description  | KVM Project                      |</strong><br class="calibre7"/><strong class="calibre4">| domain_id    | default                          |</strong><br class="calibre7"/><strong class="calibre4">| enabled      | True                             |</strong><br class="calibre7"/><strong class="calibre4">| id           | 9a1a863fe41b42b2955b313f2cca0ef0 |</strong><br class="calibre7"/><strong class="calibre4">| is_domain    | False                            |</strong><br class="calibre7"/><strong class="calibre4">| name         | service                          |</strong><br class="calibre7"/><strong class="calibre4">| parent_id    | default                          |</strong><br class="calibre7"/><strong class="calibre4">+-------------+-----------------------------------+</strong><br class="calibre7"/><strong class="calibre4">root@controller:~# openstack project list</strong><br class="calibre7"/><strong class="calibre4">+----------------------------------+---------+</strong><br class="calibre7"/><strong class="calibre4">| ID                               | Name    |</strong><br class="calibre7"/><strong class="calibre4">+----------------------------------+---------+</strong><br class="calibre7"/><strong class="calibre4">| 06f4e2d7e384474781803395b24b3af2 | admin   |</strong><br class="calibre7"/><strong class="calibre4">| 9a1a863fe41b42b2955b313f2cca0ef0 | service |</strong><br class="calibre7"/><strong class="calibre4">+----------------------------------+---------+</strong><br class="calibre7"/><strong class="calibre4">root@controller:~#</strong>
</pre>
<ol start="11" class="calibre18">
<li value="11" class="calibre17">Create an unprivileged project and a user that will be used by regular clients instead of the OpenStack services:</li>
</ol>
<pre class="calibre25">
<strong class="calibre4">root@controller:~# openstack project create --domain default --description "KVM User Project" kvm</strong><br class="calibre7"/><strong class="calibre4">+-------------+----------------------------------+</strong><br class="calibre7"/><strong class="calibre4">| Field       | Value                            |</strong><br class="calibre7"/><strong class="calibre4">+-------------+----------------------------------+</strong><br class="calibre7"/><strong class="calibre4">| description | KVM User Project                 |</strong><br class="calibre7"/><strong class="calibre4">| domain_id   | default                          |</strong><br class="calibre7"/><strong class="calibre4">| enabled     | True                             |</strong><br class="calibre7"/><strong class="calibre4">| id          | eb9cdc2c2b4e4f098f2d104752970d52 |</strong><br class="calibre7"/><strong class="calibre4">| is_domain   | False                            |</strong><br class="calibre7"/><strong class="calibre4">| name        | kvm                              |</strong><br class="calibre7"/><strong class="calibre4">| parent_id   | default                          |</strong><br class="calibre7"/><strong class="calibre4">+-------------+----------------------------------+</strong><br class="calibre7"/><strong class="calibre4">root@controller:~#</strong><br class="calibre7"/><strong class="calibre4">root@controller:~# openstack user create --domain default --password-prompt kvm</strong><br class="calibre7"/><strong class="calibre4">User Password:</strong><br class="calibre7"/><strong class="calibre4">Repeat User Password:</strong><br class="calibre7"/><strong class="calibre4">+---------------------+----------------------------------+</strong><br class="calibre7"/><strong class="calibre4">| Field               | Value                            |</strong><br class="calibre7"/><strong class="calibre4">+---------------------+----------------------------------+</strong><br class="calibre7"/><strong class="calibre4">| domain_id           | default                          |</strong><br class="calibre7"/><strong class="calibre4">| enabled             | True                             |</strong><br class="calibre7"/><strong class="calibre4">| id                  | 1e83e0c8ca194f2e9d8161eb61d21030 |</strong><br class="calibre7"/><strong class="calibre4">| name                | kvm                              |</strong><br class="calibre7"/><strong class="calibre4">| password_expires_at | None                             |</strong><br class="calibre7"/><strong class="calibre4">+---------------------+----------------------------------+</strong><br class="calibre7"/><strong class="calibre4">root@controller:~#</strong>
</pre>
<ol start="12" class="calibre18">
<li value="12" class="calibre17">Create a user role and associate it with the KVM project and user:</li>
</ol>
<pre class="calibre25">
<strong class="calibre4">root@controller:~# openstack role create user</strong><br class="calibre7"/><strong class="calibre4">+-----------+----------------------------------+</strong><br class="calibre7"/><strong class="calibre4">| Field     | Value                            |</strong><br class="calibre7"/><strong class="calibre4">+-----------+----------------------------------+</strong><br class="calibre7"/><strong class="calibre4">| domain_id | None                             |</strong><br class="calibre7"/><strong class="calibre4">| id        | 331c0b61e9784112874627264f03a058 |</strong><br class="calibre7"/><strong class="calibre4">| name      | user                             |</strong><br class="calibre7"/><strong class="calibre4">+-----------+----------------------------------+</strong><br class="calibre7"/><strong class="calibre4">root@controller:~# openstack role add --project kvm --user kvm user</strong><br class="calibre7"/><strong class="calibre4">root@controller:~#</strong>
</pre>
<ol start="13" class="calibre18">
<li value="13" class="calibre17">Configure the <strong class="calibre4">Web Service Gateway Interface</strong> (<strong class="calibre4">WSGI</strong>) middleware pipeline for Keystone:</li>
</ol>
<pre class="calibre25">
<strong class="calibre4">root@controller:~# cat /etc/keystone/keystone-paste.ini</strong><br class="calibre7"/><strong class="calibre4"># Keystone PasteDeploy configuration file.</strong><br class="calibre7"/><strong class="calibre4">[filter:debug]</strong><br class="calibre7"/><strong class="calibre4">use = egg:oslo.middleware#debug</strong><br class="calibre7"/><strong class="calibre4">[filter:request_id]</strong><br class="calibre7"/><strong class="calibre4">use = egg:oslo.middleware#request_id</strong><br class="calibre7"/><strong class="calibre4">[filter:build_auth_context]</strong><br class="calibre7"/><strong class="calibre4">use = egg:keystone#build_auth_context</strong><br class="calibre7"/><strong class="calibre4">[filter:token_auth]</strong><br class="calibre7"/><strong class="calibre4">use = egg:keystone#token_auth</strong><br class="calibre7"/><strong class="calibre4">[filter:admin_token_auth]</strong><br class="calibre7"/><strong class="calibre4">use = egg:keystone#admin_token_auth</strong><br class="calibre7"/><strong class="calibre4">[filter:json_body]</strong><br class="calibre7"/><strong class="calibre4">use = egg:keystone#json_body</strong><br class="calibre7"/><strong class="calibre4">[filter:cors]</strong><br class="calibre7"/><strong class="calibre4">use = egg:oslo.middleware#cors</strong><br class="calibre7"/><strong class="calibre4">oslo_config_project = keystone</strong><br class="calibre7"/><strong class="calibre4">[filter:http_proxy_to_wsgi]</strong><br class="calibre7"/><strong class="calibre4">use = egg:oslo.middleware#http_proxy_to_wsgi</strong><br class="calibre7"/><strong class="calibre4">[filter:ec2_extension]</strong><br class="calibre7"/><strong class="calibre4">use = egg:keystone#ec2_extension</strong><br class="calibre7"/><strong class="calibre4">[filter:ec2_extension_v3]</strong><br class="calibre7"/><strong class="calibre4">use = egg:keystone#ec2_extension_v3</strong><br class="calibre7"/><strong class="calibre4">[filter:s3_extension]</strong><br class="calibre7"/><strong class="calibre4">use = egg:keystone#s3_extension</strong><br class="calibre7"/><strong class="calibre4">[filter:url_normalize]</strong><br class="calibre7"/><strong class="calibre4">use = egg:keystone#url_normalize</strong><br class="calibre7"/><strong class="calibre4">[filter:sizelimit]</strong><br class="calibre7"/><strong class="calibre4">use = egg:oslo.middleware#sizelimit</strong><br class="calibre7"/><strong class="calibre4">[filter:osprofiler]</strong><br class="calibre7"/><strong class="calibre4">use = egg:osprofiler#osprofiler</strong><br class="calibre7"/><strong class="calibre4">[app:public_service]</strong><br class="calibre7"/><strong class="calibre4">use = egg:keystone#public_service</strong><br class="calibre7"/><strong class="calibre4">[app:service_v3]</strong><br class="calibre7"/><strong class="calibre4">use = egg:keystone#service_v3</strong><br class="calibre7"/><strong class="calibre4">[app:admin_service]</strong><br class="calibre7"/><strong class="calibre4">use = egg:keystone#admin_service</strong><br class="calibre7"/><strong class="calibre4">[pipeline:public_api]</strong><br class="calibre7"/><strong class="calibre4">pipeline = cors sizelimit http_proxy_to_wsgi osprofiler url_normalize request_id build_auth_context token_auth json_body ec2_extension public_service</strong><br class="calibre7"/><strong class="calibre4">[pipeline:admin_api]</strong><br class="calibre7"/><strong class="calibre4">pipeline = cors sizelimit http_proxy_to_wsgi osprofiler url_normalize request_id build_auth_context token_auth json_body ec2_extension s3_extension admin_service</strong><br class="calibre7"/><strong class="calibre4">[pipeline:api_v3]</strong><br class="calibre7"/><strong class="calibre4">pipeline = cors sizelimit http_proxy_to_wsgi osprofiler url_normalize request_id build_auth_context token_auth json_body ec2_extension_v3 s3_extension service_v3</strong><br class="calibre7"/><strong class="calibre4">[app:public_version_service]</strong><br class="calibre7"/><strong class="calibre4">use = egg:keystone#public_version_service</strong><br class="calibre7"/><strong class="calibre4">[app:admin_version_service]</strong><br class="calibre7"/><strong class="calibre4">use = egg:keystone#admin_version_service</strong><br class="calibre7"/><strong class="calibre4">[pipeline:public_version_api]</strong><br class="calibre7"/><strong class="calibre4">pipeline = cors sizelimit osprofiler url_normalize public_version_service</strong><br class="calibre7"/><strong class="calibre4">[pipeline:admin_version_api]</strong><br class="calibre7"/><strong class="calibre4">pipeline = cors sizelimit osprofiler url_normalize admin_version_service</strong><br class="calibre7"/><strong class="calibre4">[composite:main]</strong><br class="calibre7"/><strong class="calibre4">use = egg:Paste#urlmap</strong><br class="calibre7"/><strong class="calibre4">/v2.0 = public_api</strong><br class="calibre7"/><strong class="calibre4">/v3 = api_v3</strong><br class="calibre7"/><strong class="calibre4">/ = public_version_api</strong><br class="calibre7"/><strong class="calibre4">[composite:admin]</strong><br class="calibre7"/><strong class="calibre4">use = egg:Paste#urlmap</strong><br class="calibre7"/><strong class="calibre4">/v2.0 = admin_api</strong><br class="calibre7"/><strong class="calibre4">/v3 = api_v3</strong><br class="calibre7"/><strong class="calibre4">/ = admin_version_api</strong><br class="calibre7"/><strong class="calibre4">root@controller:~#</strong>
</pre>
<ol start="14" class="calibre18">
<li value="14" class="calibre17">Request a token for the admin and KVM users:</li>
</ol>
<pre class="calibre25">
<strong class="calibre4">root@controller:~# openstack --os-auth-url http://controller:35357/v3 --os-project-domain-name default --os-user-domain-name default --os-project-name admin --os-username admin token issue</strong><br class="calibre7"/><strong class="calibre4">+------------+----------------------------------+</strong><br class="calibre7"/><strong class="calibre4">| Field      | Value                            |</strong><br class="calibre7"/><strong class="calibre4">+------------+----------------------------------+</strong><br class="calibre7"/><strong class="calibre4">| expires    | 2017-04-26 18:29:03+00:00        |</strong><br class="calibre7"/><strong class="calibre4">| id         | gAAAAABZMIdwefsdfB8e4rFk5IALgM4U |</strong><br class="calibre7"/><strong class="calibre4">| project_id | 123c1e6f33584dd1876c0a34249a6e11 |</strong><br class="calibre7"/><strong class="calibre4">| user_id    | cc14c5dbbd654c438e52d38efaf4f1a6 |</strong><br class="calibre7"/><strong class="calibre4">+------------+----------------------------------+</strong><br class="calibre7"/><strong class="calibre4">root@controller:~# openstack --os-auth-url http://controller:5000/v3 --os-project-domain-name default --os-user-domain-name default --os-project-name kvm --os-username kvm token issue</strong><br class="calibre7"/><strong class="calibre4">+------------+----------------------------------+</strong><br class="calibre7"/><strong class="calibre4">| Field      | Value                            |</strong><br class="calibre7"/><strong class="calibre4">+------------+----------------------------------+</strong><br class="calibre7"/><strong class="calibre4">| expires    | 2017-04-26 18:29:52+00:00        |</strong><br class="calibre7"/><strong class="calibre4">| id         | gAAAAABZANkQmInUifl6Up_PzdH_9OHd |</strong><br class="calibre7"/><strong class="calibre4">| project_id | 10a92eccbad9439d9e56c4edda6b211f |</strong><br class="calibre7"/><strong class="calibre4">| user_id    | a186b226ed1e4717b25bb978f2bc9958 |</strong><br class="calibre7"/><strong class="calibre4">+------------+----------------------------------+</strong><br class="calibre7"/><strong class="calibre4">root@controller:~#</strong>
</pre>
<ol start="15" class="calibre18">
<li value="15" class="calibre17">Create the files that will contain the admin and user credentials:</li>
</ol>
<pre class="calibre25">
<strong class="calibre4">root@controller:~# cat rc.admin</strong><br class="calibre7"/><strong class="calibre4">export OS_PROJECT_DOMAIN_NAME=default</strong><br class="calibre7"/><strong class="calibre4">export OS_USER_DOMAIN_NAME=default</strong><br class="calibre7"/><strong class="calibre4">export OS_PROJECT_NAME=admin</strong><br class="calibre7"/><strong class="calibre4">export OS_USERNAME=admin</strong><br class="calibre7"/><strong class="calibre4">export OS_PASSWORD=lxcpassword</strong><br class="calibre7"/><strong class="calibre4">export OS_AUTH_URL=http://controller:35357/v3</strong><br class="calibre7"/><strong class="calibre4">export OS_IDENTITY_API_VERSION=3</strong><br class="calibre7"/><strong class="calibre4">export OS_IMAGE_API_VERSION=2</strong><br class="calibre7"/><strong class="calibre4">root@controller:~#</strong><br class="calibre7"/><strong class="calibre4">root@controller:~# cat rc.kvm</strong><br class="calibre7"/><strong class="calibre4">export OS_PROJECT_DOMAIN_NAME=default</strong><br class="calibre7"/><strong class="calibre4">export OS_USER_DOMAIN_NAME=default</strong><br class="calibre7"/><strong class="calibre4">export OS_PROJECT_NAME=kvm</strong><br class="calibre7"/><strong class="calibre4">export OS_USERNAME=kvm</strong><br class="calibre7"/><strong class="calibre4">export OS_PASSWORD=lxcpassword</strong><br class="calibre7"/><strong class="calibre4">export OS_AUTH_URL=http://controller:5000/v3</strong><br class="calibre7"/><strong class="calibre4">export OS_IDENTITY_API_VERSION=3</strong><br class="calibre7"/><strong class="calibre4">export OS_IMAGE_API_VERSION=2</strong><br class="calibre7"/><strong class="calibre4">root@controller:~#</strong>
</pre>
<ol start="16" class="calibre18">
<li value="16" class="calibre17">Source the admin credentials file:</li>
</ol>
<pre class="calibre25">
<strong class="calibre4"><span><span>root @ controller: ~ #. </span><span>rc.admin </span></span></strong><br class="calibre7"/><strong class="calibre4"><span><span>root @ controller: ~ #</span></span></strong>
</pre>
<ol start="17" class="calibre18">
<li value="17" class="calibre17">Request an authentication token for the admin user:</li>
</ol>
<pre class="calibre25">
<strong class="calibre4">root@controller:~# openstack token issue</strong><br class="calibre7"/><br class="calibre7"/><strong class="calibre4">+------------+----------------------------------+</strong><br class="calibre7"/><strong class="calibre4">| Field      | Value                            |</strong><br class="calibre7"/><strong class="calibre4">+------------+----------------------------------+</strong><br class="calibre7"/><strong class="calibre4">| expires    | 2017-04-26 18:30:41+00:00        |</strong><br class="calibre7"/><strong class="calibre4">| id         | gAAAAABZANlBdsu-DTmz6ME2Z8JFKjJM |</strong><br class="calibre7"/><strong class="calibre4">| project_id | 123c1e6f33584dd1876c0a34249a6e11 |</strong><br class="calibre7"/><strong class="calibre4">| user_id    | cc14c5dbbd654c438e52d38efaf4f1a6 |</strong><br class="calibre7"/><strong class="calibre4">+------------+----------------------------------+</strong><br class="calibre7"/><strong class="calibre4">root@controller:~#</strong>
</pre>


            </article>

            <footer class="calibre5">
                
            </footer>

        </section>
    

        <section class="calibre1">

            <header class="calibre1">
                </header><h1 class="header-title" id="calibre_pb_0">How it works...</h1>
            

            <article class="calibre1">
                
<p class="calibre3">We start by creating the Keystone database in MariaDB with the necessary user permissions in step 1. In step 2, we install the Keystone package.</p>
<p class="calibre3">In step 3, we create the configuration file for the service. As you can see from the output, most of the options have been omitted, and default ones are assumed.</p>
<p class="calibre3">In step 4, we run a script that populates the Keystone database by creating the database schema.</p>
<p class="calibre3">Keystone uses tokens to authenticate and authorize users and services. There are different token formats available for use, such as UUID, PKI, and Fernet tokens. For this deployment, we are going to use the Fernet tokens. The Fernet tokens do not need to be persisted in a backend store. In step 5, we initialize the Fernet key repository.</p>
<div class="packt_infobox">For more information on the available identity tokens, refer to <a href="http://docs.openstack.org/admin-guide/identity-tokens.html" class="calibre30">http://docs.openstack.org/admin-guide/identity-tokens.html</a>.</div>
<p class="calibre3">In step 6, we bootstrap Keystone and update the Apache configuration in step 7 and perform some cleanup in step 8.</p>
<p class="calibre3">In step 9, we export a list of environment variables containing the Keystone user, password, and endpoint.</p>
<p class="calibre3">In step 10, we create our first project in Keystone that will be used by the rest of the services. Projects represent a unit of ownership, where all resources are owned by a project. In steps 11 and 12, we create an unprivileged project and associated user.</p>
<p class="calibre3">In step 13, we configure the WSGI middleware pipeline for Keystone.</p>
<p class="calibre3">In step 14, we request and obtain tokens for the admin and KVM users, and in step 15, we create two environment variable files that we can source when we need to switch between users.</p>
<p class="calibre3">In steps 16 and 17, we source the admin credentials and project endpoint and obtain an authorization token.</p>


            </article>

            <footer class="calibre5">
                
            </footer>

        </section>
    

        <section class="calibre1">

            <header class="calibre1">
                </header><h1 class="header-title" id="calibre_pb_0">Installing and configuring the OpenStack Glance image service</h1>
            

            <article class="calibre1">
                
<p class="calibre3">The Glance image service provides an API that we can use to discover, register, and obtain images for virtual machines. When we later use Nova compute to build a new KVM instance, the Nova service will send a request to Glance to obtain the requested image type.</p>
<p class="calibre3">In this recipe, we are going to install Glance and register a new Ubuntu image.</p>


            </article>

            <footer class="calibre5">
                
            </footer>

        </section>
    

        <section class="calibre1">

            <header class="calibre1">
                </header><h1 class="header-title" id="calibre_pb_0">Getting ready</h1>
            

            <article class="calibre1">
                
<p class="calibre3">For this recipe, we are going to need the following things:</p>
<ul class="calibre16">
<li class="calibre17"><span><span>An Ubuntu server with great virtualization capabilities</span></span></li>
<li class="calibre17"><span><span>Access to the internet for package installation</span></span></li>
<li class="calibre17"><span><span>A database server, a message queue, and</span></span> <kbd class="calibre13">memcached</kbd> <span><span>installed and configured, as described in the</span></span> <em class="calibre22"><span><span>Preparing the host for the OpenStack deployment</span></span></em><span><span> recipe</span></span></li>
<li class="calibre17">The Keystone service we deployed in the <em class="calibre22">Installing and configuring the OpenStack Keystone identity service</em> recipe</li>
</ul>


            </article>

            <footer class="calibre5">
                
            </footer>

        </section>
    

        <section class="calibre1">

            <header class="calibre1">
                </header><h1 class="header-title" id="calibre_pb_0">How to do it...</h1>
            

            <article class="calibre1">
                
<p class="calibre3">To install, configure, and register an image with Glance, follow the steps outlined here:</p>
<ol class="calibre18">
<li value="1" class="calibre17"><span>Create the Glance database and user:</span></li>
</ol>
<pre class="calibre25">
<strong class="calibre4">root@controller:~# mysql -u root -plxcpassword</strong><br class="calibre7"/><strong class="calibre4">MariaDB [(none)]&gt; CREATE DATABASE glance;</strong><br class="calibre7"/><strong class="calibre4">Query OK, 1 row affected (0.00 sec)</strong><br class="calibre7"/><strong class="calibre4">MariaDB [(none)]&gt; GRANT ALL PRIVILEGES ON glance.* TO 'glance'@'localhost' IDENTIFIED BY 'lxcpassword';</strong><br class="calibre7"/><strong class="calibre4">Query OK, 0 rows affected (0.00 sec)</strong><br class="calibre7"/><strong class="calibre4">MariaDB [(none)]&gt; GRANT ALL PRIVILEGES ON glance.* TO 'glance'@'%' IDENTIFIED BY 'lxcpassword';</strong><br class="calibre7"/><strong class="calibre4">Query OK, 0 rows affected (0.00 sec)</strong><br class="calibre7"/><strong class="calibre4">MariaDB [(none)]&gt; exit</strong><br class="calibre7"/><strong class="calibre4">Bye</strong><br class="calibre7"/><strong class="calibre4">root@controller:~#</strong>
</pre>
<ol start="2" class="calibre18">
<li value="2" class="calibre17">Create the Glance user and add it to the admin role:</li>
</ol>
<pre class="calibre25">
<strong class="calibre4">root@controller:~# openstack user create --domain default --password-prompt glance</strong><br class="calibre7"/><strong class="calibre4">User Password:</strong><br class="calibre7"/><strong class="calibre4">Repeat User Password:</strong><br class="calibre7"/><strong class="calibre4">+---------------------+----------------------------------+</strong><br class="calibre7"/><strong class="calibre4">| Field               | Value                            |</strong><br class="calibre7"/><strong class="calibre4">+---------------------+----------------------------------+</strong><br class="calibre7"/><strong class="calibre4">| domain_id           | default                          |</strong><br class="calibre7"/><strong class="calibre4">| enabled             | True                             |</strong><br class="calibre7"/><strong class="calibre4">| id                  | e566c6e2012148daa374cd68077b38df |</strong><br class="calibre7"/><strong class="calibre4">| name                | glance                           |</strong><br class="calibre7"/><strong class="calibre4">| password_expires_at | None                             |</strong><br class="calibre7"/><strong class="calibre4">+---------------------+----------------------------------+</strong><br class="calibre7"/><strong class="calibre4">root@controller:~# openstack role add --project service --user glance admin</strong><br class="calibre7"/><strong class="calibre4">root@controller:~#</strong>
</pre>
<ol start="3" class="calibre18">
<li value="3" class="calibre17">Create the Glance service definition:</li>
</ol>
<pre class="calibre25">
<strong class="calibre4">root@controller:~# openstack service create --name glance --description "OpenStack Image" image</strong><br class="calibre7"/><strong class="calibre4">+-------------+----------------------------------+</strong><br class="calibre7"/><strong class="calibre4">| Field       | Value                            |</strong><br class="calibre7"/><strong class="calibre4">+-------------+----------------------------------+</strong><br class="calibre7"/><strong class="calibre4">| description | OpenStack Image                  |</strong><br class="calibre7"/><strong class="calibre4">| enabled     | True                             |</strong><br class="calibre7"/><strong class="calibre4">| id          | d4d42a586551461c8b445b927f2144e1 |</strong><br class="calibre7"/><strong class="calibre4">| name        | glance                           |</strong><br class="calibre7"/><strong class="calibre4">| type        | image                            |</strong><br class="calibre7"/><strong class="calibre4">+-------------+----------------------------------+</strong><br class="calibre7"/><strong class="calibre4">root@controller:~#</strong>
</pre>
<ol start="4" class="calibre18">
<li value="4" class="calibre17">Create the Glance API endpoints in Keystone:</li>
</ol>
<pre class="calibre25">
<strong class="calibre4">root@controller:~# openstack endpoint create --region RegionOne image public http://controller:9292</strong><br class="calibre7"/><strong class="calibre4">+--------------+----------------------------------+</strong><br class="calibre7"/><strong class="calibre4">| Field        | Value                            |</strong><br class="calibre7"/><strong class="calibre4">+--------------+----------------------------------+</strong><br class="calibre7"/><strong class="calibre4">| enabled      | True                             |</strong><br class="calibre7"/><strong class="calibre4">| id           | 618af0c845194f508752f230364d6e0e |</strong><br class="calibre7"/><strong class="calibre4">| interface    | public                           |</strong><br class="calibre7"/><strong class="calibre4">| region       | RegionOne                        |</strong><br class="calibre7"/><strong class="calibre4">| region_id    | RegionOne                        |</strong><br class="calibre7"/><strong class="calibre4">| service_id   | d4d42a586551461c8b445b927f2144e1 |</strong><br class="calibre7"/><strong class="calibre4">| service_name | glance                           |</strong><br class="calibre7"/><strong class="calibre4">| service_type | image                            |</strong><br class="calibre7"/><strong class="calibre4">| url          | http://controller:9292           |</strong><br class="calibre7"/><strong class="calibre4">+--------------+----------------------------------+</strong><br class="calibre7"/><strong class="calibre4">root@controller:~# openstack endpoint create --region RegionOne image internal http://controller:9292</strong><br class="calibre7"/><strong class="calibre4">+--------------+----------------------------------+</strong><br class="calibre7"/><strong class="calibre4">| Field        | Value                            |</strong><br class="calibre7"/><strong class="calibre4">+--------------+----------------------------------+</strong><br class="calibre7"/><strong class="calibre4">| enabled      | True                             |</strong><br class="calibre7"/><strong class="calibre4">| id           | 991a1b03f7194139b98bafe19acf3518 |</strong><br class="calibre7"/><strong class="calibre4">| interface    | internal                         |</strong><br class="calibre7"/><strong class="calibre4">| region       | RegionOne                        |</strong><br class="calibre7"/><strong class="calibre4">| region_id    | RegionOne                        |</strong><br class="calibre7"/><strong class="calibre4">| service_id   | d4d42a586551461c8b445b927f2144e1 |</strong><br class="calibre7"/><strong class="calibre4">| service_name | glance                           |</strong><br class="calibre7"/><strong class="calibre4">| service_type | image                            |</strong><br class="calibre7"/><strong class="calibre4">| url          | http://controller:9292           |</strong><br class="calibre7"/><strong class="calibre4">+--------------+----------------------------------+</strong><br class="calibre7"/><strong class="calibre4">root@controller:~# openstack endpoint create --region RegionOne image admin http://controller:9292</strong><br class="calibre7"/><strong class="calibre4">+--------------+----------------------------------+</strong><br class="calibre7"/><strong class="calibre4">| Field        | Value                            |</strong><br class="calibre7"/><strong class="calibre4">+--------------+----------------------------------+</strong><br class="calibre7"/><strong class="calibre4">| enabled      | True                             |</strong><br class="calibre7"/><strong class="calibre4">| id           | 991a1b03f7194139b98bafe19acf3322 |</strong><br class="calibre7"/><strong class="calibre4">| interface    | admin                            |</strong><br class="calibre7"/><strong class="calibre4">| region       | RegionOne                        |</strong><br class="calibre7"/><strong class="calibre4">| region_id    | RegionOne                        |</strong><br class="calibre7"/><strong class="calibre4">| service_id   | d4d42a586551461c8b445b927f2144e1 |</strong><br class="calibre7"/><strong class="calibre4">| service_name | glance                           |</strong><br class="calibre7"/><strong class="calibre4">| service_type | image                            |</strong><br class="calibre7"/><strong class="calibre4">| url          | http://controller:9292           |</strong><br class="calibre7"/><strong class="calibre4">+--------------+----------------------------------+</strong><br class="calibre7"/><strong class="calibre4">root@controller:~#</strong> 
</pre>
<ol start="5" class="calibre18">
<li value="5" class="calibre17">Install the Glance service:</li>
</ol>
<pre class="calibre25">
<strong class="calibre4">root@controller:~# apt install glance</strong>
</pre>
<ol start="6" class="calibre18">
<li value="6" class="calibre17">Configure the service:</li>
</ol>
<pre class="calibre25">
<strong class="calibre4">root@controller:~# cat /etc/glance/glance-api.conf</strong><br class="calibre7"/><strong class="calibre4">[DEFAULT]</strong><br class="calibre7"/><strong class="calibre4">[cors]</strong><br class="calibre7"/><strong class="calibre4">[cors.subdomain]</strong><br class="calibre7"/><br class="calibre7"/><strong class="calibre4">[database]</strong><br class="calibre7"/><strong class="calibre4">connection = mysql+pymysql://glance:lxcpassword@controller/glance</strong><br class="calibre7"/><br class="calibre7"/><strong class="calibre4">[glance_store]</strong><br class="calibre7"/><strong class="calibre4">stores = file,http</strong><br class="calibre7"/><strong class="calibre4">default_store = file</strong><br class="calibre7"/><strong class="calibre4">filesystem_store_datadir = /var/lib/glance/images/</strong><br class="calibre7"/><br class="calibre7"/><strong class="calibre4">[image_format]</strong><br class="calibre7"/><strong class="calibre4">disk_formats = ami,ari,aki,vhd,vhdx,vmdk,raw,qcow2,vdi,iso,root-tar</strong><br class="calibre7"/><br class="calibre7"/><strong class="calibre4">[keystone_authtoken]</strong><br class="calibre7"/><strong class="calibre4">auth_uri = http://controller:5000</strong><br class="calibre7"/><strong class="calibre4">auth_url = http://controller:35357</strong><br class="calibre7"/><strong class="calibre4">memcached_servers = controller:11211</strong><br class="calibre7"/><strong class="calibre4">auth_type = password</strong><br class="calibre7"/><strong class="calibre4">project_domain_name = default</strong><br class="calibre7"/><strong class="calibre4">user_domain_name = default</strong><br class="calibre7"/><strong class="calibre4">project_name = service</strong><br class="calibre7"/><strong class="calibre4">username = glance</strong><br class="calibre7"/><strong class="calibre4">password = lxcpassword</strong><br class="calibre7"/><br class="calibre7"/><strong class="calibre4">[matchmaker_redis]</strong><br class="calibre7"/><strong class="calibre4">[oslo_concurrency]</strong><br class="calibre7"/><strong class="calibre4">[oslo_messaging_amqp]</strong><br class="calibre7"/><strong class="calibre4">[oslo_messaging_notifications]</strong><br class="calibre7"/><strong class="calibre4">[oslo_messaging_rabbit]</strong><br class="calibre7"/><strong class="calibre4">[oslo_messaging_zmq]</strong><br class="calibre7"/><strong class="calibre4">[oslo_middleware]</strong><br class="calibre7"/><strong class="calibre4">[oslo_policy]</strong><br class="calibre7"/><strong class="calibre4">[paste_deploy]</strong><br class="calibre7"/><strong class="calibre4">flavor = keystone</strong><br class="calibre7"/><br class="calibre7"/><strong class="calibre4">[profiler]</strong><br class="calibre7"/><strong class="calibre4">[store_type_location_strategy]</strong><br class="calibre7"/><strong class="calibre4">[task]</strong><br class="calibre7"/><strong class="calibre4">[taskflow_executor]</strong><br class="calibre7"/><strong class="calibre4">root@controller:~#</strong><br class="calibre7"/><strong class="calibre4">root@controller:~# cat /etc/glance/glance-registry.conf</strong><br class="calibre7"/><strong class="calibre4">[DEFAULT]</strong><br class="calibre7"/><br class="calibre7"/><strong class="calibre4">[database]</strong><br class="calibre7"/><strong class="calibre4">connection = mysql+pymysql://glance:lxcpassword@controller/glance</strong><br class="calibre7"/><br class="calibre7"/><strong class="calibre4">[keystone_authtoken]</strong><br class="calibre7"/><strong class="calibre4">auth_uri = http://controller:5000</strong><br class="calibre7"/><strong class="calibre4">auth_url = http://controller:35357</strong><br class="calibre7"/><strong class="calibre4">memcached_servers = controller:11211</strong><br class="calibre7"/><strong class="calibre4">auth_type = password</strong><br class="calibre7"/><strong class="calibre4">project_domain_name = default</strong><br class="calibre7"/><strong class="calibre4">user_domain_name = default</strong><br class="calibre7"/><strong class="calibre4">project_name = service</strong><br class="calibre7"/><strong class="calibre4">username = glance</strong><br class="calibre7"/><strong class="calibre4">password = lxcpassword</strong><br class="calibre7"/><br class="calibre7"/><strong class="calibre4">[matchmaker_redis]</strong><br class="calibre7"/><strong class="calibre4">[oslo_messaging_amqp]</strong><br class="calibre7"/><strong class="calibre4">[oslo_messaging_notifications]</strong><br class="calibre7"/><strong class="calibre4">[oslo_messaging_rabbit]</strong><br class="calibre7"/><strong class="calibre4">[oslo_messaging_zmq]</strong><br class="calibre7"/><strong class="calibre4">[oslo_policy]</strong><br class="calibre7"/><strong class="calibre4">[paste_deploy]</strong><br class="calibre7"/><strong class="calibre4">flavor = keystone</strong><br class="calibre7"/><br class="calibre7"/><strong class="calibre4">[profiler]</strong><br class="calibre7"/><strong class="calibre4">root@controller:~#</strong>
</pre>
<ol start="7" class="calibre18">
<li value="7" class="calibre17">Populate the Glance database:</li>
</ol>
<pre class="calibre25">
<strong class="calibre4">root@controller:~# su -s /bin/sh -c "glance-manage db_sync" glance</strong><br class="calibre7"/><strong class="calibre4">...</strong><br class="calibre7"/><strong class="calibre4">root@controller:~#</strong>
</pre>
<ol start="8" class="calibre18">
<li value="8" class="calibre17">Start the Glance service daemons:</li>
</ol>
<pre class="calibre25">
<strong class="calibre4">root@controller:~# service glance-registry restart</strong><br class="calibre7"/><strong class="calibre4">root@controller:~# service glance-api restart</strong><br class="calibre7"/><strong class="calibre4">root@controller:~#</strong>
</pre>
<ol start="9" class="calibre18">
<li value="9" class="calibre17">Download a QCOW2 image for the Ubuntu distribution:</li>
</ol>
<pre class="calibre25">
<strong class="calibre4">root@controller:~# wget https://uec-images.ubuntu.com/releases/16.04/release-20170330/ubuntu-16.04-server-cloudimg-amd64-disk1.img</strong><br class="calibre7"/><strong class="calibre4">Saving to: ‘ubuntu-16.04-server-cloudimg-amd64-disk1.img’</strong><br class="calibre7"/><strong class="calibre4">ubuntu-16.04-server-cloudimg-amd64-disk1.img 100%[===================================================&gt;] 309.75M 31.1MB/s in 13s</strong><br class="calibre7"/><br class="calibre7"/><strong class="calibre4">2017-04-26 17:40:21 (24.5 MB/s) - ‘ubuntu-16.04-server-cloudimg-amd64-disk1.img’ saved [324796416/324796416]</strong><br class="calibre7"/><strong class="calibre4">root@controller:~#</strong>
</pre>
<ol start="10" class="calibre18">
<li value="10" class="calibre17">Add the image to the Glance service:</li>
</ol>
<pre class="calibre25">
<strong class="calibre4">root@controller:~# openstack image create "ubuntu_16.04" --file ubuntu-16.04-server-cloudimg-amd64-disk1.img --disk-format qcow2 --container-format bare --public</strong><br class="calibre7"/><strong class="calibre4">+------------------+------------------------------------------------------+</strong><br class="calibre7"/><strong class="calibre4">| Field            | Value                                                |</strong><br class="calibre7"/><strong class="calibre4">+------------------+------------------------------------------------------+</strong><br class="calibre7"/><strong class="calibre4">| checksum         | 87b0b7a4b03dd0bb2177d5cc02c80720                     |</strong><br class="calibre7"/><strong class="calibre4">| container_format | bare                                                 |</strong><br class="calibre7"/><strong class="calibre4">| created_at       | 2017-04-26T17:41:44Z                                 |</strong><br class="calibre7"/><strong class="calibre4">| disk_format      | qcow2                                                |</strong><br class="calibre7"/><strong class="calibre4">| file             | /v2/images/abce08d2-2f9f-4545-a414-32019d41c0cd/file |</strong><br class="calibre7"/><strong class="calibre4">| id               | abce08d2-2f9f-4545-a414-32019d41c0cd                 |</strong><br class="calibre7"/><strong class="calibre4">| min_disk         | 0                                                    |</strong><br class="calibre7"/><strong class="calibre4">| min_ram          | 0                                                    |</strong><br class="calibre7"/><strong class="calibre4">| name             | ubuntu_16.04                                         |</strong><br class="calibre7"/><strong class="calibre4">| owner            | 123c1e6f33584dd1876c0a34249a6e11                     |</strong><br class="calibre7"/><strong class="calibre4">| protected        | False                                                |</strong><br class="calibre7"/><strong class="calibre4">| schema           | /v2/schemas/image                                    |</strong><br class="calibre7"/><strong class="calibre4">| size             | 324796416                                            |</strong><br class="calibre7"/><strong class="calibre4">| status           | active                                               |</strong><br class="calibre7"/><strong class="calibre4">| tags             |                                                      |</strong><br class="calibre7"/><strong class="calibre4">| updated_at       | 2017-04-26T17:41:45Z                                 |</strong><br class="calibre7"/><strong class="calibre4">| virtual_size     | None                                                 |</strong><br class="calibre7"/><strong class="calibre4">| visibility       | public                                               |</strong><br class="calibre7"/><strong class="calibre4">+------------------+------------------------------------------------------+</strong><br class="calibre7"/><strong class="calibre4">root@controller:~#</strong>
</pre>
<ol start="11" class="calibre18">
<li value="11" class="calibre17">List the available images and their location on the filesystem:</li>
</ol>
<pre class="calibre25">
<strong class="calibre4">root@controller:~# openstack image list</strong><br class="calibre7"/><strong class="calibre4">+--------------------------------------+--------------+--------+</strong><br class="calibre7"/><strong class="calibre4">| ID                                   | Name         | Status |</strong><br class="calibre7"/><strong class="calibre4">+--------------------------------------+--------------+--------+</strong><br class="calibre7"/><strong class="calibre4">| abce08d2-2f9f-4545-a414-32019d41c0cd | ubuntu_16.04 | active |</strong><br class="calibre7"/><strong class="calibre4">+--------------------------------------+--------------+--------+</strong><br class="calibre7"/><strong class="calibre4">root@controller:~# ls -lah /var/lib/glance/images/</strong><br class="calibre7"/><strong class="calibre4">drwxr-xr-x 2 glance glance 4.0K Apr 26 17:51 .</strong><br class="calibre7"/><strong class="calibre4">drwxr-xr-x 4 glance glance 4.0K Apr 26 17:32 ..</strong><br class="calibre7"/><strong class="calibre4">-rw-r----- 1 glance glance 310M Apr 26 17:41 abce08d2-2f9f-4545-a414-32019d41c0cd</strong><br class="calibre7"/><strong class="calibre4">root@controller:~# qemu-img info /var/lib/glance/images/abce08d2-2f9f-4545-a414-32019d41c0cd</strong><br class="calibre7"/><strong class="calibre4">image: /var/lib/glance/images/abce08d2-2f9f-4545-a414-32019d41c0cd</strong><br class="calibre7"/><strong class="calibre4">file format: qcow2</strong><br class="calibre7"/><strong class="calibre4">virtual size: 2.2G (2361393152 bytes)</strong><br class="calibre7"/><strong class="calibre4">disk size: 310M</strong><br class="calibre7"/><strong class="calibre4">cluster_size: 65536</strong><br class="calibre7"/><strong class="calibre4">Format specific information:</strong><br class="calibre7"/><strong class="calibre4"> compat: 0.10</strong><br class="calibre7"/><strong class="calibre4"> refcount bits: 16</strong><br class="calibre7"/><strong class="calibre4">root@controller:~#</strong> 
</pre>


            </article>

            <footer class="calibre5">
                
            </footer>

        </section>
    

        <section class="calibre1">

            <header class="calibre1">
                </header><h1 class="header-title" id="calibre_pb_0">How it works...</h1>
            

            <article class="calibre1">
                
<p class="calibre3">We start by creating the Glance database in MariaDB in step 1.</p>
<p class="calibre3">In steps 2 and 3, we create the user, role, and service for the Glance project. In step 4, we define the Glance API service endpoints in Keystone. The Nova service and the OpenStack tool can use these endpoints to query Glance for available images.</p>
<p class="calibre3">In step 5, we install the Glance package and create a minimal configuration file in step 6.</p>
<p class="calibre3">We then create the database schemas in step 7, by executing the <kbd class="calibre13">glance-manage</kbd> Python script and restart the Glance service in step 8.</p>
<p class="calibre3">In step 9, we download a QCOW2 Ubuntu image and add it to the glance registry in step 10.</p>
<p class="calibre3">Finally, in step 11, we list the newly added image and examine it on the host filesystem.</p>


            </article>

            <footer class="calibre5">
                
            </footer>

        </section>
    

        <section class="calibre1">

            <header class="calibre1">
                </header><h1 class="header-title" id="calibre_pb_0">Installing and configuring the OpenStack Nova compute service</h1>
            

            <article class="calibre1">
                
<p class="calibre3">The OpenStack Compute service, code named Nova, manages a pool of compute resources  and the virtual machines running on them. Nova is a suite of services to create and manage the lifecycle of virtual machines. We will use Nova to create, examine, stop, delete, and migrate KVM instances.</p>
<div class="packt_infobox">For more information on the various Nova services, refer to: <a href="http://docs.openstack.org/developer/nova/" class="calibre30">http://docs.openstack.org/developer/nova/</a>.</div>
<p class="calibre3">In this recipe, we are going to install and configure the following Nova components:</p>
<ul class="calibre16">
<li class="calibre17"><kbd class="calibre13">nova-api</kbd>: This is the service that accepts and responds to user requests through a RESTful API. We will use it when creating, running, stopping, and migrating KVM instances.</li>
<li class="calibre17"><kbd class="calibre13">nova-scheduler</kbd>: <span>This is the</span> service that makes decisions on where to provision instance, based on filters, such as available memory, disk, and CPU resources.</li>
<li class="calibre17"><kbd class="calibre13">nova-compute</kbd>: <span>This is the</span> service that runs on the compute hosts and is responsible for managing the lifecycle of the KVM instance, from provisioning to deletion.</li>
<li class="calibre17"><kbd class="calibre13">nova-conductor</kbd>: <span>This is the</span> service that sits between the Nova database we created earlier and the <kbd class="calibre13">nova-compute</kbd> service.</li>
<li class="calibre17"><kbd class="calibre13">nova-consoleauth</kbd>: <span>This is the</span> service that authorizes tokens for users that want to use various consoles to connect to the virtual machines.</li>
<li class="calibre17"><kbd class="calibre13">nova-novncproxy</kbd>: <span>This is the</span> service that grants access to instances running VNC.</li>
</ul>


            </article>

            <footer class="calibre5">
                
            </footer>

        </section>
    

        <section class="calibre1">

            <header class="calibre1">
                </header><h1 class="header-title" id="calibre_pb_0">Getting ready</h1>
            

            <article class="calibre1">
                
<p class="calibre3">For this recipe, we are going to need:</p>
<ul class="calibre16">
<li class="calibre17"><span><span>An Ubuntu server with great virtualization capabilities</span></span></li>
<li class="calibre17"><span><span>Access to the internet for package installation</span></span></li>
<li class="calibre17"><span><span>A database server, a message queue, and</span></span> <kbd class="calibre13">memcached</kbd> <span><span>installed and configured, as described in the</span></span> <em class="calibre22"><span><span>Preparing the host for the OpenStack deployment</span></span></em><span><span> recipe</span></span></li>
<li class="calibre17"><span><span>The Keystone service we deployed in the</span></span> <em class="calibre22"><span><span>Installing and configuring the OpenStack Keystone identity service</span></span></em><span><span> recipe</span></span></li>
<li class="calibre17">The Glance service we deployed in the <em class="calibre22">Installing and configuring the OpenStack Glance image service</em> recipe</li>
</ul>


            </article>

            <footer class="calibre5">
                
            </footer>

        </section>
    

        <section class="calibre1">

            <header class="calibre1">
                </header><h1 class="header-title" id="calibre_pb_0">How to do it...</h1>
            

            <article class="calibre1">
                
<p class="calibre3">To install and configure the Nova services outlined earlier, perform the following steps:</p>
<ol class="calibre18">
<li value="1" class="calibre17">Create the Nova database and user in MariaDB:</li>
</ol>
<pre class="calibre25">
<strong class="calibre4">root@controller:~# mysql -u root -plxcpassword</strong><br class="calibre7"/><strong class="calibre4">MariaDB [(none)]&gt; CREATE DATABASE nova_api;</strong><br class="calibre7"/><strong class="calibre4">Query OK, 1 row affected (0.00 sec)</strong><br class="calibre7"/><strong class="calibre4">MariaDB [(none)]&gt; CREATE DATABASE nova;</strong><br class="calibre7"/><strong class="calibre4">Query OK, 1 row affected (0.00 sec)</strong><br class="calibre7"/><strong class="calibre4">MariaDB [(none)]&gt; GRANT ALL PRIVILEGES ON nova_api.* TO 'nova'@'localhost' IDENTIFIED BY 'lxcpassword';</strong><br class="calibre7"/><strong class="calibre4">Query OK, 0 rows affected (0.03 sec)</strong><br class="calibre7"/><strong class="calibre4">MariaDB [(none)]&gt; GRANT ALL PRIVILEGES ON nova_api.* TO 'nova'@'%' IDENTIFIED BY 'lxcpassword';</strong><br class="calibre7"/><strong class="calibre4">Query OK, 0 rows affected (0.00 sec)</strong><br class="calibre7"/><strong class="calibre4">MariaDB [(none)]&gt; GRANT ALL PRIVILEGES ON nova.* TO 'nova'@'localhost' IDENTIFIED BY 'lxcpassword';</strong><br class="calibre7"/><strong class="calibre4">Query OK, 0 rows affected (0.00 sec)</strong><br class="calibre7"/><strong class="calibre4">MariaDB [(none)]&gt; GRANT ALL PRIVILEGES ON nova.* TO 'nova'@'%' IDENTIFIED BY 'lxcpassword';</strong><br class="calibre7"/><strong class="calibre4">Query OK, 0 rows affected (0.00 sec)</strong><br class="calibre7"/><strong class="calibre4">MariaDB [(none)]&gt; exit</strong><br class="calibre7"/><strong class="calibre4">Bye</strong><br class="calibre7"/><strong class="calibre4">root@controller:~#</strong>
</pre>
<ol start="2" class="calibre18">
<li value="2" class="calibre17">Create the Nova user and add it to the admin role in the Identity service:</li>
</ol>
<pre class="calibre25">
<strong class="calibre4">root@controller:~# openstack user create --domain default --password-prompt nova</strong><br class="calibre7"/><strong class="calibre4">User Password:</strong><br class="calibre7"/><strong class="calibre4">Repeat User Password:</strong><br class="calibre7"/><strong class="calibre4">+---------------------+----------------------------------+</strong><br class="calibre7"/><strong class="calibre4">| Field               | Value                            |</strong><br class="calibre7"/><strong class="calibre4">+---------------------+----------------------------------+</strong><br class="calibre7"/><strong class="calibre4">| domain_id           | default                          |</strong><br class="calibre7"/><strong class="calibre4">| enabled             | True                             |</strong><br class="calibre7"/><strong class="calibre4">| id                  | 038aa8840aca449dbd3e653c5d2c5a08 |</strong><br class="calibre7"/><strong class="calibre4">| name                | nova                             |</strong><br class="calibre7"/><strong class="calibre4">| password_expires_at | None                             |</strong><br class="calibre7"/><strong class="calibre4">+---------------------+----------------------------------+</strong><br class="calibre7"/><strong class="calibre4">root@controller:~# openstack role add --project service --user nova admin</strong><br class="calibre7"/><strong class="calibre4">root@controller:~#</strong>
</pre>
<ol start="3" class="calibre18">
<li value="3" class="calibre17">Create the Nova service and endpoints:</li>
</ol>
<pre class="calibre25">
<strong class="calibre4">root@controller:~# openstack service create --name nova --description "OpenStack Compute" compute</strong><br class="calibre7"/><strong class="calibre4">+-------------+----------------------------------+</strong><br class="calibre7"/><strong class="calibre4">| Field       | Value                            |</strong><br class="calibre7"/><strong class="calibre4">+-------------+----------------------------------+</strong><br class="calibre7"/><strong class="calibre4">| description | OpenStack Compute                |</strong><br class="calibre7"/><strong class="calibre4">| enabled     | True                             |</strong><br class="calibre7"/><strong class="calibre4">| id          | 04132edd7f654f56ba0cc23ac182c9aa |</strong><br class="calibre7"/><strong class="calibre4">| name        | nova                             |</strong><br class="calibre7"/><strong class="calibre4">| type        | compute                          |</strong><br class="calibre7"/><strong class="calibre4">+-------------+----------------------------------+</strong><br class="calibre7"/><strong class="calibre4">root@controller:~# openstack endpoint create --region RegionOne compute public http://controller:8774/v2.1/%(tenant_id)s</strong><br class="calibre7"/><strong class="calibre4">+--------------+-------------------------------------------+</strong><br class="calibre7"/><strong class="calibre4">| Field        | Value                                     |</strong><br class="calibre7"/><strong class="calibre4">+--------------+-------------------------------------------+</strong><br class="calibre7"/><strong class="calibre4">| enabled      | True                                      |</strong><br class="calibre7"/><strong class="calibre4">| id           | 5fc54236c324412db135dff88807e820          |</strong><br class="calibre7"/><strong class="calibre4">| interface    | public                                    |</strong><br class="calibre7"/><strong class="calibre4">| region       | RegionOne                                 |</strong><br class="calibre7"/><strong class="calibre4">| region_id    | RegionOne                                 |</strong><br class="calibre7"/><strong class="calibre4">| service_id   | 04132edd7f654f56ba0cc23ac182c9aa          |</strong><br class="calibre7"/><strong class="calibre4">| service_name | nova                                      |</strong><br class="calibre7"/><strong class="calibre4">| service_type | compute                                   |</strong><br class="calibre7"/><strong class="calibre4">| url          | http://controller:8774/v2.1/%(tenant_id)s |</strong><br class="calibre7"/><strong class="calibre4">+--------------+-------------------------------------------+</strong><br class="calibre7"/><strong class="calibre4">root@controller:~# openstack endpoint create --region RegionOne compute internal http://controller:8774/v2.1/%(tenant_id)s</strong><br class="calibre7"/><strong class="calibre4">+--------------+-------------------------------------------+</strong><br class="calibre7"/><strong class="calibre4">| Field        | Value                                     |</strong><br class="calibre7"/><strong class="calibre4">+--------------+-------------------------------------------+</strong><br class="calibre7"/><strong class="calibre4">| enabled      | True                                      |</strong><br class="calibre7"/><strong class="calibre4">| id           | a0f623ed345e4bdb8fced929b7fe6b3f          |</strong><br class="calibre7"/><strong class="calibre4">| interface    | internal                                  |</strong><br class="calibre7"/><strong class="calibre4">| region       | RegionOne                                 |</strong><br class="calibre7"/><strong class="calibre4">| region_id    | RegionOne                                 |</strong><br class="calibre7"/><strong class="calibre4">| service_id   | 04132edd7f654f56ba0cc23ac182c9aa          |</strong><br class="calibre7"/><strong class="calibre4">| service_name | nova                                      |</strong><br class="calibre7"/><strong class="calibre4">| service_type | compute                                   |</strong><br class="calibre7"/><strong class="calibre4">| url          | http://controller:8774/v2.1/%(tenant_id)s |</strong><br class="calibre7"/><strong class="calibre4">+--------------+-------------------------------------------+</strong><br class="calibre7"/><strong class="calibre4">root@controller:~# openstack endpoint create --region RegionOne compute admin http://controller:8774/v2.1/%(tenant_id)s</strong><br class="calibre7"/><strong class="calibre4">+--------------+-------------------------------------------+</strong><br class="calibre7"/><strong class="calibre4">| Field        | Value                                     |</strong><br class="calibre7"/><strong class="calibre4">+--------------+-------------------------------------------+</strong><br class="calibre7"/><strong class="calibre4">| enabled      | True                                      |</strong><br class="calibre7"/><strong class="calibre4">| id           | 3964db0d281545acbaa6c18abc44a216          |</strong><br class="calibre7"/><strong class="calibre4">| interface    | admin                                     |</strong><br class="calibre7"/><strong class="calibre4">| region       | RegionOne                                 |</strong><br class="calibre7"/><strong class="calibre4">| region_id    | RegionOne                                 |</strong><br class="calibre7"/><strong class="calibre4">| service_id   | 04132edd7f654f56ba0cc23ac182c9aa          |</strong><br class="calibre7"/><strong class="calibre4">| service_name | nova                                      |</strong><br class="calibre7"/><strong class="calibre4">| service_type | compute                                   |</strong><br class="calibre7"/><strong class="calibre4">| url          | http://controller:8774/v2.1/%(tenant_id)s |</strong><br class="calibre7"/><strong class="calibre4">+--------------+-------------------------------------------+</strong><br class="calibre7"/><strong class="calibre4">root@controller:~#</strong>
</pre>
<ol start="4" class="calibre18">
<li value="4" class="calibre17">Install the Nova packages that will provide the API, the conductor, the console, and the scheduler services:</li>
</ol>
<pre class="calibre25">
<strong class="calibre4">root@controller:~# apt install nova-api nova-conductor nova-consoleauth nova-novncproxy nova-scheduler</strong>
</pre>
<ol start="5" class="calibre18">
<li value="5" class="calibre17">Create the Nova configuration file:</li>
</ol>
<pre class="calibre25">
<strong class="calibre4">root@controller:~# cat /etc/nova/nova.conf</strong><br class="calibre7"/><strong class="calibre4">[DEFAULT]</strong><br class="calibre7"/><strong class="calibre4">dhcpbridge_flagfile=/etc/nova/nova.conf</strong><br class="calibre7"/><strong class="calibre4">dhcpbridge=/usr/bin/nova-dhcpbridge</strong><br class="calibre7"/><strong class="calibre4">log-dir=/var/log/nova</strong><br class="calibre7"/><strong class="calibre4">state_path=/var/lib/nova</strong><br class="calibre7"/><strong class="calibre4">force_dhcp_release=True</strong><br class="calibre7"/><strong class="calibre4">verbose=True</strong><br class="calibre7"/><strong class="calibre4">ec2_private_dns_show_ip=True</strong><br class="calibre7"/><strong class="calibre4">enabled_apis=osapi_compute,metadata</strong><br class="calibre7"/><strong class="calibre4">transport_url = rabbit://openstack:lxcpassword@controller</strong><br class="calibre7"/><strong class="calibre4">auth_strategy = keystone</strong><br class="calibre7"/><strong class="calibre4">my_ip = 10.208.132.45</strong><br class="calibre7"/><strong class="calibre4">use_neutron = True</strong><br class="calibre7"/><strong class="calibre4">firewall_driver = nova.virt.firewall.NoopFirewallDriver</strong><br class="calibre7"/><br class="calibre7"/><strong class="calibre4">[database]</strong><br class="calibre7"/><strong class="calibre4">connection = mysql+pymysql://nova:lxcpassword@controller/nova</strong><br class="calibre7"/><br class="calibre7"/><strong class="calibre4">[api_database]</strong><br class="calibre7"/><strong class="calibre4">connection = mysql+pymysql://nova:lxcpassword@controller/nova_api</strong><br class="calibre7"/><br class="calibre7"/><strong class="calibre4">[oslo_concurrency]</strong><br class="calibre7"/><strong class="calibre4">lock_path = /var/lib/nova/tmp</strong><br class="calibre7"/><br class="calibre7"/><strong class="calibre4">[libvirt]</strong><br class="calibre7"/><strong class="calibre4">use_virtio_for_bridges=True</strong><br class="calibre7"/><br class="calibre7"/><strong class="calibre4">[wsgi]</strong><br class="calibre7"/><strong class="calibre4">api_paste_config=/etc/nova/api-paste.ini</strong><br class="calibre7"/><br class="calibre7"/><strong class="calibre4">[keystone_authtoken]</strong><br class="calibre7"/><strong class="calibre4">auth_uri = http://controller:5000</strong><br class="calibre7"/><strong class="calibre4">auth_url = http://controller:35357</strong><br class="calibre7"/><strong class="calibre4">memcached_servers = controller:11211</strong><br class="calibre7"/><strong class="calibre4">auth_type = password</strong><br class="calibre7"/><strong class="calibre4">project_domain_name = default</strong><br class="calibre7"/><strong class="calibre4">user_domain_name = default</strong><br class="calibre7"/><strong class="calibre4">project_name = service</strong><br class="calibre7"/><strong class="calibre4">username = nova</strong><br class="calibre7"/><strong class="calibre4">password = lxcpassword</strong><br class="calibre7"/><br class="calibre7"/><strong class="calibre4">[vnc]</strong><br class="calibre7"/><strong class="calibre4">vncserver_listen = $my_ip</strong><br class="calibre7"/><strong class="calibre4">vncserver_proxyclient_address = $my_ip</strong><br class="calibre7"/><br class="calibre7"/><strong class="calibre4">[glance]</strong><br class="calibre7"/><strong class="calibre4">api_servers = http://controller:9292</strong><br class="calibre7"/><strong class="calibre4">root@controller:~#</strong>
</pre>
<ol start="6" class="calibre18">
<li value="6" class="calibre17">Create the database tables:</li>
</ol>
<pre class="calibre25">
<strong class="calibre4">root@controller:~# su -s /bin/sh -c "nova-manage api_db sync" nova</strong><br class="calibre7"/><strong class="calibre4">...</strong><br class="calibre7"/><strong class="calibre4">root@controller:~# su -s /bin/sh -c "nova-manage db sync" nova</strong><br class="calibre7"/><strong class="calibre4">...</strong><br class="calibre7"/><strong class="calibre4">root@controller:~#</strong>
</pre>
<ol start="7" class="calibre18">
<li value="7" class="calibre17">Start the Nova services:</li>
</ol>
<pre class="calibre25">
<strong class="calibre4">root@controller:~# service nova-api restart</strong><br class="calibre7"/><strong class="calibre4">root@controller:~# service nova-consoleauth restart</strong><br class="calibre7"/><strong class="calibre4">root@controller:~# service nova-scheduler restart</strong><br class="calibre7"/><strong class="calibre4">root@controller:~# service nova-conductor restart</strong><br class="calibre7"/><strong class="calibre4">root@controller:~# service nova-novncproxy restart</strong><br class="calibre7"/><strong class="calibre4">root@controller:~#</strong>
</pre>
<ol start="8" class="calibre18">
<li value="8" class="calibre17">Install the <kbd class="calibre13">nova-compute</kbd> service, which will provision KVM instances:</li>
</ol>
<pre class="calibre25">
<strong class="calibre4">root@controller:~# apt install nova-compute</strong>
</pre>
<ol start="9" class="calibre18">
<li value="9" class="calibre17">Update the Nova configuration file, as follows:</li>
</ol>
<pre class="calibre25">
<strong class="calibre4">root@controller:~# cat /etc/nova/nova.conf</strong><br class="calibre7"/><strong class="calibre4">[DEFAULT]</strong><br class="calibre7"/><strong class="calibre4">dhcpbridge_flagfile=/etc/nova/nova.conf</strong><br class="calibre7"/><strong class="calibre4">dhcpbridge=/usr/bin/nova-dhcpbridge</strong><br class="calibre7"/><strong class="calibre4">log-dir=/var/log/nova</strong><br class="calibre7"/><strong class="calibre4">state_path=/var/lib/nova</strong><br class="calibre7"/><strong class="calibre4">force_dhcp_release=True</strong><br class="calibre7"/><strong class="calibre4">verbose=True</strong><br class="calibre7"/><strong class="calibre4">ec2_private_dns_show_ip=True</strong><br class="calibre7"/><strong class="calibre4">enabled_apis=osapi_compute,metadata</strong><br class="calibre7"/><strong class="calibre4">transport_url = rabbit://openstack:lxcpassword@controller</strong><br class="calibre7"/><strong class="calibre4">auth_strategy = keystone</strong><br class="calibre7"/><strong class="calibre4">my_ip = 10.208.132.45</strong><br class="calibre7"/><strong class="calibre4">use_neutron = True</strong><br class="calibre7"/><strong class="calibre4">firewall_driver = nova.virt.firewall.NoopFirewallDriver</strong><br class="calibre7"/><strong class="calibre4">compute_driver = libvirt.LibvirtDriver</strong><br class="calibre7"/><br class="calibre7"/><strong class="calibre4">[database]</strong><br class="calibre7"/><strong class="calibre4">connection = mysql+pymysql://nova:lxcpassword@controller/nova</strong><br class="calibre7"/><br class="calibre7"/><strong class="calibre4">[api_database]</strong><br class="calibre7"/><strong class="calibre4">connection = mysql+pymysql://nova:lxcpassword@controller/nova_api</strong><br class="calibre7"/><br class="calibre7"/><strong class="calibre4">[oslo_concurrency]</strong><br class="calibre7"/><strong class="calibre4">lock_path = /var/lib/nova/tmp</strong><br class="calibre7"/><br class="calibre7"/><strong class="calibre4">[libvirt]</strong><br class="calibre7"/><strong class="calibre4">use_virtio_for_bridges=True</strong><br class="calibre7"/><br class="calibre7"/><strong class="calibre4">[wsgi]</strong><br class="calibre7"/><strong class="calibre4">api_paste_config=/etc/nova/api-paste.ini</strong><br class="calibre7"/><br class="calibre7"/><strong class="calibre4">[keystone_authtoken]</strong><br class="calibre7"/><strong class="calibre4">auth_uri = http://controller:5000</strong><br class="calibre7"/><strong class="calibre4">auth_url = http://controller:35357</strong><br class="calibre7"/><strong class="calibre4">memcached_servers = controller:11211</strong><br class="calibre7"/><strong class="calibre4">auth_type = password</strong><br class="calibre7"/><strong class="calibre4">project_domain_name = default</strong><br class="calibre7"/><strong class="calibre4">user_domain_name = default</strong><br class="calibre7"/><strong class="calibre4">project_name = service</strong><br class="calibre7"/><strong class="calibre4">username = nova</strong><br class="calibre7"/><strong class="calibre4">password = lxcpassword</strong><br class="calibre7"/><br class="calibre7"/><strong class="calibre4">[vnc]</strong><br class="calibre7"/><strong class="calibre4">enabled = True</strong><br class="calibre7"/><strong class="calibre4">vncserver_listen = $my_ip</strong><br class="calibre7"/><strong class="calibre4">vncserver_proxyclient_address = $my_ip</strong><br class="calibre7"/><strong class="calibre4">novncproxy_base_url = http://controller:6080/vnc_auto.html</strong><br class="calibre7"/><br class="calibre7"/><strong class="calibre4">[glance]</strong><br class="calibre7"/><strong class="calibre4">api_servers = http://controller:9292</strong><br class="calibre7"/><br class="calibre7"/><strong class="calibre4">root@controller:~#</strong>
</pre>
<ol start="10" class="calibre18">
<li value="10" class="calibre17">Specify the virtualization driver to be used:</li>
</ol>
<pre class="calibre25">
<strong class="calibre4">root@controller:~# cat /etc/nova/nova-compute.conf</strong><br class="calibre7"/><strong class="calibre4">[DEFAULT]</strong><br class="calibre7"/><strong class="calibre4">compute_driver=libvirt.LibvirtDriver</strong><br class="calibre7"/><strong class="calibre4">[libvirt]</strong><br class="calibre7"/><strong class="calibre4">virt_type=kvm</strong><br class="calibre7"/><strong class="calibre4">root@controller:~#</strong> 
</pre>
<ol start="11" class="calibre18">
<li value="11" class="calibre17">Restart the <kbd class="calibre13">nova-compute</kbd> service and list the available services:</li>
</ol>
<pre class="calibre25">
<strong class="calibre4">root@controller:~# service nova-compute restart</strong><br class="calibre7"/><strong class="calibre4">root@controller:~# openstack compute service list</strong><br class="calibre7"/><strong class="calibre4">+----+------------------+------------+----------+---------+-------+----------------------+</strong><br class="calibre7"/><strong class="calibre4">| ID | Binary           | Host       | Zone     | Status  | State | Updated At           |</strong><br class="calibre7"/><strong class="calibre4">+----+------------------+------------+----------+---------+-------+----------------------+</strong><br class="calibre7"/><strong class="calibre4">| 8  | nova-consoleauth | controller | internal | enabled | up    | 2017-04-26T17:58     |</strong><br class="calibre7"/><strong class="calibre4">| 9  | nova-scheduler   | controller | internal | enabled | up    | 2017-04-26T17:58     |</strong><br class="calibre7"/><strong class="calibre4">| 10 | nova-conductor   | controller | internal | enabled | up    | 2017-04-26T17:58     |</strong><br class="calibre7"/><strong class="calibre4">| 15 | nova-compute     | controller | nova     | enabled | up    | None                 |</strong><br class="calibre7"/><strong class="calibre4">+----+------------------+------------+----------+---------+-------+----------------------+</strong><br class="calibre7"/><strong class="calibre4">root@controller:~# pgrep -lf nova | uniq -f1</strong><br class="calibre7"/><strong class="calibre4">14110 nova-consoleaut</strong><br class="calibre7"/><strong class="calibre4">14176 nova-conductor</strong><br class="calibre7"/><strong class="calibre4">14239 nova-novncproxy</strong><br class="calibre7"/><strong class="calibre4">20877 nova-api</strong><br class="calibre7"/><strong class="calibre4">20994 nova-scheduler</strong><br class="calibre7"/><strong class="calibre4">21065 nova-compute</strong><br class="calibre7"/><strong class="calibre4">root@controller:~#</strong>
</pre>


            </article>

            <footer class="calibre5">
                
            </footer>

        </section>
    

        <section class="calibre1">

            <header class="calibre1">
                </header><h1 class="header-title" id="calibre_pb_0">How it works...</h1>
            

            <article class="calibre1">
                
<p class="calibre3">In steps 1 and 2, we create the Nova database and user in MariaDB. In step 3, we create the service and endpoints that we can use to send API calls to.</p>
<p class="calibre3">In steps 4 and 5, we install the packages for the Nova services and proceed to create a simple configuration file.</p>
<p class="calibre3">We create the database table schemas in step 6 and start the Nova services in step 7.</p>
<p class="calibre3">For this example deployment, we are using a single node to run all of the OpenStack services we are interested in. However, you can use a second node just for the <kbd class="calibre13">nova-compute</kbd> service that will provision the KVM virtual machines. We install the <kbd class="calibre13">nova-compute</kbd> service in step 8, update the configuration file, and examine the <kbd class="calibre13">nova-compute</kbd> service external configuration in steps 9 and 10.</p>
<p class="calibre3">We finish the recipe by making sure that all Nova services have been configured and running in step 11. </p>


            </article>

            <footer class="calibre5">
                
            </footer>

        </section>
    

        <section class="calibre1">

            <header class="calibre1">
                </header><h1 class="header-title" id="calibre_pb_0">Installing and configuring the OpenStack Neutron networking service</h1>
            

            <article class="calibre1">
                
<p class="calibre3">The OpenStack Neutron project provides networking as a service to manage the networking between virtual instances. It is responsible for setting up virtual interfaces, configuring a software bridge, creating routes, and managing IP addressing.</p>
<div class="packt_infobox"><span class="calibre33">For more information on the various Neutron services, refer to <a href="https://docs.openstack.org/security-guide/networking/architecture.html" class="calibre30">https://docs.openstack.org/security-guide/networking/architecture.html</a></span><span class="calibre33">.</span></div>
<p class="calibre3">In this recipe, we are going to install and configure the following Neutron components:</p>
<ul class="calibre16">
<li class="calibre17"><kbd class="calibre13">neutron-server</kbd>: <span>This is the</span> service that provides API to dynamically request and configure virtual networks</li>
<li class="calibre17"><kbd class="calibre13">neutron-plugin-ml2</kbd>: <span>This is the</span><span> </span>framework that enables the use of various network technologies, such as the Linux Bridge, Open vSwitch, GRE, and VXLAN, that we saw in earlier chapters</li>
<li class="calibre17"><kbd class="calibre13">neutron-linuxbridge-agent</kbd>: <span>This is the</span> service that provides the Linux bridge plugin agent</li>
<li class="calibre17"><kbd class="calibre13">neutron-l3-agent</kbd>: <span>This is the</span> daemon that performs forwarding and NAT functionality between software-defined networks, by creating virtual routers</li>
<li class="calibre17"><kbd class="calibre13">neutron-dhcp-agent</kbd>: <span>This is the</span> service that controls the DHCP daemon, which assigns IP addresses to the instances running on the compute nodes</li>
<li class="calibre17"><kbd class="calibre13">neutron-metadata-agent</kbd>: <span>This is the</span> service that passes instance metadata to Neutron</li>
</ul>
<p class="calibre3">In earlier recipes, we configured and used the Linux bridge and Open vSwitch manually and later delegated the management of the networking to libvirt. OpenStack Neutron integrates with libvirt and automates this process even further by exposing API calls that other services like Nova can utilize.</p>


            </article>

            <footer class="calibre5">
                
            </footer>

        </section>
    

        <section class="calibre1">

            <header class="calibre1">
                </header><h1 class="header-title" id="calibre_pb_0">Getting ready</h1>
            

            <article class="calibre1">
                
<p class="calibre3"><span><span>For this recipe, we are going to need:</span></span></p>
<ul class="calibre16">
<li class="calibre17"><span><span>An Ubuntu server with great virtualization capabilities</span></span></li>
<li class="calibre17"><span><span>Access to the internet for package installation</span></span></li>
<li class="calibre17"><span><span>A database server, a message queue, and</span></span> <kbd class="calibre13">memcached</kbd> <span><span>installed and configured, as described in the</span></span> <em class="calibre22"><span><span>Preparing the host for the OpenStack deployment</span></span></em><span><span> recipe</span></span></li>
<li class="calibre17"><span><span>The Keystone service we deployed in the</span></span> <em class="calibre22"><span><span>Installing and configuring the OpenStack Keystone identity service</span></span></em><span><span> recipe</span></span></li>
<li class="calibre17">The Nova services we configured in the <em class="calibre22">Installing and configuring the OpenStack Nova compute service</em> recipe</li>
</ul>


            </article>

            <footer class="calibre5">
                
            </footer>

        </section>
    

        <section class="calibre1">

            <header class="calibre1">
                </header><h1 class="header-title" id="calibre_pb_0">How to do it...</h1>
            

            <article class="calibre1">
                
<p class="calibre3">To install, configure, and create a network managed by Neutron, execute the following steps:</p>
<ol class="calibre18">
<li value="1" class="calibre17"><span>Create the Neutron database:</span></li>
</ol>
<pre class="calibre25">
<strong class="calibre4">root@controller:~# mysql -u root -plxcpassword</strong><br class="calibre7"/><strong class="calibre4">MariaDB [(none)]&gt; CREATE DATABASE neutron;</strong><br class="calibre7"/><strong class="calibre4">Query OK, 1 row affected (0.00 sec)</strong><br class="calibre7"/><strong class="calibre4">MariaDB [(none)]&gt; GRANT ALL PRIVILEGES ON neutron.* TO 'neutron'@'localhost' IDENTIFIED BY 'lxcpassword';</strong><br class="calibre7"/><strong class="calibre4">Query OK, 0 rows affected (0.00 sec)</strong><br class="calibre7"/><strong class="calibre4">MariaDB [(none)]&gt; GRANT ALL PRIVILEGES ON neutron.* TO 'neutron'@'%' IDENTIFIED BY 'lxcpassword';</strong><br class="calibre7"/><strong class="calibre4">Query OK, 0 rows affected (0.00 sec)</strong><br class="calibre7"/><strong class="calibre4">MariaDB [(none)]&gt; exit</strong><br class="calibre7"/><strong class="calibre4">Bye</strong><br class="calibre7"/><strong class="calibre4">root@controller:~#</strong>
</pre>
<ol start="2" class="calibre18">
<li value="2" class="calibre17">Create the Neutron user and add it to the admin role in Keystone:</li>
</ol>
<pre class="calibre25">
<strong class="calibre4">root@controller:~# openstack user create --domain default --password-prompt neutron</strong><br class="calibre7"/><strong class="calibre4">User Password:</strong><br class="calibre7"/><strong class="calibre4">Repeat User Password:</strong><br class="calibre7"/><strong class="calibre4">+---------------------+----------------------------------+</strong><br class="calibre7"/><strong class="calibre4">| Field               | Value                            |</strong><br class="calibre7"/><strong class="calibre4">+---------------------+----------------------------------+</strong><br class="calibre7"/><strong class="calibre4">| domain_id           | default                          |</strong><br class="calibre7"/><strong class="calibre4">| enabled             | True                             |</strong><br class="calibre7"/><strong class="calibre4">| id                  | 02934ad74c94461482b95fff32d36894 |</strong><br class="calibre7"/><strong class="calibre4">| name                | neutron                          |</strong><br class="calibre7"/><strong class="calibre4">| password_expires_at | None                             |</strong><br class="calibre7"/><strong class="calibre4">+---------------------+----------------------------------+</strong><br class="calibre7"/><strong class="calibre4">root@controller:~# openstack role add --project service --user neutron admin</strong><br class="calibre7"/><strong class="calibre4">root@controller:~#</strong>
</pre>
<ol start="3" class="calibre18">
<li value="3" class="calibre17">Create the Neutron service and endpoints:</li>
</ol>
<pre class="calibre25">
<strong class="calibre4">root@controller:~# openstack service create --name neutron --description "OpenStack Networking" network</strong><br class="calibre7"/><strong class="calibre4">+-------------+----------------------------------+</strong><br class="calibre7"/><strong class="calibre4">| Field       | Value                            |</strong><br class="calibre7"/><strong class="calibre4">+-------------+----------------------------------+</strong><br class="calibre7"/><strong class="calibre4">| description | OpenStack Networking             |</strong><br class="calibre7"/><strong class="calibre4">| enabled     | True                             |</strong><br class="calibre7"/><strong class="calibre4">| id          | 24b32d32d4b54e3ab2d785a1817b8e7e |</strong><br class="calibre7"/><strong class="calibre4">| name        | neutron                          |</strong><br class="calibre7"/><strong class="calibre4">| type        | network                          |</strong><br class="calibre7"/><strong class="calibre4">+-------------+----------------------------------+</strong><br class="calibre7"/><strong class="calibre4">root@controller:~# openstack endpoint create --region RegionOne network public http://controller:9696</strong><br class="calibre7"/><strong class="calibre4">+--------------+----------------------------------+</strong><br class="calibre7"/><strong class="calibre4">| Field        | Value                            |</strong><br class="calibre7"/><strong class="calibre4">+--------------+----------------------------------+</strong><br class="calibre7"/><strong class="calibre4">| enabled      | True                             |</strong><br class="calibre7"/><strong class="calibre4">| id           | 544821d511e04847869fc601f2ebf0f7 |</strong><br class="calibre7"/><strong class="calibre4">| interface    | public                           |</strong><br class="calibre7"/><strong class="calibre4">| region       | RegionOne                        |</strong><br class="calibre7"/><strong class="calibre4">| region_id    | RegionOne                        |</strong><br class="calibre7"/><strong class="calibre4">| service_id   | 24b32d32d4b54e3ab2d785a1817b8e7e |</strong><br class="calibre7"/><strong class="calibre4">| service_name | neutron                          |</strong><br class="calibre7"/><strong class="calibre4">| service_type | network                          |</strong><br class="calibre7"/><strong class="calibre4">| url          | http://controller:9696           |</strong><br class="calibre7"/><strong class="calibre4">+--------------+----------------------------------+</strong><br class="calibre7"/><strong class="calibre4">root@controller:~# openstack endpoint create --region RegionOne network internal http://controller:9696</strong><br class="calibre7"/><strong class="calibre4">+--------------+----------------------------------+</strong><br class="calibre7"/><strong class="calibre4">| Field        | Value                            |</strong><br class="calibre7"/><strong class="calibre4">+--------------+----------------------------------+</strong><br class="calibre7"/><strong class="calibre4">| enabled      | True                             |</strong><br class="calibre7"/><strong class="calibre4">| id           | 05e276ec603f424f85be8705ce7fe86a |</strong><br class="calibre7"/><strong class="calibre4">| interface    | internal                         |</strong><br class="calibre7"/><strong class="calibre4">| region       | RegionOne                        |</strong><br class="calibre7"/><strong class="calibre4">| region_id    | RegionOne                        |</strong><br class="calibre7"/><strong class="calibre4">| service_id   | 24b32d32d4b54e3ab2d785a1817b8e7e |</strong><br class="calibre7"/><strong class="calibre4">| service_name | neutron                          |</strong><br class="calibre7"/><strong class="calibre4">| service_type | network                          |</strong><br class="calibre7"/><strong class="calibre4">| url          | http://controller:9696           |</strong><br class="calibre7"/><strong class="calibre4">+--------------+----------------------------------+</strong><br class="calibre7"/><strong class="calibre4">root@controller:~# openstack endpoint create --region RegionOne network admin http://controller:9696</strong><br class="calibre7"/><strong class="calibre4">+--------------+----------------------------------+</strong><br class="calibre7"/><strong class="calibre4">| Field        | Value                            |</strong><br class="calibre7"/><strong class="calibre4">+--------------+----------------------------------+</strong><br class="calibre7"/><strong class="calibre4">| enabled      | True                             |</strong><br class="calibre7"/><strong class="calibre4">| id           | 836b4309186146fb9143544490cd0bc1 |</strong><br class="calibre7"/><strong class="calibre4">| interface    | admin                            |</strong><br class="calibre7"/><strong class="calibre4">| region       | RegionOne                        |</strong><br class="calibre7"/><strong class="calibre4">| region_id    | RegionOne                        |</strong><br class="calibre7"/><strong class="calibre4">| service_id   | 24b32d32d4b54e3ab2d785a1817b8e7e |</strong><br class="calibre7"/><strong class="calibre4">| service_name | neutron                          |</strong><br class="calibre7"/><strong class="calibre4">| service_type | network                          |</strong><br class="calibre7"/><strong class="calibre4">| url          | http://controller:9696           |</strong><br class="calibre7"/><strong class="calibre4">+--------------+----------------------------------+</strong><br class="calibre7"/><strong class="calibre4">root@controller:~#</strong>
</pre>
<ol start="4" class="calibre18">
<li value="4" class="calibre17">Install the Neutron packages:</li>
</ol>
<pre class="calibre25">
<strong class="calibre4">root@controller:~# apt install neutron-server neutron-plugin-ml2 neutron-linuxbridge-agent neutron-l3-agent neutron-dhcp-agent neutron-metadata-agent</strong><br class="calibre7"/><strong class="calibre4">...</strong><br class="calibre7"/><strong class="calibre4">root@controller:~#</strong>
</pre>
<ol start="5" class="calibre18">
<li value="5" class="calibre17">Create the Neutron configuration file:</li>
</ol>
<pre class="calibre25">
<strong class="calibre4">root@controller:~# cat /etc/neutron/neutron.conf</strong><br class="calibre7"/><strong class="calibre4">[DEFAULT]</strong><br class="calibre7"/><strong class="calibre4">core_plugin = ml2</strong><br class="calibre7"/><strong class="calibre4">service_plugins = router</strong><br class="calibre7"/><strong class="calibre4">allow_overlapping_ips = True</strong><br class="calibre7"/><strong class="calibre4">transport_url = rabbit://openstack:lxcpassword@controller</strong><br class="calibre7"/><strong class="calibre4">auth_strategy = keystone</strong><br class="calibre7"/><strong class="calibre4">notify_nova_on_port_status_changes = True</strong><br class="calibre7"/><strong class="calibre4">notify_nova_on_port_data_changes = True</strong><br class="calibre7"/><br class="calibre7"/><strong class="calibre4">[agent]</strong><br class="calibre7"/><strong class="calibre4">root_helper = sudo /usr/bin/neutron-rootwrap /etc/neutron/rootwrap.conf</strong><br class="calibre7"/><br class="calibre7"/><strong class="calibre4">[cors]</strong><br class="calibre7"/><strong class="calibre4">[cors.subdomain]</strong><br class="calibre7"/><strong class="calibre4">[database]</strong><br class="calibre7"/><strong class="calibre4">connection = mysql+pymysql://neutron:lxcpassword@controller/neutron</strong><br class="calibre7"/><br class="calibre7"/><strong class="calibre4">[keystone_authtoken]</strong><br class="calibre7"/><strong class="calibre4">auth_uri = http://controller:5000</strong><br class="calibre7"/><strong class="calibre4">auth_url = http://controller:35357</strong><br class="calibre7"/><strong class="calibre4">memcached_servers = controller:11211</strong><br class="calibre7"/><strong class="calibre4">auth_type = password</strong><br class="calibre7"/><strong class="calibre4">project_domain_name = default</strong><br class="calibre7"/><strong class="calibre4">user_domain_name = default</strong><br class="calibre7"/><strong class="calibre4">project_name = service</strong><br class="calibre7"/><strong class="calibre4">username = neutron</strong><br class="calibre7"/><strong class="calibre4">password = lxcpassword</strong><br class="calibre7"/><br class="calibre7"/><strong class="calibre4">[matchmaker_redis]</strong><br class="calibre7"/><strong class="calibre4">[nova]</strong><br class="calibre7"/><strong class="calibre4">auth_url = http://controller:35357</strong><br class="calibre7"/><strong class="calibre4">auth_type = password</strong><br class="calibre7"/><strong class="calibre4">project_domain_name = default</strong><br class="calibre7"/><strong class="calibre4">user_domain_name = default</strong><br class="calibre7"/><strong class="calibre4">region_name = RegionOne</strong><br class="calibre7"/><strong class="calibre4">project_name = service</strong><br class="calibre7"/><strong class="calibre4">username = nova</strong><br class="calibre7"/><strong class="calibre4">password = lxcpassword</strong><br class="calibre7"/><br class="calibre7"/><strong class="calibre4">[oslo_concurrency]</strong><br class="calibre7"/><strong class="calibre4">[oslo_messaging_amqp]</strong><br class="calibre7"/><strong class="calibre4">[oslo_messaging_notifications]</strong><br class="calibre7"/><strong class="calibre4">[oslo_messaging_rabbit]</strong><br class="calibre7"/><strong class="calibre4">[oslo_messaging_zmq]</strong><br class="calibre7"/><strong class="calibre4">[oslo_policy]</strong><br class="calibre7"/><strong class="calibre4">[qos]</strong><br class="calibre7"/><strong class="calibre4">[quotas]</strong><br class="calibre7"/><strong class="calibre4">[ssl]</strong><br class="calibre7"/><strong class="calibre4">root@controller:~#</strong>
</pre>
<ol start="6" class="calibre18">
<li value="6" class="calibre17">Define the network type and extensions that we are going to use with Neutron:</li>
</ol>
<pre class="calibre25">
<strong class="calibre4">root@controller:~# cat /etc/neutron/plugins/ml2/ml2_conf.ini</strong><br class="calibre7"/><strong class="calibre4">[DEFAULT]</strong><br class="calibre7"/><strong class="calibre4">[ml2]</strong><br class="calibre7"/><strong class="calibre4">type_drivers = flat,vlan,vxlan</strong><br class="calibre7"/><strong class="calibre4">tenant_network_types = vxlan</strong><br class="calibre7"/><strong class="calibre4">mechanism_drivers = linuxbridge,l2population</strong><br class="calibre7"/><strong class="calibre4">extension_drivers = port_security</strong><br class="calibre7"/><br class="calibre7"/><strong class="calibre4">[ml2_type_flat]</strong><br class="calibre7"/><strong class="calibre4">flat_networks = provider</strong><br class="calibre7"/><br class="calibre7"/><strong class="calibre4">[ml2_type_geneve]</strong><br class="calibre7"/><strong class="calibre4">[ml2_type_gre]</strong><br class="calibre7"/><strong class="calibre4">[ml2_type_vlan]</strong><br class="calibre7"/><strong class="calibre4">[ml2_type_vxlan]</strong><br class="calibre7"/><strong class="calibre4">vni_ranges = 1:1000</strong><br class="calibre7"/><br class="calibre7"/><strong class="calibre4">[securitygroup]</strong><br class="calibre7"/><strong class="calibre4">enable_ipset = True</strong><br class="calibre7"/><strong class="calibre4">root@controller:~#</strong>
</pre>
<ol start="7" class="calibre18">
<li value="7" class="calibre17">Define the interface that will be added to the software bridge and the IP the bridge will be bound to, replacing the IP address and interface name (<kbd class="calibre13">eth1</kbd> in this example) as needed:</li>
</ol>
<pre class="calibre25">
<strong class="calibre4">root@controller:~# cat /etc/neutron/plugins/ml2/linuxbridge_agent.ini</strong><br class="calibre7"/><strong class="calibre4">[DEFAULT]</strong><br class="calibre7"/><strong class="calibre4">[agent]</strong><br class="calibre7"/><strong class="calibre4">[linux_bridge]</strong><br class="calibre7"/><strong class="calibre4">physical_interface_mappings = provider:eth1</strong><br class="calibre7"/><br class="calibre7"/><strong class="calibre4">[securitygroup]</strong><br class="calibre7"/><strong class="calibre4">enable_security_group = True</strong><br class="calibre7"/><strong class="calibre4">firewall_driver = neutron.agent.linux.iptables_firewall.IptablesFirewallDriver</strong><br class="calibre7"/><br class="calibre7"/><strong class="calibre4">[vxlan]</strong><br class="calibre7"/><strong class="calibre4">enable_vxlan = True</strong><br class="calibre7"/><strong class="calibre4">local_ip = 10.208.132.45</strong><br class="calibre7"/><strong class="calibre4">l2_population = True</strong><br class="calibre7"/><strong class="calibre4">root@controller:~#</strong>
</pre>
<ol start="8" class="calibre18">
<li value="8" class="calibre17">Configure the Layer 3 agent as follows:</li>
</ol>
<pre class="calibre25">
<strong class="calibre4">root@controller:~# cat /etc/neutron/l3_agent.ini</strong><br class="calibre7"/><strong class="calibre4">[DEFAULT]</strong><br class="calibre7"/><strong class="calibre4">interface_driver = neutron.agent.linux.interface.BridgeInterfaceDriver</strong><br class="calibre7"/><br class="calibre7"/><strong class="calibre4">[AGENT]</strong><br class="calibre7"/><strong class="calibre4">root@controller:~#</strong>
</pre>
<ol start="9" class="calibre18">
<li value="9" class="calibre17">Configure the DHCP agent:</li>
</ol>
<pre class="calibre25">
<strong class="calibre4">root@controller:~# cat /etc/neutron/dhcp_agent.ini</strong><br class="calibre7"/><strong class="calibre4">[DEFAULT]</strong><br class="calibre7"/><strong class="calibre4">interface_driver = neutron.agent.linux.interface.BridgeInterfaceDriver</strong><br class="calibre7"/><strong class="calibre4">dhcp_driver = neutron.agent.linux.dhcp.Dnsmasq</strong><br class="calibre7"/><strong class="calibre4">enable_isolated_metadata = True</strong><br class="calibre7"/><br class="calibre7"/><strong class="calibre4">[AGENT]</strong><br class="calibre7"/><strong class="calibre4">root@controller:~#</strong>
</pre>
<ol start="10" class="calibre18">
<li value="10" class="calibre17">Create a configuration for the metadata agent:</li>
</ol>
<pre class="calibre25">
<strong class="calibre4">root@controller:~# cat /etc/neutron/metadata_agent.ini<br class="calibre7"/></strong><strong class="calibre4">[DEFAULT]</strong><br class="calibre7"/><strong class="calibre4">nova_metadata_ip = controller</strong><br class="calibre7"/><strong class="calibre4">metadata_proxy_shared_secret = lxcpassword</strong><br class="calibre7"/><br class="calibre7"/><strong class="calibre4">[AGENT]</strong><br class="calibre7"/><strong class="calibre4">[cache]</strong><br class="calibre7"/><strong class="calibre4">root@controller:~#</strong>
</pre>
<ol start="11" class="calibre18">
<li value="11" class="calibre17">Update the configuration file for the Nova services to include Neutron. A completely minimal working example follows to look as the following:</li>
</ol>
<pre class="calibre25">
<strong class="calibre4">root@controller:~# cat /etc/nova/nova.conf</strong><br class="calibre7"/><strong class="calibre4">[DEFAULT]</strong><br class="calibre7"/><strong class="calibre4">dhcpbridge_flagfile=/etc/nova/nova.conf</strong><br class="calibre7"/><strong class="calibre4">dhcpbridge=/usr/bin/nova-dhcpbridge</strong><br class="calibre7"/><strong class="calibre4">log-dir=/var/log/nova</strong><br class="calibre7"/><strong class="calibre4">state_path=/var/lib/nova</strong><br class="calibre7"/><strong class="calibre4">force_dhcp_release=True</strong><br class="calibre7"/><strong class="calibre4">verbose=True</strong><br class="calibre7"/><strong class="calibre4">ec2_private_dns_show_ip=True</strong><br class="calibre7"/><strong class="calibre4">enabled_apis=osapi_compute,metadata</strong><br class="calibre7"/><strong class="calibre4">transport_url = rabbit://openstack:lxcpassword@controller</strong><br class="calibre7"/><strong class="calibre4">auth_strategy = keystone</strong><br class="calibre7"/><strong class="calibre4">my_ip = 10.208.132.45</strong><br class="calibre7"/><strong class="calibre4">use_neutron = True</strong><br class="calibre7"/><strong class="calibre4">firewall_driver = nova.virt.firewall.NoopFirewallDriver</strong><br class="calibre7"/><strong class="calibre4">compute_driver = libvirt.LibvirtDriver</strong><br class="calibre7"/><strong class="calibre4">scheduler_default_filters = RetryFilter, AvailabilityZoneFilter, RamFilter, ComputeFilter, ComputeCapabilitiesFilter, ImagePropertiesFilter, ServerGroupAntiAffinityFilter, ServerGroupAffinityFilter</strong><br class="calibre7"/><br class="calibre7"/><strong class="calibre4">[database]</strong><br class="calibre7"/><strong class="calibre4">connection = mysql+pymysql://nova:lxcpassword@controller/nova</strong><br class="calibre7"/><br class="calibre7"/><strong class="calibre4">[api_database]</strong><br class="calibre7"/><strong class="calibre4">connection = mysql+pymysql://nova:lxcpassword@controller/nova_api</strong><br class="calibre7"/><br class="calibre7"/><strong class="calibre4">[oslo_concurrency]</strong><br class="calibre7"/><strong class="calibre4">lock_path = /var/lib/nova/tmp</strong><br class="calibre7"/><br class="calibre7"/><strong class="calibre4">[libvirt]</strong><br class="calibre7"/><strong class="calibre4">use_virtio_for_bridges=True</strong><br class="calibre7"/><br class="calibre7"/><strong class="calibre4">[wsgi]</strong><br class="calibre7"/><strong class="calibre4">api_paste_config=/etc/nova/api-paste.ini</strong><br class="calibre7"/><br class="calibre7"/><strong class="calibre4">[keystone_authtoken]</strong><br class="calibre7"/><strong class="calibre4">auth_uri = http://controller:5000</strong><br class="calibre7"/><strong class="calibre4">auth_url = http://controller:35357</strong><br class="calibre7"/><strong class="calibre4">memcached_servers = controller:11211</strong><br class="calibre7"/><strong class="calibre4">auth_type = password</strong><br class="calibre7"/><strong class="calibre4">project_domain_name = default</strong><br class="calibre7"/><strong class="calibre4">user_domain_name = default</strong><br class="calibre7"/><strong class="calibre4">project_name = service</strong><br class="calibre7"/><strong class="calibre4">username = nova</strong><br class="calibre7"/><strong class="calibre4">password = lxcpassword</strong><br class="calibre7"/><br class="calibre7"/><strong class="calibre4">[vnc]</strong><br class="calibre7"/><strong class="calibre4">enabled = True</strong><br class="calibre7"/><strong class="calibre4">vncserver_listen = $my_ip</strong><br class="calibre7"/><strong class="calibre4">vncserver_proxyclient_address = $my_ip</strong><br class="calibre7"/><strong class="calibre4">novncproxy_base_url = http://controller:6080/vnc_auto.html</strong><br class="calibre7"/><br class="calibre7"/><strong class="calibre4">[glance]</strong><br class="calibre7"/><strong class="calibre4">api_servers = http://controller:9292</strong><br class="calibre7"/><br class="calibre7"/><strong class="calibre4">[libvirt]</strong><br class="calibre7"/><strong class="calibre4">virt_type = kvm</strong><br class="calibre7"/><br class="calibre7"/><strong class="calibre4">[neutron]</strong><br class="calibre7"/><strong class="calibre4">url = http://controller:9696</strong><br class="calibre7"/><strong class="calibre4">auth_url = http://controller:35357</strong><br class="calibre7"/><strong class="calibre4">auth_type = password</strong><br class="calibre7"/><strong class="calibre4">project_domain_name = default</strong><br class="calibre7"/><strong class="calibre4">user_domain_name = default</strong><br class="calibre7"/><strong class="calibre4">region_name = RegionOne</strong><br class="calibre7"/><strong class="calibre4">project_name = service</strong><br class="calibre7"/><strong class="calibre4">username = neutron</strong><br class="calibre7"/><strong class="calibre4">password = lxcpassword</strong><br class="calibre7"/><strong class="calibre4">service_metadata_proxy = True</strong><br class="calibre7"/><strong class="calibre4">metadata_proxy_shared_secret = lxcpassword</strong><br class="calibre7"/><strong class="calibre4">root@controller:~#</strong>
</pre>
<ol start="12" class="calibre18">
<li value="12" class="calibre17">Populate the Neutron databases:</li>
</ol>
<pre class="calibre25">
<strong class="calibre4">root@controller:~# su -s /bin/sh -c "neutron-db-manage --config-file /etc/neutron/neutron.conf --config-file /etc/neutron/plugins/ml2/ml2_conf.ini upgrade head" neutron</strong><br class="calibre7"/><strong class="calibre4">INFO [alembic.runtime.migration] Context impl MySQLImpl.</strong><br class="calibre7"/><strong class="calibre4">INFO [alembic.runtime.migration] Will assume non-transactional DDL.</strong><br class="calibre7"/><strong class="calibre4"> Running upgrade for neutron ...</strong><br class="calibre7"/><strong class="calibre4">INFO [alembic.runtime.migration] Context impl MySQLImpl.</strong><br class="calibre7"/><strong class="calibre4">INFO [alembic.runtime.migration] Will assume non-transactional DDL.</strong><br class="calibre7"/><strong class="calibre4">INFO [alembic.runtime.migration] Running upgrade -&gt; kilo, kilo_initial</strong><br class="calibre7"/><strong class="calibre4">...</strong><br class="calibre7"/><strong class="calibre4">root@controller:~#</strong>
</pre>
<ol start="13" class="calibre18">
<li value="13" class="calibre17">Restart all Neutron services and Nova:</li>
</ol>
<pre class="calibre25">
<strong class="calibre4">root@controller:~# service neutron-server restart</strong><br class="calibre7"/><strong class="calibre4">root@controller:~# service neutron-linuxbridge-agent restart</strong><br class="calibre7"/><strong class="calibre4">root@controller:~# service neutron-dhcp-agent restart</strong><br class="calibre7"/><strong class="calibre4">root@controller:~# service neutron-metadata-agent restart</strong><br class="calibre7"/><strong class="calibre4">root@controller:~# service neutron-l3-agent restart</strong><br class="calibre7"/><strong class="calibre4">root@controller:~# service nova-api restart</strong><br class="calibre7"/><strong class="calibre4">root@controller:~# service nova-compute restart</strong><br class="calibre7"/><strong class="calibre4">root@controller:~#</strong>
</pre>
<ol start="14" class="calibre18">
<li value="14" class="calibre17">Verify that the Neutron services have been registered:</li>
</ol>
<pre class="calibre25">
<strong class="calibre4">root@controller:~# openstack network agent list</strong><br class="calibre7"/><strong class="calibre4">+--------------------------------------+--------------------+------+-------------------+-------+-------+---------------------------+</strong><br class="calibre7"/><strong class="calibre4">| ID | Agent Type | Host | Availability Zone | Alive | State | Binary |</strong><br class="calibre7"/><strong class="calibre4">+--------------------------------------+--------------------+------+-------------------+-------+-------+---------------------------+</strong><br class="calibre7"/><strong class="calibre4">| 9242d71d-de25-4b3e-8aa8-62691ef72001 | Linux bridge agent | kvm2 | None | True | UP | neutron-linuxbridge-agent |</strong><br class="calibre7"/><strong class="calibre4">| 92b601de-06df-4b10-88c7-8f27bc48f6ab | L3 agent | kvm2 | nova | True | UP | neutron-l3-agent |</strong><br class="calibre7"/><strong class="calibre4">| d249f986-9b26-4c5d-8ea5-311daf3b395d | DHCP agent | kvm2 | nova | True | UP | neutron-dhcp-agent |</strong><br class="calibre7"/><strong class="calibre4">| f3cac79b-a7c3-4672-b846-9268f2d58706 | Metadata agent | kvm2 | None | True | UP | neutron-metadata-agent |</strong><br class="calibre7"/><strong class="calibre4">+--------------------------------------+--------------------+------+-------------------+-------+-------+---------------------------+</strong><br class="calibre7"/><strong class="calibre4">root@controller:~#</strong>
</pre>
<ol start="15" class="calibre18">
<li value="15" class="calibre17">Create a new network:</li>
</ol>
<pre class="calibre25">
<strong class="calibre4">root@controller:~# openstack network create nat</strong><br class="calibre7"/><strong class="calibre4">+---------------------------+--------------------------------------+</strong><br class="calibre7"/><strong class="calibre4">| Field                     | Value                                |</strong><br class="calibre7"/><strong class="calibre4">+---------------------------+--------------------------------------+</strong><br class="calibre7"/><strong class="calibre4">| admin_state_up            | UP                                   |</strong><br class="calibre7"/><strong class="calibre4">| availability_zone_hints   |                                      |</strong><br class="calibre7"/><strong class="calibre4">| availability_zones        |                                      |</strong><br class="calibre7"/><strong class="calibre4">| created_at                | 2017-04-26T18:17:24Z                 |</strong><br class="calibre7"/><strong class="calibre4">| description               |                                      |</strong><br class="calibre7"/><strong class="calibre4">| headers                   |                                      |</strong><br class="calibre7"/><strong class="calibre4">| id                        | b7ccb514-21fc-4ced-b74f-026e7e358bba |</strong><br class="calibre7"/><strong class="calibre4">| ipv4_address_scope        | None                                 |</strong><br class="calibre7"/><strong class="calibre4">| ipv6_address_scope        | None                                 |</strong><br class="calibre7"/><strong class="calibre4">| mtu                       | 1450                                 |</strong><br class="calibre7"/><strong class="calibre4">| name                      | nat                                  |</strong><br class="calibre7"/><strong class="calibre4">| port_security_enabled     | True                                 |</strong><br class="calibre7"/><strong class="calibre4">| project_id                | 123c1e6f33584dd1876c0a34249a6e11     |</strong><br class="calibre7"/><strong class="calibre4">| project_id                | 123c1e6f33584dd1876c0a34249a6e11     |</strong><br class="calibre7"/><strong class="calibre4">| provider:network_type     | vxlan                                |</strong><br class="calibre7"/><strong class="calibre4">| provider:physical_network | None                                 |</strong><br class="calibre7"/><strong class="calibre4">| provider:segmentation_id  | 37                                   |</strong><br class="calibre7"/><strong class="calibre4">| revision_number           | 3                                    |</strong><br class="calibre7"/><strong class="calibre4">| router:external           | Internal                             |</strong><br class="calibre7"/><strong class="calibre4">| shared                    | False                                |</strong><br class="calibre7"/><strong class="calibre4">| status                    | ACTIVE                               |</strong><br class="calibre7"/><strong class="calibre4">| subnets                   |                                      |</strong><br class="calibre7"/><strong class="calibre4">| tags                      | []                                   |</strong><br class="calibre7"/><strong class="calibre4">| updated_at                | 2017-04-26T18:17:24Z                 |</strong><br class="calibre7"/><strong class="calibre4">+---------------------------+--------------------------------------+</strong><br class="calibre7"/><strong class="calibre4">root@controller:~#</strong>
</pre>
<ol start="16" class="calibre18">
<li value="16" class="calibre17">Define the DNS server, the default gateway, and the subnet range that will be assigned to the guests:</li>
</ol>
<pre class="calibre25">
<strong class="calibre4">root@controller:~# openstack subnet create --network nat --dns-nameserver 8.8.8.8 --gateway 192.168.0.1 --subnet-range 192.168.0.0/24 nat</strong><br class="calibre7"/><strong class="calibre4">+-------------------+--------------------------------------+</strong><br class="calibre7"/><strong class="calibre4">| Field             | Value                                |</strong><br class="calibre7"/><strong class="calibre4">+-------------------+--------------------------------------+</strong><br class="calibre7"/><strong class="calibre4">| allocation_pools  | 192.168.0.2-192.168.0.254            |</strong><br class="calibre7"/><strong class="calibre4">| cidr              | 192.168.0.0/24                       |</strong><br class="calibre7"/><strong class="calibre4">| created_at        | 2017-04-26T18:17:41Z                 |</strong><br class="calibre7"/><strong class="calibre4">| description       |                                      |</strong><br class="calibre7"/><strong class="calibre4">| dns_nameservers   | 8.8.8.8                              |</strong><br class="calibre7"/><strong class="calibre4">| enable_dhcp       | True                                 |</strong><br class="calibre7"/><strong class="calibre4">| gateway_ip        | 192.168.0.1                          |</strong><br class="calibre7"/><strong class="calibre4">| headers           |                                      |</strong><br class="calibre7"/><strong class="calibre4">| host_routes       |                                      |</strong><br class="calibre7"/><strong class="calibre4">| id                | 296250a7-f241-4f84-adbb-64a45c943094 |</strong><br class="calibre7"/><strong class="calibre4">| ip_version        | 4                                    |</strong><br class="calibre7"/><strong class="calibre4">| ipv6_address_mode | None                                 |</strong><br class="calibre7"/><strong class="calibre4">| ipv6_ra_mode      | None                                 |</strong><br class="calibre7"/><strong class="calibre4">| name              | nat                                  |</strong><br class="calibre7"/><strong class="calibre4">| network_id        | b7ccb514-21fc-4ced-b74f-026e7e358bba |</strong><br class="calibre7"/><strong class="calibre4">| project_id        | 123c1e6f33584dd1876c0a34249a6e11     |</strong><br class="calibre7"/><strong class="calibre4">| project_id        | 123c1e6f33584dd1876c0a34249a6e11     |</strong><br class="calibre7"/><strong class="calibre4">| revision_number   | 2                                    |</strong><br class="calibre7"/><strong class="calibre4">| service_types     | []                                   |</strong><br class="calibre7"/><strong class="calibre4">| subnetpool_id     | None                                 |</strong><br class="calibre7"/><strong class="calibre4">| updated_at        | 2017-04-26T18:17:41Z                 |</strong><br class="calibre7"/><strong class="calibre4">+-------------------+--------------------------------------+</strong><br class="calibre7"/><strong class="calibre4">root@controller:~#</strong>
</pre>
<ol start="17" class="calibre18">
<li value="17" class="calibre17">Update the subnet information in Neutron:</li>
</ol>
<pre class="calibre25">
<strong class="calibre4">root@controller:~# neutron net-update nat --router:external</strong><br class="calibre7"/><strong class="calibre4">Updated network: nat</strong><br class="calibre7"/><strong class="calibre4">root@controller:~#</strong>
</pre>
<ol start="18" class="calibre18">
<li value="18" class="calibre17">Create a new software router:</li>
</ol>
<pre class="calibre25">
<strong class="calibre4">root@controller:~# openstack router create router</strong><br class="calibre7"/><br class="calibre7"/><strong class="calibre4">+-------------------------+--------------------------------------+</strong><br class="calibre7"/><strong class="calibre4">| Field                   | Value                                |</strong><br class="calibre7"/><strong class="calibre4">+-------------------------+--------------------------------------+</strong><br class="calibre7"/><strong class="calibre4">| admin_state_up          | UP                                   |</strong><br class="calibre7"/><strong class="calibre4">| availability_zone_hints |                                      |</strong><br class="calibre7"/><strong class="calibre4">| availability_zones      |                                      |</strong><br class="calibre7"/><strong class="calibre4">| created_at              | 2017-04-26T18:18:05Z                 |</strong><br class="calibre7"/><strong class="calibre4">| description             |                                      |</strong><br class="calibre7"/><strong class="calibre4">| external_gateway_info   | null                                 |</strong><br class="calibre7"/><strong class="calibre4">| flavor_id               | None                                 |</strong><br class="calibre7"/><strong class="calibre4">| headers                 |                                      |</strong><br class="calibre7"/><strong class="calibre4">| id                      | f9cd8c96-a53c-4585-ad21-0e409f3b4d70 |</strong><br class="calibre7"/><strong class="calibre4">| name                    | router                               |</strong><br class="calibre7"/><strong class="calibre4">| project_id              | 10a92eccbad9439d9e56c4edda6b211f     |</strong><br class="calibre7"/><strong class="calibre4">| project_id              | 10a92eccbad9439d9e56c4edda6b211f     |</strong><br class="calibre7"/><strong class="calibre4">| revision_number         | 3                                    |</strong><br class="calibre7"/><strong class="calibre4">| routes                  |                                      |</strong><br class="calibre7"/><strong class="calibre4">| status                  | ACTIVE                               |</strong><br class="calibre7"/><strong class="calibre4">| updated_at              | 2017-04-26T18:18:05Z                 |</strong><br class="calibre7"/><strong class="calibre4">+-------------------------+--------------------------------------+</strong><br class="calibre7"/><strong class="calibre4">root@controller:~#</strong>
</pre>
<ol start="19" class="calibre18">
<li value="19" class="calibre17">As the admin user, add the subnet we created earlier to the router as an interface:</li>
</ol>
<pre class="calibre25">
<strong class="calibre4">root@controller:~# . rc.admin</strong><br class="calibre7"/><strong class="calibre4">root@controller:~# neutron router-interface-add router nat</strong><br class="calibre7"/><strong class="calibre4">Added interface 2e1e2fd3-1819-489b-a21f-7005862f9de7 to router router.</strong><br class="calibre7"/><strong class="calibre4">root@controller:~#</strong>
</pre>
<ol start="20" class="calibre18">
<li value="20" class="calibre17">List the network namespaces that Neutron created:</li>
</ol>
<pre class="calibre25">
<strong class="calibre4">root@controller:~# ip netns</strong><br class="calibre7"/><strong class="calibre4">qrouter-f9cd8c96-a53c-4585-ad21-0e409f3b4d70</strong><br class="calibre7"/><strong class="calibre4">qdhcp-b7ccb514-21fc-4ced-b74f-026e7e358bba</strong><br class="calibre7"/><strong class="calibre4">root@controller:~#</strong>
</pre>
<ol start="21" class="calibre18">
<li value="21" class="calibre17">List the ports on the software router:</li>
</ol>
<pre class="calibre25">
<strong class="calibre4">root@controller:~# neutron router-port-list router</strong><br class="calibre7"/><strong class="calibre4">+--------------------------------------+------+-------------------+------------------------------------------------------------------------------------+</strong><br class="calibre7"/><strong class="calibre4">| id | name | mac_address | fixed_ips |</strong><br class="calibre7"/><strong class="calibre4">+--------------------------------------+------+-------------------+------------------------------------------------------------------------------------+</strong><br class="calibre7"/><strong class="calibre4">| 2e1e2fd3-1819-489b-a21f-7005862f9de7 | | fa:16:3e:0e:db:14 | {"subnet_id": "296250a7-f241-4f84-adbb-64a45c943094", "ip_address": "192.168.0.1"} |</strong><br class="calibre7"/><strong class="calibre4">+--------------------------------------+------+-------------------+------------------------------------------------------------------------------------+</strong><br class="calibre7"/><strong class="calibre4">root@controller:~#</strong>
</pre>
<ol start="22" class="calibre18">
<li value="22" class="calibre17">List the Neutron networks and ensure that the one we created earlier is present:</li>
</ol>
<pre class="calibre25">
<strong class="calibre4">root@controller:~# openstack network list</strong><br class="calibre7"/><strong class="calibre4">+--------------------------------------+------+--------------------------------------+</strong><br class="calibre7"/><strong class="calibre4">| ID                                   | Name | Subnets                              |</strong><br class="calibre7"/><strong class="calibre4">+--------------------------------------+------+--------------------------------------+</strong><br class="calibre7"/><strong class="calibre4">| b7ccb514-21fc-4ced-b74f-026e7e358bba | nat  | 296250a7-f241-4f84-adbb-64a45c943094 |</strong><br class="calibre7"/><strong class="calibre4">+--------------------------------------+------+--------------------------------------+</strong><br class="calibre7"/><strong class="calibre4">root@controller:~#</strong>
</pre>


            </article>

            <footer class="calibre5">
                
            </footer>

        </section>
    

        <section class="calibre1">

            <header class="calibre1">
                </header><h1 class="header-title" id="calibre_pb_0">How it works...</h1>
            

            <article class="calibre1">
                
<p class="calibre3">We start this recipe by creating a new database for Neutron in step 1. We then proceed to create the user for the Neutron service  and add it to the admin role for the service. In steps 2 and 3, we define the service endpoints that will be exposed for Nova to use. In steps 4 and 5, we install the Neutron packages and create a basic configuration file. In step 6, we select the VXLAN type of networking for this example deployment. In steps 7, 8, 9, and 10, we configure the bridge agent, the layer 3 agent, the DHCP agent, and the metadata agent.</p>
<p class="calibre3">In step 11, we update the Nova configuration file to contain a section about the Neutron service. In step 12, we create the database schema and restart all Neutron services in step 13, including <kbd class="calibre13">nova-api</kbd> and <kbd class="calibre13">nova-compute</kbd>.</p>
<p class="calibre3">In step 14, we verify that the Neutron services have been registered and proceed to create a new network in step 15.</p>
<p class="calibre3">In step 18, we define a new software router. We add the subnet we created earlier to it in step 19, then verify the new route configuration in step 21.</p>
<p class="calibre3">The last step 22 ensures that the network we defined earlier is active.</p>


            </article>

            <footer class="calibre5">
                
            </footer>

        </section>
    

        <section class="calibre1">

            <header class="calibre1">
                </header><h1 class="header-title" id="calibre_pb_0">Building and inspecting KVM instances with OpenStack</h1>
            

            <article class="calibre1">
                
<p class="calibre3">In this recipe, we are going to build our first KVM instance using the OpenStack infrastructure we put in place in the previous recipes. Building a new KVM instance consists of the following steps:</p>
<ol class="calibre18">
<li value="1" class="calibre17">We send an API call to the <kbd class="calibre13">nova-api</kbd> service.</li>
<li value="2" class="calibre17">The <kbd class="calibre13">nova-api</kbd> service requests a target compute host from the nova-scheduler service.</li>
<li value="3" class="calibre17"><kbd class="calibre13">nova-scheduler</kbd> picks an available compute host, based on the configured filters, such as available memory, disk, and CPU utilization.</li>
<li value="4" class="calibre17">Once the <kbd class="calibre13">nova-scheduler</kbd> selects an appropriate host, the <kbd class="calibre13">nova-compute</kbd> service on the selected host, requests the image from the Glance repository, if not already cached locally. Once the image is on the new server, <kbd class="calibre13">nova-compute</kbd> builds the new KVM instance.</li>
</ol>


            </article>

            <footer class="calibre5">
                
            </footer>

        </section>
    

        <section class="calibre1">

            <header class="calibre1">
                </header><h1 class="header-title" id="calibre_pb_0">Getting ready</h1>
            

            <article class="calibre1">
                
<p class="calibre3"><span><span>For this recipe, we are going to need the following things:</span></span></p>
<ul class="calibre16">
<li class="calibre17">A database server, a message queue, and <kbd class="calibre13">memcached</kbd> installed and configured, as described in the <em class="calibre22">Preparing the host for the OpenStack deployment</em> recipe.</li>
<li class="calibre17">The Glance service with an available image. For more information on how to deploy Glance and add a new image, refer to the <em class="calibre22">Installing and configuring the OpenStack Glance image service</em> recipe.</li>
<li class="calibre17">The Keystone service we deployed in the <em class="calibre22">Installing and configuring the OpenStack Keystone identity service</em> recipe.</li>
<li class="calibre17">The Nova services we configured in the <em class="calibre22">Installing and configuring the OpenStack Nova compute service</em> recipe.</li>
<li class="calibre17">The Neutron service that was deployed in the <em class="calibre22">Installing and configuring the OpenStack Neutron networking service</em> recipe.</li>
</ul>


            </article>

            <footer class="calibre5">
                
            </footer>

        </section>
    

        <section class="calibre1">

            <header class="calibre1">
                </header><h1 class="header-title" id="calibre_pb_0">How to do it...</h1>
            

            <article class="calibre1">
                
<p class="calibre3">To build a new KVM instance using the OpenStack <strong class="calibre4">command-line interface</strong> (<strong class="calibre4">CLI</strong>), perform the following steps:</p>
<ol class="calibre18">
<li value="1" class="calibre17"><span>Ensure that we have an available Glance image to use:</span></li>
</ol>
<pre class="calibre25">
<strong class="calibre4">root@controller:~# openstack image list</strong><br class="calibre7"/><strong class="calibre4">+--------------------------------------+--------------+--------+</strong><br class="calibre7"/><strong class="calibre4">| ID                                   | Name         | Status |</strong><br class="calibre7"/><strong class="calibre4">+--------------------------------------+--------------+--------+</strong><br class="calibre7"/><strong class="calibre4">| abce08d2-2f9f-4545-a414-32019d41c0cd | ubuntu_16.04 | active |</strong><br class="calibre7"/><strong class="calibre4">+--------------------------------------+--------------+--------+</strong><br class="calibre7"/><strong class="calibre4">root@controller:~#</strong>
</pre>
<ol start="2" class="calibre18">
<li value="2" class="calibre17">Create a new instance flavor type:</li>
</ol>
<pre class="calibre25">
<strong class="calibre4">root@controller:~# openstack flavor create --id 0 --vcpus 1 --ram 1024 --disk 5000 kvm.medium</strong><br class="calibre7"/><strong class="calibre4">+----------------------------+------------+</strong><br class="calibre7"/><strong class="calibre4">| Field                      | Value      |</strong><br class="calibre7"/><strong class="calibre4">+----------------------------+------------+</strong><br class="calibre7"/><strong class="calibre4">| OS-FLV-DISABLED:disabled   | False      |</strong><br class="calibre7"/><strong class="calibre4">| OS-FLV-EXT-DATA:ephemeral  | 0          |</strong><br class="calibre7"/><strong class="calibre4">| disk                       | 5000       |</strong><br class="calibre7"/><strong class="calibre4">| id                         | 0          |</strong><br class="calibre7"/><strong class="calibre4">| name                       | kvm.medium |</strong><br class="calibre7"/><strong class="calibre4">| os-flavor-access:is_public | True       |</strong><br class="calibre7"/><strong class="calibre4">| properties                 |            |</strong><br class="calibre7"/><strong class="calibre4">| ram                        | 1024       |</strong><br class="calibre7"/><strong class="calibre4">| rxtx_factor                | 1.0        |</strong><br class="calibre7"/><strong class="calibre4">| swap                       |            |</strong><br class="calibre7"/><strong class="calibre4">| vcpus                      | 1          |</strong><br class="calibre7"/><strong class="calibre4">+----------------------------+------------+</strong><br class="calibre7"/><strong class="calibre4">root@controller:~#</strong><br class="calibre7"/><strong class="calibre4">root@controller:~# openstack flavor list</strong><br class="calibre7"/><strong class="calibre4">+----+------------+------+------+-----------+-------+-----------+</strong><br class="calibre7"/><strong class="calibre4">| ID | Name       | RAM  | Disk | Ephemeral | VCPUs | Is Public |</strong><br class="calibre7"/><strong class="calibre4">+----+------------+------+------+-----------+-------+-----------+</strong><br class="calibre7"/><strong class="calibre4">| 0 | kvm.medium  | 1024 | 5000 | 0         | 1     | True      |</strong><br class="calibre7"/><strong class="calibre4">+----+------------+------+------+-----------+-------+-----------+</strong><br class="calibre7"/><strong class="calibre4">root@controller:~#</strong>
</pre>
<ol start="3" class="calibre18">
<li value="3" class="calibre17">Create a new SSH key-pair:</li>
</ol>
<pre class="calibre25">
<strong class="calibre4">root@controller:~# openstack keypair create --public-key ~/.ssh/kvm_rsa.pub kvmkey</strong><br class="calibre7"/><strong class="calibre4">+-------------+-------------------------------------------------+</strong><br class="calibre7"/><strong class="calibre4">| Field       | Value                                           |</strong><br class="calibre7"/><strong class="calibre4">+-------------+-------------------------------------------------+</strong><br class="calibre7"/><strong class="calibre4">| fingerprint | e9:7e:e6:05:8b:a4:31:c3:5e:41:65:0e:29:23:eb:2a |</strong><br class="calibre7"/><strong class="calibre4">| name        | kvmkey                                          |</strong><br class="calibre7"/><strong class="calibre4">| user_id     | cc14c5dbbd654c438e52d38efaf4f1a6                |</strong><br class="calibre7"/><strong class="calibre4">+-------------+-------------------------------------------------+</strong><br class="calibre7"/><strong class="calibre4">root@controller:~# openstack keypair list</strong><br class="calibre7"/><strong class="calibre4">+--------+-------------------------------------------------+</strong><br class="calibre7"/><strong class="calibre4">| Name   | Fingerprint                                     |</strong><br class="calibre7"/><strong class="calibre4">+--------+-------------------------------------------------+</strong><br class="calibre7"/><strong class="calibre4">| kvmkey | e9:7e:e6:05:8b:a4:31:c3:5e:41:65:0e:29:23:eb:2a |</strong><br class="calibre7"/><strong class="calibre4">+--------+-------------------------------------------------+</strong><br class="calibre7"/><strong class="calibre4">root@controller:~#</strong>
</pre>
<ol start="4" class="calibre18">
<li value="4" class="calibre17">Define the security group rules that allow SSH and ICMP access:</li>
</ol>
<pre class="calibre25">
<strong class="calibre4">root@controller:~# openstack security group rule create --proto icmp default</strong><br class="calibre7"/><br class="calibre7"/><strong class="calibre4">+-------------------+--------------------------------------+</strong><br class="calibre7"/><strong class="calibre4">| Field             | Value                                |</strong><br class="calibre7"/><strong class="calibre4">+-------------------+--------------------------------------+</strong><br class="calibre7"/><strong class="calibre4">| created_at        | 2017-04-26T18:17:13Z                 |</strong><br class="calibre7"/><strong class="calibre4">| description       |                                      |</strong><br class="calibre7"/><strong class="calibre4">| direction         | ingress                              |</strong><br class="calibre7"/><strong class="calibre4">| ethertype         | IPv4                                 |</strong><br class="calibre7"/><strong class="calibre4">| headers           |                                      |</strong><br class="calibre7"/><strong class="calibre4">| id                | ca28501a-1b3b-448f-8c1b-0fa6f9fa9263 |</strong><br class="calibre7"/><strong class="calibre4">| port_range_max    | None                                 |</strong><br class="calibre7"/><strong class="calibre4">| port_range_min    | None                                 |</strong><br class="calibre7"/><strong class="calibre4">| project_id        | 123c1e6f33584dd1876c0a34249a6e11     |</strong><br class="calibre7"/><strong class="calibre4">| project_id        | 123c1e6f33584dd1876c0a34249a6e11     |</strong><br class="calibre7"/><strong class="calibre4">| protocol          | icmp                                 |</strong><br class="calibre7"/><strong class="calibre4">| remote_group_id   | None                                 |</strong><br class="calibre7"/><strong class="calibre4">| remote_ip_prefix  | 0.0.0.0/0                            |</strong><br class="calibre7"/><strong class="calibre4">| revision_number   | 1                                    |</strong><br class="calibre7"/><strong class="calibre4">| security_group_id | 050b8174-d961-4706-ab63-1cdd2a25fbdd |</strong><br class="calibre7"/><strong class="calibre4">| updated_at        | 2017-04-26T18:17:13Z                 |</strong><br class="calibre7"/><strong class="calibre4">+-------------------+--------------------------------------+</strong><br class="calibre7"/><strong class="calibre4">root@controller:~#</strong><br class="calibre7"/><strong class="calibre4">root@controller:~# openstack security group rule create --proto tcp --dst-port 22 default</strong><br class="calibre7"/><br class="calibre7"/><strong class="calibre4">+-------------------+--------------------------------------+</strong><br class="calibre7"/><strong class="calibre4">| Field             | Value                                |</strong><br class="calibre7"/><strong class="calibre4">+-------------------+--------------------------------------+</strong><br class="calibre7"/><strong class="calibre4">| created_at        | 2017-04-26T18:17:18Z                 |</strong><br class="calibre7"/><strong class="calibre4">| description       |                                      |</strong><br class="calibre7"/><strong class="calibre4">| direction         | ingress                              |</strong><br class="calibre7"/><strong class="calibre4">| ethertype         | IPv4                                 |</strong><br class="calibre7"/><strong class="calibre4">| headers           |                                      |</strong><br class="calibre7"/><strong class="calibre4">| id                | 334130c3-42b2-4f1b-aba6-c46e91ad203e |</strong><br class="calibre7"/><strong class="calibre4">| port_range_max    | 22                                   |</strong><br class="calibre7"/><strong class="calibre4">| port_range_min    | 22                                   |</strong><br class="calibre7"/><strong class="calibre4">| project_id        | 123c1e6f33584dd1876c0a34249a6e11     |</strong><br class="calibre7"/><strong class="calibre4">| project_id        | 123c1e6f33584dd1876c0a34249a6e11     |</strong><br class="calibre7"/><strong class="calibre4">| protocol          | tcp                                  |</strong><br class="calibre7"/><strong class="calibre4">| remote_group_id   | None                                 |</strong><br class="calibre7"/><strong class="calibre4">| remote_ip_prefix  | 0.0.0.0/0                            |</strong><br class="calibre7"/><strong class="calibre4">| revision_number   | 1                                    |</strong><br class="calibre7"/><strong class="calibre4">| security_group_id | 050b8174-d961-4706-ab63-1cdd2a25fbdd |</strong><br class="calibre7"/><strong class="calibre4">| updated_at        | 2017-04-26T18:17:18Z                 |</strong><br class="calibre7"/><strong class="calibre4">+-------------------+--------------------------------------+</strong><br class="calibre7"/><strong class="calibre4">root@controller:~#</strong>
</pre>
<ol start="5" class="calibre18">
<li value="5" class="calibre17">List the available networks, we defined earlier:</li>
</ol>
<pre class="calibre25">
<strong class="calibre4"><span><span>root@controller:~# openstack network list</span></span></strong><br class="calibre7"/><strong class="calibre4"><span><span>+--------------------------------------+------+--------------------------------------+</span></span></strong><br class="calibre7"/><strong class="calibre4"><span><span>| ID                                   | Name | Subnets                              |</span></span></strong><br class="calibre7"/><strong class="calibre4"><span><span>+--------------------------------------+------+--------------------------------------+</span></span></strong><br class="calibre7"/><strong class="calibre4"><span><span>| b7ccb514-21fc-4ced-b74f-026e7e358bba | nat  | 296250a7-f241-4f84-adbb-64a45c943094 |</span></span></strong><br class="calibre7"/><strong class="calibre4"><span><span>+--------------------------------------+------+--------------------------------------+</span></span></strong><br class="calibre7"/><strong class="calibre4"><span><span>root@controller:~#</span></span></strong>
</pre>
<ol start="6" class="calibre18">
<li value="6" class="calibre17">Build a new KVM instance and list its status:</li>
</ol>
<pre class="calibre25">
<strong class="calibre4">root@controller:~# openstack server create --flavor kvm.medium --image ubuntu_16.04 --nic net-id=b7ccb514-21fc-4ced-b74f-026e7e358bba --security-group default --key-name kvmkey ubuntu_instance</strong><br class="calibre7"/><strong class="calibre4">+--------------------------------------+-------------------------------------------+</strong><br class="calibre7"/><strong class="calibre4">| Field                                | Value                                     |</strong><br class="calibre7"/><strong class="calibre4">+--------------------------------------+-------------------------------------------+</strong><br class="calibre7"/><strong class="calibre4">| OS-DCF:diskConfig                    | MANUAL                                    |</strong><br class="calibre7"/><strong class="calibre4">| OS-EXT-AZ:availability_zone          |                                           |</strong><br class="calibre7"/><strong class="calibre4">| OS-EXT-SRV-ATTR:host                 | None                                      |</strong><br class="calibre7"/><strong class="calibre4">| OS-EXT-SRV-ATTR:hypervisor_hostname  | None                                      |</strong><br class="calibre7"/><strong class="calibre4">| OS-EXT-SRV-ATTR:instance_name        |                                           |</strong><br class="calibre7"/><strong class="calibre4">| OS-EXT-STS:power_state               | NOSTATE                                   |</strong><br class="calibre7"/><strong class="calibre4">| OS-EXT-STS:task_state                | scheduling                                |</strong><br class="calibre7"/><strong class="calibre4">| OS-EXT-STS:vm_state                  | building                                  |</strong><br class="calibre7"/><strong class="calibre4">| OS-SRV-USG:launched_at               | None                                      |</strong><br class="calibre7"/><strong class="calibre4">| OS-SRV-USG:terminated_at             | None                                      |</strong><br class="calibre7"/><strong class="calibre4">| accessIPv4                           |                                           |</strong><br class="calibre7"/><strong class="calibre4">| accessIPv6                           |                                           |</strong><br class="calibre7"/><strong class="calibre4">| addresses                            |                                           |</strong><br class="calibre7"/><strong class="calibre4">| adminPass                            | Z23yEuDLBjLe                              |</strong><br class="calibre7"/><strong class="calibre4">| config_drive                         |                                           |</strong><br class="calibre7"/><strong class="calibre4">| created                              | 2017-04-26T19:11:23Z                      |</strong><br class="calibre7"/><strong class="calibre4">| flavor                               | kvm.medium (0)                            |</strong><br class="calibre7"/><strong class="calibre4">| hostId                               |                                           |</strong><br class="calibre7"/><strong class="calibre4">| id                                   | 0f4745b1-9d4b-4e8a-82f7-9eaa1f9bb08f      |</strong><br class="calibre7"/><strong class="calibre4">| image                                | ubuntu_16.04 (abce08d2-a414-32019d41c0cd) |</strong><br class="calibre7"/><strong class="calibre4">| key_name                             | kvmkey                                    |</strong><br class="calibre7"/><strong class="calibre4">| name                                 | ubuntu_instance                           |</strong><br class="calibre7"/><strong class="calibre4">| os-extended-volumes:volumes_attached | []                                        |</strong><br class="calibre7"/><strong class="calibre4">| progress                             | 0                                         |</strong><br class="calibre7"/><strong class="calibre4">| project_id                           | 123c1e6f33584dd1876c0a34249a6e11          |</strong><br class="calibre7"/><strong class="calibre4">| properties                           |                                           |</strong><br class="calibre7"/><strong class="calibre4">| security_groups                      | [{u'name': u'default'}]                   |</strong><br class="calibre7"/><strong class="calibre4">| status                               | BUILD                                     |</strong><br class="calibre7"/><strong class="calibre4">| updated                              | 2017-04-26T19:11:23Z                      |</strong><br class="calibre7"/><strong class="calibre4">| user_id                              | cc14c5dbbd654c438e52d38efaf4f1a6          |</strong><br class="calibre7"/><strong class="calibre4">+--------------------------------------+-------------------------------------------+</strong><br class="calibre7"/><strong class="calibre4">root@controller:~# openstack server list</strong><br class="calibre7"/><strong class="calibre4">+---------------------+-----------------+---------+------------------+--------------+</strong><br class="calibre7"/><strong class="calibre4">| ID                  | Name            | Status  | Networks         | Image Name   |</strong><br class="calibre7"/><strong class="calibre4">+---------------------+-----------------+---------+------------------+--------------+</strong><br class="calibre7"/><strong class="calibre4">| 0f4745b1-...-9bb08f | ubuntu_instance | BUILD   | nat=192.168.0.11 | ubuntu_16.04 |</strong><br class="calibre7"/><strong class="calibre4">+---------------------+-----------------+---------+------------------+--------------+</strong><br class="calibre7"/><strong class="calibre4">root@controller:~#</strong>
</pre>
<ol start="7" class="calibre18">
<li value="7" class="calibre17">Ensure that the container was started successfully:</li>
</ol>
<pre class="calibre25">
<strong class="calibre4">root@controller:~# pgrep -lfa qemu</strong><br class="calibre7"/><strong class="calibre4">23388 /usr/bin/qemu-system-x86_64 -name instance-00000005 -S -machine pc-i440fx-xenial,accel=kvm,usb=off -cpu Haswell-noTSX,+abm,+pdpe1gb,+rdrand,+f16c,+osxsave,+dca,+pdcm,+xtpr,+tm2,+est,+smx,+vmx,+ds_cpl,+monitor,+dtes64,+pbe,+tm,+ht,+ss,+acpi,+ds,+vme -m 1024 -realtime mlock=off -smp 1,sockets=1,cores=1,threads=1 -uuid 0f4745b1-9d4b-4e8a-82f7-9eaa1f9bb08f -smbios type=1,manufacturer=OpenStack Foundation,product=OpenStack Nova,version=14.0.4,serial=6d6366d9-4569-6233-dad6-4927587cc79f,uuid=0f4745b1-9d4b-4e8a-82f7-9eaa1f9bb08f,family=Virtual Machine -no-user-config -nodefaults -chardev socket,id=charmonitor,path=/var/lib/libvirt/qemu/domain-instance-00000005/monitor.sock,server,nowait -mon chardev=charmonitor,id=monitor,mode=control -rtc base=utc,driftfix=slew -global kvm-pit.lost_tick_policy=discard -no-hpet -no-shutdown -boot strict=on -device piix3-usb-uhci,id=usb,bus=pci.0,addr=0x1.0x2 -drive file=/var/lib/nova/instances/0f4745b1-9d4b-4e8a-82f7-9eaa1f9bb08f/disk,format=qcow2,if=none,id=drive-virtio-disk0,cache=none -device virtio-blk-pci,scsi=off,bus=pci.0,addr=0x4,drive=drive-virtio-disk0,id=virtio-disk0,bootindex=1 -netdev tap,fd=26,id=hostnet0,vhost=on,vhostfd=28 -device virtio-net-pci,netdev=hostnet0,id=net0,mac=fa:16:3e:3c:c0:0f,bus=pci.0,addr=0x3 -chardev file,id=charserial0,path=/var/lib/nova/instances/0f4745b1-9d4b-4e8a-82f7-9eaa1f9bb08f/console.log -device isa-serial,chardev=charserial0,id=serial0 -chardev pty,id=charserial1 -device isa-serial,chardev=charserial1,id=serial1 -device usb-tablet,id=input0 -vnc 0.0.0.0:0 -k en-us -device cirrus-vga,id=video0,bus=pci.0,addr=0x2 -device virtio-balloon-pci,id=balloon0,bus=pci.0,addr=0x5 -msg timestamp=on</strong><br class="calibre7"/><strong class="calibre4">root@controller:~# openstack server list</strong><br class="calibre7"/><strong class="calibre4">+---------------------------+-----------------+--------+------------------+--------------+</strong><br class="calibre7"/><strong class="calibre4">| ID                        | Name            | Status | Networks         | Image Name   |</strong><br class="calibre7"/><strong class="calibre4">+---------------------------+-----------------+--------+------------------+--------------+</strong><br class="calibre7"/><strong class="calibre4">| 0f4745b1-...-9eaa1f9bb08f | ubuntu_instance | ACTIVE | nat=192.168.0.11 | ubuntu_16.04 |</strong><br class="calibre7"/><strong class="calibre4">+---------------------------+-----------------+--------+------------------+--------------+</strong><br class="calibre7"/><strong class="calibre4">root@controller:~#</strong>
</pre>
<ol start="8" class="calibre18">
<li value="8" class="calibre17">Inspect the KVM instance:</li>
</ol>
<pre class="calibre25">
<strong class="calibre4">root@controller:~# openstack server show ubuntu_instance</strong><br class="calibre7"/><strong class="calibre4">+--------------------------------------+-------------------------------------------+</strong><br class="calibre7"/><strong class="calibre4">| Field                                | Value                                     |</strong><br class="calibre7"/><strong class="calibre4">+--------------------------------------+-------------------------------------------+</strong><br class="calibre7"/><strong class="calibre4">| OS-DCF:diskConfig                    | MANUAL                                    |</strong><br class="calibre7"/><strong class="calibre4">| OS-EXT-AZ:availability_zone          | nova                                      |</strong><br class="calibre7"/><strong class="calibre4">| OS-EXT-SRV-ATTR:host                 | controller                                |</strong><br class="calibre7"/><strong class="calibre4">| OS-EXT-SRV-ATTR:hypervisor_hostname  | controller                                |</strong><br class="calibre7"/><strong class="calibre4">| OS-EXT-SRV-ATTR:instance_name        | instance-00000001                         |</strong><br class="calibre7"/><strong class="calibre4">| OS-EXT-STS:power_state               | Running                                   |</strong><br class="calibre7"/><strong class="calibre4">| OS-EXT-STS:task_state                | None                                      |</strong><br class="calibre7"/><strong class="calibre4">| OS-EXT-STS:vm_state                  | active                                    |</strong><br class="calibre7"/><strong class="calibre4">| OS-SRV-USG:launched_at               | 2017-04-26T19:11:37.000000                |</strong><br class="calibre7"/><strong class="calibre4">| OS-SRV-USG:terminated_at             | None                                      |</strong><br class="calibre7"/><strong class="calibre4">| accessIPv4                           |                                           |</strong><br class="calibre7"/><strong class="calibre4">| accessIPv6                           |                                           |</strong><br class="calibre7"/><strong class="calibre4">| addresses                            | nat=192.168.0.11                          |</strong><br class="calibre7"/><strong class="calibre4">| config_drive                         |                                           |</strong><br class="calibre7"/><strong class="calibre4">| created                              | 2017-04-26T19:11:23Z                      |</strong><br class="calibre7"/><strong class="calibre4">| flavor                               | kvm.medium (0)                            |</strong><br class="calibre7"/><strong class="calibre4">| hostId                               | c8d0t2jgdlkasdjg0iu4kjdg3o43045t          |</strong><br class="calibre7"/><strong class="calibre4">| id                                   | 0f4745b1-9d4b-4e8a-82f7-9eaa1f9bb08f      |</strong><br class="calibre7"/><strong class="calibre4">| image                                | ubuntu_16.04 (abce08d2-a414-32019d41c0cd) |</strong><br class="calibre7"/><strong class="calibre4">| key_name                             | kvmkey                                    |</strong><br class="calibre7"/><strong class="calibre4">| name                                 | ubuntu_instance                           |</strong><br class="calibre7"/><strong class="calibre4">| os-extended-volumes:volumes_attached | []                                        |</strong><br class="calibre7"/><strong class="calibre4">| progress                             | 0                                         |</strong><br class="calibre7"/><strong class="calibre4">| project_id                           | 123c1e6f33584dd1876c0a34249a6e11          |</strong><br class="calibre7"/><strong class="calibre4">| properties                           |                                           |</strong><br class="calibre7"/><strong class="calibre4">| security_groups                      | [{u'name': u'default'}]                   |</strong><br class="calibre7"/><strong class="calibre4">| status                               | ACTIVE                                    |</strong><br class="calibre7"/><strong class="calibre4">| updated                              | 2017-04-26T19:11:23Z                      |</strong><br class="calibre7"/><strong class="calibre4">| user_id                              | cc14c5dbbd654c438e52d38efaf4f1a6          |</strong><br class="calibre7"/><strong class="calibre4">+--------------------------------------+-------------------------------------------+</strong><br class="calibre7"/><strong class="calibre4">root@controller:~#</strong>
</pre>


            </article>

            <footer class="calibre5">
                
            </footer>

        </section>
    

        <section class="calibre1">

            <header class="calibre1">
                </header><h1 class="header-title" id="calibre_pb_0">How it works...</h1>
            

            <article class="calibre1">
                
<p class="calibre3">We start the recipe by ensuring that we have an available Glance image to choose from. We list all available images in Glance in step 1. In step 2, we create a new instance flavor; we specify the allocated CPU, memory, and disk resources for the new instance type. In step 3, although it is not mandatory, we create a new SSH key pair that can later be used to SSH to the new instance. In step 4, we create two new security group rules that allow SSH and ICMP traffic. This is handy if we would like to ping and SSH to the new instance. Before we build the instance, we need to list the available networks in Neutron, which the guest will be part of; we do this in step 5.</p>
<p class="calibre3">With all of the earlier prerequisites in place, we build a new KVM instance in step 6, by specifying the instance flavor, the Glance image, the network, the security group, and the SSH key. We then proceed to list the status of the instance. Notice how the task state shows as scheduling, meaning that the <kbd class="calibre13">nova-scheduler</kbd> is selecting a host to provision the instance on and the status is BUILD. Since we are only using a single host for this example deployment, the instance is going to be provisioned on the same compute server. From the output of the build command, we can also see the IP address that was assigned to the new instance.</p>
<p class="calibre3">In step 7, we can see that the new instance was successfully provisioned, its status now shows as ACTIVE and a new QEMU process has been started.</p>
<p class="calibre3">Finally, in step 8, we examine the running instance; note that the power state field now shows Running and the status field displays active.</p>


            </article>

            <footer class="calibre5">
                
            </footer>

        </section>
    

        <section class="calibre1">

            <header class="calibre1">
                </header><h1 class="header-title" id="calibre_pb_0">Stopping KVM instances with OpenStack</h1>
            

            <article class="calibre1">
                
<p class="calibre3">In this short recipe, we are going to stop a running KVM instance, we provisioned in the last recipe, using the familiar <kbd class="calibre13">openstack</kbd> command syntax.</p>


            </article>

            <footer class="calibre5">
                
            </footer>

        </section>
    

        <section class="calibre1">

            <header class="calibre1">
                </header><h1 class="header-title" id="calibre_pb_0">Getting ready</h1>
            

            <article class="calibre1">
                
<p class="calibre3"><span><span>For this recipe, we are going to need the following:</span></span></p>
<ul class="calibre16">
<li class="calibre17">A database server, a message queue, and <kbd class="calibre13">memcached</kbd> installed and configured, as described in the <em class="calibre22">Preparing the host for the OpenStack deployment</em> recipe.</li>
<li class="calibre17">The Glance service with an available image. For more information on how to deploy Glance and add a new image, refer to the <em class="calibre22">Installing and configuring the OpenStack Glance image service</em> recipe.</li>
<li class="calibre17"><span><span>The Keystone service we deployed in the</span></span> <em class="calibre22"><span><span>Installing and configuring the OpenStack Keystone identity service</span></span></em><span><span> recipe.</span></span></li>
<li class="calibre17"><span><span>The Nova services we configured in the</span></span> <em class="calibre22"><span><span>Installing and configuring the OpenStack Nova compute service</span></span></em><span><span> recipe.</span></span></li>
<li class="calibre17">The Neutron service that was deployed in the <em class="calibre22">Installing and configuring the OpenStack Neutron networking service</em> recipe.</li>
<li class="calibre17">A running KVM instance, provisioned with OpenStack.</li>
</ul>


            </article>

            <footer class="calibre5">
                
            </footer>

        </section>
    

        <section class="calibre1">

            <header class="calibre1">
                </header><h1 class="header-title" id="calibre_pb_0">How to do it...</h1>
            

            <article class="calibre1">
                
<p class="calibre3">To stop a running KVM guest using OpenStack, perform the following simple steps:</p>
<ol class="calibre18">
<li value="1" class="calibre17"><span>List the provisioned OpenStack instances:</span></li>
</ol>
<pre class="calibre25">
<strong class="calibre4">root@controller:~# openstack server list</strong><br class="calibre7"/><strong class="calibre4">+---------------------------+-----------------+--------+------------------+--------------+</strong><br class="calibre7"/><strong class="calibre4">| ID                        | Name            | Status | Networks         | Image Name   |</strong><br class="calibre7"/><strong class="calibre4">+---------------------------+-----------------+--------+------------------+--------------+</strong><br class="calibre7"/><strong class="calibre4">| 0f4745b1-...-9eaa1f9bb08f | ubuntu_instance | ACTIVE | nat=192.168.0.11 | ubuntu_16.04 |</strong><br class="calibre7"/><strong class="calibre4">+---------------------------+-----------------+--------+------------------+--------------+</strong><br class="calibre7"/><strong class="calibre4">root@controller:~#</strong>
</pre>
<ol start="2" class="calibre18">
<li value="2" class="calibre17">Stop the instance:</li>
</ol>
<pre class="calibre25">
<strong class="calibre4">root@controller:~# openstack server stop ubuntu_instance</strong><br class="calibre7"/><strong class="calibre4">root@controller:~#</strong>
</pre>
<ol start="3" class="calibre18">
<li value="3" class="calibre17">List the KVM guests using libvirt:</li>
</ol>
<pre class="calibre25">
<strong class="calibre4">root@controller:~# virsh list --all</strong><br class="calibre7"/><strong class="calibre4"> Id Name              State</strong><br class="calibre7"/><strong class="calibre4">----------------------------------------------------</strong><br class="calibre7"/><strong class="calibre4"> -  instance-00000001 shut off</strong><br class="calibre7"/><br class="calibre7"/><strong class="calibre4">root@controller:~#</strong>
</pre>
<ol start="4" class="calibre18">
<li value="4" class="calibre17">Ensure that the QEMU process for the instance has terminated:</li>
</ol>
<pre class="calibre25">
<strong class="calibre4">root@controller:~# pgrep -lfa qemu</strong><br class="calibre7"/><strong class="calibre4">root@controller:~#</strong>
</pre>
<ol start="5" class="calibre18">
<li value="5" class="calibre17">Check the status of the KVM guest:</li>
</ol>
<pre class="calibre25">
<strong class="calibre4">root@controller:~# openstack server list</strong><br class="calibre7"/><strong class="calibre4">+---------------------------+-----------------+--------+------------------+--------------+</strong><br class="calibre7"/><strong class="calibre4">| ID                        | Name            | Status | Networks         | Image Name   |</strong><br class="calibre7"/><strong class="calibre4">+---------------------------+-----------------+--------+------------------+--------------+</strong><br class="calibre7"/><strong class="calibre4">| 0f4745b1-...-9eaa1f9bb08f | ubuntu_instance | SHUTOFF| nat=192.168.0.11 | ubuntu_16.04 |</strong><br class="calibre7"/><strong class="calibre4">+---------------------------+-----------------+--------+------------------+--------------+</strong><br class="calibre7"/><strong class="calibre4">root@controller:~#</strong>
</pre>


            </article>

            <footer class="calibre5">
                
            </footer>

        </section>
    

        <section class="calibre1">

            <header class="calibre1">
                </header><h1 class="header-title" id="calibre_pb_0">How it works...</h1>
            

            <article class="calibre1">
                
<p class="calibre3">We start by listing the available KVM instances, provisioned with OpenStack in step 1. In step 2, we stop the instance by specifying its name. Please note that we can also use the instance ID to stop it. Since OpenStack uses the libvirt to manage the lifecycle of the KVM instances, in step 3, we see that the instance has been indeed destroyed. In step 4, we ensure that the QEMU process for the guest has also been terminated. In the last step, we can see that the instance state is now SHUTOFF instead of ACTIVE. Instances in this state can be started again by executing the following command:</p>
<pre class="calibre23">
<strong class="calibre4">root@controller:~# openstack server start ubuntu_instance</strong><br class="calibre7"/><strong class="calibre4">root@controller:~# openstack server list</strong><br class="calibre7"/><strong class="calibre4">+---------------------------+-----------------+--------+------------------+--------------+</strong><br class="calibre7"/><strong class="calibre4">| ID                        | Name            | Status | Networks         | Image Name   |</strong><br class="calibre7"/><strong class="calibre4">+---------------------------+-----------------+--------+------------------+--------------+</strong><br class="calibre7"/><strong class="calibre4">| 0f4745b1-...-9eaa1f9bb08f | ubuntu_instance | ACTIVE | nat=192.168.0.11 | ubuntu_16.04 |</strong><br class="calibre7"/><strong class="calibre4">+---------------------------+-----------------+--------+------------------+--------------+</strong><br class="calibre7"/><strong class="calibre4">root@controller:~#</strong>
</pre>


            </article>

            <footer class="calibre5">
                
            </footer>

        </section>
    

        <section class="calibre1">

            <header class="calibre1">
                </header><h1 class="header-title" id="calibre_pb_0">Terminating KVM instances with OpenStack</h1>
            

            <article class="calibre1">
                
<p class="calibre3">In this recipe, we are going to terminate a KVM instance provisioned with OpenStack. Terminating the instance will undefine it through libvirt, release the allocated CPU memory and disk resources back to the pool of available resource, for the compute host, and mark its IP address as available in the Neutron database.</p>


            </article>

            <footer class="calibre5">
                
            </footer>

        </section>
    

        <section class="calibre1">

            <header class="calibre1">
                </header><h1 class="header-title" id="calibre_pb_0">Getting ready</h1>
            

            <article class="calibre1">
                
<p class="calibre3"><span><span>For this recipe, we are going to need the following:</span></span></p>
<ul class="calibre16">
<li class="calibre17"><span><span>A database server, a message queue, and</span></span> <kbd class="calibre13">memcached</kbd><span><span> installed and configured, as described in the</span></span> <em class="calibre22"><span><span>Preparing the host for the OpenStack deployment</span></span></em><span><span> recipe.</span></span></li>
<li class="calibre17"><span><span>The Glance service with an available image. For more information on how to deploy Glance and add a new image, refer to the</span></span> <em class="calibre22"><span><span>Installing and configuring the OpenStack Glance image service</span></span></em><span><span> recipe.</span></span></li>
<li class="calibre17"><span><span>The Keystone service we deployed in the</span></span> <em class="calibre22"><span><span>Installing and configuring the OpenStack Keystone identity service</span></span></em><span><span> recipe.</span></span></li>
<li class="calibre17"><span><span>The Nova services we configured in the</span></span> <em class="calibre22"><span><span>Installing and configuring the OpenStack Nova compute service</span></span></em><span><span> recipe.</span></span></li>
<li class="calibre17"><span><span>The Neutron service that was deployed in the</span></span> <em class="calibre22"><span><span>Installing and configuring the OpenStack Neutron networking service</span></span></em><span><span> recipe.</span></span></li>
<li class="calibre17">A running KVM instance, provisioned with OpenStack.</li>
</ul>


            </article>

            <footer class="calibre5">
                
            </footer>

        </section>
    

        <section class="calibre1">

            <header class="calibre1">
                </header><h1 class="header-title" id="calibre_pb_0">How to do it...</h1>
            

            <article class="calibre1">
                
<p class="calibre3">To terminate a running instance, perform the following steps:</p>
<ol class="calibre18">
<li value="1" class="calibre17"><span>Obtain the name or ID of the instance to be terminated:</span></li>
</ol>
<pre class="calibre25">
<strong class="calibre4"><span><span>root@controller:~# openstack server start ubuntu_instance</span></span></strong><br class="calibre7"/><strong class="calibre4"><span><span>root@controller:~# openstack server list</span></span></strong><br class="calibre7"/><strong class="calibre4"><span><span>+---------------------------+-----------------+--------+------------------+--------------+</span></span></strong><br class="calibre7"/><strong class="calibre4"><span><span>| ID                        | Name            | Status | Networks         | Image Name   |</span></span></strong><br class="calibre7"/><strong class="calibre4"><span><span>+---------------------------+-----------------+--------+------------------+--------------+</span></span></strong><br class="calibre7"/><strong class="calibre4"><span><span>| 0f4745b1-...-9eaa1f9bb08f | ubuntu_instance | ACTIVE | nat=192.168.0.11 | ubuntu_16.04 |</span></span></strong><br class="calibre7"/><strong class="calibre4"><span><span>+---------------------------+-----------------+--------+------------------+--------------+</span></span></strong><br class="calibre7"/><strong class="calibre4"><span><span>root@controller:~#</span></span></strong>
</pre>
<ol start="2" class="calibre18">
<li value="2" class="calibre17">Delete the instance by providing the name:</li>
</ol>
<pre class="calibre25">
<strong class="calibre4">root@controller:~# openstack server delete ubuntu_instance</strong><br class="calibre7"/><strong class="calibre4">root@controller:~#</strong>
</pre>
<ol start="3" class="calibre18">
<li value="3" class="calibre17">Ensure that the instance was undefined:</li>
</ol>
<pre class="calibre25">
<strong class="calibre4">root@controller:~# openstack server list</strong><br class="calibre7"/><br class="calibre7"/><strong class="calibre4">root@controller:~# virsh list --all</strong><br class="calibre7"/><strong class="calibre4"> Id   Name   State</strong><br class="calibre7"/><strong class="calibre4">----------------------------------------------------</strong><br class="calibre7"/><br class="calibre7"/><strong class="calibre4">root@controller:~#</strong>
</pre>
<ol start="4" class="calibre18">
<li value="4" class="calibre17">Examine the <kbd class="calibre13">nova-api</kbd>, <kbd class="calibre13">neutron-server</kbd>, and <kbd class="calibre13">nova-compute</kbd> logs:</li>
</ol>
<pre class="calibre25">
<strong class="calibre4">root@controller:~# cat /var/log/nova/nova-api.log | grep -i delete</strong><br class="calibre7"/><strong class="calibre4">2017-05-04 15:30:07.733 20915 INFO nova.osapi_compute.wsgi.server [req-54dbe80f-9942-43d8-949a-d80daa2440a9 cc14c5dbbd654c438e52d38efaf4f1a6 123c1e6f33584dd1876c0a34249a6e11 - default default] 10.184.226.74 "DELETE /v2.1/123c1e6f33584dd1876c0a34249a6e11/servers/0f4745b1-9d4b-4e8a-82f7-9eaa1f9bb08f HTTP/1.1" status: 204 len: 339 time: 0.1859989</strong><br class="calibre7"/><strong class="calibre4">root@controller:~#</strong><br class="calibre7"/><strong class="calibre4">root@controller:~# cat /var/log/neutron/neutron-server.log | grep -i delete</strong><br class="calibre7"/><strong class="calibre4">2017-05-04 15:30:08.402 17910 INFO neutron.wsgi [req-5c9674d6-c596-4b17-b975-54625ac7adb2 cc14c5dbbd654c438e52d38efaf4f1a6 123c1e6f33584dd1876c0a34249a6e11 - - -] 10.184.226.74 - - [04/May/2017 15:30:08] "DELETE /v2.0/ports/fdaf6ea1-b76a-4895-a028-db15831132fa.json HTTP/1.1" 204 173 0.320351</strong><br class="calibre7"/><strong class="calibre4">root@controller:~#</strong><br class="calibre7"/><strong class="calibre4">root@controller:~# cat /var/log/nova/nova-compute.log</strong><br class="calibre7"/><strong class="calibre4">...</strong><br class="calibre7"/><strong class="calibre4">2017-05-04 15:30:07.747 21065 INFO nova.compute.manager [req-54dbe80f-9942-43d8-949a-d80daa2440a9 cc14c5dbbd654c438e52d38efaf4f1a6 123c1e6f33584dd1876c0a34249a6e11 - - -] [instance: 0f4745b1-9d4b-4e8a-82f7-9eaa1f9bb08f] Terminating instance</strong><br class="calibre7"/><strong class="calibre4">2017-05-04 15:30:07.952 21065 INFO nova.virt.libvirt.driver [-] [instance: 0f4745b1-9d4b-4e8a-82f7-9eaa1f9bb08f] Instance destroyed successfully.</strong><br class="calibre7"/><strong class="calibre4">2017-05-04 15:30:07.953 21065 INFO os_vif [req-54dbe80f-9942-43d8-949a-d80daa2440a9 cc14c5dbbd654c438e52d38efaf4f1a6 123c1e6f33584dd1876c0a34249a6e11 - - -] Successfully unplugged vif VIFBridge(active=True,address=fa:16:3e:3c:c0:0f,bridge_name='brqb7ccb514-21',has_traffic_filtering=True,id=fdaf6ea1-b76a-4895-a028-db15831132fa,network=Network(b7ccb514-21fc-4ced-b74f-026e7e358bba),plugin='linux_bridge',port_profile=&lt;?&gt;,preserve_on_delete=False,vif_name='tapfdaf6ea1-b7')</strong><br class="calibre7"/><strong class="calibre4">2017-05-04 15:30:07.970 21065 INFO nova.virt.libvirt.driver [req-54dbe80f-9942-43d8-949a-d80daa2440a9 cc14c5dbbd654c438e52d38efaf4f1a6 123c1e6f33584dd1876c0a34249a6e11 - - -] [instance: 0f4745b1-9d4b-4e8a-82f7-9eaa1f9bb08f] Deleting instance files /var/lib/nova/instances/0f4745b1-9d4b-4e8a-82f7-9eaa1f9bb08f_del</strong><br class="calibre7"/><strong class="calibre4">2017-05-04 15:30:07.974 21065 INFO nova.virt.libvirt.driver [req-54dbe80f-9942-43d8-949a-d80daa2440a9 cc14c5dbbd654c438e52d38efaf4f1a6 123c1e6f33584dd1876c0a34249a6e11 - - -] [instance: 0f4745b1-9d4b-4e8a-82f7-9eaa1f9bb08f] Deletion of /var/lib/nova/instances/0f4745b1-9d4b-4e8a-82f7-9eaa1f9bb08f_del complete</strong><br class="calibre7"/><strong class="calibre4">...</strong><br class="calibre7"/><strong class="calibre4">root@controller:~#</strong>
</pre>


            </article>

            <footer class="calibre5">
                
            </footer>

        </section>
    

        <section class="calibre1">

            <header class="calibre1">
                </header><h1 class="header-title" id="calibre_pb_0">How it works...</h1>
            

            <article class="calibre1">
                
<p class="calibre3">We begin by listing all instances that Nova knows about in step 1, noting the name of the instance we would like to delete.</p>
<p class="calibre3">In step 2, we delete the instance by specifying its name. Note that we can also use its ID instead. In step 3, we confirm that the instance has been undefined by libvirt and is no longer available in OpenStack.</p>
<p class="calibre3">In step 4, we can see the API calls that were sent to the <kbd class="calibre13">nova-api</kbd>, <kbd class="calibre13">neutron-server</kbd>, and <kbd class="calibre13">nova-compute</kbd> services and the action that those services took.</p>


            </article>

            <footer class="calibre5">
                
            </footer>

        </section>
    </body></html>