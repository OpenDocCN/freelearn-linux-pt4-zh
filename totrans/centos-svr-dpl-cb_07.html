<html><head></head><body><div class="chapter" title="Chapter&#xA0;7.&#xA0;Working with Databases"><div class="titlepage"><div><div><h1 class="title"><a id="ch07"/>Chapter 7. Working with Databases</h1></div></div></div><p>This chapter contains the following recipes:</p><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc">Setting up a MySQL database</li><li class="listitem" style="list-style-type: disc">Backing up and restoring a MySQL database</li><li class="listitem" style="list-style-type: disc">Configuring MySQL replication</li><li class="listitem" style="list-style-type: disc">Setting up a MySQL cluster</li><li class="listitem" style="list-style-type: disc">Setting up a MongoDB database</li><li class="listitem" style="list-style-type: disc">Backing up and restoring a MongoDB database</li><li class="listitem" style="list-style-type: disc">Configuring a MongoDB replica set</li><li class="listitem" style="list-style-type: disc">Setting up an OpenLDAP directory</li><li class="listitem" style="list-style-type: disc">Backing up and restoring an OpenLDAP directory</li></ul></div><div class="section" title="Introduction"><div class="titlepage"><div><div><h1 class="title"><a id="ch07lvl1sec57"/>Introduction</h1></div></div></div><p>This chapter focuses on three databases. First, you'll learn how to install one of the most widely used relational database servers, MySQL. You'll also learn how to set up master-slave replication to maintain mirror copies of your MySQL databases, and how to stand up a MySQL cluster to provide scalable, high-availability data storage. Next, we'll move to the world of NoSQL databases. You'll learn how to install the popular document-oriented database server MongoDB, and how to configure a MongoDB replica set (replication). Then you'll learn how to set up an LDAP directory server using OpenLDAP. For each of these databases, the chapter also has recipes to show you how to perform basic backup and restore tasks to keep your data safe.</p></div></div>
<div class="section" title="Setting up a MySQL database"><div class="titlepage"><div><div><h1 class="title"><a id="ch07lvl1sec58"/>Setting up a MySQL database</h1></div></div></div><p>This recipe shows you how to perform a basic installation of the popular MySQL database server on CentOS. MySQL is the second most widely used database system today, which is found across many different industries providing data storage for everything from dynamic websites to large-scale data warehouses.</p><div class="section" title="Getting ready"><div class="titlepage"><div><div><h2 class="title"><a id="ch07lvl2sec181"/>Getting ready</h2></div></div></div><p>This recipe requires a CentOS system with a working network connection and administrative privileges either using the <code class="literal">root</code> account or <code class="literal">sudo</code>.</p></div><div class="section" title="How to do it..."><div class="titlepage"><div><div><h2 class="title"><a id="ch07lvl2sec182"/>How to do it...</h2></div></div></div><p>Follow these steps to install MySQL and create a new database:</p><div class="orderedlist"><ol class="orderedlist arabic"><li class="listitem">Download the repository configuration package for the Oracle-maintained MySQL repository:<pre class="programlisting">
<span class="strong"><strong>curl -LO dev.mysql.com/get/mysql57-community-release-el7-&#13;
       7.noarch.rpm</strong></span>
</pre></li><li class="listitem">Install the downloaded package:<pre class="programlisting">
<span class="strong"><strong>yum install mysql57-community-release-el7-7.noarch.rpm</strong></span>
</pre></li><li class="listitem">Now that the MySQL repository is registered, install the <code class="literal">mysql-community-server</code> package:<pre class="programlisting">
<span class="strong"><strong>yum install mysql-community-server</strong></span>
</pre></li><li class="listitem">Start the MySQL server and enable it to start automatically whenever the system reboots:<pre class="programlisting">
<span class="strong"><strong>systemctl start mysqld.service</strong></span>
<span class="strong"><strong>systemctl enable mysqld.service</strong></span>
</pre></li><li class="listitem">Open port <code class="literal">3306</code> in the system's firewall to allow outside connections to MySQL:<pre class="programlisting">
<span class="strong"><strong>firewall-cmd --zone=public --permanent --add-service=mysql</strong></span>
<span class="strong"><strong>firewall-cmd --reload</strong></span>
</pre></li><li class="listitem">Retrieve the temporary password for MySQL's <code class="literal">root</code> user from the server's log file:<pre class="programlisting">
<span class="strong"><strong>grep "temporary password" /var/log/mysqld.log</strong></span>
</pre></li><li class="listitem">Set a new password for <code class="literal">root</code> using <code class="literal">mysqladmin</code>. When the program prompts for the current password, enter the temporary password found in the logs:<pre class="programlisting">
<span class="strong"><strong>mysqladmin -u root -p password</strong></span>
</pre></li><li class="listitem">Use <code class="literal">mysql</code> to connect to the MySQL server using the <code class="literal">root</code> account:<pre class="programlisting">
<span class="strong"><strong>mysql -u root -p</strong></span>
</pre></li><li class="listitem">To create a new database, execute a <code class="literal">CREATE DATABASE</code> statement:<pre class="programlisting">
<span class="strong"><strong>CREATE DATABASE packt;</strong></span>
</pre></li><li class="listitem">Execute a <code class="literal">CREATE USER</code> statement to create a MySQL user account for working with the database:<pre class="programlisting">
<span class="strong"><strong>CREATE USER "tboronczyk"@"localhost" IDENTIFIED  BY "P@$$W0rd";</strong></span>
</pre></li><li class="listitem">Execute a <code class="literal">GRANT</code> statement to assign the appropriate privileges to the account for the new database:<pre class="programlisting">
<span class="strong"><strong>GRANT CREATE, DROP, ALTER, LOCK TABLES, INDEX,  INSERT, UPDATE, &#13;
       SELECT, DELETE ON packt.* TO </strong></span>
<span class="strong"><strong>"tboronczyk"@"localhost";</strong></span>
</pre></li><li class="listitem">Execute <code class="literal">FLUSH PRIVILEGES</code> to instruct MySQL to rebuild its privileges cache:<pre class="programlisting">
<span class="strong"><strong>FLUSH PRIVILEGES;</strong></span>
</pre></li><li class="listitem">Exit the MySQL client and return to the terminal:<pre class="programlisting">
<span class="strong"><strong>exit</strong></span>
</pre></li></ol></div></div><div class="section" title="How it works..."><div class="titlepage"><div><div><h2 class="title"><a id="ch07lvl2sec183"/>How it works...</h2></div></div></div><p>We began by downloading the package that registers the Oracle-maintained MySQL repository on our system. MySQL is installed from the Oracle repository, because the CentOS repositories install MariaDB instead. After a series of acquisitions between 2008 and 2010, the MySQL codebase and trademark became the property of Oracle. Widespread concern over Oracle's stewardship and the future of MySQL prompted one of the original developers of MySQL to fork the project and start MariaDB. In 2014, the Red Hat and CentOS repositories replaced MySQL as the default database with MariaDB (welcome to the world of open-source politics).</p><div class="note" style="" title="Note"><div class="inner"><h3 class="title"><a id="note45"/>Note</h3><p>MariaDB's goal is to remain a free, open-source project under the GNU GPL license and to be an "enhanced, drop-in replacement" for MySQL. For now, differences between the two are negligible to the casual user. But in the world of forked replacements, it's mainly the programming interfaces and communication protocols that remain compatible. Core functionality may remain the same initially, but new features are added independently as time goes on and the products' feature sets begin to diverge. MariaDB acknowledges this with a jump in versioning numbers. MariaDB 5.1 offers the same features as MySQL 5.1, as does MariaDB 5.5 for MySQL 5.5. However, MariaDB doesn't plan to implement all of MySQL 5.6's features and changed their version number to 10.0. For those keeping score at home, the Oracle-maintained repository hosts MySQL 5.7 at the time of this writing. The CentOS repositories currently offer MariaDB 5.5.</p></div></div><p>The server that hosts the package assumes that people download the file using a web browser and issues a redirect to begin the download. Since we're using <code class="literal">curl</code>, we supplied the <code class="literal">-L</code> argument to follow the redirects to reach the actual package:</p><pre class="programlisting">
<span class="strong"><strong>curl -LO dev.mysql.com/get/mysql57-community-release-el7-7.noarch.rpm</strong></span>
</pre><p>Next, we installed the downloaded package. Once the repository is registered, we're able to install MySQL with the <code class="literal">mysql-community-server</code> package. The package installs the server binaries, and the client utilities to work with MySQL are installed as dependencies:</p><pre class="programlisting">
<span class="strong"><strong>yum install mysql57-community-release-el7-7.noarch.rpm</strong></span>
<span class="strong"><strong>yum install mysql-community-server</strong></span>
</pre><p>MySQL maintains its own user accounts and its administrative user is named <code class="literal">root</code>. Just like CentOS's <code class="literal">root</code> user, you shouldn't use the account for regular activities; it should be reserved for administrative tasks such as creating new users, granting privileges, and flushing the server's caches. Other less-privileged accounts should be used for everyday activities. To protect the <code class="literal">root</code> account, its password is randomly generated the first time we start the MySQL server. We needed to search the log file where MySQL recorded the password so that we can set a new password of our own choosing:</p><pre class="programlisting">
<span class="strong"><strong>grep "temporary password" /var/log/mysqld.log</strong></span>
</pre><p>Knowing the temporary password, we used <code class="literal">mysqladmin</code> to change it. The <code class="literal">-u</code> option gives the username of the MySQL account, <code class="literal">-p</code> prompts us for the account's password, and <code class="literal">password</code> is the utility's subcommand used to change passwords. We entered the temporary password when prompted for the original and then we were asked to enter and confirm the new password:</p><pre class="programlisting">
<span class="strong"><strong>mysqladmin -u root -p password</strong></span>
</pre><div class="note" style="" title="Note"><div class="inner"><h3 class="title"><a id="note46"/>Note</h3><p>A random default password for <code class="literal">root</code> is a new behavior starting with MySQL 5.6, which writes the password to <code class="literal">/root/.mysql_secret</code>, whereas 5.7 writes it to the log file. In older versions, and thus MariaDB since 5.5 is installed by the CentOS repositories, the password is empty.
The <code class="literal">validate_password</code> plugin is also activated in MySQL 5.7. It requires the password to be eight characters or more with at least one number, one upper and one lowercase character, and one special character (that is, punctuation). Consider these requirements when choosing root's new password.</p></div></div><div class="mediaobject"><img alt="How it works..." src="graphics/image_07_001.jpg"/><div class="caption"><p>The temporary password is needed to set root's permanent password</p></div></div><p>There are several clients that we can use to connect to MySQL and interact with our databases. This recipe used <code class="literal">mysql</code> since it will have been installed by default as a dependency. Again, <code class="literal">-u</code> identifies the account's username and <code class="literal">-p</code> prompts us for its password:</p><pre class="programlisting">
<span class="strong"><strong>mysql -u root -p</strong></span>
</pre><p>When running in interactive mode, the client displays the prompt <code class="literal">mysql&gt;</code> at which we submit our SQL statements. After each query, the client displays the server's response, how long the statement took to execute, and if the server reported any errors or warnings.</p><p>We issued a <code class="literal">CREATE DATABASE</code> statement at the prompt to create the new database named <code class="literal">packt</code>:</p><pre class="programlisting">
<span class="strong"><strong>CREATE DATABASE packt;</strong></span>
</pre><p>Then we created a new user account with <code class="literal">CREATE USER</code> to avoid using <code class="literal">root</code> for our day-to-day work. The account is named <code class="literal">tboronczyk</code> and is allowed to authenticate from the localhost:</p><pre class="programlisting">
<span class="strong"><strong>CREATE USER "tboronczyk"@"localhost" IDENTIFIED BY "P@$$w0rd";</strong></span>
</pre><p>A system's hostname or IP address can replace <code class="literal">localhost</code> if the account will connect to the server from a different system. MySQL treats each username and hostname pair to be separate accounts though, for example <code class="literal">tboronczyk@localhost</code> and <code class="literal">tboronczyk@ 192.168.56.100</code> are different accounts and can have different privileges assigned to them.</p><div class="note" style="" title="Note"><div class="inner"><h3 class="title"><a id="note47"/>Note</h3><p>You can use wildcards in the hostname to create an account that can connect from multiple systems. The <code class="literal">%</code> wildcard matches zero or more characters, so it can be used to represent any system:</p><p>
</p><p><code class="literal">
<span class="strong"><strong>CREATE USER "tboronczyk"@"%" IDENTIFIED BY "P@$$w0rd";</strong></span>
</code></p></div></div><p>New accounts are created without any privileges, so we must assign them by executing a <code class="literal">GRANT</code> statement:</p><pre class="programlisting">
<span class="strong"><strong>GRANT CREATE, DROP, ALTER, LOCK TABLES, INSERT, UPDATE, SELECT,  &#13;
DELETE ON packt.* TO "tboronczyk"@"localhost";</strong></span>
</pre><p>The statement assigns the following privileges to the user for all tables (denoted by <code class="literal">*</code>) in the <code class="literal">packt</code> database:</p><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc"><code class="literal">CREATE</code>: This allows the user to create databases and tables</li><li class="listitem" style="list-style-type: disc"><code class="literal">DROP</code>: This allows the user to delete entire tables and databases</li><li class="listitem" style="list-style-type: disc"><code class="literal">ALTER</code>: This allows the user to change the definition of an existing table</li><li class="listitem" style="list-style-type: disc"><code class="literal">LOCK TABLES</code>: This allows the user to lock a table for exclusive read or write access</li><li class="listitem" style="list-style-type: disc"><code class="literal">INDEX</code>: This allows the user to create table indexes</li><li class="listitem" style="list-style-type: disc"><code class="literal">INSERT</code>: This allows the user to add records to a table</li><li class="listitem" style="list-style-type: disc"><code class="literal">UPDATE</code>: This allows the user to update records in a table</li><li class="listitem" style="list-style-type: disc"><code class="literal">SELECT</code>: This allows the user to retrieve records from a table</li><li class="listitem" style="list-style-type: disc"><code class="literal">DELETE</code>: This allows the user to delete records from a table</li></ul></div><p>A full list of privileges and what they permit a user to do can be found in the official MySQL documentation online at <a class="ulink" href="http://dev.mysql.com/doc/refman/5.7/en/grant.html">http://dev.mysql.com/doc/refman/5.7/en/grant.html</a>.</p><p>Next, we instructed MySQL to rebuild its privileges cache using <code class="literal">FLUSH PRIVILEGES</code>:</p><pre class="programlisting">    FLUSH PRIVILEGES; &#13;
</pre><p>When MySQL starts up, it caches the user and permissions information in memory (you'll recall from <a class="link" href="ch05.html" title="Chapter 5. Managing Filesystems and Storage">Chapter 5</a>, <span class="emphasis"><em>Managing Filesystems and Storage</em></span>, that reading from memory is much faster than reading from disk) and then checks the cache every time a user performs an action to verify if they have sufficient privileges. We need to tell MySQL to update its cache whenever we create or delete a user account or grant or revoke an account's privileges, or else our changes will go unnoticed until the next time MySQL starts.</p><p>When using <code class="literal">mysql</code> to connect to MySQL, you may frequently invoke it with additional options. A common option is <code class="literal">-h</code>, which identifies the hostname or IP address of the remote server if MySQL is running on a different system. <code class="literal">-e</code> executes a statement directly instead of launching <code class="literal">mysql</code> in interactive mode. Also, to work with a specific database, the name can be given either after the rest of the command or you can use <code class="literal">-D</code> to specify it. The following example demonstrates all of these by connecting to the MySQL server on <code class="literal">192.168.56.100</code> and executing a <code class="literal">SELECT</code> statement against its <code class="literal">sakila</code> database:</p><pre class="programlisting">
<span class="strong"><strong>mysql -u tboronczyk -p -h 192.168.56.100 -D sakila -e "SELECT  &#13;
last_name, first_name FROM actor"</strong></span>
</pre></div><div class="section" title="See also"><div class="titlepage"><div><div><h2 class="title"><a id="ch07lvl2sec184"/>See also</h2></div></div></div><p>Refer to the following resources for more information on working with MySQL:</p><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc">The <code class="literal">mysql</code> manual page (<code class="literal">man 1 mysql</code>)</li><li class="listitem" style="list-style-type: disc">MySQL 5.7 reference manual (<a class="ulink" href="http://dev.mysql.com/doc/refman/5.7/en">http://dev.mysql.com/doc/refman/5.7/en</a>)</li><li class="listitem" style="list-style-type: disc">Jump Start MySQL (<a class="ulink" href="http://www.amazon.com/Jump-Start-MySQL-Timothy-Boronczyk/dp/0992461286">http://www.amazon.com/Jump-Start-MySQL-Timothy-Boronczyk/dp/0992461286</a>)</li><li class="listitem" style="list-style-type: disc">MySQL Tutorial (<a class="ulink" href="http://www.mysqltutorial.org/">http://www.mysqltutorial.org/</a>)</li></ul></div></div></div>
<div class="section" title="Backing up and restoring a MySQL database"><div class="titlepage"><div><div><h1 class="title"><a id="ch07lvl1sec59"/>Backing up and restoring a MySQL database</h1></div></div></div><p>This recipe shows you how to back up your MySQL databases using <code class="literal">mysqldump</code>. The utility connects to the MySQL server, queries the structure of the database and its data, and outputs the data in the form of SQL statements. The backup can then be used to restore the database or populate a new database with the data.</p><div class="section" title="Getting ready"><div class="titlepage"><div><div><h2 class="title"><a id="ch07lvl2sec185"/>Getting ready</h2></div></div></div><p>This recipe requires a running MySQL server and access to either MySQL's <code class="literal">root</code> user or another user with the necessary privileges to perform the backup.</p></div><div class="section" title="How to do it..."><div class="titlepage"><div><div><h2 class="title"><a id="ch07lvl2sec186"/>How to do it...</h2></div></div></div><p>Follow these steps to make a backup of a MySQL database:</p><div class="orderedlist"><ol class="orderedlist arabic"><li class="listitem">Connect to the MySQL database you want to back up:<pre class="programlisting">
<span class="strong"><strong>mysql -u root -p packt</strong></span>
</pre></li><li class="listitem">Execute a <code class="literal">FLUSH TABLES</code> statement to set the database's tables read-only:<pre class="programlisting">
<span class="strong"><strong>FLUSH TABLES WITH READ LOCK;</strong></span>
</pre></li><li class="listitem">Open a second terminal, leaving the first one active with the <code class="literal">mysql</code> client still running.</li><li class="listitem">In the new terminal, use <code class="literal">mysqldump</code> to export the table definitions and data:<pre class="programlisting">
<span class="strong"><strong>mysqldump -u root -p packt &gt; backup.sql</strong></span>
</pre></li><li class="listitem">Return to the first terminal once the backup is complete and exit <code class="literal">mysql</code> to unlock the tables.<p>Because the backup consists of SQL statements, you can recreate the database by importing the statements with <code class="literal">mysql</code>:</p><pre class="programlisting">
<span class="strong"><strong>mysql -u root -p packt &lt; backup.sql</strong></span>
</pre></li></ol></div></div><div class="section" title="How it works..."><div class="titlepage"><div><div><h2 class="title"><a id="ch07lvl2sec187"/>How it works...</h2></div></div></div><p>The consequences of lost data can range from mild irritation to serious economic repercussions, so it's important to protect yourself with backups. Just think what would happen if your bank lost all of your financial records! The more important your data is to you and the more difficult it is to be recreated if it were to be lost, the more important it is to have backups in case something bad happens.</p><p>Prior to making the backup, we connected to the server and executed <code class="literal">FLUSH TABLES</code>. The statement forces MySQL to finalize any data updates that may be pending and then sets the tables read-only to prevent modifications to the data while the backup is in progress. This ensures that the data in our backup is consistent:</p><pre class="programlisting">
<span class="strong"><strong>FLUSH TABLES WITH READ LOCK;</strong></span>
</pre><p>The tables remain read-only until we release the lock, either by executing an <code class="literal">UNLOCK TABLES</code> statement or by terminating the connection to the MySQL server, so we left the current session running and opened a second terminal to perform the backup. While the tables are read-only, any queries that retrieve data will execute, but those that update or insert data will be blocked.</p><div class="note" style="" title="Note"><div class="inner"><h3 class="title"><a id="note48"/>Note</h3><p>Consider setting up MySQL replication as described in the <span class="emphasis"><em>Configuring MySQL replication</em></span> recipe and then back up the slave's copy of the database to avoid any downtime. Stop replication on the slave, use <code class="literal">mysqldump</code> to export the data, and then resume replication. The master's tables don't need to be locked and any changes made on the master while replication is suspended will be replicated once the slave comes back online.</p></div></div><p>Then, we used <code class="literal">mysqldump</code> to export all of the table definitions and data from the database:</p><pre class="programlisting">
<span class="strong"><strong>mysqldump -u root -p packt &gt; backup.sql</strong></span>
</pre><p>Keep yourself organized by including the date in your backup filenames:</p><pre class="programlisting">
<span class="strong"><strong>mysqldump -u root -p packt &gt; backup-$(date +%F).sql</strong></span>
</pre><p><code class="literal">mysqldump</code> queries the database to retrieve the data, so whichever account we use to perform the backup, it must have the necessary privileges. What exactly those permissions are, ultimately depends on your database's schema. For example, the account needs the <code class="literal">SHOW VIEW</code> privilege if your database uses views. The same holds true for the account used to restore the database. You should keep this in mind if you want to use dedicated accounts for your backup and restore activities.</p><p>To back up only certain tables, you can list them after the database. For example, the following backs up the <code class="literal">customers</code> and <code class="literal">addresses</code> tables:</p><pre class="programlisting">
<span class="strong"><strong>mysqldump -u root -p packt customers addresses &gt; backup.sql</strong></span>
</pre><p>There are also several options you can provide to <code class="literal">mysqldump</code> that affect what it includes in the backup. Here's a list of some of the more commonly used ones:</p><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc"><code class="literal">--no-add-drop-table</code>: This does not include a <code class="literal">DROP TABLE</code> statement before any <code class="literal">CREATE TABLE</code> statements in the output. Without dropping a table first, the import process may fail on the <code class="literal">CREATE TABLE</code> statement when the backup is restored on a system that already has the tables defined.</li><li class="listitem" style="list-style-type: disc"><code class="literal">--events</code>: This exports the definitions for any stored events associated with the database.</li><li class="listitem" style="list-style-type: disc"><code class="literal">--hex-blob</code>: This outputs binary values using the hexadecimal notation. This can help protect against certain byte sequences being incorrectly interpreted, causing a restore to fail.</li><li class="listitem" style="list-style-type: disc"><code class="literal">--tables</code>: This backs up only the specific tables. This is an alternate way of specifying tables instead of listing them after the database name.</li><li class="listitem" style="list-style-type: disc"><code class="literal">--routines</code>: This exports the definitions for any stored procedures associated with the database.</li><li class="listitem" style="list-style-type: disc"><code class="literal">--where</code>: This is a <code class="literal">WHERE</code> condition used to return only specific rows. For example, <code class="literal">--tables customers --where "last_name LIKE 'B%'"</code> will only export rows from the <code class="literal">customers</code> table for customers whose last name starts with B.</li></ul></div><p>You can find a complete list of options in the online documentation at <a class="ulink" href="http://dev.mysql.com/doc/refman/5.7/en/mysqldump.html">http://dev.mysql.com/doc/refman/5.7/en/mysqldump.html</a>.</p></div><div class="section" title="See also"><div class="titlepage"><div><div><h2 class="title"><a id="ch07lvl2sec188"/>See also</h2></div></div></div><p>Refer to the following resources for more information on making backups with <code class="literal">mysqldump</code>:</p><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc">The <code class="literal">mysqldump</code> manual page (<code class="literal">man 1 mysqldump</code>)</li><li class="listitem" style="list-style-type: disc">MySQL 5.7 Reference Manual: <code class="literal">mysqldump</code> (<a class="ulink" href="http://dev.mysql.com/doc/refman/5.7/en/mysqldump.html">http://dev.mysql.com/doc/refman/5.7/en/mysqldump.html</a>)</li><li class="listitem" style="list-style-type: disc">Backup and Restore MySQL Database Using <code class="literal">mysqldump</code> (<a class="ulink" href="http://www.thegeekstuff.com/2008/09/backup-and-restore-mysql-database-using-mysqldump">http://www.thegeekstuff.com/2008/09/backup-and-restore-mysql-database-using-mysqldump</a>)</li></ul></div></div></div>
<div class="section" title="Configuring MySQL replication"><div class="titlepage"><div><div><h1 class="title"><a id="ch07lvl1sec60"/>Configuring MySQL replication</h1></div></div></div><p>This recipe teaches you how to configure MySQL's master-slave replication to maintain mirror copies of your databases in near real time.</p><p>To replicate data, the master MySQL server records details about any changes that take place (inserts, updates, and so on) to a file known as the binary log. Each slave server connects to the master's system, reads the information from the log file, and then duplicates the change to maintain their own local copy of the database. Each slave server is responsible for itself, which means we can bring a slave down for maintenance without affecting the availability of the master. Once it comes back online, the slave resumes replication from where it left off.</p><p>Replication can be useful in many situations. For example, if a full copy of the database is maintained on a slave, you can swap out the master server with little effort for a failover or disaster-recovery situation. For environments where scalability and performance are a concern, write operations can be performed by the master while intensive read operations can be handled by a collection of read-only slaves behind a load balancer.</p><div class="section" title="Getting ready"><div class="titlepage"><div><div><h2 class="title"><a id="ch07lvl2sec189"/>Getting ready</h2></div></div></div><p>This recipe demonstrates how to configure MySQL replication using two systems. The first system is the master MySQL server, which we'll assume has the IP address <code class="literal">192.168.56.100</code>. The second system is the slave server and has the address <code class="literal">192.168.56.101</code>. You'll need administrative access on both systems either using the <code class="literal">root</code> account or <code class="literal">sudo</code> to complete the configuration.</p><p>Both systems should have MySQL installed as discussed by the earlier <span class="emphasis"><em>Setting up a MySQL database</em></span> recipe. If you're setting up replication after one or more databases have already been created on the master, follow the <span class="emphasis"><em>Backing up and restoring a MySQL database</em></span> recipe to back them up and import them to the slave before configuring replication. This ensures that replication starts with all databases in sync.</p></div><div class="section" title="How to do it..."><div class="titlepage"><div><div><h2 class="title"><a id="ch07lvl2sec190"/>How to do it...</h2></div></div></div><p>Follow these steps to configure master-slave replication for MySQL:</p><div class="orderedlist"><ol class="orderedlist arabic"><li class="listitem">Use your text editor to open the master MySQL server's configuration file at <code class="literal">/etc/my.cnf</code>:<pre class="programlisting">
<span class="strong"><strong>vi /etc/my.cnf</strong></span>
</pre></li><li class="listitem">In the <code class="literal">[mysqld]</code> section, add a new entry for the <code class="literal">server-id</code> option and set its value to <code class="literal">1</code>:<pre class="programlisting">
<span class="strong"><strong>server-id = 1</strong></span>
</pre></li><li class="listitem">Locate the <code class="literal">log_bin</code> option and uncomment it:<pre class="programlisting">
<span class="strong"><strong>log_bin</strong></span>
</pre></li><li class="listitem">Save your changes and close the configuration file.</li><li class="listitem">Restart the server so that the changes will take effect:<pre class="programlisting">
<span class="strong"><strong>systemctl restart mysqld.service</strong></span>
</pre></li><li class="listitem">Connect to the master server using <code class="literal">mysql</code> and create a new account for slaves to use. The account requires the <code class="literal">REPLICATION SLAVE</code> privilege:<pre class="programlisting">
<span class="strong"><strong>CREATE USER "slave"@"192.168.56.101" IDENTIFIED BY "S3CR3t##";</strong></span>
<span class="strong"><strong>GRANT REPLICATION SLAVE ON *.* TO "slave"@"192.168.56.101";</strong></span>
<span class="strong"><strong>FLUSH PRIVILEGES;</strong></span>
</pre></li><li class="listitem">Execute <code class="literal">SHOW MASTER STATUS</code> to determine the master's current position in writing to the binary log. Note the values returned for <code class="literal">File</code> and <code class="literal">Position</code>, as the information will be required to configure the slave:<pre class="programlisting">
<span class="strong"><strong>SHOW MASTER STATUS;</strong></span>
</pre><div class="mediaobject"><img alt="How to do it..." src="graphics/image_07_002.jpg"/><div class="caption"><p>The master's status includes the name of the log file and the server's write position</p></div></div></li><li class="listitem">Use your editor to open the slave's configuration file. Add a new entry for the <code class="literal">server-id</code> option and set its value to <code class="literal">2</code>:<pre class="programlisting">
<span class="strong"><strong>server-id = 2</strong></span>
</pre></li><li class="listitem">Add an entry for the <code class="literal">read-only</code> option:<pre class="programlisting">
<span class="strong"><strong>read-only</strong></span>
</pre></li><li class="listitem">Save your changes and close the file.</li><li class="listitem">Restart the slave for the changes to take effect:<pre class="programlisting">
<span class="strong"><strong>systemctl restart mysqld.service</strong></span>
</pre></li><li class="listitem">To configure communication with the master, connect to the slave using <code class="literal">mysql</code>, and execute a <code class="literal">CHANGE MASTER</code> statement. The values should reflect those returned by <code class="literal">SHOW MASTER STATUS</code> in step 7:<pre class="programlisting">
<span class="strong"><strong>CHANGE MASTER TO</strong></span>
<span class="strong"><strong>     MASTER_HOST = "192.168.56.100",</strong></span>
<span class="strong"><strong>     MASTER_USER = "slave",</strong></span>
<span class="strong"><strong>     MASTER_PASSWORD = "S3CR3t##",    </strong></span>
<span class="strong"><strong>     MASTER_LOG_FILE = "localhost-bin.000003",</strong></span>
<span class="strong"><strong>     MASTER_LOG_POS = 1235;</strong></span>
</pre></li><li class="listitem">Start the replication process by executing <code class="literal">START SLAVE</code> on the slave system:<pre class="programlisting">
<span class="strong"><strong>START SLAVE;</strong></span>
</pre></li><li class="listitem">Execute <code class="literal">SHOW SLAVE STATUS</code> to verify replication is running. The values returned for <code class="literal">Slave_IO_Running</code> and <code class="literal">Slave_SQL_Running</code> should both be <code class="literal">Yes</code>:<pre class="programlisting">
<span class="strong"><strong>SHOW SLAVE STATUS\G</strong></span>
</pre><p><code class="literal">SHOW SLAVE STATUS</code> returns a fair amount of information-listed as a table, column wrapping makes the output impossible to read. Using <code class="literal">\G</code> to execute the statement (as opposed to the semicolon) will make <code class="literal">mysql</code> display the results vertically which, in this case, is much more readable.</p></li><li class="listitem">To stop replication, execute <code class="literal">STOP SLAVE</code> on the slave system.</li></ol></div></div><div class="section" title="How it works..."><div class="titlepage"><div><div><h2 class="title"><a id="ch07lvl2sec191"/>How it works...</h2></div></div></div><p>Configuration began in the master's <code class="literal">/etc/my.cnf</code> file, where we added the <code class="literal">server-id</code> option to give the server a numeric identifier. Each server in the replication setup uses this value to identify itself to the others, so it must be unique across the environment. Then, we uncommented the <code class="literal">log_bin</code> option to instruct the server to record the details of each change to the binary log.</p><div class="mediaobject"><img alt="How it works..." src="graphics/image_07_003.jpg"/><div class="caption"><p>The master server's configuration file sets the server identifier and enables logging</p></div></div><p>Next, we created a dedicated account on the master server and granted it the <code class="literal">REPLICATION SLAVE</code> privilege. The slave will use this account to connect to the master and read from the log:</p><pre class="programlisting">
<span class="strong"><strong>CREATE USER "slave"@"192.168.56.101" IDENTIFIED BY "S3CR3t##";</strong></span>
<span class="strong"><strong>GRANT REPLICATION SLAVE ON *.* TO "slave"@"192.168.56.101";</strong></span>
</pre><p>Finally, we executed <code class="literal">SHOW MASTER STATUS</code> command. The values of <code class="literal">File</code> and <code class="literal">Position</code> in the result identify the name of the binary log file and the server's current position in it. As the master writes to the log, the position increases and the suffix attached to the log's filename changes when the log files are rotated. We need to know the current position so we can configure the slave to begin reading/replicating from that point onward.</p><p>On the slave, we set the server's unique identifier and added the <code class="literal">read-only</code> option in the configuration file. If someone were to make a change in the slave's database that conflicts with an incoming update from the binary log, then replication would break. The <code class="literal">read-only</code> option is a safeguard that prevents users from updating the slave databases directly, ensuring all updates come from the master.</p><p>Next, we set up the slave's replication process using <code class="literal">CHANGE MASTER</code> statement. The <code class="literal">CHANGE MASTER</code> statement identifies the master, sets the username and password the slave will use to connect, and identifies the name of the log and the current position to start replicating from:</p><pre class="programlisting">
<span class="strong"><strong>CHANGE MASTER TO</strong></span>
<span class="strong"><strong>  MASTER_HOST = "192.168.56.100",</strong></span>
<span class="strong"><strong>  MASTER_USER = "slave",</strong></span>
<span class="strong"><strong>  MASTER_PASSWORD = "S3CR3t##",    </strong></span>
<span class="strong"><strong>  MASTER_LOG_FILE = "localhost-bin.000003",</strong></span>
<span class="strong"><strong>  MASTER_LOG_POS = 1235;</strong></span>
</pre><p>Replication is started with <code class="literal">START SLAVE</code> and stopped with <code class="literal">STOP SLAVE</code>. The <code class="literal">SHOW SLAVE STATUS</code> returns information about the current state of replication:</p><div class="mediaobject"><img alt="How it works..." src="graphics/image_07_004.jpg"/><div class="caption"><p>We can check the slave's status to see whether replication is running without any issues</p></div></div><p>MySQL creates two background processes when replication is running-one communicates with the master (the IO process) and the other executes the SQL statements to maintain the local database (the SQL process). The <code class="literal">Slave_IO_Running</code> value shows whether the communication process is running or not, while the value of <code class="literal">Slave_SQL_Running</code> reflects whether or not the execution process is running. Both values should be <code class="literal">Yes</code> when replication is running.</p><p>If there's a problem with replication, the <code class="literal">Last_IO_Error</code> and <code class="literal">Last_SQL_Error</code> entries will report any errors thrown for their respective processes. You can also tell how far behind the slave is from the master by comparing the values of the <code class="literal">Master_Log_File</code> and <code class="literal">Read_Master_Log_Pos</code> fields with what the <code class="literal">SHOW MASTER STATUS</code> returns.</p><p>The current configuration enables the slave to replicate every database from the master, but we can also restrict replication to certain databases by adding the <code class="literal">replicate-do-db</code> entries in the slave's <code class="literal">my.cnf</code> file. Multiple entries may be given, which will have one entry per database:</p><pre class="programlisting">
<span class="strong"><strong>replicate-do-db = packt</strong></span>
<span class="strong"><strong>replicate-do-db = acme</strong></span>
<span class="strong"><strong>replicate-do-db = sakila</strong></span>
</pre><p>Alternatively, we can use the <code class="literal">replicate-ignore-db</code> option to replicate everything except specific databases:</p><pre class="programlisting">
<span class="strong"><strong>replicate-ignore-db = mysql</strong></span>
</pre><p>Replication can be filtered at the table-level as well, targeting and ignoring specific tables in a database using the <code class="literal">replicate-do-table</code> and <code class="literal">replicate-ignore-table</code> options:</p><pre class="programlisting">
<span class="strong"><strong>replicate-do-table = acme.customers</strong></span>
<span class="strong"><strong>replicate-do-table = acme.addresses</strong></span>
</pre></div><div class="section" title="See also"><div class="titlepage"><div><div><h2 class="title"><a id="ch07lvl2sec192"/>See also</h2></div></div></div><p>Refer to the following resources for more information on replicating MySQL databases:</p><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc">MySQL 5.7 Reference Manual: Replication (<a class="ulink" href="http://dev.mysql.com/doc/refman/5.7/en/replication.html">http://dev.mysql.com/doc/refman/5.7/en/replication.html</a>)</li><li class="listitem" style="list-style-type: disc">MySQL Replication on RHEL 7 (<a class="ulink" href="https://www.youtube.com/watch?v=kIfRXshR2zc">https://www.youtube.com/watch?v=kIfRXshR2zc</a>)</li><li class="listitem" style="list-style-type: disc">MySQL High Availability Architectures (<a class="ulink" href="http://skillachie.com/2014/07/25/mysql-high-availability-architectures">http://skillachie.com/2014/07/25/mysql-high-availability-architectures</a>)</li><li class="listitem" style="list-style-type: disc">Replication Tips and Tricks in MySQL (<a class="ulink" href="http://www.linux-mag.com/id/1661/">http://www.linux-mag.com/id/1661/</a>)</li></ul></div></div></div>
<div class="section" title="Standing up a MySQL cluster"><div class="titlepage"><div><div><h1 class="title"><a id="ch07lvl1sec61"/>Standing up a MySQL cluster</h1></div></div></div><p>This recipe guides you through the process of setting up a MySQL cluster. Clustered databases meet the challenges of scalability and high-availability by partitioning the data across multiple systems and maintaining replicas to avoid single points of failure.</p><p>The members of a cluster are referred to as nodes. There are three node types in a MySQL cluster: data nodes, API nodes, and the management node. Data nodes are responsible for storing data. Users and processes then connect to an API node to access the database. The management node manages the cluster as a whole. Although multiple nodes can be installed on the same system, for example, both an API node and a data node may be hosted on the same system. However, hosting multiple data nodes on the same system is obviously not a good idea because it negates MySQL's efforts to distribute the data.</p><div class="section" title="Getting ready"><div class="titlepage"><div><div><h2 class="title"><a id="ch07lvl2sec193"/>Getting ready</h2></div></div></div><p>This recipe demonstrates how to deploy a MySQL cluster using four systems. The first system will host the management node and we'll assume that it has the IP address <code class="literal">192.168.56.100</code>. The second system will host the API node and have the address <code class="literal">192.168.56.101</code>. The remaining systems will be configured with data nodes and use the addresses <code class="literal">192.168.56.102</code> and <code class="literal">192.168.56.103</code>. You'll need administrative access on all four systems either using the <code class="literal">root</code> account or <code class="literal">sudo</code>.</p></div><div class="section" title="How to do it..."><div class="titlepage"><div><div><h2 class="title"><a id="ch07lvl2sec194"/>How to do it...</h2></div></div></div><p>Follow these steps to set up a clustered MySQL database:</p><div class="orderedlist"><ol class="orderedlist arabic"><li class="listitem">Download the cluster archive from the MySQL website and extract its packages using <code class="literal">tar</code>:<pre class="programlisting">
<span class="strong"><strong>curl -L dev.mysql.com/get/Downloads/MySQL-Cluster-7.4/  &#13;
       MySQL-Cluster-gpl-7.4.10-1.el7.x86_64.rpm-bundle.tar | tar  x</strong></span>
</pre></li><li class="listitem">On each system, install <code class="literal">perl-Data-Dumper</code> and replace the installed <code class="literal">mariadb-libs</code> package with the downloaded <code class="literal">MySQL-Cluster-shared</code> package:<pre class="programlisting">
<span class="strong"><strong>yum install perl-Data-Dumper MySQL-Cluster-shared-gpl-*.rpm</strong></span>
<span class="strong"><strong>yum erase mariadb-libs</strong></span>
</pre></li><li class="listitem">Install the <code class="literal">MySQL-Cluster-server</code> and <code class="literal">MySQL-Cluster-client</code> packages on each system:<pre class="programlisting">
<span class="strong"><strong>yum install MySQL-Cluster-{server,client}-gpl-*.rpm</strong></span>
</pre></li><li class="listitem">On the system hosting the management node, create the <code class="literal">/var/lib/mysql-cluster</code> directory:<pre class="programlisting">
<span class="strong"><strong>mkdir /var/lib/mysql-cluster</strong></span>
</pre></li><li class="listitem">Create the cluster's configuration file for the management node at <code class="literal">/var/lib/mysql-cluster/config.ini</code> as follows:<pre class="programlisting">
<span class="strong"><strong>[ndbd default]</strong></span>
<span class="strong"><strong>NoOfReplicas = 2</strong></span>
<span class="strong"><strong>DataMemory = 100M</strong></span>
<span class="strong"><strong>IndexMemory = 10M</strong></span>
<span class="strong"><strong>ServerPort = 2202</strong></span>
<span class="strong"><strong>[ndb_mgmd]</strong></span>
<span class="strong"><strong>hostname = 192.168.56.100</strong></span>
<span class="strong"><strong>[mysqld]</strong></span>
<span class="strong"><strong>hostname = 192.168.56.101</strong></span>
<span class="strong"><strong>[ndbd]</strong></span>
<span class="strong"><strong>hostname = 192.168.56.102</strong></span>
<span class="strong"><strong>[ndbd]</strong></span>
<span class="strong"><strong>hostname = 192.168.56.103</strong></span>
</pre></li><li class="listitem">Start the management node:<pre class="programlisting">
<span class="strong"><strong>ndb_mgmd -f /var/lib/mysql-cluster/config.ini</strong></span>
</pre></li><li class="listitem">Open port <code class="literal">1186</code> in the management node system's firewall:<pre class="programlisting">
<span class="strong"><strong>firewall-cmd --zone=public --permanent --add-port=1186/tcp</strong></span>
<span class="strong"><strong>firewall-cmd --reload</strong></span>
</pre></li><li class="listitem">On each data node's system, create the file <code class="literal">/etc/my.cnf</code> using the following:<pre class="programlisting">
<span class="strong"><strong>[mysql_cluster]</strong></span>
<span class="strong"><strong>ndb-connectstring = 192.168.56.100</strong></span>
</pre></li><li class="listitem">Start each data node:<pre class="programlisting">
<span class="strong"><strong>ndbd</strong></span>
</pre></li><li class="listitem">Open port <code class="literal">2202</code> in the data nodes' systems' firewall:<pre class="programlisting">
<span class="strong"><strong>firewall-cmd --zone=public --permanent --add-port=2202/tcp</strong></span>
<span class="strong"><strong>firewall-cmd --reload</strong></span>
</pre></li><li class="listitem">Create <code class="literal">/etc/my.cnf</code> on the system hosting the API node using the following:<pre class="programlisting">
<span class="strong"><strong>[mysqld]</strong></span>
<span class="strong"><strong>ndbcluster</strong></span>
<span class="strong"><strong>default-storage-engine = ndbcluster</strong></span>
<span class="strong"><strong>[mysql_cluster]</strong></span>
<span class="strong"><strong>ndb-connectstring = 192.168.56.100</strong></span>
</pre></li><li class="listitem">Start MySQL server as the API node:<pre class="programlisting">
<span class="strong"><strong>mysqld_safe &amp;</strong></span>
</pre></li><li class="listitem">Retrieve the <code class="literal">root</code> account's temporary password that was created when the MySQL server was installed. It's recorded in <code class="literal">/root/.mysql_secret</code>:<pre class="programlisting">
<span class="strong"><strong>cat /root/.mysql_secret</strong></span>
</pre></li><li class="listitem">Set a new password for the root account using <code class="literal">mysqladmin</code>. When prompted for the current password, enter the one identified in the previous step:<pre class="programlisting">
<span class="strong"><strong>mysqladmin -u root -p password</strong></span>
</pre></li><li class="listitem">Open port <code class="literal">3306</code> in the API node system's firewall:<pre class="programlisting">
<span class="strong"><strong>firewall-cmd --zone=public --permanent --add-service=mysql</strong></span>
<span class="strong"><strong>firewall-cmd --reload</strong></span>
</pre></li><li class="listitem">Verify the status of the cluster using the <code class="literal">ndb_mgm</code> client on the system hosting the management node:<pre class="programlisting">
<span class="strong"><strong>ndb_mgm -e SHOW</strong></span>
</pre></li></ol></div></div><div class="section" title="How it works..."><div class="titlepage"><div><div><h2 class="title"><a id="ch07lvl2sec195"/>How it works...</h2></div></div></div><p>This recipe taught you how to set up a MySQL clustered database with two data nodes: one API node and one management node. The management node consists of the <code class="literal">ndb_mgmd</code> process that provides configuration information to the other nodes and monitors them. On the data nodes, the <code class="literal">ndbd</code> process handles the storage, partitioning, and replication of the clustered data. A MySQL server aware of the management node and the data nodes acts as the API node through which users can work with the clustered database.</p><p>The packages available in the Oracle-maintained repository are built without support for Network Database (NDB), so we first downloaded an archive from the MySQL website that has packages which will install a version of MySQL that supports NDB/clustering:</p><pre class="programlisting">
<span class="strong"><strong>curl -L dev.mysql.com/get/Downloads/MySQL-Cluster-7.4/MySQL- &#13;
Cluster-gpl-7.4.10-1.el7.x86_64.rpm-bundle.tar | tar x</strong></span>
</pre><p>MySQL abstracts the details of exactly how data is physically organized and manipulated, delegating this to its various storage engines. Different engines have different abilities. Since the NDB engine is the one that implements clustering, we need a build that supports the engine. Instead of writing curl's output to a file as we've done in other recipes, this time we piped the output directly to <code class="literal">tar</code> with the <code class="literal">x</code> argument to expand the archive on the fly.</p><p>Afterwards, we installed the <code class="literal">perl-Data-Dumper</code> package from the CentOS repository and replaced the <code class="literal">mariadb-libs</code> package already installed with the just downloaded <code class="literal">MySQL-Cluster-shared</code> package on each system:</p><pre class="programlisting">
<span class="strong"><strong>yum install perl-Data-Dumper MySQL-Cluster-shared-gpl-*.rpm</strong></span>
<span class="strong"><strong>yum erase mariadb-libs</strong></span>
</pre><p>The <code class="literal">MySQL-Cluster-shared</code> package provides the shared libraries used by other programs to work with MySQL. These libraries replace the MariaDB version installed from the CentOS repositories by default and save us from experiencing library conflicts that would prevent a clean install. Since it's no longer needed afterwards, we uninstalled the <code class="literal">mariadb-libs</code> package.</p><p>Some of the post-installation steps performed by Yum after it installs the <code class="literal">MySQL-Cluster-server</code> package are scripted in Perl and use Perl's <code class="literal">Data::Dumper</code> module. This makes the <code class="literal">Perl-Data-Dumper</code> package a dependency for the <code class="literal">MySQL-Cluster-server</code> package. However, a bug causes Yum to miss this, so we installed the package ourselves so that the <code class="literal">MySQL-Cluster-server</code> package's installation will proceed smoothly. It wouldn't prevent the package from installing, but it would have required us to complete some additional configuration steps manually.</p><p>With the requirements in place, we then installed the <code class="literal">MySQL-Cluster-server</code> and <code class="literal">MySQL-Cluster-client</code> packages on each system:</p><pre class="programlisting">
<span class="strong"><strong>yum install MySQL-Cluster-{server,client}-gpl-*.rpm</strong></span>
</pre><p>Configuration for the overall cluster is pretty much centralized with the management node in <code class="literal">/var/lib/mysql-cluster/config.ini</code>. The file is divided into several sections, the first being <code class="literal">[ndb default]</code>, which provides the default configuration values that should be used for the cluster. The values here apply to each node of the cluster unless overridden by a more specific directive in the respective node's configuration section:</p><pre class="programlisting">
<span class="strong"><strong>[ndbd default]</strong></span>
<span class="strong"><strong>NoOfReplicas = 2</strong></span>
<span class="strong"><strong>DataMemory = 100M</strong></span>
<span class="strong"><strong>IndexMemory = 10M</strong></span>
<span class="strong"><strong>ServerPort = 2202</strong></span>
</pre><p>The <code class="literal">NoOfReplicas</code> option sets the number of replicas in the cluster. Its value may be set to <code class="literal">1</code> or <code class="literal">2</code>, although <code class="literal">2</code> is the recommended value. Recall that not only a clustered database is partitioned across the data nodes but it is also replicated; each node hosts a partition typically <span class="emphasis"><em>1/n</em></span> the size of the database (where <span class="emphasis"><em>n</em></span> is the number of data nodes) and also a replica of the other nodes. The cluster can still function if a system goes offline because its data is still available in the replica. A value of <code class="literal">1</code> for <code class="literal">NoOfReplicas</code> means that there would be only one copy of the database (no replica) and the availability of the database depends on all data nodes being up.</p><p>The data nodes hold their working copy of the database in RAM to reduce latency while periodically syncing the data to disk. The <code class="literal">DataMemory</code> option specifies how much RAM should be reserved for the data by the nodes and <code class="literal">IndexMemory</code> specifies how much memory should be reserved for primary keys and unique indexes. Whatever values you provide, be sure that sufficient resources are available to avoid RAM swapping.</p><p>The <code class="literal">ServerPort</code> option specifies the port number the nodes will use to communicate with one another. By default, MySQL would dynamically allocate ports to make it easier to run multiple nodes on the same system, but since this recipe runs each node on its own host system and we need to know the port to allow traffic through the firewall, we specified the port ourselves.</p><p>The subsequent sections in the configuration use the <code class="literal">hostname</code> option to specify the addresses at which the management node (via the <code class="literal">[ndb_mgmtd]</code> section), the API node (the <code class="literal">[mysqld]</code> section), and the data nodes (the <code class="literal">[ndbd]</code> section) are running. As made evident by the multiple <code class="literal">[ndbd]</code> sections, multiple sections of the same type will appear if there is more than one node of that type running in the cluster:</p><pre class="programlisting">
<span class="strong"><strong>[ndb_mgmd]</strong></span>
<span class="strong"><strong>hostname = 192.168.56.100</strong></span>
<span class="strong"><strong>[mysqld]</strong></span>
<span class="strong"><strong>hostname = 192.168.56.101</strong></span>
<span class="strong"><strong>[ndbd]</strong></span>
<span class="strong"><strong>hostname = 192.168.56.102</strong></span>
<span class="strong"><strong>[ndbd]</strong></span>
<span class="strong"><strong>hostname = 192.168.56.103</strong></span>
</pre><p>On the remaining systems, <code class="literal">/etc/my.cnf</code> is created as the configuration file used by the data nodes and the API node. Each includes a <code class="literal">[mysql_cluster]</code> section, which gives the <code class="literal">ndb-connectstring</code> option:</p><pre class="programlisting">
<span class="strong"><strong>[mysql_cluster]</strong></span>
<span class="strong"><strong>ndb-connectstring = 192.168.56.100</strong></span>
</pre><p>The <code class="literal">ndb-connectstring</code> option specifies the address of the system that hosts the management node. As the data and API nodes come online, they communicate with the manager to receive their configuration information. If your cluster has more than one management node, the additional nodes can be listed in the connection string separated by commas:</p><pre class="programlisting">
<span class="strong"><strong>ndb-connectstring = "192.168.56.100,192.168.56.105,192.168.56.106"</strong></span>
</pre><p>Additionally, the API node's configuration includes the <code class="literal">[mysqld]</code> section. It includes the <code class="literal">ndbcluster</code> option to enable the NDB engine and the <code class="literal">default-storage-engine</code> option instructing MySQL to use NDB to manage all new tables unless otherwise specified in the table's <code class="literal">CREATE TABLE</code> statement:</p><pre class="programlisting">
<span class="strong"><strong>[mysqld]</strong></span>
<span class="strong"><strong>ndbcluster</strong></span>
<span class="strong"><strong>default-storage-engine = ndbcluster</strong></span>
</pre><p>When a user or process creates a new table with the <code class="literal">CREATE TABLE</code> statement, they can specify which of MySQL's storage engines should be used to manage its data with the <code class="literal">ENGINE</code> directive, for example:</p><pre class="programlisting">
<span class="strong"><strong>CREATE TABLE users (</strong></span>
<span class="strong"><strong>    id INTEGER UNSIGNED NOT NULL PRIMARY KEY,</strong></span>
<span class="strong"><strong>    first_name VARCHAR(50) NOT NULL DEFAULT '',</strong></span>
<span class="strong"><strong>    last_name VARCHAR(50) NOT NULL DEFAULT ''</strong></span>
<span class="strong"><strong>)</strong></span>
<span class="strong"><strong>ENGINE = NDBCluster;</strong></span>
</pre><p>The default engine is InnoDB engine. However, only data in NDB-managed tables make their way to the cluster. If a table is managed by another engine, the data resides locally on the API node and is not available to other nodes in the cluster. To prevent unexpected problems and any confusion this can cause, we changed the default engine so that tables will use the NDB engine when the <code class="literal">ENGINE</code> directive isn't provided.</p><p>The order in which nodes are started when bringing up the MySQL cluster is important, since one node may depend on the others. The management node is started first, followed by the data nodes, and then the API node.</p><p>The password for MySQL's root account on the API node is randomly generated the first time the server is started, and it is written to the <code class="literal">/root/.mysql_secret</code> file, just as we used <code class="literal">mysqladmin</code> to change it in the <span class="emphasis"><em>Setting up a MySQL database</em></span> recipe:</p><pre class="programlisting">
<span class="strong"><strong>cat /root/.mysql_secret</strong></span>
<span class="strong"><strong>mysqladmin -u root -p password</strong></span>
</pre><p>The <code class="literal">SHOW</code> command sent to the <code class="literal">ndb_mgm</code> client on the management node's system allows us to view the status of the cluster and ensure everything is up and running as it should be. The client can be invoked in interactive mode, or commands can be passed to it directly using the <code class="literal">-e</code> argument:</p><pre class="programlisting">
<span class="strong"><strong>ndb_mgm -e SHOW</strong></span>
</pre><div class="mediaobject"><img alt="How it works..." src="graphics/image_07_005.jpg"/><div class="caption"><p>The status of the MySQL cluster can be viewed using the ndb_mgm client</p></div></div></div><div class="section" title="See also"><div class="titlepage"><div><div><h2 class="title"><a id="ch07lvl2sec196"/>See also</h2></div></div></div><p>Refer to the following resources for more information on working with MySQL clusters:</p><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc">MySQL Reference Manual: MySQL Cluster Core Concepts (<a class="ulink" href="http://dev.mysql.com/doc/refman/5.7/en/mysql-cluster-basics.html">http://dev.mysql.com/doc/refman/5.7/en/mysql-cluster-basics.html</a>)</li><li class="listitem" style="list-style-type: disc">MySQL Reference Manual: MySQL Cluster Installation (<a class="ulink" href="http://dev.mysql.com/doc/refman/5.7/en/mysql-cluster-installation.htm">http://dev.mysql.com/doc/refman/5.7/en/mysql-cluster-installation.htm</a>l)</li><li class="listitem" style="list-style-type: disc">MySQL Reference Manual: MySQL Cluster Nodes, Node Groups, Replicas, and Partitions (<a class="ulink" href="http://dev.mysql.com/doc/refman/5.7/en/mysql-cluster-nodes-groups.html">http://dev.mysql.com/doc/refman/5.7/en/mysql-cluster-nodes-groups.html</a>)</li><li class="listitem" style="list-style-type: disc">MySQL Reference Manual: Online Backup of MySQL Cluster (<a class="ulink" href="http://dev.mysql.com/doc/refman/5.7/en/mysql-cluster-backup.html">http://dev.mysql.com/doc/refman/5.7/en/mysql-cluster-backup.html</a>)</li><li class="listitem" style="list-style-type: disc">Set Up a MySQL Cluster the Easy Way (<a class="ulink" href="http://youtube.com/watch?v=64jtbkuPtv">http://youtube.com/watch?v=64jtbkuPtv</a>c)</li><li class="listitem" style="list-style-type: disc"><span class="emphasis"><em>High Availability MySQL Cookbook</em></span> by Alex Davies (<a class="ulink" href="https://www.packtpub.com/big-data-and-business-intelligence/high-availability-mysql-cookbook">https://www.packtpub.com/big-data-and-business-intelligence/high-availability-mysql-cookbook</a>)</li></ul></div></div></div>
<div class="section" title="Setting up a MongoDB database"><div class="titlepage"><div><div><h1 class="title"><a id="ch07lvl1sec62"/>Setting up a MongoDB database</h1></div></div></div><p>Although relational databases have dominated the world of data storage, there have always been other systems that specialize in alternative ways of working with data, for example document and object-oriented databases, key-value databases, and hierarchical databases. The popularity of these alternative databases has experienced a resurgence thanks to the recent <span class="emphasis"><em>NoSQL</em></span> and <span class="emphasis"><em>Big Data</em></span> movements. This recipe teaches you how to install MongoDB, a modern document-oriented database system.</p><div class="section" title="Getting ready"><div class="titlepage"><div><div><h2 class="title"><a id="ch07lvl2sec197"/>Getting ready</h2></div></div></div><p>This recipe requires a CentOS system with a working network connection and administrative privileges by either using the <code class="literal">root</code> account or <code class="literal">sudo</code>. It also assumes you have registered the EPEL repository (see the <span class="emphasis"><em>Registering the EPEL and Remi repositories</em></span> recipe in <a class="link" href="ch04.html" title="Chapter 4. Software Installation Management">Chapter 4</a>, <span class="emphasis"><em>Software Installation Management</em></span>).</p></div><div class="section" title="How to do it…"><div class="titlepage"><div><div><h2 class="title"><a id="ch07lvl2sec198"/>How to do it…</h2></div></div></div><p>Follow these steps to install MongoDB and create a new database:</p><div class="orderedlist"><ol class="orderedlist arabic"><li class="listitem">Install the <code class="literal">mongodb-server</code> and <code class="literal">mongodb</code> packages from the EPEL repository:<pre class="programlisting">
<span class="strong"><strong>yum install mongodb-server mongodb</strong></span>
</pre></li><li class="listitem">Open <code class="literal">/etc/mongod.conf</code> with your text editor:<pre class="programlisting">
<span class="strong"><strong>vi /etc/mongod.conf</strong></span>
</pre></li><li class="listitem">Locate the <code class="literal">auth</code> entry and uncomment it, making sure its value is <code class="literal">true</code>:<pre class="programlisting">
<span class="strong"><strong># Run with/without security</strong></span>
<span class="strong"><strong>auth = true</strong></span>
</pre></li><li class="listitem">Locate the <code class="literal">bind-ip</code> option and comment it out:<pre class="programlisting">
<span class="strong"><strong>       # Comma separated list of ip addresses to listen on &#13;
       # bind_ip = 127.0.0.1</strong></span>
</pre></li><li class="listitem">Save your changes to the configuration file and close it.</li><li class="listitem">Start the MongoDB server and enable it to start automatically whenever the system reboots:<pre class="programlisting">
<span class="strong"><strong>systemctl start mongod.service</strong></span>
<span class="strong"><strong>systemctl enable mongod.service</strong></span>
</pre></li><li class="listitem">Open port <code class="literal">27017</code> in the system's firewall:<pre class="programlisting">
<span class="strong"><strong>firewall-cmd --zone=public --permanent --add-port=27017/tcp</strong></span>
<span class="strong"><strong>firewall-cmd --reload</strong></span>
</pre></li><li class="listitem">Connect to the MongoDB server with <code class="literal">mongo</code>:<pre class="programlisting">
<span class="strong"><strong>mongo</strong></span>
</pre></li><li class="listitem">Set <code class="literal">admin</code> as the active database:<pre class="programlisting">
<span class="strong"><strong>use admin</strong></span>
</pre></li><li class="listitem">Execute <code class="literal">createUser()</code> to create a new user for managing user accounts:<pre class="programlisting">
<span class="strong"><strong>db.createUser({</strong></span>
<span class="strong"><strong>  user: "admin",</strong></span>
<span class="strong"><strong>     pwd: "P@$$W0rd",</strong></span>
<span class="strong"><strong>     roles: [{ role: "userAdminAnyDatabase", db: "admin" }]</strong></span>
<span class="strong"><strong>})</strong></span>
</pre></li><li class="listitem">Authenticate yourself using the newly created <code class="literal">admin</code> account:<pre class="programlisting">
<span class="strong"><strong>db.auth({ user: "admin", pwd: "P@$$W0rd" })</strong></span>
</pre></li><li class="listitem">Set <code class="literal">packt</code> as the active database:<pre class="programlisting">
<span class="strong"><strong>use packt</strong></span>
</pre></li><li class="listitem">Create a user account for working with the database:<pre class="programlisting">
<span class="strong"><strong>db.createUser({</strong></span>
<span class="strong"><strong>  user: "tboronczyk",</strong></span>
<span class="strong"><strong>     pwd: "S3CR3t##",</strong></span>
<span class="strong"><strong>     roles: [{ role: "readWrite", db: "packt" }]</strong></span>
<span class="strong"><strong>})</strong></span>
</pre></li><li class="listitem">Exit the client and return to the terminal:<pre class="programlisting">
<span class="strong"><strong>exit</strong></span>
</pre></li></ol></div></div><div class="section" title="How it works..."><div class="titlepage"><div><div><h2 class="title"><a id="ch07lvl2sec199"/>How it works...</h2></div></div></div><p>MongoDB is the most popular in its class of databases and is used by many high-profile companies, including eBay, Craigslist, SAP, and Yandex. The necessary packages are available in the EPEL repository; <code class="literal">mongodb-server</code> contains the MongoDB server application and the <code class="literal">mongodb</code> package contains the client and other utilities for working with the server and databases:</p><pre class="programlisting">
<span class="strong"><strong>yum install mongodb-server mongodb</strong></span>
</pre><p>MongoDB runs without security enabled by default and anyone may perform any action against any database. To prevent this, we enabled security by uncommenting the <code class="literal">auth</code> option in MongoDB's configuration file (<code class="literal">/etc/mongod.conf</code>). Once security is enabled, users must authenticate themselves before they can work with a database, and the server verifies that the account has the right to perform the requested action:</p><pre class="programlisting">
<span class="strong"><strong>auth = true</strong></span>
</pre><p>The current configuration permits MongoDB to listen for connections only on the loop-back interface (<code class="literal">127.0.0.1</code>), so we also commented out the <code class="literal">bind_ip</code> option:</p><pre class="programlisting">
<span class="strong"><strong># bind_ip = 127.0.0.1</strong></span>
</pre><p>Left unbound, MongoDB will be accessible via all of the system's addresses. Alternatively, if the system has multiple addresses (perhaps the system has multiple interfaces or you've implemented the <span class="emphasis"><em>Binding multiple addresses to a single Ethernet device</em></span> recipe in <a class="link" href="ch02.html" title="Chapter 2. Networking">Chapter 2</a>, <span class="emphasis"><em>Networking</em></span>) and you want MongoDB to respond on only one of them, you can leave the option active with the desired IP address as its value.</p><p>After updating the configuration file, we started the server and opened MongoDB's default port in the system's firewall to allow remote connections:</p><pre class="programlisting">
<span class="strong"><strong>firewall-cmd --zone=public --permanent --add-port=27017/tcp</strong></span>
<span class="strong"><strong>firewall-cmd --reload</strong></span>
</pre><p>Next, we used the <code class="literal">mongo</code> client to establish a connection to the MongoDB server running on the localhost:</p><pre class="programlisting">
<span class="strong"><strong>mongo</strong></span>
</pre><p>We set <code class="literal">admin</code> as the active database and executed the <code class="literal">createUser()</code> method to create an administrator account dedicated to managing MongoDB's database users:</p><pre class="programlisting">
<span class="strong"><strong>use admin</strong></span>
<span class="strong"><strong>db.createUser({</strong></span>
<span class="strong"><strong>  user: "admin",</strong></span>
<span class="strong"><strong>  pwd: "P@$$W0rd",</strong></span>
<span class="strong"><strong>  roles: [{ role: "userAdminAnyDatabase", db: "admin" }]</strong></span>
<span class="strong"><strong>})</strong></span>
</pre><p>The <code class="literal">createUser()</code> method accepts a document with properties listing the new account's username (<code class="literal">user</code>), password (<code class="literal">pwd</code>), and roles (<code class="literal">roles</code>) and adds it to the <code class="literal">system.users</code> collection in the active database (<code class="literal">admin</code>). User accounts are stored at the database level and the database storing a user's details is known as that user's authentication database. Users may work with other databases, but they must authenticate against their authentication database first. Even if their usernames are the same, accounts created in different databases are considered separate and may have different permissions.</p><p>The <code class="literal">roles</code> property is an array of objects, each listing a role that the user is a member of when they work with the given database. In the case of <code class="literal">admin</code>, the user is a member of the <code class="literal">userAdminAnyDatabase</code> role. MongoDB's permission system is based on role-based access control (RBAC). The focus of RBAC is on users and what roles they play as opposed to granting individual permissions to each account. Permissions are assigned to a role and then user accounts are given membership in the role inheriting its permissions.</p><p><code class="literal">userAdminAnyDatabase</code> is a built-in role configured with the necessary permissions to create and delete user accounts, assign membership in a role, and manage user passwords for any database. MongoDB ships with several predefined roles besides <code class="literal">userAdminAnyDatabase</code>. They include the following:</p><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc"><code class="literal">dbAdmin</code>: These users are responsible for administering the database</li><li class="listitem" style="list-style-type: disc"><code class="literal">userAdmin</code>: These users are responsible for administering other users</li><li class="listitem" style="list-style-type: disc"><code class="literal">read</code>: These are users that only read documents from the database</li><li class="listitem" style="list-style-type: disc"><code class="literal">readWrite</code>: These are users who read documents and also need write access to insert/modify them</li><li class="listitem" style="list-style-type: disc"><code class="literal">dbOwner</code>: These are users who own the database (combines the <code class="literal">dbAdmin</code>, <code class="literal">userAdmin</code>, and <code class="literal">readWrite</code> roles)</li></ul></div><p>There are also the <code class="literal">backup</code> and <code class="literal">restore</code> roles for users responsible for performing database backups, roles for managing MongoDB clusters, and additional global versions of some of the aforementioned roles, such as <code class="literal">readAnyDatabase</code>, for users who need read-access to all of MongoDB's databases. A complete list of roles can be found in the official documentation online at <a class="ulink" href="https://docs.mongodb.com/manual/reference/built-in-roles/">https://docs.mongodb.com/manual/reference/built-in-roles/</a>.</p><div class="note" style="" title="Note"><div class="inner"><h3 class="title"><a id="note49"/>Note</h3><p>The principles of least privilege encourage us to avoid over-using the global roles; it's better to create users that work with their own databases. If an account needs to work with a database outside its authentication database, multiple roles can be assigned as follows:</p><p>
</p><pre class="programlisting">  <span class="strong"><strong>db.createUser({</strong></span>
<span class="strong"><strong>     user: "tboronczyk",</strong></span>
<span class="strong"><strong>     pwd: "S3CR3t##",</strong></span>
<span class="strong"><strong>     roles: [</strong></span>
<span class="strong"><strong>       { role: "read", db: "admin" },</strong></span>
<span class="strong"><strong>       { role: "readWrite", db: "packt" },</strong></span>
<span class="strong"><strong>       { role: "readWrite", db: "acme" }</strong></span>
<span class="strong"><strong>     ]</strong></span>
<span class="strong"><strong>   })</strong></span>
</pre><p>
</p></div></div><p>Next, we used the new <code class="literal">admin</code> user to create a new user for the <code class="literal">packt</code> database (and to create the <code class="literal">packt</code> database itself as a side effect):</p><pre class="programlisting">
<span class="strong"><strong>db.auth("admin", "P@$$W0rd")</strong></span>
<span class="strong"><strong>use packt</strong></span>
<span class="strong"><strong>db.createUser({</strong></span>
<span class="strong"><strong>  user: "tboronczyk",</strong></span>
<span class="strong"><strong>  pwd: "S3CR3t##",</strong></span>
<span class="strong"><strong>  roles: [{ role: "readWrite", db: "packt" }]</strong></span>
<span class="strong"><strong>})</strong></span>
</pre><p>Databases and collections are implicitly created by MongoDB when the first document is inserted, and since MongoDB stores new users in the active database, setting <code class="literal">packt</code> as the active database and creating a user is enough to trigger its creation.</p><p>The <code class="literal">auth()</code> method assumes that the active database is the authentication database for the provided credentials. In this instance, authentication is successful because <code class="literal">admin</code> was already the active database; attempting to authenticate as <code class="literal">admin</code> after switching to <code class="literal">packt</code> would fail. However, the identity persists after authentication until the next time we call <code class="literal">auth()</code> or we exit the client. So, even though we switched databases, we're still operating within the roles and privileges of the <code class="literal">admin</code> database's <code class="literal">admin</code> user.</p><p>Although the recipe connected to the server with a bare <code class="literal">mongo</code> invocation, the active database can be specified on the command line. <code class="literal">mongo</code> also offers several options, for example, to connect to a MongoDB server running on a different system and provide authentication credentials. <code class="literal">--host</code> identifies the remote hostname or IP address where MongoDB is running, and the <code class="literal">--username</code> and <code class="literal">--password</code> options allow you to provide your account's authentication details:</p><pre class="programlisting">
<span class="strong"><strong>mongo --host 192.168.56.100 --username tboronczyk --password ""  packt</strong></span>
</pre><p>If the database is given in the invocation when <code class="literal">--username</code> and <code class="literal">--password</code> are used as well, MongoDB assumes that the database is the account's authentication database. If the account belongs to another database, its authentication database can be given using the <code class="literal">--authenticationDatabase</code> option:</p><pre class="programlisting">
<span class="strong"><strong>mongo --authenticationDatabase admin --username admin --password &#13;
    ""  packt</strong></span>
</pre><p>The <code class="literal">--password</code> option expects a value, but MongoDB will prompt you for a password when its value is empty. I suggest that you use an empty string (<code class="literal">""</code>) for the value, as I have done here, to force the password prompt.</p><div class="note" style="" title="Note"><div class="inner"><h3 class="title"><a id="note50"/>Note</h3><p>Never enter a password as part of a command's invocation for security reasons. The password may appear in the output of <code class="literal">ps</code> while the command is running and will also appear in your shell's history.</p></div></div></div><div class="section" title="See also"><div class="titlepage"><div><div><h2 class="title"><a id="ch07lvl2sec200"/>See also</h2></div></div></div><p>Refer to the following resources for more information on working with MongoDB:</p><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc">The MongoDB manual (<a class="ulink" href="http://docs.mongodb.org/manual">http://docs.mongodb.org/manual</a>)</li><li class="listitem" style="list-style-type: disc">MongoDB Manual: Role-Based Access Control (<a class="ulink" href="http://docs.mongodb.org/manual/core/authorization">http://docs.mongodb.org/manual/core/authorization</a>)</li><li class="listitem" style="list-style-type: disc">MongoDB Tutorial for Beginners (<a class="ulink" href="http://www.youtube.com/watch?v=W-WihPoEbR4">http://www.youtube.com/watch?v=W-WihPoEbR4</a>)</li><li class="listitem" style="list-style-type: disc">Wikipedia: Role-based access control (<a class="ulink" href="https://en.wikipedia.org/wiki/Role-based_access_control">https://en.wikipedia.org/wiki/Role-based_access_control</a>)</li></ul></div></div></div>
<div class="section" title="Backing up and restoring a MongoDB database"><div class="titlepage"><div><div><h1 class="title"><a id="ch07lvl1sec63"/>Backing up and restoring a MongoDB database</h1></div></div></div><p>This recipe teaches you how to back up a MongoDB database using the <code class="literal">mongodump</code> utility and restore it using <code class="literal">mongorestore</code>.</p><div class="section" title="Getting ready"><div class="titlepage"><div><div><h2 class="title"><a id="ch07lvl2sec201"/>Getting ready</h2></div></div></div><p>This recipe requires a running MongoDB server and access to a user account with membership in the <code class="literal">userAdmin</code> role.</p></div><div class="section" title="How to do it..."><div class="titlepage"><div><div><h2 class="title"><a id="ch07lvl2sec202"/>How to do it...</h2></div></div></div><p>Follow these steps to back up a MongoDB database:</p><div class="orderedlist"><ol class="orderedlist arabic"><li class="listitem">Connect to MongoDB as a user with membership in the <code class="literal">userAdmin</code> role:<pre class="programlisting">
<span class="strong"><strong>mongo --username admin --password "" admin</strong></span>
</pre></li><li class="listitem">Create an account with membership in the <code class="literal">backup</code> and <code class="literal">restore</code> roles to be used for creating and restoring backups:<pre class="programlisting">
<span class="strong"><strong>db.createUser({</strong></span>
<span class="strong"><strong>     user: "backupusr",</strong></span>
<span class="strong"><strong>     pwd: "B@CK&amp;4th",</strong></span>
<span class="strong"><strong>     roles: [</strong></span>
<span class="strong"><strong>       { role: "backup", db: "admin" },</strong></span>
<span class="strong"><strong>       { role: "restore", db: "admin" }</strong></span>
<span class="strong"><strong>     ]</strong></span>
<span class="strong"><strong>})</strong></span>
</pre></li><li class="listitem">Use <code class="literal">mongodump</code> on the command-line to export a MongoDB database:<pre class="programlisting">
<span class="strong"><strong>mongodump --authenticationDatabase admin --username  backupusr &#13;
       --password "" --db packt</strong></span>
</pre></li><li class="listitem">To restore a database from the backup made by <code class="literal">mongodump</code>, use the <code class="literal">mongorestore</code> program:<pre class="programlisting">
<span class="strong"><strong>mongorestore --authenticationDatabase admin --username  backupusr&#13;
       --password "" --drop --db packt dump/packt</strong></span>
</pre></li></ol></div></div><div class="section" title="How it works..."><div class="titlepage"><div><div><h2 class="title"><a id="ch07lvl2sec203"/>How it works...</h2></div></div></div><p>The account used to make a backup must have the privileges assigned to the <code class="literal">backup</code> role and the restore account must have those assigned to the <code class="literal">restore</code> role. So, we connected to the MongoDB server and created an account with membership in both roles prior to using the utilities:</p><pre class="programlisting">
<span class="strong"><strong>db.createUser({</strong></span>
<span class="strong"><strong>  user: "backupusr",</strong></span>
<span class="strong"><strong>  pwd: "B@CK&amp;4th",</strong></span>
<span class="strong"><strong>  roles: [</strong></span>
<span class="strong"><strong>    { role: "backup", db: "admin" },</strong></span>
<span class="strong"><strong>    { role: "restore", db: "admin" }</strong></span>
<span class="strong"><strong>  ]</strong></span>
<span class="strong"><strong>})</strong></span>
</pre><p>The new account is then used with <code class="literal">mongodump</code> to back up our database:</p><pre class="programlisting">
<span class="strong"><strong>mongodump --authenticationDatabase admin --username backupusr &#13;
    --password "" --db packt</strong></span>
</pre><p>The preceding invocation exports everything in the <code class="literal">packt</code> database as specified by the <code class="literal">--db</code> argument. If <code class="literal">--db</code> is not given, <code class="literal">mongodump</code> exports all of the available databases except for the server's <code class="literal">local</code> database. It's possible to export just a specific collection from the database using the <code class="literal">--collection</code> argument:</p><pre class="programlisting">
<span class="strong"><strong>mongodump --db packt --collection authors</strong></span>
</pre><p>By default, <code class="literal">mongodump</code> creates a local directory named <code class="literal">dump</code> to organize the exported data. Within <code class="literal">dump</code> exists a directory for each exported database and within that are two files for each collection. The first file is a BSON file, a binary JSON-like format used because it offers a richer set of data types than JSON does. For example, JSON doesn't define a date type. Whereas JSON offers only a single numeric type, BSON supports 32 and 64-bit integers and doubles. The second file is a metadata JSON file that stores details about the collection, such as any collection options or index definitions.</p><div class="note" style="" title="Note"><div class="inner"><h3 class="title"><a id="note51"/>Note</h3><p><code class="literal">mongodump</code> will overwrite any existing files if the <code class="literal">dump</code> directory already exists. To avoid problems, you can specify a different location with the  
 <code class="literal">--out</code> argument:</p><p>
</p><p> <code class="literal">
<span class="strong"><strong>mongodump --db packt --out dump-$(date +%F)</strong></span>
</code></p></div></div><div class="mediaobject"><img alt="How it works..." src="graphics/image_07_006.jpg"/><div class="caption"><p>The exported collection data is organized by database in the dump directory</p></div></div><p>The path to the collection files is then given to <code class="literal">mongorestore</code> to import the data dumped by <code class="literal">mongodump</code>. The database to which the collections will be inserted is named using the <code class="literal">--db</code> argument:</p><pre class="programlisting">
<span class="strong"><strong>mongorestore --authenticationDatabase admin --username backupusr &#13;
    --password "" --drop --db packt dump/packt</strong></span>
</pre><p><code class="literal">mongorestore</code> only inserts the data; if documents with the same <code class="literal">_id</code> field already exist in a collection then those records are skipped, not updated. This may or may not be desired depending on the circumstances. So to be sure that the restored data matches what was exported, the <code class="literal">--drop</code> argument is used, which instructs <code class="literal">mongorestore</code> to drop the existing collection first before importing the backup.</p><p>Apart from <code class="literal">mongodump</code> and <code class="literal">mongorestore</code>, there is also <code class="literal">mongoexport</code> and <code class="literal">mongoimport</code>. <code class="literal">mongoexport</code> exports a collection's data to either a JSON or CSV file and <code class="literal">mongoimport</code> imports data from these formats. Keep in mind however that JSON's type system (and certainly "types" in CSV) is less granular than BSON's and some fidelity can be lost. For reliable backups, <code class="literal">mongodump</code> and <code class="literal">mongorestore</code> are preferred.</p><p>The default export format of <code class="literal">mongoexport</code> is JSON. To export a collection's data to CSV instead, use the <code class="literal">--csv</code> argument:</p><pre class="programlisting">
<span class="strong"><strong>mongoexport --db packt --collection titles --csv --out titles.csv</strong></span>
</pre><p>Specific fields can be targeted for export as well by providing a comma-separated list of names using the <code class="literal">--fields</code> argument:</p><pre class="programlisting">
<span class="strong"><strong>mongoexport --db packt --collection titles --fields isbn,title,     &#13;
    authors,year,language,pages --csv --out titles.csv</strong></span>
</pre><p>Some arguments worth noting when importing data with <code class="literal">mongoimport</code> are <code class="literal">--type</code>, which specifies the import file's type (either JSON for CSV), <code class="literal">--headerline</code> - to skip the first row of data in the case of column headers in a CSV file, <code class="literal">--fields</code> - to import only specific fields from the file, and <code class="literal">--upsert</code>, which performs an upsert action on existing documents instead of skipping them:</p><pre class="programlisting">
<span class="strong"><strong>mongoimport --db packt --collection titles --fields isbn,title,&#13;
    authors --type csv --upsert &lt; titles.csv</strong></span>
</pre></div><div class="section" title="See also"><div class="titlepage"><div><div><h2 class="title"><a id="ch07lvl2sec204"/>See also</h2></div></div></div><p>Refer to the following resources for more information on backing up and restoring MongoDB databases:</p><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc">The <code class="literal">mongodump</code> manual page (<code class="literal">man 1 mongodump</code>)</li><li class="listitem" style="list-style-type: disc">The <code class="literal">mongorestore</code> manual page (<code class="literal">man 1 mongorestore</code>)</li><li class="listitem" style="list-style-type: disc">The <code class="literal">mongoexport</code> manual page (<code class="literal">man 1 mongoexport</code>)</li><li class="listitem" style="list-style-type: disc">The <code class="literal">mongoimport</code> manual page (<code class="literal">man 1 mongoimport</code>)</li><li class="listitem" style="list-style-type: disc">MongoDB Manual: MongoDB Backup Methods (<a class="ulink" href="http://docs.mongodb.org/manual/core/backups">http://docs.mongodb.org/manual/core/backups</a>)</li><li class="listitem" style="list-style-type: disc">BSON: Binary JSON (<a class="ulink" href="http://bsonspec.org/">http://bsonspec.org/</a>)</li></ul></div></div></div>
<div class="section" title="Configuring a MongoDB replica set"><div class="titlepage"><div><div><h1 class="title"><a id="ch07lvl1sec64"/>Configuring a MongoDB replica set</h1></div></div></div><p>This recipe teaches you how to configure replication using MongoDB replica sets.</p><p>When replication is performed using replica sets, one installation of MongoDB identifies as the primary server while others in the cluster are secondaries. The primary server accepts writes, which are replicated to the secondaries, while the secondaries service read requests. If the primary server goes down, the secondary servers automatically call a quorum and promote one of the secondaries to fill the primary's role. The old primary rejoins the cluster when it comes back on line. This configuration provides redundancy, distributed read/write access, and automatic failover for high-availability.</p><div class="section" title="Getting ready"><div class="titlepage"><div><div><h2 class="title"><a id="ch07lvl2sec205"/>Getting ready</h2></div></div></div><p>This recipe demonstrates configuring replica sets using three systems. The first system will be the cluster's primary server and we assume that its IP address is <code class="literal">192.168.56.100</code>. The other two systems will be secondary servers using the addresses <code class="literal">192.168.56.102</code> and <code class="literal">192.168.56.103</code>. MongoDB should be installed on all three systems. You'll also need administrative access to complete the configuration and access to a user account with membership in the <code class="literal">userAdmin</code> role.</p><p>MongoDB replication relies on hostnames. Before you begin this recipe, make sure that the systems are accessible to one another by the hostname. If the systems are inaccessible and you are unable to add the necessary records to your network's DNS, you can override local resolution for the hosts in question by adding entries to <code class="literal">/etc/hosts</code>, similarly to the following:</p><pre class="programlisting">
<span class="strong"><strong>192.168.56.100 benito benito.localdomain</strong></span>
<span class="strong"><strong>192.168.56.101 javier javier.localdomain</strong></span>
<span class="strong"><strong>192.168.56.102 geomar geomar.localdomain</strong></span>
</pre></div><div class="section" title="How to do it..."><div class="titlepage"><div><div><h2 class="title"><a id="ch07lvl2sec206"/>How to do it...</h2></div></div></div><p>Follow these steps to configure replication using MongoDB replica sets:</p><div class="orderedlist"><ol class="orderedlist arabic"><li class="listitem">On the primary system, navigate to <code class="literal">/var/lib/mongodb</code> and use <code class="literal">openssl</code> to create a shared secret. This secret serves as the password each server will use to authenticate itself as a member of the replication cluster:<pre class="programlisting">
<span class="strong"><strong>cd /var/lib/mongodb</strong></span>
<span class="strong"><strong>openssl rand 756 -base64 -out rs0.key</strong></span>
</pre></li><li class="listitem">Secure the file's permissions; it should be owned by <code class="literal">mongodb</code> and only readable by its owner:<pre class="programlisting">
<span class="strong"><strong>chown mongodb.mongodb rs0.key</strong></span>
<span class="strong"><strong>chmod 600 rs0.key</strong></span>
</pre></li><li class="listitem">Open <code class="literal">/etc/mongod.conf</code> with your text editor:<pre class="programlisting">
<span class="strong"><strong>vi /etc/mongod.conf</strong></span>
</pre></li><li class="listitem">Locate the <code class="literal">replSet</code> option, uncomment it, and assign it the value <code class="literal">rs0</code>:<pre class="programlisting">
<span class="strong"><strong># Arg is &lt;setname&gt;[/&lt;optionalseedhostlist&gt;]</strong></span>
<span class="strong"><strong>replSet = rs0</strong></span>
</pre></li><li class="listitem">Uncomment the <code class="literal">keyFile</code> option and provide the path to the file containing the shared password:<pre class="programlisting">
<span class="strong"><strong># Private key for cluster authentication</strong></span>
<span class="strong"><strong>keyFile = /var/lib/mongodb/rs0.key</strong></span>
</pre></li><li class="listitem">Save your changes and close the file.</li><li class="listitem">Restart the MongoDB server:<pre class="programlisting">
<span class="strong"><strong>systemctl restart mongod.service</strong></span>
</pre></li><li class="listitem">Copy the shared secret to each of the secondary systems:<pre class="programlisting">
<span class="strong"><strong>scp rs0.key 192.168.56.101:/var/lib/mongodb/rs0.key</strong></span>
<span class="strong"><strong>scp rs0.key 192.168.56.102:/var/lib/mongodb/rs0.key</strong></span>
</pre></li><li class="listitem">Repeat steps 2-7 on each of the other secondary systems.</li><li class="listitem">Connect to the primary MongoDB server and create an account with membership in the <code class="literal">clusterManager</code> role to be used for configuring and managing the replica cluster:<pre class="programlisting">
<span class="strong"><strong>db.createUser({</strong></span>
<span class="strong"><strong>  user: "repladmin",</strong></span>
<span class="strong"><strong>     pwd: "dupl1C@t3",</strong></span>
<span class="strong"><strong>     roles: [{ role: "clusterManager", db: "admin" }]</strong></span>
<span class="strong"><strong>})</strong></span>
</pre></li><li class="listitem">Authenticating yourself using the <code class="literal">repladmin</code> user:<pre class="programlisting">
<span class="strong"><strong>db.auth("repladmin", "dupl1C@t3")</strong></span>
</pre></li><li class="listitem">Use the <code class="literal">rs.initiate()</code> method to initialize the cluster:<pre class="programlisting">
<span class="strong"><strong>rs.initiate()</strong></span>
</pre></li><li class="listitem">Register the secondary members using <code class="literal">rs.add()</code>:<pre class="programlisting">
<span class="strong"><strong>rs.add("192.168.56.101")</strong></span>
<span class="strong"><strong>rs.add("192.168.56.102")</strong></span>
</pre></li></ol></div></div><div class="section" title="How it works..."><div class="titlepage"><div><div><h2 class="title"><a id="ch07lvl2sec207"/>How it works...</h2></div></div></div><p>Clusters must contain an odd number of servers because there has to be a majority vote to approve a secondary's proposal to take on the role of primary if the primary server becomes unavailable. Three servers were used, which is the minimum number for a cluster that provides proper redundancy and availability.</p><p>Cluster members identify themselves to one another using a shared replica set name and password, which we provide in each server's <code class="literal">mongod.conf</code> configuration file. The name is specified using the <code class="literal">replSet</code> option:</p><pre class="programlisting">
<span class="strong"><strong>replSet = rs0</strong></span>
</pre><p>The password value can be anything up to 1,024 characters. For security reasons, a long random string is preferred for resistance against brute force and dictionary attacks. We can generate such values using <code class="literal">openssl rand</code>:</p><pre class="programlisting">
<span class="strong"><strong>openssl rand 756 -base64 -out rs0.key</strong></span>
</pre><p><code class="literal">rand</code> generates the number of random bytes we request, in this case 756 bytes. <code class="literal">-base64</code> encodes them using the Base64 encoding scheme to represent the bytes safely as plain text. Encoding incurs some overhead, and Base64 encodes three bytes as four characters and pads the result when less than three bytes are available. So, Base64-encoding the 765 random bytes results in 1,024 characters of text suitable for our needs.</p><p>The resulting key file containing the password is copied to each system. Its ownership is set to the system's <code class="literal">mongodb</code> user and access permissions to the file are revoked for everyone except that user:</p><pre class="programlisting">
<span class="strong"><strong>chown mongodb.mongodb rs0.key</strong></span>
<span class="strong"><strong>chmod 600 rs0.key</strong></span>
</pre><p>The file is specified in the configuration file using the <code class="literal">keyFile</code> option:</p><pre class="programlisting">
<span class="strong"><strong>keyFile = /var/lib/mongodb/rs0.key</strong></span>
</pre><p>Management of the cluster requires permissions assigned to the <code class="literal">clusterManager</code> role, so we then created an account with membership in that role, and then we authenticated ourselves using the new account:</p><pre class="programlisting">
<span class="strong"><strong>db.createUser({</strong></span>
<span class="strong"><strong>  user: "repladmin",</strong></span>
<span class="strong"><strong>  pwd: "dupl1C@t3",</strong></span>
<span class="strong"><strong>  roles: [{ role: "clusterManager", db: "admin" }]</strong></span>
<span class="strong"><strong>})</strong></span>
<span class="strong"><strong>db.auth("repladmin", "dupl1C@t3")</strong></span>
</pre><p>We started the cluster using <code class="literal">rs.initiate()</code> on the primary server and then registered the secondary servers using <code class="literal">rs.add()</code>:</p><pre class="programlisting">
<span class="strong"><strong>rs.initiate()</strong></span>
<span class="strong"><strong>rs.add("192.168.56.101")</strong></span>
<span class="strong"><strong>rs.add("192.168.56.102")</strong></span>
</pre><p>After <code class="literal">rs.initiate()</code> is invoked, you'll notice the mongo client's prompt changes to <code class="literal">rs0:primary</code> to notify us that we're connected to the primary server in the <code class="literal">rs0</code> replication group. If you were to log in to a secondary server, the prompt would read <code class="literal">rs0:secondary</code>.</p><p>Alternatively, the cluster can be configured by passing an object that specifies the secondary servers as an argument to <code class="literal">rs.initiate()</code>. The object's <code class="literal">_id</code> property is the name of the set and the <code class="literal">members</code> property is an array of secondary hosts:</p><pre class="programlisting">
<span class="strong"><strong>rs.initiate({</strong></span>
<span class="strong"><strong>  _id : "rs0",</strong></span>
<span class="strong"><strong>  members : [</strong></span>
<span class="strong"><strong>    {_id : 0, host : "192.168.56.100"},</strong></span>
<span class="strong"><strong>    {_id : 1, host : "192.168.56.101"},</strong></span>
<span class="strong"><strong>    {_id : 2, host : "192.168.56.102"}</strong></span>
<span class="strong"><strong>  ]</strong></span>
<span class="strong"><strong>})</strong></span>
</pre></div><div class="section" title="See also"><div class="titlepage"><div><div><h2 class="title"><a id="ch07lvl2sec208"/>See also</h2></div></div></div><p>Refer to the following resources for more information on working with MongoDB replica sets:</p><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc">MongoDB Manual: Replication (<a class="ulink" href="http://docs.mongodb.org/manual/core/replication-introduction">http://docs.mongodb.org/manual/core/replication-introduction</a>)</li><li class="listitem" style="list-style-type: disc">MongoDB Replication and Replica Sets (<a class="ulink" href="http://www.youtube.com/watch?v=CsvbG9tykC4">http://www.youtube.com/watch?v=CsvbG9tykC4</a>)</li></ul></div></div></div>
<div class="section" title="Setting up an OpenLDAP directory"><div class="titlepage"><div><div><h1 class="title"><a id="ch07lvl1sec65"/>Setting up an OpenLDAP directory</h1></div></div></div><p>This recipe teaches you how to install OpenLDAP, an open-source implementation of an X.500 directory server. The X.500 series of protocols was developed in the late 1980s to support the storage and lookup of names, e-mail addresses, computer systems, and other entities in a hierarchical fashion. Each entry is a node in a directory information tree (DIT) and is identified by its distinguished name (DN). Information about the entry is represented as key/value pairs known as attributes.</p><div class="section" title="Getting ready"><div class="titlepage"><div><div><h2 class="title"><a id="ch07lvl2sec209"/>Getting ready</h2></div></div></div><p>This recipe requires a CentOS system with a working network connection and administrative privileges either by using the <code class="literal">root</code> account or <code class="literal">sudo</code>.</p></div><div class="section" title="How to do it..."><div class="titlepage"><div><div><h2 class="title"><a id="ch07lvl2sec210"/>How to do it...</h2></div></div></div><p>Follow these steps to set up an OpenLDAP directory:</p><div class="orderedlist"><ol class="orderedlist arabic"><li class="listitem">Install the <code class="literal">openldap-server</code> and <code class="literal">openldap-clients</code> packages:<pre class="programlisting">
<span class="strong"><strong>yum install openldap-servers openldap-clients</strong></span>
</pre></li><li class="listitem">Copy the database configuration file included with OpenLDAP to the server's data directory. Ensure the file is owned by the <code class="literal">ldap</code> user:<pre class="programlisting">
<span class="strong"><strong>cp /usr/share/openldap-servers/DB_CONFIG.example  &#13;
       /var/lib/ldap/DB_CONFIG</strong></span>
<span class="strong"><strong>chown ldap.ldap /var/lib/ldap/DB_CONFIG</strong></span>
</pre></li><li class="listitem">Use <code class="literal">slappasswd</code> to generate a password hash for OpenLDAP's <code class="literal">Manager</code> account. Enter the desired password when prompted:<pre class="programlisting">
<span class="strong"><strong>slappasswd</strong></span>
</pre></li><li class="listitem">Start the LDAP server and optionally enable it to start automatically whenever the system reboots:<pre class="programlisting">
<span class="strong"><strong>systemctl start slapd.service</strong></span>
<span class="strong"><strong>systemctl enable slapd.service</strong></span>
</pre></li><li class="listitem">Open port <code class="literal">389</code> in the system's firewall to allow outside connections to the server:<pre class="programlisting">
<span class="strong"><strong>firewall-cmd --zone=public --permanent --add-service=ldap</strong></span>
<span class="strong"><strong>firewall-cmd --reload</strong></span>
</pre></li><li class="listitem">Create the file <code class="literal">config.ldif</code> using the following content. The DIT's suffix is based on the domain <code class="literal">ldap.example.com</code> and the value for <code class="literal">olcRootPW</code> is the password hash obtained in step 3:<pre class="programlisting">
<span class="strong"><strong>dn: olcDatabase={2}hdb,cn=config</strong></span>
<span class="strong"><strong>changetype: modify</strong></span>
<span class="strong"><strong>replace: olcSuffix</strong></span>
<span class="strong"><strong>olcSuffix: dc=ldap,dc=example,dc=com</strong></span>
<span class="strong"><strong>-</strong></span>
<span class="strong"><strong>replace: olcRootDN</strong></span>
<span class="strong"><strong>olcRootDN: cn=Manager,dc=ldap,dc=example,dc=com</strong></span>
<span class="strong"><strong>-</strong></span>
<span class="strong"><strong>add: olcRootPW</strong></span>
<span class="strong"><strong>olcRootPW: {SSHA}cb0i4Kwzvd5tBlxEtwB50myPIUKI3bkp</strong></span>
<span class="strong"><strong>dn: olcDatabase={1}monitor,cn=config</strong></span>
<span class="strong"><strong>changetype: modify</strong></span>
<span class="strong"><strong>replace: olcAccess</strong></span>
<span class="strong"><strong>olcAccess: {0}to * by dn.base="gidNumber=0+uidNumber=0,</strong></span>
<span class="strong"><strong>    cn=peercred,cn=external,cn=auth" read by dn.base="cn=</strong></span>
<span class="strong"><strong>    Manager,dc=ldap,dc=example,dc=com" read by * none</strong></span>
</pre></li><li class="listitem">Invoke <code class="literal">ldapmodify</code> to execute the operations in <code class="literal">config.ldif</code>:<pre class="programlisting">
<span class="strong"><strong>ldapmodify -Y EXTERNAL -H ldapi:/// -f config.ldif</strong></span>
</pre></li><li class="listitem">Use <code class="literal">ldapadd</code> to import the <code class="literal">cosine</code>, <code class="literal">inetorgperson</code>, and <code class="literal">nis</code> schemas found in <code class="literal">/etc/openldap/schema</code>:<pre class="programlisting">
<span class="strong"><strong>cd /etc/openldap/schema</strong></span>
<span class="strong"><strong>ldapadd -Y EXTERNAL -H ldapi:/// -f cosine.ldif</strong></span>
<span class="strong"><strong>ldapadd -Y EXTERNAL -H ldapi:/// -f inetorgperson.ldif</strong></span>
<span class="strong"><strong>ldapadd -Y EXTERNAL -H ldapi:/// -f nis.ldif</strong></span>
</pre></li><li class="listitem">Create the file <code class="literal">root.ldif</code> with the following content:<pre class="programlisting">
<span class="strong"><strong>dn: dc=ldap,dc=example,dc=com</strong></span>
<span class="strong"><strong>objectClass: dcObject</strong></span>
<span class="strong"><strong>objectClass: organization</strong></span>
<span class="strong"><strong>o: My Company's LDAP Database</strong></span>
</pre></li><li class="listitem">Use <code class="literal">ldapadd</code> to import <code class="literal">root.ldif</code>, authenticating yourself with the <code class="literal">Manager</code> account:<pre class="programlisting">
<span class="strong"><strong>ldapadd -D "cn=Manager,dc=ldap,dc=example,dc=com" -W -H  &#13;
       ldapi:/// -f root.ldif</strong></span>
</pre></li></ol></div></div><div class="section" title="How it works..."><div class="titlepage"><div><div><h2 class="title"><a id="ch07lvl2sec211"/>How it works...</h2></div></div></div><p>We first installed the <code class="literal">openldap-server</code> package, which contains the LDAP server (<code class="literal">slapd</code>) and some supporting utilities, and the <code class="literal">openldap-clients</code> package, which installed the basic utilities used for working with the directory server:</p><pre class="programlisting">
<span class="strong"><strong>yum install openldap-servers openldap-clients</strong></span>
</pre><p>OpenLDAP uses the Berkeley DB (BDB/HDB) database for backend data storage, indexing, and caching. The database is configured separately from the directory server and an example configuration file is installed along with the server. We copied the example into the server's data directory but left it with its default values; the defaults are fine to start with although you'll want to review the settings periodically after you deploy OpenLDAP to ensure the best performance (<code class="literal">man 5 slapd-bdb</code> provides descriptions of the file's configuration options):</p><pre class="programlisting">
<span class="strong"><strong>cp /usr/share/openldap-servers/DB_CONFIG.example  &#13;
    /var/lib/ldap/DB_CONFIG</strong></span>
</pre><p>The directory's administrative user <code class="literal">Manager</code> doesn't have an assigned password at first. OpenLDAP expects the password to be hashed so we created a suitable value using <code class="literal">slappasswd</code>:</p><pre class="programlisting">
<span class="strong"><strong>slappasswd</strong></span>
</pre><p>The default hashing algorithm used by <code class="literal">slappasswd</code> is salted SHA (SSHA) as indicated by the <code class="literal">{SSHA}</code> prefix in its output. It's possible to hash the password using a different algorithm if required by specifying it using the <code class="literal">-h</code> argument. The possible values are <code class="literal">{CRYPT}</code>, <code class="literal">{MD5}</code>, <code class="literal">{SMD5}</code> (salted MD5), <code class="literal">{SHA}</code>, or <code class="literal">{SSHA}</code>. The salted algorithms are preferred over their nonsalted counterparts because the randomly generated salt <code class="literal">slappasswd</code> incorporates into the hash makes the hash resistant to rainbow attacks.</p><p>OpenLDAP has deprecated its file-based configuration approach in favor of online configuration, storing parameters in a config DIT so that they can be updated without needing to restart the directory server for the changes to take effect. So after starting the server, we wrote the necessary operations to <code class="literal">config.ldif</code> that will make our updates and then executed them as a batch with <code class="literal">ldapmodify</code>:</p><pre class="programlisting">
<span class="strong"><strong>ldapmodify -Y EXTERNAL -H ldapi:// -f config.ldif</strong></span>
</pre><p>The <code class="literal">-H</code> argument provides one or more URIs for the servers we want to connect to. We can specify the transport protocol, hostname or IP address, and port, but the URI is not a full RFC-4516 style LDAP URI (other components such as the base DN are given using other arguments). The supported protocols are <code class="literal">ldap</code>, <code class="literal">ldaps</code> (LDAP over SSL), and <code class="literal">ldapi</code> (LDAP over IPC/unix-socket). No hostname is required to access the local host, so just <code class="literal">ldapi://</code> is used.</p><p>The <code class="literal">-Y</code> argument specifying <code class="literal">EXTERNAL</code> as the authentication mechanism allows the use of mechanisms external to the server's SASL methods. When paired with <code class="literal">ldapi</code>, <code class="literal">EXTERNAL</code> uses our login session's username to authenticate us.</p><p>The default behavior for <code class="literal">ldapmodify</code> is to read input from STDIN, but the <code class="literal">-f</code> argument can specify an input file instead. Since the statements are rather verbose, using an input file is a great idea because you can review them for any mistakes beforehand. If you do want to provide them via STDIN however, I recommend that you use the <code class="literal">-c</code> argument to run <code class="literal">ldapmodify</code> in "continuous mode". The program terminates when it encounters an error by default, but in continuous mode it will keep running. This will give you the opportunity to resubmit the operation if there's a problem, without reconnecting:</p><pre class="programlisting">
<span class="strong"><strong>ldapmodify -Y EXTERNAL -H ldapi:/// -c</strong></span>
</pre><p>Our first operation changed the DIT's suffix from the default <code class="literal">dc=my-domain,dc=com</code> to something more appropriate. The recipe uses <code class="literal">ldap.example.com</code> for example purposes, but of course you may substitute your own domain accordingly:</p><pre class="programlisting">
<span class="strong"><strong>dn: olcDatabase={2}hdb,cn=config</strong></span>
<span class="strong"><strong>changetype: modify</strong></span>
<span class="strong"><strong>replace: olcSuffix</strong></span>
<span class="strong"><strong>olcSuffix: dc=ldap,dc=example,dc=com</strong></span>
</pre><p>The suffix is stored in the <code class="literal">olcSuffix</code> attribute of the <code class="literal">olcDatabase={2}hdb,cn= config</code> entry and represents the top level of the DIT. Traditionally, the suffix is based on a domain name and is expressed as a series of domain components (DC), so the domain <code class="literal">ldap.example.com</code> becomes <code class="literal">dc=ldap,dc=example,dc=com</code>.</p><p>The suffix appears in a few other places, so we needed to update those as well - the <code class="literal">olcRootDN</code> attribute, which lists the name of the DIT's administrative user, and in the permission statement in <code class="literal">olcAccess</code> that grants access to <code class="literal">Manager</code> and the system's <code class="literal">root</code> account. Additionally, we added the <code class="literal">olcRootPW</code> attribute that stores the Manager's password hash. We don't have to specify the DN multiple times for attributes on same entry. Rather, we can separate the operations with a single hyphen:</p><pre class="programlisting">
<span class="strong"><strong>replace: olcRootDN</strong></span>
<span class="strong"><strong>olcRootDN: cn=Manager,dc=ldap,dc=example,dc=com</strong></span>
<span class="strong"><strong>-</strong></span>
<span class="strong"><strong>add: olcRootPW</strong></span>
<span class="strong"><strong>olcRootPW: {SSHA}3NhShraRoA+MaOGSrjWTzK3fX0AIq+7P</strong></span>
<span class="strong"><strong>dn: olcDatabase={1}monitor,cn=config</strong></span>
<span class="strong"><strong>changetype: modify</strong></span>
<span class="strong"><strong>replace: olcAccess</strong></span>
<span class="strong"><strong>olcAccess: {0}to * by dn.base="gidNumber=0+uidNumber=0,</strong></span>
<span class="strong"><strong> cn=peercred,cn=external,cn=auth" read by dn.base="cn=</strong></span>
<span class="strong"><strong> Manager,dc=ldap,dc=example,dc=com" read by * none</strong></span>
</pre><p>Next, we imported the <code class="literal">cosine</code>, <code class="literal">nis</code>, and <code class="literal">inetorgperson</code> schemas. Creating new schemas from scratch can be a daunting task as a fair amount of planning is required to identify what types are needed and what PEN/OIDs should be allocated. Importing these schemas provided with OpenLDAP gives us access to various useful predefined types:</p><pre class="programlisting">
<span class="strong"><strong>ldapadd -Y EXTERNAL -H ldapi:/// -f cosine.ldif</strong></span>
<span class="strong"><strong>ldapadd -Y EXTERNAL -H ldapi:/// -f inetorgperson.ldif</strong></span>
<span class="strong"><strong>ldapadd -Y EXTERNAL -H ldapi:/// -f nis.ldif</strong></span>
</pre><p><code class="literal">cosine</code> defines a standard X.500 directory services schema that was originally developed for the COSINE PARADISE Project and is outlined in RFC-4524. It gives us types such as <code class="literal">document</code> and <code class="literal">domain</code> objects and attributes such as <code class="literal">host</code>, <code class="literal">mail</code>, and <code class="literal">documentAuthor</code>. <code class="literal">inetorgperson</code> defines the <code class="literal">inetOrgPerson</code> class, a person object that attempts to "meet the requirements found in today's Internet and intranet directory service deployments" as described by RFC-2798 and RFC-4524. <code class="literal">nis</code> defines a Network Information Services schema with user and host attributes useful for setting up centralized authentication, such as <code class="literal">uidNumber</code>, <code class="literal">gidNumber</code>, <code class="literal">ipNetworkNumber</code>, and <code class="literal">ipNetmaskNumber</code>.</p><p>If you look at the contents of these files, you'll find that object identifiers (OIDs) play an important role in schema definitions, providing globally unique identification of various object classes and attributes. OIDs are a string of numbers separated by dots, read left to right, with each position representing a level in the distributed hierarchy. Top levels of the hierarchy are maintained by various standards bodies and registry authorities, and Internet Assigned Numbers Authority (IANA) allows individuals to register for their own branch under the OID <code class="literal">1.3.6.1.4.1</code>. For example, <code class="literal">1.3.6.1.4.1.4203</code> is assigned to the OpenLDAP project.</p><p>Finally, we need to define the domain component object (<code class="literal">dcObject</code>) first. This object is the root of our local branch of the directory under which future entries can be added. If your experience centers mostly on working with relational databases such as MySQL or with modern NoSQL databases such as MongoDB, you can think of <code class="literal">dcObject</code> as the database:</p><pre class="programlisting">
<span class="strong"><strong>dn: dc=ldap,dc=example,dc=com</strong></span>
<span class="strong"><strong>objectClass: dcObject</strong></span>
<span class="strong"><strong>objectClass: organization</strong></span>
<span class="strong"><strong>o: My Company's LDAP Database</strong></span>
</pre><p>While using <code class="literal">ldapadd</code> to import the definition, we provided the <code class="literal">-D</code> argument to specify the <code class="literal">Manager</code> account and <code class="literal">-W</code> to be prompted for the account's password:</p><pre class="programlisting">
<span class="strong"><strong>ldapadd -D "cn=Manager,dc=ldap,dc=example,dc=com" -W -H ldapi:///  &#13;
    -f root.ldif</strong></span>
</pre></div><div class="section" title="See also"><div class="titlepage"><div><div><h2 class="title"><a id="ch07lvl2sec212"/>See also</h2></div></div></div><p>Refer to the following resources for more information on working with OpenLDAP:</p><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc">The <code class="literal">ldapmodify</code> manual page (<code class="literal">man 1 ldapmodify</code>)</li><li class="listitem" style="list-style-type: disc">OpenLDAP (<a class="ulink" href="http://www.openldap.org/">http://www.openldap.org/</a>)</li><li class="listitem" style="list-style-type: disc">Understanding the LDAP Protocol, Data Hierarchy, and Entry Components (<a class="ulink" href="http://www.digitalocean.com/community/tutorials/understanding-the-ldap-protocol-data-hierarchy-and-entry-components">http://www.digitalocean.com/community/tutorials/understanding-the-ldap-protocol-data-hierarchy-and-entry-components</a>)</li><li class="listitem" style="list-style-type: disc">How to Use LDIF Files to Make Changes to an OpenLDAP System (<a class="ulink" href="http://www.digitalocean.com/community/tutorials/how-to-use-ldif-files-to-make-changes-to-an-openldap-system">http://www.digitalocean.com/community/tutorials/how-to-use-ldif-files-to-make-changes-to-an-openldap-system</a>)</li><li class="listitem" style="list-style-type: disc">How to Get Your Own LDAP OID (<a class="ulink" href="http://ldapwiki.willeke.com/wiki/How%20To%20Get%20Your%20Own%20LDAP%20OID">http://ldapwiki.willeke.com/wiki/How%20To%20Get%20Your%20Own%20LDAP%20OID</a>)</li></ul></div></div></div>
<div class="section" title="Backing up and restoring an OpenLDAP database"><div class="titlepage"><div><div><h1 class="title"><a id="ch07lvl1sec66"/>Backing up and restoring an OpenLDAP database</h1></div></div></div><p>This recipe teaches you how to back up an OpenLDAP database by exporting the directory to an LDIF file, which can then be imported later to restore the database.</p><div class="section" title="Getting ready"><div class="titlepage"><div><div><h2 class="title"><a id="ch07lvl2sec213"/>Getting ready</h2></div></div></div><p>This recipe requires a CentOS system with a working network connection and administrative privileges either using the <code class="literal">root</code> account or <code class="literal">sudo</code>.</p></div><div class="section" title="How to do it..."><div class="titlepage"><div><div><h2 class="title"><a id="ch07lvl2sec214"/>How to do it...</h2></div></div></div><p>To back up an LDAP directory, export the directory using the <code class="literal">slapcat</code> utility:</p><pre class="programlisting">
<span class="strong"><strong>slapcat -b "dc=ldap,dc=example,dc=com" -l backup.ldif</strong></span>
</pre><p>To rebuild the directory from an export, follow these steps:</p><div class="orderedlist"><ol class="orderedlist arabic"><li class="listitem">Stop the LDAP server:<pre class="programlisting">
<span class="strong"><strong>service stop slapd.service</strong></span>
</pre></li><li class="listitem">Import the file using <code class="literal">slapadd</code>:<pre class="programlisting">
<span class="strong"><strong>slapadd -f backup.ldif</strong></span>
</pre></li><li class="listitem">Ensure the data files are owned by the <code class="literal">ldap</code> user:<pre class="programlisting">
<span class="strong"><strong>chown -R ldap.ldap /var/lib/ldap/*</strong></span>
</pre></li><li class="listitem">Restart the LDAP server:<pre class="programlisting">
<span class="strong"><strong>service restart slapd.service</strong></span>
</pre></li></ol></div></div><div class="section" title="How it works..."><div class="titlepage"><div><div><h2 class="title"><a id="ch07lvl2sec215"/>How it works...</h2></div></div></div><p><code class="literal">slapcat</code> exports the LDAP database's contents to LDIF-formatted output. The content is sent to STDOUT by default, so you should either capture it using the shell's redirect operators (<code class="literal">&gt;</code> or <code class="literal">&gt;&gt;</code>) or using the command's <code class="literal">-l</code> (lowercase L) argument, which specifies the name of an output file:</p><pre class="programlisting">
<span class="strong"><strong>slapcat -b "dc=ldap,dc=example,dc=com" -l backup.ldif</strong></span>
</pre><p>The suffix of the targeted directory is given using the <code class="literal">-b</code> argument. If there are any subordinate directories, they'll be exported as well by default. To eliminate subordinates from the export and to export only the top-level directory contents, use the <code class="literal">-g</code> argument:</p><pre class="programlisting">
<span class="strong"><strong>slapcat -b "dc=ldap,dc=example,dc=com" -g -l backup.ldif</strong></span>
</pre><p><code class="literal">slapcat</code> returns entries in the order it encounters them while scanning the database. This means it's possible for an object's definition to appear in the export after that of an entity who's attributes reference it. This isn't a problem for <code class="literal">slapadd</code> because of how it imports data as opposed to <code class="literal">ldapadd</code>, so the former utility should be used to restore the directory. Otherwise you'll have to edit the file to ensure the ordering won't pose a problem; something I'm sure you'll agree isn't appealing given the format's verbosity:</p><pre class="programlisting">
<span class="strong"><strong>slapadd -f backup.ldif</strong></span>
</pre><p>When performing exports and imports, the LDAP server should not be running. This makes any write actions impossible during the process to guarantee the integrity and consistency of the data.</p><p><code class="literal">slapadd</code> writes files directly to the server's data directory so that the files will be owned by <code class="literal">root</code> (the user account used to run <code class="literal">slapadd</code>), so their ownership needs to be set to <code class="literal">ldap</code> after the import but before the server is started so that the process can access them:</p><pre class="programlisting">
<span class="strong"><strong>chown -R ldap.ldap /var/lib/ldap/*</strong></span>
</pre></div><div class="section" title="See also"><div class="titlepage"><div><div><h2 class="title"><a id="ch07lvl2sec216"/>See also</h2></div></div></div><p>Refer to the following resources for more information on working with OpenLDAP backups:</p><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc">OpenLDAP FAQ-O-Matic: How do I backup my directory (<a class="ulink" href="http://www.openldap.org/faq/data/cache/287.html">http://www.openldap.org/faq/data/cache/287.html</a>)</li><li class="listitem" style="list-style-type: disc">OpenLDAP Administrator's Guide: Maintenance (<a class="ulink" href="http://www.openldap.org/doc/admin24/maintenance.html">http://www.openldap.org/doc/admin24/maintenance.html</a>)</li></ul></div></div></div></body></html>