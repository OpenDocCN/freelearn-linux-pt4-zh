<html><head></head><body><div class="chapter" title="Chapter&#xA0;8.&#xA0;Intrusion Detection System"><div class="titlepage"><div><div><h1 class="title"><a id="ch08"/>Chapter 8. Intrusion Detection System</h1></div></div></div><p>Nowadays intrusion<a id="id362" class="indexterm"/> detection systems are quite common but really expensive. In this chapter, I'm going to show how we can implement a cheap intrusion detection system with a reasonable quality using our BeagleBone Black and two (or more) webcams.</p><p>The system will be able to alert the user by sending an e-mail with a photo of the intruder.</p><div class="section" title="The basics of functioning"><div class="titlepage"><div><div><h1 class="title"><a id="ch08lvl1sec45"/>The basics of functioning</h1></div></div></div><p>As mentioned <a id="id363" class="indexterm"/>earlier, we're going to use two webcams connected with our BeagleBone Black via a USB bus. Then, we'll install and run a special motion detection software that is able to detect a movement into a dynamic scene. When the program detects a movement, it will take one or more photos of the moving object and then send the pictures via e-mail to a user's account.</p></div></div>
<div class="section" title="Setting up the hardware"><div class="titlepage"><div><div><h1 class="title"><a id="ch08lvl1sec46"/>Setting up the hardware</h1></div></div></div><p>This time, the <a id="id364" class="indexterm"/>connections are very simple since they are just done using several USB cables.</p><p>In the previous chapters, we have seen how to set up a webcam (see <a class="link" href="ch03.html" title="Chapter 3. Aquarium Monitor">Chapter 3</a>, <span class="emphasis"><em>Aquarium Monitor</em></span>, for instance); but this time, we have a different configuration due to the fact that we're using two webcams at the same time.</p><p>As the reader might know, the BeagleBone Black board has only one USB host port, so to connect two webcams, we need a USB hub. These devices (used to connect more than one device to a USB host port) are very common, and the reader can find them anywhere on the Internet.</p><div class="note" title="Note" style=""><div class="inner"><h3 class="title"><a id="tip100"/>Tip</h3><p>In theory, the more ports the hub has, the more webcams we can use in our system! But, of course, there is a maximum limit of usable webcams due to the fact that each webcam adds a CPU load to the system.</p></div></div><p>A little schematic <a id="id365" class="indexterm"/>of the system using a <span class="strong"><strong>USB HUB</strong></span> <a id="id366" class="indexterm"/>with three ports is shown in the following diagram:</p><div class="mediaobject"><img src="graphics/B00255_08_01.jpg" alt="Setting up the hardware"/></div><div class="section" title="Setting up the webcams"><div class="titlepage"><div><div><h2 class="title"><a id="ch08lvl2sec67"/>Setting up the webcams</h2></div></div></div><p>For my <a id="id367" class="indexterm"/>prototype, I used two generic webcams supported by the <a id="id368" class="indexterm"/>
<span class="strong"><strong>Video4Linux</strong></span> driver class, as already explained in <a class="link" href="ch03.html" title="Chapter 3. Aquarium Monitor">Chapter 3</a>, <span class="emphasis"><em>Aquarium Monitor</em></span>, connected to the <span class="strong"><strong>USB HUB</strong></span> as shown in the following image. However, you can use your preferred device since it's a very common device.</p><div class="mediaobject"><img src="graphics/B00255_08_02.jpg" alt="Setting up the webcams"/></div><div class="note" title="Note" style=""><div class="inner"><h3 class="title"><a id="note82"/>Note</h3><p>The curious reader can get more <a id="id369" class="indexterm"/>information about the USB hub's drivers at <a class="ulink" href="https://en.wikipedia.org/wiki/USB_hub"> https://en.wikipedia.org/wiki/USB_hub</a>.</p></div></div><p>To verify if everything is well connected and supported, you have to connect the webcams as shown in the diagram in the previous section. Then, you should get something similar to the output of my system, as follows:</p><div class="informalexample"><pre class="programlisting">
<span class="strong"><strong>root@beaglebone:~# ls -l /dev/video*</strong></span>
<span class="strong"><strong>crw-rw---T 1 root video 81, 0 Jan  1  2000 /dev/video0</strong></span>
<span class="strong"><strong>crw-rw---T 1 root video 81, 1 Jan  1  2000 /dev/video1</strong></span>
</pre></div><div class="note" title="Note" style=""><div class="inner"><h3 class="title"><a id="tip101"/>Tip</h3><p>Note that you must use an external power supply for the HUB, or else your BeagleBone Black will be unable to supply enough current to manage both webcams.</p></div></div><p>Okay, now we <a id="id370" class="indexterm"/>can verify if the webcams are correctly managed using the <code class="literal">fswebcam</code> program in the same manner as in the previous chapter. However, this time we must specify which webcam must be used to take a simple picture to the <code class="literal">fswebcam</code> program. The trick can be done using the <code class="literal">-d</code> option argument, as shown in the following command line:</p><div class="informalexample"><pre class="programlisting">
<span class="strong"><strong>root@beaglebone:~# fswebcam -d /dev/video0 video0-shot.jpg</strong></span>
<span class="strong"><strong>--- Opening /dev/video0...</strong></span>
<span class="strong"><strong>Trying source module v4l2...</strong></span>
<span class="strong"><strong>/dev/video0 opened.</strong></span>
<span class="strong"><strong>No input was specified, using the first.</strong></span>
<span class="strong"><strong>Adjusting resolution from 384x288 to 352x288.</strong></span>
<span class="strong"><strong>--- Capturing frame...</strong></span>
<span class="strong"><strong>Captured frame in 0.00 seconds.</strong></span>
<span class="strong"><strong>--- Processing captured image...</strong></span>
<span class="strong"><strong>Writing JPEG image to 'video0-shot.jpg'.</strong></span>
</pre></div><div class="note" title="Note" style=""><div class="inner"><h3 class="title"><a id="tip102"/>Tip</h3><p>As already stated in <a class="link" href="ch03.html" title="Chapter 3. Aquarium Monitor">Chapter 3</a>, <span class="emphasis"><em>Aquarium Monitor</em></span>, if you get a completely blank image with a message as follows, you can resolve the issue by adding the <code class="literal">-S</code> option argument to the command line:</p><div class="informalexample"><pre class="programlisting">
<span class="strong"><strong>root@beaglebone:~# fswebcam -d /dev/video0 -S 10 webcam-shot.jpg</strong></span>
</pre></div></div></div><p>Then, to take a picture from the other webcam, we can use the following command line:</p><div class="informalexample"><pre class="programlisting">
<span class="strong"><strong>root@beaglebone:~# fswebcam -d /dev/video1 video1-shot.jpg</strong></span>
<span class="strong"><strong>--- Opening /dev/video1...</strong></span>
<span class="strong"><strong>Trying source module v4l2...</strong></span>
<span class="strong"><strong>/dev/video1 opened.</strong></span>
<span class="strong"><strong>No input was specified, using the first.</strong></span>
<span class="strong"><strong>Adjusting resolution from 384x288 to 320x240.</strong></span>
<span class="strong"><strong>--- Capturing frame...</strong></span>
<span class="strong"><strong>Captured frame in 0.00 seconds.</strong></span>
<span class="strong"><strong>--- Processing captured image...</strong></span>
<span class="strong"><strong>Writing JPEG image to 'video1-shot.jpg'.</strong></span>
</pre></div><p>The following <a id="id371" class="indexterm"/>two screenshots show the two pictures from the two webcams, which are set face to face, that is, the first webcam gets a picture of the second one and vice versa.</p><div class="mediaobject"><img src="graphics/B00255_08_03.jpg" alt="Setting up the webcams"/></div><div class="mediaobject"><img src="graphics/B00255_08_04.jpg" alt="Setting up the webcams"/></div></div><div class="section" title="The final picture"><div class="titlepage"><div><div><h2 class="title"><a id="ch08lvl2sec68"/>The final picture</h2></div></div></div><p>The following <a id="id372" class="indexterm"/>screenshot shows all the devices that I used to implement this project and to test the software:</p><div class="mediaobject"><img src="graphics/B00255_08_05.jpg" alt="The final picture"/></div><p>Nothing <a id="id373" class="indexterm"/>special to highlight here; all the connections are just very simple USB connections. However, let me highlight the fact that I used an external power supply for both the BeagleBone Black board and for the USB hub in order to avoid power loss due to the high power consumption from the webcams.</p></div></div>
<div class="section" title="Setting up the software"><div class="titlepage"><div><div><h1 class="title"><a id="ch08lvl1sec47"/>Setting up the software</h1></div></div></div><p>This time, we <a id="id374" class="indexterm"/>have to set up two programs: the mailer and the motion detection system. The former, used to send the alarm e-mail message, is very simple and easy to set up; while the latter, used to implement the intrusions detection system, is a bit more complicated due to the fact that it supports tons of different devices and features.</p><div class="section" title="Setting up the mailer"><div class="titlepage"><div><div><h2 class="title"><a id="ch08lvl2sec69"/>Setting up the mailer</h2></div></div></div><p>As requested by <a id="id375" class="indexterm"/>this project, we should alert the user about possible intrusions by sending them an e-mail. There exists several ways to send an e-mail on a UNIX-like system, and the most commonly used is the <code class="literal">mail</code> command that is called with the following command:</p><div class="informalexample"><pre class="programlisting">
<span class="strong"><strong>echo "Test message" | mail -s "test mail" email_address@somedomain.com</strong></span>
</pre></div><div class="note" title="Note" style=""><div class="inner"><h3 class="title"><a id="note83"/>Note</h3><p>For further information <a id="id376" class="indexterm"/>about the <code class="literal">mail</code> program, the reader can take a look at its man pages (using the <code class="literal">man mail</code> command) or start reading about it at <a class="ulink" href="https://en.wikipedia.org/wiki/Mail_%28Unix%29">https://en.wikipedia.org/wiki/Mail_%28Unix%29</a>.</p></div></div><p>The real problem<a id="id377" class="indexterm"/> is that this command relays on the system mailer, which is the real program that actually sends our letters over the Internet! By default, our BeagleBone Black has no valid mailer, so, if we try to send an e-mail message with the <code class="literal">mail</code> program, we get the following error:</p><div class="informalexample"><pre class="programlisting">
<span class="strong"><strong>root@beaglebone:~# echo "Test message" | mail -s "test mail"giometti@hce-engineering.com</strong></span>
<span class="strong"><strong>root@beaglebone:~# /usr/lib/sendmail: No such file or directory</strong></span>
<span class="strong"><strong>"/root/dead.letter" 8/200</strong></span>
<span class="strong"><strong>. . . message not sent.</strong></span>
</pre></div><div class="note" title="Note" style=""><div class="inner"><h3 class="title"><a id="tip103"/>Tip</h3><p>The <code class="literal">-s</code> option argument used in the preceding output is to specify a subject for the e-mail.</p></div></div><p>To solve our problem, we have to install a valid <code class="literal">/usr/lib/sendmail</code> program, and, as already stated, there are several ways to do it. I decided to use the <code class="literal">ssmtp</code> tool with my Gmail account.</p><div class="note" title="Note" style=""><div class="inner"><h3 class="title"><a id="note84"/>Note</h3><p>Note that the <code class="literal">ssmtp</code> tool is <a id="id378" class="indexterm"/>a generic tool to be used with a mailhost, so it is not a Gmail-related product. For further information on the tool, you can take a look at <a class="ulink" href="https://wiki.debian.org/sSMTP">https://wiki.debian.org/sSMTP</a>.</p></div></div><p>To install it, we can use the usual <code class="literal">aptitude</code> command with two other useful tools for e-mail processing:</p><div class="informalexample"><pre class="programlisting">
<span class="strong"><strong>root@beaglebone:~# aptitude install ssmtp mailutils mpack</strong></span>
</pre></div><p>After the installation, we have to modify the <code class="literal">/etc/ssmtp/ssmtp.conf</code> configuration file according to the following patch:</p><div class="informalexample"><pre class="programlisting">
<span class="strong"><strong>--- /etc/ssmtp/ssmtp.conf.orig   2015-09-11 21:52:39.531475392 +0000</strong></span>
<span class="strong"><strong>+++ /etc/ssmtp/ssmtp.conf   2015-09-11 21:56:01.859600416 +0000</strong></span>
<span class="strong"><strong>@@ -18,4 +18,10 @@</strong></span>
<span class="strong"><strong> # Are users allowed to set their own From: address?</strong></span>
<span class="strong"><strong> # YES - Allow the user to specify their own From: address</strong></span>
<span class="strong"><strong> # NO - Use the system generated From: address</strong></span>
<span class="strong"><strong>-#FromLineOverride=YES</strong></span>
<span class="strong"><strong>+FromLineOverride=YES</strong></span>
<span class="strong"><strong>+</strong></span>
<span class="strong"><strong>+# Add GMail settings</strong></span>
<span class="strong"><strong>+mailhub=smtp.gmail.com:587</strong></span>
<span class="strong"><strong>+AuthUser=rodolfo.giometti@gmail.com</strong></span>
<span class="strong"><strong>+AuthPass=XXXXXXXXXX</strong></span>
<span class="strong"><strong>+useSTARTTLS=YES</strong></span>
</pre></div><p>The <code class="literal">FromLineOverride</code> setting <a id="id379" class="indexterm"/>has been enabled since we wish to specify our own <code class="literal">From:</code> address; then, the other fields are needed so we can send an e-mail message via our Gmail account.</p><div class="note" title="Note" style=""><div class="inner"><h3 class="title"><a id="tip104"/>Tip</h3><p>For obvious reasons, I replaced my password with the <code class="literal">XXXXXXXXXX</code> string. Of course, you have to set up the <code class="literal">AuthUser</code> and <code class="literal">AuthPass</code> settings to suite your Gmail account.</p></div></div><p>If everything works well, we should now be able to send an e-mail using the following command:</p><div class="informalexample"><pre class="programlisting">
<span class="strong"><strong>root@beaglebone:~# echo "Test message" | mail -s "Test subject" -r "BBB Guardian &lt;myaccount@gmail.com&gt;" giometti@hce-engineering.com</strong></span>
</pre></div><div class="note" title="Note" style=""><div class="inner"><h3 class="title"><a id="tip105"/>Tip</h3><p>Note that if your Gmail credentials are not correctly set up, you may get the following error message:</p><div class="informalexample"><pre class="programlisting">
<span class="strong"><strong>send-mail: Authorization failed (535 5.7.8  https://support.google.com/mail/answer/14257 fr10sm1091535wib.14 – gsmtp)</strong></span>
</pre></div><p>Also, note also that the <code class="literal">-r</code> option argument is used to specify a sender name; so, in the preceding example, in the <code class="literal">From:</code> field is displayed the <code class="literal">BBB Guardian &lt;myaccount@gmail.com&gt;</code> string, otherwise, the Gmail address is displayed instead.</p></div></div><p>The following screenshot shows the message as received on my smartphone:</p><div class="mediaobject"><img src="graphics/B00255_08_06.jpg" alt="Setting up the mailer"/></div></div><div class="section" title="Using motion"><div class="titlepage"><div><div><h2 class="title"><a id="ch08lvl2sec70"/>Using motion</h2></div></div></div><div class="blockquote"><table border="0" width="100%" cellspacing="0" cellpadding="0" class="blockquote" summary="Block quote"><tr><td valign="top"> </td><td valign="top"><p><span class="emphasis"><em>Motion is a <a id="id380" class="indexterm"/>program that monitors the video signal from cameras. It is able to detect if a significant part of the picture has changed; in other words, it can detect motion.</em></span></p></td><td valign="top"> </td></tr><tr><td valign="top"> </td><td colspan="2" align="right" valign="top" style="text-align: center">--<span class="attribution"><span class="emphasis"><em>[Motion WebHome]</em></span></span></td></tr></table></div><div class="note" title="Note" style=""><div class="inner"><h3 class="title"><a id="note85"/>Note</h3><p>Visit the project <a id="id381" class="indexterm"/>homepage is at <a class="ulink" href="http://www.lavrsen.dk/foswiki/bin/view/Motion/WebHome">http://www.lavrsen.dk/foswiki/bin/view/Motion/WebHome</a>.</p></div></div><p>The software<a id="id382" class="indexterm"/> is a libre CCTV software application developed for GNU/Linux-based systems, and as stated on the program's home site, it can monitor the video signal from one or more cameras and is able to detect if a significant part of the picture has changed, saving video when it detects that motion is occurring.</p><p>The program is a command-line-driven tool written in <span class="strong"><strong>C</strong></span> and made for the Video4Linux interface. It can run as a daemon with a rather small footprint and low CPU usage. It can call to user configurable <span class="emphasis"><em>triggers</em></span> when certain events occur, and then it generates either pictures (<code class="literal">.jpeg</code>, <code class="literal">.netpbm</code>) or videos (<code class="literal">.mpeg</code>, <code class="literal">.avi</code>).</p><p>
<code class="literal">motion</code> is operated mainly via configuration files though the end video streams that can be viewed from a web browser.</p><div class="section" title="Downloading the code"><div class="titlepage"><div><div><h3 class="title"><a id="ch08lvl3sec10"/>Downloading the code</h3></div></div></div><p>Downloading <a id="id383" class="indexterm"/>and installing <code class="literal">motion</code> on the <a id="id384" class="indexterm"/>BeagleBone Black is quite simple, since we simply have to use the usual command to install a new package as follows:</p><div class="informalexample"><pre class="programlisting">
<span class="strong"><strong>root@beaglebone:~# aptitude install motion</strong></span>
<span class="strong"><strong>...</strong></span>
<span class="strong"><strong>Setting up motion (3.2.12-3.4) ...</strong></span>
<span class="strong"><strong>Adding group `motion' (GID 117) ...</strong></span>
<span class="strong"><strong>Done.</strong></span>
<span class="strong"><strong>Adding system user `motion' (UID 111) ...</strong></span>
<span class="strong"><strong>Adding new user `motion' (UID 111) with group `motion' ...</strong></span>
<span class="strong"><strong>Not creating home directory `/home/motion'.</strong></span>
<span class="strong"><strong>Adding user `motion' to group `video' ...</strong></span>
<span class="strong"><strong>Adding user motion to group video</strong></span>
<span class="strong"><strong>Done.</strong></span>
<span class="strong"><strong>[ ok ] Starting motion (via systemctl): motion.service.</strong></span>
</pre></div><p>When all the code is installed, it's time to configure the program! In fact, if we take a look at the system's log messages, we see the following output:</p><div class="informalexample"><pre class="programlisting">
<span class="strong"><strong>root@beaglebone:~# tail -f /var/log/syslog</strong></span>
<span class="strong"><strong>...</strong></span>
<span class="strong"><strong>Sep  4 15:18:41 beaglebone motion[4511]: Not starting motion daemon, disabled via /etc/default/motion ... (warning).</strong></span>
</pre></div><p>The daemon is disabled by default due to the fact that it must be correctly configured before enabling it. So, let's see how we can do this in the next section.</p></div><div class="section" title="Configuring the daemon"><div class="titlepage"><div><div><h3 class="title"><a id="ch08lvl3sec11"/>Configuring the daemon</h3></div></div></div><p>To configure <a id="id385" class="indexterm"/>the daemon in order to use two webcams, we have to modify three files: the main configuration file <code class="literal">/etc/motion/motion.conf</code>, the configuration files of each webcam <code class="literal">/etc/motion/thread1.conf</code>, and <code class="literal">/etc/motion/thread2.conf</code>. The daemon creates one thread per webcams used, and all special settings referring to a webcam must be set inside the corresponding file.</p><p>Let's start by modifying the <code class="literal">/etc/motion/motion.conf</code> file. First of all, we must enable one thread per webcam, so we have to apply the following patch:</p><div class="informalexample"><pre class="programlisting">
<span class="strong"><strong>--- motion.conf.orig   2014-04-23 21:12:18.511719124 +0000</strong></span>
<span class="strong"><strong>+++ motion.conf   2014-04-23 21:12:47.710937877 +0000</strong></span>
<span class="strong"><strong>@@ -630,8 +630,8 @@</strong></span>
<span class="strong"><strong> # This motion.conf file AND thread1.conf and thread2.conf.</strong></span>
<span class="strong"><strong> # Only put the options that are unique to each camera in the</strong></span>
<span class="strong"><strong> # thread config files.</strong></span>
<span class="strong"><strong>-; thread /usr/local/etc/thread1.conf</strong></span>
<span class="strong"><strong>-; thread /usr/local/etc/thread2.conf</strong></span>
<span class="strong"><strong>+thread /etc/motion/thread1.conf</strong></span>
<span class="strong"><strong>+thread /etc/motion/thread2.conf</strong></span>
<span class="strong"><strong> ; thread /usr/local/etc/thread3.conf</strong></span>
<span class="strong"><strong> ; thread /usr/local/etc/thread4.conf</strong></span>
</pre></div><p>Then, we can verify <a id="id386" class="indexterm"/>the setting by running the <code class="literal">motion</code> daemon in debugging mode with the following command:</p><div class="informalexample"><pre class="programlisting">
<span class="strong"><strong>root@beaglebone:~# motion -s -n</strong></span>
<span class="strong"><strong>[0] Processing thread 0 - config file /etc/motion/motion.conf</strong></span>
<span class="strong"><strong>[0] Processing config file /etc/motion/thread1.conf</strong></span>
<span class="strong"><strong>[0] Processing config file /etc/motion/thread2.conf</strong></span>
<span class="strong"><strong>[0] Motion 3.2.12 Started</strong></span>
<span class="strong"><strong>[0] ffmpeg LIBAVCODEC_BUILD 3482368 LIBAVFORMAT_BUILD 3478785</strong></span>
<span class="strong"><strong>[0] Motion running in setup mode.</strong></span>
<span class="strong"><strong>[0] Thread 1 is from /etc/motion/thread1.conf</strong></span>
<span class="strong"><strong>[0] Thread 1 is device: /dev/video0 input 8</strong></span>
<span class="strong"><strong>[0] Webcam port 8081</strong></span>
<span class="strong"><strong>[0] Thread 2 is from /etc/motion/thread2.conf</strong></span>
<span class="strong"><strong>[0] Thread 2 is device: /dev/video1 input 1</strong></span>
<span class="strong"><strong>[0] Webcam port 8082</strong></span>
<span class="strong"><strong>[0] Waiting for threads to finish, pid: 3096</strong></span>
<span class="strong"><strong>[1] Thread 1 started</strong></span>
<span class="strong"><strong>[0] motion-httpd/3.2.12 running, accepting connections</strong></span>
<span class="strong"><strong>[0] motion-httpd: waiting for data on port TCP 8080</strong></span>
<span class="strong"><strong>[2] Thread 2 started</strong></span>
<span class="strong"><strong>[1] cap.driver: "uvcvideo"</strong></span>
<span class="strong"><strong>[1] cap.card: "Microsoft LifeCam VX-800"</strong></span>
<span class="strong"><strong>[1] cap.bus_info: "usb-musb-hdrc.1.auto-1.1"</strong></span>
<span class="strong"><strong>[1] cap.capabilities=0x84000001</strong></span>
<span class="strong"><strong>[1] - VIDEO_CAPTURE</strong></span>
<span class="strong"><strong>[1] - STREAMING</strong></span>
<span class="strong"><strong>[1] Config palette index 8 (YU12) doesn't work.</strong></span>
<span class="strong"><strong>[1] Supported palettes:</strong></span>
<span class="strong"><strong>[1] 0: YUYV (YUV 4:2:2 (YUYV))</strong></span>
<span class="strong"><strong>[1] Selected palette YUYV</strong></span>
<span class="strong"><strong>[1] Test palette YUYV (320x240)</strong></span>
<span class="strong"><strong>[1] Using palette YUYV (320x240) bytesperlines 640 sizeimage 153600 colorspace 00000000</strong></span>
<span class="strong"><strong>[1] found control 0x00980900, "Brightness", range -10,10</strong></span>
<span class="strong"><strong>[1]    "Brightness", default 2, current 2</strong></span>
<span class="strong"><strong>[1] found control 0x00980901, "Contrast", range 0,20</strong></span>
<span class="strong"><strong>[1]    "Contrast", default 10, current 10</strong></span>
<span class="strong"><strong>[1] found control 0x00980902, "Saturation", range 0,10</strong></span>
<span class="strong"><strong>[1]    "Saturation", default 4, current 4</strong></span>
<span class="strong"><strong>[1] found control 0x00980903, "Hue", range -5,5</strong></span>
<span class="strong"><strong>[1] 	"Hue", default 0, current 0</strong></span>
<span class="strong"><strong>[1] found control 0x00980910, "Gamma", range 100,200</strong></span>
<span class="strong"><strong>[1]    "Gamma", default 130, current 130</strong></span>
<span class="strong"><strong>[1] found control 0x00980913, "Gain", range 32,48</strong></span>
<span class="strong"><strong>[1]    "Gain", default 34, current 34</strong></span>
<span class="strong"><strong>[1] mmap information:</strong></span>
<span class="strong"><strong>[1] frames=4</strong></span>
<span class="strong"><strong>[1] 0 length=153600</strong></span>
<span class="strong"><strong>[1] 1 length=153600</strong></span>
<span class="strong"><strong>[1] 2 length=153600</strong></span>
<span class="strong"><strong>[1] 3 length=153600</strong></span>
<span class="strong"><strong>[1] Using V4L2</strong></span>
<span class="strong"><strong>[2] cap.driver: "gspca_zc3xx"</strong></span>
<span class="strong"><strong>[2] cap.card: "USB Camera (046d:08a2)"</strong></span>
<span class="strong"><strong>[2] cap.bus_info: "usb-musb-hdrc.1.auto-1.2"</strong></span>
<span class="strong"><strong>[2] cap.capabilities=0x85000001</strong></span>
<span class="strong"><strong>[2] - VIDEO_CAPTURE</strong></span>
<span class="strong"><strong>[2] - READWRITE</strong></span>
<span class="strong"><strong>[2] - STREAMING</strong></span>
<span class="strong"><strong>[2] Unable to query input 1 VIDIOC_ENUMINPUT: Invalid argument</strong></span>
<span class="strong"><strong>[2] ioctl (VIDIOCGCAP): Inappropriate ioctl for device</strong></span>
<span class="strong"><strong>[2] Could not fetch initial image from camera</strong></span>
<span class="strong"><strong>[2] Motion continues using width and height from config file(s)</strong></span>
<span class="strong"><strong>[1] Resizing pre_capture buffer to 1 items</strong></span>
<span class="strong"><strong>[2] Resizing pre_capture buffer to 1 items</strong></span>
<span class="strong"><strong>[2] Started stream webcam server in port 8082</strong></span>
</pre></div><p>As we can see from<a id="id387" class="indexterm"/> the preceding output, we can get a lot of useful information about the daemon status. First of all, we notice that each line begins with a number in square brackets that address per thread output. The number <code class="literal">0</code> is for the <code class="literal">motion</code> main thread, the number <code class="literal">1</code> is for the first thread connected to the first webcam (device <code class="literal">/dev/video0</code>), and the number <code class="literal">2</code> is for the second thread connected to the second webcam (device <code class="literal">/dev/video1</code>).</p><p>Then, we see that for the first webcam, the daemon says gives us the following output:</p><div class="informalexample"><pre class="programlisting">
<span class="strong"><strong>[1] cap.driver: "uvcvideo"</strong></span>
<span class="strong"><strong>[1] cap.card: "Microsoft LifeCam VX-800"</strong></span>
<span class="strong"><strong>[1] cap.bus_info: "usb-musb-hdrc.1.auto-1.1"</strong></span>
<span class="strong"><strong>[1] cap.capabilities=0x84000001</strong></span>
<span class="strong"><strong>[1] - VIDEO_CAPTURE</strong></span>
<span class="strong"><strong>[1] - STREAMING</strong></span>
<span class="strong"><strong>[1] Config palette index 8 (YU12) doesn't work.</strong></span>
<span class="strong"><strong>[1] Supported palettes:</strong></span>
<span class="strong"><strong>[1] 0: YUYV (YUV 4:2:2 (YUYV))</strong></span>
<span class="strong"><strong>[1] Selected palette YUYV</strong></span>
</pre></div><p>That is the current palette setting (YU12) is not valid for the webcam and the system says that it is going to use YUYV.</p><p>And an error message is displayed for thread 2:</p><div class="informalexample"><pre class="programlisting">
<span class="strong"><strong>[2] cap.driver: "gspca_zc3xx"</strong></span>
<span class="strong"><strong>[2] cap.card: "USB Camera (046d:08a2)"</strong></span>
<span class="strong"><strong>[2] cap.bus_info: "usb-musb-hdrc.1.auto-1.2"</strong></span>
<span class="strong"><strong>[2] cap.capabilities=0x85000001</strong></span>
<span class="strong"><strong>[2] - VIDEO_CAPTURE</strong></span>
<span class="strong"><strong>[2] - READWRITE</strong></span>
<span class="strong"><strong>[2] - STREAMING</strong></span>
<span class="strong"><strong>[2] Unable to query input 1 VIDIOC_ENUMINPUT: Invalid argument</strong></span>
<span class="strong"><strong>[2] ioctl (VIDIOCGCAP): Inappropriate ioctl for device</strong></span>
<span class="strong"><strong>[2] Could not fetch initial image from camera</strong></span>
</pre></div><p>This time, it seems like a severe error, but let's go step by step and fix the first camera. In the <code class="literal">/etc/motion/thread1.conf</code> file, we see the following settings (the following is just a snippet of the whole file):</p><div class="informalexample"><pre class="programlisting"># Videodevice to be used for capturing  (default /dev/video0)
# for FreeBSD default is /dev/bktr0
videodevice /dev/video0

# The video input to be used (default: 8)
# Should normally be set to 1 for video/TV cards, and 8 for USB cameras
input 8</pre></div><p>The <code class="literal">videodevice</code> and <code class="literal">input</code> settings are correct, but the video palette setting is missing, so the default <a id="id388" class="indexterm"/>one is used. As seen in the preceding output, it's wrong. To fix it, we must add the following lines:</p><div class="informalexample"><pre class="programlisting">
<span class="strong"><strong>--- /etc/motion/thread1.conf.orig   2014-04-23 21:12:25.712890999 +0000</strong></span>
<span class="strong"><strong>+++ /etc/motion/thread1.conf   2014-04-23 20:25:15.089843787 +0000</strong></span>
<span class="strong"><strong>@@ -12,6 +12,25 @@</strong></span>
<span class="strong"><strong> # for FreeBSD default is /dev/bktr0</strong></span>
<span class="strong"><strong> videodevice /dev/video0</strong></span>
<span class="strong"><strong> </strong></span>
<span class="strong"><strong>+# v4l2_palette allows to choose preferable palette to be use by motion</strong></span>
<span class="strong"><strong>+# to capture from those supported by your videodevice. (default: 8)</strong></span>
<span class="strong"><strong>+# E.g. if your videodevice supports both V4L2_PIX_FMT_SBGGR8 and</strong></span>
<span class="strong"><strong>+# V4L2_PIX_FMT_MJPEG then motion will by default use V4L2_PIX_FMT_MJPEG.</strong></span>
<span class="strong"><strong>+# Setting v4l2_palette to 1 forces motion to use V4L2_PIX_FMT_SBGGR8</strong></span>
<span class="strong"><strong>+# instead.</strong></span>
<span class="strong"><strong>+#</strong></span>
<span class="strong"><strong>+# Values :</strong></span>
<span class="strong"><strong>+# V4L2_PIX_FMT_SN9C10X : 0  'S910'</strong></span>
<span class="strong"><strong>+# V4L2_PIX_FMT_SBGGR8  : 1  'BA81'</strong></span>
<span class="strong"><strong>+# V4L2_PIX_FMT_MJPEG   : 2  'MJPEG'</strong></span>
<span class="strong"><strong>+# V4L2_PIX_FMT_JPEG    : 3  'JPEG'</strong></span>
<span class="strong"><strong>+# V4L2_PIX_FMT_RGB24   : 4  'RGB3'</strong></span>
<span class="strong"><strong>+# V4L2_PIX_FMT_UYVY    : 5  'UYVY'</strong></span>
<span class="strong"><strong>+# V4L2_PIX_FMT_YUYV    : 6  'YUYV'</strong></span>
<span class="strong"><strong>+# V4L2_PIX_FMT_YUV422P : 7  '422P'</strong></span>
<span class="strong"><strong>+# V4L2_PIX_FMT_YUV420  : 8  'YU12'</strong></span>
<span class="strong"><strong>+v4l2_palette 8</strong></span>
<span class="strong"><strong>+</strong></span>
<span class="strong"><strong> # The video input to be used (default: 8)</strong></span>
<span class="strong"><strong> # Should normally be set to 1 for video/TV cards, and 8 for USB cameras</strong></span>
<span class="strong"><strong> input 8</strong></span>
</pre></div><p>Note that I set the entry <code class="literal">v4l2_palette</code> to <code class="literal">6</code> in order to select the <code class="literal">YUYV</code> palette. Now, if we rerun the daemon, we get the following output:</p><div class="informalexample"><pre class="programlisting">
<span class="strong"><strong>[2] Thread 2 started</strong></span>
<span class="strong"><strong>[1] cap.driver: "uvcvideo"</strong></span>
<span class="strong"><strong>[1] cap.card: "Microsoft LifeCam VX-800"</strong></span>
<span class="strong"><strong>[1] cap.bus_info: "usb-musb-hdrc.1.auto-1.1"</strong></span>
<span class="strong"><strong>[1] cap.capabilities=0x84000001</strong></span>
<span class="strong"><strong>[1] - VIDEO_CAPTURE</strong></span>
<span class="strong"><strong>[1] - STREAMING</strong></span>
<span class="strong"><strong>[1] Test palette YUYV (320x240)</strong></span>
<span class="strong"><strong>[1] Using palette YUYV (320x240) bytesperlines 640 sizeimage 153600 colorspace 00000000</strong></span>
</pre></div><p>Great! Now, let's fix <a id="id389" class="indexterm"/>the configuration file for the second webcam. In the <code class="literal">/etc/motion/thread2.conf</code> file, we see the following output:</p><div class="informalexample"><pre class="programlisting"># Videodevice to be used for capturing  (default /dev/video0)
# for FreeBSD default is /dev/bktr0
videodevice /dev/video1

# The video input to be used (default: 8)
# Should normally be set to 1 for video/TV cards, and 8 for USB cameras
input 1</pre></div><p>Again, the <code class="literal">videodevice</code> setting is correct, but the <code class="literal">input</code> setting is not! So, let's fix it as shown in the following patch and then rerun the daemon:</p><div class="informalexample"><pre class="programlisting">
<span class="strong"><strong>--- /etc/motion/thread2.conf.orig   2014-04-23 21:12:30.703125375 +0000</strong></span>
<span class="strong"><strong>+++ /etc/motion/thread2.conf   2014-04-23 20:31:54.214843835 +0000</strong></span>
<span class="strong"><strong>@@ -14,7 +14,7 @@</strong></span>
<span class="strong"><strong> </strong></span>
<span class="strong"><strong> # The video input to be used (default: 8)</strong></span>
<span class="strong"><strong> # Should normally be set to 1 for video/TV cards, and 8 for USB cameras</strong></span>
<span class="strong"><strong>-input 1</strong></span>
<span class="strong"><strong>+input 6</strong></span>
<span class="strong"><strong> </strong></span>
<span class="strong"><strong> # Draw a user defined text on the images using same options as C #function strftime(3)</strong></span>
<span class="strong"><strong> # Default: Not defined = no text</strong></span>
</pre></div><p>Now, the daemon output for the second thread is changed as follows:</p><div class="informalexample"><pre class="programlisting">
<span class="strong"><strong>[2] cap.driver: "gspca_zc3xx"</strong></span>
<span class="strong"><strong>[2] cap.card: "USB Camera (046d:08a2)"</strong></span>
<span class="strong"><strong>[2] cap.bus_info: "usb-musb-hdrc.1.auto-1.2"</strong></span>
<span class="strong"><strong>[2] cap.capabilities=0x85000001</strong></span>
<span class="strong"><strong>[2] - VIDEO_CAPTURE</strong></span>
<span class="strong"><strong>[2] - READWRITE</strong></span>
<span class="strong"><strong>[2] - STREAMING</strong></span>
<span class="strong"><strong>[2] Config palette index 8 (YU12) doesn't work.</strong></span>
<span class="strong"><strong>[2] Supported palettes:</strong></span>
<span class="strong"><strong>[1] Resizing pre_capture buffer to 1 items</strong></span>
<span class="strong"><strong>[2] 0: JPEG (JPEG)</strong></span>
<span class="strong"><strong>[2] Selected palette JPEG</strong></span>
</pre></div><p>So, we have to <a id="id390" class="indexterm"/>modify the <code class="literal">/etc/motion/thread2.conf</code> file again as shown in the following patch:</p><div class="informalexample"><pre class="programlisting">
<span class="strong"><strong>--- /etc/motion/thread2.conf.orig   2014-04-23 20:34:51.173828231 +0000</strong></span>
<span class="strong"><strong>+++ /etc/motion/thread2.conf   2014-04-23 20:34:32.744140729 +0000</strong></span>
<span class="strong"><strong>@@ -12,6 +12,25 @@</strong></span>
<span class="strong"><strong> # for FreeBSD default is /dev/bktr0</strong></span>
<span class="strong"><strong> videodevice /dev/video1</strong></span>
<span class="strong"><strong> </strong></span>
<span class="strong"><strong>+# v4l2_palette allows to choose preferable palette to be use by motion</strong></span>
<span class="strong"><strong>+# to capture from those supported by your videodevice. (default: 8)</strong></span>
<span class="strong"><strong>+# E.g. if your videodevice supports both V4L2_PIX_FMT_SBGGR8 and</strong></span>
<span class="strong"><strong>+# V4L2_PIX_FMT_MJPEG then motion will by default use V4L2_PIX_FMT_MJPEG.</strong></span>
<span class="strong"><strong>+# Setting v4l2_palette to 1 forces motion to use V4L2_PIX_FMT_SBGGR8</strong></span>
<span class="strong"><strong>+# instead.</strong></span>
<span class="strong"><strong>+#</strong></span>
<span class="strong"><strong>+# Values :</strong></span>
<span class="strong"><strong>+# V4L2_PIX_FMT_SN9C10X : 0  'S910'</strong></span>
<span class="strong"><strong>+# V4L2_PIX_FMT_SBGGR8  : 1  'BA81'</strong></span>
<span class="strong"><strong>+# V4L2_PIX_FMT_MJPEG   : 2  'MJPEG'</strong></span>
<span class="strong"><strong>+# V4L2_PIX_FMT_JPEG    : 3  'JPEG'</strong></span>
<span class="strong"><strong>+# V4L2_PIX_FMT_RGB24   : 4  'RGB3'</strong></span>
<span class="strong"><strong>+# V4L2_PIX_FMT_UYVY    : 5  'UYVY'</strong></span>
<span class="strong"><strong>+# V4L2_PIX_FMT_YUYV    : 6  'YUYV'</strong></span>
<span class="strong"><strong>+# V4L2_PIX_FMT_YUV422P : 7  '422P'</strong></span>
<span class="strong"><strong>+# V4L2_PIX_FMT_YUV420  : 8  'YU12'</strong></span>
<span class="strong"><strong>+v4l2_palette 3</strong></span>
<span class="strong"><strong>+</strong></span>
<span class="strong"><strong> # The video input to be used (default: 8)</strong></span>
<span class="strong"><strong> # Should normally be set to 1 for video/TV cards, and 8 for USB cameras</strong></span>
<span class="strong"><strong> input 8</strong></span>
</pre></div><p>Now, if we <a id="id391" class="indexterm"/>rerun the daemon for the second thread, we get the following output:</p><div class="informalexample"><pre class="programlisting">
<span class="strong"><strong>[2] cap.driver: "gspca_zc3xx"</strong></span>
<span class="strong"><strong>[2] cap.card: "USB Camera (046d:08a2)"</strong></span>
<span class="strong"><strong>[2] cap.bus_info: "usb-musb-hdrc.1.auto-1.2"</strong></span>
<span class="strong"><strong>[2] cap.capabilities=0x85000001</strong></span>
<span class="strong"><strong>[2] - VIDEO_CAPTURE</strong></span>
<span class="strong"><strong>[2] - READWRITE</strong></span>
<span class="strong"><strong>[2] - STREAMING</strong></span>
<span class="strong"><strong>[2] Test palette JPEG (320x240)</strong></span>
<span class="strong"><strong>[2] Using palette JPEG (320x240) bytesperlines 320 sizeimage 29390 colorspace 00000007</strong></span>
</pre></div><p>Perfect! The webcams are now correctly configured.</p></div></div><div class="section" title="The web interface"><div class="titlepage"><div><div><h2 class="title"><a id="ch08lvl2sec71"/>The web interface</h2></div></div></div><p>Now it's time <a id="id392" class="indexterm"/>to verify the video output by directly seeing a video stream. To do it, <code class="literal">motion</code> sets up several web servers to be used to monitor the main thread (thread numbered <code class="literal">0</code>) and the per camera threads (threads numbered from <span class="emphasis"><em>1</em></span> to <span class="emphasis"><em>N</em></span>).</p><p>If we take a look at the <code class="literal">webcam_port</code> settings in the <code class="literal">motion.conf</code>, <code class="literal">thread1.conf</code> and <code class="literal">thread2.conf</code> files, we see that each thread opens a different monitoring port, as follows:</p><div class="informalexample"><pre class="programlisting">
<span class="strong"><strong>root@beaglebone:~# grep webcam_port /etc/motion/{motion,thread1,thread2}.conf</strong></span>
<span class="strong"><strong>/etc/motion/motion.conf:webcam_port 8081</strong></span>
<span class="strong"><strong>/etc/motion/thread1.conf:webcam_port 8081</strong></span>
<span class="strong"><strong>/etc/motion/thread2.conf:webcam_port 8082</strong></span>
</pre></div><p>The only settings that must be modified are <code class="literal">control_localhost</code> and <code class="literal">webcam_localhost</code>, which must be set to <code class="literal">off</code> in order to allow a remote control connection for the first thread and a remote webcam connection for the threads of each webcam. The patch is as follows:</p><div class="informalexample"><pre class="programlisting">
<span class="strong"><strong>--- /etc/motion/motion.conf.orig   2014-04-23 21:12:18.511719124 +0000</strong></span>
<span class="strong"><strong>+++ /etc/motion/motion.conf   2014-04-23 20:48:18.068359577 +0000</strong></span>
<span class="strong"><strong>@@ -410,7 +410,7 @@</strong></span>
<span class="strong"><strong> webcam_maxrate 1</strong></span>
<span class="strong"><strong> </strong></span>
<span class="strong"><strong> # Restrict webcam connections to localhost only (default: on)</strong></span>
<span class="strong"><strong>-webcam_localhost on</strong></span>
<span class="strong"><strong>+webcam_localhost off</strong></span>
<span class="strong"><strong> </strong></span>
<span class="strong"><strong> # Limits the number of images per connection (default: 0 = unlimited)</strong></span>
<span class="strong"><strong> # Number can be defined by multiplying actual webcam rate by desired number of seconds</strong></span>
<span class="strong"><strong>@@ -426,7 +426,7 @@</strong></span>
<span class="strong"><strong> control_port 8080</strong></span>
<span class="strong"><strong> </strong></span>
<span class="strong"><strong> # Restrict control connections to localhost only (default: on)</strong></span>
<span class="strong"><strong>-control_localhost on</strong></span>
<span class="strong"><strong>+control_localhost off</strong></span>
<span class="strong"><strong> </strong></span>
<span class="strong"><strong> # Output for http server, select off to choose raw text plain (default: on)</strong></span>
<span class="strong"><strong> control_html_output on</strong></span>
</pre></div><p>Note that the <a id="id393" class="indexterm"/>daemon doesn't start if the <code class="literal">8080</code> port is occupied by another running process (such as Apache, for instance). Verify that this is not this case.</p><p>Now, if we rerun the daemon, we can verify that the three <code class="literal">motion</code> web servers are running at the <code class="literal">8080</code>, <code class="literal">8081</code>, and <code class="literal">8082</code> ports using the following command line in a different terminal:</p><div class="informalexample"><pre class="programlisting">
<span class="strong"><strong>root@beaglebone:~# netstat -pnl | grep motion</strong></span>
<span class="strong"><strong>tcp        0      0 0.0.0.0:8080            0.0.0.0:*               LISTEN      2388/motion     </strong></span>
<span class="strong"><strong>tcp        0      0 0.0.0.0:8081            0.0.0.0:*               LISTEN      2388/motion     </strong></span>
<span class="strong"><strong>tcp        0      0 0.0.0.0:8082            0.0.0.0:*               LISTEN      2388/motion     </strong></span>
</pre></div><p>Great! Now, we can use a normal browser to connect to the main thread (thread number 0), but <a id="id394" class="indexterm"/>for us to check the webcams' output, we can get the per webcam video stream at <code class="literal">http://192.168.7.2:8081</code> and <code class="literal">http://192.168.7.2:8082</code>, as shown in the following screenshots:</p><div class="mediaobject"><img src="graphics/B00255_08_07.jpg" alt="The web interface"/></div><div class="mediaobject"><img src="graphics/B00255_08_08.jpg" alt="The web interface"/></div><div class="note" title="Note" style=""><div class="inner"><h3 class="title"><a id="tip107"/>Tip</h3><p>Note that in this last test, I executed the daemon without the <code class="literal">-s</code> option argument in order to disable the setup mode, that is, using the following command line:</p><div class="informalexample"><pre class="programlisting">
<span class="strong"><strong>root@beaglebone:~# motion -n</strong></span>
</pre></div><p>This is because I noticed that in the setup mode, the webcams work with a very bad video output (I don't know if this is a bug or a feature).</p></div></div><p>On the other hand, the control thread can be controlled via a web browser at <code class="literal">http://192.168.7.2:8080</code>. The following screenshot shows the main page:</p><div class="mediaobject"><img src="graphics/B00255_08_09.jpg" alt="The web interface"/></div><p>If we navigate to the <span class="strong"><strong>All</strong></span> | <span class="strong"><strong>Config</strong></span> | <span class="strong"><strong>list</strong></span> menu entries, we reach <code class="literal">http://192.168.7.2:8080/0/config/list</code>, where we can get a page with all the configuration <a id="id395" class="indexterm"/>settings of the main thread, as shown in the following screenshot:</p><div class="mediaobject"><img src="graphics/B00255_08_10.jpg" alt="The web interface"/></div><div class="note" title="Note" style=""><div class="inner"><h3 class="title"><a id="tip109"/>Tip</h3><p>Note that we are able to change each setting just by clicking on the relevant link and entering the new value. However, we're not going to use these interfaces to set up the system in this book.</p></div></div><p>As for the main thread, we can get the configuration of each running thread by just clicking on the relative link and then navigating to the menu. As an example, for the thread 1, we <a id="id396" class="indexterm"/>can read its current configuration at <code class="literal">http://192.168.7.2:8080/1/config/list</code>, as shown in the following screenshot:</p><div class="mediaobject"><img src="graphics/B00255_08_11.jpg" alt="The web interface"/></div></div><div class="section" title="Managing events"><div class="titlepage"><div><div><h2 class="title"><a id="ch08lvl2sec72"/>Managing events</h2></div></div></div><p>Now it's time to <a id="id397" class="indexterm"/>see how we can perform some actions when an event occurs. The <code class="literal">motion</code> daemon defines several events, all reported in the main configuration file. In fact, in the <code class="literal">/etc/motion/motion.conf</code> file, we see the following settings (again a snippet of the file):</p><div class="informalexample"><pre class="programlisting">############################################################
# External Commands, Warnings and Logging:
# You can use conversion specifiers for the on_xxxx commands
# %Y = year, %m = month, %d = date,
# %H = hour, %M = minute, %S = second,
# %v = event, %q = frame number, %t = thread (camera) number,
# %D = changed pixels, %N = noise level,
# %i and %J = width and height of motion area,
# %K and %L = X and Y coordinates of motion center
# %C = value defined by text_event
# %f = filename with full path
# %n = number indicating filetype
# Both %f and %n are only defined for on_picture_save,
# on_movie_start and on_movie_end
# Quotation marks round string are allowed.
############################################################

# Do not sound beeps when detecting motion (default: on)
# Note: motion never beeps when running in daemon mode.
quiet on

# Command to be executed when an event starts. (default: none)
# An event starts at first motion detected after a period of no motion defined by gap
; on_event_start value

# Command to be executed when an event ends after a period of no motion
# (default: none). The period of no motion is defined by option gap.
; on_event_end value

# Command to be executed when a picture (.ppm|.jpg) is saved (default: none)
# To give the filename as an argument to a command append it with %f
; on_picture_save value
 
# Command to be executed when a motion frame is detected (default: none)
; on_motion_detected value

# Command to be executed when motion in a predefined area is detected
# Check option 'area_detect'.   (default: none)
; on_area_detected value

# Command to be executed when a movie file (.mpg|.avi) is created. (default: none)
# To give the filename as an argument to a command append it with %f
; on_movie_start value

# Command to be executed when a movie file (.mpg|.avi) is closed. (default: none)
# To give the filename as an argument to a command append it with %f
; on_movie_end value

# Command to be executed when a camera can't be opened or if it is lost
# NOTE: There is situations when motion doesn't detect a lost camera!
# It depends on the driver, some drivers don't detect a lost camera at all
# Some hang the motion thread. Some even hang the PC! (default: none)
; on_camera_lost value</pre></div><p>These are all the <a id="id398" class="indexterm"/>possible events reported by the daemon, and here we can define the command to execute when one event occurs. We just have to enter a command file with specific arguments, and the daemon will call it at the right time. The allowed arguments are shown in the comment at the top of the preceding list.</p><p>As an example, and in order to better understand how the mechanism works, let's consider the following simple <span class="strong"><strong>Bash</strong></span> script named <code class="literal">args.sh</code>:</p><div class="informalexample"><pre class="programlisting">#!/bin/bash

NAME=$(basename $0)
ID=$RANDOM

function log ( ) { 
    echo "$(date "+%s.%N"): $NAME-$ID: $1"
} 

log "executing with $# args"

n=1
for arg ; do 
    log "$n) $arg" 
    n=$((n + 1))
done

log "done"

exit 0</pre></div><div class="note" title="Note" style=""><div class="inner"><h3 class="title"><a id="note86"/>Note</h3><p>The code is stored in the <code class="literal">chapter_08/bin/args.sh</code> script in the book's example code repository.</p></div></div><p>If we execute it from the command line, it simply prints its arguments (with a timestamp prefix) as follows:</p><div class="informalexample"><pre class="programlisting">
<span class="strong"><strong>root@beaglebone:~/chapter_08# ./args.sh arg1 "arg 2" "..." 'arg-N'</strong></span>
<span class="strong"><strong>1398299270.472083231: args.sh-12334: executing with 4 args</strong></span>
<span class="strong"><strong>1398299270.498241897: args.sh-12334: 1) arg1</strong></span>
<span class="strong"><strong>1398299270.523545772: args.sh-12334: 2) arg 2</strong></span>
<span class="strong"><strong>1398299270.548859939: args.sh-12334: 3) ...</strong></span>
<span class="strong"><strong>1398299270.574398731: args.sh-12334: 4) arg-N</strong></span>
<span class="strong"><strong>1398299270.599793272: args.sh-12334: done</strong></span>
</pre></div><div class="note" title="Note" style=""><div class="inner"><h3 class="title"><a id="tip110"/>Tip</h3><p>Note that the program prints a random number after its name. This is because we'll need a unique name to distinguish between thread 1 and thread 2 (see the following section).</p></div></div><p>Now, if we copy this script in the <code class="literal">/usr/local/bin/</code> directory, we can call it, as follows:</p><div class="informalexample"><pre class="programlisting">
<span class="strong"><strong>root@beaglebone:~/chapter_08# /usr/local/bin/args.sh test command line</strong></span>
<span class="strong"><strong>1398299445.322540043: args.sh-13425: executing with 3 args</strong></span>
<span class="strong"><strong>1398299445.348607251: args.sh-13425: 1) test</strong></span>
<span class="strong"><strong>1398299445.374537126: args.sh-13425: 2) command</strong></span>
<span class="strong"><strong>1398299445.400261585: args.sh-13425: 3) line</strong></span>
<span class="strong"><strong>1398299445.429571918: args.sh-13425: done</strong></span>
</pre></div><p>We can use this <a id="id399" class="indexterm"/>program with <code class="literal">motion</code> in order to discover which arguments are passed to an external program when an event occurs. As an example, we can consider the <code class="literal">on_picture_save</code> event. We can enable it with the following patch:</p><div class="informalexample"><pre class="programlisting">
<span class="strong"><strong>--- /etc/motion/motion.conf.orig   2014-04-23 21:12:18.511719124 +0000</strong></span>
<span class="strong"><strong>+++ /etc/motion/motion.conf   2015-09-11 20:58:19.334749400 +0000</strong></span>
<span class="strong"><strong>@@ -518,7 +518,7 @@</strong></span>
<span class="strong"><strong> </strong></span>
<span class="strong"><strong> # Command to be executed when a picture (.ppm|.jpg) is saved (default: #none)</strong></span>
<span class="strong"><strong> # To give the filename as an argument to a command append it with %f</strong></span>
<span class="strong"><strong>-; on_picture_save value</strong></span>
<span class="strong"><strong>+on_picture_save /usr/local/bin/args.sh %C %t %f</strong></span>
<span class="strong"><strong> </strong></span>
<span class="strong"><strong> # Command to be executed when a motion frame is detected (default: none)</strong></span>
<span class="strong"><strong> ; on_motion_detected value</strong></span>
</pre></div><p>In this manner, we ask <code class="literal">motion</code> to execute the <code class="literal">args.sh</code> script when a new picture is saved, passing to it the event's timestamp, the number of the thread that generated the event, and the full path name of the picture file.</p><p>Before running the daemon again, we must make sure that, in the per thread configuration file, the same event has been disabled by commenting on the relative line, as shown, for <a id="id400" class="indexterm"/>example, for the first thread, in the following patch:</p><div class="informalexample"><pre class="programlisting">
<span class="strong"><strong>--- /etc/motion/thread1.conf.orig   2014-04-23 21:12:25.712890999 +0000</strong></span>
<span class="strong"><strong>+++ /etc/motion/thread1.conf   2015-09-11 20:57:49.828890021 +0000</strong></span>
<span class="strong"><strong>@@ -50,7 +69,7 @@</strong></span>
<span class="strong"><strong> </strong></span>
<span class="strong"><strong> # Command to be executed when a picture (.ppm|.jpg) is saved (default: none)</strong></span>
<span class="strong"><strong> # The filename of the picture is appended as an argument for the command.</strong></span>
<span class="strong"><strong>-on_picture_save /usr/local/motion-extras/camparse1.pl</strong></span>
<span class="strong"><strong>+; on_picture_save /usr/local/motion-extras/camparse1.pl</strong></span>
<span class="strong"><strong> </strong></span>
<span class="strong"><strong> # Command to be executed when a movie file (.mpg|.avi) is closed. #(default: none)</strong></span>
</pre></div><div class="note" title="Note" style=""><div class="inner"><h3 class="title"><a id="tip111"/>Tip</h3><p>If you forget to disable the event in the webcams' threads, you'll get several errors, such as the following ones:</p><div class="informalexample"><pre class="programlisting">
<span class="strong"><strong>[2] File of type 1 saved to: /usr/local/apache2/htdocs/cam2/01-20150911205458-00.jpg</strong></span>
<span class="strong"><strong> &amp;: 1:  &amp;: /usr/local/motion-extras/camparse2.pl: not found</strong></span>
<span class="strong"><strong>[1] File of type 1 saved to: /usr/local/apache2/htdocs/cam1/01-20150911205555-01.jpg</strong></span>
<span class="strong"><strong> &amp;: 1:  &amp;: /usr/local/motion-extras/camparse1.pl: not found</strong></span>
</pre></div><p>So, remember to disable this setting for all running threads!</p></div></div><p>Now, if we execute the daemon again and do some movement in front of a camera, we get the following messages:</p><div class="informalexample"><pre class="programlisting">
<span class="strong"><strong>[1] File of type 1 saved to: /usr/local/apache2/htdocs/cam1/01-20150911210615-00.jpg</strong></span>
<span class="strong"><strong>1442005575.375926790: args.sh-7523: executing with 3 args</strong></span>
<span class="strong"><strong>1442005575.386901248: args.sh-7523: 1) 20150911210615</strong></span>
<span class="strong"><strong>1442005575.398043498: args.sh-7523: 2) 1</strong></span>
<span class="strong"><strong>1442005575.408981165: args.sh-7523: 3) /usr/local/apache2/htdocs/cam1/01-20150911210615-00.jpg</strong></span>
<span class="strong"><strong>1442005575.419728082: args.sh-7523: done</strong></span>
</pre></div><p>Great! Everything is  working correctly. Now, it's very easy to finish the job. In fact, we have to simply replace the <code class="literal">args.sh</code> script with a script that sends an e-mail to us with a picture <a id="id401" class="indexterm"/>attached! A snippet of a possible implementation of such program is as follows:</p><div class="informalexample"><pre class="programlisting">#
# Local functions
#

function log ( ) { 
    echo "[$cam] $1"
}

function send_alert { 
    # Build the attachments list 
    [ ! -e $ALERT_LIST ] &amp;&amp; return 
    for f in $(head -n $ALERT_LIMIT $ALERT_LIST) ; do 
        list="-a $f $list" 
    done 

    # Send the letter 
    echo -e ${ALERT_MESG/\%time/$time} | \ 
        mail -s "$ALERT_SUBJ" -r "$ALERT_FROM" $list "$ALERT_TO"
}

usage() { 
    echo "usage [to add image]: $NAME &lt;timestamp&gt;&lt;cam #&gt;&lt;filepath&gt;" &gt;&amp;2 
    echo "usage [to send alert]: $NAME &lt;timestamp&gt;&lt;cam #&gt;" &gt;&amp;2 
    exit 1
}

#
# Main
#
# Check command line
[ $# -lt 2 ] &amp;&amp; usage

( # Wait for lock on LOCK_FILE (fd 99) for 10 seconds
flock -w 10 -x 99 || exit 1

if [ $# -eq 3 ] ; then 
    # Must add the picture to the list 
    time=$1 
    cam=$2 
    path=$3 

    log "got new picture $path at $time" 
    echo "$path" &gt;&gt; $ALERT_LIST

elif [ $# -eq 2 ] ; then 
    # Send the mail alert 
    time=$1 
    cam=$2 

    log "sending alert at $time" 
    send_alert 
    rm $ALERT_LIST

else 

    cam="?" 
    log "invalid command!"

fi

# Release the lock
) 99&gt;$LOCK_FILE

exit 0</pre></div><div class="note" title="Note" style=""><div class="inner"><h3 class="title"><a id="note87"/>Note</h3><p>The complete code is stored in the <code class="literal">chapter_08/bin/send_alert.sh</code> script in the book's example code repository.</p></div></div><p>To use it, we <a id="id402" class="indexterm"/>have to copy it in <code class="literal">/usr/local/bin/</code>, as we did before, for the <code class="literal">args.sh</code> program. Then, we must replace all the occurrences of <code class="literal">args.sh</code> in the <code class="literal">/etc/motion/motion.conf</code> configuration file with <code class="literal">send_alert.sh</code>. When this is done, just rerun the <code class="literal">motion</code> daemon, and when a motion is detected, we should get a logging message as follows:</p><div class="informalexample"><pre class="programlisting">
<span class="strong"><strong>[1] File of type 1 saved to: /usr/local/apache2/htdocs/cam1/01-20150915210814-01.jpg</strong></span>
<span class="strong"><strong>[1] got new picture /usr/local/apache2/htdocs/cam1/01-20150915210814-01.jpg at 20150915210814</strong></span>
<span class="strong"><strong>[1] File of type 1 saved to: /usr/local/apache2/htdocs/cam1/01-20150915210815-00.jpg</strong></span>
<span class="strong"><strong>[1] got new picture /usr/local/apache2/htdocs/cam1/01-20150915210815-00.jpg at 20150915210814</strong></span>
<span class="strong"><strong>[1] File of type 1 saved to: /usr/local/apache2/htdocs/cam1/01-20150915210815-01.jpg</strong></span>
<span class="strong"><strong>[1] got new picture /usr/local/apache2/htdocs/cam1/01-20150915210815-01.jpg at 20150915210814</strong></span>
</pre></div><p>Note that it's <a id="id403" class="indexterm"/>quite common that a lot of pictures will be taken, so without some specific anti-flooding technique, we can risk to send tons of e-mails! The trick here is quite easy—using the <code class="literal">gap</code> and <code class="literal">on_event_end</code> options, we can generate an <span class="emphasis"><em>e-mail send</em></span> event once motion decides that the current event is finished. In fact, we can see the following by taking a look at the configuration filed:</p><div class="informalexample"><pre class="programlisting"># Gap is the seconds of no motion detection that triggers the end of an event
# An event is defined as a series of motion images taken within a short timeframe.
# Recommended value is 60 seconds (Default). The value 0 is allowed and disables
# events causing all Motion to be written to one single mpeg file and no pre_capture.
gap 60</pre></div><p>We can imagine storing the filenames of the images in a list, and then, when the <code class="literal">on_event_end</code> event occurs, we can read back the names and send one e-mail with attachments.</p><p>To enable the <code class="literal">on_event_end</code> event, I used to following setting:</p><div class="informalexample"><pre class="programlisting">
<span class="strong"><strong>--- /etc/motion/motion.conf.orig   2014-04-23 21:12:18.511719124 +0000</strong></span>
<span class="strong"><strong>+++ /etc/motion/motion.conf   2015-09-15 20:55:31.654352880 +0000</strong></span>
<span class="strong"><strong>@@ -514,11 +514,11 @@</strong></span>
<span class="strong"><strong> </strong></span>
<span class="strong"><strong> # Command to be executed when an event ends after a period of no motion</strong></span>
<span class="strong"><strong> # (default: none). The period of no motion is defined by option gap.</strong></span>
<span class="strong"><strong>-; on_event_end value</strong></span>
<span class="strong"><strong>+on_event_end /usr/local/bin/send_alert.sh %C %t</strong></span>
<span class="strong"><strong> </strong></span>
<span class="strong"><strong> # Command to be executed when a picture (.ppm|.jpg) is saved (default: none)</strong></span>
<span class="strong"><strong> # To give the filename as an argument to a command append it with %f</strong></span>
<span class="strong"><strong>-; on_picture_save value</strong></span>
<span class="strong"><strong>+on_picture_save /usr/local/bin/send_alert.sh %C %t %f</strong></span>
</pre></div><p>Here, the <code class="literal">send_alert.sh</code> script implements this solution. If we run it without arguments, it displays a short usage message as follows:</p><div class="informalexample"><pre class="programlisting">
<span class="strong"><strong>root@beaglebone:~# ./send_alert.sh</strong></span>
<span class="strong"><strong>usage [to add image]: send_alert.sh &lt;timestamp&gt; &lt;cam #&gt; &lt;filepath&gt;</strong></span>
<span class="strong"><strong>usage [to send alert]: send_alert.sh &lt;timestamp&gt; &lt;cam #&gt;</strong></span>
</pre></div><p>If executed <a id="id404" class="indexterm"/>with three arguments, it stores <code class="literal">filepath</code> in the file addressed by the <code class="literal">ALERT_LIST</code> variable, while when it is executed with two arguments, it rereads the file and sends an e-mail with a number of pictures (limited by the variable <code class="literal">ALERT_LIMIT</code>) as attachments.</p><p>To test if the program works correctly, we can try to execute it with just two arguments, and then verify that an e-mail message arrives to our account.</p></div></div>
<div class="section" title="Final test"><div class="titlepage"><div><div><h1 class="title"><a id="ch08lvl1sec48"/>Final test</h1></div></div></div><p>Now it's time <a id="id405" class="indexterm"/>to test our prototype. To do it, I decided to point the webcams toward my library shelf, where my precious stamp collection is kept. Then, I run the <code class="literal">motion</code> utility and just wait.</p><p>Note that this time, there is nothing special to do to configure the hardware.</p><p>After a while, I receive the following e-mail:</p><div class="mediaobject"><img src="graphics/B00255_08_12.jpg" alt="Final test"/></div><p>Then, looking at one <a id="id406" class="indexterm"/>picture, I discovered a very dangerous intruder.</p><div class="mediaobject"><img src="graphics/B00255_08_13.jpg" alt="Final test"/></div></div>
<div class="section" title="Summary"><div class="titlepage"><div><div><h1 class="title"><a id="ch08lvl1sec49"/>Summary</h1></div></div></div><p>In this chapter, there was very little hardware work to do, but on the other hand, we discovered how to use a really powerful tool named <code class="literal">motion</code>. This tool allows us to realize (quasi) professional, if minimal, anti-intrusion system. Also, you learned how to send simple e-mails with attached pictures to inform the user about an important event in the system.</p><p>In the next chapter, we'll discover how to use different identification devices (such as RFID readers and smart card readers) to implement an access control system.</p></div></body></html>