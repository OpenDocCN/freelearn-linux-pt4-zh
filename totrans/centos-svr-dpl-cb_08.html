<html><head></head><body><div class="chapter" title="Chapter&#xA0;8.&#xA0;Managing Domains and DNS"><div class="titlepage"><div><div><h1 class="title"><a id="ch08"/>Chapter 8. Managing Domains and DNS</h1></div></div></div><p>This chapter contains the following recipes:</p><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc">Setting up BIND as a resolving DNS server</li><li class="listitem" style="list-style-type: disc">Configuring BIND as an authoritative DNS server</li><li class="listitem" style="list-style-type: disc">Writing a reverse lookup zone file</li><li class="listitem" style="list-style-type: disc">Setting up a slave DNS server</li><li class="listitem" style="list-style-type: disc">Configuring <code class="literal">rndc</code> to control BIND</li></ul></div><div class="section" title="Introduction"><div class="titlepage"><div><div><h1 class="title"><a id="ch08lvl1sec67"/>Introduction</h1></div></div></div><p>In this chapter, you'll find recipes that cover working with BIND in various capacities to manage your domain infrastructure better. You'll learn how to configure BIND as a resolving DNS server capable of caching lookup results which can help reduce latency, and also how to configure BIND as an authoritative DNS server to provide authoritative responses publicly for your domain or for resources on your private intranet. Also discussed are handling reverse lookup requests and ensuring your resources remain accessible by configuring redundant, secondary authoritative DNS servers that perform master/slave-style transfers of zone records. Finally, you'll learn how to set up and use <code class="literal">rndc</code>, a very useful administration client for BIND servers.</p></div></div>
<div class="section" title="Setting up BIND as a resolving DNS server"><div class="titlepage"><div><div><h1 class="title"><a id="ch08lvl1sec68"/>Setting up BIND as a resolving DNS server</h1></div></div></div><p>This recipe teaches you how to set up a resolving DNS server using BIND. Domain Name Service (DNS) is the unsung workhorse of the Internet, which translates memorable names such as <code class="literal">facebook.com</code> and <code class="literal">google.com</code> to IP addresses such as <code class="literal">172.217.18.238</code> and <code class="literal">31.13.76.68</code>.</p><p>Communication across the Internet uses IP addresses to identify systems, but numbers are hard for people to remember. For example, it's easier for us to remember <code class="literal">google.com</code> than <code class="literal">172.217.18.238</code> (or the IPv6 address <code class="literal">2607:f8b0:4006:80e::200e</code>). So, when you type <code class="literal">google.com</code> in your browser's address bar, your system queries a DNS server to resolve the name to its IP address and then requests the page from the web server at that address. When you write an e-mail, a DNS server retrieves the IP address of the recipient's mail server before the message is sent.</p><p>A resolving DNS server maintained by your service provider is probably the first server to receive such lookup requests and it will respond immediately if it already happens to know the address. If not, it contacts the DNS servers in the requested domain's parent zone and receives either a referral to the authoritative DNS server of the requested domain or to servers in the next zone in the DNS hierarchy. If the request reaches the top of the hierarchy without being referred to an authoritative server, then the domain doesn't exist. Otherwise, the authoritative server sends the address back to your resolving server. The resolver then caches the response so that future lookups will complete faster.</p><p>Depending on your network and how many servers are involved in resolving an address, DNS lookups can become a significant source of latency. Address records should be found within the first one or two hops, and the resolving server should be physically close to the user for best performance. Because of this, setting up a local DNS server to cache lookup results can greatly improve how users experience the speed of your network.</p><div class="section" title="Getting ready"><div class="titlepage"><div><div><h2 class="title"><a id="ch08lvl2sec217"/>Getting ready</h2></div></div></div><p>This recipe requires a CentOS system with a working network connection. It assumes that the system is configured with the IP address <code class="literal">192.168.56.10</code>. Administrative privileges are also required, either by logging in with the <code class="literal">root</code> account or through the use of <code class="literal">sudo</code>.</p></div><div class="section" title="How to do it..."><div class="titlepage"><div><div><h2 class="title"><a id="ch08lvl2sec218"/>How to do it...</h2></div></div></div><p>Follow these steps to install BIND as a resolving DNS server:</p><div class="orderedlist"><ol class="orderedlist arabic"><li class="listitem">Install the <code class="literal">bind</code> and <code class="literal">bind-util</code> packages:<pre class="programlisting">
<span class="strong"><strong>yum install bind bind-utils</strong></span>
</pre></li><li class="listitem">Open BIND's configuration file at <code class="literal">/etc/named.conf</code> with your text editor:<pre class="programlisting">
<span class="strong"><strong>vi /etc/named.conf</strong></span>
</pre></li><li class="listitem">Find the <code class="literal">listen-on</code> option inside the braces of <code class="literal">options</code>. Update its list to reflect the system's IP addresses BIND will use:<pre class="programlisting">
<span class="strong"><strong>listen-on port 53 { 127.0.0.1; 192.168.56.10; };</strong></span>
</pre></li><li class="listitem">Change the value of <code class="literal">listen-on-v6</code> similarly if you want to service IPv6 requests. Otherwise, update the value to <code class="literal">none</code>:<pre class="programlisting">
<span class="strong"><strong>listen-on-v6 port 53 { none; }</strong></span>
</pre></li><li class="listitem">Update the <code class="literal">allow-query</code> option with the list of IP addresses that BIND is allowed to accept requests from:<pre class="programlisting">
<span class="strong"><strong>allow-query { localhost; 192.168.56.0/24; };</strong></span>
</pre></li><li class="listitem">Save your changes to the configuration file and close it.</li><li class="listitem">Start BIND with <code class="literal">systemctl</code>, optionally enable it to start automatically when the system reboots:<pre class="programlisting">
<span class="strong"><strong>systemctl start named.service</strong></span>
<span class="strong"><strong>systemctl enable named.service</strong></span>
</pre></li><li class="listitem">Enable FirewallD's <code class="literal">dns</code> service to open port <code class="literal">53</code> to TCP and UDP traffic:<pre class="programlisting">
<span class="strong"><strong>firewall-cmd --zone=public --permanent --add-service=dns</strong></span>
<span class="strong"><strong>firewall-cmd --reload</strong></span>
</pre></li><li class="listitem">Request a lookup using <code class="literal">dig</code> to test the configuration:<pre class="programlisting">
<span class="strong"><strong>dig @192.168.56.10 google.com A</strong></span>
</pre></li></ol></div></div><div class="section" title="How it works..."><div class="titlepage"><div><div><h2 class="title"><a id="ch08lvl2sec219"/>How it works...</h2></div></div></div><p>BIND is configured as a resolving DNS server by default but we still want to update a few options to define how it accepts lookup requests. The first change is to the <code class="literal">listen-on*</code> options found in the <code class="literal">options</code> section which specify the port and network interface BIND listens on for requests. <code class="literal">listen-on</code> applies to IPv4 networks and <code class="literal">listen-on-v6</code> applies to IPv6. In both cases, the standard port for DNS traffic is port <code class="literal">53</code>:</p><pre class="programlisting">
<span class="strong"><strong>listen-on port 53 { 127.0.0.1; 192.168.56.10; };</strong></span>
<span class="strong"><strong>listen-on-v6 port 53 { none; }</strong></span>
</pre><p>Next, we updated the <code class="literal">allow-query</code> option, providing a whitelist of systems that BIND may accept requests from. Addresses can be provided individually or written in CIDR notation:</p><pre class="programlisting">
<span class="strong"><strong>allow-query { localhost; 92.168.56.0/24; }</strong></span>
</pre><p>Using the predefined values such as <code class="literal">any</code>, <code class="literal">localhost</code>, <code class="literal">localnets</code>, and <code class="literal">none</code> is also acceptable. Intuitively, <code class="literal">any</code> represents all addresses, allowing BIND to listen on all of the system's configured addresses or accept requests from any source, whereas <code class="literal">none</code> disallows everything. <code class="literal">localhost</code> represents all of the system's addresses and <code class="literal">localnets</code> represents all addresses on all of the networks the system is a member of.</p><div class="note" style="" title="Note"><div class="inner"><h3 class="title"><a id="note52"/>Note</h3><p>Be careful that the <code class="literal">local</code> in <code class="literal">localhost</code> and <code class="literal">localnets</code> doesn't give you a false sense of security. If your system is connected to multiple networks, for example, a public network (such as the Internet) and a private internal network, both of them are considered local. Allowing access from untrusted networks is a serious risk without the necessary security measures in place because an open DNS server can be abused by malicious users intent on carrying out several types of denial of service attacks.</p></div></div><p>After BIND's configuration is updated and it's up and running, we can test everything by sending a lookup request with <code class="literal">dig</code> and inspect the response:</p><pre class="programlisting">
<span class="strong"><strong>dig @192.168.56.10 google.com A</strong></span>
</pre><p>Requests can be sent to a specific DNS server with <code class="literal">dig</code> by providing the targeted server's address prefixed by <code class="literal">@</code>. If a DNS server isn't given in the invocation, <code class="literal">dig</code> will send the request to the servers listed in your system's <code class="literal">/etc/resolve.conf</code> file.</p><p>After the address of the DNS server, we gave the resource name we're interested in followed by the desired record type. In the preceding example, the Address (<code class="literal">A</code>) record for <code class="literal">google.com</code> is sought. Other types can be queried too, such as the Name Server (<code class="literal">NS</code>) and Mail Exchange (<code class="literal">MX</code>) records.</p><div class="mediaobject"><img alt="How it works..." src="graphics/image_08_001.jpg"/><div class="caption"><p>dig queries the DNS servers and displays their response</p></div></div><p>The response from <code class="literal">dig</code> is organized into several sections. The <span class="strong"><strong>ANSWER SECTION</strong></span> shows the <code class="literal">A</code> record we requested. The <span class="strong"><strong>AUTHORITY SECTION</strong></span> lists the authoritative DNS servers configured for the requested domain, and the <span class="strong"><strong>ADDITIONAL SECTION</strong></span> shows the IP addresses of the authoritative servers. Various metadata is included throughout, such as which flags were set in the request, which DNS server was queried, and how long the lookup took to complete.</p><p>When you're satisfied with the testing results, you can configure the systems on your network to use the new DNS server. This is typically done by adding a <code class="literal">nameserver</code> entry in each system's <code class="literal">/etc/resolv.conf</code> file that provides the DNS server's address:</p><pre class="programlisting">
<span class="strong"><strong>nameserver 192.168.56.10</strong></span>
</pre><p><code class="literal">resolv.conf</code> may be dynamically generated depending on how the system's interfaces are configured. If this is the case, any changes you make in the file will be overwritten. You'll need to inspect the interfaces' configuration files (for example, <code class="literal">/etc/sysconf/network-scripts/ifcfg-enp0s3</code>), and if <code class="literal">PEERDNS</code> is set to <code class="literal">yes</code> then <code class="literal">resolv.conf</code> is maintained by the network manager. Add the <code class="literal">DNS</code> entry in the interface's configuration and the DNS server's address will make its way into <code class="literal">resolve.conf</code> the next time the interface is brought up:</p><pre class="programlisting">
<span class="strong"><strong>DNS=192.168.56.10</strong></span>
</pre><p>Bounce the interface after updating the configuration for the change to take effect and verify the contents of <code class="literal">resolve.conf</code>:</p><pre class="programlisting">
<span class="strong"><strong>ifdown enp0s3 &amp;&amp; ifup enp0s3</strong></span>
<span class="strong"><strong>cat /etc/resolv.conf</strong></span>
</pre><p>Resolving DNS servers are sometimes called recursive servers because they send lookup requests to each level in the zone hierarchy until they find an answer. Forwarding DNS servers function similarly to resolving/recursive servers, in that both types accept lookup requests and cache the results for expediency; however, forwarding servers send their requests to another DNS server and wait for the response, delegating the resolution process instead of tracking down the answer itself. This can offload a lot of the network chatter produced by a resolving DNS server trying to service a request.</p><p>To configure BIND to run as a forwarding DNS server, open <code class="literal">/etc/named.conf</code> again and add the <code class="literal">forwarders</code> and <code class="literal">forward</code> options to the <code class="literal">options</code> block:</p><pre class="programlisting">
<span class="strong"><strong>forwarders { 8.8.8.8; 8.8.4.4; };</strong></span>
<span class="strong"><strong>forward only;</strong></span>
</pre><p>The <code class="literal">forwarders</code> option provides a list of DNS servers responsible for resolving lookup requests. The example identifies Google's public DNS servers but your service provider should also maintain public DNS servers that you can use if you prefer.</p><p><code class="literal">forward only</code> forces BIND to forward requests to the responsible servers listed in <code class="literal">forwarders</code>. Only when the responsible server fails to return an address or a referral, will BIND contact the root servers for the domain's authoritative DNS servers and service the request itself. Recursion isn't completely turned off on a forwarding server but it is greatly reduced.</p></div><div class="section" title="See also"><div class="titlepage"><div><div><h2 class="title"><a id="ch08lvl2sec220"/>See also</h2></div></div></div><p>The following resources will provide you with more information on how DNS works and how to configure BIND:</p><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc">The <code class="literal">dig</code> manual page (<code class="literal">man 1 dig</code>)</li><li class="listitem" style="list-style-type: disc">An Introduction to DNS Terminology (<a class="ulink" href="http://www.digitalocean.com/community/tutorials/an-introduction-to-dns-terminology-components-and-concepts">http://www.digitalocean.com/community/tutorials/an-introduction-to-dns-terminology-components-and-concepts</a>)</li><li class="listitem" style="list-style-type: disc">DNS for Rocket Scientists (<a class="ulink" href="http://www.zytrax.com/books/dns/">http://www.zytrax.com/books/dns/</a>)</li><li class="listitem" style="list-style-type: disc">How DNS Works (<a class="ulink" href="http://howdns.works/">http://howdns.works/</a>)</li><li class="listitem" style="list-style-type: disc">BIND 9 Administrator Reference Manual (<a class="ulink" href="http://www.isc.org/downloads/bind/doc/">http://www.isc.org/downloads/bind/doc/</a>)</li><li class="listitem" style="list-style-type: disc">RHEL 7 Networking Guide: BIND (<a class="ulink" href="https://access.redhat.com/documentation/en-US/Red_Hat_Enterprise_Linux/7/html/Networking_Guide/sec-BIND.html">https://access.redhat.com/documentation/en-US/Red_Hat_Enterprise_Linux/7/html/Networking_Guide/sec-BIND.html</a>)</li><li class="listitem" style="list-style-type: disc">DNS &amp; BIND by Cricket Liu and Paul Albitz (<a class="ulink" href="http://shop.oreilly.com/product/9780596100575.do">http://shop.oreilly.com/product/9780596100575.do</a>)</li></ul></div></div></div>
<div class="section" title="Configuring BIND as an authoritative DNS server"><div class="titlepage"><div><div><h1 class="title"><a id="ch08lvl1sec69"/>Configuring BIND as an authoritative DNS server</h1></div></div></div><p>A benefit to hierarchical structures is that the responsibility for subordinate nodes can be delegated. Although the Internet Corporation for Assigned Names and Numbers (ICANN) has authority over the DNS directory, it delegates the responsibility to accredited registrars for top-level domains, such as <code class="literal">com</code>, <code class="literal">net</code>, and <code class="literal">org</code>, and delegates to the appropriate governmental agencies for country top-level domains, such as <code class="literal">ca</code>, <code class="literal">de</code>, and <code class="literal">es</code>. Registrars delegate responsibility to you when you register a domain and you may further delegate the responsibility for your subdomains however you please. Each boundary formed by delegating responsibility creates what is known as a DNS zone.</p><p>This recipe teaches you how to configure BIND to operate as an authoritative DNS server for your zone. If you recall the previous recipe's discussion on how a DNS request propagates, you'll remember that authoritative servers have the final say for a resolution. This is because its information comes from outside the DNS system, from an administrator who manually configures the zone's information. You'll also learn how to write a zone file with information such as mapping hostnames to IP addresses, which, I promise, isn't as scary as it might look at first glance.</p><div class="section" title="Getting ready"><div class="titlepage"><div><div><h2 class="title"><a id="ch08lvl2sec221"/>Getting ready</h2></div></div></div><p>This recipe requires a CentOS system with BIND configured as a resolving DNS server, as described in the previous recipe (BIND's configuration will be updated to operate as an authoritative server). Administrative privileges are also required, either by logging in with the <code class="literal">root</code> account or through the use of <code class="literal">sudo</code>.</p><p>Following the advice of RFC-2606 (Reserved Top Level DNS Names), I'll use the <code class="literal">example.com</code> domain for illustration. If you have your own domain name then feel free to substitute. Also for the sake of illustration, the recipe will reflect a network of various servers that handle the different services one commonly finds in a domain, such as e-mail servers and web servers. The systems are as follows:</p><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc"><code class="literal">ns1</code>: Hosts the domain's primary authoritative DNS server with the IP address <code class="literal">192.168.56.10</code> (this is the system we'll be working on)</li><li class="listitem" style="list-style-type: disc"><code class="literal">ns2</code>: Hosts a secondary authoritative DNS server with the address <code class="literal">192.168.56.20</code></li><li class="listitem" style="list-style-type: disc"><code class="literal">mail</code>: Hosts the primary e-mail server with the address <code class="literal">192.168.56.12</code></li><li class="listitem" style="list-style-type: disc"><code class="literal">mail2</code>: Hosts a secondary e-mail server with the address <code class="literal">192.168.56.22</code></li><li class="listitem" style="list-style-type: disc"><code class="literal">www</code>: Hosts a web and FTP server with the address <code class="literal">192.168.56.100</code></li></ul></div></div><div class="section" title="How to do it..."><div class="titlepage"><div><div><h2 class="title"><a id="ch08lvl2sec222"/>How to do it...</h2></div></div></div><p>Follow these steps to configure BIND as an authoritative DNS server:</p><div class="orderedlist"><ol class="orderedlist arabic"><li class="listitem">Open <code class="literal">/etc/named.conf</code> with your text editor:<pre class="programlisting">
<span class="strong"><strong>vi /etc/named.conf</strong></span>
</pre></li><li class="listitem">Verify that the <code class="literal">listen-on*</code> and <code class="literal">allow-query</code> options are configured as described in the previous recipe:<pre class="programlisting">
<span class="strong"><strong>listen-on port 52 { 127.0.0.1; 192.168.56.10; };</strong></span>
<span class="strong"><strong>listen-on-v6 port 52 { none; };</strong></span>
<span class="strong"><strong>allow-query { 192.168.56.0/24; };</strong></span>
</pre></li><li class="listitem">Change the value of the <code class="literal">recursion</code> option to <code class="literal">no</code> to disable BIND's recursive lookup behavior completely:<pre class="programlisting">
<span class="strong"><strong>recursion no;</strong></span>
</pre></li><li class="listitem">At the end of the file, add the following zone configuration:<pre class="programlisting">
<span class="strong"><strong>zone "example.com." in {</strong></span>
<span class="strong"><strong>       type master;</strong></span>
<span class="strong"><strong>       file "/var/named/zones/example.com.fwd";</strong></span>
<span class="strong"><strong>       allow-transfer { none; };</strong></span>
<span class="strong"><strong>};</strong></span>
</pre></li><li class="listitem">Save your changes and close the file.</li><li class="listitem">Create the <code class="literal">/var/named/zones</code> directory:<pre class="programlisting">
<span class="strong"><strong>mkdir /var/named/zones</strong></span>
</pre></li><li class="listitem">Create the zone file <code class="literal">/var/named/zones/example.com.fwd</code> with the following content (our discussion in <span class="emphasis"><em>How it works...</em></span> will help you understand the meaning of each record):<pre class="programlisting">
<span class="strong"><strong>$TTL 1d</strong></span>
<span class="strong"><strong>$ORIGIN example.com.</strong></span>
<span class="strong"><strong>; start of authority resource record</strong></span>
<span class="strong"><strong>@       IN SOA   ns1 hostmaster.example.com. (</strong></span>
<span class="strong"><strong>                    2016041501 ; serial</strong></span>
<span class="strong"><strong>                    12h        ; refresh</strong></span>
<span class="strong"><strong>                    5m         ; retry</strong></span>
<span class="strong"><strong>                    2w         ; expire</strong></span>
<span class="strong"><strong>                    3h)        ; negative TTL</strong></span>
<span class="strong"><strong>; nameserver records</strong></span>
<span class="strong"><strong>           IN NS    ns1</strong></span>
<span class="strong"><strong>           IN NS    ns2</strong></span>
<span class="strong"><strong>ns1     IN A     192.168.56.10 </strong></span>
<span class="strong"><strong>ns2     IN A     192.168.56.20</strong></span>
<span class="strong"><strong>; mail records</strong></span>
<span class="strong"><strong>@       IN MX    10 mail</strong></span>
<span class="strong"><strong>           IN MX    20 mail2</strong></span>
<span class="strong"><strong>mail    IN A     192.168.56.12</strong></span>
<span class="strong"><strong>mail2   IN A     192.168.56.22</strong></span>
<span class="strong"><strong>; webserver records</strong></span>
<span class="strong"><strong>@       IN A     192.168.56.100</strong></span>
<span class="strong"><strong>www     IN CNAME @</strong></span>
<span class="strong"><strong>ftp     IN CNAME @</strong></span>
</pre></li><li class="listitem">Ensure that the directory and zone file have the correct ownership and access permissions:<pre class="programlisting">
<span class="strong"><strong>chown root.named /var/named/zones</strong></span>
<span class="strong"><strong>chmod 750 /var/named/zones</strong></span>
<span class="strong"><strong>chmod 640 /var/named/zones/*</strong></span>
</pre></li><li class="listitem">Restart BIND for the configuration changes to take effect:<pre class="programlisting">
<span class="strong"><strong>systemctl restart named.service</strong></span>
</pre></li><li class="listitem">Request a lookup using dig to test the configuration:<pre class="programlisting">
<span class="strong"><strong>dig @192.168.56.10 example.com SOA</strong></span>
</pre></li></ol></div></div><div class="section" title="How it works..."><div class="titlepage"><div><div><h2 class="title"><a id="ch08lvl2sec223"/>How it works...</h2></div></div></div><p>The only records an authoritative DNS server should serve are those with authoritative information about its zones, so we began by disabling <code class="literal">recursion</code> in BIND's configuration file. When disabled, BIND won't forward requests or try to resolve a lookup request for non-authoritative records:</p><pre class="programlisting">
<span class="strong"><strong>recursion off;</strong></span>
</pre><p>Then we added a short section at the end of the configuration file that specifies how the BIND server should function for the <code class="literal">example.com.</code> zone:</p><pre class="programlisting">
<span class="strong"><strong>zone "example.com." in {</strong></span>
<span class="strong"><strong>    type master;</strong></span>
<span class="strong"><strong>    file "/var/named/zones/example.com.fwd";</strong></span>
<span class="strong"><strong>    allow-transfer { none; };</strong></span>
<span class="strong"><strong>};</strong></span>
</pre><p>The section starts with the keyword <code class="literal">zone</code> to denote a zone configuration and is followed by the zone's name given as a fully qualified domain name (FQDN). FQDNs always end with a dot because they include all of the delegated paths, including the root. Since the root of the DNS system doesn't have a name, its separator appears as a trailing dot. Thus, <code class="literal">example.com.</code> is fully qualified but <code class="literal">example.com</code> is not. (Some people misuse the term FQDN when they're really talking about partially qualified domain names. This is one of my irrational pet peeves so consider yourself warned.)</p><div class="note" style="" title="Note"><div class="inner"><h3 class="title"><a id="note53"/>Note</h3><p>Thinking about how you navigate the filesystem can help you understanding the difference between the fully qualified and partially qualified names. Navigation, when the absolute (fully qualified) path <code class="literal">/var/named</code> is given, begins at the root of the filesystem, descends into the <code class="literal">var</code> directory, and then into <code class="literal">named</code>. The root directory has no name other than its separator. However, the relative (partially qualified) path <code class="literal">var/named</code> doesn't start with the separator. Its navigation begins where the current directory happens to be at the moment. Domain names are similar, but they list traverse the hierarchy backwards toward the root, and the dot is used as a separator instead of a slash.</p></div></div><p>The <code class="literal">type master</code> option specifies this server as the zone's primary authoritative DNS server. A common deployment strategy sets up several authoritative servers in a master/slave configuration. An administrator updates the zone information on the primary, which is identified as the master; the information is then transferred to one or more slaves acting as secondary authoritative DNS servers. You'll learn how to set this up in the <span class="emphasis"><em>Setting up a slave DNS server</em></span> recipe, but for now we'll only focus on the primary server.</p><p>The <code class="literal">allow-transfers</code> option lists the slave systems this server is allowed to respond to when a request is received for zone information transfers, but since we don't (yet) have a secondary authoritative DNS server configured, we've used <code class="literal">none</code> to disable transfers. This helps to protect us from a specific type of denial of service attack. Resource records are small enough to fit in a UDP packet or two during normal lookup activity, but zone transfers transmit all of the records in bulk over TCP. Malicious users repeatedly sending transfer requests in quick succession can saturate your network.</p><p>The zone's information is stored in a text file known as a <span class="strong"><strong>zone file</strong></span> whose location is given with the <code class="literal">file</code> option. The convention followed in this chapter places the files in a <code class="literal">zone</code> directory under <code class="literal">/var/named</code> and uses <code class="literal">fwd</code> and <code class="literal">rev</code> as file extensions to indicate whether the file is a forward lookup or a reverse lookup zone file. Thus, our file is saved as <code class="literal">/var/named/zones/example.com.fwd</code>.</p><p>This recipe's file is a forward zone file because it maps names to their IP addresses. A reverse lookup zone maps the inverse relationship, which is addresses to names. They are discussed in the <span class="emphasis"><em>Writing a reverse lookup zone file</em></span> recipe.</p><div class="note" style="" title="Note"><div class="inner"><h3 class="title"><a id="note54"/>Note</h3><p>I've seen a handful of different conventions followed when it comes to naming zone files. Some administrators use <code class="literal">zon</code> or <code class="literal">zone</code> as the file's extension. Some will separate the zone files in the directories named
<code class="literal">fwd-zone</code> and <code class="literal">rev-zone</code>. Honestly, it really doesn't matter what you do as long as you stay consistent <code class="literal">systemctl restart named.servicent</code> and your files are well organized.</p></div></div><p><code class="literal">$TTL</code> is the first directive given in the zone file and gives the default length of time a resolving DNS server may cache records it receives from the authoritative server. Specific records may provide their own TTL, which overrides this default value:</p><pre class="programlisting">
<span class="strong"><strong>$TTL 14400</strong></span>
</pre><p>The <code class="literal">$ORIGIN</code> directive provides the FQDN identifying the zone. Any <code class="literal">@</code> appearing in the file will be replaced by the value of <code class="literal">$ORIGIN</code>:</p><pre class="programlisting">
<span class="strong"><strong>$ORIGIN example.com.</strong></span>
</pre><p>The remaining entries are collectively called resource records and are made up of a series of fields in the order <code class="literal">name ttl class type values</code>. The <code class="literal">name</code> field gives the name of the resource that owns the record. If blank, its value defaults to the name used in the previous record. <code class="literal">ttl</code> is also optional, defaulting to the value of <code class="literal">$TTL</code>. And for our purposes, <code class="literal">class</code> will always be <code class="literal">IN</code> because we're writing the Internet resource records. The other classes are <code class="literal">CH</code> for Chaos and <code class="literal">HS</code> for Hesiod but they aren't in widespread use.</p><p>The first record in the file must be the start of authority (<code class="literal">SOA</code>) record which identifies that this server is the authoritative DNS server for the zone. The values for a <code class="literal">SOA</code> record are the name of the primary authoritative server for the zone (we supplied <code class="literal">ns1</code>), an e-mail address for the person responsible for the zone (<code class="literal">hostmaster.example.com.</code>), a serial number (<code class="literal">2016041501</code>), refresh duration (<code class="literal">12h</code>), retry duration (<code class="literal">5m</code>), expiration duration (<code class="literal">2w</code>), and the length of time negative responses (sent when the requested record doesn't exist) from the server can be cached (<code class="literal">3h</code>). Records are usually written as single-line entries, but parentheses permit us to split the record over several lines:</p><pre class="programlisting">
<span class="strong"><strong>; start of authority resource record</strong></span>
<span class="strong"><strong>@       IN SOA   ns1 hostmaster.example.com. (</strong></span>
<span class="strong"><strong>                 2016041501 ; serial</strong></span>
<span class="strong"><strong>                 12h        ; refresh</strong></span>
<span class="strong"><strong>                 5m         ; retry</strong></span>
<span class="strong"><strong>                 2w         ; expire</strong></span>
<span class="strong"><strong>                 3h)        ; negative TTL</strong></span>
</pre><p>The <code class="literal">@</code> variable that would normally appear in the e-mail addresses is changed to a dot in <code class="literal">hostmaster.example.com.</code> because <code class="literal">@</code> has special meaning in zone files. Also notice which names are fully qualified. Names that aren't fully qualified will have the FQDN appended automatically, so <code class="literal">ns1</code> is understood as <code class="literal">ns1.example.com.</code>. If the e-mail address's domain part wasn't fully qualified then <code class="literal">hostmaster.example.com</code> would be treated as <code class="literal">hostmaster.example.com.example.com.</code>, which certainly isn't what we want.</p><p>Values beyond that in the <code class="literal">SOA</code> record are primarily of interest to the slave DNS servers. The refresh value informs the slave how often it should try to refresh its copy of the zone file. The retry duration tells the slave how long it should wait between connection attempts if the master is unreachable, and the expiry value specifies how long the slave can satisfy lookup requests as an authoritative server with its copy of the zone file if contact with the master is completely lost. The negative TTL is the length of time a resolver should cache negative responses from a DNS server, for example, <code class="literal">NXDOMAIN</code> and <code class="literal">NODATA</code> responses.</p><p>The serial number is an arbitrary that 10-digit value slaves can use to differentiate this version of the zone file from previous versions. Anytime you update the file, you must also update the serial number. A popular convention is to use the current date followed by a sequence counter. For example, April 15, 2016 is written as <code class="literal">20160415</code> and then two additional digits are added to identify multiple updates during the same day (<code class="literal">2016041501</code>, <code class="literal">2016041502</code>, <code class="literal">2016041503</code>, and so on).</p><p>Next, we gave the <code class="literal">NS</code> records that identify the zone's authoritative DNS servers. The <code class="literal">SOA</code> and <code class="literal">NS</code> records are mandatory in every zone file:</p><pre class="programlisting">
<span class="strong"><strong>; nameserver records</strong></span>
<span class="strong"><strong>        IN NS    ns1</strong></span>
<span class="strong"><strong>        IN NS    ns2</strong></span>
<span class="strong"><strong>ns1     IN A     192.168.56.10 </strong></span>
<span class="strong"><strong>ns2     IN A     192.168.56.20</strong></span>
</pre><p>The <code class="literal">NS</code> records identify the names of the authoritative servers. In the preceding example, we defined <code class="literal">n1</code> and <code class="literal">n2</code> as the zone's authoritative DNS servers which are understood as <code class="literal">ns1.example.com.</code> and <code class="literal">ns2.example.com.</code> since they are not fully qualified. The <code class="literal">A</code> records map a name to its address (<code class="literal">AAAA</code> is used for IPv6 addresses). The records we wrote in the example say <code class="literal">ns1.example.com.</code> can be reached at <code class="literal">192.168.56.10</code> and <code class="literal">ns2.example.com.</code> can be reached at <code class="literal">192.168.56.20</code>.</p><div class="note" style="" title="Note"><div class="inner"><h3 class="title"><a id="note55"/>Note</h3><p>The <code class="literal">NS</code> records belong to the zone but I left the first field of the <code class="literal">NS</code> records blank since the field defaults to the name used in the last record. In this case, the name happens to be <code class="literal">@</code> from the <code class="literal">SOA</code> record (which is <code class="literal">$ORIGIN</code>). Any of the following alternatives mean the same and are equally acceptable:</p><p>
</p><pre class="programlisting">
<span class="strong"><strong>@ IN NS n1</strong></span>
<span class="strong"><strong>$ORIGIN IN NS n1</strong></span>
<span class="strong"><strong>example.com. IN NS n1</strong></span></pre><p>
</p><p>However, be careful because the <code class="literal">MX</code> records also belong to the zone. As we begin the next set of records, the last name is <code class="literal">ns2</code> from that server's <code class="literal">A</code> record. This means the first <code class="literal">MX</code> record must provide either <code class="literal">@</code>, <code class="literal">$ORIGIN</code>, or <code class="literal">example.com.</code>.</p></div></div><p>The <code class="literal">MX</code> records define the names of the servers responsible for handling e-mail for the zone. The mailers are assigned a relative preference and a client will try to communicate with the mail server with the lowest preference first. If the server is unreachable, the client attempts to connect to the next lowest until it exhausts the list:</p><pre class="programlisting">
<span class="strong"><strong>; mail records</strong></span>
<span class="strong"><strong>@       IN MX    10 mail</strong></span>
<span class="strong"><strong>        IN MX    20 mail2</strong></span>
<span class="strong"><strong>mail    IN A     192.168.56.12</strong></span>
<span class="strong"><strong>mail2   IN A     192.168.56.22</strong></span>
</pre><p>Our configuration defines the principal mail server <code class="literal">mail.example.com.</code> with the IP address <code class="literal">192.168.56.12</code> and a relative preference of 10. The second server, perhaps a backup in the event of an outage, is <code class="literal">mail2.example.com.</code> at <code class="literal">192.168.56.22</code> with a preference of 20.</p><p>Last, we defined records that identify our zone's web server and other aliases for the system:</p><pre class="programlisting">
<span class="strong"><strong>; webserver records</strong></span>
<span class="strong"><strong>@       IN A     192.168.56.100</strong></span>
<span class="strong"><strong>www     IN CNAME @</strong></span>
<span class="strong"><strong>ftp     IN CNAME @</strong></span>
</pre><p>The ubiquity of <code class="literal">www</code> appearing at the beginning of URLs has waned since the good old days of the dot-com era. Still, many zones resolve the addresses both with and without <code class="literal">www</code> to the same IP. Our configuration does the same, returning <code class="literal">192.168.56.100</code> for lookups of both <code class="literal">example.com</code> or <code class="literal">www.example.com</code>. This is accomplished by creating the <code class="literal">A</code> record that maps the domain to the web server's address and then a Canonical Name (<code class="literal">CNAME</code>) record that aliases <code class="literal">www</code> to the domain's <code class="literal">A</code> record. Our configuration also aliases <code class="literal">ftp</code> to the <code class="literal">A</code> record so that users can upload their site's files to the web server using the address <code class="literal">ftp.example.com</code>.</p></div><div class="section" title="See also"><div class="titlepage"><div><div><h2 class="title"><a id="ch08lvl2sec224"/>See also</h2></div></div></div><p>Refer to the following resources for more information on running a DNS server and managing your domain:</p><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc">BIND 9 Administrator Reference Manual (<a class="ulink" href="http://www.isc.org/downloads/bind/doc">http://www.isc.org/downloads/bind/doc</a>)</li><li class="listitem" style="list-style-type: disc">Five Basic Mistakes Not to Make in DNS (<a class="ulink" href="http://archive.oreilly.com/pub/a/sysadmin/2007/04/26/5-basic-mistakes-not-to-make-in-dns.html">http://archive.oreilly.com/pub/a/sysadmin/2007/04/26/5-basic-mistakes-not-to-make-in-dns.html</a>)</li><li class="listitem" style="list-style-type: disc">BIND for the Small LAN (<a class="ulink" href="http://www.madboa.com/geek/soho-bind">http://www.madboa.com/geek/soho-bind</a>)</li><li class="listitem" style="list-style-type: disc">RFC-1034: Domain Concepts and Facilities (<a class="ulink" href="https://tools.ietf.org/html/rfc1034">https://tools.ietf.org/html/rfc1034</a>)</li><li class="listitem" style="list-style-type: disc">RFC-1035: Domain Names-Implementation and Specification (<a class="ulink" href="https://tools.ietf.org/html/rfc1035">https://tools.ietf.org/html/rfc1035</a>)</li><li class="listitem" style="list-style-type: disc">RFC-1912: Common DNS Operational and Configuration Errors (<a class="ulink" href="https://tools.ietf.org/html/rfc1912">https://tools.ietf.org/html/rfc1912</a>)</li></ul></div></div></div>
<div class="section" title="Writing a reverse lookup zone file"><div class="titlepage"><div><div><h1 class="title"><a id="ch08lvl1sec70"/>Writing a reverse lookup zone file</h1></div></div></div><p>Until now we've treated DNS requests as forward facing lookups, translating resource names like <code class="literal">www.example.com</code> to an IP address. However, services can also ask a DNS server to resolve information in the opposite direction by providing an IP address and want to know what name it's associated with. Reverse lookups such as these are especially useful for logging or authentication and security purposes. For example, a system can query a DNS server to verify that a client really is connecting from the system they claim. To accommodate such requests, this recipe shows you how to write a reverse lookup zone file.</p><div class="section" title="Getting ready"><div class="titlepage"><div><div><h2 class="title"><a id="ch08lvl2sec225"/>Getting ready</h2></div></div></div><p>This recipe requires a CentOS system with BIND installed and configured as described in the previous recipes. Administrative privileges are also required, either by logging in with the <code class="literal">root</code> account or through the use of <code class="literal">sudo</code>.</p></div><div class="section" title="How to do it..."><div class="titlepage"><div><div><h2 class="title"><a id="ch08lvl2sec226"/>How to do it...</h2></div></div></div><p>Follow these steps to add a reverse lookup zone:</p><div class="orderedlist"><ol class="orderedlist arabic"><li class="listitem">Open BIND's configuration file:<pre class="programlisting">
<span class="strong"><strong>vi /etc/named.conf</strong></span>
</pre></li><li class="listitem">Add the following zone entry:<pre class="programlisting">
<span class="strong"><strong>zone "56.168.192.in-addr.arpa." in {</strong></span>
<span class="strong"><strong>       type master;</strong></span>
<span class="strong"><strong>       file "/var/named/zones/example.com.rev";</strong></span>
<span class="strong"><strong>       allow-transfer { none; };</strong></span>
<span class="strong"><strong>};</strong></span>
</pre></li><li class="listitem">Save your changes and close the configuration file.</li><li class="listitem">Create the <code class="literal">/etc/named/zones/example.com.rev</code> file with the following content:<pre class="programlisting">
<span class="strong"><strong>$TTL 1d</strong></span>
<span class="strong"><strong>$ORIGIN 56.168.192.in-addr.arpa.</strong></span>
<span class="strong"><strong>; start of authority</strong></span>
<span class="strong"><strong>@   IN SOA  ns1.example.com. hostmaster.example.com. (</strong></span>
<span class="strong"><strong>               2016041501 ; serial</strong></span>
<span class="strong"><strong>               12h        ; refresh</strong></span>
<span class="strong"><strong>               5m         ; retry</strong></span>
<span class="strong"><strong>               2w         ; expire</strong></span>
<span class="strong"><strong>               3h)        ; error TTL</strong></span>
<span class="strong"><strong>; nameservers</strong></span>
<span class="strong"><strong>       IN NS   ns1.example.com.</strong></span>
<span class="strong"><strong>       IN NS   ns2.example.com.</strong></span>
<span class="strong"><strong>10  IN PTR  ns1.example.com.</strong></span>
<span class="strong"><strong>20  IN PTR  ns2.example.com.</strong></span>
<span class="strong"><strong>; mail servers</strong></span>
<span class="strong"><strong>12  IN PTR  mail.example.com.</strong></span>
<span class="strong"><strong>22  IN PTR  mail2.example.com.</strong></span>
<span class="strong"><strong>; web servers</strong></span>
<span class="strong"><strong>100 IN PTR  example.com.</strong></span>
<span class="strong"><strong>100 IN PTR  www.example.com.</strong></span>
<span class="strong"><strong>100 IN PTR  ftp.example.com.</strong></span>
</pre></li><li class="listitem">Ensure that the zone file has the correct ownership and access permissions:<pre class="programlisting">
<span class="strong"><strong>chown root.named /var/named/zones/example.com.rev</strong></span>
<span class="strong"><strong>chmod 640 /var/named/zones/example.com.rev</strong></span>
</pre></li><li class="listitem">Restart BIND for the configuration changes to take effect:<pre class="programlisting">
<span class="strong"><strong>systemctl restart named.service</strong></span>
</pre></li><li class="listitem">Perform a reverse DNS lookup using <code class="literal">dig</code> to test the zone:<pre class="programlisting">
<span class="strong"><strong>dig @192.168.56.10 -x 192.168.56.100</strong></span>
</pre></li></ol></div></div><div class="section" title="How it works..."><div class="titlepage"><div><div><h2 class="title"><a id="ch08lvl2sec227"/>How it works...</h2></div></div></div><p>Reverse lookup zones are just like any other zones defined by a zone file. So, hopefully nothing in this recipe came as a big surprise to you. Nevertheless, there are still a few points worth reviewing.</p><p>First, the zone's name is constructed by combining the network's address with the special domain <code class="literal">in-addr.arpa</code>, which is used to define reverse-mapped IP addresses (<code class="literal">ip6.arpa</code> is used for IPv6). The order of the address's octets is reversed to maintain consistency with domain names that read from the most specific to the most broad. Thus, <code class="literal">56.168.192.in-addr.arpa.</code> is the FQDN for reverse lookups on addresses in the <code class="literal">192.168.56/24</code> address space:</p><pre class="programlisting">
<span class="strong"><strong>zone "56.168.192.in-addr.arpa." in {</strong></span>
<span class="strong"><strong>    type master;</strong></span>
<span class="strong"><strong>    file "/etc/named/zones/example.com.rev";</strong></span>
<span class="strong"><strong>    allow-transfer { none; };</strong></span>
<span class="strong"><strong>};</strong></span>
</pre><div class="note" style="" title="Note"><div class="inner"><h3 class="title"><a id="note56"/>Note</h3><p>This recipe names the zone file as <code class="literal">example.com.rev</code> so that it will sort alongside the forward zone file <code class="literal">example.com.fwd</code> in directory listings. Other conventions might name the file as <code class="literal">56.168.192.in-addr.arpa.zone</code>. Again, regardless of whatever convention you choose, the key thing is to be consistent.</p></div></div><p>Keep in mind the expansion and substitution rules we've discussed when writing a reverse zone file, most importantly that partially qualified names are interpreted in the context of <code class="literal">$ORIGIN</code>. We can get away writing just the primary authoritative DNS server's hostname in a forward lookup zone's <code class="literal">SOA</code> record, but we need to make sure that the names are fully qualified in a reverse file to prevent them from being treated as <code class="literal">ns1.56.168.192.in-addr.arpa.</code>:</p><pre class="programlisting">
<span class="strong"><strong>; start of authority</strong></span>
<span class="strong"><strong>@   IN SOA  ns1.example.com. hostmaster.example.com. (</strong></span>
<span class="strong"><strong>            2016041501 ; serial</strong></span>
<span class="strong"><strong>            12h        ; refresh</strong></span>
<span class="strong"><strong>            5m         ; retry</strong></span>
<span class="strong"><strong>            2w         ; expire</strong></span>
<span class="strong"><strong>            3h)        ; error TTL</strong></span>
</pre><p>A pointer record (<code class="literal">PTR</code>) relates an IP address back to a resource name. Apart from the <code class="literal">SOA</code> and <code class="literal">NS</code> records (as they are mandatory records in any zone file), the only other type of record that can appear in a reverse file is <code class="literal">PTR</code>. A consequence of this is that multiple records are needed to correctly inverse any aliases created with the <code class="literal">CNAME</code> records in the forward file. Since we used <code class="literal">www</code> and <code class="literal">ftp</code> as aliases for <code class="literal">example.com.</code>, which resolve to <code class="literal">192.168.56.100</code>, three records for the address appears in the reverse zone file as follows:</p><pre class="programlisting">
<span class="strong"><strong>100 IN PTR  example.com.</strong></span>
<span class="strong"><strong>100 IN PTR  www.example.com.</strong></span>
<span class="strong"><strong>100 IN PTR  ftp.example.com.</strong></span>
</pre><p>We can test the zone configuration with <code class="literal">dig</code> using the <code class="literal">-x</code> argument:</p><pre class="programlisting">
<span class="strong"><strong>dig @192.168.56.10 -x 192.168.56.100</strong></span>
</pre><p><code class="literal">-x</code> lets <code class="literal">dig</code> know that we're performing a reverse lookup. We provide the IP address as we would normally write it and <code class="literal">dig</code> will reverse its octets and append the <code class="literal">in-addr.arpa</code> domain for us when it sends the request.</p></div><div class="section" title="See also"><div class="titlepage"><div><div><h2 class="title"><a id="ch08lvl2sec228"/>See also</h2></div></div></div><p>Refer to the following resources for more information on working with reverse zones and lookups:</p><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc">BIND 9 Administrator Reference Manual (<a class="ulink" href="http://www.isc.org/downloads/bind/doc/">http://www.isc.org/downloads/bind/doc/</a>)</li><li class="listitem" style="list-style-type: disc">DNS Reverse Mapping (<a class="ulink" href="http://www.zytrax.com/books/dns/ch3/">http://www.zytrax.com/books/dns/ch3/</a>)</li><li class="listitem" style="list-style-type: disc">Classless <code class="literal">in-addr.arpa.</code> delegation (<a class="ulink" href="http://www.indelible.org/ink/classless">http://www.indelible.org/ink/classless</a>)</li></ul></div></div></div>
<div class="section" title="Setting up a slave DNS server"><div class="titlepage"><div><div><h1 class="title"><a id="ch08lvl1sec71"/>Setting up a slave DNS server</h1></div></div></div><p>Redundancy is important to ensure key services remain available in the event of an issue. As DNS is one of the most critical components of a network, whether it's a private intranet or the public Internet, having only one authoritative DNS server is unwise. In fact, IANA's <span class="emphasis"><em>Technical Requirements for Authoritative Name Servers</em></span> document states that there must be a minimum of two different authoritative name servers for the zone. This recipe shows you how to configure a second BIND installation to act as a secondary authoritative server that receives its zone information from the primary in a master/slave configuration. A lookup request can then be satisfied by either server and be considered an authoritative response.</p><div class="section" title="Getting ready"><div class="titlepage"><div><div><h2 class="title"><a id="ch08lvl2sec229"/>Getting ready</h2></div></div></div><p>This recipe requires two CentOS systems with BIND installed and configured as described in earlier recipes. Use the network described by the <span class="emphasis"><em>Configuring BIND as an authoritative DNS server</em></span> recipe. This recipe assumes that the system to serve as the master is configured as <code class="literal">192.168.56.10</code> and the slave is <code class="literal">192.168.56.20</code>. Administrative privileges are also required, either by logging in with the <code class="literal">root</code> account or through the use of <code class="literal">sudo</code>.</p></div><div class="section" title="How to do it..."><div class="titlepage"><div><div><h2 class="title"><a id="ch08lvl2sec230"/>How to do it...</h2></div></div></div><p>Follow these steps to configure BIND as a secondary authoritative DNS server that receives its zone information from the primary:</p><div class="orderedlist"><ol class="orderedlist arabic"><li class="listitem">On the system running the slave instance of BIND, open <code class="literal">named.conf</code> and configure the <code class="literal">example.com.</code> zone as follows:<pre class="programlisting">
<span class="strong"><strong>zone "example.com." in {</strong></span>
<span class="strong"><strong>       type slave;</strong></span>
<span class="strong"><strong>       file "/var/named/slaves/example.com.fwd";</strong></span>
<span class="strong"><strong>       masters { 192.168.56.10; };</strong></span>
<span class="strong"><strong>       allow-transfer { none; };</strong></span>
<span class="strong"><strong>       notify no;</strong></span>
<span class="strong"><strong>};</strong></span>
</pre></li><li class="listitem">Configure its reverse zone as follows:<pre class="programlisting">
<span class="strong"><strong>zone "56.168.192.in-addr.arpa." in {</strong></span>
<span class="strong"><strong>       type slave;</strong></span>
<span class="strong"><strong>       file "/var/named/slaves/example.com.rev";</strong></span>
<span class="strong"><strong>       masters { 192.168.56.10; };</strong></span>
<span class="strong"><strong>       allow-transfer { none; };</strong></span>
<span class="strong"><strong>       notify no;</strong></span>
<span class="strong"><strong>};</strong></span>
</pre></li><li class="listitem">Save your changes and close the file.</li><li class="listitem">Restart the slave for the configuration changes to take effect:<pre class="programlisting">
<span class="strong"><strong>systemctl restart named.service</strong></span>
</pre></li><li class="listitem">On the system running the master instance of BIND, open <code class="literal">named.conf</code>.</li><li class="listitem">Update the <code class="literal">example.com.</code> zone's <code class="literal">allow-transfer</code> entry with the addresses of the slave. The zone's configuration should look like this:<pre class="programlisting">
<span class="strong"><strong>zone "example.com." in {</strong></span>
<span class="strong"><strong>       type master;</strong></span>
<span class="strong"><strong>       file "/var/named/zones/example.com.fwd";</strong></span>
<span class="strong"><strong>       allow-transfer { 192.168.56.20; };</strong></span>
<span class="strong"><strong>};</strong></span>
</pre></li><li class="listitem">Make the same change to the reverse zone configuration:<pre class="programlisting">
<span class="strong"><strong>zone "56.168.192.in-addr.arpa." in {</strong></span>
<span class="strong"><strong>       type master;</strong></span>
<span class="strong"><strong>       file "/var/named/zones/example.com.rev";</strong></span>
<span class="strong"><strong>       allow-transfer { 192.168.56.20; };</strong></span>
<span class="strong"><strong>};</strong></span>
</pre></li><li class="listitem">Save the changes and close the file.</li><li class="listitem">Restart the master for the configuration changes to take effect:<pre class="programlisting">
<span class="strong"><strong>systemctl restart named.service</strong></span>
</pre></li><li class="listitem">On the slave, test the configuration using <code class="literal">dig</code> to request a zone transfer:<pre class="programlisting">
<span class="strong"><strong>dig @192.168.56.10 example.com. AXFR</strong></span>
</pre></li></ol></div></div><div class="section" title="How it works..."><div class="titlepage"><div><div><h2 class="title"><a id="ch08lvl2sec231"/>How it works...</h2></div></div></div><p>Slave servers request a zone transfer when notified by the primary authoritative DNS server that the zone's records have changed and when the copy of the zone file maintained by the slave expires according to the <code class="literal">SOA</code> record. In this recipe, we began with two systems running BIND and edited their configurations to allow the transfer. We began on the system targeted as the slave, configuring both the forward and reverse lookup zones we've worked with earlier:</p><pre class="programlisting">
<span class="strong"><strong>zone "example.com." in {</strong></span>
<span class="strong"><strong>    type slave;</strong></span>
<span class="strong"><strong>    file "/var/named/slaves/example.com.fwd";</strong></span>
<span class="strong"><strong>    masters { 192.168.56.10; };</strong></span>
<span class="strong"><strong>    allow-transfer { none; };</strong></span>
<span class="strong"><strong>    notify no;</strong></span>
<span class="strong"><strong>};</strong></span>
<span class="strong"><strong>zone "56.168.192.in-addr.arpa." in {</strong></span>
<span class="strong"><strong>    type slave;</strong></span>
<span class="strong"><strong>    file "/var/named/slaves/example.com.rev";</strong></span>
<span class="strong"><strong>    masters { 192.168.56.10; };</strong></span>
<span class="strong"><strong>    allow-transfer { none; };</strong></span>
<span class="strong"><strong>    notify no;</strong></span>
<span class="strong"><strong>};</strong></span>
</pre><p>The <code class="literal">type slave</code> option instructs this server to act as a secondary server for the zone. Since designating the master and slave is done on a per-zone basis, it's possible for the same instance of BIND to be the master for one zone and a slave for another. The <code class="literal">masters</code> option provides the address of the primary server.</p><p>The <code class="literal">file</code> option provides the location where BIND will write the transferred zone information. Not only is it good for the organization to keep the transferred zones separate from any primary zone files on the system, but it's also good for security. BIND needs write permissions to the directory to save the transferred files, but the primary zone files should be read-only to anyone except the administrator (that is, <code class="literal">root</code>) as a safeguard from any tampering. Our configuration saves them to <code class="literal">/var/named/slaves</code>, which was created when we installed the <code class="literal">bind</code> package and already has the appropriate permissions.</p><p>The <code class="literal">allow-transfers</code> option lists the systems this server is allowed to respond to for zone transfer requests. To protect ourselves from possible abuse, we set the value to none, which disallows transfers from the secondary server. All transfers will be serviced by the primary authoritative DNS server, and even then it will only send them to the slave.</p><p>BIND sends a notification to the secondary authoritative servers listed in a zone's <code class="literal">NS</code> records each time the zone is reloaded. There's no reason for the slave to send a notification to other secondaries (if you configure more than one slave) because they are already notified by the primary, so we turned off this behavior with <code class="literal">notify no</code>.</p><p>However, if you want you can send notifications to other servers along with those listed in the zone file with the <code class="literal">also-notify</code> option. This is useful if you have additional secondary servers which you don't want to make public with <code class="literal">NS</code> records or if you want to notify some other automated process. Simply provide the addresses of the servers you want to notify with <code class="literal">also-notify</code>:</p><pre class="programlisting">
<span class="strong"><strong>also-notify { 192.168.56.200; 192.168.68.200; };</strong></span>
</pre><p>To notify only those servers listed in <code class="literal">also-notify</code> and not the secondary authoritative servers, set <code class="literal">notify</code> to <code class="literal">explicit</code>:</p><pre class="programlisting">
<span class="strong"><strong>also-notify { 192.168.56.200; 192.168.68.200; };</strong></span>
<span class="strong"><strong>notify explicit;</strong></span>
</pre><p>Next, we updated the master's configuration, giving the slave's address with <code class="literal">allow-transfers</code> to permit the master to respond to zone transfer requests from the slave:</p><pre class="programlisting">
<span class="strong"><strong>zone "example.com." in {</strong></span>
<span class="strong"><strong>    type master;</strong></span>
<span class="strong"><strong>    file "/var/named/zones/example.com.fwd";</strong></span>
<span class="strong"><strong>    allow-transfer { 192.168.56.20; };</strong></span>
<span class="strong"><strong>};</strong></span>
</pre><p>After restarting BIND for our changes take effect, we can test the configuration by using <code class="literal">dig</code> to request a zone transfer from the master while on the slave system:</p><pre class="programlisting">
<span class="strong"><strong>dig @192.168.56.10 example.com. AXFR</strong></span>
</pre><div class="note" style="" title="Note"><div class="inner"><h3 class="title"><a id="note57"/>Note</h3><p>Remember to increment the serial number in the <code class="literal">SOA</code> record whenever you update a zone configuration. The slave checks the serial before updating its zone information and won't update it if the value hasn't changed.</p></div></div></div><div class="section" title="See also"><div class="titlepage"><div><div><h2 class="title"><a id="ch08lvl2sec232"/>See also</h2></div></div></div><p>Refer to the following resources for more information on configuring and working with zone transfers:</p><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc">BIND 9 Administrator Reference Manual (<a class="ulink" href="http://www.isc.org/downloads/bind/doc/">http://www.isc.org/downloads/bind/doc/</a>)</li><li class="listitem" style="list-style-type: disc">DNS for Rocket Scientists (<a class="ulink" href="http://www.zytrax.com/books/dns/">http://www.zytrax.com/books/dns/</a>)</li><li class="listitem" style="list-style-type: disc">Technical requirements for authoritative name servers (<a class="ulink" href="http://www.iana.org/help/nameserver-requirements">http://www.iana.org/help/nameserver-requirements</a>)</li><li class="listitem" style="list-style-type: disc">How the AXFR protocol works (<a class="ulink" href="http://cr.yp.to/djbdns/axfr-notes.html">http://cr.yp.to/djbdns/axfr-notes.html</a>)</li><li class="listitem" style="list-style-type: disc">A Pattern for DNS Architecture (<a class="ulink" href="http://www.allgoodbits.org/articles/view/5">http://www.allgoodbits.org/articles/view/5</a>)</li><li class="listitem" style="list-style-type: disc">Securing an Internet Name Server (<a class="ulink" href="http://resources.sei.cmu.edu/library/asset-view.cfm?assetid=52493">http://resources.sei.cmu.edu/library/asset-view.cfm?assetid=52493</a>)</li></ul></div></div></div>
<div class="section" title="Configuring rndc to control BIND"><div class="titlepage"><div><div><h1 class="title"><a id="ch08lvl1sec72"/>Configuring rndc to control BIND</h1></div></div></div><p><code class="literal">rndc</code> is the client utility for managing BIND servers. However, before you can use it, both <code class="literal">rndc</code> and BIND need to be configured. This recipe shows you how to configure them and then shows you a few commands for managing the server's cache.</p><div class="section" title="Getting ready"><div class="titlepage"><div><div><h2 class="title"><a id="ch08lvl2sec233"/>Getting ready</h2></div></div></div><p>This recipe requires a CentOS system with BIND installed and configured as described in the previous recipes. Administrative privileges are also required, either by logging in with the <code class="literal">root</code> account or through the use of <code class="literal">sudo</code>.</p></div><div class="section" title="How to do it..."><div class="titlepage"><div><div><h2 class="title"><a id="ch08lvl2sec234"/>How to do it...</h2></div></div></div><p>Follow these steps to configure <code class="literal">rndc:</code></p><div class="orderedlist"><ol class="orderedlist arabic"><li class="listitem">Use the <code class="literal">rndc-confgen</code> utility to generate the necessary key file:<pre class="programlisting">
<span class="strong"><strong>rndc-confgen -a -c /etc/rndc.key</strong></span>
</pre></li><li class="listitem">Create the <code class="literal">/etc/rndc.conf</code> file with the following content:<pre class="programlisting">       include "/etc/rndc.key";&#13;
       options {&#13;
           default-key "rndc-key";&#13;
           default-server 127.0.0.1;&#13;
           default-port 953;&#13;
       };&#13;
</pre></li><li class="listitem">Ensure the correct ownership and access permissions for <code class="literal">rndc.key</code> and <code class="literal">rndc.conf</code>:<pre class="programlisting">
<span class="strong"><strong>chown root.named /etc/rndc*</strong></span>
<span class="strong"><strong>chmod 640 /etc/rndc*</strong></span>
</pre></li><li class="listitem">Open <code class="literal">/etc/named.conf</code> and add the following configuration settings after the closing brace of the <code class="literal">options</code> block:<pre class="programlisting">       include "/etc/rndc.key";&#13;
       controls {&#13;
           inet 127.0.0.1 port 953 allow { 127.0.0.1; } keys {&#13;
           "rndc-key"; };&#13;
       };&#13;
</pre></li><li class="listitem">Restart BIND for the configuration changes to take effect:<pre class="programlisting">
<span class="strong"><strong>systemctl restart named.service</strong></span>
</pre></li><li class="listitem">Test the configuration by using <code class="literal">rndc</code> to request BIND's status:<pre class="programlisting">
<span class="strong"><strong>rndc status</strong></span>
</pre></li></ol></div></div><div class="section" title="How it works..."><div class="titlepage"><div><div><h2 class="title"><a id="ch08lvl2sec235"/>How it works...</h2></div></div></div><p>Communication between <code class="literal">rndc</code> and BIND requires a shared key for authorization. So, first we used <code class="literal">rndc-confgen</code> to create one. In a normal operation without arguments, the program generates the key and necessary configuration fragments and dumps everything to the screen. You can cut and paste sections of the output into the appropriate files, but if you only have access with a terminal and keyboard then this could prove difficult. Instead, we ran the program with <code class="literal">-a</code> for it to generate the key's definition and dump it to its own configuration file and we'll type the other configuration pieces manually. The <code class="literal">-c</code> argument simply specifies our desired name for the key definition's file:</p><pre class="programlisting">
<span class="strong"><strong>rndc-confgen -a -c /etc/rndc.key</strong></span>
</pre><div class="note" style="" title="Note"><div class="inner"><h3 class="title"><a id="note58"/>Note</h3><p>Some people report that <code class="literal">rndc-confgen</code> appears to crash on their system. If you experience this, the most likely reason is that it's waiting for sufficient data to generate the secret, but the entropy pool for <code class="literal">/dev/random</code> is starved which causes <code class="literal">rndc-confgen</code> to wait. Terminate the process and try again using <code class="literal">-r</code> to specify <code class="literal">/dev/urandom </code>as an alternate source:</p><p>
</p><p><code class="literal">
<span class="strong"><strong>rndc-confgen -a -c /etc/rndc.key -r /dev/urandom</strong></span>
</code></p></div></div><p>A quick peek inside <code class="literal">/etc/rndc.key</code> reveals the key's definition as follows:</p><pre class="programlisting">
<span class="strong"><strong>key "rndc-key" {</strong></span>
<span class="strong"><strong>    algorithm hmac-md5;</strong></span>
<span class="strong"><strong>    secret "YBmUKeobRMlAOUjCqMcb6g==";</strong></span>
<span class="strong"><strong>};</strong></span>
</pre><p><code class="literal">rndc</code> uses a configuration file of its own. So, next we created <code class="literal">/etc/rndc.conf</code>:</p><pre class="programlisting">
<span class="strong"><strong>include "/etc/rndc.key";</strong></span>
<span class="strong"><strong>options {</strong></span>
<span class="strong"><strong>    default-key "rndc-key";</strong></span>
<span class="strong"><strong>    default-server 127.0.0.1;</strong></span>
<span class="strong"><strong>    default-port 953;</strong></span>
<span class="strong"><strong>};</strong></span>
</pre><p>We include the key definition from <code class="literal">rndc.key</code> and specify it as the default key for <code class="literal">rndc</code> to use. We also specified the local loopback address as the default server and 953 as the default port. With these configuration options, <code class="literal">rndc</code> attempts to connect to the locally running BIND server without the need for us to provide extra arguments at the command line.</p><p>Last, we BIND to allow and authenticate rndc's connection requests. So, we again include the key definition and add a <code class="literal">controls</code> block in <code class="literal">named.conf</code>:</p><pre class="programlisting">
<span class="strong"><strong>include "/etc/rndc.key";</strong></span>
<span class="strong"><strong>controls {</strong></span>
<span class="strong"><strong>    inet 127.0.0.1 port 953 allow {127.0.0.1;} keys {"rndc-key";};</strong></span>
<span class="strong"><strong>};</strong></span>
</pre><p>The <code class="literal">inet</code> statement specifies which addresses are allowed to connect and the keys they need to authenticate. The first address lists which address BIND will listen on for connection requests. The configuration is intentionally restrictive for the sake of security and only allows us to use <code class="literal">rndc</code> locally—BIND listens on the local address and services commands sent from the local address.</p><p>If you want to use <code class="literal">rndc</code> for remote administration, I recommend you against opening access and instead use SSH to log into the remote system and it's copy of <code class="literal">rndc</code>. BIND's control channel remains closed to anyone up to no good, you don't need to distribute copies of the key file, and communication between the two systems is encrypted:</p><pre class="programlisting">
<span class="strong"><strong>ssh 192.168.56.10 rndc status</strong></span>
</pre><div class="note" style="" title="Note"><div class="inner"><h3 class="title"><a id="note59"/>Note</h3><p>You can save typing by creating an <code class="literal">alias</code>:</p><p>
</p><p><code class="literal">
<span class="strong"><strong>alias rndc-ns1="ssh 192.168.56.10 rndc"</strong></span>
<span class="strong"><strong>rndc-ns1 status</strong></span>
</code></p></div></div><p>When invoked without a subcommand, <code class="literal">rndc</code> displays a usage message enumerating the actions we can perform. The <code class="literal">status</code> command outputs BIND's current status including how many zones are configured, if any zone transfers are in progress, and in the case of a resolving DNS server, how many queries it's currently trying to resolve through recursion:</p><pre class="programlisting">
<span class="strong"><strong>rndc status</strong></span>
</pre><div class="mediaobject"><img alt="How it works..." src="graphics/image_08_002.jpg"/><div class="caption"><p>rndc is used to manage BIND DNS servers</p></div></div><p>You may find the <code class="literal">flush</code> command useful if you're running a resolving DNS server. It removes all of the cached lookup information from BIND's cache. If you want to clear only the records related to a particular domain, you can use <code class="literal">flushname</code>:</p><pre class="programlisting">
<span class="strong"><strong>rndc flushname google.com</strong></span>
</pre><p>The <code class="literal">reload</code> and <code class="literal">refresh</code> commands are useful with authoritative servers. The <code class="literal">reload</code> command causes BIND to reparse zone files after they've been updated without restarting the server. Unless a specific zone is given, all zones will be reloaded:</p><pre class="programlisting">
<span class="strong"><strong>rndc reload example.com.</strong></span>
</pre><p>In the case of slave DNS servers, we can force BIND to update its copy of a zone file if it's stale using the <code class="literal">refresh</code> command:</p><pre class="programlisting">
<span class="strong"><strong>rndc refresh example.com.</strong></span>
</pre></div><div class="section" title="See also"><div class="titlepage"><div><div><h2 class="title"><a id="ch08lvl2sec236"/>See also</h2></div></div></div><p>Refer to the following resources for more information on using <code class="literal">rndc</code>:</p><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc">The <code class="literal">rndc</code> manual page (<code class="literal">man 8 rndc</code>)</li><li class="listitem" style="list-style-type: disc">RHEL 7 Networking Guide: BIND (<a class="ulink" href="https://access.redhat.com/documentation/en-US/Red_Hat_Enterprise_Linux/7/html/Networking_Guide/sec-BIND.html">https://access.redhat.com/documentation/en-US/Red_Hat_Enterprise_Linux/7/html/Networking_Guide/sec-BIND.html</a>)</li></ul></div></div></div></body></html>