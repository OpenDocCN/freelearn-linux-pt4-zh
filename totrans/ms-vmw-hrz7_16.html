<html><head></head><body>
        <section>

                            <header>
                    <h1 class="header-title">Upgrading to a New Version of Horizon</h1>
                </header>
            
            <article>
                
<p>In this chapter, we are going to cover the upgrade process and recommendations for upgrading your VMware View environment to the latest version, and, in this example, we will upgrade from Horizon 6 to Horizon 7. We will start by discussing the elements that need to be considered before undertaking the upgrade, how we undertake the upgrade to ensure there is minimum disruption to our users, and finally, the step-by-step process to completing the upgrade.</p>
<p>In this chapter, we will cover the following topics :</p>
<ul>
<li>Upgrading compatibility</li>
<li>Upgrading Horizon Composer </li>
<li>Upgrading the Horizon View Connection Server</li>
<li>Upgrading the View Security Server</li>
<li>Upgrading Group Policy templates </li>
<li>Upgrading the VMware Horizon Agent </li>
<li>Upgrading the Horizon Client</li>
</ul>


            </article>

            
        </section>
    

        <section>

                            <header>
                    <h1 class="header-title">Upgrading compatibility</h1>
                </header>
            
            <article>
                
<p>Before undertaking any upgrades, you should start off by reading the release notes and the upgrade guide for Horizon View. With a number of interdependent components, you not only need to check the compatibility between the different versions of these components, but also ensure that you undertake the upgrade in the correct order to minimize the risk of failure and disruption to our users.</p>
<p class="mce-root"/>
<p>In this section, we are going to look at compatibility, starting with which versions you are able to upgrade to Horizon 7. The following list shows the different versions:</p>
<ul>
<li>The latest maintenance release of Horizon View 5.3</li>
<li>The latest maintenance release of VMware Horizon 6.0 (with View)</li>
<li>The latest maintenance release of VMware Horizon 6 version 6.1</li>
<li>The latest maintenance release of VMware Horizon 6 version 6.2</li>
</ul>
<p>You also need to check compatibility between the different View Components and whether Horizon 7 works with earlier versions of these components. By components, we mean the Connection Server, the <span>Security Server</span>, and so on.</p>
<p>The following table demonstrates version compatibility:</p>
<div class="CDPAlignCenter CDPAlign"><img src="assets/bbcb5d78-94d8-4508-9269-2d715f699cb9.png"/></div>
<p>As such, the process by which the upgrade needs to take place is as follows:</p>
<ul>
<li>View Composer upgrade</li>
<li>View <span>Connection Server</span> upgrade</li>
<li>View <span>Security Server</span> upgrade</li>
<li>Upgrading group policies</li>
<li>Upgrading vCenter (if required)</li>
<li>Upgrading ESXi hosts and virtual machine hardware/tools (if required)</li>
<li>Upgrading Horizon Agents</li>
<li>Recomposing desktop pools</li>
</ul>
<p>You will also need to think about the impact of any upgrade that may need to be undertaken on your end users. For example, you wouldn't want to upgrade a View Connection Server in the middle of a working day, with potentially thousands of users connected to it. You would normally schedule any upgrades to take place out of hours, or at least ensure that each View Connection Server is removed from the load balancer the night before the planned upgrade. </p>
<p>You could decide to build new <span>Connection Server</span>s with the latest Horizon version, rather than upgrading the existing <span>Connection Server</span>s, and then simply point users to the new servers and then remove the old <span>Connection Server</span>s once completed.</p>
<p>The first component we are going to look at upgrading is the View Composer.</p>


            </article>

            
        </section>
    

        <section>

                            <header>
                    <h1 class="header-title">Upgrading Horizon Composer</h1>
                </header>
            
            <article>
                
<p>In the first part of the process, we are going to upgrade the View Composer Server.</p>


            </article>

            
        </section>
    

        <section>

                            <header>
                    <h1 class="header-title">Before you begin the upgrade</h1>
                </header>
            
            <article>
                
<p>There are a couple of prerequisites you need to have completed before starting the upgrade of the View Composer. You need to perform the following steps prior to commencing with the upgrade:</p>
<ol>
<li>Check the prerequisites with the VMware Horizon View installation guide to ensure all components to be upgraded meet the minimum requirements for resources, operating system, and applicable database versions.</li>
<li>If your View Composer Server is installed on a virtual machine, snapshot the virtual machine before starting.</li>
<li>Back up your vCenter and View Composer databases.</li>
<li>Back up the folder containing the SSL certificates on your View Composer Server. Certificates can be found in the following folder: <kbd>%ALLUSERSPROFILE%\Application Data\VMware\VMware VirtualCenter</kbd></li>
<li>Document the IP address and hostname of your vCenter Server.</li>
<li>Ensure the usernames and passwords are documented for the accounts used to access your composer database.</li>
</ol>
<p>With the prerequisite tasks completed, the next step is to disable provisioning. To do this, perform the following steps as:</p>
<ol>
<li>Log in to the View Administrator, expand out the <span class="packt_screen">Catalog</span> option, and click on <span class="packt_screen">Desktop Pools</span> (<strong>1</strong>).</li>
<li>Now, click and highlight the desktop pool you want to disable (<strong>2</strong>), right-click, and, from the contextual menu, select <span class="packt_screen">Disable Provisioning…</span> (<strong>3</strong>), as shown in the following screenshot:</li>
</ol>
<div class="CDPAlignCenter CDPAlign"><img src="assets/35b9418c-92bc-41bb-a2e9-77350aa5a165.png"/></div>
<ol start="3">
<li>You will now see the following message displayed:</li>
</ol>
<div class="CDPAlignCenter CDPAlign"><img src="assets/5b2f248a-38f0-4f5f-8b00-fdf3fcf19dec.png" style=""/></div>
<ol start="4">
<li>Click the <span class="packt_screen">OK</span> button to disable provisioning. You will need to disable provisioning for all desktop pools that are going to be affected by the View Composer upgrade. This prevents any new desktops from being provisioned during the upgrade.</li>
<li>Next, you need to modify any desktop pools that are set to refresh upon logging off to ensure that they are set to never refresh.</li>
</ol>
<ol start="6">
<li>To do this, from the <span class="packt_screen">Catalog</span> option, click on <span class="packt_screen">Desktop Pools</span> (<strong>4</strong>), and then click and highlight the desktop pool you want to edit (<strong>5</strong>), right-click, and, from the contextual menu, select <span class="packt_screen">Edit…</span> (<strong>6</strong>), as shown in the following screenshot:</li>
</ol>
<div class="CDPAlignCenter CDPAlign"><img src="assets/c68424aa-eace-4166-bcb8-cd7702358b44.png"/></div>
<ol start="7">
<li>You will now see the <span class="packt_screen">Edit Win7-Floating-LC</span> dialog box, as shown in the following screenshot:</li>
</ol>
<div class="CDPAlignCenter CDPAlign"><img src="assets/be76480c-398f-4030-b751-89180a6113f8.png" style=""/></div>
<ol start="8">
<li>Click the <span class="packt_screen">Desktop Pool…</span> tab (<strong>7</strong>), and then, from the <span class="packt_screen">Delete or refresh machine on logoff</span> section, from the drop-down menu, select the option for <span class="packt_screen">Never</span> (<strong>8</strong>).</li>
<li>Click the <span class="packt_screen">OK</span> button to save the changes and close the dialog box.</li>
</ol>
<p>You are now ready to complete the upgrade process, which we will cover in the next section.</p>


            </article>

            
        </section>
    

        <section>

                            <header>
                    <h1 class="header-title">Completing the View Composer upgrade</h1>
                </header>
            
            <article>
                
<p>Once you have completed all the prerequisites, and have planned the upgrades so as to have the minimal impact on your end users, you are able to start the upgrade. The next stage is to install the new version of the Horizon Composer software.</p>
<p>We are not going to cover this, as it's exactly the same process as we covered back in <a href="a85150f1-1f32-4c91-87f0-1e8c700b9b96.xhtml">Chapter 4</a>, <em>Installing and Configuring Horizon 7 - Part 1</em>, in the <em>Installing and Configuring Horizon View</em> and the <em>Horizon Composer Installation Process</em> sections, with the slight difference being that you need to uninstall the old version first. Once uninstalled, you can follow the instructions in that section, remembering that you have already set up the database details, so all you need to do is enter the DSN details you already created when prompted to do so.</p>


            </article>

            
        </section>
    

        <section>

                            <header>
                    <h1 class="header-title">Verifying the upgrade</h1>
                </header>
            
            <article>
                
<p class="NormalPACKT"><span>Now that the upgrade has completed, the next stage is to check that everything is back up and running. The first thing we will check is to make sure that the Horizon Composer service is running by performing the following steps:</span></p>
<ol>
<li>First, from the Horizon Composer Server, launch a services console by opening a <span class="packt_screen">Run</span> dialog box and typing <kbd>services.msc</kbd>.</li>
</ol>
<ol start="2">
<li>In the <span class="packt_screen">Services</span> screen, scroll down and check that the <span class="packt_screen">VMware Horizon 7 Composer</span> service is running, as shown in the following screenshot:</li>
</ol>
<div class="CDPAlignCenter CDPAlign"><img src="assets/493e85d6-5548-4fb3-87ed-8ec4e90d5e37.png"/></div>
<ol start="3">
<li>The second check is to run through the View Composer verification process.</li>
<li>From the View Administrator, click on <span class="packt_screen">Servers</span> (<strong>1</strong>), and then highlight the vCenter server you want to verify (<strong>2</strong>), as shown in the following screenshot:</li>
</ol>
<div class="CDPAlignCenter CDPAlign"><img src="assets/ee2a69fb-6a90-44ad-bc39-58595a69dca0.png"/></div>
<ol start="5">
<li>Now, click the <span class="packt_screen">Edit...</span> button (<strong>3</strong>).</li>
</ol>
<ol start="6">
<li>You will now see the <span class="packt_screen">Edit vCenter Server</span> dialog box, as shown in the following screenshot:</li>
</ol>
<div class="CDPAlignCenter CDPAlign"><img src="assets/bc2235c7-6eb0-4d7d-ab46-af15980410fd.png" style=""/></div>
<ol start="7">
<li>In the <span class="packt_screen">View Composer Server Settings</span> section, click the <span class="packt_screen">Edit…</span> button (<strong>4</strong>).</li>
</ol>
<ol start="8">
<li>You will now see the <span class="packt_screen">View Composer Server Settings</span><span>, as shown in the</span> following screenshot:</li>
</ol>
<div class="CDPAlignCenter CDPAlign"><img src="assets/17592fbd-c3da-4819-bc37-fb053ffdbab8.png" style=""/></div>
<ol start="9">
<li>In the <span class="packt_screen">Domains</span> section at the bottom, click the <span class="packt_screen">Verify Server Information</span> button (<strong>5</strong>).</li>
</ol>
<ol start="10">
<li>You will now see the <span class="packt_screen">Domains</span> section populated, along with the desktop pool information, as shown in the following screenshot:</li>
</ol>
<div class="CDPAlignCenter CDPAlign"><img src="assets/9a7ac8a4-d1e6-4041-9844-7cb1168c7391.png" style=""/></div>
<ol start="11">
<li>Click the <span class="packt_screen">OK</span> button to close the dialog box.</li>
</ol>
<p>You have now successfully completed the upgrade procedure for the Horizon Composer Server. Obviously, if you are using multiple composer servers, you will need to repeat these steps on all your Horizon Composer servers.</p>
<p class="mce-root"/>
<p class="mce-root"/>


            </article>

            
        </section>
    

        <section>

                            <header>
                    <h1 class="header-title">Upgrading the Horizon View Connection Server</h1>
                </header>
            
            <article>
                
<p>You are now in a position to move on to upgrading all the View Connection Servers within your infrastructure.</p>


            </article>

            
        </section>
    

        <section>

                            <header>
                    <h1 class="header-title">Before you begin the upgrade</h1>
                </header>
            
            <article>
                
<p>There are a couple of prerequisites you need to have completed before beginning the upgrade of the View Connection Server:</p>
<ol>
<li>Check the prerequisites with the VMware Horizon View installation guide to ensure all components to be upgraded meet the minimum requirements for resources, operating system, and so on.</li>
<li>If your View Connection Server is installed in a virtual machine, snapshot the virtual machine. Please note that if you need to recover this snapshot, you will first need to uninstall any replicated <span>Connection Server</span>s before reverting the master to the snapshot.</li>
<li>Ensure that your documentation is up to date, including pool configuration, global configuration settings, IP addresses, batch files, SQL credentials for the event database, and load balancer configuration.</li>
</ol>
<p class="mce-root"><span>Use the</span> <kbd>vdmexport.exe</kbd> <span>command-line utility to back up the existing configuration help within the LDAP database. From the command line, run the following command:</span></p>
<pre style="color: black;padding-left: 30px"><strong>vdmexport &gt; {backup location\filename.ldf}</strong></pre>


            </article>

            
        </section>
    

        <section>

                            <header>
                    <h1 class="header-title">Completing the Connection Server upgrade</h1>
                </header>
            
            <article>
                
<p>Once you have completed all the prerequisites, and have planned the upgrades so as to have the minimal effect on your end users, you are able to start the upgrade.</p>
<p>The next stage is to install the new version of the View Connection Server software.</p>
<p>We are not going to cover this, as it's exactly the same process as we covered in <span>back in </span><a href="a85150f1-1f32-4c91-87f0-1e8c700b9b96.xhtml">Chapter 4</a><span>, </span><em>Installing and Configuring Horizon 7 - Part 1</em><span>, the </span><em>Installing and Configuring Horizon View</em><span> and the </span><em>Horizon Composer Installation Process</em><span> sections</span>, with the slight difference being that the old version gets uninstalled first. Follow the instructions in that section to install the Connection Server software.</p>
<p>Once the installation has finished and the server has rebooted, you should be able to see that the upgrade has completed successfully by accessing the View Administrator. To do this, c<span>lick on</span> <span class="packt_screen">Servers</span> <span>(<strong>1</strong>) and then click the</span> <span class="packt_screen">Connection Servers</span> <span>tab (<strong>2</strong>). You can then check the version number for the associated</span> <span class="packt_screen">Connection Server</span> <span>(<strong>3</strong>), </span>as shown in the following screenshot:</p>
<div class="CDPAlignCenter CDPAlign"><img src="assets/2f4bf44a-00be-49ae-a7a1-b41e1eec06d4.png"/></div>
<p>You have now successfully completed the upgrade procedure for the View Connection Server. Obviously, if you are using multiple <span class="packt_screen">Connection Servers</span>, you will need to repeat these steps on all your View Connection servers.</p>


            </article>

            
        </section>
    

        <section>

                            <header>
                    <h1 class="header-title">Alternative View Connection Server upgrade method</h1>
                </header>
            
            <article>
                
<p>There may be a situation where you decide to upgrade View Connection Servers by adding new Horizon 7 Connection Servers to your existing Horizon Connection Servers, and then remove the old <span>Connection Server</span>s from the configuration when you are ready to do so. We aren't going to cover the procedure for the installation of the new replica View Connection Servers here, as this is extensively covered in <a href="a85150f1-1f32-4c91-87f0-1e8c700b9b96.xhtml">Chapter 4</a>, <em>Installing and Configuring Horizon - Part 1</em>, but it is important to understand how to remove the old View Connection Servers correctly, by performing the following steps.</p>
<p>Once you have installed the new version of the <span>Connection Server</span>, and are ready to remove your first old version <span>Connection Server</span>, you will need to ensure that the View Connection Server to be removed has been removed from any load balancers and is no longer in use by the users; in other words, nobody is connected to it.</p>
<p>Then, launch the <span class="packt_screen">Programs and Features</span> configuration screen from the control panel, as shown in the following screenshot:</p>
<div class="CDPAlignCenter CDPAlign"><img src="assets/7c61e7b0-0ebb-42bf-9d02-ea71644b1ae5.png"/></div>
<p>You will then need to uninstall the <span class="packt_screen">AD LDS Instance VMwareVDMS</span> (1) and the <span class="packt_screen">VMware Horizon Connection Server</span> (2) from the View Connection Server you want to remove.</p>
<p class="mce-root"/>
<p>Once you have completed the uninstall, you will need to connect to all of your remaining <span>Connection Server</span>s, open a command line, and run the following command:</p>
<pre><strong>"C:\Program Files\VMware\VMware View\Server\tools\bin\vdmadmin.exe" -S -r -s server_name</strong></pre>
<p>This removes this <span>Connection Server</span> entry from the other <span>Connection Server</span>s. You will then get confirmation of the scheduled removal of the server from the configuration, and the server will no longer be displayed in the View Administrator screen.</p>
<p>The process described is also the same process you would use to upgrade a replica server, as, essentially, a replica server is just a <span>Connection Server</span>.</p>


            </article>

            
        </section>
    

        <section>

                            <header>
                    <h1 class="header-title">Upgrading the View Security Server</h1>
                </header>
            
            <article>
                
<p>The next step in upgrading your Horizon View environment is to upgrade the <span>Security Server</span>s that are used to enable external users to connect to their desktops. Bear in mind that this won't be added to your domain, so you will need to log in using local credentials.</p>


            </article>

            
        </section>
    

        <section>

                            <header>
                    <h1 class="header-title">Before you begin the upgrade</h1>
                </header>
            
            <article>
                
<p>There are a couple of prerequisites you need to have completed before starting the upgrade of the View Security Server.</p>
<p>By default, since View 5.3, traffic between the <span>Security Server </span>and <span>Connection Server</span> is governed by IPSEC rules. When you complete an upgrade of a View Security Server, these rules will need to be recreated, and if the existing rules still exist, this will fail.</p>
<p>As such, VMware has built-in functionality to clear the IPSEC rules prior to the upgrade being started. To do this, perform the following the steps:</p>
<ol>
<li>From the View Administrator screen, click on <span class="packt_screen">Servers</span> (<strong>1</strong>), and then the <span class="packt_screen">Security Servers</span> tab (<strong>2</strong>), as shown in the following screenshot:</li>
</ol>
<div class="CDPAlignCenter CDPAlign"><img src="assets/1a4d204b-d767-4daf-b3fa-aa1f08d3065b.png"/></div>
<ol start="2">
<li>Now, highlight the <span>Security Server</span> and click the dropdown for <span class="packt_screen">More Commands</span> (<strong>3</strong>).</li>
<li>Select the <span class="packt_screen">Prepare for Upgrade or Reinstallation…</span> option (<strong>4</strong>).</li>
</ol>
<p>Once you have completed this action, the <span>Security Server</span> is no longer able to communicate with the <span>Connection Server</span>, so ensure this is only completed as part of planned maintenance to the <span>Security Server</span>, so as to avoid disruption, since external users may now be unable to log in and connect to a virtual desktop machine.</p>


            </article>

            
        </section>
    

        <section>

                            <header>
                    <h1 class="header-title">Completing the View Security Server upgrade</h1>
                </header>
            
            <article>
                
<p>Once you have completed all the prerequisites, and have planned the upgrades, so as to have the minimal effect on your end users, you are able to start the upgrade by uninstalling the current version of the <span>Security Server</span> using the <span class="packt_screen">Add and Remove Programs</span> configuration on the server running the current version. Once removed, you can now proceed and install the new version.</p>
<p>Before you actually install the new version of the <span>Security Server</span>, you first need to set the pairing password. To do this, perform the following the steps:</p>
<ol>
<li>From the View Administrator console, select <span class="packt_screen">Servers, </span>and then click on the <span class="packt_screen">Connection Servers</span> tab.</li>
<li>Select your View Connection Server, and then click on the <span class="packt_screen">More Commands</span> button.</li>
<li>Select the option for <span class="packt_screen">Specify Security Server Pairing Password...</span></li>
</ol>
<ol start="4">
<li>You will now see the <span class="packt_screen">Specify Security Server Pairing Password</span> dialog box.</li>
<li>Type in a password, and then confirm it by typing it in again. If you need to extend the length of time the pairing password is valid for then you can enter a new time in the <span class="packt_screen">Password timeout</span> box.</li>
<li>Click the <span class="packt_screen">OK</span> <span>button to continue.</span></li>
</ol>
<p>For more detailed information on this process, please refer back to the installation of the <span>Security Server</span> in <a href="89619cdf-5fc7-4dd1-a431-76cef6cbb67c.xhtml">Chapter 5</a>, <em>Installing and Configuring Horizon 7 - Part 2</em>.</p>
<p>The next stage is to install the new version of the View Security Server software.</p>
<p>We are not going to cover this, as it's exactly the same process as we covered in <a href="a85150f1-1f32-4c91-87f0-1e8c700b9b96.xhtml">Chapter 4</a>, <em>Installing and Configuring Horizon 7 - Part 1</em><span>, in the </span><em>Installing and Configuring Horizon View</em><span> and the </span><em>Horizon Composer Installation Process</em><span> sections</span>. Follow the instructions in that section to install the <span>Security Server</span> software.</p>
<p>Once the installation has completed and the server rebooted, you should be able to see that the upgrade has completed successfully by logging in to the View Administrator console, navigating to the <span class="packt_screen">Servers</span> section, and then clicking on the <span class="packt_screen">Security Servers</span> tab and checking the version number for the <span>Security Server</span> you just upgraded.</p>


            </article>

            
        </section>
    

        <section>

                            <header>
                    <h1 class="header-title">Upgrading group policy templates</h1>
                </header>
            
            <article>
                
<p>As part of new Horizon versions, there will be a number of new features, some of which will be controlled via Group Policy. Therefore, you will need to upgrade the Group Policy Administrative templates to the latest version when upgrading to a new version of Horizon View. This is easily achieved through the Group Policy Object Editor on your domain controllers.</p>
<p>We are not going to cover the process on how to do this, as it has been extensively covered in <a href="8ebc54c4-3812-46fe-9534-fe38b78804a9.xhtml">Chapter 10</a>, <em>Fine-Tuning the End User Experience</em>.</p>
<div class="packt_infobox">One thing to be aware of is that any policy changes can affect end users, and some policies may have been deprecated and other new ones added. It's worth creating a new GPO for any new versions so that you can roll back to the previous one if users start to report any issues.</div>
<p class="mce-root">In the next section, we are going to look at upgrading the Horizon Agent.</p>


            </article>

            
        </section>
    

        <section>

                            <header>
                    <h1 class="header-title">Upgrading the VMware Horizon Agent</h1>
                </header>
            
            <article>
                
<p>Upgrading the Horizon Agent is probably one of the simplest tasks of the upgrade process. You are going to need to upgrade the agents in all of your golden images and then, if you are using Linked Clones, recompose the desktop pools.</p>
<p>With non-persistent desktops, this is a relatively simple task of upgrading the agent, taking a new snapshot, and recomposing all the pools. With persistent desktops, you may need to take further consideration of the effect of recomposing the pool, or, alternatively, look at manually upgrading the agent on each virtual desktop machine, or deploy an applications deployment tool.</p>
<p>You also need to consider that the Horizon Agent may be installed on an RDSH host server used for delivering desktop sessions and View hosted applications. For this, you will need to schedule time where you can take host machines out of the farm in order to perform the upgrade.</p>
<p>We are not going to go through the Horizon Agent installation process, as this has been covered previously in <a href="d42ce468-eec2-4d43-ba82-25b90b59f936.xhtml">Chapter 7</a>, <em>Building and Optimizing the Virtual Desktop OS</em>.</p>


            </article>

            
        </section>
    

        <section>

                            <header>
                    <h1 class="header-title">Upgrading the Horizon Client</h1>
                </header>
            
            <article>
                
<p>There is no built-in method to upgrade the Horizon Clients automatically, unless, of course, you use something like Microsoft SCCM to deploy software automatically.</p>
<p>If you are running thin clients as end user devices for your users, the upgrade procedure is usually easily managed with the management software that comes with the thin clients.</p>
<p>If you are using re-provisioned PCs, or maybe laptops, to connect to the Horizon View environment, you are going to need to either manually update the client, direct your users to do so, or use a third-party software deployment tool to complete the upgrade.</p>
<p>For those users who are using BYOD, or any other type of non-corporate device, then they will have to rely on the device stores to alert them to the fact that a new version is available. However, you will need to make sure that any new client version that a user does install will still be compatible with your Horizon infrastructure.</p>
<p class="mce-root"/>
<p class="mce-root"/>


            </article>

            
        </section>
    

        <section>

                            <header>
                    <h1 class="header-title">Summary</h1>
                </header>
            
            <article>
                
<p>In this chapter, we have covered the process of upgrading your VMware Horizon View environment to a newer version, walking through what you need to do for each of the individual infrastructure components. The actual upgrade process itself is relatively easy, but you must take the time to check and complete the prerequisites first. <span>You also need to keep in mind the importance of planning the update, so as to minimize the effect on your end users.</span></p>


            </article>

            
        </section>
    </body></html>