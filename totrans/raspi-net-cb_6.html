<html><head></head><body><div class="chapter" title="Chapter&#xA0;6.&#xA0;IoT &#x2013; Internet of Things"><div class="titlepage"><div><div><h1 class="title"><a id="ch06"/>Chapter 6. IoT – Internet of Things</h1></div></div></div><p>In this chapter, we will cover:</p><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc">Easy access to hardware</li><li class="listitem" style="list-style-type: disc">Installing the GrovePi</li><li class="listitem" style="list-style-type: disc">Controlling devices from a web page</li><li class="listitem" style="list-style-type: disc">Connecting to an IoT platform</li><li class="listitem" style="list-style-type: disc">Creating an IoT gateway</li></ul></div><div class="section" title="Introduction"><div class="titlepage"><div><div><h1 class="title"><a id="ch06lvl1sec55"/>Introduction</h1></div></div></div><p>The recipes in this chapter show how devices and sensors – things – attached to the Raspberry Pi<a class="indexterm" id="id548"/> can be connected to the <span class="strong"><strong>Internet of Things</strong></span> (<span class="strong"><strong>IoT</strong></span>).</p><p>The (<span class="strong"><strong>IoT</strong></span>) describes the Internet when it is being used to enable physical objects – Things – to exchange data. When connected to the Internet, the Raspberry Pi can participate in the IoT, exchanging real-time data using its <span class="strong"><strong>general-purpose input/output</strong></span> (<span class="strong"><strong>GPIO</strong></span>) and other <a class="indexterm" id="id549"/>hardware interfaces. This chapter has a collection of recipes that show how the Raspberry Pi can participate in the Internet of Things.</p><p>The recipes in this chapter are specific to the Raspberry Pi. They utilize the hardware interfaces of the Raspberry Pi – the GPIO pins. The concepts can be used with other Linux computers; however, the instructions are specific to the Raspberry Pi.</p><p>After completing the recipes in this chapter, you will have configured and controlled devices and sensors attached directly to the Raspberry Pi and via the GrovePi hardware system. You will also have controlled devices attached to the Raspberry Pi from a web page hosted on the Raspberry and through the IoT service providers SmartLiving.io and ThingBox.io. </p></div></div>
<div class="section" title="Easy access to hardware"><div class="titlepage"><div><div><h1 class="title"><a id="ch06lvl1sec56"/>Easy access to hardware</h1></div></div></div><p>This<a class="indexterm" id="id550"/> recipe demonstrates how simple it is to access hardware from a Raspberry Pi. </p><p>In this recipe, an LED connected to one of the Raspberry Pi's GPIO pins is made to blink using simple Bash commands (<code class="literal">ls</code>, <code class="literal">cat</code>, and <code class="literal">echo</code>).</p><p>After completing this recipe, you will be able to control the GPIO ports attached to your Raspberry Pi from the Bash command line.</p><div class="section" title="Getting ready"><div class="titlepage"><div><div><h2 class="title"><a id="ch06lvl2sec205"/>Getting ready</h2></div></div></div><p>Ingredients:</p><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc">An Initial Setup or Basic Networking setup for the Raspberry Pi that is not powered on</li><li class="listitem" style="list-style-type: disc">An LED</li><li class="listitem" style="list-style-type: disc">A pushbutton switch</li><li class="listitem" style="list-style-type: disc">Three 330 Ohm resisters</li><li class="listitem" style="list-style-type: disc">A breadboard</li><li class="listitem" style="list-style-type: disc">A few breadboarding wires</li></ul></div><p>This recipe does not require the desktop GUI and could either be run from the text-based console or from within an <code class="literal">LXTerminal</code>.</p><p>If the Raspberry Pi's Secure Shell server is running, this recipe can be completed remotely using a Secure Shell client.</p></div><div class="section" title="How to do it..."><div class="titlepage"><div><div><h2 class="title"><a id="ch06lvl2sec206"/>How to do it...</h2></div></div></div><p>The steps to easily accessing hardware from the command line are:</p><div class="orderedlist"><ol class="orderedlist arabic"><li class="listitem">Before powering on the Raspberry Pi, use the following two diagrams to connect a pushbutton switch to GPIO port 23 (pin 16) and an LED to GPIO port 24 (pin 18). <p>The following diagram shows the component layout for this recipe:</p><div class="mediaobject"><img alt="How to do it..." src="graphics/B04745_06_01.jpg"/></div></li><li class="listitem">The <a class="indexterm" id="id551"/>pushbutton switch should be connected to pin 2 (5V) on one side. The other side of the pushbutton switch should have two 330 Ohm resisters connected – one resister leading to pin 6 (GND) and one resistor leading to pin 16 (GPIO 23).</li><li class="listitem">The LED should be connected to pin 18 (GPIO port 24) on one side. The other side of the LED should have a 330 Ohm resistor connected leading to pin 20 (GND). <div class="note" style="" title="Note"><div class="inner"><h3 class="title"><a id="note31"/>Note</h3><p>Turn the LED around if the first try does not work.</p><p>An LED is a light emitting diode. Diodes only allow current to flow in one direction. A reversed diode is a common electronic circuit bug.</p></div></div></li><li class="listitem">After you have validated that the pushbutton switch, the LED, and the two 330 Ohm resistors are connected correctly, power on the Raspberry Pi.<p>The following diagram shows the pin layout of the Raspberry Pi's GPIO interface:</p><div class="mediaobject"><img alt="How to do it..." src="graphics/B04745_06_02.jpg"/></div></li><li class="listitem">Log<a class="indexterm" id="id552"/> in to the Raspberry Pi either directly or remotely.</li><li class="listitem">Use the <code class="literal">cd </code>command to navigate through the Raspberry Pi's kernel parameters to the <code class="literal">/sys/class/gpio</code> directory.<div class="informalexample"><pre class="programlisting">
pi@raspberrypi ~ $ 
<span class="strong"><strong>cd /sys/class/gpio</strong></span>

pi@raspberrypi ~ $
</pre></div></li><li class="listitem">Use the <code class="literal">ls</code> command to list the contents of the kernel parameter directory containing GPIO parameters and interfaces.<div class="informalexample"><pre class="programlisting">
pi@raspberrypi /sys/class/gpio $ 
<span class="strong"><strong>ls</strong></span>
export  gpiochip0  unexport

pi@raspberrypi /sys/class/gpio $ 
</pre></div></li><li class="listitem">Use <a class="indexterm" id="id553"/>the <code class="literal">echo</code> command to tell the Raspberry Pi's kernel to <code class="literal">export</code> the interfaces to GPIO ports <code class="literal">23</code> and <code class="literal">24</code> into user space.<div class="informalexample"><pre class="programlisting">
pi@raspberrypi /sys/class/gpio $ 
<span class="strong"><strong>echo 23 &gt;export</strong></span>

pi@raspberrypi /sys/class/gpio $ 
<span class="strong"><strong>echo 24 &gt;export</strong></span>

pi@raspberrypi /sys/class/gpio $ 
</pre></div></li><li class="listitem">Use the <code class="literal">ls</code> command to once again display the contents of the kernel parameters and interfaces directory, <code class="literal">/sys/class/gpio</code>. <div class="informalexample"><pre class="programlisting">
pi@raspberrypi /sys/class/gpio $ 
<span class="strong"><strong>ls</strong></span>
export  gpio23  gpio24  gpiochip0  unexport

pi@raspberrypi /sys/class/gpio $ 
</pre></div></li><li class="listitem">Notice the two new user space accessible kernel interfaces to GPIO port 23 (<code class="literal">gpio23</code>) and GPIO port 24 (<code class="literal">gpio24)</code>.</li><li class="listitem">Use the <code class="literal">echo</code> command to configure GPIO port 23 (<code class="literal">gpio23</code>) to receive input signals (<code class="literal">in</code>) and GPIO port 24 (<code class="literal">gpio24</code>) to send output signals (<code class="literal">out</code>).<div class="informalexample"><pre class="programlisting">
pi@raspberrypi /sys/class/gpio $ 
<span class="strong"><strong>echo in &gt;gpio23/direction</strong></span>
 

pi@raspberrypi /sys/class/gpio $ 
<span class="strong"><strong>echo out &gt;gpio24/direction</strong></span>

pi@raspberrypi /sys/class/gpio $ 
</pre></div></li><li class="listitem">Use the <code class="literal">cat</code> command to see the current state of the pushbutton switch when it's not being pressed (<code class="literal">0</code>) and when it is pressed (<code class="literal">1</code>).<div class="informalexample"><pre class="programlisting">
pi@raspberrypi /sys/class/gpio $ 
<span class="strong"><strong>cat gpio23/value</strong></span>
 
0

pi@raspberrypi /sys/class/gpio $ # WHILE PRESSING THE BUTTON...

pi@raspberrypi /sys/class/gpio $ 
<span class="strong"><strong>cat gpio23/value</strong></span>
 
1

pi@raspberrypi /sys/class/gpio $ 
</pre></div></li><li class="listitem">The pushbutton switch works!</li><li class="listitem">Use the <code class="literal">echo</code> command to turn the LED on (<code class="literal">1</code>) and then off (<code class="literal">0</code>).<div class="informalexample"><pre class="programlisting">
pi@raspberrypi /sys/class/gpio $ 
<span class="strong"><strong>echo 1 &gt;gpio24/value</strong></span>

pi@raspberrypi /sys/class/gpio $ 
<span class="strong"><strong>echo 0 &gt;gpio24/value</strong></span>
 
pi@raspberrypi /sys/class/gpio $ 
</pre></div></li><li class="listitem">The<a class="indexterm" id="id554"/> LED works!</li><li class="listitem">Use the following <code class="literal">while</code> loop to control the LED with the pushbutton. Use <span class="emphasis"><em>Ctrl-C</em></span> (<code class="literal">^C</code>) to stop the <code class="literal">while</code> loop.<div class="informalexample"><pre class="programlisting">
pi@raspberrypi /sys/class/gpio $ 
<span class="strong"><strong>in=gpio23/value</strong></span>

pi@raspberrypi /sys/class/gpio $ 
<span class="strong"><strong>out=gpio24/value</strong></span>

pi@raspberrypi /sys/class/gpio $ 
<span class="strong"><strong>while true; do echo $(cat $in) &gt;$out; done</strong></span>

<span class="strong"><strong>^C</strong></span>

pi@raspberrypi /sys/class/gpio $ 
</pre></div></li><li class="listitem">The pushbutton switch controls the LED!</li><li class="listitem">Use the <code class="literal">echo</code> command to <code class="literal">unexport</code> GPIO ports <code class="literal">23</code> and <code class="literal">24</code> from user space, and use the <code class="literal">ls</code> command to see that the Raspberry Pi kernel has removed the <code class="literal">gpio23</code> and <code class="literal">gpio24</code> interfaces.<div class="informalexample"><pre class="programlisting">
pi@raspberrypi /sys/class/gpio $ 
<span class="strong"><strong>ls</strong></span>
export  gpio23  gpio24  gpiochip0  unexport

pi@raspberrypi /sys/class/gpio $ 
<span class="strong"><strong>echo 23 &gt;unexport</strong></span>

pi@raspberrypi /sys/class/gpio $ 
<span class="strong"><strong>echo 24 &gt;unexport</strong></span>

pi@raspberrypi /sys/class/gpio $ 
<span class="strong"><strong>ls</strong></span>
export  gpiochip0  unexport
</pre></div></li></ol></div></div><div class="section" title="How it works..."><div class="titlepage"><div><div><h2 class="title"><a id="ch06lvl2sec207"/>How it works...</h2></div></div></div><p>This recipe uses a connected input device (pushbutton switch) to activate an output device (LED). The recipe begins by connecting the input and output devices to the Raspberry Pi. Once the devices are connected, each of the devices is tested individually. Finally, a Bash script activates the output device whenever the input device signals.</p><p>Before<a class="indexterm" id="id555"/> the Raspberry Pi is powered on two devices, a pushbutton switch and an <span class="strong"><strong>LED</strong></span>, are connected to the Raspberry Pi. </p><div class="section" title="Connect the pushbutton switch to GPIO port 23"><div class="titlepage"><div><div><h3 class="title"><a id="ch06lvl3sec64"/>Connect the pushbutton switch to GPIO port 23</h3></div></div></div><p>The <a class="indexterm" id="id556"/>pushbutton switch acts as an input device. It is connected to +5v on one side via pin 2<span class="strong"><strong> </strong></span>and to GPIO port 23 on the other side via pin 16. When the pushbutton switch is pressed, GPIO port 23 (pin 16) detects a high signal coming from +5v (pin 2) through the closed pushbutton switch. </p><p>In addition to the pushbutton switch, two 330 Ohm resistors are necessary to safely complete this part of the circuit. One 330 Ohm resistor is used to limit the current flow when the pushbutton switch is pressed (closed) and the signal is high. The other 330 Ohm resistor is used to pull the signal down to low when the pushbutton switch is not pressed (open). </p><p>The current-limiting resistor connects the pushbutton switch to GPIO port 23 (pin 16). The pull-down resistor connects GPIO port 23 (pin 16) to GND (pin 6). </p><p>When the pushbutton switch is open, GPIO port 23 (pin 16) detects a low signal coming through the pull-down resistor connected to GND (pin 6). When the pushbutton switch is closed, GPIO port 23 (pin 16) detects a high signal coming from +5v (pin 2) through the current-limiting resistor.</p></div><div class="section" title="Connect the LED to GPIO port 24"><div class="titlepage"><div><div><h3 class="title"><a id="ch06lvl3sec65"/>Connect the LED to GPIO port 24</h3></div></div></div><p>The <a class="indexterm" id="id557"/>LED acts as an output device. It is connected to GPIO port 24 (pin 18) on one side. On the other side, the LED is connected to a current-limiting 330 Ohm resistor leading to GND (pin 20).</p><p>When GPIO port 24 (pin 18) emits a high signal, enough current passes through the circuit to light the LED. When the signal is low, the LED remains unlit.</p></div><div class="section" title="Power on and log in"><div class="titlepage"><div><div><h3 class="title"><a id="ch06lvl3sec66"/>Power on and log in</h3></div></div></div><p>Once <a class="indexterm" id="id558"/>you have validated that the LED, the pushbutton switch, and the three protective 330 Ohm resistors are connected correctly, turn on the Raspberry Pi and log in.</p></div><div class="section" title="Navigating the Linux kernel with sysfs"><div class="titlepage"><div><div><h3 class="title"><a id="ch06lvl3sec67"/>Navigating the Linux kernel with sysfs</h3></div></div></div><p>After you have logged in, the recipe uses the <code class="literal">cd</code> command to navigate to the <code class="literal">/sys/class/gpio</code> directory within the <code class="literal">sysfs</code> virtual file system. The <code class="literal">sysfs</code> virtual file system is<a class="indexterm" id="id559"/> a user space mapping of Linux kernel parameters and interfaces. The kernel parameters for the GPIO interface are accessible from <code class="literal">/sys/class/gpio</code>.</p><p>The <code class="literal">ls</code> command is used to see which GPIO port interfaces are currently exported from kernel space to user space. So far, no interfaces have been exported. </p><p>The gpio directory only contains three entries: two pseudo-parameters, <code class="literal">export</code> and <code class="literal">unexport</code>; and one interface, <code class="literal">gpiochip0</code>. The interface to <code class="literal">gpiochip0</code> is not used in this recipe. The two pseudo-parameters are used to <code class="literal">export</code> and <code class="literal">unexport</code> GPIO port interfaces from kernel space to user space.</p></div><div class="section" title="Export GPIO ports 23 and 24"><div class="titlepage"><div><div><h3 class="title"><a id="ch06lvl3sec68"/>Export GPIO ports 23 and 24</h3></div></div></div><p>The<a class="indexterm" id="id560"/> recipe uses the <code class="literal">echo</code> command to write the numbers 23 and 24 to the <code class="literal">export</code> pseudo-parameter. This tells the Raspberry Pi's Linux kernel to export the interfaces to GPIO ports 23 and 24 into user space (at <code class="literal">/sys/class/gpio</code>). </p><p>The command line for exporting the GPIO port 23 interface, <code class="literal">echo 23 &gt;export</code>, works because it writes (<span class="strong"><strong>&gt;</strong></span>) the number 23 (echo 23) to the Linux kernel pseudo-parameter <code class="literal">/sys/class/gpio/export</code> telling the kernel to create an interface subdirectory (gpio23) for GPIO port 23.</p><p>After the kernel has been told to export the two GPIO ports, the <code class="literal">ls</code> command is used once again to show that the Linux kernel has created two new GPIO port interface subdirectories, one for GPIO port 23, <code class="literal">/sys/class/gpio/gpio23</code>, and one for GPIO port 24, <code class="literal">/sys/class/gpio/gpio24</code>.</p></div><div class="section" title="Configure each interface direction as input or output"><div class="titlepage"><div><div><h3 class="title"><a id="ch06lvl3sec69"/>Configure each interface direction as input or output</h3></div></div></div><p>The<a class="indexterm" id="id561"/> recipe then uses the <code class="literal">echo</code> command to write (<span class="strong"><strong>&gt;</strong></span>) either <code class="literal">in</code> (for input) or <code class="literal">out</code> (for output) to the <code class="literal">direction</code> parameter within each of the GPIO ports' interface subdirectories (gpio23 and gpio24). </p><p>The input device (pushbutton switch) is connected to GPIO port 23, so the direction parameter for GPIO port 23 (gpio23) is set to input (<code class="literal">echo in &gt; gpio23/direction</code>). </p><p>The output device (LED) is connected to GPIO port 24, so the direction for GPIO port 24 (gpio24) is set to output (<code class="literal">echo out &gt; gpio24/direction</code>). </p><p>Once the input/output direction for each GPIO port has been configured, the interface to each port can be tested.</p></div><div class="section" title="Testing the input device"><div class="titlepage"><div><div><h3 class="title"><a id="ch06lvl3sec70"/>Testing the input device</h3></div></div></div><p>The input device is tested using the <code class="literal">cat</code> command to display the value of GPIO port 23 (<code class="literal">gpio23/value</code>).</p><p>The <a class="indexterm" id="id562"/>value of GPIO port 23 (<code class="literal">gpio23/value</code>) is displayed when the pushbutton switch is released and when it is being pressed. When the pushbutton switch is released (the switch is open), the value of GPIO port 23 (<code class="literal">gpio23/value</code>) is low (0). When the pushbutton switch is pressed (closed), the value is high (1).</p></div><div class="section" title="Testing the output device"><div class="titlepage"><div><div><h3 class="title"><a id="ch06lvl3sec71"/>Testing the output device</h3></div></div></div><p>The <a class="indexterm" id="id563"/>output device is tested using the <code class="literal">echo</code> command. </p><p>When the value high is sent to GPIO port 24 (echo 1 &gt;gpio24/value), the LED glows. When the value low is sent (echo 0 &gt;gpio24/value), the LED stops glowing.</p></div><div class="section" title="Using the input device to activate the output device"><div class="titlepage"><div><div><h3 class="title"><a id="ch06lvl3sec72"/>Using the input device to activate the output device</h3></div></div></div><p>After successfully testing<a class="indexterm" id="id564"/> the input (pushbutton switch) and output (LED) devices, the recipe connects the two devices with a simple <code class="literal">while</code> loop.</p><p>First, the shell variable <code class="literal">in</code> is defined to be an alias for the value of GPIO port 23 (<code class="literal">gpio23/value</code>) and the variable <code class="literal">out</code> is defined to be an alias for the value of GPIO port 24 (<code class="literal">gpio24/value</code>). </p><p>Then, the two variables are used in an infinite loop (<code class="literal">while true; do</code>) that reads the input signal from GPIO port 23 (<code class="literal">$(cat in)</code>) and uses the <code class="literal">echo</code> command to write the signal to GPIO port 24 (<code class="literal">&gt;$out</code>).</p><p>While the loop is running, the LED lights whenever the pushbutton switch is pressed.</p><p>Pressing <span class="emphasis"><em>Ctrl+C</em></span> stops the loop.</p></div><div class="section" title="Cleanup"><div class="titlepage"><div><div><h3 class="title"><a id="ch06lvl3sec73"/>Cleanup</h3></div></div></div><p>After<a class="indexterm" id="id565"/> running the loop, the <code class="literal">cat</code> command is used to unexport the Linux kernel interfaces from user space to GPIO port 23 (<code class="literal">/sys/class/gpio/gpio23</code>) and GPIO port 24 (<code class="literal">/sys/class/gpio/gpio24</code>).</p><p>After the GPIO port interfaces have been unexported, the <code class="literal">ls</code> command is used to validate that the two GPIO port interfaces (<code class="literal">gpio23</code> and <code class="literal">gpio24</code>) have been removed from the <code class="literal">/sys/class/gpio</code> user space directory.</p></div></div><div class="section" title="See also"><div class="titlepage"><div><div><h2 class="title"><a id="ch06lvl2sec208"/>See also</h2></div></div></div><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc"><span class="strong"><strong>General-purpose </strong></span><a class="indexterm" id="id566"/><span class="strong"><strong>input/output </strong></span>(<a class="ulink" href="https://en.wikipedia.org/wiki/General-purpose_input/output">https://en.wikipedia.org/wiki/General-purpose_input/output</a>): This Wikipedia article describes how General-purpose input/output interfaces work.</li><li class="listitem" style="list-style-type: disc"><span class="strong"><strong>sysfs </strong></span>(<a class="ulink" href="https://en.wikipedia.org/wiki/Sysfs">https://en.wikipedia.org/wiki/Sysfs</a>): This Wikipedia article<a class="indexterm" id="id567"/> describes the <code class="literal">sysfs</code> filesystem, its history, and how it works.</li><li class="listitem" style="list-style-type: disc"><span class="strong"><strong>Pull-up resistor </strong></span>(<a class="ulink" href="https://en.wikipedia.org/wiki/Pull-up_resistor">https://en.wikipedia.org/wiki/Pull-up_resistor</a>): This Wikipedia article describes how pull-up resistors are used to<a class="indexterm" id="id568"/> ensure a circuit has valid logic levels.</li><li class="listitem" style="list-style-type: disc"><span class="strong"><strong>Diode </strong></span>(<a class="ulink" href="https://en.wikipedia.org/wiki/Diode">https://en.wikipedia.org/wiki/Diode</a>): This Wikipedia article<a class="indexterm" id="id569"/> explains diodes in great detail.</li><li class="listitem" style="list-style-type: disc"><span class="strong"><strong>Bash Guide for Beginners </strong></span>(<a class="ulink" href="http://tldp.org/LDP/Bash-Beginners-Guide/html/index.html">http://tldp.org/LDP/Bash-Beginners-Guide/html/index.html</a>): This book is a practical guide for using Bash and the<a class="indexterm" id="id570"/> Bash scripting language.</li></ul></div></div></div>
<div class="section" title="Installing the GrovePi"><div class="titlepage"><div><div><h1 class="title"><a id="ch06lvl1sec57"/>Installing the GrovePi</h1></div></div></div><p>This <a class="indexterm" id="id571"/>recipe configures access to the Grove Pi extension board for the Raspberry Pi. </p><p>The Grove hardware system by Seeed is a Lego-like system for plugging together electronic components without the need for soldering. </p><p>The GrovePi by Dexter Industries turns the Raspberry Pi into a central control hub for Grove components. </p><p>The following image shows the GrovePi+ installed on a Raspberry Pi 2:</p><div class="mediaobject"><img alt="Installing the GrovePi" src="graphics/B04745_06_03.jpg"/></div><p>After <a class="indexterm" id="id572"/>completing this recipe, you will be able to control Grove components attached to the GrovePi from your Raspberry Pi using the Python scripting language.</p><div class="section" title="Getting ready"><div class="titlepage"><div><div><h2 class="title"><a id="ch06lvl2sec209"/>Getting ready</h2></div></div></div><p>Ingredients:</p><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc">An Initial Setup or Basic Networking setup for the Raspberry Pi that has been powered on, but the GrovePi has not yet been installed. You have also logged in as the user <code class="literal">pi</code> (see the recipes in <a class="link" href="ch01.html" title="Chapter 1. Installation and Setup">Chapter 1</a>, <span class="emphasis"><em>Installation and Setup</em></span> for how to boot and log in, and the recipes in <a class="link" href="ch02.html" title="Chapter 2. Administration">Chapter 2</a>, <span class="emphasis"><em>Administration</em></span> for how to log in remotely).</li><li class="listitem" style="list-style-type: disc">A GrovePi GPIO expansion board.</li><li class="listitem" style="list-style-type: disc">A Grove LED.</li><li class="listitem" style="list-style-type: disc">A Grove pushbutton switch.</li><li class="listitem" style="list-style-type: disc">Two Grove connector wires.</li></ul></div><p>If the Raspberry Pi's Secure Shell server is running, this recipe can be completed remotely using a Secure Shell client.</p></div><div class="section" title="How to do it..."><div class="titlepage"><div><div><h2 class="title"><a id="ch06lvl2sec210"/>How to do it...</h2></div></div></div><p>The steps<a class="indexterm" id="id573"/> to installing the GrovePi are:</p><div class="orderedlist"><ol class="orderedlist arabic"><li class="listitem">Before attaching the GrovePi to the Raspberry Pi, use the <code class="literal">git</code> command to download the GrovePi installation files from the <code class="literal">DexterInd/GrovePi</code> repository on <code class="literal">github.com</code>. <div class="informalexample"><pre class="programlisting">
pi@raspberrypi ~ $ 
<span class="strong"><strong>git clone https://github.com/DexterInd/GrovePi</strong></span>

Cloning into 'GrovePi'...
remote: Counting objects: 2206, done.
remote: Total 2206 (delta 0), reused 0 (delta 0), pack-reused 2206
Receiving objects: 100% (2206/2206), 1.22 MiB | 1.37 MiB/s, done.
Resolving deltas: 100% (1134/1134), done.

pi@raspberrypi ~/ $ 
</pre></div></li><li class="listitem">Use the <code class="literal">cd</code> command to navigate to the directory containing the installation script, <code class="literal">GrovePi/Scripts</code>.<div class="informalexample"><pre class="programlisting">
pi@raspberrypi ~ $ 
<span class="strong"><strong>cd GrovePi/Script/</strong></span>

pi@raspberrypi ~/GrovePi/Script $ 
</pre></div></li><li class="listitem">Use the <code class="literal">sh</code> command to execute the installation script. The command requires super user privileges (use <code class="literal">sudo</code>).<div class="informalexample"><pre class="programlisting">pi@raspberrypi ~/GrovePi/Script $ <span class="strong"><strong>sudo sh ./install.sh </strong></span>

  _____            _                                
 |  __ \          | |                               
 | |  | | _____  _| |_ ___ _ __                     
 | |  | |/ _ \ \/ / __/ _ \ '__|                    
 | |__| |  __/&gt;  &lt;| ||  __/ |                       
 |_____/ \___/_/\_\__\___|_| _        _            
 |_   _|         | |         | |      (_)           
   | |  _ __   __| |_   _ ___| |_ _ __ _  ___  ___  
   | | | '_ \ / _` | | | / __| __| '__| |/ _ \/ __|
  _| |_| | | | (_| | |_| \__ \ |_| |  | |  __/\__ \ 
 |_____|_| |_|\__,_|\__,_|___/\__|_|  |_|\___||___/ 


Welcome to GrovePi Installer.
 
Requirements:

1) Must be connected to the internet

2) This script must be run as root user
 
Steps:

1) Installs package dependencies:
   - python-pip       alternative Python package installer
   - git              fast, scalable, distributed revision control system
   - libi2c-dev       userspace I2C programming library development files
   - python-serial    pyserial - module encapsulating access for the serial port
   - python-rpi.gpio  Python GPIO module for Raspberry Pi
   - i2c-tools        This Python module allows SMBus access through the I2C /dev
   - python-smbus     Python bindings for Linux SMBus access through i2c-dev
   - arduino          AVR development board IDE and built-in libraries
   - minicom          friendly menu driven serial communication program

2) Installs wiringPi in GrovePi/Script

3) Removes I2C and SPI from modprobe blacklist /etc/modprobe.d/raspi-blacklist.conf

4) Adds I2C-dev, i2c-bcm2708 and spi-dev to /etc/modules

5) Installs gertboard avrdude_5.10-4_armhf.deb package

6) Runs gertboard setup
   - configures avrdude
   - downloads gertboard known boards and programmers
   - replaces avrsetup with gertboards version
   - in /etc/inittab comments out lines containing AMA0
   - in /boot/cmdline.txt removes: console=ttyAMA0,115200 kgdboc=ttyAMA0,115200 console=tty1
   - in /usr/share/arduino/hardware/arduino creates backup of boards.txt
   - in /usr/share/arduino/hardware/arduino creates backup of programmers.txt
 
Special thanks to Joe Sanford at Tufts University. This script was derived from his work. Thank you Joe!
 
Raspberry Pi will reboot after completion.</pre></div></li><li class="listitem">As<a class="indexterm" id="id574"/> the installation continues, it will prompt for permission to install new software packages. Press the <span class="emphasis"><em>Enter</em></span> key to accept the default answer to the prompts (<code class="literal">Y</code>).</li><li class="listitem">When the installation script completes, you will be prompted to restart the Raspberry Pi. Instead, use the <code class="literal">poweroff</code> command to shut down the Raspberry Pi.<div class="informalexample"><pre class="programlisting">  _____  ______  _____ _______       _____ _______ 
 |  __ \|  ____|/ ____|__   __|/\   |  __ \__   __|
 | |__) | |__  | (___    | |  /  \  | |__) | | |   
 |  _  /|  __|  \___ \   | | / /\ \ |  _  /  | |   
 | | \ \| |____ ____) |  | |/ ____ \| | \ \  | |   
 |_|  \_\______|_____/   |_/_/    \_\_|  \_\ |_|   
 

Please restart to implement changes!
To Restart type sudo reboot


pi@raspberrypi ~ $ <span class="strong"><strong>sudo poweroff</strong></span>

Broadcast message from root@raspberrypi (pts/0) (Sun Sep 27 21:42:34 2015):
The system is going down for system halt NOW!</pre></div></li><li class="listitem">While <a class="indexterm" id="id575"/>the Raspberry Pi is shut down and the power has been disconnected, attach the GrovePi to the Raspberry Pi.<p>The following image shows how to attach the GrovePi+ to the Raspberry Pi 2:</p><div class="mediaobject"><img alt="How to do it..." src="graphics/B04745_06_04.jpg"/></div></li><li class="listitem">After the GrovePi has been attached to the Raspberry Pi, reconnect the power and log in once the Raspberry Pi finishes booting.</li><li class="listitem">After logging in, use the <code class="literal">i2cdetect</code> command to validate that the GrovePi has been installed correctly. Note: if you are using an original Raspberry Pi, use the option <code class="literal">–y 0</code> instead of <code class="literal">–y 1</code>.<div class="informalexample"><pre class="programlisting">pi@raspberrypi ~ $ <span class="strong"><strong>sudo i2cdetect -y 1</strong></span>
     0  1  2  3  4  5  6  7  8  9  a  b  c  d  e  f
00:          -- 04 -- -- -- -- -- -- -- -- -- -- -- 
10: -- -- -- -- -- -- -- -- -- -- -- -- -- -- -- -- 
20: -- -- -- -- -- -- -- -- -- -- -- -- -- -- -- -- 
30: -- -- -- -- -- -- -- -- -- -- -- -- -- -- -- -- 
40: -- -- -- -- -- -- -- -- -- -- -- -- -- -- -- -- 
50: -- -- -- -- -- -- -- -- -- -- -- -- -- -- -- -- 
60: -- -- -- -- -- -- -- -- -- -- -- -- -- -- -- -- 
70: -- -- -- -- -- -- -- --                         </pre></div></li><li class="listitem">Now, use the <code class="literal">apt-get install</code> command to install the Python setup tools (<code class="literal">python-setuptools</code>).<div class="informalexample"><pre class="programlisting">pi@raspberrypi ~ $ <span class="strong"><strong>sudo apt-get install -y python-setuptools</strong></span>
Reading package lists... Done
Building dependency tree       
Reading state information... Done
The following extra packages will be installed:
  python-pkg-resources
Suggested packages:
  python-distribute python-distribute-doc
The following NEW packages will be installed:
  python-pkg-resources python-setuptools
0 upgraded, 2 newly installed, 0 to remove and 39 not upgraded.
Need to get 0 B/513 kB of archives.
After this operation, 1,308 kB of additional disk space will be used.
Selecting previously unselected package python-pkg-resources.
(Reading database ... 82496 files and directories currently installed.)
Unpacking python-pkg-resources (from .../python-pkg-resources_0.6.24-1_all.deb) ...
Selecting previously unselected package python-setuptools.
Unpacking python-setuptools (from .../python-setuptools_0.6.24-1_all.deb) ...
Setting up python-pkg-resources (0.6.24-1) ...
Setting up python-setuptools (0.6.24-1) ...

pi@raspberrypi ~ $ </pre></div></li><li class="listitem">Use the <code class="literal">cd</code> command to navigate to the GrovePi Python software library (<code class="literal">~/GrovePi/Software/Python</code>).<div class="informalexample"><pre class="programlisting">pi@raspberrypi ~ $ <span class="strong"><strong>cd GrovePi/Software/Python</strong></span>

pi@raspberrypi ~/GrovePi/Software/Python $ </pre></div></li><li class="listitem">Use<a class="indexterm" id="id576"/> the <code class="literal">python setup.py</code> command to <code class="literal">build</code> and <code class="literal">install</code> the <code class="literal">grovepi</code> module.<div class="informalexample"><pre class="programlisting">pi@raspberrypi ~/GrovePi/Software/Python $ <span class="strong"><strong>python setup.py build</strong></span>
running build
running build_py
creating build
creating build/lib.linux-armv7l-2.7
copying grovepi.py -&gt; build/lib.linux-armv7l-2.7

pi@raspberrypi ~/GrovePi/Software/Python $ <span class="strong"><strong>sudo python setup.py install</strong></span>
running install
Checking .pth file support in /usr/local/lib/python2.7/dist-packages/
/usr/bin/python -E -c pass
TEST PASSED: /usr/local/lib/python2.7/dist-packages/ appears to support .pth files
running bdist_egg
running egg_info
creating grovepi.egg-info
writing grovepi.egg-info/PKG-INFO
writing top-level names to grovepi.egg-info/top_level.txt
writing dependency_links to grovepi.egg-info/dependency_links.txt
writing manifest file 'grovepi.egg-info/SOURCES.txt'
reading manifest file 'grovepi.egg-info/SOURCES.txt'
writing manifest file 'grovepi.egg-info/SOURCES.txt'
installing library code to build/bdist.linux-armv7l/egg
running install_lib
running build_py
creating build/bdist.linux-armv7l
creating build/bdist.linux-armv7l/egg
copying build/lib.linux-armv7l-2.7/grovepi.py -&gt; build/bdist.linux-armv7l/egg
byte-compiling build/bdist.linux-armv7l/egg/grovepi.py to grovepi.pyc
creating build/bdist.linux-armv7l/egg/EGG-INFO
copying grovepi.egg-info/PKG-INFO -&gt; build/bdist.linux-armv7l/egg/EGG-INFO
copying grovepi.egg-info/SOURCES.txt -&gt; build/bdist.linux-armv7l/egg/EGG-INFO
copying grovepi.egg-info/dependency_links.txt -&gt; build/bdist.linux-armv7l/egg/EGG-INFO
copying grovepi.egg-info/top_level.txt -&gt; build/bdist.linux-armv7l/egg/EGG-INFO
zip_safe flag not set; analyzing archive contents...
creating dist
creating 'dist/grovepi-0.0.0-py2.7.egg' and adding 'build/bdist.linux-armv7l/egg' to it
removing 'build/bdist.linux-armv7l/egg' (and everything under it)
Processing grovepi-0.0.0-py2.7.egg
creating /usr/local/lib/python2.7/dist-packages/grovepi-0.0.0-py2.7.egg
Extracting grovepi-0.0.0-py2.7.egg to /usr/local/lib/python2.7/dist-packages
Adding grovepi 0.0.0 to easy-install.pth file

Installed /usr/local/lib/python2.7/dist-packages/grovepi-0.0.0-py2.7.egg
Processing dependencies for grovepi==0.0.0
Finished processing dependencies for grovepi==0.0.0

pi@raspberrypi ~/GrovePi/Software/Python $ </pre></div></li><li class="listitem">Attach <a class="indexterm" id="id577"/>a <code class="literal">Grove LED</code> device to port <code class="literal">D2</code> and a <code class="literal">Grove pushbutton switch</code> to port <code class="literal">D4</code> of the <code class="literal">GrovePi</code>.</li><li class="listitem">A <code class="literal">Grove pushbutton switch</code> and a <code class="literal">Grove LED</code> are attached to the <code class="literal">GrovePi+</code>, as depicted in the following image:<div class="mediaobject"><img alt="How to do it..." src="graphics/B04745_06_05.jpg"/></div></li><li class="listitem">Now, use the following Python script (<code class="literal">button.py</code>), to test the <code class="literal">Grove pushbutton switch</code>. Run the test script (<code class="literal">button.py</code>) twice – once without pressing the pushbutton switch (<code class="literal">0</code>) and once while pressing the pushbutton switch (<code class="literal">1</code>). Notice the different results.<div class="informalexample"><pre class="programlisting">pi@raspberrypi:~$ <span class="strong"><strong>cat &lt;&lt;EOD &gt;button.py
from grovepi import *
button = 4
pinMode( button, "input" )
print digitalRead( button )
EOD</strong></span>

pi@raspberrypi:~$ # without pressing the pushbutton switch
pi@raspberrypi:~$ <span class="strong"><strong>python button.py</strong></span>
0

pi@raspberrypi:~$ # while pressing the pushbutton switch
pi@raspberrypi:~$ <span class="strong"><strong>python button.py</strong></span>
1

pi@raspberrypi:~$ </pre></div></li><li class="listitem">Next, use<a class="indexterm" id="id578"/> the following Python script (<code class="literal">led.py</code>) to test the <code class="literal">LED</code>. When the script (<code class="literal">led.py</code>) is run, the <code class="literal">LED</code> should glow for one second.<div class="informalexample"><pre class="programlisting">pi@raspberrypi:~$ <span class="strong"><strong>cat &lt;&lt;EOD &gt;led.py
from grovepi import *
from time import sleep
led = 2
pinMode( led, "output" )
digitalWrite( led, 1 )
sleep( 1 )
digitalWrite( led, 0 )
EOD</strong></span>

pi@raspberrypi:~$ <span class="strong"><strong>python led.py</strong></span>

pi@raspberrypi:~$ </pre></div></li><li class="listitem">Finally, use the following Python script to light the <code class="literal">LED</code> whenever the <code class="literal">Grove pushbutton switch</code> is pressed. Press <span class="emphasis"><em>Ctrl+C</em></span> to stop the script.<div class="informalexample"><pre class="programlisting">pi@raspberrypi:~$ <span class="strong"><strong>cat &lt;&lt;EOD &gt;loop.py
from grovepi import *
from time import sleep
led = 2
pinMode( led, "output" )
button = 4
pinMode( button, "input" )
while True:
  try:
    state = digitalRead( button )
    digitalWrite( led, state )
    sleep( 0.01 )
  except KeyboardInterrupt:
    digitalWrite( led, 0 )
    break
  except IOError:
    print "IOError"
EOD</strong></span>

pi@raspberrypi:~$ <span class="strong"><strong>python loop.py</strong></span>

<span class="strong"><strong>^C</strong></span></pre></div></li></ol></div></div><div class="section" title="How it works..."><div class="titlepage"><div><div><h2 class="title"><a id="ch06lvl2sec211"/>How it works...</h2></div></div></div><p>This recipe uses the GrovePi attached to the Raspberry Pi to activate an output device (<code class="literal">Grove LED</code>) when the state of an attached input device (<code class="literal">Grove pushbutton switch</code>) changes. The <a class="indexterm" id="id579"/>recipe begins by connecting the GrovePi and the input and output devices to the Raspberry Pi. Once the devices are connected, each of the devices is tested individually. Finally, a Python script is used to activate the output device whenever the input device changes state.</p><p>Before the GrovePi is attached to the Raspberry Pi, the GrovePi drivers are installed. </p><div class="section" title="Installing the GrovePi drivers and interfaces"><div class="titlepage"><div><div><h3 class="title"><a id="ch06lvl3sec74"/>Installing the GrovePi drivers and interfaces</h3></div></div></div><p>The<a class="indexterm" id="id580"/> GrovePi drivers and interfaces are downloaded directly<a class="indexterm" id="id581"/> from their source repository on GitHub (<a class="ulink" href="https://github.com/">https://github.com/</a>). The <code class="literal">git clone</code> command uses a secure Internet connection (<code class="literal">https://</code>) to download the GrovePi interfaces and drivers from their repository, <code class="literal">DexterInd/GrovePi</code>. The downloaded files include the installation scripts.</p><p>The installation script, <code class="literal">install.sh</code>, is located in the <code class="literal">GrovePi/Scripts</code> directory. The <code class="literal">cd</code> command is used to navigate to the <code class="literal">GrovePi/Scipts</code> directory.</p><p>In the <code class="literal">GrovePi/Scipts</code> directory, the <code class="literal">sh</code> command is used to run the <code class="literal">install.sh</code> script. The script requires super user privileges, so <code class="literal">sudo</code> is used as a command prefix.</p><p>Before starting the installation, the <code class="literal">install.sh</code> script displays a complete list of the changes it will make to your Raspberry Pi. The installation script prompts you to continue with the install. Press the <span class="emphasis"><em>Enter</em></span> key to accept the defaults to all questions during the installation process. </p><p>After the GrovePi interfaces and drivers are installed, you are prompted to restart the Raspberry Pi. Shut down the Raspberry Pi instead, so that you can remove the power from the Raspberry Pi and attach the GrovePi to it.</p></div><div class="section" title="Attach the GrovePi to the Raspberry Pi"><div class="titlepage"><div><div><h3 class="title"><a id="ch06lvl3sec75"/>Attach the GrovePi to the Raspberry Pi</h3></div></div></div><p>Follow<a class="indexterm" id="id582"/> the manufacturer's instructions on <a class="ulink" href="http://www.dexterindustries.com/grovepi/">http://www.dexterindustries.com/grovepi/</a> to attach the GrovePi to the Raspberry Pi.</p><p>If you<a class="indexterm" id="id583"/> are attaching the original 26 pin GrovePi to one of the 40 pin models of the Raspberry Pi, make sure that pin 1 is lined up correctly. Even though the GrovePi does not cover all of the pins, it will still work perfectly.</p><p>You may need to put a protective layer between the GrovePi and the Raspberry Pi to prevent the bottom of the GrovePi from touching the Raspberry Pi's USB connectors. A snippet of the electrostatic bag in which the GrovePi was shipped is a perfect protective layer.</p></div><div class="section" title="Power on and log in"><div class="titlepage"><div><div><h3 class="title"><a id="ch06lvl3sec76"/>Power on and log in</h3></div></div></div><p>Once <a class="indexterm" id="id584"/>you have validated that the GrovePi is attached to the Raspberry Pi correctly, attach the power cable to the Raspberry Pi and log in after it reboots.</p><p>The <code class="literal">i2cdetect</code> command is used to validate that the GrovePi has been connected correctly. The <code class="literal">–y</code> option is used to bypass interactive mode. Only the original Raspberry Pi uses bus <code class="literal">0</code>, whereas all of the newer Raspberry Pis use bus <code class="literal">1</code>.</p><p>If the GrovePi is connected correctly, its chip ID <code class="literal">04</code> will be displayed at address <code class="literal">00 4</code>.</p><p>Now<a class="indexterm" id="id585"/> that the GrovePi has been attached and detected, it is time to install the GrovePi's Python language <span class="strong"><strong>Application Programming Interface</strong></span> (<span class="strong"><strong>API</strong></span>).</p></div><div class="section" title="Install the Python API"><div class="titlepage"><div><div><h3 class="title"><a id="ch06lvl3sec77"/>Install the Python API</h3></div></div></div><p>Before<a class="indexterm" id="id586"/> the GrovePi API can be installed, the Python setup tools need to be installed. The <code class="literal">apt-get install</code> command is used to install the <code class="literal">python-setuptools</code> software package. After Python's setup tools are installed, the GrovePi API can be installed. </p><p>The sources for the GrovePi API are located in the <code class="literal">GrovePi/Software/Python</code> directory. The <code class="literal">cd</code> command is used to navigate to that directory.</p><p>The <code class="literal">python</code> command is used to run the <code class="literal">setup.py</code> script, first to build the API and then to install the API. Installation requires super user privileges, so <code class="literal">sudo</code> command is used as a command prefix during <code class="literal">install</code>.</p><p>Once the GrovePi Python API is installed, the hardware devices can be tested.</p></div><div class="section" title="Test the Grove pushbutton switch"><div class="titlepage"><div><div><h3 class="title"><a id="ch06lvl3sec78"/>Test the Grove pushbutton switch</h3></div></div></div><p>The <code class="literal">cat</code> command is<a class="indexterm" id="id587"/> used to create a new script, <code class="literal">button.py</code>, which tests the state of the <code class="literal">Grove pushbutton switch</code>. The lines immediately following the <code class="literal">cat</code> command up to the end of the data marker (<code class="literal">&lt;&lt;EOD</code>) are copied to the new script (<code class="literal">&gt;button.py</code>).</p><p>The <code class="literal">python</code> command is used to run the <code class="literal">button.py</code> test script twice. </p><p>The first time the <code class="literal">button.py</code> script is run, it is run without pressing the pushbutton switch. The result is 0 because the switch is open (not pressed).</p><p>The second time the script is run, it is run while pressing the pushbutton switch. The result is 1 because the switch is closed (pressed).</p></div><div class="section" title="Test the Grove LED"><div class="titlepage"><div><div><h3 class="title"><a id="ch06lvl3sec79"/>Test the Grove LED</h3></div></div></div><p>The <code class="literal">cat</code> command is <a class="indexterm" id="id588"/>also used to create another test script, <code class="literal">led.py</code>, which tests the <code class="literal">Grove LED</code>. The lines immediately following the <code class="literal">cat</code> command up to the end of data marker (<code class="literal">&lt;&lt;EOD</code>) are copied to the new script (<code class="literal">&gt;led.py</code>).</p><p>The <code class="literal">python</code> command is used to run the <code class="literal">led.py</code> test script. When the script (<code class="literal">led.py</code>) is run, the <code class="literal">Grove LED</code> should glow for one second.</p></div><div class="section" title="Pressing the pushbutton switch lights the LED"><div class="titlepage"><div><div><h3 class="title"><a id="ch06lvl3sec80"/>Pressing the pushbutton switch lights the LED</h3></div></div></div><p>The <code class="literal">cat</code> command is used once more to create the <code class="literal">loop.py</code> Python script. This short program <a class="indexterm" id="id589"/>will loop forever sending signal values from the input device (pushbutton switch) to the output device (LED).</p><p>The <code class="literal">loop.py</code> script imports the complete <code class="literal">(*) grovepi</code> API. It also imports the <code class="literal">sleep</code> function from the <code class="literal">time</code> API. </p><p>A variable, <code class="literal">led</code>, is used to represent digital port <code class="literal">2</code>, the port that connects the LED to the GrovePi. The <code class="literal">pinMode</code> function from the <code class="literal">grovepi</code> API is used to set the signal direction for the LED port to output.</p><p>Another variable, <code class="literal">button</code>, is used to represent digital port <code class="literal">4</code>, the port that connects the pushbutton switch to the GrovePi. The <code class="literal">pinMode</code> function is used to set the signal direction for the <code class="literal">button</code> port to <code class="literal">input</code>.</p><p>The main body of the script is an infinite loop (<code class="literal">while True:</code>) that only breaks when a <code class="literal">KeyboardInterrupt exception</code> occurs.</p><p>The loop first uses the <code class="literal">digitalRead</code> function to receive the current value of the <code class="literal">button</code> port. The value received is stored in the variable <code class="literal">state</code>.</p><p>The value of the <code class="literal">state</code> variable is then sent to the led port using the <code class="literal">digitalWrite</code> function.</p><p>Before the <code class="literal">while</code> loop continues, the program sleeps for 0.01 seconds. This gives the Raspberry Pi a chance to do something else in between setting the <code class="literal">state</code> of the led port and reading the next <code class="literal">state</code> from the <code class="literal">button</code> port.</p><p>The <code class="literal">while</code> loop listens for two exceptions: <code class="literal">KeyboardInterrupt</code> and <code class="literal">IOError</code>. When a <code class="literal">KeyboardInterrupt</code> occurs, the script uses the <code class="literal">digitalWrite</code> function to send the LED port the signal for off (<code class="literal">0</code>) and the script breaks the <code class="literal">while</code> loop ending the program. When an <code class="literal">IOError</code> occurs, the message <code class="literal">IOError</code> is printed.</p><p>The <code class="literal">python</code> command is used to run the <code class="literal">loop.py</code> script. While the script is running, the LED glows whenever the pushbutton switch is pressed. The LED stops glowing whenever the pushbutton switch is released. Use <span class="emphasis"><em>Ctrl+C</em></span> to send a <code class="literal">KeyboardInterrupt</code> exception and end the program.</p></div></div><div class="section" title="There's more…"><div class="titlepage"><div><div><h2 class="title"><a id="ch06lvl2sec212"/>There's more…</h2></div></div></div><p>The GrovePi expansion board from Dexter Industries can connect the Raspberry PI to more than 100 components from the Grove hardware platform developed by Seeed Studio. The official website is <a class="ulink" href="http://www.seeedstudio.com/depot/">http://www.seeedstudio.com/depot/</a>. These components can be<a class="indexterm" id="id590"/> manipulated with simple Python <a class="indexterm" id="id591"/>scripts as well as integrated into larger applications programmed in C, Go, or Java.</p><p>In addition to the digital ports used in this recipe, The GrovePi also has analog ports that can receive signal levels ranging from 0 to 1023 and can end signal levels from 0 to 255. The <a class="indexterm" id="id592"/>GrovePi also has 3 I2C ports and a <span class="strong"><strong>Universal Asynchronous Receiver/Transmitter</strong></span> (<span class="strong"><strong>UART</strong></span>) serial port that can be used to communicate with more complex devices.</p><p>Complete GrovePi documentation, including the Python API, can be found on Dexter Industries' website. More information about the Grove System can be found on Seeed Studio's wiki.</p></div><div class="section" title="See also"><div class="titlepage"><div><div><h2 class="title"><a id="ch06lvl2sec213"/>See also</h2></div></div></div><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc"><span class="strong"><strong>GrovePi</strong></span>: at <a class="ulink" href="http://www.dexterindustries.com/grovepi/">http://www.dexterindustries.com/grovepi/</a>. The GrovePi<a class="indexterm" id="id593"/> home page has a complete list of compatible sensors and devices.</li><li class="listitem" style="list-style-type: disc"><span class="strong"><strong>The Grove System</strong></span>: <a class="ulink" href="http://www.seeedstudio.com/wiki/Category:Grove">http://www.seeedstudio.com/wiki/Category:Grove</a>. This wiki page describes<a class="indexterm" id="id594"/> the Lego-like Grove hardware system in more detail.</li><li class="listitem" style="list-style-type: disc"><span class="strong"><strong>The Grove System – Python Library Documentation</strong></span>: <a class="ulink" href="http://www.dexterindustries.com/GrovePi/programming/python-library-documentation/">http://www.dexterindustries.com/GrovePi/programming/python-library-documentation/</a>. This website documents the Python programming language library for the GrovePi.</li><li class="listitem" style="list-style-type: disc"><span class="strong"><strong>Python</strong></span>: <a class="ulink" href="https://www.python.org/">https://www.python.org/</a>. The Python website has complete reference<a class="indexterm" id="id595"/> documentation for the Python language.</li><li class="listitem" style="list-style-type: disc"><span class="strong"><strong>GrovePi Windows IoT: LED Blink</strong></span>: <a class="ulink" href="https://www.hackster.io/9381/grove-pi-windows-iot-getting-started-94bf38">https://www.hackster.io/9381/grove-pi-windows-iot-getting-started-94bf38</a>. A <a class="indexterm" id="id596"/>blinking LED example for Windows 10 and the GrovePi.</li><li class="listitem" style="list-style-type: disc"><span class="strong"><strong>Dexter Industries</strong></span>: <a class="ulink" href="https://en.wikipedia.org/wiki/Dexter_Industries">https://en.wikipedia.org/wiki/Dexter_Industries</a>. Dexter Industries<a class="indexterm" id="id597"/> is best known for their robotic sensors for the Raspberry Pi.</li><li class="listitem" style="list-style-type: disc"><span class="strong"><strong>Seeed Studio</strong></span>: <a class="ulink" href="http://www.seeedstudio.com/depot/">http://www.seeedstudio.com/depot/</a>. Seeed is a hardware <a class="indexterm" id="id598"/>innovation platform developed in Shenzhen, China.</li><li class="listitem" style="list-style-type: disc"><span class="strong"><strong>GitHub</strong></span>: <a class="ulink" href="http://github.com">http://github.com</a>. GitHub is a collaborative repository for open<a class="indexterm" id="id599"/> source software.</li><li class="listitem" style="list-style-type: disc"><span class="strong"><strong>i2cdetect</strong></span>: <a class="ulink" href="http://manpages.debian.org/cgi-bin/man.cgi?query=i2cdetect">http://manpages.debian.org/cgi-bin/man.cgi?query=i2cdetect</a>. The Debian man page for i2cdetect documents<a class="indexterm" id="id600"/> the command and its options.</li></ul></div></div></div>
<div class="section" title="Controlling devices from a web page"><div class="titlepage"><div><div><h1 class="title"><a id="ch06lvl1sec58"/>Controlling devices from a web page</h1></div></div></div><p>This <a class="indexterm" id="id601"/>recipe uses a simple Python script to show how devices attached to the Raspberry Pi can be controlled from a web page. </p><p>The <code class="literal">web.py</code> programming framework for Python can be used to serve web pages from scripts that are written in the Python programming language. This recipe features a Python script that serves a web page displaying the current state of a GrovePi LED and enables a button on the web page to turn a GrovePi LED on and off. It is a simple example, but is an excellent foundation for simple Internet of Things projects.</p><p>After completing this recipe, you will have installed and applied the <code class="literal">web.py</code> Python framework to serve a web page that can be used to turn an LED on and off.</p><div class="section" title="Getting ready"><div class="titlepage"><div><div><h2 class="title"><a id="ch06lvl2sec214"/>Getting ready</h2></div></div></div><p>The following are the ingredients for controlling devices from a web page:</p><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc">An initial setup or basic networking setup for the Raspberry Pi that already has the GrovePi interfaces and drivers installed (see the previous recipe, <span class="emphasis"><em>Installing the GrovePi</em></span>, for instructions). You have also logged in as the user <code class="literal">pi</code> (see the recipes in <a class="link" href="ch01.html" title="Chapter 1. Installation and Setup">Chapter 1</a>, <span class="emphasis"><em>Installation and Setup</em></span>, for how to boot and log in and the recipes in <a class="link" href="ch02.html" title="Chapter 2. Administration">Chapter 2</a>, <span class="emphasis"><em>Administration</em></span>, for how to log in remotely).</li><li class="listitem" style="list-style-type: disc">A GrovePi should already be attached to the Raspberry Pi.</li><li class="listitem" style="list-style-type: disc">A Grove LED should be attached to port <code class="literal">D2</code> of the GrovePi.</li></ul></div><p>This recipe does not require the desktop GUI and could either be run from the text-based console or from within an <code class="literal">LXTerminal</code> application.</p><p>If the Raspberry Pi's secure shell server is running, this recipe can be completed remotely using a secure shell client.</p></div><div class="section" title="How to do it..."><div class="titlepage"><div><div><h2 class="title"><a id="ch06lvl2sec215"/>How to do it...</h2></div></div></div><p>The steps to controlling devices from a web page are:</p><div class="orderedlist"><ol class="orderedlist arabic"><li class="listitem">Log in to the Raspberry Pi either directly or remotely.</li><li class="listitem">Use the <code class="literal">apt-get install </code>command to install the <code class="literal">web.py</code> web framework for Python.<div class="informalexample"><pre class="programlisting">pi@raspberrypi ~ $ <span class="strong"><strong>apt-get install –y python-webpy</strong></span>
Reading package lists... Done
Building dependency tree       
Reading state information... Done
The following extra packages will be installed:
  libpq5 python-cheetah python-egenix-mxdatetime python-egenix-mxtools python-flup python-psycopg2 python2.6
  python2.6-minimal
Suggested packages:
  python-markdown python-pygments python-memcache python-egenix-mxdatetime-dbg python-egenix-mxdatetime-doc
  python-egenix-mxtools-dbg python-egenix-mxtools-doc python-psycopg2-doc python2.6-doc binfmt-support
The following NEW packages will be installed:
  libpq5 python-cheetah python-egenix-mxdatetime python-egenix-mxtools python-flup python-psycopg2 python-webpy
  python2.6 python2.6-minimal
0 upgraded, 9 newly installed, 0 to remove and 39 not upgraded.
Need to get 923 kB/4,773 kB of archives.
After this operation, 16.5 MB of additional disk space will be used.

...</pre></div></li><li class="listitem">After <code class="literal">web.py</code> is installed, use the <code class="literal">cat</code> command to create a Python script that serves<a class="indexterm" id="id602"/> a web page used to turn the Grove LED on and off.<div class="informalexample"><pre class="programlisting">pi@raspberrypi ~ $ <span class="strong"><strong>cat &lt;&lt;EOD &gt;ledpage.py

import grovepi
import web

LED  = 2
URLS = ( '/(.*)', 'request_handler' )


class request_handler:

  def GET( self, url_match ):

    web.header( 'Content-Type', 'text/html; charset=utf-8' )

    if url_match == 'on':
      grovepi.digitalWrite( LED, 1 )
      return html_page( 'off' )

    if url_match == 'off':
      grovepi.digitalWrite( LED, 0 )
      return html_page( 'on' )

    return html_page( 'on' )


def html_page( state ):
  form  = '&lt;form action="/' + state + '"&gt;'
  form +=   '&lt;input type="submit" value="' + state + '"&gt;'
  form += '&lt;/form&gt;'
  return '&lt;html&gt;&lt;body&gt;' + form + '&lt;/body&gt;&lt;/html&gt;'


if __name__ == '__main__':
  grovepi.pinMode( LED, 'output' )
  app = web.application( URLS, globals() )
  app.run()
    
EOD</strong></span>

pi@raspberrypi ~ $</pre></div></li><li class="listitem">Use the <code class="literal">python</code> command to start serving the web page. <div class="informalexample"><pre class="programlisting">pi@raspberrypi ~ $ <span class="strong"><strong>python ledpage.py</strong></span>
http://0.0.0.0:8080/</pre></div></li><li class="listitem">From<a class="indexterm" id="id603"/> a web browser, you will be able to see the web page. Use the IP address of your Raspberry Pi plus the port <code class="literal">8080</code> to access the web page (for example, <code class="literal">http://192.168.2.19:8080</code>).</li><li class="listitem">The web page displays one button. If the LED is off, the button is labeled <code class="literal">on</code>. If the LED is on, the button is labeled <code class="literal">off</code>. Clicking the button sets the LED as stated by the button's label.</li><li class="listitem">Use <span class="emphasis"><em>Ctrl+C</em></span> to stop serving the web page.</li></ol></div></div><div class="section" title="How it works..."><div class="titlepage"><div><div><h2 class="title"><a id="ch06lvl2sec216"/>How it works...</h2></div></div></div><p>After logging in to the Raspberry Pi, the recipe first uses the <code class="literal">apt-get install</code> command to install the <code class="literal">python-webpy</code> software package. This software package contains the <code class="literal">web.py</code> web framework for Python.</p><p>The <code class="literal">web.py</code> web framework is a toolkit for creating web servers that use the Python programming language to create web pages. The Python script in this recipe also uses the GrovePi API introduced in the previous recipe, <span class="emphasis"><em>Installing the GrovePi</em></span>.</p><div class="section" title="Create and run the ledpage website"><div class="titlepage"><div><div><h3 class="title"><a id="ch06lvl3sec81"/>Create and run the ledpage website</h3></div></div></div><p>The <code class="literal">cat</code> command<a class="indexterm" id="id604"/> is used to create a new script, <code class="literal">ledpage.py</code>. The lines immediately following the <code class="literal">cat</code> command up to the end of the data marker (<code class="literal">&lt;&lt;EOD</code>) are copied to the new script (<code class="literal">&gt;ledpage.py</code>).</p><p>This<a class="indexterm" id="id605"/> new script will serve a web page that can be used to control a GrovePi LED. In the example script, the LED is attached to port <code class="literal">D2</code> of the GrovePi.</p><p>The <code class="literal">ledpage.py</code> script is run using the <code class="literal">python</code> command. When the script is run, a web server is started listening on port <code class="literal">8080</code> of every network interface attached to the Raspberry Pi (<code class="literal">http://0.0.0.0</code>).</p><p>The output of the web server can be viewed in a web browser. Open a browser and browse <a class="indexterm" id="id606"/>to <code class="literal">http://ipaddress:8080</code>, the URL of the running <code class="literal">ledpage.py</code> script. Replace the <code class="literal">ipaddress</code> in the URL with the IP address of your <a class="indexterm" id="id607"/>Raspberry Pi (instructions for determining the IP address can be found in <a class="link" href="ch02.html" title="Chapter 2. Administration">Chapter 2</a>, <span class="emphasis"><em>Administration</em></span>).</p></div><div class="section" title="Action URLs"><div class="titlepage"><div><div><h3 class="title"><a id="ch06lvl3sec82"/>Action URLs</h3></div></div></div><p>The default view (<code class="literal">http://ipaddress:8080/</code>) shows a single button that can be used to change the<a class="indexterm" id="id608"/> current state of the LED. The button is labeled <code class="literal">on</code> when the LED is off and it's labeled <code class="literal">off</code> when the LED is on. When clicked, the button turns the LED to the labeled state. </p><p>When the button is labeled <code class="literal">on</code>, clicking the button sends the browser to the URL <code class="literal">http://ipaddress:8080/on</code>; and when the button is labeled <code class="literal">off</code>, clicking the button sends the browser to the URL <code class="literal">http://ipaddress:8080/off</code>.</p><p>Browsing to the <code class="literal">/on</code> URL turns the light on and displays an <code class="literal">off</code> button. Browsing to the <code class="literal">/off</code> URL turns the light off and displays an <code class="literal">on</code> button. The action URLs, <code class="literal">/on</code> and <code class="literal">/off</code>, are defined in <code class="literal">ledpage.py</code>.</p></div><div class="section" title="Use Ctrl+C to quit"><div class="titlepage"><div><div><h3 class="title"><a id="ch06lvl3sec83"/>Use Ctrl+C to quit</h3></div></div></div><p>The <a class="indexterm" id="id609"/>Python web server continues to run until <span class="emphasis"><em>Ctrl+C</em></span> is pressed.</p></div></div><div class="section" title="There's more…"><div class="titlepage"><div><div><h2 class="title"><a id="ch06lvl2sec217"/>There's more…</h2></div></div></div><p>The <code class="literal">ledpage.py</code> script is a simple yet complete example of a web service that controls a device attached to the Raspberry Pi. The script can be broken into four parts: initialization, the <code class="literal">request handler</code> class, the <code class="literal">html_page</code> function, and the <code class="literal">main</code> loop.</p><div class="section" title="Initialization"><div class="titlepage"><div><div><h3 class="title"><a id="ch06lvl3sec84"/>Initialization</h3></div></div></div><p>The<a class="indexterm" id="id610"/> script begins with two <code class="literal">import</code> statements: one for the <code class="literal">grovepi</code> API and one for the <code class="literal">web</code> API. The <code class="literal">web</code> API is used to set up the web server and the <code class="literal">grovepi</code> API is used to connect to the Grove LED.</p><p>After the <code class="literal">import</code> statements, two constants are defined: <code class="literal">LED</code> and <code class="literal">URLS</code>. The <code class="literal">LED</code> constant defines which digital output port will be used on the GrovePi (<code class="literal">2</code>), and the <code class="literal">URLS</code> constant defines a mapping between a regular expression (<code class="literal">/(.*)</code>) and a request handler (<code class="literal">request_handler</code>).</p><p>The defined regular expression (<code class="literal">/(.*)</code>) matches all URLs. The matched part of the URL, anything after the slash (<code class="literal">(.*)</code>), will be passed to the <code class="literal">request_handler</code> (as <code class="literal">url_match</code>).</p></div><div class="section" title="The request_handler class"><div class="titlepage"><div><div><h3 class="title"><a id="ch06lvl3sec85"/>The request_handler class</h3></div></div></div><p>The <code class="literal">request_handler</code> class defines how HTTP requests are handled by the web server. In this <a class="indexterm" id="id611"/>script, only the <code class="literal">GET</code> method of the <span class="strong"><strong>HyperText Transfer Protocol</strong></span> (<span class="strong"><strong>HTTP</strong></span>) is implemented.</p><p>When <a class="indexterm" id="id612"/>you browse to the Python web server's URL (<code class="literal">http://ipaddress:8080</code>), a <code class="literal">GET</code> method is received by the web server and the <code class="literal">GET</code> method (<code class="literal">GET ( self, url_match )</code>) of the <code class="literal">request_handler</code> class is called.</p><p>The <code class="literal">GET</code> method uses the <code class="literal">web</code> API function <code class="literal">header</code> to set the <code class="literal">Content-type</code> of the HTTP response to be <code class="literal">text/html</code> and the character set encoding to be UTF-8 (<code class="literal">charset=utf-8</code>). The <code class="literal">Content-type</code> response header tells the browser what type of web content (web page, plain text, image, audio, video, and so on) is located at this URL. The response for this URL is a web page (<code class="literal">text/html</code>) that uses the UTF-8 character set.</p><p>Then, the <code class="literal">GET</code> method checks the value of the <code class="literal">url_match</code> parameter.</p><p>When the <code class="literal">url_match</code> is <code class="literal">on</code> (<code class="literal">http://ipaddress:8080/on</code>), the <code class="literal">grovepi</code> API function <code class="literal">digitalWrite</code> is used to first turn the <code class="literal">LED</code> on (<code class="literal">1</code>) and then <code class="literal">return</code> an <code class="literal">html_page</code> to the browser with an <code class="literal">off</code> button.</p><p>When the <code class="literal">url_match</code> is <code class="literal">off</code>
<span class="strong"><strong> </strong></span>(<code class="literal">http://ipaddress:8080/off</code>), the <code class="literal">digitalWrite</code> function is used to turn the <code class="literal">LED</code> off (<code class="literal">0</code>) and an <code class="literal">html_page</code> is <code class="literal">returned</code> to the browser with an <code class="literal">on</code> button.</p><p>If the matched URL (<code class="literal">url_match</code>) is neither <code class="literal">on</code> nor <code class="literal">off</code>, an <code class="literal">html_page</code> with an <code class="literal">on</code> button is <code class="literal">returned</code> to the browser. The state of the <code class="literal">LED</code> is not changed.</p></div><div class="section" title="The html_page function"><div class="titlepage"><div><div><h3 class="title"><a id="ch06lvl3sec86"/>The html_page function</h3></div></div></div><p>The <code class="literal">html_page</code> function (<code class="literal">html_page( state )</code>) renders the HTML that will be sent to the<a class="indexterm" id="id613"/> browser to display the web page.</p><p>The function has one parameter, <code class="literal">state</code>, which is used to specify the label (<code class="literal">value</code>) for the button (<code class="literal">&lt;input type="submit"&gt;</code>) and the <code class="literal">action</code> for the HTML <code class="literal">&lt;form&gt;</code> tag.</p><p>A string variable, <code class="literal">form</code>, is created to build the HTML <code class="literal">&lt;form&gt;</code> part of the web page. </p><p>The <code class="literal">action</code> attribute of the HTML <code class="literal">&lt;form&gt;</code> tag is set either to <code class="literal">/on</code> or <code class="literal">/off</code> depending on the value of the <code class="literal">state</code> parameter. The <code class="literal">action</code> attribute defines the URL where the browser will be sent when the HTML <code class="literal">&lt;form&gt;</code> is submitted (that is, when the button is pressed).</p><p>The <code class="literal">value</code> attribute (the label) of the <code class="literal">&lt;input type="submit"&gt;</code> tag (the button) is set either to <code class="literal">on</code> or to <code class="literal">off</code> depending on the value of the <code class="literal">state</code> parameter. When clicked, the tag (the button) will submit the HTML <code class="literal">&lt;form&gt;</code>. </p><p>Once the HTML <code class="literal">&lt;form&gt;</code> tag is completely defined including its end tag <code class="literal">&lt;/form&gt;</code>, it is wrapped in a <code class="literal">&lt;body&gt;</code> tag and an <code class="literal">&lt;html&gt;</code> tag to complete the minimal HTML web page.</p><p>The complete <a class="indexterm" id="id614"/>web page is returned to the <code class="literal">request_handler</code>, which sends the web page to the browser.</p></div><div class="section" title="The main loop"><div class="titlepage"><div><div><h3 class="title"><a id="ch06lvl3sec87"/>The main loop</h3></div></div></div><p>The main loop begins <code class="literal">if __name__ == '__main__':</code> and is called once after the <code class="literal">html_page</code> function and the <code class="literal">request_handler</code> have been defined.</p><p>The main <a class="indexterm" id="id615"/>loop first uses the <code class="literal">grovepi</code> API to initialize the <code class="literal">LED</code> to the <code class="literal">output pinMode</code>. The GrovePi digital ports can either be used to listen for signals or to trigger them. For this script, the <code class="literal">LED</code> port is configured for <code class="literal">output</code>.</p><p>After the <code class="literal">LED</code> port is configured, the <code class="literal">web</code> API's <code class="literal">application</code> function is used to create a web application that listens for the specified <code class="literal">URLS</code> using Python's default global variables (<code class="literal">globals()</code>) as the application context. </p><p>The first parameter to the <code class="literal">web.application</code> function, <code class="literal">URLS</code>, defines the mapping between URL request patterns (regular expressions) and their request handlers (Python classes). The second parameter defines the application context (in this case, it is the <code class="literal">global</code> context). The <code class="literal">web.application</code> function returns a web application object (<code class="literal">app</code>) that encapsulates the HTTP protocol and manages the web server.</p><p>Finally, the web server is started using the <code class="literal">run</code> function of the newly created web application object (<code class="literal">app</code>). </p><p>The web application listens by default on port <code class="literal">8080</code> of all the network interfaces attached to the Raspberry Pi (<code class="literal">0.0.0.0</code>). The <code class="literal">app.run</code> function continues until it is interrupted (by <span class="emphasis"><em>Ctrl+C</em></span>).</p><p>More information on using <code class="literal">web.py</code> to create web applications using the Python scripting language <a class="indexterm" id="id616"/>can be found on the <code class="literal">web.py</code> website (<a class="ulink" href="http://webpy.org/">http://webpy.org/</a>).</p></div></div><div class="section" title="See also"><div class="titlepage"><div><div><h2 class="title"><a id="ch06lvl2sec218"/>See also</h2></div></div></div><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc"><span class="strong"><strong>web.py</strong></span> (<a class="ulink" href="http://webpy.org/">http://webpy.org/</a>): This web framework was originally developed at <a class="indexterm" id="id617"/>reddit.com where it grew to serve millions of page views per day.</li><li class="listitem" style="list-style-type: disc"><span class="strong"><strong>web.py – Tutorial </strong></span>(<a class="ulink" href="http://webpy.org/docs/0.3/tutorial">http://webpy.org/docs/0.3/tutorial</a>): This is the root of the <code class="literal">web.py</code> tutorial.</li><li class="listitem" style="list-style-type: disc"><span class="strong"><strong>Regular Expression HOWTO </strong></span>(<a class="ulink" href="https://docs.python.org/2/howto/regex.html">https://docs.python.org/2/howto/regex.html</a>): This is an introductory <a class="indexterm" id="id618"/>tutorial to using regular expressions in Python.</li><li class="listitem" style="list-style-type: disc"><span class="strong"><strong>Hypertext Transfer Protocol </strong></span>(<a class="ulink" href="https://en.wikipedia.org/wiki/Hypertext_Transfer_Protocol">https://en.wikipedia.org/wiki/Hypertext_Transfer_Protocol</a>): This<a class="indexterm" id="id619"/> Wikipedia article is about the HTTP protocol.</li><li class="listitem" style="list-style-type: disc"><span class="strong"><strong>HTML </strong></span>(<a class="ulink" href="https://en.wikipedia.org/wiki/HTML">https://en.wikipedia.org/wiki/HTML</a>): This Wikipedia article <a class="indexterm" id="id620"/>describes the Hypertext Markup Language (HML) and<a class="indexterm" id="id621"/> its history.</li></ul></div></div></div>
<div class="section" title="Connecting to an IoT platform"><div class="titlepage"><div><div><h1 class="title"><a id="ch06lvl1sec59"/>Connecting to an IoT platform</h1></div></div></div><p>This recipe connects<a class="indexterm" id="id622"/> your Raspberry Pi to the SmartLiving (<a class="ulink" href="http://smartliving.io">http://smartliving.io</a>) Internet of Things (IoT) platform.</p><p>The<a class="indexterm" id="id623"/> SmartLiving IoT platform uses a web browser to configure rules that respond to sensors and/or activate IoT devices attached to your Raspberry Pi. The SmartLiving API includes drivers for the GrovePi from Dexter Industries. This recipe integrates your Raspberry Pi with the SmartLiving platform and uses it to control a GrovePi device attached to your Raspberry Pi.</p><p>After completing this recipe, you will be able to control Grove devices attached to your Raspberry Pi using the SmartLiving Internet of Things platform.</p><div class="section" title="Getting ready"><div class="titlepage"><div><div><h2 class="title"><a id="ch06lvl2sec219"/>Getting ready </h2></div></div></div><p>Ingredients:</p><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc">A Basic Networking setup for the Raspberry Pi that already has the GrovePi interfaces and drivers installed (see the previous recipe, <span class="emphasis"><em>Installing the GrovePi</em></span>, for instructions). You have also logged in as the user <code class="literal">pi</code> (see the recipes in <a class="link" href="ch01.html" title="Chapter 1. Installation and Setup">Chapter 1</a>, <span class="emphasis"><em>Installation and Setup</em></span> for how to boot and log in and the recipes in <a class="link" href="ch02.html" title="Chapter 2. Administration">Chapter 2</a>, <span class="emphasis"><em>Administration</em></span> for how to log in remotely).</li><li class="listitem" style="list-style-type: disc">The Raspberry Pi should be connected to the Internet.</li><li class="listitem" style="list-style-type: disc">A GrovePi should already be attached to the Raspberry Pi.</li><li class="listitem" style="list-style-type: disc">A Grove LED should be attached to port D2 of the GrovePi.</li></ul></div><p>This recipe does not require the desktop GUI and could either be run from the text-based console or from within an <code class="literal">LXTerminal</code>.</p><p>If the Raspberry Pi's Secure Shell server is running, this recipe can be completed remotely using a Secure Shell client.</p></div><div class="section" title="How to do it..."><div class="titlepage"><div><div><h2 class="title"><a id="ch06lvl2sec220"/>How to do it...</h2></div></div></div><p>The steps to controlling IoT devices from the SmartLiving platform are:</p><div class="orderedlist"><ol class="orderedlist arabic"><li class="listitem">First, create <a class="indexterm" id="id624"/>a free account and log in to the<a class="indexterm" id="id625"/> SmartLiving platform at <a class="ulink" href="http://beta.smartliving.io">http://beta.smartliving.io</a>.<div class="mediaobject"><img alt="How to do it..." src="graphics/B04745_06_06.jpg"/></div></li><li class="listitem">Click on the plus icon to create a new device.<div class="mediaobject"><img alt="How to do it..." src="graphics/B04745_06_07.jpg"/></div></li><li class="listitem">Select<a class="indexterm" id="id626"/> the device type Raspberry Pi and name the device (<span class="strong"><strong>MyGoldenPi</strong></span>). Click the <span class="strong"><strong>right arrow icon</strong></span> to continue.<div class="mediaobject"><img alt="How to do it..." src="graphics/B04745_06_08.jpg"/></div></li><li class="listitem">Select the Raspberry Pi by clicking on the Raspberry Pi logo.<div class="mediaobject"><img alt="How to do it..." src="graphics/B04745_06_09.jpg"/></div></li><li class="listitem">Select<a class="indexterm" id="id627"/> settings by clicking on the <span class="strong"><strong>gear icon</strong></span>.<div class="mediaobject"><img alt="How to do it..." src="graphics/B04745_06_10.jpg"/></div></li><li class="listitem">Now that your Raspberry Pi is registered and you can see the device ID, client ID, and client key, it's time to switch back to the Raspberry Pi.</li><li class="listitem">Log in to the Raspberry Pi (locally or remotely). </li><li class="listitem">Use the <code class="literal">git clone </code>command to download the All Things Talk (<code class="literal">allthingstalk</code>) client for Python (<code class="literal">raspberrypi-python-client</code>).<div class="informalexample"><pre class="programlisting">pi@raspberrypi ~ $ <span class="strong"><strong>git clone https://github.com/allthingstalk/raspberrypi-python-client</strong></span>

Cloning into 'raspberrypi-python-client'...
remote: Counting objects: 369, done.
Receiving objects: 100% (369/369), 85.93 KiB, done.
remote: Total 369 (delta 0), reused 0 (delta 0), pack-reused 369
Resolving deltas: 100% (240/240), done.

pi@raspberrypi ~ $ </pre></div></li><li class="listitem">Use<a class="indexterm" id="id628"/> the <code class="literal">cd</code> command to enter the client install directory, and then use the Bash script <code class="literal">setupGrovePi.sh </code>to install the client. <div class="informalexample"><pre class="programlisting">pi@raspberrypi ~ $ <span class="strong"><strong>cd raspberrypi-python-client</strong></span>

pi@raspberrypi ~/raspberyypi-python-client $ sudo bash setupGrovePi.sh

Reading package lists... Done
Building dependency tree       
Reading state information... Done
The following extra packages will be installed:
  python2.7-dev
The following NEW packages will be installed:
  python-dev python2.7-dev
0 upgraded, 2 newly installed, 0 to remove and 0 not upgraded.
Need to get 0 B/28.7 MB of archives.

...</pre></div></li><li class="listitem">Press the <span class="emphasis"><em>Enter</em></span> key in response to any and all installation prompts to accept the defaults.</li><li class="listitem">When the installation script is complete, use the <code class="literal">reboot</code> command to restart the Raspberry Pi.<div class="informalexample"><pre class="programlisting">...

Please restart to implement changes!
  _____  ______  _____ _______       _____ _______ 
 |  __ \|  ____|/ ____|__   __|/\   |  __ \__   __|
 | |__) | |__  | (___    | |  /  \  | |__) | | |   
 |  _  /|  __|  \___ \   | | / /\ \ |  _  /  | |   
 | | \ \| |____ ____) |  | |/ ____ \| | \ \  | |   
 |_|  \_\______|_____/   |_/_/    \_\_|  \_\ |_|   
 
Please restart to implement changes!
To Restart type sudo reboot

pi@raspberrypi ~/raspberrypi-python-client $ <span class="strong"><strong>sudo reboot</strong></span>
Broadcast message from root@raspberrypi (pts/0) (Mon Oct 12 17:07:11 2015):
The system is going down for reboot NOW!</pre></div></li><li class="listitem">Now that the All Things Talk (Smart Living) client has been installed, it's time to test the Internet of Things.</li><li class="listitem">Log back in to the Raspberry Pi (locally or remotely).</li><li class="listitem">Use the <code class="literal">cd</code> command to change to the directory with the Smart Living Python client, <code class="literal">raspberrypi-python-client</code>.<div class="informalexample"><pre class="programlisting">pi@raspberrypi ~ $ <span class="strong"><strong>cd raspberrypi-python-client</strong></span>

pi@raspberrypi ~/ raspberrypi-python-client $ </pre></div></li><li class="listitem">Use<a class="indexterm" id="id629"/> the <code class="literal">cat</code> command to create a Python script (<code class="literal">ledserver.py</code>) that connects a Grove LED on port D2 to the Smart Living platform. Make sure you replace the values of the three configuration parameters (<code class="literal">IOT.DeviceId</code>, <code class="literal">IOT.ClientId</code>, and <code class="literal">IO.ClientKey</code>) with the values from your Smart Living account (from step 6).<div class="informalexample"><pre class="programlisting">pi@raspberrypi ~/ raspberrypi-python-client $ <span class="strong"><strong>cat &lt;&lt;EOD &gt;ledserver.py

import grovepi
import ATT_IOT as IOT
import time

LED = 2

def on_message( id, value ):

    if id.endswith( str( LED ) ):

        value = value.lower()

        if value == "true":
            grovepi.digitalWrite( LED, 1 )

        if value == "false":
            grovepi.digitalWrite( LED, 0 )

    # ignore unkown ids and values                                                                                                                                               

if __name__ == '__main__':

  grovepi.pinMode( LED, 'output' )

  IOT.DeviceId   = "JKi92itLxuwZbLuuYXQug8I"
  IOT.ClientId   = "golden"
  IOT.ClientKey  = "jlsvtobazhs"

  IOT.on_message = on_message

  IOT.connect()
  IOT.addAsset( LED, "LED", "Light Emitting Diode", True, "boolean" )
  IOT.subscribe()

  while True:
      time.sleep( .1 )

EOD</strong></span>

pi@raspberrypi ~ $</pre></div></li><li class="listitem">Use the <code class="literal">python</code> command to run the newly created script.<div class="informalexample"><pre class="programlisting">pi@raspberrypi ~/ raspberrypi-python-client $ <span class="strong"><strong>python ledserver.py</strong></span>
connected with http server
HTTP PUT: /asset/JKi92itLxuwZbLuuYXQug8I2
HTTP HEADER: {'Auth-ClientId': 'golden', 'Content-type': 'application/json', 'Auth-ClientKey': 'jlsvtobazhs'}
HTTP BODY:{"name":"LED","description":"Light Emitting Diode", "style": "Undefined","is":"actuator","profile": {"type":"boolean" },"deviceId":"JKi92itLxuwZbLuuYXQug8I" }
(200, 'OK')
{"deviceId":"JKi92itLxuwZbLuuYXQug8I","id":"JKi92itLxuwZbLuuYXQug8I2","name":"LED","is":"actuator","description":"Light Emitting Diode","createdOn":"2015-10-13T00:36:01.742Z","createdBy":"555a3d487ae2530b385b2173","updatedOn":"2015-10-13T01:07:44.074Z","updatedBy":"555a3d487ae2530b385b2173","profile":{"type":"boolean"},"state":null,"style":"undefined","control":{"name":null,"widgetUrl":null}}
Connected to mqtt broker with result code 0
subscribing to: client/golden/in/device/JKi92itLxuwZbLuuYXQug8I/asset/+/command
(0, 1)
Subscribed to topic, receiving data from the cloud: qos=(0,)</pre></div></li><li class="listitem">In<a class="indexterm" id="id630"/> the browser, refresh the Smart Living device page. The Raspberry Pi device (<span class="strong"><strong>MyGoldenPi</strong></span>) now has a new device (<span class="strong"><strong>LED</strong></span>).<div class="mediaobject"><img alt="How to do it..." src="graphics/B04745_06_11.jpg"/></div></li><li class="listitem">Toggle the <span class="strong"><strong>boolean </strong></span>switch on the Smart Living web page and the Grove LED turns on and off while the running <code class="literal">ledserver.py</code> script prints additional status messages.<div class="informalexample"><pre class="programlisting">Incoming message - topic: client/golden/in/device/JKi92itLxuwZbLuuYXQug8I/asset/JKi92itLxuwZbLuuYXQug8I2/command, payload: true
Incoming message - topic: client/golden/in/device/JKi92itLxuwZbLuuYXQug8I/asset/JKi92itLxuwZbLuuYXQug8I2/command, payload: false</pre></div></li><li class="listitem">Press <span class="emphasis"><em>Ctrl+C</em></span> to stop the <code class="literal">ledserver.py</code> script.</li></ol></div></div><div class="section" title="How it works…"><div class="titlepage"><div><div><h2 class="title"><a id="ch06lvl2sec221"/>How it works…</h2></div></div></div><p>This <a class="indexterm" id="id631"/>recipe has three parts: registering a Raspberry Pi device with the Smart Living IoT platform, installing the Smart Living client API, and finally running a script that exchanges signals between the Smart Living platform and the Raspberry Pi.</p><div class="section" title="Register your Raspberry Pi with the IoT platform"><div class="titlepage"><div><div><h3 class="title"><a id="ch06lvl3sec88"/>Register your Raspberry Pi with the IoT platform </h3></div></div></div><p>The<a class="indexterm" id="id632"/> recipe begins by registering for a free <a class="indexterm" id="id633"/>account at <a class="ulink" href="http://beta.smartliving.io">http://beta.smartliving.io</a>. </p><p>After registering for an account, a new Raspberry Pi device interface (<span class="strong"><strong>MyGoldenPi</strong></span>) is created and the <span class="strong"><strong>Device id</strong></span>, <span class="strong"><strong>Client id</strong></span>, and <span class="strong"><strong>Client key</strong></span> for this device are displayed. These three configuration values are used later in this recipe to connect the Raspberry Pi to the Smart Living IoT platform.</p></div><div class="section" title="Install the IoT platform API"><div class="titlepage"><div><div><h3 class="title"><a id="ch06lvl3sec89"/>Install the IoT platform API</h3></div></div></div><p>The<a class="indexterm" id="id634"/> recipe continues by logging in to the Raspberry Pi. </p><p>The <code class="literal">git clone</code> command is used to download the All Things Talk client API for the Raspberry Pi (<code class="literal">allthingstalk/raspberrypi-python-client</code>) – the Python API that is used to communicate with the Smart Living IoT platform.</p><p>After the client API is downloaded, the <code class="literal">bash</code> command is used to run the <code class="literal">setGrovePi.sh</code> script from the client API directory (<code class="literal">raspberrypi-python-client</code>). The <code class="literal">setupGrovePi.sh</code> installation script installs additional software packages and Python libraries.</p></div><div class="section" title="Exchange signals with the IoT platform"><div class="titlepage"><div><div><h3 class="title"><a id="ch06lvl3sec90"/>Exchange signals with the IoT platform</h3></div></div></div><p>Once<a class="indexterm" id="id635"/> the Smart Living client API is installed, the <code class="literal">cat</code> command is used to create a short Python script (<code class="literal">ledserver.py</code>) that listens for signals from the Smart Living IoT platform.</p><p>The script is run from the <code class="literal">raspberrypi-python-client</code> directory using the <code class="literal">python</code> command. While the script is running, the Raspberry Pi is connected to the Smart Living IoT platform and receives signals from the IoT platform that turn the LED on and off. </p><p>The IoT signals are sent using the Raspberry Pi device page on the Smart Living website. The device page has an <span class="strong"><strong>actuator</strong></span> labeled <span class="strong"><strong>LED</strong></span>. By toggling the <span class="strong"><strong>false</strong></span> – <span class="strong"><strong>true</strong></span> switch under the <span class="strong"><strong>LED</strong></span> label, a signal is sent from Smart Living platform through the Internet of Things to the Raspberry Pi. A <span class="strong"><strong>false</strong></span> signal turns the LED off. A <span class="strong"><strong>true</strong></span> signal turns the LED on.</p><p>A local keyboard interrupt signal (pressing <span class="emphasis"><em>Ctrl+C</em></span> on the keyboard) stops the script.</p></div></div><div class="section" title="There's more…"><div class="titlepage"><div><div><h2 class="title"><a id="ch06lvl2sec222"/>There's more…</h2></div></div></div><p>The Python script, <code class="literal">ledserver.py</code>, is a simple demonstration of how a Raspberry Pi can be connected to an Internet of Things platform. The script listens for and responds to a binary signal sent from the Smart Living IoT platform. The signal sent from the IoT platform controls a device attached to the Raspberry Pi (an LED). </p><p>The script has three parts: initialization, the signal handler, and the main loop.</p><div class="section" title="Initialization"><div class="titlepage"><div><div><h3 class="title"><a id="ch06lvl3sec91"/>Initialization</h3></div></div></div><p>The <a class="indexterm" id="id636"/>script begins with three <code class="literal">import</code> statements: one for the GrovePi API (<code class="literal">grovepi</code>), one for the All Things Talk API (ATT_IOT), and one for the <code class="literal">time</code> API. The <code class="literal">time</code> API provides the <code class="literal">sleep</code> function; the ATT_IOT API is used to connect with the Smart Living IoT platform, and the <code class="literal">grovepi</code> API is used to connect to the Grove LED.</p><p>After the <code class="literal">import</code> statements, a single constant is defined, <span class="strong"><strong>LED</strong></span>, to represent the digital port that will be used on the GrovePi (2). </p></div><div class="section" title="The signal handler"><div class="titlepage"><div><div><h3 class="title"><a id="ch06lvl3sec92"/>The signal handler</h3></div></div></div><p>The <a class="indexterm" id="id637"/>signal handler function <code class="literal">on_message</code>
<span class="strong"><strong>( ID, value )</strong></span> defines the actions that are taken when signals (messages) are received from the IoT platform. </p><p>When the last character (<code class="literal">endswith</code>) of the message <span class="strong"><strong>id</strong></span> is equal to the registered asset ID of the LED (<code class="literal">str( LED )</code>), then the message applies to the <span class="strong"><strong>LED</strong></span> asset.</p><p>If the value of the message (converted to lowercase, <span class="strong"><strong>lower</strong></span>) is "<span class="strong"><strong>true</strong></span>", the LED will be turned on using the grovepi API (<code class="literal">digitalWrite( LED, 1 )</code>). When the value is "<span class="strong"><strong>false</strong></span>", the LED will be turned off (<code class="literal">digitalWrite( LED, 0 )</code>).</p></div><div class="section" title="The main loop"><div class="titlepage"><div><div><h3 class="title"><a id="ch06lvl3sec93"/>The main loop</h3></div></div></div><p>The<a class="indexterm" id="id638"/> main loop (<code class="literal">if __name__ == '__main__':</code>) begins by using the GrovePi API to set the pinmode of the LED to output.</p><p>The Smart Living client API (IOT) is configured using the <span class="strong"><strong>DeviceId</strong></span>, <span class="strong"><strong>ClientId</strong></span>, and <span class="strong"><strong>ClientKey</strong></span> configuration parameters. They are set to the values displayed earlier, during the Smart Living registration. The IOT signal handler parameter, <code class="literal">on_message</code>
<span class="strong"><strong>,</strong></span> is set to the signal handling function, <code class="literal">on_message</code>. </p><p>Now that the client API (IOT) is configured, the Raspberry Pi is ready to <code class="literal">connect</code> to the Smart Living IoT platform, register a new device asset (<code class="literal">addAsset</code>), and subscribe to messages coming from the IoT platform. </p><p>The <code class="literal">IOT.connect</code> method establishes a connection to the Smart Living IoT platform using the previously specified <span class="strong"><strong>DeviceId</strong></span>, <span class="strong"><strong>ClientId</strong></span>, and <span class="strong"><strong>ClientKey</strong></span>. </p><p>With the connection established, the Raspberry Pi lets the IoT platform know (<code class="literal">addAsset</code>) that there is a binary (<span class="strong"><strong>"boolean"</strong></span>) output (<span class="strong"><strong>True</strong></span>) device attached to port D2 (<span class="strong"><strong>LED</strong></span>). The output device is labeled <span class="strong"><strong>"LED"</strong></span> and has a short description, <span class="strong"><strong>"Light Emitting Diode"</strong></span>.</p><p>The <code class="literal">IOT.subscribe</code> method lets the Smart Living IoT platform know that the Raspberry Pi is ready to receive signals (messages) from the platform. </p><p>The <code class="literal">on_message</code> function was previously defined as the signal handler. So, when a new signal (message) arrives for the Raspberry Pi, the <code class="literal">on_message</code> function receives the signal and acts upon its <span class="strong"><strong>id</strong></span> and <span class="strong"><strong>value</strong></span>.</p><p>When a <span class="strong"><strong>"true"</strong></span> signal is received, the LED is turned on. When a <span class="strong"><strong>"false"</strong></span> signal is received, the LED is turned off.</p></div><div class="section" title="IoT Rules"><div class="titlepage"><div><div><h3 class="title"><a id="ch06lvl3sec94"/>IoT Rules</h3></div></div></div><p>Although this recipe does show how the Raspberry Pi can connect to and exchange signals <a class="indexterm" id="id639"/>with the Smart Living IoT platform, it does not show how to create new IoT Rules. </p><p>The <a class="indexterm" id="id640"/>Smart Living website (<a class="ulink" href="http://smartliving.io">http://smartliving.io</a>) has a number of examples of how IoT Rules can be used to react to and control the Raspberry Pi:</p><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc">Detect movement – light an LED when a sensor detects movement</li><li class="listitem" style="list-style-type: disc">Unplugged smartphone – vibrate when a phone is removed from its charger</li><li class="listitem" style="list-style-type: disc">Smart doorbell – the doorbell rings your smartphone</li><li class="listitem" style="list-style-type: disc">Light sensor – display light levels in a remote room on your smartphone</li><li class="listitem" style="list-style-type: disc">Smart shop window – use a QR code to control the light in a window</li><li class="listitem" style="list-style-type: disc">Visit the Smart Living website for detailed instructions and a complete reference to using the Smart Living IoT platform with the Raspberry Pi and other devices.</li></ul></div></div></div><div class="section" title="See also"><div class="titlepage"><div><div><h2 class="title"><a id="ch06lvl2sec223"/>See also</h2></div></div></div><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc"><span class="strong"><strong>SmartLiving </strong></span>(<a class="ulink" href="http://www.smartliving.io/">http://www.smartliving.io/</a>): Use the Maker link to sign <a class="indexterm" id="id641"/>up for a Smart Living account.</li><li class="listitem" style="list-style-type: disc"><span class="strong"><strong>All Things Talk </strong></span>(<a class="ulink" href="http://allthingstalk.com/">http://allthingstalk.com/</a>): The All Things Talk website<a class="indexterm" id="id642"/> has more details about the home and business versions of their Internet of Things platform.</li><li class="listitem" style="list-style-type: disc"><span class="strong"><strong>Raspberry Pi kit </strong></span>(<a class="ulink" href="http://docs.smartliving.io/kits/linux-raspberry-pi/stepbystep/">http://docs.smartliving.io/kits/linux-raspberry-pi/stepbystep/</a>): This tutorial is a guide for connecting your <a class="indexterm" id="id643"/>Raspberry Pi to Smart Living.</li><li class="listitem" style="list-style-type: disc"><span class="strong"><strong>Raspberry Pi kit Experiments Guide </strong></span>(<a class="ulink" href="http://docs.smartliving.io/kits/linux-raspberry-pi/experiments/">http://docs.smartliving.io/kits/linux-raspberry-pi/experiments/</a>): There <a class="indexterm" id="id644"/>are five experiments on this website to get you started with the IoT.</li></ul></div></div></div>
<div class="section" title="Creating an IoT gateway"><div class="titlepage"><div><div><h1 class="title"><a id="ch06lvl1sec60"/>Creating an IoT gateway</h1></div></div></div><p>This <a class="indexterm" id="id645"/>recipe turns your Raspberry Pi into an IoT gateway using<a class="indexterm" id="id646"/> The ThingBox (<a class="ulink" href="http://thethingbox.io/">http://thethingbox.io/</a>) powered by Node-RED (<a class="ulink" href="http://nodered.org/">http://nodered.org/</a>).</p><p>The <a class="indexterm" id="id647"/>ThingBox is a Raspbian-based operating system distribution for wiring together hardware devices, APIs, and online services in new and interesting ways. It comes preinstalled with the Node-RED visual tool for wiring the Internet of Things.</p><p>In this recipe, The ThingBox is deployed and a new flow is created that lights an LED attached to the Raspberry Pi while a pushbutton is pressed. This is a very simple example, but completely demonstrates how The ThingBox is used. At the end of the recipe, there is a list of additional nodes that could be used in your next project.</p><p>After completing this recipe, your Raspberry Pi will be an IoT gateway.</p><div class="section" title="Getting ready"><div class="titlepage"><div><div><h2 class="title"><a id="ch06lvl2sec224"/>Getting ready </h2></div></div></div><p>Ingredients:</p><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc">An Internet connection for downloading The ThingBox distribution</li><li class="listitem" style="list-style-type: disc">An SD card – 4 GB or greater (class 10 has the best performance)</li><li class="listitem" style="list-style-type: disc">A Raspberry Pi connected to the local network</li></ul></div><p>This recipe only requires the desktop GUI to set up a wireless network.</p><p>Once the Raspberry Pi is running and connected to the network, this recipe is completed from another computer using a web browser.</p></div><div class="section" title="How to do it..."><div class="titlepage"><div><div><h2 class="title"><a id="ch06lvl2sec225"/>How to do it...</h2></div></div></div><p>The steps to creating an IoT gateway from your Raspberry Pi are:</p><div class="orderedlist"><ol class="orderedlist arabic"><li class="listitem">Download<a class="indexterm" id="id648"/> the latest image file from The ThingBox website, <a class="ulink" href="http://thethingbox.io/#packagestable">http://thethingbox.io/#packagestable</a> (see the recipe <span class="emphasis"><em>Downloading new SD cards</em></span> in <a class="link" href="ch01.html" title="Chapter 1. Installation and Setup">Chapter 1</a>, <span class="emphasis"><em>Installation and Setup</em></span>).</li><li class="listitem">Write<a class="indexterm" id="id649"/> the image file to the SD card (see the appropriate disk utility recipe for your computer in <a class="link" href="ch01.html" title="Chapter 1. Installation and Setup">Chapter 1</a>, <span class="emphasis"><em>Installation and Setup</em></span>).</li><li class="listitem">Boot your Raspberry Pi using the updated SD card.</li><li class="listitem">If your Raspberry Pi uses a Wi-Fi adapter to connect to the local network, you will need to log in to the Raspberry Pi GUI once (username: <code class="literal">root</code>, password: <code class="literal">raspberry</code>) and use the Wi-Fi config utility to configure the wireless network adapter.</li><li class="listitem">After the Raspberry Pi has successfully booted and connected to the network (this might take a few seconds longer during the first boot), The ThingBox server running on your Raspberry Pi will be available at the local network address, <code class="literal">http://thethingbox.local/</code>.<div class="mediaobject"><img alt="How to do it..." src="graphics/B04745_06_12.jpg"/></div></li><li class="listitem">If you click the colored square on the left side of the <span class="strong"><strong>Go</strong></span> node at the beginning of the default <span class="strong"><strong>Flow</strong></span>, the message <span class="strong"><strong>Hello!</strong></span> is displayed in the <span class="strong"><strong>debug</strong></span> tab.</li><li class="listitem">Click the <span class="strong"><strong>+</strong></span> tab on the far right side of the center panel (opposite the <span class="strong"><strong>Flow</strong></span> tab) to create a new flow.</li><li class="listitem">Add an <code class="literal">rpi-gpio</code> in node to the flow by dragging an in node from the toolbox on the left and dropping it on the flow diagram in the center.</li><li class="listitem">Add<a class="indexterm" id="id650"/> an <code class="literal">rpi-gpio</code> out node to the flow by dragging and dropping the out node from the toolbox.</li><li class="listitem">Connect the two nodes by dragging the output connector of the <span class="strong"><strong>rpi-gpio</strong></span> in node to the input connector of the <span class="strong"><strong>rpi-gpio</strong></span> out node.<div class="mediaobject"><img alt="How to do it..." src="graphics/B04745_06_13.jpg"/></div></li><li class="listitem">Now the<a class="indexterm" id="id651"/> basic flow has been set up, it's time to configure the nodes. The red triangle and blue circle badges on the input and output nodes indicate the configuration is not yet complete.</li><li class="listitem">Configure the <code class="literal">Pushbutton</code> node. Double-click on the <code class="literal">rpi-gpio</code> in node. Change the <span class="strong"><strong>GPIO Pin</strong></span> to <span class="strong"><strong>16 – GPIO4 – BCM23</strong></span>. Change the <span class="strong"><strong>Resistor</strong></span> to <span class="strong"><strong>pullup</strong></span>. Change the <span class="strong"><strong>Name</strong></span> parameter to <code class="literal">Pushbutton</code>. Click on the <span class="strong"><strong>Ok</strong></span> button.<div class="mediaobject"><img alt="How to do it..." src="graphics/B04745_06_14.jpg"/></div></li><li class="listitem">Configure <a class="indexterm" id="id652"/>the LED node. Double-click on the <code class="literal">rpi-gpio</code> out node. Change the <span class="strong"><strong>GPIO Pin</strong></span> to <span class="strong"><strong>18 – GPIO5 – BCM24</strong></span>. Change the <span class="strong"><strong>Type</strong></span> to <span class="strong"><strong>Digital output</strong></span>. Change the <span class="strong"><strong>Name</strong></span> to <span class="strong"><strong>LED</strong></span>. Click on the <span class="strong"><strong>Ok</strong></span> button.<div class="mediaobject"><img alt="How to do it..." src="graphics/B04745_06_15.jpg"/></div></li><li class="listitem">Rename the flow diagram. Double-click on the name, <span class="strong"><strong>Sheet 1</strong></span>. Change the <span class="strong"><strong>Name</strong></span> of the flow diagram to <span class="strong"><strong>Pushbutton LED</strong></span>. Click on the Ok button.<div class="mediaobject"><img alt="How to do it..." src="graphics/B04745_06_16.jpg"/></div></li><li class="listitem">Start<a class="indexterm" id="id653"/> the flow by clicking on the red <span class="strong"><strong>Activate</strong></span> button. Wait until the <span class="strong"><strong>Successfully Deployed</strong></span> message appears.<div class="mediaobject"><img alt="How to do it..." src="graphics/B04745_06_17.jpg"/></div></li><li class="listitem">The <span class="strong"><strong>Pushbutton LED</strong></span> flow has started!</li><li class="listitem">Press and hold the <span class="strong"><strong>Pushbutton</strong></span>. The LED glows. Release the <span class="strong"><strong>Pushbutton</strong></span> and the <span class="strong"><strong>LED</strong></span> stops glowing.<div class="mediaobject"><img alt="How to do it..." src="graphics/B04745_06_18.jpg"/></div></li><li class="listitem">Notice <a class="indexterm" id="id654"/>that the values next to the green status indicators under the input and output nodes change from <span class="strong"><strong>0</strong></span> to <span class="strong"><strong>1</strong></span> whenever the pushbutton is pressed.</li><li class="listitem">The ThingBox IoT gateway is responding to a hardware signal by sending a hardware signal. Your IoT gateway works!</li></ol></div></div><div class="section" title="How it works"><div class="titlepage"><div><div><h2 class="title"><a id="ch06lvl2sec226"/>How it works</h2></div></div></div><p>This recipe has two main parts: </p><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc">Creating the bootable SD card for The ThingBox IoT gateway</li><li class="listitem" style="list-style-type: disc">Creating the <span class="strong"><strong>Pushbutton LED</strong></span> flow in the running IoT gateway </li></ul></div><p>You may also need to configure your Raspberry Pi's wireless networking. </p><p>And you may want to run the example flow when The ThingBox is ready.</p><div class="section" title="Creating the bootable SD card"><div class="titlepage"><div><div><h3 class="title"><a id="ch06lvl3sec95"/>Creating the bootable SD card</h3></div></div></div><p>The <a class="indexterm" id="id655"/>current ThingBox bootable disk image is<a class="indexterm" id="id656"/> available from The ThingBox website (<a class="ulink" href="http://thethingbox.io/#packagestable">http://thethingbox.io/#packagestable</a>). After the image is downloaded, it needs to be written to an SD card that has at least 4 GB of disk space. Class 10 SD cards have the best performance. Instructions for creating a bootable SD card can be found in <a class="link" href="ch01.html" title="Chapter 1. Installation and Setup">Chapter 1</a>, <span class="emphasis"><em>Installation and Setup</em></span>.</p><p>Once the ThingBox image is written to the SD card, use it to boot the Raspberry Pi. The initial boot takes longer as the filesystem is expanded to fill the whole SD card. After the initial boot, subsequent boots will be much faster.</p></div><div class="section" title="Configuring wireless networking"><div class="titlepage"><div><div><h3 class="title"><a id="ch06lvl3sec96"/>Configuring wireless networking</h3></div></div></div><p>If your <a class="indexterm" id="id657"/>Raspberry Pi depends on a Wi-Fi adapter for networking, you will need to log in to the Raspberry Pi desktop after the initial boot and configure wireless networking. Use the username <code class="literal">root</code> and the default password <code class="literal">raspberry</code>. </p><p>The wireless networking configuration application is available from the <span class="strong"><strong>Raspberry Pi Menu &gt; Preferences &gt; WiFi Configuration</strong></span> menu. </p><p>Once the WiFi Configuration application is running, click <span class="strong"><strong>Scan</strong></span> to display the available networks. Double-click on your network's <span class="strong"><strong>SSID</strong></span> to enter your network's <span class="strong"><strong>Private Security Key</strong></span> (<span class="strong"><strong>PSK</strong></span>) and then click <span class="strong"><strong>Add</strong></span> to add this device to the list of known Wi-Fi interfaces.</p><p>Close the <span class="strong"><strong>Scan Results</strong></span> window and you can observe connection status changes in the <span class="strong"><strong>WiFi Configuration</strong></span> window. After adding the <span class="strong"><strong>SSID</strong></span> and <span class="strong"><strong>PSK</strong></span> for your network, the Raspberry Pi will continue to use that configuration by default at each boot.</p><p>The Wi-Fi configuration can also be set from the ThingBox user interface. Choose <span class="strong"><strong>Settings</strong></span> from the configuration menu at the top-right of the user interface (the three bars next to the <span class="strong"><strong>Activate</strong></span> button).</p></div><div class="section" title="The ThingBox is ready"><div class="titlepage"><div><div><h3 class="title"><a id="ch06lvl3sec97"/>The ThingBox is ready</h3></div></div></div><p>After the Raspberry Pi boots, it broadcasts its name, <code class="literal">thethingbox</code>, to the local multicast DNS <a class="indexterm" id="id658"/>server. In a few seconds, after the mDNS server <a class="indexterm" id="id659"/>updates, the ThingBox user interface is accessible at the URL <code class="literal">http://thethingbox.local/</code>. </p><p>There is no need for additional network configuration. However, the device name and other network parameters can be changed from the configuration menu at the top-right of the user interface.</p></div><div class="section" title="Running the example flow"><div class="titlepage"><div><div><h3 class="title"><a id="ch06lvl3sec98"/>Running the example flow</h3></div></div></div><p>When the <a class="indexterm" id="id660"/>ThingBox is first accessed, it displays a default <span class="strong"><strong>Flow</strong></span> made up of three nodes: <span class="strong"><strong>Go</strong></span>, <span class="strong"><strong>Hello!</strong></span>, and <span class="strong"><strong>display</strong></span>.</p><p>Each node has configuration parameters that are set by double-clicking on the node. Nodes can also have multiple inputs and outputs, and can process more than one message.</p><p>The default <span class="strong"><strong>Flow</strong></span> is activated by clicking the colored square that is on the left side of the <span class="strong"><strong>Go</strong></span> node. Clicking the square sends a message (<code class="literal">msg</code>) to the <span class="strong"><strong>Hello!</strong></span> node. </p><p>The <span class="strong"><strong>Hello!</strong></span> node receives the message (<code class="literal">msg</code>) and sets the <code class="literal">payload</code> parameter of the message to "<code class="literal">Hello!</code>" and then sends the message on to the <span class="strong"><strong>display</strong></span> node. </p><p>The <span class="strong"><strong>display</strong></span> node outputs the value of the <code class="literal">msg.payload</code> parameter in the <span class="strong"><strong>debug</strong></span> tab of the right sidebar. </p><p>This<a class="indexterm" id="id661"/> completes the default <span class="strong"><strong>Flow</strong></span>.</p></div><div class="section" title="Go with the flow"><div class="titlepage"><div><div><h3 class="title"><a id="ch06lvl3sec99"/>Go with the flow</h3></div></div></div><p>All flows follow the same basic pattern. </p><p>A message (<code class="literal">msg</code>) is sent from node to node along the paths that connect each node. </p><p>Each<a class="indexterm" id="id662"/> node can read and update the <code class="literal">msg</code> as it passes through the node adding, updating, or removing <code class="literal">msg</code> parameters until the <code class="literal">msg</code> is passed on to the next node. </p><p>After reaching the end of a flow, the message (<code class="literal">msg</code>) is discarded.</p></div><div class="section" title="Creating the pushbutton LED flow"><div class="titlepage"><div><div><h3 class="title"><a id="ch06lvl3sec100"/>Creating the pushbutton LED flow</h3></div></div></div><p>The Pushbutton LED flow is created by clicking on the <span class="strong"><strong>+</strong></span> tab at the top-right of the center panel. This creates a new flow sheet with the default name of <span class="strong"><strong>Sheet 1</strong></span>.</p><p>From <a class="indexterm" id="id663"/>the Raspberry Pi section of the toolbox on the left, drag an <code class="literal">rpi-gpio</code> in node onto the blank flow sheet. Also drag an <code class="literal">rpi-gpio</code> out node onto the flow sheet. </p><p>Connect the two nodes by first clicking on the output connector of the <span class="strong"><strong>rpio-gpio</strong></span> in node and dragging until a path forms and connects to the input connector of the <span class="strong"><strong>rpio-cpio</strong></span> out node.</p><p>Now, double-click on each node and enter the appropriate configuration information. The <span class="strong"><strong>rpi-gpio</strong></span> in node is named <span class="strong"><strong>Pushbutton</strong></span>, connected to <span class="strong"><strong>GPIO4</strong></span>, and has a <span class="strong"><strong>pullup</strong></span> <span class="strong"><strong>Resistor</strong></span>. The <span class="strong"><strong>rpi-gpio</strong></span> out node is named <span class="strong"><strong>LED</strong></span>, has the <span class="strong"><strong>Type</strong></span> <span class="strong"><strong>Digital output</strong></span>, and connects to <span class="strong"><strong>GPIO5</strong></span>. The flow sheet is renamed <span class="strong"><strong>Pushbutton LED</strong></span> by double-clicking the sheet name, <span class="strong"><strong>Sheet 1</strong></span>.</p><p>Once the nodes are configured, clicking on the red <span class="strong"><strong>Activate</strong></span> button deploys the flow. The <span class="strong"><strong>Activate</strong></span> button is red whenever there are changes to the flow. When the flow has been deployed, the button turns gray.</p><p>While the Pushbutton LED flow is active, the LED glows while the pushbutton is pressed and the LED stops glowing when the pushbutton is released. </p><p>Notice that the green status indicators under the two nodes also change from <span class="strong"><strong>0</strong></span> to <span class="strong"><strong>1</strong></span> while the pushbutton is pressed. The Node-RED platform is processing each button press.</p><p>Your Raspberry Pi is now a gateway for the Internet of Things!</p></div></div><div class="section" title="There's more…"><div class="titlepage"><div><div><h2 class="title"><a id="ch06lvl2sec227"/>There's more…</h2></div></div></div><p>This recipe <a class="indexterm" id="id664"/>is a very simple example of The ThingBox powered by Node-RED.</p><div class="section" title="There is a large library of available nodes"><div class="titlepage"><div><div><h3 class="title"><a id="ch06lvl3sec101"/>There is a large library of available nodes</h3></div></div></div><p>There <a class="indexterm" id="id665"/>are dozens of additional APIs and services in the Node-RED platform. </p><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc">Raspberry Pi <div class="itemizedlist"><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc">GPIO – the hardware GPIO pins</li><li class="listitem" style="list-style-type: disc">Mouse – pressing the mouse buttons</li></ul></div></li><li class="listitem" style="list-style-type: disc">General I/O<div class="itemizedlist"><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc">HTTP – ReSTful services and web pages</li><li class="listitem" style="list-style-type: disc">MQTT – message queues</li><li class="listitem" style="list-style-type: disc">Web Sockets – JSON messages</li><li class="listitem" style="list-style-type: disc">TCP/UDP – data streams</li><li class="listitem" style="list-style-type: disc">Serial Port – character streams</li></ul></div></li><li class="listitem" style="list-style-type: disc">Data Parsing<div class="itemizedlist"><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc">CSV – comma-separated values</li><li class="listitem" style="list-style-type: disc">JSON – JavaScript object notation</li><li class="listitem" style="list-style-type: disc">XML – extensible markup language</li><li class="listitem" style="list-style-type: disc">HTML – hypertext markup language</li></ul></div></li><li class="listitem" style="list-style-type: disc">Social<div class="itemizedlist"><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc">Email – send/receive e-mail messages</li><li class="listitem" style="list-style-type: disc">Twitter – send/receive tweets</li><li class="listitem" style="list-style-type: disc">Esendx – send SMS messages</li><li class="listitem" style="list-style-type: disc">Google Calendar – add, update, and react to events</li><li class="listitem" style="list-style-type: disc">RSS – monitor RSS/Atom feeds</li></ul></div></li><li class="listitem" style="list-style-type: disc">Storage<div class="itemizedlist"><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc">File – read/write files on disk</li><li class="listitem" style="list-style-type: disc">Carriots – data collection from connected objects</li><li class="listitem" style="list-style-type: disc">Emoncms – process and visualize environmental data</li><li class="listitem" style="list-style-type: disc">Evrythng – drive applications with real-time data</li><li class="listitem" style="list-style-type: disc">Exosite – operationalized cloud<a class="indexterm" id="id666"/> processing</li><li class="listitem" style="list-style-type: disc">Thingspeak – open IoT platform</li><li class="listitem" style="list-style-type: disc">Tinamous – IoT platform for privacy and collaboration</li><li class="listitem" style="list-style-type: disc">Xively – enterprise IoT application platform</li></ul></div></li></ul></div></div><div class="section" title="Wait 40 seconds before powering off or rebooting"><div class="titlepage"><div><div><h3 class="title"><a id="ch06lvl3sec102"/>Wait 40 seconds before powering off or rebooting</h3></div></div></div><p>There is<a class="indexterm" id="id667"/> one particular caution that is repeated in The ThingBox documentation. It says do not shut down or reboot the Raspberry Pi for at least 40 seconds after activating (saving) any flow – even if the flow starts working earlier than that!</p><p>Saving the updated flow diagram to disk is scheduled as an independent task that runs in parallel with the other tasks (nodes) that are currently running in the Node-RED server. So, it is quite likely that changes to the flow diagrams are activated in the Node-RED server before they are persisted to disk.</p></div></div><div class="section" title="See also"><div class="titlepage"><div><div><h2 class="title"><a id="ch06lvl2sec228"/>See also</h2></div></div></div><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc"><span class="strong"><strong>The ThingBox Project </strong></span>(<a class="ulink" href="http://thethingbox.io/">http://thethingbox.io/</a>): Use Internet of Things <a class="indexterm" id="id668"/>technologies without any technical knowledge and for free.</li><li class="listitem" style="list-style-type: disc"><span class="strong"><strong>Node-RED </strong></span>(<a class="ulink" href="http://nodered.org/">http://nodered.org/</a>): Node-RED is a visual tool for wiring<a class="indexterm" id="id669"/> the Internet of Things.</li><li class="listitem" style="list-style-type: disc"><span class="strong"><strong>Carriots </strong></span>(<a class="ulink" href="https://www.carriots.com/">https://www.carriots.com/</a>): Carriots is an IoT platform that<a class="indexterm" id="id670"/> will store a year of data for 10 devices for free.</li><li class="listitem" style="list-style-type: disc"><span class="strong"><strong>Emoncms </strong></span>(<a class="ulink" href="http://emoncms.org/">http://emoncms.org/</a>): Emoncms is a powerful open source web <a class="indexterm" id="id671"/>app for processing, logging, and visualizing energy, temperature, and other environmental data.</li><li class="listitem" style="list-style-type: disc"><span class="strong"><strong>Evrythng </strong></span>(<a class="ulink" href="https://evrythng.com/">https://evrythng.com/</a>): Evrythng is an IoT platform that connects <a class="indexterm" id="id672"/>any consumer product to the web and manages real-time data to drive applications.</li><li class="listitem" style="list-style-type: disc"><span class="strong"><strong>Thingspeak </strong></span>(<a class="ulink" href="https://thingspeak.com/">https://thingspeak.com/</a>): Thingspeak is an open source platform<a class="indexterm" id="id673"/> for the Internet of Things.</li><li class="listitem" style="list-style-type: disc"><span class="strong"><strong>Tinamous </strong></span>(<a class="ulink" href="https://www.tinamous.com/">https://www.tinamous.com/</a>): Tinamous integrates status posts, alerts, and<a class="indexterm" id="id674"/> sensor measurements using simple, open connectivity solutions easily connecting people and Internet of Things devices.</li><li class="listitem" style="list-style-type: disc"><span class="strong"><strong>Xively </strong></span>(<a class="ulink" href="https://xively.com/">https://xively.com/</a>): Xively simplifies the way companies securely<a class="indexterm" id="id675"/> and robustly connect their products and users, manage IoT data at scale, and engage more closely with their customers, users, and partners.</li><li class="listitem" style="list-style-type: disc"><span class="strong"><strong>Zero-configuration networking </strong></span>(<a class="ulink" href="https://en.wikipedia.org/wiki/Zero-configuration_networking">https://en.wikipedia.org/wiki/Zero-configuration_networking</a>): This Wikipedia article describes the zero-configuration <a class="indexterm" id="id676"/>networking that The ThingBox uses to announce its location at <code class="literal">http://thethingbox.local/</code>.</li></ul></div></div></div></body></html>