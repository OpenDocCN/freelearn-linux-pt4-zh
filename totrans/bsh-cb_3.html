<html><head></head><body><div id="sbo-rt-content" class="calibre1"><section class="calibre2">

                            <header class="calibre2">
                    <h1 class="header-title">Understanding and Gaining File System Mastery</h1>
                </header>
            
            <article class="calibre2">
                
<p class="mce-root">In this chapter, we will introduce the following:</p>
<ul class="calibre13">
<li class="calibre14">Viewing files from various angles – head, tail, less, and more</li>
<li class="calibre14">Searching for files by name and/or extension</li>
<li class="calibre14">Creating a diff of two files and patching</li>
<li class="calibre14">Creating symbolic links and using them effectively</li>
<li class="calibre14">Crawling filesystem directories and printing a tree</li>
<li class="calibre14">Finding and deleting duplicate files or directories</li>
<li class="calibre14">Joining and splitting files at arbitrary positions</li>
<li class="calibre14">Generating datasets and random files of various size</li>
</ul>


            </article>

            
        </section>
    </div>



  
<div id="sbo-rt-content" class="calibre1"><section class="calibre2">

                            <header class="calibre2">
                    <h1 class="header-title">Introduction</h1>
                </header>
            
            <article class="calibre2">
                
<p class="mce-root">In this chapter, we will extend some of the contents from Chapter 2, <em class="calibre18">Acting Like a Typewriter and File Explorer</em>, but aim to make you even stronger when creating, viewing, and managing files. After all, how does one look at a very large file? Find external software dependencies of a binary and manipulate files? Surely, these tasks are cornerstones in a number of tasks any one developer, administrator, or power user can think of.</p>
<p class="mce-root">For example, Bob the reader has already been introduced to <span class="calibre16">VI</span>, and perhaps he has his own GUI editor or application, such as Open Office, but what happens if that editor likes to crash upon opening a full file? Can he just look at the starting few lines? Absolutely. Can he split that file (if the structure is known like a CSV) at X number of lines? Again, absolutely!</p>
<p class="mce-root">All of these things are not impossible, and the list of activities Bob can do can continue on forever. The idea of this chapter is to give you a segue into some of the things you can do if life isn't going your way or you need quick access/control over the files on your system.</p>
<div class="packt_infobox">The scripts for this chapter can be found at <a href="https://github.com/PacktPublishing/Bash-Cookbook/tree/master/chapter%2003" class="calibre25 pcalibre pcalibre3 pcalibre2 pcalibre1">https://github.com/PacktPublishing/Bash-Cookbook/tree/master/chapter%2003</a>.</div>


            </article>

            
        </section>
    </div>



  
<div id="sbo-rt-content" class="calibre1"><section class="calibre2">

                            <header class="calibre2">
                    <h1 class="header-title">Viewing files from various angles – head, tail, less, and more</h1>
                </header>
            
            <article class="calibre2">
                
<p class="mce-root">As of this very moment, your system likely has many text files of various sizes including a never ending log file being written too. You might even have several large files containing copious amounts of code (such as the Linux kernel or a software project) and would like to quickly view them from the console without slowing your system down to a halt.</p>
<p class="mce-root">To do this, there are four essential commands that should be able to provide you more than enough functionality for their purposes:</p>
<ul class="calibre13">
<li class="calibre14"><strong class="calibre3">Head</strong>: Can be used to output the beginning lines of a file</li>
<li class="calibre14"><strong class="calibre3">Tail</strong>: Can be used to output the end or tail of a file (continuously as well)</li>
<li class="calibre14"><strong class="calibre3">More</strong>: A tool used as a <em class="calibre26">pager</em> to view large files page by page/line by line</li>
<li class="calibre14"><strong class="calibre3">Less</strong>: <span class="calibre11">Is the same as more, but it has more features, including backwards scrolling</span></li>
</ul>
<div class="packt_infobox">Sometimes, you may see the command <kbd class="calibre23">more</kbd> on embedded systems and not the <kbd class="calibre23">less</kbd> command. This is because the less command is larger than <kbd class="calibre23">more</kbd>. Does your head hurt yet?</div>


            </article>

            
        </section>
    </div>



  
<div id="sbo-rt-content" class="calibre1"><section class="calibre2">

                            <header class="calibre2">
                    <h1 class="header-title">Getting ready</h1>
                </header>
            
            <article class="calibre2">
                
<p class="mce-root">Besides having a terminal open, several large text files are needed for this recipe. If you have some already, great; if not, install the following:</p>
<pre class="calibre22">$ wget http://www.randomtext.me/download/txt/lorem/ol-20/98-98.txt<br class="calibre2"/>$ fmt 98-98.txt &gt; loremipsum.txt</pre>
<div class="packt_infobox">The <kbd class="calibre23">fmt</kbd> <span class="calibre11">command</span> is a simple optimal text formatter. It is used to clean up the output a bit for better results on the command line.</div>


            </article>

            
        </section>
    </div>



  
<div id="sbo-rt-content" class="calibre1"><section class="calibre2">

                            <header class="calibre2">
                    <h1 class="header-title">How to do it...</h1>
                </header>
            
            <article class="calibre2">
                
<p class="mce-root">Open a terminal and run the following commands:</p>
<pre class="calibre27">$ cat loremipsum.txt<br class="calibre2"/>$ head loremipsum.txt<br class="calibre2"/>$ head -n 1 loremipsum.txt<br class="calibre2"/>$ tail loremipsum.txt<br class="calibre2"/>$ tail -n 1 loremipsum.txt</pre>
<p class="mce-root">Interestingly enough, the <kbd class="calibre17">tail</kbd> command has a feature that is different than the <kbd class="calibre17">head</kbd> command: it can monitor the tail end of a file forever until the command is exited or killed when using the <kbd class="calibre17">-f</kbd> or <kbd class="calibre17">-F</kbd> flags. Run the following command:</p>
<pre class="calibre27">$ tail -F /var/log/kern.log</pre>
<p class="mce-root">Keeping the <kbd class="calibre17">tail</kbd> command running, try disconnecting your wireless or Ethernet port. What do you see?</p>
<p class="mce-root">Press <em class="calibre18">Ctrl</em> + <em class="calibre18">C</em> to quit <kbd class="calibre17">tail</kbd> and run the following command:</p>
<pre class="calibre27">$ more loremipsum.txt</pre>
<p class="mce-root">Pressing the spacebar or <em class="calibre18">Enter</em> on your keyboard will progress through the file until the end. Pressing <kbd class="calibre17">q</kbd> will immediately exit <kbd class="calibre17">more</kbd> and return you to the console prompt.</p>
<p class="mce-root">Next, try the following command:</p>
<pre class="calibre27">$ less loremipsum.txt </pre>
<p class="mce-root">Try navigating through the file using <span class="calibre16"><em class="calibre18">p</em></span><em class="calibre18">g up</em>, <em class="calibre18">pg dn</em>, the up and down arrow keys, and <em class="calibre18">Enter</em> and the spacebar. Notice anything?</p>


            </article>

            
        </section>
    </div>



  
<div id="sbo-rt-content" class="calibre1"><section class="calibre2">

                            <header class="calibre2">
                    <h1 class="header-title">How it works...</h1>
                </header>
            
            <article class="calibre2">
                
<p class="mce-root">Before proceeding, note that the contents of the <kbd class="calibre17">loremipsum.txt</kbd> file will be different for every instance downloaded. <strong class="calibre6">Lorem Ipsum</strong> is pseudo random text that is used in a variety of text-related duties, often as placeholder values because it <em class="calibre18">looks</em> to be a language of sorts and is useful where the human brain is disturbed by copy and paste stub text.</p>
<p class="mce-root">Great! Let's get started:</p>
<ol class="calibre20">
<li class="chapter">In the first step, the commands should produce similar results to the following block (for brevity, we excluded much of the output to keep the recipe coherent), but notice that head begins at the beginning, or <em class="calibre26">head</em>, of <kbd class="calibre17">loremipsum.txt</kbd><span class="calibre11">, and tail begins at the end, or <em class="calibre26">tail</em></span>, <span class="calibre11">of <kbd class="calibre17">loremipsum.txt</kbd><strong class="calibre3">.</strong> When we specify the <kbd class="calibre17">-n</kbd> flag with a decimal number such as <kbd class="calibre17">1</kbd>, both utilities will output a single line or whatever number of lines is entered:</span></li>
</ol>
<pre class="calibre27">$ cat loremipsum.txt<br class="calibre2"/><br class="calibre2"/>Feugiat orci massa inceptos proin adipiscing urna vestibulum<br class="calibre2"/>hendrerit morbi convallis commodo porta magna, auctor cras nulla ligula<br class="calibre2"/>sit vehicula primis ultrices duis rutrum cras feugiat sit facilisis<br class="calibre2"/>fusce placerat sociosqu amet cursus quisque praesent mauris facilisis,<br class="calibre2"/>egestas curabitur imperdiet sit elementum ornare sed class ante pharetra<br class="calibre2"/>in, nisi luctus sit accumsan iaculis eu platea sit ullamcorper platea<br class="calibre2"/>erat convallis orci volutpat curabitur nostra tellus erat non nisl<br class="calibre2"/>condimentum, cubilia lacinia eget rhoncus pharetra euismod sagittis<br class="calibre2"/>morbi risus, nisl scelerisque fringilla arcu auctor turpis ultricies<br class="calibre2"/>imperdiet nibh eget felis leo enim auctor sed netus ultricies sit fames<br class="calibre2"/>...<br class="calibre2"/>$ head loremipsum.txt<br class="calibre2"/> Feugiat orci massa inceptos proin adipiscing urna vestibulum<br class="calibre2"/>hendrerit morbi convallis commodo porta magna, auctor cras nulla ligula<br class="calibre2"/>sit vehicula primis ultrices duis rutrum cras feugiat sit facilisis<br class="calibre2"/>fusce placerat sociosqu amet cursus quisque praesent mauris facilisis,<br class="calibre2"/>egestas curabitur imperdiet sit elementum ornare sed class ante pharetra in<br class="calibre2"/>$ head -n 1 loremipsum.txt<br class="calibre2"/> Feugiat orci massa inceptos proin adipiscing urna vestibulum<br class="calibre2"/>$ tail loremipsum.txt<br class="calibre2"/>euismod torquent primis mattis velit aptent risus accumsan cubilia eros<br class="calibre2"/>justo ad sodales dapibus tempor, donec mauris erat at lacinia senectus<br class="calibre2"/>luctus venenatis mollis ullamcorper ante mollis nisl leo sollicitudin<br class="calibre2"/>felis congue tempus nam curabitur viverra venenatis quis, felis pretium<br class="calibre2"/>enim posuere elit bibendum dictumst, bibendum mattis blandit sociosqu<br class="calibre2"/>adipiscing cursus quisque augue facilisis vehicula metus taciti conubia<br class="calibre2"/>odio proin rutrum aliquam lorem, erat lobortis etiam eget risus lectus<br class="calibre2"/>sodales mauris blandit, curabitur velit risus litora tincidunt inceptos<br class="calibre2"/>nam ipsum platea felis mi arcu consequat velit viverra, facilisis<br class="calibre2"/> ulputate semper vitae suspendisse aliquam, amet proin potenti semper<br class="calibre2"/>$ tail -n 1 loremipsum.txt<br class="calibre2"/> ulputate semper vitae suspendisse aliquam, amet proin potenti semper</pre>
<ol start="2" class="calibre20">
<li class="chapter">In the second step, we discover a key difference between the <kbd class="calibre17">head</kbd> and <kbd class="calibre17">tail</kbd> commands. Tail is able to monitor a file while continuously dumping the tail contents of the file to standard out <kbd class="calibre17">(stdout)</kbd>. If the file has a read error, or is moved/rotated out, <kbd class="calibre17">-f</kbd> (lowercase) will often stop outputting information, while <kbd class="calibre17">-F</kbd> will reopen the file and continue outputting the contents.</li>
</ol>
<div class="packt_tip"><kbd class="calibre23">-F</kbd> <span class="calibre11">instead of</span> <kbd class="calibre23">-f</kbd> <span class="calibre11">is usually the desired option between the two if tailing system logs.</span></div>
<ol start="3" class="calibre20">
<li class="chapter">With <kbd class="calibre17">tail</kbd> still running in continuous mode, several new entries should appear among the output. This sample is from when a system's wireless adapter was forced to reconnect to a standard access point (AP):</li>
</ol>
<pre class="calibre27">Dec 8 14:21:40 moon kernel: userif-2: sent link up event.<br class="calibre2"/>Dec 8 14:21:40 moon kernel: wlp3s0: authenticate with 18:d6:c7:fa:26:b0<br class="calibre2"/>Dec 8 14:21:40 moon kernel: wlp3s0: send auth to 18:d6:c7:fa:26:b0 (try 1/3)<br class="calibre2"/>Dec 8 14:21:40 moon kernel: wlp3s0: authenticated<br class="calibre2"/>Dec 8 14:21:40 moon kernel: wlp3s0: associate with 18:d6:c7:fa:26:b0 (try 1/3)<br class="calibre2"/>Dec 8 14:21:40 moon kernel: wlp3s0: RX AssocResp from 18:d6:c7:fa:26:b0 (capab=0x411 status=0 aid=1)<br class="calibre2"/>Dec 8 14:21:40 moon kernel: wlp3s0: associated<br class="calibre2"/>Dec 8 14:21:40 moon kernel: bridge-wlp3s0: device is wireless, enabling SMAC<br class="calibre2"/>Dec 8 14:21:40 moon kernel: userif-2: sent link down event.<br class="calibre2"/>Dec 8 14:21:40 moon kernel: userif-2: sent link up event.</pre>
<ol start="4" class="calibre20">
<li class="chapter">After killing the <kbd class="calibre17">tail</kbd> command, your console should be back at the prompt again: <kbd class="calibre17">$</kbd>.</li>
<li class="chapter">Running <kbd class="calibre17">more</kbd> and using the spacebar or <em class="calibre26">Enter</em> keys will progress output through the entire <kbd class="calibre17">loremipsum.txt</kbd> file. The <kbd class="calibre17">more</kbd> command is only able to view from beginning to end, and not back and forth.</li>
<li class="chapter">The <kbd class="calibre17">less</kbd> command is certainly more powerful and offers the user to be able to navigate through <kbd class="calibre17">loremipsum.txt</kbd> using several key combinations. It also offers search facilities among other features.</li>
</ol>


            </article>

            
        </section>
    </div>



  
<div id="sbo-rt-content" class="calibre1"><section class="calibre2">

                            <header class="calibre2">
                    <h1 class="header-title">Searching for files by name and/or extension</h1>
                </header>
            
            <article class="calibre2">
                
<p class="mce-root">When we have large number of files available for viewing, sometimes we need to find a file among many without using the GUI searching tools or provide a better set of granular filters to reduce returned results. To search on the command line, there are a few facilities/commands we can use:</p>
<ul class="calibre13">
<li class="calibre14"><kbd class="calibre17">locate</kbd> (also a sibling of the <kbd class="calibre17">updatedb</kbd> command): Used to find files more efficiently using an index of files</li>
<li class="calibre14"><kbd class="calibre17">find</kbd><span class="calibre11">:</span> Used to find files with specific attributes, extensions, and even names within a specific directory</li>
</ul>
<p class="mce-root">The <kbd class="calibre17">find</kbd> command is far more suitable for the command line and widespread (often being on embedded devices), but the <kbd class="calibre17">locate</kbd> command is a common facility for use on desktops, laptops, and servers. Locate is far more simpler and involves recursively indexing all of the files it is configured to keep track of and it can generate very quick file listings. The file index can be updated using the following command:</p>
<pre class="calibre22">$ sudo updatedb</pre>
<div class="packt_tip">Updating the database for the first time or after large amounts of files have been created, moved, or copied may result in longer than average times to update the database. One particular mechanism to keep the database frequently up to date automatically is through the use of <strong class="calibre3">cron scheduler</strong>. More about this topic will be covered later.</div>
<p class="mce-root">The <kbd class="calibre17">locate</kbd> command can also be used to test for the existence of a file before reporting its location (the database may be out of date), and also limit the number of entries returned.</p>
<p class="mce-root">As noted, <kbd class="calibre17">find</kbd> does not have a fancy database, but it does have a number of user configurable flags, which can be passed to it at the time of execution. Some of the most commonly used flags used with the <kbd class="calibre17">find</kbd> command are as follows:</p>
<ul class="calibre13">
<li class="calibre14"><kbd class="calibre17">-type</kbd>: This is used to specify the type of file, which can be either file or directory</li>
<li class="calibre14"><kbd class="calibre17">-delete</kbd>: This is used to delete files, but may not be present, which means that <kbd class="calibre17">exec</kbd> will be required</li>
<li class="calibre14"><kbd class="calibre17">-name</kbd>: This is used to specify searching by name functionality</li>
<li class="calibre14"><kbd class="calibre17">-exec</kbd>: This is used to specify what else to do upon match</li>
<li class="calibre14"><kbd class="calibre17">-{a,c,m}time</kbd>: This is used to search for things such as time of access, creation, and modification</li>
<li class="calibre14"><kbd class="calibre17">-d, -depth</kbd>: This is used to specify the depth searching may delve recursively into</li>
<li class="calibre14"><kbd class="calibre17">-maxdepth</kbd>: This is used to specify the maximum depth per recursion</li>
<li class="calibre14"><kbd class="calibre17">-mindepth</kbd>: This is used to specify the minimum depth when recursively searching</li>
<li class="calibre14"><kbd class="calibre17">-L</kbd>, <kbd class="calibre17">-H</kbd>, <kbd class="calibre17">-P</kbd>: In order, <kbd class="calibre17">-L</kbd> follow symbolic links, <kbd class="calibre17">-H</kbd> does not follow symbolic links except in specific cases, and <kbd class="calibre17">-P</kbd> never follows symbolic links</li>
<li class="calibre14"><kbd class="calibre17">-print</kbd>, <kbd class="calibre17">-print0</kbd>: These commands are used to print the name of the current file on a standard output</li>
<li class="calibre14"><kbd class="calibre17">!</kbd>, <kbd class="calibre17">-not</kbd>: This is used to specify logical operations such as match everything, but not on this criteria</li>
<li class="calibre14"><kbd class="calibre17">-i</kbd>: This is used to specify user interaction on a match such as -<kbd class="calibre17">iname test</kbd></li>
</ul>
<div class="packt_infobox">Please be aware that your platform may not support all of GNU find's features. This may be the case with limited shells for embedding, resource constraints, or security reasons.</div>


            </article>

            
        </section>
    </div>



  
<div id="sbo-rt-content" class="calibre1"><section class="calibre2">

                            <header class="calibre2">
                    <h1 class="header-title">Getting ready</h1>
                </header>
            
            <article class="calibre2">
                
<p class="mce-root">Besides having a terminal open, several large text files are needed for this recipe. If you have some already, great; if not, install the following:</p>
<pre class="calibre22">$ sudo apt-get install locate manpages manpages-posix<br class="calibre2"/>$ sudo updatedb<br class="calibre2"/>$ git clone https://github.com/PacktPublishing/Linux-Device-Drivers-Development.git Linux-Device-Drivers-Development # Another Packt title<br class="calibre2"/>$ mkdir -p ~/emptydir/makesure</pre>
<div class="packt_infobox">If a file is not found using the <kbd class="calibre23">locate</kbd> command, the database might be simply out of date and needs to be re-ran. It is possible that <kbd class="calibre23">updatedb</kbd> is also not indexing partitions such as those contained on removable media (USB sticks), and the file may be present there instead of the regular system partitions.<br class="calibre2"/>
In preparation for this recipe, be aware that two concepts were inadvertently introduced: <kbd class="calibre23">git</kbd> and <kbd class="calibre23">manpages.</kbd> Manpages are among one of the oldest forms of help documentation available in Linux, and git is a version control system that simplifies management, versioning, and distribution of files such as code. Knowing how to use either is certainly beneficial, but beyond the scope of this book. For more information about git, check out another Packt book: <em class="calibre26">GIT Version Control Cookbook</em>.</div>


            </article>

            
        </section>
    </div>



  
<div id="sbo-rt-content" class="calibre1"><section class="calibre2">

                            <header class="calibre2">
                    <h1 class="header-title">How to do it...</h1>
                </header>
            
            <article class="calibre2">
                
<ol class="calibre20">
<li class="chapter">Open a terminal and run the following commands in order to understand the <kbd class="calibre17">locate</kbd> command:</li>
</ol>
<pre class="calibre27">$ locate stdio.h<br class="calibre2"/>$ sudo touch /usr/filethatlocatedoesntknow.txt /usr/filethatlocatedoesntknow2.txt<br class="calibre2"/>$ sudo sh -c 'echo "<span class="calibre11">My dear Watson ol\'boy" &gt; </span>/usr/filethatlocatedoesntknow.txt'<br class="calibre2"/>$ locate filethatlocatedoes<br class="calibre2"/>$ sudo updatedb<br class="calibre2"/>$ locate filethatlocatedoesntknow</pre>
<ol start="2" class="calibre20">
<li class="chapter">Next, run the following commands to demonstrate some of the power of <kbd class="calibre17">find</kbd>:</li>
</ol>
<pre class="calibre27">$ sudo <span class="calibre11">find</span> <span class="calibre11">${HOME}</span> <span class="calibre11">-name</span> <span class="calibre11">".*"</span> <span class="calibre11">-ls<br class="calibre2"/>$ sudo find / -type d -name ".git"<br class="calibre2"/>$ find ${HOME} -type f \( -name "*.sh" -o -name "*.txt" \)<br class="calibre2"/></span></pre>
<ol start="3" class="calibre20">
<li class="chapter">Next, we can chain the <kbd class="calibre17">find</kbd> commands together with <kbd class="calibre17">&amp;&amp;</kbd> and ultimately perform an <kbd class="calibre17">exec</kbd> instead of piping the output to another process, command, or script. Try the following:</li>
</ol>
<pre class="calibre27"><span class="calibre11">$ find . -type d -name ".git" &amp;&amp; find . -name ".gitignore" &amp;&amp; find . -name ".gitmodules"</span><span class="calibre11"><br class="calibre2"/>$ sudo find / -type f -exec grep -Hi 'My dear Watson ol boy' {} +</span></pre>
<ol start="4" class="calibre20">
<li class="chapter">Finally, one of the most common uses of find is to delete files using either the built-in <kbd class="calibre17">-delete</kbd> flag or by using <kbd class="calibre17">exec</kbd> combined with rm <kbd class="calibre17">-rf</kbd>:</li>
</ol>
<pre class="calibre27"><span class="calibre11">$ find </span>~/emptydir <span class="calibre11">-type d -empty -delete<br class="calibre2"/>$ find </span>Linux-Device-Drivers-Development <span class="calibre11">-name ".git*" -exec rm -rf {} \;</span></pre>


            </article>

            
        </section>
    </div>



  
<div id="sbo-rt-content" class="calibre1"><section class="calibre2">

                            <header class="calibre2">
                    <h1 class="header-title">How it works...</h1>
                </header>
            
            <article class="calibre2">
                
<p class="mce-root">Repeat after me—"<em class="calibre18">locate is simple</em> and needs to be updated, <kbd class="calibre17">find</kbd> works when in a bind, but powerful and cryptic and <em class="calibre18">can break things</em>." Lets continue and begin with the explanations:</p>
<ol class="calibre20">
<li class="chapter">As mentioned previously, the <kbd class="calibre17">locate</kbd> command is a relatively simple search tool that uses a database as a backend, which contains an indexed list of all of the files for quick and efficient searches. Locate is not real-time unlike the <kbd class="calibre17">find</kbd> command, which searches everything as it exists at the time of execution (depending on the parameters provided to find). Locating <kbd class="calibre17">stdio.h</kbd> will produce several results depending on your system. However, when we run locate again, it does not know or contain any information regarding the <kbd class="calibre17">/usr/filethatlocatedoesntknow.txt</kbd> and <kbd class="calibre17">/usr/filethatlocatedoesntknow2.txt</kbd> files. Running <kbd class="calibre17">updatedb</kbd> will re-index the files and then using the <kbd class="calibre17">locate</kbd> command will return the appropriate results. Notice that locate works with partial names or full path matching:</li>
</ol>
<pre class="calibre27">$ locate stdio.h<br class="calibre2"/>/usr/include/stdio.h<br class="calibre2"/>/usr/include/c++/5/tr1/stdio.h<br class="calibre2"/>/usr/include/x86_64-linux-gnu/bits/stdio.h<br class="calibre2"/>/usr/include/x86_64-linux-gnu/unicode/ustdio.h<br class="calibre2"/>/usr/lib/x86_64-linux-gnu/perl/5.22.1/CORE/nostdio.h<br class="calibre2"/>/usr/share/man/man7/stdio.h.7posix.gz<br class="calibre2"/>$ sudo touch /usr/filethatlocatedoesntknow.txt /usr/filethatlocatedoesntknow2.txt<br class="calibre2"/>$ sudo sh -c 'echo "<span class="calibre11">My dear Watson ol\'boy" &gt; </span>/usr/filethatlocatedoesntknow.txt'<br class="calibre2"/>$ locate filethatlocatedoes<br class="calibre2"/>$ sudo updatedb<br class="calibre2"/>$ locate filethatlocatedoes<br class="calibre2"/>/usr/filethatlocatedoesntknow.txt<br class="calibre2"/>/usr/filethatlocatedoesntknow2.txt</pre>
<ol start="2" class="calibre20">
<li class="chapter">In the second step, we are introduced to some of the amazing functionality provided by the <kbd class="calibre17">find</kbd> command.</li>
</ol>
<div class="packt_infobox">Again, be aware that using <kbd class="calibre23">find</kbd> for operations such as deletion can break your system if not handled appropriately or if the input isn't carefully monitored and filtered.</div>
<ol start="3" class="calibre20">
<li class="chapter">At a minimum, the <kbd class="calibre17">find</kbd> command is executed this way: <kbd class="calibre17">$ find ${START_SEARCH_HERE} ${OPTIONAL_PARAMETERS ...}</kbd>. In the first use of the find command, we begin searching within our user's home directory (<kbd class="calibre17">${HOME}</kbd> environment variable), and then use a wild card to look for <strong class="calibre3">hidden files</strong> that begin with a <kbd class="calibre17">.</kbd>.Finally, we use <kbd class="calibre17">-ls</kbd> to create a file listing. This is not by accident as you may have observed; you can create files that are absent upon first inspection in the GUI's file explorer (especially in your user's home directory) or on the console (for example, unless you use the <kbd class="calibre17">ls</kbd> command with the <kbd class="calibre17">-a</kbd> flag). In the next command, we use <kbd class="calibre17">find -type d</kbd> to search for a directory named <kbd class="calibre17">.git</kbd>. Then, we search for files that match either <kbd class="calibre17">*.sh</kbd> or <kbd class="calibre17">*.txt</kbd> using a special notation for find: <kbd class="calibre17">-type f \( -name "*.sh" -o -name "*.txt" \).</kbd> Notice the forward slash <kbd class="calibre17">\</kbd> <span class="calibre11">and</span> then the parenthesis <kbd class="calibre17">(</kbd>. We can then specify multiple name matching arguments using <kbd class="calibre17">-o -name "string"</kbd>.</li>
</ol>
<p class="mce-root"> </p>
<ol start="4" class="calibre20">
<li class="chapter">In the third step, we use find to search for subdirectories using <kbd class="calibre17">-type d</kbd> that are often present inside of cloned or exported git-related directories. We can chain the <kbd class="calibre17">find</kbd> commands together using this format: <kbd class="calibre17">$ cmd 1 &amp;&amp; cmd2 &amp;&amp; cmd3 &amp;&amp; ...</kbd>. This guarantees that if the proceeding command evaluates to true, then the next will execute and so on. Then, we introduce the <kbd class="calibre17">-exec</kbd> flag, which is used to execute another command once a match has been found. In this case, we search for all files and then use grep immediately to search within the file. Notice the <kbd class="calibre17">{} +</kbd> at the end of the <kbd class="calibre17">grep</kbd>. This is because <kbd class="calibre17">{}</kbd> will be replaced with find's returned results. The <kbd class="calibre17">+</kbd> character delimits the end of the <kbd class="calibre17">exec</kbd> command, and appends the results so that <kbd class="calibre17">rm -rf</kbd> will be executed less times than the total number of files found/matched.</li>
<li class="chapter">In the final step, we delete files using two methods. The first method using the <kbd class="calibre17">-delete</kbd> flag may not be available on all distributions or implementations of find, but upon match, it will delete the file. It is more efficient than executing the sub process <kbd class="calibre17">rm</kbd> on large numbers of files. Secondly, using <kbd class="calibre17">-exec rm -rf {} \;</kbd><span class="calibre11">,</span> we can delete files found easily and in a portable way. However, there is a difference between <kbd class="calibre17">\;</kbd> and <kbd class="calibre17">+</kbd> and the difference is that in the <kbd class="calibre17">\;</kbd> version, <kbd class="calibre17">rm -rf</kbd> is executed for each file found/matched. Be careful with this command as it is not interactive.</li>
</ol>


            </article>

            
        </section>
    </div>



  
<div id="sbo-rt-content" class="calibre1"><section class="calibre2">

                            <header class="calibre2">
                    <h1 class="header-title">Creating a diff of two files and patching</h1>
                </header>
            
            <article class="calibre2">
                
<p class="mce-root">In what case should you know what a diff is? Or a patch? In the Linux world, it is a way to determine the differences between files and also to solve problems at the OS level (especially if you have a broken driver in the Linux kernel). However, for the purposes of a cookbook, diffs and patches useful for a couple of main things:</p>
<ul class="calibre13">
<li class="calibre14">When determining whether a particular script or configuration file has modifications</li>
<li class="calibre14">When plotting differences between versions, or migrating data between an old to new script, and so on</li>
</ul>
<p class="mce-root">So, what is a <strong class="calibre6">diff</strong> or <strong class="calibre6">differential</strong>? A diff is the output that describes the differences between two files (file A and file B). The file A is the source, and the B file is the assumed to be modified file. If no diff output is created, then A and B are either empty or there are no differences. Diffs in a unified format typically look like this:</p>
<pre class="calibre22">$ diff -urN fileA.txt fileB.txt <br class="calibre2"/>--- fileA.txt 2017-12-11 15:06:49.972849620 -0500<br class="calibre2"/>+++ fileB.txt 2017-12-11 15:08:09.201177398 -0500<br class="calibre2"/>@@ -1,3 +1,4 @@<br class="calibre2"/> 12345<br class="calibre2"/>-abcdef<br class="calibre2"/>+abcZZZ<br class="calibre2"/>+789aaa<br class="calibre2"/> </pre>
<p class="mce-root">There are several formats of diffs, but the unified format is among the most popular (and used by the FOSS crowd). It contains information about both files (A and B), the line numbers and counts in each, and the content added or changed. If we look at the preceding sample, we can see that in the original, the string <kbd class="calibre17">abcdef</kbd> is removed <kbd class="calibre17">(-)</kbd> and then re-added <kbd class="calibre17">(+)</kbd> as <kbd class="calibre17">abcdZZZ</kbd>. And there is the further addition of a new line containing <kbd class="calibre17">789aaa</kbd> (which can also be seen here: <kbd class="calibre17">@@ -1,3 +1,4 @@</kbd>).</p>
<p class="mce-root">A patch is a unified diff that contains changes to one or more files that are to be applied in a specific order or method, hence the concept of patching being the process of applying a patch (which contains diff information). A patch can consist of several diffs concatenated together as well.</p>


            </article>

            
        </section>
    </div>



  
<div id="sbo-rt-content" class="calibre1"><section class="calibre2">

                            <header class="calibre2">
                    <h1 class="header-title">Getting ready</h1>
                </header>
            
            <article class="calibre2">
                
<p class="mce-root">Besides having a terminal open, these two utilities need to be installed:</p>
<pre class="calibre22">$ sudo apt-get install patch diff</pre>
<p class="mce-root">Next, let's create a fake configuration file that's copied from a real one:</p>
<pre class="calibre22">$ cp /etc/updatedb.conf ~/updatedb-v2.conf</pre>
<p class="mce-root">Open <kbd class="calibre17">updatedb-v2.conf</kbd> and change the contents to look like this:</p>
<pre class="calibre22">PRUNE_BIND_MOUNTS="yes"<br class="calibre2"/># PRUNENAMES=".git .bzr .hg .svn"<br class="calibre2"/>PRUNEPATHS="/tmp /var/spool /media /home/.ecryptfs /var/lib/schroot <strong class="calibre3">/media /mount</strong>"<br class="calibre2"/>PRUNEFS="NFS nfs nfs4 rpc_pipefs afs binfmt_misc proc smbfs autofs iso9660 ncpfs coda devpts ftpfs devfs mfs shfs sysfs cifs lustre tmpfs usbfs udf fuse.glusterfs fuse.sshfs curlftpfs ecryptfs fusesmb devtmpfs"</pre>
<p class="mce-root">In the event that your <kbd class="calibre17">updatedb-v2.conf</kbd> looks drastically different, add <kbd class="calibre17">/media /mount</kbd> to the <kbd class="calibre17">PRUNEPATHS</kbd> variable. Notice that they are separated by a space.</p>


            </article>

            
        </section>
    </div>



  
<div id="sbo-rt-content" class="calibre1"><section class="calibre2">

                            <header class="calibre2">
                    <h1 class="header-title">How to do it...</h1>
                </header>
            
            <article class="calibre2">
                
<ol class="calibre20">
<li class="chapter">Open a terminal, and run the following commands in order to understand the <kbd class="calibre17">diff</kbd> command:</li>
</ol>
<pre class="calibre27">$ diff /etc/updatedb.conf ~/updatedb-v2.conf<br class="calibre2"/>$ diff -urN /etc/updatedb.conf ~/updatedb-v2.conf</pre>
<ol start="2" class="calibre20">
<li class="chapter">At this point, only the diff information has been output to the console's standard out and a patch file has not been created. To create the actual patch file, execute the following command:</li>
</ol>
<pre class="calibre27">$ diff -urN /etc/updatedb.conf ~/updatedb-v2.conf &gt; 001-myfirst-patch-for-updatedb.patch</pre>
<div class="packt_infobox">Patches can be found in many forms, but they usually have the <kbd class="calibre23">.patch</kbd> extension and are preceded by a number and a human readable name.</div>
<ol start="3" class="calibre20">
<li class="chapter">Now, before applying a patch, it can also be tested to ensure that the results are as expected. Try the following commands:</li>
</ol>
<pre class="calibre27">$ echo "NEW LINE" &gt; ~/updatedb-v3.conf<br class="calibre2"/>$ cat ~/updatedb-v2.conf &gt;&gt; ~/updatedb-v3.conf<br class="calibre2"/>$ patch --verbose /etc/updatedb.conf &lt; 001-myfirst-patch-for-updatedb.patch</pre>
<ol start="4" class="calibre20">
<li class="chapter">Let's see what happens when patches fail to apply using the following commands:</li>
</ol>
<pre class="calibre27">$ patch --verbose --dry-run ~/updatedb-v1.conf &lt; 001-myfirst-patch-for-updatedb.patch <br class="calibre2"/>$ patch --verbose ~/fileA.txt &lt; 001-myfirst-patch-for-updatedb.patch </pre>


            </article>

            
        </section>
    </div>



  
<div id="sbo-rt-content" class="calibre1"><section class="calibre2">

                            <header class="calibre2">
                    <h1 class="header-title">How it works...</h1>
                </header>
            
            <article class="calibre2">
                
<p class="mce-root">Repeat after me—"<em class="calibre18">locate is simple and needs to be updated, find works when in a bind, but powerful and cryptic and can break things</em>." Let's continue and begin with the explanations:</p>
<ol class="calibre20">
<li class="chapter">The first <kbd class="calibre17">diff</kbd> command outputs the changes in the simple diff format. However, in the second instance when running the diff command, we use the <kbd class="calibre17">-urN</kbd> flag(s). <kbd class="calibre17">-u</kbd> stands for unified format, <kbd class="calibre17">-r</kbd> stands for recursive, and <kbd class="calibre17">-N</kbd> stands for a new file:</li>
</ol>
<pre class="calibre27">$ diff /etc/updatedb.conf ~/updatedb-v2.conf<br class="calibre2"/>3c3<br class="calibre2"/>&lt; PRUNEPATHS="/tmp /var/spool /media /home/.ecryptfs /var/lib/schroot"<br class="calibre2"/>---<br class="calibre2"/>&gt; PRUNEPATHS="/tmp /var/spool /media /home/.ecryptfs /var/lib/schroot /media /mount"<br class="calibre2"/>$ diff -urN /etc/updatedb.conf ~/updatedb-v2.conf<br class="calibre2"/>--- /etc/updatedb.conf 2014-11-18 02:54:29.000000000 -0500<br class="calibre2"/>+++ /home/rbrash/updatedb-v2.conf 2017-12-11 15:26:33.172955754 -0500<br class="calibre2"/>@@ -1,4 +1,4 @@<br class="calibre2"/> PRUNE_BIND_MOUNTS="yes"<br class="calibre2"/> # PRUNENAMES=".git .bzr .hg .svn"<br class="calibre2"/>-PRUNEPATHS="/tmp /var/spool /media /home/.ecryptfs /var/lib/schroot"<br class="calibre2"/>+PRUNEPATHS="/tmp /var/spool /media /home/.ecryptfs /var/lib/schroot /media /mount"<br class="calibre2"/> PRUNEFS="NFS nfs nfs4 rpc_pipefs afs binfmt_misc proc smbfs autofs iso9660 ncpfs coda devpts ftpfs devfs mfs shfs sysfs cifs lustre tmpfs usbfs udf fuse.glusterfs fuse.sshfs curlftpfs ecryptfs fusesmb devtmpfs"<br class="calibre2"/><br class="calibre2"/></pre>
<ol start="2" class="calibre20">
<li class="chapter">Now, we have created a patch by redirecting standard out to the <kbd class="calibre17">001-myfirst-patch-for-updatedb.patch</kbd> file:</li>
</ol>
<pre class="calibre27">$ diff -urN /etc/updatedb.conf ~/updatedb-v2.conf &gt; 001-myfirst-patch-for-updatedb.patch</pre>
<ol start="3" class="calibre20">
<li class="chapter">Now that we have created a modified version of <kbd class="calibre17">~/updatedb-v3</kbd>, notice anything from the dry-run? Ignoring that <kbd class="calibre17">/etc/updatedb.conf</kbd> only has read-only permissions (we are just using it for the sake of example as dry-run doesn't alter the contents anyway), we can see that HUNK #1 is applied successfully. A <strong class="calibre3">hunk</strong> stands for a section of the diff, and you can have several for one file or many files inside of the same patch. Did you notice that the line numbers didn't match exactly as those in the patch? It still applied the patch as it knew enough information and <strong class="calibre3">fudged</strong> the data to match so that it would apply successfully. Be aware of this functionality when dealing with large files, which may have similar match criteria:</li>
</ol>
<pre class="calibre27">$ patch --verbose --dry-run /etc/updatedb.conf &lt; 001-myfirst-patch-for-updatedb.patch <br class="calibre2"/>Hmm... Looks like a unified diff to me...<br class="calibre2"/>The text leading up to this was:<br class="calibre2"/>--------------------------<br class="calibre2"/>|--- /etc/updatedb.conf 2014-11-18 02:54:29.000000000 -0500<br class="calibre2"/>|+++ /home/rbrash/updatedb-v2.conf 2017-12-11 15:26:33.172955754 -0500<br class="calibre2"/>--------------------------<br class="calibre2"/>File /etc/updatedb.conf is read-only; trying to patch anyway<br class="calibre2"/>checking file /etc/updatedb.conf<br class="calibre2"/>Using Plan A...<br class="calibre2"/>Hunk #1 succeeded at 1.<br class="calibre2"/>done</pre>
<ol start="4" class="calibre20">
<li class="chapter">If we attempt to apply the patch to a file on a file that does not match, it will fail, like in the following output (if <kbd class="calibre17">--dry-run</kbd> is specified). If <kbd class="calibre17">--dry-run</kbd> is not specified, the failure will be stored in a reject file as is noted in this line: <kbd class="calibre17">1 out of 1 hunk FAILED -- saving rejects to file /home/rbrash/fileA.txt.rej</kbd>:</li>
</ol>
<pre class="calibre27">$ patch --verbose --dry-run /etc/updatedb.conf1 &lt; 001-myfirst-patch-for-updatedb.patch <br class="calibre2"/>Hmm... Looks like a unified diff to me...<br class="calibre2"/>The text leading up to this was:<br class="calibre2"/>--------------------------<br class="calibre2"/>|--- /etc/updatedb.conf 2014-11-18 02:54:29.000000000 -0500<br class="calibre2"/>|+++ /home/rbrash/updatedb-v2.conf 2017-12-11 15:26:33.172955754 -0500<br class="calibre2"/>--------------------------<br class="calibre2"/>checking file /etc/updatedb.conf1<br class="calibre2"/>Using Plan A...<br class="calibre2"/><strong class="calibre3">Hunk #1 FAILED at 1.</strong><br class="calibre2"/><strong class="calibre3">1 out of 1 hunk FAILED</strong><br class="calibre2"/>done<br class="calibre2"/>$<br class="calibre2"/>$ patch --verbose ~/fileA.txt &lt; 001-myfirst-patch-for-updatedb.patch <br class="calibre2"/>Hmm... Looks like a unified diff to me...<br class="calibre2"/>The text leading up to this was:<br class="calibre2"/>--------------------------<br class="calibre2"/>|--- /etc/updatedb.conf 2014-11-18 02:54:29.000000000 -0500<br class="calibre2"/>|+++ /home/rbrash/updatedb-v2.conf 2017-12-11 15:26:33.172955754 -0500<br class="calibre2"/>--------------------------<br class="calibre2"/>patching file /home/rbrash/fileA.txt<br class="calibre2"/>Using Plan A...<br class="calibre2"/>Hunk #1 FAILED at 1.<br class="calibre2"/>1 out of 1 hunk FAILED -- saving rejects to file <strong class="calibre3">/home/rbrash/fileA.txt.rej</strong><br class="calibre2"/>done</pre>


            </article>

            
        </section>
    </div>



  
<div id="sbo-rt-content" class="calibre1"><section class="calibre2">

                            <header class="calibre2">
                    <h1 class="header-title">Creating symbolic links and using them effectively</h1>
                </header>
            
            <article class="calibre2">
                
<p class="mce-root">Symbolic links mean shortcuts, right? Well, if you ever heard that explanation, it is only partially correct and they are present on most modern OS. In fact, there are two kinds of symbolic links when thinking in terms of files: hard and soft:</p>
<table border="1" class="calibre32">
<tbody class="calibre33">
<tr class="calibre34">
<td class="calibre35"><strong class="calibre3">Hard Links</strong></td>
<td class="calibre35"><strong class="calibre3">Soft Links</strong></td>
</tr>
<tr class="calibre36">
<td class="calibre35">Only link to files</td>
<td class="calibre35">Can link to directories and files</td>
</tr>
<tr class="calibre34">
<td class="calibre35">Link to contents on same disk</td>
<td class="calibre35">Can reference files/folders across disks or networks</td>
</tr>
<tr class="calibre36">
<td class="calibre35">Reference inode/physical locations</td>
<td class="calibre35">If the original file is deleted, the hard link will remain (in own inodes)</td>
</tr>
<tr class="calibre37">
<td class="calibre35">Moving a file will still allow the link to work</td>
<td class="calibre35">Links don't follow the reference file if moved</td>
</tr>
</tbody>
</table>
<p class="mce-root"> </p>
<p class="mce-root">A soft link will most likely match your expectations of a shortcut and the behavior might not be very surprising, but what use is a hard link? One of the most prominent cases of when to use a hard link is when you don't want to break a link by moving the file it points to! A soft link is clearly more flexible and can work across file systems, which is unlike hard links, but soft links won't work if a file is moved.</p>
<div class="packt_infobox">Besides creating shortcuts, you can do neat tricks like renaming <kbd class="calibre23">argv[0]</kbd> when using symbolic links. The Busybox shell is an example of that, where it contains <strong class="calibre3">applets</strong> that are executed by a symlink that points to <kbd class="calibre23">./busybox</kbd>. For example, <kbd class="calibre23">ls</kbd> points to the same binary as <kbd class="calibre23">cd</kbd>! All of them point to <kbd class="calibre23">./busybox</kbd>. This is a neat way to save space and improve run-time flags without the use of flags.</div>
<div class="packt_tip">Soft links are also used in the <kbd class="calibre23">/usr/lib</kbd> or <kbd class="calibre23">/lib</kbd> folders for shared <kbd class="calibre23">librarys</kbd>. In fact, symlinks are very useful for aliasing paths or getting software to work with hard-coded paths that are inside of the binaries themselves.</div>


            </article>

            
        </section>
    </div>



  
<div id="sbo-rt-content" class="calibre1"><section class="calibre2">

                            <header class="calibre2">
                    <h1 class="header-title">How to do it...</h1>
                </header>
            
            <article class="calibre2">
                
<ol class="calibre20">
<li class="chapter">Open a terminal, and create the <kbd class="calibre17">whoami.sh</kbd> script:</li>
</ol>
<pre class="calibre27">#!/bin/bash<br class="calibre2"/>VAR=$0<br class="calibre2"/>echo "I was ran as: $VAR"</pre>
<ol start="2" class="calibre20">
<li class="chapter">Execute <kbd class="calibre17">whoami.sh</kbd> and observe what has happened:</li>
</ol>
<pre class="calibre27">$ bash whoami.sh</pre>
<ol start="3" class="calibre20">
<li class="chapter">Next, create a soft link to <kbd class="calibre17">whoami.sh</kbd> using the <kbd class="calibre17">ln</kbd> command:</li>
</ol>
<pre class="calibre27">$ ln -s whoami.sh ghosts-there-be.sh</pre>
<ol start="4" class="calibre20">
<li class="chapter">Next, run <kbd class="calibre17">ls</kbd> <kbd class="calibre17">-la</kbd>. Notice any differences?</li>
</ol>
<pre class="calibre27">ls -la ghosts-there-be.sh whoami.sh </pre>
<ol start="5" class="calibre20">
<li class="chapter">On to hard links, which are created this way using <kbd class="calibre17">ln</kbd>:</li>
</ol>
<pre class="calibre27">$ ln ghosts-there-be.sh gentle-ghosts-there-be.sh<br class="calibre2"/>$ ln whoami.sh real-ghosts-there-be.sh</pre>
<ol start="6" class="calibre20">
<li class="chapter">Next, let's look at the difference in results when running the commands:</li>
</ol>
<pre class="calibre27">$ ls -la ghosts-there-be.sh whoami.sh real-ghosts-there-be.sh gentle-ghosts-there-be.sh <br class="calibre2"/>lrwxrwxrwx 1 rbrash rbrash 18 Dec 12 15:07 gentle-ghosts-there-be.sh -&gt; ghosts-there-be.sh<br class="calibre2"/>lrwxrwxrwx 1 rbrash rbrash 9 Dec 12 14:57 ghosts-there-be.sh -&gt; whoami.sh<br class="calibre2"/>-rw-rw-r-- 2 rbrash rbrash 45 Dec 12 14:56 real-ghosts-there-be.sh<br class="calibre2"/>-rw-rw-r-- 2 rbrash rbrash 45 Dec 12 14:56 whoami.sh<br class="calibre2"/>$ mv whoami.sh nobody.sh<br class="calibre2"/>$ bash ghosts-there-be.sh <br class="calibre2"/>bash: ghosts-there-be.sh: No such file or directory<br class="calibre2"/>$ bash real-ghosts-there-be.sh <br class="calibre2"/>I was ran as: real-ghosts-there-be.sh<br class="calibre2"/>$ bash gentle-ghosts-there-be.sh <br class="calibre2"/>bash: gentle-ghosts-there-be.sh: No such file or directory</pre>


            </article>

            
        </section>
    </div>



  
<div id="sbo-rt-content" class="calibre1"><section class="calibre2">

                            <header class="calibre2">
                    <h1 class="header-title">How it works...</h1>
                </header>
            
            <article class="calibre2">
                
<p class="mce-root">In step one, we created <kbd class="calibre17">whoami.sh</kbd>. It is similar to the <kbd class="calibre17">whoami</kbd> command, but different because we do not print the <kbd class="calibre17">$USER</kbd> variable, but rather argument <kbd class="calibre17">0</kbd> <kbd class="calibre17">(arg0</kbd>, as its typically known) or <kbd class="calibre17">$0</kbd>. In laymen's terms, we are printing out the name used to execute the code or script.</p>
<p class="mce-root">When we execute <kbd class="calibre17">whoami.sh</kbd>, it prints to the console:</p>
<pre class="calibre27">$ bash whoami.sh <br class="calibre2"/>I was ran as: whoami.sh</pre>
<p class="mce-root">To create a symbolic soft link, we use <kbd class="calibre17">ln</kbd> with the <kbd class="calibre17">-s</kbd> flag (for symbolic mode). The <kbd class="calibre17">ln</kbd> command expects to be executed in this way: <kbd class="calibre17">$ ln -s originalFileToBeLinkedTo newFileToLinkToOldFile</kbd>.</p>
<p class="mce-root">As we can see in the following code, executing <kbd class="calibre17">ghosts-there-be.sh</kbd> runs the code in <kbd class="calibre17">whoami.sh</kbd>, but <kbd class="calibre17">arg0</kbd> is <kbd class="calibre17">ghosts-there-be.sh</kbd>. Then, when the <kbd class="calibre17">ls</kbd> command is ran with the <kbd class="calibre17">-l -a</kbd> flags (<kbd class="calibre17">-la</kbd>), we can see the soft link to <kbd class="calibre17">whoami.sh</kbd>. Notice the small size of 9 bytes!</p>
<pre class="calibre27">$ bash ghosts-there-be.sh <br class="calibre2"/>I was ran as: ghosts-there-be.sh<br class="calibre2"/>$ ls -la ghosts-there-be.sh whoami.sh <br class="calibre2"/>lrwxrwxrwx 1 rbrash rbrash 9 Dec 12 14:57 ghosts-there-be.sh -&gt; whoami.sh<br class="calibre2"/>-rw-rw-r-- 1 rbrash rbrash 45 Dec 12 14:56 whoami.sh</pre>
<p class="mce-root">Next, we create a hard link by using the <kbd class="calibre17">ls</kbd> command without the <kbd class="calibre17">-s</kbd> flag.</p>
<p class="mce-root">The hard link, <kbd class="calibre17">real-ghosts-there-be.sh</kbd><span class="calibre16">,</span> runs the same content as <kbd class="calibre17">ghosts-there-be.sh</kbd>, but points to the actual contents of <kbd class="calibre17">whoami.sh</kbd>, even if it is moved and renamed as <kbd class="calibre17">nobody.sh</kbd>:</p>
<pre class="calibre27">$ ls -la ghosts-there-be.sh whoami.sh real-ghosts-there-be.sh gentle-ghosts-there-be.sh <br class="calibre2"/>lrwxrwxrwx 1 rbrash rbrash 18 Dec 12 15:07 gentle-ghosts-there-be.sh -&gt; ghosts-there-be.sh<br class="calibre2"/>lrwxrwxrwx 1 rbrash rbrash 9 Dec 12 14:57 ghosts-there-be.sh -&gt; whoami.sh<br class="calibre2"/>-rw-rw-r-- 2 rbrash rbrash 45 Dec 12 14:56 real-ghosts-there-be.sh<br class="calibre2"/>-rw-rw-r-- 2 rbrash rbrash 45 Dec 12 14:56 whoami.sh<br class="calibre2"/> mv whoami.sh nobody.sh<br class="calibre2"/>$ bash ghosts-there-be.sh <br class="calibre2"/>bash: ghosts-there-be.sh: No such file or directory<br class="calibre2"/>$ bash real-ghosts-there-be.sh <br class="calibre2"/>I was ran as: real-ghosts-there-be.sh<br class="calibre2"/>$ bash gentle-ghosts-there-be.sh <br class="calibre2"/>bash: gentle-ghosts-there-be.sh: No such file or directory <br class="calibre2"/>$ bash gentle-ghosts-there-be.sh <br class="calibre2"/>bash: gentle-ghosts-there-be.sh: No such file or directory</pre>


            </article>

            
        </section>
    </div>



  
<div id="sbo-rt-content" class="calibre1"><section class="calibre2">

                            <header class="calibre2">
                    <h1 class="header-title">Crawling filesystem directories and printing a tree</h1>
                </header>
            
            <article class="calibre2">
                
<p class="mce-root">At this point, we already know about the commands locate, find, and grep (plus regular expressions), but what about if we wanted to create our own naive implementation of a directory crawler/scraper/indexer? It certainly won't be the fastest or have optimizations, but we can use recursive functionality and file tests to print a tree-like structure.</p>
<div class="packt_infobox">This exercise is a bit of a fun exercise and certainly recreates the proverbial "wheel". This can be easily done by running the tree command, however, this will be useful in an upcoming exercise when we'll be building arrays of arrays for files.</div>


            </article>

            
        </section>
    </div>



  
<div id="sbo-rt-content" class="calibre1"><section class="calibre2">

                            <header class="calibre2">
                    <h1 class="header-title">Getting ready</h1>
                </header>
            
            <article class="calibre2">
                
<p class="mce-root">Besides having a terminal open, let's create some test data:</p>
<pre class="calibre22">$ mkdir -p parentdir/child_with_kids<br class="calibre2"/>$ mkdir -p parentdir/second_child_with_kids<br class="calibre2"/>$ mkdir -p parentdir/child_with_kids/grand_kid/<br class="calibre2"/>$ touch parentdir/child.txt parentdir/child_with_kids/child.txt parentdir/child_with_kids/grand_kid/gkid1.txt<br class="calibre2"/>$ touch parentdir/second_child_with_kids/cousin1.txt parentdir/z_child.txt parentdir/child.txt parentdir/child2.txt</pre>


            </article>

            
        </section>
    </div>



  
<div id="sbo-rt-content" class="calibre1"><section class="calibre2">

                            <header class="calibre2">
                    <h1 class="header-title">How to do it...</h1>
                </header>
            
            <article class="calibre2">
                
<ol class="calibre20">
<li class="chapter">Open a terminal and create the <kbd class="calibre17">mytree.sh</kbd> script:</li>
</ol>
<pre class="calibre27">#!/bin/bash<br class="calibre2"/>CURRENT_LVL=0<br class="calibre2"/><br class="calibre2"/>function tab_creator() {<br class="calibre2"/>  <br class="calibre2"/>  local X=0<br class="calibre2"/>  local LVL=$1<br class="calibre2"/>  local TABS="."<br class="calibre2"/>  while [ $X -lt $LVL ]<br class="calibre2"/>  do<br class="calibre2"/>    # Concatonate strings<br class="calibre2"/>    TABS="${TABS}${TABS}"<br class="calibre2"/>    X=$[$X+1]<br class="calibre2"/>  done<br class="calibre2"/>  echo -en "$TABS"<br class="calibre2"/>}<br class="calibre2"/>function recursive_tree() {<br class="calibre2"/><br class="calibre2"/>  local ENTRY=$1<br class="calibre2"/>  for LEAF in ${ENTRY}/*<br class="calibre2"/>  do<br class="calibre2"/>    if [ -d $LEAF ];then<br class="calibre2"/>      # If LEAF is a directory &amp; not empty<br class="calibre2"/>      TABS=$(tab_creator $CURRENT_LVL)<br class="calibre2"/>      printf "%s\_ %s\n" "$TABS" "$LEAF" <br class="calibre2"/>      CURRENT_LVL=$(( CURRENT_LVL + 1 ))<br class="calibre2"/>      recursive_tree $LEAF $CURRENT_LVL<br class="calibre2"/>      CURRENT_LVL=$(( CURRENT_LVL - 1 ))<br class="calibre2"/>    elif [ -f $LEAF ];then<br class="calibre2"/>      # Print only the bar and not the backwards slash<br class="calibre2"/>      # And only if a file<br class="calibre2"/>      TABS=$(tab_creator $CURRENT_LVL)<br class="calibre2"/>      printf "%s|_%s\n" "$TABS" "$LEAF" <br class="calibre2"/>      continue<br class="calibre2"/>    fi<br class="calibre2"/>  <br class="calibre2"/>  done<br class="calibre2"/>}<br class="calibre2"/><br class="calibre2"/>PARENTDIR=$1<br class="calibre2"/>recursive_tree $PARENTDIR 1</pre>
<ol start="2" class="calibre20">
<li class="chapter">In your terminal, now run:</li>
</ol>
<pre class="calibre27">$ bash mytree.sh parentdir </pre>


            </article>

            
        </section>
    </div>



  
<div id="sbo-rt-content" class="calibre1"><section class="calibre2">

                            <header class="calibre2">
                    <h1 class="header-title">How it works...</h1>
                </header>
            
            <article class="calibre2">
                
<p class="mce-root">The creation of <kbd class="calibre17">mytree.sh</kbd> is a trivial task, but the logic inside follows recursive functions. There is also the concept of <kbd class="calibre17">${CURRENT_LVL}</kbd>, which is used to produce the number of periods (or levels) deep the script is from its original starting point: <strong class="calibre6">parentdir</strong>. In each directory, we create a for loop to test each file/directory inside of it. The logic tests whether the entry is either a file or a director. If it is a directory, we increment <kbd class="calibre17">${CURRENT_LVL}</kbd> and then <strong class="calibre6">recursively</strong> execute the <strong class="calibre6">same</strong> logic inside of the <kbd class="calibre17">recursive_tree</kbd> function until done and then return. If the logic is a file, we merely print out and <strong class="calibre6">continue</strong>. The <kbd class="calibre17">tab_creator</kbd> <span class="calibre16">function</span> makes the variable string for the periods based on <kbd class="calibre17">${CURRENT_LVL}</kbd> and concatenation.</p>
<p class="mce-root">Executing the script should produce an output similar to the following, but notice how the script remembers how many layers deep it might be, and that the directories are shown with a <kbd class="calibre17">\_</kbd> instead of <kbd class="calibre17">|_</kbd>:</p>
<pre class="calibre27">$ bash mytree.sh parentdir<br class="calibre2"/>.|_parentdir/child2.txt<br class="calibre2"/>.|_parentdir/child.txt<br class="calibre2"/>.\_ parentdir/child_with_kids<br class="calibre2"/>..|_parentdir/child_with_kids/child.txt<br class="calibre2"/>..\_ parentdir/child_with_kids/grand_kid<br class="calibre2"/>....|_parentdir/child_with_kids/grand_kid/gkid1.txt<br class="calibre2"/>.\_ parentdir/empty_dir<br class="calibre2"/>.\_ parentdir/second_child_with_kids<br class="calibre2"/>..|_parentdir/second_child_with_kids/cousin1.txt<br class="calibre2"/>.|_parentdir/z_child.txt</pre>


            </article>

            
        </section>
    </div>



  
<div id="sbo-rt-content" class="calibre1"><section class="calibre2">

                            <header class="calibre2">
                    <h1 class="header-title">Finding and deleting duplicate files or directories</h1>
                </header>
            
            <article class="calibre2">
                
<p class="mce-root">At one point, we had already talked about checking to see if strings inside of a file were unique and if we could sort them, but we haven't yet performed a similar operation on files. However, before diving in, let's make some assumptions about what constitutes a duplicate file for the purpose of this recipe: a duplicate file is one that may have a different name, but the same contents as another.</p>
<p class="mce-root">One way to investigate the contents of a file would be to remove all white space and purely check the strings contained within, or we could merely use tools such as <span class="calibre16"><strong class="calibre6">SHA</strong></span><strong class="calibre6">512sum</strong> and <span class="calibre16"><strong class="calibre6">MD</strong></span><strong class="calibre6">5sum</strong> to generate a unique hash (think unique string full of gibberish) of the contents of the files. The general flow would be as follows:</p>
<ol class="calibre20">
<li class="chapter">Using this hash, we can compare the hash against a list of hashes already computed.</li>
<li class="chapter">If the has matches, we have seen the contents of this file before and so we can delete it.</li>
<li class="chapter">If the hash is new, we can record the entry and move onto calculating the hash of the next file until all files have been <em class="calibre26">hashed.</em></li>
</ol>
<div class="packt_infobox">Using a hash does not require you to know how the mathematics work, but rather to be aware of how it's supposed to work IF it is a secure implementation and has enough possibilities to make finding a duplicate computationally unfeasible. Hashes are supposed to be one way, which means that they are different from encryption/decryption so that once a hash has been created, it should be impossible to determine the original input from the hash itself.<br class="calibre2"/>
MD5sums are considered completely insecure (although useful where security may be less needed), and SHA1/2 are considered to be potentially on their way out of popularity with the use of SPONGE algorithms in SHA3 (use SHA3 where possible). For more information, please see the <a href="https://csrc.nist.gov/Projects/Hash-Functions" class="calibre25 pcalibre pcalibre3 pcalibre2 pcalibre1">NIST guidelines</a>.</div>


            </article>

            
        </section>
    </div>



  
<div id="sbo-rt-content" class="calibre1"><section class="calibre2">

                            <header class="calibre2">
                    <h1 class="header-title">Getting ready</h1>
                </header>
            
            <article class="calibre2">
                
<p class="mce-root">Open a terminal and create a data set consisting of several files with the <kbd class="calibre17">dsetmkr.sh</kbd> script:</p>
<pre class="calibre22">$ #!/bin/bash<br class="calibre2"/>BDIR="files_galore"<br class="calibre2"/>rm -rf ${BDIR}<br class="calibre2"/>mkdir -p ${BDIR}<br class="calibre2"/><br class="calibre2"/>touch $BDIR/file1; echo "1111111111111111111111111111111" &gt; $BDIR/file1;<br class="calibre2"/>touch $BDIR/file2; echo "2222222222222222222222222222222" &gt; $BDIR/file2;<br class="calibre2"/>touch $BDIR/file3; echo "3333333333333333333333333333333" &gt; $BDIR/file3;<br class="calibre2"/>touch $BDIR/file4; echo "4444444444444444444444444444444" &gt; $BDIR/file4;<br class="calibre2"/>touch $BDIR/file5; echo "4444444444444444444444444444444" &gt; $BDIR/file5;<br class="calibre2"/>touch $BDIR/sameas5; echo "4444444444444444444444444444444" &gt; $BDIR/sameas5;<br class="calibre2"/>touch $BDIR/sameas1; echo "1111111111111111111111111111111" &gt; $BDIR/sameas1;</pre>
<p class="mce-root">Then, before jumping into scripting, a core concept needs to be discussed regarding arrays and whether they are static or dynamic; knowing how an array implementation works at its core is a key principle if performance is an objective.</p>
<p class="mce-root">Arrays can be really helpful, but the performance of a Bash script is often sub-par to that of a compiled program or even choosing a language with the appropriate data structures. In Bash, arrays are linked lists and dynamic, which means that if you resize the array, there isn't a massive performance penalty.</p>
<p class="mce-root">For our purposes, we are going to create a dynamic array and once the array becomes quite large, it will be the searching of the array which becomes the performance bottleneck. This naive iterative approach usually works well up to an arbitrary amount (let's say, <kbd class="calibre17">N</kbd>), and at which the benefits of using another mechanism may outweigh the simplicity of the current approach. For those who want to know more about data structures and the performance of them, check out Big O notation and complexity theory.</p>


            </article>

            
        </section>
    </div>



  
<div id="sbo-rt-content" class="calibre1"><section class="calibre2">

                            <header class="calibre2">
                    <h1 class="header-title">How to do it...</h1>
                </header>
            
            <article class="calibre2">
                
<ol class="calibre20">
<li class="chapter">Open a terminal, and create the <kbd class="calibre17">file-deduplicator.sh</kbd> script.</li>
</ol>
<p class="mce-root1">The following is a code snippet of the script:</p>
<pre class="calibre27">#!/bin/bash<br class="calibre2"/><br class="calibre2"/>declare -a FILE_ARRAY=()<br class="calibre2"/><br class="calibre2"/>function add_file() {<br class="calibre2"/>  # echo $2 $1<br class="calibre2"/>  local NUM_OR_ELEMENTS=${#FILE_ARRAY[@]}<br class="calibre2"/>  FILE_ARRAY[$NUM_OR_ELEMENTS+1]=$1<br class="calibre2"/>}<br class="calibre2"/><br class="calibre2"/>function del_file() {<br class="calibre2"/>  rm "$1" 2&gt;/dev/null<br class="calibre2"/>}</pre>
<ol start="2" class="calibre20">
<li class="chapter">Run the <kbd class="calibre17">setup</kbd> command if not already: run <kbd class="calibre17">$ bash dsetmkr.sh</kbd> and then run <kbd class="calibre17">$ bash ./file-deduplicator.sh</kbd>. Enter <kbd class="calibre17">files_galore/</kbd> at the prompt and press <em class="calibre26">Enter</em>:</li>
</ol>
<pre class="calibre27">$ bash dsetmkr.sh <br class="calibre2"/>$ bash file-deduplicator.sh<br class="calibre2"/>Enter directory name to being searching and deduplicating:<br class="calibre2"/>Press [ENTER] when ready<br class="calibre2"/><br class="calibre2"/>files_galore/<br class="calibre2"/>#1 f559f33eee087ea5ac75b2639332e97512f305fc646cf422675927d4147500d4c4aa573bd3585bb866799d08c373c0427ece87b60a5c42dbee9c011640e04d75<br class="calibre2"/>#2 f7559990a03f2479bf49c85cb215daf60417cb59875b875a8a517c069716eb9417dfdb907e50c0fd5bd47127105b7df9e68a0c45a907dc5254ce6bc64d7ec82a<br class="calibre2"/>#3 2811ce292f38147613a84fdb406ef921929f864a627f78ef0ef16271d4996ed598d0f5c5f410f7ae75f9902ff0f63126b567e5f24882db3686be81f2a79f1bb3<br class="calibre2"/>#4 89f5df2b9f4908adca6a36f92b344d4a8ff96d04184e99d8dd31a86e96d45a1aa16a8b574d5815f17d649d521c9472670441a56f54dc1c2640e20567581d9b4e</pre>
<ol start="3" class="calibre20">
<li class="chapter">Review the results and verify the contents of <kbd class="calibre17">files_galore</kbd>.</li>
</ol>
<pre class="calibre27">$ ls files_galore/</pre>


            </article>

            
        </section>
    </div>



  
<div id="sbo-rt-content" class="calibre1"><section class="calibre2">

                            <header class="calibre2">
                    <h1 class="header-title">How it works...</h1>
                </header>
            
            <article class="calibre2">
                
<p class="mce-root">Before getting started, a proceeding note of caution: the <kbd class="calibre17">file-deduplicator.sh</kbd> script deletes duplicate files in the directory it is targeted at.</p>
<ol class="calibre20">
<li class="chapter">Getting started (especially using the <kbd class="calibre17">dsetmkr.sh</kbd> script), we will produce a directory called <kbd class="calibre17">files_galore</kbd> that also contains several files: four are unique and three contain duplicate content:</li>
</ol>
<pre class="calibre27">$ bash dsetmkr.sh </pre>
<div class="packt_infobox"><span class="calibre11">The study of cryptography, security, and mathematics are all very interesting and broad information domains! Hashes have a multitude of other uses such as integrity checking of files, lookup values to find data quickly, unique identifiers, and much more.</span></div>
<ol start="2" class="calibre20">
<li class="chapter">When you run <kbd class="calibre17">file-deduplicator.sh</kbd>, it begins by asking the user for input using <kbd class="calibre17">read</kbd> and then it prints out four different values with seemingly random strings of characters. <em class="calibre26">Random</em> looking is absolutely correct—they are SHA512 hash sums! Each string is the sum of the contents inside of it. Even if the contents are even slightly different (for example, one bit has been flipped to a <kbd class="calibre17">1</kbd> instead of a <kbd class="calibre17">0</kbd>), then a totally different hash sum will be produced. Again, this bash script leverages a foreign concept of arrays (using a global array variable meaning accessible everywhere in the script) and hash sums using the <strong class="calibre3">SHA512sum</strong> tool combined with <strong class="calibre3">awk</strong> to retrieve the correct values. This script is not recursive though, and only looks at the files inside of <kbd class="calibre17">files_galore</kbd> to generate a list of files, a hash for each one, and search an array containing all <em class="calibre26">known</em> hashes. If a hash is unknown, then it is a new file and is inserted into the array for storage. Otherwise, if a hash is seen twice, the file is deleted because it contains DUPLICATE content (even if the file name is different). There is another aspect here, and that is the use of return values as strings. As you may remember, return only can return numeric values:</li>
</ol>
<pre class="calibre27"><br class="calibre2"/>$ bash file-deduplicator.sh <br class="calibre2"/>Enter directory name to being searching and deduplicating:<br class="calibre2"/>Press [ENTER] when ready<br class="calibre2"/><br class="calibre2"/>files_galore/<br class="calibre2"/>#1 f559f33eee087ea5ac75b2639332e97512f305fc646cf422675927d4147500d4c4aa573bd3585bb866799d08c373c0427ece87b60a5c42dbee9c011640e04d75<br class="calibre2"/>#2 f7559990a03f2479bf49c85cb215daf60417cb59875b875a8a517c069716eb9417dfdb907e50c0fd5bd47127105b7df9e68a0c45a907dc5254ce6bc64d7ec82a<br class="calibre2"/>#3 2811ce292f38147613a84fdb406ef921929f864a627f78ef0ef16271d4996ed598d0f5c5f410f7ae75f9902ff0f63126b567e5f24882db3686be81f2a79f1bb3<br class="calibre2"/>#4 89f5df2b9f4908adca6a36f92b344d4a8ff96d04184e99d8dd31a86e96d45a1aa16a8b574d5815f17d649d521c9472670441a56f54dc1c2640e20567581d9b4e</pre>
<ol start="3" class="calibre20">
<li class="chapter">After executing the operation, we can see that the <kbd class="calibre17">files_galore</kbd> directory only contains four files out of the original seven. The duplicate data is now removed!</li>
</ol>
<pre class="calibre27">$ ls files_galore/<br class="calibre2"/>file1 file2 file3 file4</pre>


            </article>

            
        </section>
    </div>



  
<div id="sbo-rt-content" class="calibre1"><section class="calibre2">

                            <header class="calibre2">
                    <h1 class="header-title">Joining and splitting files at arbitrary positions</h1>
                </header>
            
            <article class="calibre2">
                
<p class="mce-root">Let's not be shy! Who has tried to open a large file by accident or even intentionally with an application and it didn't quite go as planned? I certainly have, and I have certainly seen the limitations such as the number of rows loaded in Excel, or OpenOffice calculator. In these cases, we use a handy tool that can split files at arbitrary points, such as the following:</p>
<ul class="calibre13">
<li class="calibre14">Before X number of lines</li>
<li class="calibre14">Before Z number of bytes/chars</li>
</ul>
<p class="mce-root">In this recipe, you will create a singe dual purpose script: a script that can use an input file and produce <em class="calibre18">split</em> or multiple files, and a second script to join files using a combining method. There are a few caveats when passing around string variables as they:</p>
<ul class="calibre13">
<li class="calibre14">Can sometimes lose special characters such as new lines</li>
<li class="calibre14">(Binary) Should be handled by different tools than the usual commands on the command line</li>
</ul>
<p class="mce-root">This file also reuses the <kbd class="calibre17">getopts</kbd> parameter parsing we saw earlier in Chapter 1, <em class="calibre18">Crash Course in Bash</em>, but it also introduces the <kbd class="calibre17">mktemp</kbd> command and the <kbd class="calibre17">getconf</kbd> command with the <kbd class="calibre17">PAGESIZE</kbd> parameter. <kbd class="calibre17">Mktemp</kbd> is a useful command because it can produce unique temporary files that reside in the <kbd class="calibre17">/tmp</kbd> directory, but can even produce unique files that follow a template (notice the <kbd class="calibre17">XXX</kbd><span class="calibre16">—</span>this will be replaced with random values, but <kbd class="calibre17">uniquefile.</kbd> will remain):</p>
<pre class="calibre22">$ mktemp uniquefile.XXXX</pre>
<p class="mce-root">Another useful command is the <kbd class="calibre17">getconf</kbd> programming utility, which is a standards compliant tool designed to fetch useful system variables. One in particular called <kbd class="calibre17">PAGESIZE</kbd> is useful to determine the size of memory in one block. Obviously, this is in very simplistic terms, but choosing the appropriate size to write data can be very beneficial performance-wise.</p>


            </article>

            
        </section>
    </div>



  
<div id="sbo-rt-content" class="calibre1"><section class="calibre2">

                            <header class="calibre2">
                    <h1 class="header-title">Getting ready</h1>
                </header>
            
            <article class="calibre2">
                
<p class="mce-root">Besides having a terminal open, a single text file called <kbd class="calibre17">input-lines</kbd> needs to be created with the following content (one character on each line):</p>
<pre class="calibre22">1<br class="calibre2"/>2<br class="calibre2"/>3<br class="calibre2"/>4<br class="calibre2"/>5<br class="calibre2"/>6<br class="calibre2"/>7<br class="calibre2"/>8<br class="calibre2"/>9<br class="calibre2"/>0<br class="calibre2"/>a<br class="calibre2"/>b<br class="calibre2"/>c<br class="calibre2"/>d<br class="calibre2"/>e<br class="calibre2"/>f<br class="calibre2"/>g<br class="calibre2"/>h<br class="calibre2"/>i<br class="calibre2"/>j<br class="calibre2"/>k</pre>
<p class="mce-root">Next, create a second file called <kbd class="calibre17">merge-lines</kbd> with the following content:</p>
<pre class="calibre22">It's -17 outside</pre>


            </article>

            
        </section>
    </div>



  
<div id="sbo-rt-content" class="calibre1"><section class="calibre2">

                            <header class="calibre2">
                    <h1 class="header-title">How to do it...</h1>
                </header>
            
            <article class="calibre2">
                
<p class="mce-root">Open a terminal and create a script named <kbd class="calibre17">file-splitter.sh</kbd>.</p>
<p class="mce-root">The following is the code snippet:</p>
<pre class="calibre27">#!/bin/bash<br class="calibre2"/>FNAME=""<br class="calibre2"/>LEN=10<br class="calibre2"/>TYPE="line" <br class="calibre2"/>OPT_ERROR=0<br class="calibre2"/>set -f<br class="calibre2"/><br class="calibre2"/>function determine_type_of_file() {<br class="calibre2"/>  local FILE="$1"<br class="calibre2"/>  file -b "${FILE}" | grep "ASCII text" &gt; /dev/null<br class="calibre2"/>  RES=$?<br class="calibre2"/>  if [ $RES -eq 0 ]; then<br class="calibre2"/>    echo "ASCII file - continuing"<br class="calibre2"/>    <br class="calibre2"/>  else<br class="calibre2"/>    echo "Not an ASCII file, perhaps it is Binary?"<br class="calibre2"/>  fi <br class="calibre2"/>}</pre>
<p class="mce-root">Next, run <kbd class="calibre17">file-splitter.sh</kbd> with this command and flags ( <kbd class="calibre17">-i</kbd>, <kbd class="calibre17">-t</kbd>, <kbd class="calibre17">-l</kbd>):</p>
<pre class="calibre27">$ bash file-splitter.sh -i input-lines -t line -l 10</pre>
<p class="mce-root">Review the output and see what the difference is with <kbd class="calibre17">-t size</kbd> and when <kbd class="calibre17">-l line</kbd> is used. What about when <kbd class="calibre17">-l 1</kbd> or <kbd class="calibre17">-l 100</kbd> is used? Remember to remove the split files using <kbd class="calibre17">$ rm input-lines.*</kbd>:</p>
<pre class="calibre27">$ rm input-lines.*<br class="calibre2"/>$ bash file-splitter.sh -i input-lines -t line -l 10<br class="calibre2"/>$ rm input-lines.*<br class="calibre2"/>$ bash file-splitter.sh -i input-lines -t line -l 1<br class="calibre2"/>$ rm input-lines.*<br class="calibre2"/>$ bash file-splitter.sh -i input-lines -t line -l 100<br class="calibre2"/>$ rm input-lines.*<br class="calibre2"/>$ bash file-splitter.sh -i input-lines -t size -l 10</pre>
<p class="mce-root">In the next step, create another script called <kbd class="calibre17">file-joiner.sh</kbd>.</p>
<p class="mce-root">The following is the code snippet:</p>
<pre class="calibre27">#!/bin/bash<br class="calibre2"/>INAME=""<br class="calibre2"/>ONAME=""<br class="calibre2"/>FNAME=""<br class="calibre2"/>WHERE=""<br class="calibre2"/>OPT_ERROR=0<br class="calibre2"/><br class="calibre2"/>TMPFILE1=$(mktemp)<br class="calibre2"/><br class="calibre2"/>function determine_type_of_file() {<br class="calibre2"/>  local FILE="$1"<br class="calibre2"/>  file -b "${FILE}" | grep "ASCII text" &gt; /dev/null<br class="calibre2"/>  RES=$?<br class="calibre2"/>  if [ $RES -eq 0 ]; then<br class="calibre2"/>    echo "ASCII file - continuing"<br class="calibre2"/>    <br class="calibre2"/>  else<br class="calibre2"/>    echo "Not an ASCII file, perhaps it is Binary?"<br class="calibre2"/>  fi <br class="calibre2"/>}</pre>
<p class="mce-root">Next, run the script using this command:</p>
<pre class="calibre27">$ bash file-joiner.sh -i input-lines -o merge-lines -f final-join.txt -w 2</pre>


            </article>

            
        </section>
    </div>



  
<div id="sbo-rt-content" class="calibre1"><section class="calibre2">

                            <header class="calibre2">
                    <h1 class="header-title">How it works...</h1>
                </header>
            
            <article class="calibre2">
                
<p class="mce-root">Before proceeding, notice that the type option (<kbd class="calibre17">-t</kbd>) on <kbd class="calibre17">final-join.txt</kbd> ignores <kbd class="calibre17">\n</kbd> newlines when reading in characters one at a time. Read suffices for the purpose of this recipe, but the reader should be aware that read/cat are not the best tools for this type of work.</p>
<ol class="calibre20">
<li class="chapter">Creating the script was trivial and for the most part shouldn't look like it came from the planet Mars.</li>
<li class="chapter">Running the <kbd class="calibre17">$ bash file-splitter.sh -i input-lines -t line -l 10</kbd> command should produce three files, all of which are input-lines {1,...,3}. The reason that there is three files is that if you used the same input, which is 22 lines long, it will produce three files (10+10+2). Using read and echo using a concatenated buffer (<kbd class="calibre17">${BUFFER}</kbd>), we can write to the file based on a specific criteria (provided by <kbd class="calibre17">-l</kbd>). If the <strong class="calibre3">EOF</strong> or end of file is met and the done loop is done, we need to write the buffer to the file because it may be under the threshold of the write criteria—this would result in lost/missing bytes in the last file created by the <kbd class="calibre17">splitter</kbd> script:</li>
</ol>
<pre class="calibre27"><span class="calibre11">$ bash file-splitter.sh -i input-lines -t line -l 10</span><br class="calibre2"/>ASCII file - continuing<br class="calibre2"/>Wrote buffer to file: input-lines.1<br class="calibre2"/>Wrote buffer to file: input-lines.2<br class="calibre2"/>Wrote buffer to file: input-lines.3</pre>
<ol start="3" class="calibre20">
<li class="chapter">Depending on the usage of the <kbd class="calibre17">-l</kbd> flag, the value of <kbd class="calibre17">1</kbd> will produce a file for every line, and the value of 100 will produce a single file because if fits under the threshold. Using the side-feature <kbd class="calibre17">-t size</kbd>, which can be used to split based on bytes, read has an unfortunate side effect: when we pass the buffer, it is altered and the new lines are missing. This sort of activity would be better if we used a tool such as <kbd class="calibre17">dd</kbd>, which is better for copying, writing, and creating raw data to files or devices.</li>
</ol>
<p class="mce-root"> </p>
<ol start="4" class="calibre20">
<li class="chapter">Next, we created the script called <kbd class="calibre17">file-joiners.sh</kbd>. Again, it used <kbd class="calibre17">getopts</kbd> and requires four input parameters: <kbd class="calibre17">-i originalFile -o</kbd>, <kbd class="calibre17">otherFileToMerge -f</kbd>, <kbd class="calibre17">finalMergedFile -w</kbd>, and <kbd class="calibre17">whereInjectTheOtherFile</kbd><span class="calibre11">. The script is simpler overall, but uses the <kbd class="calibre17">mktemp</kbd> command to create a temporary file which we can use as a storage buffer without modifying the originals. When we are finished, we can use the <kbd class="calibre17">mv</kbd> command to move the file from <kbd class="calibre17">/tmp</kbd> to the terminal's current directory (<kbd class="calibre17">.</kbd>). The <kbd class="calibre17">mv</kbd> command can also be used to rename files and is usually faster than <kbd class="calibre17">cp</kbd> (not so much in this case) because a copy does not occur, rather just a renaming operation at the file system level.</span></li>
<li class="chapter">Catting <kbd class="calibre17">final-join.txt</kbd> should contain the following output:</li>
</ol>
<pre class="calibre27">$ cat final-join.txt <br class="calibre2"/>1<br class="calibre2"/>2<br class="calibre2"/>It's -17 outside<br class="calibre2"/>3<br class="calibre2"/>4<br class="calibre2"/>5<br class="calibre2"/>6<br class="calibre2"/>7<br class="calibre2"/>8<br class="calibre2"/>9<br class="calibre2"/>0<br class="calibre2"/>a<br class="calibre2"/>b<br class="calibre2"/>c<br class="calibre2"/>d<br class="calibre2"/>e<br class="calibre2"/>f<br class="calibre2"/>g<br class="calibre2"/>h<br class="calibre2"/>i<br class="calibre2"/>j<br class="calibre2"/>k<br class="calibre2"/><br class="calibre2"/></pre>


            </article>

            
        </section>
    </div>



  
<div id="sbo-rt-content" class="calibre1"><section class="calibre2">

                            <header class="calibre2">
                    <h1 class="header-title">Generating datasets and random files of various size</h1>
                </header>
            
            <article class="calibre2">
                
<p class="mce-root">Usually, data that mimics real-world data is always the best, but sometimes we need an assortment of files of various content and size for validation testing without delay. Imagine that you have a web server and it is running some sort of application that accepts files for storage. However, the files have a size limit being enforced. Wouldn't it be great to just <em class="calibre18">whip up</em> a batch of files in an instant?</p>
<p class="mce-root">To do this, we can use some few file system features such as <kbd class="calibre17">/dev/random</kbd> and a useful program called <kbd class="calibre17">dd</kbd>. The <kbd class="calibre17">dd</kbd> command is a utility that can be used to convert and copy files (including devices due to Linux's concept of everything is a file, more or less). It can be used in a later recipe to back up data on an SD card (remember your favorite Raspberry Pi project?) or to "chomp" through files byte by byte without losses. Typical minimal dd usage can be <kbd class="calibre17">$ dd if="inputFile" of="outputFile" bs=1M count=10</kbd>. From this command, we can see:</p>
<ul class="calibre13">
<li class="calibre14"><kbd class="calibre17">if=</kbd>: Stands for input file</li>
<li class="calibre14"><kbd class="calibre17">of=</kbd>: Stands for output file</li>
<li class="calibre14"><kbd class="calibre17">bs=</kbd>: Stands for block size</li>
<li class="calibre14"><kbd class="calibre17">count=</kbd>: Stands for numbers of blocks to be copied</li>
</ul>
<p class="mce-root">Options <kbd class="calibre17">bs=</kbd> and <kbd class="calibre17">count=</kbd> are optional if you want to perform a 1:1 (pure duplicate) copy of a file because <kbd class="calibre17">dd</kbd> will attempt to use reasonably efficient parameters to provide adequate performance. The dd command also has a number of other options such as <kbd class="calibre17">seek=</kbd>, which will be explored later when performing low-level backups in another recipe. The count option is typically not needed as it's far more common to copy an entire file instead of a section (when performing backups).</p>
<div class="packt_infobox"><kbd class="calibre23">/dev/random</kbd> is a device in Linux (hence the <kbd class="calibre23">/dev</kbd> path) which can be used to produce random numbers for use in your scripts or applications. There are also other <kbd class="calibre23">/dev</kbd> paths such as the console and various adaptors (for example, USB sticks or mice), all of which may be accessible, and gaining knowledge of them is recommended.</div>


            </article>

            
        </section>
    </div>



  
<div id="sbo-rt-content" class="calibre1"><section class="calibre2">

                            <header class="calibre2">
                    <h1 class="header-title">Getting ready</h1>
                </header>
            
            <article class="calibre2">
                
<p class="mce-root">To get ready for this recipe, install the <kbd class="calibre17">dd</kbd> command as follows and make a new directory called <kbd class="calibre17">qa-data/</kbd>:</p>
<pre class="calibre22">$ sudo apt-get install dd bsdmainutils<br class="calibre2"/>$ mkdir qa-data</pre>
<p class="mce-root">This recipe uses the <kbd class="calibre17">dmesg</kbd> command, which is used to return system information such as interface status or the system boot process. It is nearly always present on a system and therefore a good substitute to reasonable system level "lorem ipsum". If you wish to use another type of random text, or a dictionary of words, <kbd class="calibre17">dmesg</kbd> can easily be replaced! Another two commands used are <kbd class="calibre17">seq</kbd> and <kbd class="calibre17">hexdump.</kbd> The <strong class="calibre6"><kbd class="calibre17">seq</kbd></strong> command can generate an array of <em class="calibre18">n</em> numbers from a starting point using a specified increment, and <kbd class="calibre17">hexdump</kbd> produces a human readable representation of a binary (or executable) in hexadecimal format.</p>


            </article>

            
        </section>
    </div>



  
<div id="sbo-rt-content" class="calibre1"><section class="calibre2">

                            <header class="calibre2">
                    <h1 class="header-title">How to do it...</h1>
                </header>
            
            <article class="calibre2">
                
<p class="mce-root">Open a terminal and create a new script called <kbd class="calibre17">data-maker.sh</kbd>.</p>
<p class="mce-root">The following is the code snippet of the script:</p>
<pre class="calibre27">#!/bin/bash<br class="calibre2"/><br class="calibre2"/>N_FILES=3<br class="calibre2"/>TYPE=binary<br class="calibre2"/>DIRECTORY="qa-data"<br class="calibre2"/>NAME="garbage"<br class="calibre2"/>EXT=".bin"<br class="calibre2"/>UNIT="M"<br class="calibre2"/>RANDOM=$$<br class="calibre2"/>TMP_FILE="/tmp/tmp.datamaker.sh"<br class="calibre2"/><br class="calibre2"/>function get_random_number() { <br class="calibre2"/>  SEED=$(($(date +%s%N)/100000))<br class="calibre2"/>  RANDOM=$SEED<br class="calibre2"/>  # Sleep is needed to make sure that the next time rnadom is ran, everything is good.<br class="calibre2"/>  sleep 3<br class="calibre2"/>  local STEP=$1<br class="calibre2"/>  local VARIANCE=$2<br class="calibre2"/>  local UPPER=$3<br class="calibre2"/>  local LOWER=$VARIANCE<br class="calibre2"/>  local ARR;<br class="calibre2"/>  <br class="calibre2"/>  INC=0<br class="calibre2"/>  for N in $( seq ${LOWER} ${STEP} ${UPPER} ); <br class="calibre2"/>  do<br class="calibre2"/>    ARR[$INC]=$N<br class="calibre2"/>    INC=$(($INC+1))<br class="calibre2"/>  done<br class="calibre2"/>  <br class="calibre2"/>  RAND=$[$RANDOM % ${#ARR[@]}]<br class="calibre2"/>  echo $RAND<br class="calibre2"/>}</pre>
<p class="mce-root">Let's begin the execution of the script using the following command. It uses the <kbd class="calibre17">-t</kbd> flag for type and is set to <kbd class="calibre17">text</kbd>, <kbd class="calibre17">-n</kbd> is used for the number of files, which is <kbd class="calibre17">5</kbd>, <kbd class="calibre17">-l</kbd> is the lower bound: 1 characters, and -u is <kbd class="calibre17">1000</kbd> characters:</p>
<pre class="calibre27">$ bash data-maker.sh -t text -n 5 -l 1 -u 1000</pre>
<p class="mce-root">To checkout the output, use the following command:</p>
<pre class="calibre27">$ ls -la qa-data/*.txt<br class="calibre2"/>$ tail qa-data/garbage4.txt</pre>
<p class="mce-root">Again, let's run the <kbd class="calibre17">data-maker.sh</kbd> script, but for binary files. Instead of the size limits being 1 char (1 byte) or <kbd class="calibre17">1000</kbd> chars (<kbd class="calibre17">1000</kbd> bytes or just less than one kilobyte), the sizes are in MB, with there being <kbd class="calibre17">1</kbd>-<kbd class="calibre17">10</kbd> MB files:</p>
<pre class="calibre27">$ bash data-maker.sh -t binary -n 5 -l 1 -u 10</pre>
<p class="mce-root">To check out the output, use the following command. The use of a new command called <kbd class="calibre17">hexdump</kbd> is because we cannot "dump" or "cat" a binary file the same way as we can a "regular" ASCII text file:</p>
<pre class="calibre27">$ ls -la qa-data/*.bin<br class="calibre2"/>$ hexdump qa-data/garbage0.bin <br class="calibre2"/>0000000 0000 0000 0000 0000 0000 0000 0000 0000<br class="calibre2"/>*</pre>


            </article>

            
        </section>
    </div>



  
<div id="sbo-rt-content" class="calibre1"><section class="calibre2">

                            <header class="calibre2">
                    <h1 class="header-title">How it works...</h1>
                </header>
            
            <article class="calibre2">
                
<p class="mce-root">Let's understand, how things are happening:</p>
<ol class="calibre20">
<li class="chapter">First, we create the <kbd class="calibre17">;data-maker.sh</kbd> script. This script introduces several new concepts including the ever fascinating concept of randomization. In computers, or really anything in life, true random events or number generation cannot happen and require several mathematical principles such as entropy. While this is beyond the scope of this cookbook, know that when reusing it randomly or even initially, you should give it a unique initialization vector or seed. Using a for loop, we can build an array of numbers using the <kbd class="calibre17">seq</kbd> command. Once the array is built, we choose a "random" value from the array. In each type of file output operation (binary or text), we determine approximately both minimum (<kbd class="calibre17">-l</kbd> or lower) and maximum (<kbd class="calibre17">-u</kbd> or upper) sizes to control the output data.</li>
<li class="chapter">In step 2, we build <kbd class="calibre17">5</kbd> text files using the output of <kbd class="calibre17">dmesg</kbd> and our pseudo randomization process. We can see that we iterate until we have five text files created using different sizes and starting points with the <kbd class="calibre17">dd</kbd> command.</li>
<li class="chapter">In step 3, we verify that indeed we created five files, and in the fifth one, we viewed the <kbd class="calibre17">tail</kbd> of the <kbd class="calibre17">garbage4.txt</kbd> file.</li>
<li class="chapter">In step 4, we create five binary files (full of zeros) using the <kbd class="calibre17">dd</kbd> command. Instead of using a number of chars, we used megabytes or (MB).</li>
<li class="chapter">In step 5, we verify that indeed we created five binary files, and in the fifth one, we viewed the contents of the binary file using the <kbd class="calibre17">hexdump</kbd> command. The <kbd class="calibre17">hexdump</kbd> command created a simplified "dump" of all of the bytes inside of the <kbd class="calibre17">garbage0.bin</kbd> file.</li>
</ol>


            </article>

            
        </section>
    </div>



  </body></html>