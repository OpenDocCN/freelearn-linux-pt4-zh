<html><head></head><body><div class="chapter" title="Chapter&#xA0;7.&#xA0;NSX Cross vCenter"><div class="titlepage"><div><div><h1 class="title"><a id="ch07"/>Chapter 7. NSX Cross vCenter</h1></div></div></div><p>In this chapter, we will have a detailed discussion of the NSX cross vCenter feature. Starting from NSX 6.2, we can manage multiple vCenter Servers from a single pane of glass by leveraging NSX features across vCenter environments. We will primarily cover the following topics:</p><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc">Understanding NSX cross vCenter Server</li><li class="listitem" style="list-style-type: disc">Components of NSX cross vCenter Server</li><li class="listitem" style="list-style-type: disc">Cross vCenter universal logical switches</li><li class="listitem" style="list-style-type: disc">Cross vCenter universal logical router</li><li class="listitem" style="list-style-type: disc">Network choke points in NSX cross vCenter Server</li></ul></div><div class="section" title="Understanding NSX cross vCenter Server"><div class="titlepage"><div><div><h1 class="title"><a id="ch07lvl1sec52"/>Understanding NSX cross vCenter Server</h1></div></div></div><p>Earlier versions of NSX had a <span class="strong"><strong>1:1</strong></span> relationship with vCenter Server and that means NSX features and functionalities were limited to that specific vCenter Server. So whenever we are scaling vCenter Servers, it demands separate installation and configuration of NSX Manager and each of these environments has to be managed separately. When VMware released NSX 6.2 in August 2015, security and cross vCenter Server networking were exciting features that were announced. With cross vCenter networking and security features, we can extend logical switches across vCenter boundaries and, adding to that, we can extend distributed routing and distributed firewalling seamlessly across VCs to provide a true network hybridity between both the sites. There are numerous use cases customers can benefit from with this cross VC NSX integration. The following are a few of them:</p><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc">By leveraging cross vCenter Server, we can have a primary and secondary vSphere environment and can easily configure disaster recovery sites.</li><li class="listitem" style="list-style-type: disc">Seamless migration of workloads from one vSphere environment to another.</li><li class="listitem" style="list-style-type: disc">Simplified data center routing across vCenter Server sites; centralized security policy management; firewall rules can be managed from one centralized location.</li><li class="listitem" style="list-style-type: disc">NSX features and functionalities can be locally deployed (single vCenter Server); also we can deploy it across vCenter Server (cross vCenter Server). That way, local objects can be managed locally and global objects can be managed globally.</li></ul></div><p>The following figure depicts a cross vCenter Server NSX environment:</p><p>
</p><div class="mediaobject"><img src="graphics/B03244_07_01.jpg" alt="Understanding NSX cross vCenter Server"/></div><p>
</p><p>I know we are all excited to know how NSX cross VC works. But let's be very clear with prerequirements and a few points before discussing this feature:</p><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc">The VSphere environment should be version 6.0.</li><li class="listitem" style="list-style-type: disc">Each vCenter Server should be registered with a unique NSX Manager. Okay! That is an interesting point, isn't it? When I first heard about cross VC NSX architecture, I thought all we needed would be one NSX Manager moving forward. But further reading and lab sessions proved my understanding was wrong.</li><li class="listitem" style="list-style-type: disc">We have to promote one NSX Manager as <span class="strong"><strong>primary</strong></span> and the others will be <span class="strong"><strong>secondary</strong></span>.</li><li class="listitem" style="list-style-type: disc">We can certainly demote NSX roles based on business requirements. For example, a secondary NSX Manager can be demoted to a standalone NSX Manager and that way, we are going back to where NSX was initially when it started (pre 6.2 NSX version).</li><li class="listitem" style="list-style-type: disc">Even though cross VC NSX is a great architecture, I would still call it a new kid in town and it lacks all the features that were possible in a standalone NSX Manager instance. Keeping that negativity aside, I strongly believe newer versions of NSX will start supporting all the features across vCenter Servers.</li><li class="listitem" style="list-style-type: disc">Carefully plan and integrate cross VC NSX environments; to be precise, watch out for what features we need in the primary and secondary sites and how we need to manage those features. For example, if we need just a Distributed Firewall feature in the secondary site, I wouldn't recommend cross VC NSX integration unless we want to manage these firewall policies from a single pane of glass.</li></ul></div></div></div>
<div class="section" title="Components of NSX cross vCenter Server"><div class="titlepage"><div><div><h1 class="title"><a id="ch07lvl1sec53"/>Components of NSX cross vCenter Server</h1></div></div></div><p>Cross vCenter NSX includes the following components:</p><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc">Universal controller cluster</li><li class="listitem" style="list-style-type: disc">Universal transport zone</li><li class="listitem" style="list-style-type: disc">Universal logical switch</li><li class="listitem" style="list-style-type: disc">Universal distributed logical router</li><li class="listitem" style="list-style-type: disc">Universal IP set</li><li class="listitem" style="list-style-type: disc">Universal MAC set</li><li class="listitem" style="list-style-type: disc">Universal security group</li></ul></div><p>The following table depicts NSX cross vCenter Server deployment options; based on these points, we will have a detailed explanation:</p><p>
</p><div class="mediaobject"><img src="graphics/image_07_002.jpg" alt="Components of NSX cross vCenter Server"/></div><p>
</p><p>In the preceding table, I have updated key NSX features that customers would be ideally configuring in a cross vCenter NSX environment. Any other features, such as load balancing and L2 bridging, do not have any global level fitting between the NSX sites so they always remain local to the vCenter Server environment. Before exploring universal NSX features, we need to know what roles are available for NSX Manager.</p><p>The NSX Manager instance has the following roles and a synchronization module will be running on the primary NSX Manager to ensure universal objects are synchronized to the secondary NSX Manager. The NSX Manager instance has the following roles:</p><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc"><span class="strong"><strong>Standalone</strong></span>:Before configuring NSX roles, all the NSX Managers are standalone NSX Managers. A fresh installation of NSX Manager or an upgraded version of NSX Manager from VCNS are perfect examples of standalone NSX Managers.</li><li class="listitem" style="list-style-type: disc"><span class="strong"><strong>Primary</strong></span>:There will be only <span class="strong"><strong>one Primary NSX Manager</strong></span> in a cross vCenter NSX environment and we will be creating all universal objects in the primary NSX Manager. To be more specific, any deployment, modification, or deletion tasks will be done on the primary NSX Manager.</li><li class="listitem" style="list-style-type: disc"><span class="strong"><strong>Secondary</strong></span>: Whenever a standalone NSX Manager is added to the primary NSX Manager instance, it is called a secondary NSX Manager. All the universal objects are read-only on the secondary NSX Manager instance. A secondary NSX Manager instance cannot have its own controllers. We can have a total of seven secondary NSX Managers.</li><li class="listitem" style="list-style-type: disc"><span class="strong"><strong>Transit</strong></span>:There will be instances wherein we need to remove/change primary and secondary roles for the NSX Manager and this is where the transit role is important. However, if the NSX Manager instance has universal objects, it cannot be assigned the standalone role by definition. In such cases, the NSX Manager instance is assigned the transit role. In the transit role, a universal object can only be deleted. An NSX Manager instance can be assigned the secondary role after all the universal objects are deleted.</li></ul></div><p>The following diagram explains the various NSX roles that we have explained so far and the process to promote and demote NSX roles based on universal objects:</p><p>
</p><div class="mediaobject"><img src="graphics/image_07_003.jpg" alt="Components of NSX cross vCenter Server"/></div><p>
</p><p>Before moving ahead with further discussion of cross vCenter, we need to know the importance of the <span class="strong"><strong>Universal Synchronization Service</strong></span>. The Universal Synchronization Service is the heart of cross vCenter NSX communication.</p></div>
<div class="section" title="Universal Synchronisation Service"><div class="titlepage"><div><div><h1 class="title"><a id="ch07lvl1sec54"/>Universal Synchronisation Service</h1></div></div></div><p>The<span class="strong"><strong> Universal Synchronization Service</strong></span> is responsible for synchronizing configuration changes from the primary NSX Manager instance to all the secondary NSX Manager instances. These are inbuilt services that are running in primary NSX Manager and they do REST API calls to secondary NSX Managers for synchronization. Okay, let's do a few quick tests to see what the state of the service is before we start assigning roles to NSX Managers.</p><p>The following figure shows a GUI connection to NSX 6.2 and in the highlighted column we can see the NSX Universal Synchronization Service status:</p><p>
</p><div class="mediaobject"><img src="graphics/image_07_004.jpg" alt="Universal Synchronisation Service"/></div><p>
</p><p>In our setup, we have two NSX Managers and vCenter Servers are registered with a common <span class="strong"><strong>Platform Service Controller</strong></span> (<span class="strong"><strong>PSC</strong></span>). The PSC was introduced in vSphere 6 and handles functions such as vCenter Single Sign-On, licensing, certificate management, and server reservation. Controllers are already deployed in the NSX Manager 192.168.110.15, which will be our primary NSX Manager in a short while. We all know how to register NSX Manager with an individual vCenter Server since we have already discussed that in 
<a class="link" href="ch03.html" title="Chapter 3. NSX Manager Installation and Configuration">Chapter 3</a>
,<span class="emphasis"><em> NSX Manager Installation and Configuration</em></span>. Assuming that we have already done that registration successfully, it's time to promote the <span class="strong"><strong>192.168.110.15</strong></span> NSX Manager as primary and <span class="strong"><strong>192.168.210.15</strong></span> as secondary:</p><div class="orderedlist"><ol class="orderedlist arabic"><li class="listitem">Select the <span class="strong"><strong>Management</strong></span> tab and highlight <span class="strong"><strong>NSX Manager</strong></span>s.</li><li class="listitem">Select the <span class="strong"><strong>Actions</strong></span> icon.</li><li class="listitem">Select <span class="strong"><strong>Assign Primary Role</strong></span>:</li></ol></div><p>
</p><div class="mediaobject"><img src="graphics/image_07_005.jpg" alt="Universal Synchronisation Service"/></div><p>
</p><p>Any guess what will happen when we promote NSX Manager to primary? If your thoughts match the output, I'm going to show that result right away. Congratulations if your answers are correct.</p><p>The following figure depicts NSX Manager primary role registration; the <span class="strong"><strong>Replicator Service</strong></span> is automatically starting:</p><p>
</p><div class="mediaobject"><img src="graphics/image_07_006.jpg" alt="Universal Synchronisation Service"/></div><p>
</p><p>The preceding screenshot is the NSX Manager logs from the primary NSX Manager. As we can see in the GUI as well, <span class="strong"><strong>Replicator Service </strong></span>is automatically started since the registration is successful. The following figure shows the Universal Synchronization Service in a running state:</p><p>
</p><div class="mediaobject"><img src="graphics/image_07_007.jpg" alt="Universal Synchronisation Service"/></div><p>
</p><p>So watch out for this output and verify in the GUI whether the output matches the output in the logs. It is extremely important and useful for troubleshooting.</p></div>
<div class="section" title="Universal segment ID"><div class="titlepage"><div><div><h1 class="title"><a id="ch07lvl1sec55"/>Universal segment ID</h1></div></div></div><p>The universal segment ID pool is used to assign VNIs to universal logical switches, to ensure that we don't use the same segment ID pool for local and global logical switches; there would be overlapping segment IDs in that eventually.</p><p>The following figure shows <span class="strong"><strong>Universal Segment ID pool</strong></span> creation:</p><p>
</p><div class="mediaobject"><img src="graphics/B03244_07_08.jpg" alt="Universal segment ID"/></div><p>
</p><p>The whole purpose of creating universal logical switches is to span the logical network across vCenter sites without doing traditional complex routing and switching. That way, universal logical switches will be available on all the vCenter Servers in the cross domain NSX site and we can simply connect virtual machines to those logical switches. The virtual machine logical switches will always remain as port groups and NSX will take care of cross vCenter switching. Haven't we configured a more simplified Layer 2 switching than this? First of all, was it possible do a Layer 2 switching like this in the past? I strongly believe we have all already moved away from legacy network design thinking with the amount of awareness that we have added so far in this book.</p><p>Let's go ahead and add a secondary role to our second NSX Manager so that we can start creating universal transport zones and universal logical switches.</p><p>The procedure for adding a secondary NSX Manager is as follows:</p><div class="orderedlist"><ol class="orderedlist arabic"><li class="listitem">Log in to the vCenter linked to the primary NSX Manager.</li><li class="listitem">Navigate to <span class="strong"><strong>Home</strong></span> | <span class="strong"><strong>Networking &amp; Security</strong></span> | <span class="strong"><strong>Installation</strong></span> and select the <span class="strong"><strong>Management</strong></span> tab.</li><li class="listitem">Click the primary NSX Manager. Then select <span class="strong"><strong>Actions</strong></span> | <span class="strong"><strong>Add Secondary NSX Manager</strong></span>.</li><li class="listitem">Enter the IP address, username, and password of the secondary NSX Manager.</li><li class="listitem">Click <span class="strong"><strong>OK</strong></span>.</li></ol></div><p>The following figure depicts the <span class="strong"><strong>Add Secondary NSX Manager</strong></span> option:</p><p>
</p><div class="mediaobject"><img src="graphics/image_07_009.jpg" alt="Universal segment ID"/></div><p>
</p><p>A successful addition of a secondary NSX Manager will show the role as secondary as depicted in the following screenshot:</p><p>
</p><div class="mediaobject"><img src="graphics/image_07_010.jpg" alt="Universal segment ID"/></div><p>
</p><div class="section" title="Universal transport zone"><div class="titlepage"><div><div><h2 class="title"><a id="ch07lvl2sec47"/>Universal transport zone</h2></div></div></div><p>Since we have a primary and secondary NSX Manager, let's go ahead and create a universal transport zone. First and foremost, there can only be <span class="strong"><strong>one universal transport zone in a cross vCenter NSX environment</strong></span>. During the NSX Manager roles in this chapter, we have gone through the difference between primary, secondary and transit roles and there is no exception while creating a universal transport zone. Universal objects are always created from the primary NSX Manager.</p><p>The following figure shows universal logical switch creation and we have added a primary NSX-VC pairing vSphere cluster:</p><p>
</p><div class="mediaobject"><img src="graphics/image_07_011.jpg" alt="Universal transport zone"/></div><p>
</p><p>To add clusters from the secondary NSX-VC pairing vSphere site, we need to change the manager settings to secondary and click on <span class="strong"><strong>Connect Cluster Option</strong></span>, which will display all clusters in the secondary NSX-VC site. Whenever we add new clusters, all we need to do is connect those newly added clusters to the universal transport zone and in my view this is the simplest way we can scale a software-defined data center:</p><p>
</p><div class="mediaobject"><img src="graphics/image_07_012.jpg" alt="Universal transport zone"/></div><p>
</p><p>Let's do a quick test: we will go ahead and create a universal logical switch and will check if logical switches are getting populated in the primary and secondary NSX sites. Sounds great? Let's get started then.</p></div></div>
<div class="section" title="Cross vCenter universal logical switch creation"><div class="titlepage"><div><div><h1 class="title"><a id="ch07lvl1sec56"/>Cross vCenter universal logical switch creation</h1></div></div></div><p>Okay! We need to check a few prerequirements for logical switch creation to ensure that we are able to create the logical switch at the same time and it is functioning as expected. The following are the key points that should be followed while creating a universal logical switch:</p><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc">A VSphere distributed switch should be configured</li><li class="listitem" style="list-style-type: disc">Controllers must be deployed in the primary NSX Manager</li><li class="listitem" style="list-style-type: disc">VSphere Host clusters must be prepared for NSX</li><li class="listitem" style="list-style-type: disc">VXLAN must be configured</li><li class="listitem" style="list-style-type: disc">A universal segment ID pool must be configured (should not overlap with local segment ID)</li><li class="listitem" style="list-style-type: disc">A universal transport zone must be created</li></ul></div><p>Let's go ahead and create a <span class="strong"><strong>universal logical switch</strong></span>:</p><div class="orderedlist"><ol class="orderedlist arabic"><li class="listitem">In vSphere web client, navigate to <span class="strong"><strong>Home</strong></span> | <span class="strong"><strong>Networking &amp; Security</strong></span> | <span class="strong"><strong>Logical Switches</strong></span>.</li><li class="listitem">Select the NSX Manager on which you want to create a logical switch (this should be the primary NSX Manager; if we select the secondary NSX Manager, it won't be universal object selection).</li><li class="listitem">Click the <span class="strong"><strong>New Logical Switch</strong></span> icon.</li></ol></div><p>This being a universal logical switch, we certainly need to have a universal transport zone and segment ID created; however, we have created that already. Assuming that we have met all the pre requirements, let's move on:</p><div class="orderedlist"><ol class="orderedlist arabic"><li class="listitem">Type the universal logical switch name; in our example, we are naming it <span class="strong"><strong>
<span class="strong"><strong>Universal</strong></span>
</strong></span> switch.</li><li class="listitem">Select the <span class="strong"><strong>Transport Zone</strong></span>; this should be the <span class="strong"><strong>Universal Transport Zone</strong></span> created earlier in this chapter.</li></ol></div><p>The following figure represents universal logical switch creation:</p><p>
</p><div class="mediaobject"><img src="graphics/image_07_013.jpg" alt="Cross vCenter universal logical switch creation"/></div><p>
</p><div class="section" title="Adding virtual machines to universal logical switches"><div class="titlepage"><div><div><h2 class="title"><a id="ch07lvl2sec48"/>Adding virtual machines to universal logical switches</h2></div></div></div><p>Since we have already created universal logical switches, we will go ahead and attach two virtual machines from two vCenter sites and perform a basic ping test. Considering the amount of knowledge that we have added so far, this lab task will be a cakewalk for all of us. Let's get started:</p><div class="orderedlist"><ol class="orderedlist arabic"><li class="listitem">In logical switches, we need to select the logical switch to which you want to add virtual machines.</li><li class="listitem">Click the <span class="strong"><strong>Add Virtual Machine</strong></span> icon.</li><li class="listitem">Select the virtual machines you want to add to the logical switch. In our case, we are selecting the <span class="strong"><strong>Web-Site A</strong></span> machine, which is preconfigured with IP 1<span class="strong"><strong>72.17.10.11</strong></span> as shown in the following figure:<p>
</p><div class="mediaobject"><img src="graphics/image_07_014.jpg" alt="Adding virtual machines to universal logical switches"/></div><p>
</p></li><li class="listitem">Select the vNICs that you want to connect as shown in the following figure:<p>
</p><div class="mediaobject"><img src="graphics/image_07_015.jpg" alt="Adding virtual machines to universal logical switches"/></div><p>
</p></li><li class="listitem">Click <span class="strong"><strong>Next</strong></span> and <span class="strong"><strong>Finish</strong></span> the connection configuration task for <span class="strong"><strong>Web-Site A.</strong></span><p>The following screenshot portrays the Web-Site A machine and its IP details:</p><p>
</p><div class="mediaobject"><img src="graphics/image_07_016.jpg" alt="Adding virtual machines to universal logical switches"/></div><p>
</p><p>If we don't see the correct virtual machine in the available objects section, there's a strong chance we are in the wrong NSX Manager. We have to be in the correct NSX Manager (primary/secondary) to see the VC-virtual machine inventory list.</p></li><li class="listitem">Since we have done with the Site-A, virtual machines have been added to the universal logical switch, we need to switch our NSX Manager role to secondary so that we can add machines from the secondary NSX Manager VC inventory to the same universal logical switch. How do we do that? It's a simple switch and is demonstrated in the following screenshot:<p>
</p><div class="mediaobject"><img src="graphics/image_07_017.jpg" alt="Adding virtual machines to universal logical switches"/></div><p>
</p></li><li class="listitem">We need to repeat Steps 1,2, and 3 and add virtual machine <span class="strong"><strong>Web-Site B</strong></span> from the second vCenter Server, which is preconfigured with IP <span class="strong"><strong>172.17.10.12</strong></span>.</li><li class="listitem">Click the <span class="strong"><strong>Add Virtual Machine</strong></span> icon.</li><li class="listitem">Select the virtual machines you want to add to the logical switch. In our case, we are selecting the <span class="strong"><strong>Web-Site B</strong></span> machine.</li></ol></div><p>The following screenshot shows the <span class="strong"><strong>Web-Site B</strong></span> machine and its IP details:</p><p>
</p><div class="mediaobject"><img src="graphics/image_07_018.jpg" alt="Adding virtual machines to universal logical switches"/></div><p>
</p><p>Now we have created a universal logical switch and connected the <span class="strong"><strong>Web-Site A</strong></span> and <span class="strong"><strong>Web-Site B</strong></span> machines residing in two vCenter Servers. Traditionally, we need a Layer 2 switch for such circumstances since virtual machines are on two vCenter Servers and the same subnet. However, the cross vCenter NSX universal logical switch is a game-changer for data center Layer 2 switching. This is certainly a great use case not only for cross vCenter virtual machine connectivity we can easily design an active-active,active-passive vSphere data center for disaster recovery configuration with VMware SRM.
</p><p>Let's do a simple ping test to confirm if these web servers are communicating as expected. The following screenshot shows <span class="strong"><strong>Web-Site B</strong></span> virtual machine connectivity from <span class="strong"><strong>Web-Site A</strong></span>:</p><p>
</p><div class="mediaobject"><img src="graphics/image_07_019.jpg" alt="Adding virtual machines to universal logical switches"/></div><p>
</p><p>Okay! So we have Layer 2 connectivity between two vCenter sites by leveraging universal logical switches. If this entire network flow sounds complex or confusing, let's focus on the following figure, which portrays the entire configuration that we did so far for establishing universal logical switching:</p><p>
</p><div class="mediaobject"><img src="graphics/image_07_020.jpg" alt="Adding virtual machines to universal logical switches"/></div><p>
</p></div></div>
<div class="section" title="Cross vCenter Server Universal Logical Routers"><div class="titlepage"><div><div><h1 class="title"><a id="ch07lvl1sec57"/>Cross vCenter Server Universal Logical Routers</h1></div></div></div><p>Universal Logical Routers provides a optimized routing between vCenter Server sites for East-West data center traffic. For now, we can call this router a <span class="strong"><strong>Global NSX Router</strong></span>, which will ease management tasks such as configuring and creating routes (static/dynamic) and firewall rules from a single pane of glass. Once again, I will re-emphasize: creation/deletion and all management activity relative to universal logical routers can be only done from the primary NSX Manager. We will go ahead and configure a cross vCenter Server universal logical router and establish a routing between two vCenter Server sites. We are taking the same virtual machines that we used in universal logical switching for this configuration; however, I have changed the IP/subnet of <span class="strong"><strong>Web-Site B</strong></span>, which demands a routing between <span class="strong"><strong>Web-Site A</strong></span> and <span class="strong"><strong>Web-Site B</strong></span>. Let's get started then:</p><p>
</p><div class="mediaobject"><img src="graphics/image_07_021.jpg" alt="Cross vCenter Server Universal Logical Routers"/></div><p>
</p><p>The procedure for deploying a universal logical router is as follows:</p><div class="orderedlist"><ol class="orderedlist arabic"><li class="listitem">Log in to vSphere web client.</li><li class="listitem">Click on <span class="strong"><strong>Networking &amp; Security</strong></span> and then click <span class="strong"><strong>NSX Edges</strong></span>.</li><li class="listitem">Select <span class="strong"><strong>Universal Logical (Distributed) Router</strong></span> (we will discuss local egress in the <span class="emphasis"><em>Network choke points</em></span> section of this chapter):<p>
</p><div class="mediaobject"><img src="graphics/image_07_022.jpg" alt="Cross vCenter Server Universal Logical Routers"/></div><p>
</p></li><li class="listitem">Enter the <span class="strong"><strong>User Name</strong></span> and P<span class="strong"><strong>assword</strong></span> for the <span class="strong"><strong>Universal Distributed Logical Router</strong></span> (<span class="strong"><strong>UDLR</strong></span>) as shown in the following figure:<p>
</p><div class="mediaobject"><img src="graphics/image_07_023.jpg" alt="Cross vCenter Server Universal Logical Routers"/></div><p>
</p></li><li class="listitem">Select the <span class="strong"><strong>Datacenter</strong></span> and<span class="strong"><strong> NSX  EdgeAppliance</strong></span> details as shown in the following screenshot:<div class="note" title="Note" style=""><div class="inner"><h3 class="title"><a id="note19"/>Note</h3><p>Please note that <span class="strong"><strong>NSX Edge Appliance</strong></span> is not mandatory if we are leveraging only static routes. However, <span class="strong"><strong>Appliance deployment</strong></span> is a must for dynamic routing and firewall.</p></div></div><p>
</p><div class="mediaobject"><img src="graphics/image_07_024.jpg" alt="Cross vCenter Server Universal Logical Routers"/></div><p>
</p></li><li class="listitem">For High Availability interface configuration, we connect the interface to the vSphere distributed port group and they will communicate over the APIPA range (169.250.0.0/26) IP address as shown in the following screenshot:<p>
</p><div class="mediaobject"><img src="graphics/image_07_025.jpg" alt="Cross vCenter Server Universal Logical Routers"/></div><p>
</p></li><li class="listitem">Finally, we will add logical interfaces to the UDLR.<p>The following screenshot shows the universal switch connection from Site-A to connect the Web-Site-A VM to the UDLR:</p><p>
</p><div class="mediaobject"><img src="graphics/image_07_026.jpg" alt="Cross vCenter Server Universal Logical Routers"/></div><p>
</p></li><li class="listitem">We need to repeat Step 7 to add the Web-Site-B (VM residing in the second vCenter) to the UDLR as shown in the following screenshot:</li></ol></div><p>
</p><div class="mediaobject"><img src="graphics/image_07_027.jpg" alt="Cross vCenter Server Universal Logical Routers"/></div><p>
</p><p>Now that we have connected both the universal switches to the UDLR, let's go ahead and verify the routing table. No rocket science here, if we have followed all the steps so far diligently. Our UDLR should show those two logical networks as directly connected networks. The following screenshot depicts the output for the following command:</p><pre class="programlisting">
<span class="strong"><strong>Net-vdr -route -l UDLR-ID</strong></span>
</pre><p>
</p><div class="mediaobject"><img src="graphics/image_07_028.jpg" alt="Cross vCenter Server Universal Logical Routers"/></div><p>
</p><p>Since the UDLR is showing <span class="strong"><strong>172.16.20.0</strong></span> and <span class="strong"><strong>172.17.10.0</strong></span> networks connected, we should be able to perform a simple <span class="strong"><strong>ICMP</strong></span> ping between these machines, considering we have appropriate firewall rules added in the router. In our example, the default rule is to allow all the traffic so there should not be any choke points here.</p><p>The following screenshot portrays a successful ICMP ping from <span class="strong"><strong>Web-Site-B</strong></span> (172.16.10.11) to <span class="strong"><strong>Web-Site-A</strong></span> (172.17.10.11):</p><p>
</p><div class="mediaobject"><img src="graphics/image_07_029.jpg" alt="Cross vCenter Server Universal Logical Routers"/></div><p>
</p><p>Let's take an example, to be clear with the overall learning process, showing how routes are getting pushed to the underlying ESXi host; we have a multi-tenant topology as an example which I have shown in the following figure:</p><div class="orderedlist"><ol class="orderedlist arabic"><li class="listitem">Dynamic routing protocol (OSPF) is running between Site-A and B Edges to their respective data center routers.</li><li class="listitem">Site-A and Site-B NSX Edges are connected with Universal Distributed Logical Routers.</li><li class="listitem">Static routes are created on NSX Edges to reach the 172.16.10.0 series network (we can certainly leverage dynamic routing protocols as well, based on business requirements).</li><li class="listitem">UDLR control VMs will send the learnt route to the NSX Controller cluster for distribution. Just to reiterate, controllers are running only in the primary NSX Manager since there is a cross VC NSX solution and all NSX Managers are well aware of universal NSX objects through the universal synchronization service.</li><li class="listitem">The primary NSX Controllers will send those routes to the underlying ESXi hosts.</li><li class="listitem">The ESXi host kernel routing module will update its routing table and will take care of data path traffic for those networks which it has learnt from the controllers.</li><li class="listitem">The preceding mentioned six steps are basic routing learning processes in an NSX environment:</li></ol></div><p>
</p><div class="mediaobject"><img src="graphics/image_07_030.jpg" alt="Cross vCenter Server Universal Logical Routers"/></div><p>
</p></div>
<div class="section" title="Network choke points"><div class="titlepage"><div><div><h1 class="title"><a id="ch07lvl1sec58"/>Network choke points</h1></div></div></div><p>Let me get started by saying: 
<span class="emphasis"><em>Never offer or implement any design unless you are well aware that it addresses all the customer's needs</em></span>.
</p><p>That rule is not specific to marketing or sales folk. It's general advice for anyone who deals with technology. If not, we will hear the feedback: <span class="emphasis"><em>I'm having a nightmare; all the problems started happening after that design change. Can you please get rid of that?</em></span> We have designed or seen various types of vSphere networks. Every network topology will have a loophole. Nothing is perfect in this world and all we can do is ensure that we are better prepared for failures, this seems more like an advantage than a failure? I want all of you to pause for a minute and have a look at the preceding topology; make a note of all failure scenarios that might interrupt data traffic. Adding to that, if we have carefully observed the topology, we will see that universal control VMs and Edges are running on two different sites. So how will the UDLR control VM ensure that whatever routes it is learning from that specific NSX Edge are the only routes learnt by the underlying ESXi host that are specific to that site? I know that is a slightly confusing statement. Never mind, all we need is that routes learned by Site-A appliances (Edges/Control VM) are sent to the Site-A ESXi host and vice versa for Site-B. Okay! Let's get started then and keep reading the following useful points to ensure that our design satisfies our customer requirement without inviting any further problems:</p><div class="orderedlist"><ol class="orderedlist arabic"><li class="listitem">Both the data centers have two NSX appliances running and we need to ensure they are running in HA mode with vSphere HA also configured. That way, single appliance/host failure will have less impact:<div class="itemizedlist"><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc">NSX Edge</li><li class="listitem" style="list-style-type: disc">UDLR Control VM</li></ul></div><p>
</p></li><li class="listitem">Ensure that we are using <span class="strong"><strong>LOCALE-ID (by default, this value is set to the NSX Managers-UUID)</strong></span>. With the Locale-ID configuration, NSX Controllers will send routes to ESXi hosts matching Locale-ID. Going via our topology, each site ESXi host will maintain a site-specific local routing table. We can set Locale-ID per cluster, host level and UDLR level. This would perfectly fit in a multi-tenant network/cloud environment wherein each tenant wants to maintain routes which are specific to that tenant.</li><li class="listitem">All <span class="strong"><strong>South-North</strong></span> traffic is handled by <span class="strong"><strong>Site A NSX Edge</strong></span> and <span class="strong"><strong>SITE B NSX Edge</strong></span> in their respective sites. Starting from NSX 6.1, <span class="strong"><strong>Equal Cost Multi Path</strong></span> (<span class="strong"><strong>ECMP</strong></span>) is supported. Hence, we can deploy multiple NSX Edges and the ECMP algorithm will HASH the traffic based on source and destination IP. ECMP can be enabled on Edges and DLR. That way, if there is a failure, it will recalculate the HASH and will route the traffic to the active edge/DLR. In addition to that, there will be designs that might demand back-to-back ECMP configuration, Distributed Logical Router to NSX Edge and NSX Edge to physical routers.</li><li class="listitem">We should never design something that breaks a working topology. While we deal with ECMP, we need to be aware that NSX Edge has a stateful firewall. There is a good chance we might have asymmetric routing issues; basically, a packet that travels from source to destination uses one path and while replying, takes another path, because at any time only one Edge will be aware of the traffic flow. No worries: while we enable ECMP in NSX 6.1, we will get a message that says enabling this feature will <span class="strong"><strong>disable Edge firewall</strong></span>.<span class="strong"><strong> Don't worry</strong></span>, we are not compromising on firewall rules in such designs. Either we can deploy any third-party physical firewall (as shown in the figure) between NSX Edges and Upstream router or we need to leverage Distributed Firewall, which will filter the traffic at the VNIC level. However, starting from NSX 6.1.3, ECMP and logical firewall can work together and for the same reason it won't get disabled by default when we enable ECMP. However, starting from
NSX 6.1.3, ECMP and logical firewall can work together and for the same reason
it won't get disabled by default when we enable ECMP (Active/Standby NSX Edges). The following diagram depicts an<span class="strong"><strong> ECMP</strong></span>-added configuration for the same topology:<p>
</p><div class="mediaobject"><img src="graphics/image_07_031.jpg" alt="Network choke points"/></div><p>
</p></li><li class="listitem">Since we have NSX Edges running on each site, <span class="strong"><strong>overlapping</strong></span> IP addresses are supported by configuring a NAT on the site-specific Edge. Again, a highly demanding use case, especially for cloud providers.</li><li class="listitem">We can have eight NSX Edges participating in ECMP configuration at a time; in our case, eight ECMP edges per site with a total of 16 Edges we can run in that way.</li><li class="listitem">How about a worst case scenario of complete Site A or Site B failure one at a time? There is certainly a solution for any problem, but in this case, the solution will be slightly tedious and based on the physical network design. Reconfiguring all NSX components in another site may not work.</li><li class="listitem">Site-B is where we have the primary NSX Manager and Site-B had a complete failure. Starting from NSX Manager role changing, we need to deploy Edges and appliances and can bring the environment back to normal only if the physical network design is equally matching for both the sites. I know this is a tedious process,so if we want to automate such tasks,we need to leverage NSX API and VRO workflow's so that that would ease lot of manual tasks. In a rare case, we may have to reconfigure the physical network so that Site-B machines can communicate with the physical network while they are residing in Site-A during the outage.</li></ol></div><p>There is a lot to be discussed about types of failures, such as NSX components in network sites failing at the same time or virtual environment and physical network partial/full failure scenarios. There are also routing protocol (OSPF/BGP) specific failure scenarios that also bring up some good points for discussion. It is extremely hard to cover all such failure scenarios and carry out precautionary steps based on the type of design in just one book. Luckily, the NSX product documentation from VMware is not limited to installation, configuration, and general designs. There are a few design guides they have released specific to vendor integration, such as NSX+UCS design, NSX+CISCO ACI, and so on. It's worth reading such documents once we have mastered the basics and, hopefully, what we have learnt so far in all seven chapters is a foundation step for climbing the network virtualization ladder. It's been a remarkable discussion so far on VMware NSX topologies and, optimistically, by this time, we all are clear on how VMware NSX is reinventing data center networking.</p></div>
<div class="section" title="Summary"><div class="titlepage"><div><div><h1 class="title"><a id="ch07lvl1sec59"/>Summary</h1></div></div></div><p>We started this chapter with an introduction to NSX cross vCenter Server followed by cross vCenter Server components, and universal object creation, and we ended by discussing a few design decisions that we should be well aware of during cross vCenter Server NSX deployment. Way back, network troubleshooting was single-handedly done by network architects and support engineers, which made life easy for vSphere folk. NSX being a network software layer running on top of vSphere, people often believe that it might make their life somewhat threatening since they have a clear visibility on both for both hypervisor and network virtualization layers.</p><p>For me, troubleshooting is an art; if we follow a systematic procedure for checking a problem, resolving the problem is a cakewalk. There is no secret or straightforward automation that will help us analyze and fix a problem in network virtualization.</p><p>In the next chapter, we will have a detailed discussion on NSX troubleshooting. So let's ensure that we recall whatever we learnt and get our hands dirty by applying those points based on the situation.</p></div></body></html>