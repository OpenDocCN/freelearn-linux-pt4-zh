<html><head></head><body>
        <section class="calibre1">

            <header class="calibre1">
                </header><h1 class="header-title" id="calibre_pb_0">KVM Networking with libvirt</h1>
            

            <article class="calibre1">
                
<p class="calibre3">In this chapter, we are going to cover the following topics:</p>
<ul class="calibre16">
<li class="calibre17">The Linux bridge</li>
<li class="calibre17">The Open vSwitch</li>
<li class="calibre17">Configuring NAT forwarding network</li>
<li class="calibre17">Configuring bridged network</li>
<li class="calibre17">Configuring PCI passthrough network</li>
<li class="calibre17">Manipulating network interfaces</li>
</ul>


            </article>

            <footer class="calibre5">
                
            </footer>

        </section>
    

        <section class="calibre1">

            <header class="calibre1">
                </header><h1 class="header-title" id="calibre_pb_0">Introduction</h1>
            

            <article class="calibre1">
                
<p class="calibre3">With libvirt, we can define different network types for our KVM guests, using the already familiar XML definition syntax and the <kbd class="calibre13">virsh</kbd> and <kbd class="calibre13">virt-install</kbd> userspace tools. In this chapter, we are going to deploy three different network types, explore the network XML format, and see examples on how to define and manipulate virtual interfaces for the KVM instances.</p>
<p class="calibre3">To be able to connect the virtual machines to the host OS or to each other, we are going to use the Linux bridge and the <strong class="calibre4">Open vSwitch</strong> (<strong class="calibre4">OVS</strong>) daemons, userspace tools, and kernel modules. Both software bridging technologies are great at creating <strong class="calibre4">Software-defined Networking</strong> (<strong class="calibre4">SDN</strong>) of various complexity, in a consistent and easy-to-manipulate manner. The Linux bridge and OVS both act as a bridge/switch that the virtual interfaces of the KVM guests can connect to. </p>
<p class="calibre3">With all this in mind, let's start by learning more about the software bridges in Linux.</p>


            </article>

            <footer class="calibre5">
                
            </footer>

        </section>
    

        <section class="calibre1">

            <header class="calibre1">
                </header><h1 class="header-title" id="calibre_pb_0">The Linux bridge</h1>
            

            <article class="calibre1">
                
<p class="calibre3">The Linux bridge is a software layer 2 device that provides some of the functionality of a physical bridge device. It can forward frames between KVM guests, the host OS, and virtual machines running on other servers, or networks. The Linux bridge consists of two components--a userspace administration tool that we are going to use in this recipe and a kernel module that performs all the work of connecting multiple Ethernet segments together. Each software bridge we create can have a number of ports attached to it, where network traffic is forwarded to and from. When creating KVM instances, we can attach the virtual interfaces that are associated with them to the bridge, which is similar to plugging a network cable from a physical server's NIC to a bridge/switch device. Being a layer 2 device, the Linux bridge works with MAC addresses and maintains a kernel structure to keep track of ports and associated MAC addresses in the form of a <strong class="calibre4">Content Addressable Memory</strong> (<strong class="calibre4">CAM</strong>) table.</p>
<p class="calibre3">In this recipe, we are going to create a new Linux bridge and use the <kbd class="calibre13">brctl</kbd> utility to manipulate it.</p>


            </article>

            <footer class="calibre5">
                
            </footer>

        </section>
    

        <section class="calibre1">

            <header class="calibre1">
                </header><h1 class="header-title" id="calibre_pb_0">Getting ready</h1>
            

            <article class="calibre1">
                
<p class="calibre3">For this recipe, we are going to need the following:</p>
<ul class="calibre16">
<li class="calibre17">Recent Linux kernel with enabled <kbd class="calibre13">802.1d Ethernet</kbd> bridging options</li>
</ul>
<p class="calibre32">To check whether your kernel is compiled with those features or exposed as kernel modules, run the following command:</p>
<pre class="calibre25">
<strong class="calibre4">root@kvm:~# cat /boot/config-`uname -r` | grep -i bridg</strong><br class="calibre7"/><strong class="calibre4"># PC-card bridges</strong><br class="calibre7"/><strong class="calibre4">CONFIG_BRIDGE_NETFILTER=y</strong><br class="calibre7"/><strong class="calibre4">CONFIG_NF_TABLES_BRIDGE=m</strong><br class="calibre7"/><strong class="calibre4">CONFIG_BRIDGE_NF_EBTABLES=m</strong><br class="calibre7"/><strong class="calibre4">CONFIG_BRIDGE_EBT_BROUTE=m</strong><br class="calibre7"/><strong class="calibre4">CONFIG_BRIDGE_EBT_T_FILTER=m</strong><br class="calibre7"/><strong class="calibre4">CONFIG_BRIDGE_EBT_T_NAT=m</strong><br class="calibre7"/><strong class="calibre4">CONFIG_BRIDGE_EBT_802_3=m</strong><br class="calibre7"/><strong class="calibre4">CONFIG_BRIDGE_EBT_AMONG=m</strong><br class="calibre7"/><strong class="calibre4">CONFIG_BRIDGE_EBT_ARP=m</strong><br class="calibre7"/><strong class="calibre4">CONFIG_BRIDGE_EBT_IP=m</strong><br class="calibre7"/><strong class="calibre4">CONFIG_BRIDGE_EBT_IP6=m</strong><br class="calibre7"/><strong class="calibre4">CONFIG_BRIDGE_EBT_LIMIT=m</strong><br class="calibre7"/><strong class="calibre4">CONFIG_BRIDGE_EBT_MARK=m</strong><br class="calibre7"/><strong class="calibre4">CONFIG_BRIDGE_EBT_PKTTYPE=m</strong><br class="calibre7"/><strong class="calibre4">CONFIG_BRIDGE_EBT_STP=m</strong><br class="calibre7"/><strong class="calibre4">CONFIG_BRIDGE_EBT_VLAN=m</strong><br class="calibre7"/><strong class="calibre4">CONFIG_BRIDGE_EBT_ARPREPLY=m</strong><br class="calibre7"/><strong class="calibre4">CONFIG_BRIDGE_EBT_DNAT=m</strong><br class="calibre7"/><strong class="calibre4">CONFIG_BRIDGE_EBT_MARK_T=m</strong><br class="calibre7"/><strong class="calibre4">CONFIG_BRIDGE_EBT_REDIRECT=m</strong><br class="calibre7"/><strong class="calibre4">CONFIG_BRIDGE_EBT_SNAT=m</strong><br class="calibre7"/><strong class="calibre4">CONFIG_BRIDGE_EBT_LOG=m</strong><br class="calibre7"/><strong class="calibre4"># CONFIG_BRIDGE_EBT_ULOG is not set</strong><br class="calibre7"/><strong class="calibre4">CONFIG_BRIDGE_EBT_NFLOG=m</strong><br class="calibre7"/><strong class="calibre4">CONFIG_BRIDGE=m</strong><br class="calibre7"/><strong class="calibre4">CONFIG_BRIDGE_IGMP_SNOOPING=y</strong><br class="calibre7"/><strong class="calibre4">CONFIG_BRIDGE_VLAN_FILTERING=y</strong><br class="calibre7"/><strong class="calibre4">CONFIG_SSB_B43_PCI_BRIDGE=y</strong><br class="calibre7"/><strong class="calibre4">CONFIG_DVB_DDBRIDGE=m</strong><br class="calibre7"/><strong class="calibre4">CONFIG_EDAC_SBRIDGE=m</strong><br class="calibre7"/><strong class="calibre4"># VME Bridge Drivers</strong><br class="calibre7"/><strong class="calibre4">root@kvm:~#</strong>
</pre>
<ul class="calibre16">
<li class="calibre17">The <kbd class="calibre13">bridge</kbd> kernel module</li>
</ul>
<p class="calibre32">To verify that the module is loaded and to obtain more information about its version and features, execute the following command:</p>
<pre class="calibre25">
<strong class="calibre4">root@kvm:~# lsmod | grep bridge</strong><br class="calibre7"/><strong class="calibre4">bridge 110925 0</strong><br class="calibre7"/><strong class="calibre4">stp 12976 2 garp,bridge</strong><br class="calibre7"/><strong class="calibre4">llc 14552 3 stp,garp,bridge<br class="calibre7"/>root@kvm:~#</strong><br class="calibre7"/><strong class="calibre4">root@kvm:~# modinfo bridge</strong><br class="calibre7"/><strong class="calibre4">filename: /lib/modules/3.13.0-107-generic/kernel/net/bridge/bridge.ko</strong><br class="calibre7"/><strong class="calibre4">alias: rtnl-link-bridge</strong><br class="calibre7"/><strong class="calibre4">version: 2.3</strong><br class="calibre7"/><strong class="calibre4">license: GPL</strong><br class="calibre7"/><strong class="calibre4">srcversion: 49D4B615F0B11CA696D8623</strong><br class="calibre7"/><strong class="calibre4">depends: stp,llc</strong><br class="calibre7"/><strong class="calibre4">intree: Y</strong><br class="calibre7"/><strong class="calibre4">vermagic: 3.13.0-107-generic SMP mod_unload modversions</strong><br class="calibre7"/><strong class="calibre4">signer: Magrathea: Glacier signing key</strong><br class="calibre7"/><strong class="calibre4">sig_key: E1:07:B2:8D:F0:77:39:2F:D6:2D:FD:D7:92:BF:3B:1D:BD:57:0C:D8</strong><br class="calibre7"/><strong class="calibre4">sig_hashalgo: sha512</strong><br class="calibre7"/><strong class="calibre4">root@kvm:~#</strong>
</pre>
<ul class="calibre16">
<li class="calibre17">The <kbd class="calibre13">bridge-utils</kbd> package that provides the tool to create and manipulate the Linux bridge</li>
<li class="calibre17">The ability to create new KVM guests using libvirt or the QEMU utilities or an existing KVM instance from the previous chapters</li>
</ul>


            </article>

            <footer class="calibre5">
                
            </footer>

        </section>
    

        <section class="calibre1">

            <header class="calibre1">
                </header><h1 class="header-title" id="calibre_pb_0">How to do it...</h1>
            

            <article class="calibre1">
                
<p class="calibre3">To create, list, and manipulate a new Linux bridge, follow these steps:</p>
<ol class="calibre18">
<li value="1" class="calibre17"><span>Install the Linux</span> bridge p<span>ackage, if it is not already present:</span></li>
</ol>
<pre class="calibre25">
<strong class="calibre4">root@kvm:~# apt install bridge-utils</strong>
</pre>
<ol start="2" class="calibre18">
<li value="2" class="calibre17">Build a new KVM instance using the raw image from the <em class="calibre22">Installing a custom OS on the image with debootstrap </em>recipe from <a target="_blank" href="part0026.html#OPEK0-c1e587dcccb14690b55c247c1809e6ce" class="calibre8">Chapter 1</a><em class="calibre22">, Getting Started with QEMU and KVM</em>, if you are not reading this book cover to cover:</li>
</ol>
<pre class="calibre25">
<strong class="calibre4">root@kvm:~# virt-install --name kvm1 --ram 1024 --disk path=/tmp/debian.img,format=raw --graphics vnc,listen=146.20.141.158 --noautoconsole --hvm --import</strong><br class="calibre7"/><br class="calibre7"/><strong class="calibre4">Starting install...</strong><br class="calibre7"/><strong class="calibre4">Creating domain... | 0 B 00:00</strong><br class="calibre7"/><strong class="calibre4">Domain creation completed. You can restart your domain by running:</strong><br class="calibre7"/><strong class="calibre4"> virsh --connect qemu:///system start kvm1</strong><br class="calibre7"/><strong class="calibre4">root@kvm:~#</strong>
</pre>
<ol start="3" class="calibre18">
<li value="3" class="calibre17">List all the available bridge devices:</li>
</ol>
<pre class="calibre25">
<strong class="calibre4">root@kvm:~# brctl show</strong><br class="calibre7"/><strong class="calibre4">bridge name      bridge id             STP enabled     interfaces</strong><br class="calibre7"/><strong class="calibre4">virbr0           8000.fe5400559bd6     yes             vnet0</strong><br class="calibre7"/><strong class="calibre4">root@kvm:~#</strong>
</pre>
<ol start="4" class="calibre18">
<li value="4" class="calibre17">Bring the virtual bridge down, delete it, and ensure that it's been deleted:</li>
</ol>
<pre class="calibre25">
<strong class="calibre4">root@kvm:~# ifconfig virbr0 down</strong><br class="calibre7"/><strong class="calibre4">root@kvm:~# brctl delbr virbr0</strong><br class="calibre7"/><strong class="calibre4">root@kvm:~# brctl show</strong><br class="calibre7"/><strong class="calibre4">bridge name bridge id STP enabled interfaces</strong><br class="calibre7"/><strong class="calibre4">root@kvm:~#</strong>
</pre>
<ol start="5" class="calibre18">
<li value="5" class="calibre17">Create a new bridge and bring it up:</li>
</ol>
<pre class="calibre25">
<strong class="calibre4">root@kvm:~# brctl addbr virbr0</strong><br class="calibre7"/><strong class="calibre4">root@kvm:~# brctl show</strong><br class="calibre7"/><strong class="calibre4">bridge name     bridge id            STP enabled interfaces</strong><br class="calibre7"/><strong class="calibre4">virbr0          8000.000000000000    no</strong><br class="calibre7"/><strong class="calibre4">root@kvm:~# ifconfig virbr0 up</strong><br class="calibre7"/><strong class="calibre4">root@kvm:~#</strong>
</pre>
<ol start="6" class="calibre18">
<li value="6" class="calibre17">Assign an IP address to bridge:</li>
</ol>
<pre class="calibre25">
<strong class="calibre4">root@kvm:~# ip addr add 192.168.122.1 dev virbr0</strong><br class="calibre7"/><strong class="calibre4">root@kvm:~# ip addr show virbr0</strong><br class="calibre7"/><strong class="calibre4">39: virbr0: &lt;BROADCAST,MULTICAST,UP,LOWER_UP&gt; mtu 1500 qdisc noqueue state UNKNOWN group default</strong><br class="calibre7"/><strong class="calibre4"> link/ether 32:7d:3f:80:d7:c6 brd ff:ff:ff:ff:ff:ff</strong><br class="calibre7"/><strong class="calibre4"> inet 192.168.122.1/32 scope global virbr0</strong><br class="calibre7"/><strong class="calibre4"> valid_lft forever preferred_lft forever</strong><br class="calibre7"/><strong class="calibre4"> inet6 fe80::307d:3fff:fe80:d7c6/64 scope link</strong><br class="calibre7"/><strong class="calibre4"> valid_lft forever preferred_lft forever</strong><br class="calibre7"/><strong class="calibre4">root@kvm:~#</strong>
</pre>
<ol start="7" class="calibre18">
<li value="7" class="calibre17">List the virtual interfaces on the host OS:</li>
</ol>
<pre class="calibre25">
<strong class="calibre4">root@kvm:~# ip a s | grep vnet</strong><br class="calibre7"/><strong class="calibre4">38: vnet0: &lt;BROADCAST,MULTICAST,UP,LOWER_UP&gt; mtu 1500 qdisc pfifo_fast state UNKNOWN group default qlen 500</strong><br class="calibre7"/><strong class="calibre4">root@kvm:~#</strong>
</pre>
<ol start="8" class="calibre18">
<li value="8" class="calibre17">Add the virtual interface <kbd class="calibre13">vnet0</kbd> to the bridge:</li>
</ol>
<pre class="calibre25">
<strong class="calibre4">root@kvm:~# brctl addif virbr0 vnet0</strong><br class="calibre7"/><strong class="calibre4">root@kvm:~# brctl show virbr0</strong><br class="calibre7"/><strong class="calibre4">bridge name     bridge id             STP enabled     interfaces</strong><br class="calibre7"/><strong class="calibre4">virbr0          8000.fe5400559bd6     no              vnet0</strong><br class="calibre7"/><strong class="calibre4">root@kvm:~#</strong>
</pre>
<ol start="9" class="calibre18">
<li value="9" class="calibre17">Enable the <strong class="calibre4">Spanning Tree Protocol</strong> (<strong class="calibre4">STP</strong>) on bridge and obtain more information:</li>
</ol>
<pre class="calibre25">
<strong class="calibre4">root@kvm:~# brctl stp virbr0 on</strong><br class="calibre7"/><strong class="calibre4">root@kvm:~# brctl showstp virbr0</strong><br class="calibre7"/><strong class="calibre4">virbr0</strong><br class="calibre7"/><strong class="calibre4"> bridge id 8000.fe5400559bd6</strong><br class="calibre7"/><strong class="calibre4"> designated root 8000.fe5400559bd6</strong><br class="calibre7"/><strong class="calibre4"> root port 0 path cost 0</strong><br class="calibre7"/><strong class="calibre4"> max age 20.00 bridge max age 20.00</strong><br class="calibre7"/><strong class="calibre4"> hello time 2.00 bridge hello time 2.00</strong><br class="calibre7"/><strong class="calibre4"> forward delay 15.00 bridge forward delay 15.00</strong><br class="calibre7"/><strong class="calibre4"> ageing time 300.00</strong><br class="calibre7"/><strong class="calibre4"> hello timer 0.26 tcn timer 0.00</strong><br class="calibre7"/><strong class="calibre4"> topology change timer 0.00 gc timer 90.89</strong><br class="calibre7"/><strong class="calibre4"> flags</strong><br class="calibre7"/><br class="calibre7"/><br class="calibre7"/><strong class="calibre4">vnet0 (1)</strong><br class="calibre7"/><strong class="calibre4"> port id 8001 state forwarding</strong><br class="calibre7"/><strong class="calibre4"> designated root 8000.fe5400559bd6 path cost 100</strong><br class="calibre7"/><strong class="calibre4"> designated bridge 8000.fe5400559bd6 message age timer 0.00</strong><br class="calibre7"/><strong class="calibre4"> designated port 8001 forward delay timer 0.00</strong><br class="calibre7"/><strong class="calibre4"> designated cost 0 hold timer 0.00</strong><br class="calibre7"/><strong class="calibre4"> flags</strong><br class="calibre7"/><br class="calibre7"/><strong class="calibre4">root@kvm:~#</strong>
</pre>
<ol start="10" class="calibre18">
<li value="10" class="calibre17">From inside the KVM instance, bring the interface up, request an IP address, and test connectivity to the host OS:</li>
</ol>
<pre class="calibre25">
<strong class="calibre4">root@debian:~# ifconfig eth0 up</strong><br class="calibre7"/><strong class="calibre4">root@debian:~# dhclient eth0</strong><br class="calibre7"/><strong class="calibre4">root@debian:~# ip a s eth0</strong><br class="calibre7"/><strong class="calibre4">2: eth0: &lt;BROADCAST,MULTICAST,UP,LOWER_UP&gt; mtu 1500 qdisc pfifo_fast state UP group default qlen 1000</strong><br class="calibre7"/><strong class="calibre4"> link/ether 52:54:00:55:9b:d6 brd ff:ff:ff:ff:ff:ff</strong><br class="calibre7"/><strong class="calibre4"> inet 192.168.122.92/24 brd 192.168.122.255 scope global eth0</strong><br class="calibre7"/><strong class="calibre4"> valid_lft forever preferred_lft forever</strong><br class="calibre7"/><strong class="calibre4"> inet6 fe80::5054:ff:fe55:9bd6/64 scope link</strong><br class="calibre7"/><strong class="calibre4"> valid_lft forever preferred_lft forever</strong><br class="calibre7"/><strong class="calibre4">root@debian:~#</strong><br class="calibre7"/><strong class="calibre4">root@debian:~# ping 192.168.122.1 -c 3</strong><br class="calibre7"/><strong class="calibre4">PING 192.168.122.1 (192.168.122.1) 56(84) bytes of data.</strong><br class="calibre7"/><strong class="calibre4">64 bytes from 192.168.122.1: icmp_seq=1 ttl=64 time=0.276 ms</strong><br class="calibre7"/><strong class="calibre4">64 bytes from 192.168.122.1: icmp_seq=2 ttl=64 time=0.226 ms</strong><br class="calibre7"/><strong class="calibre4">64 bytes from 192.168.122.1: icmp_seq=3 ttl=64 time=0.259 ms</strong><br class="calibre7"/><br class="calibre7"/><strong class="calibre4">--- 192.168.122.1 ping statistics ---</strong><br class="calibre7"/><strong class="calibre4">3 packets transmitted, 3 received, 0% packet loss, time 1999ms</strong><br class="calibre7"/><strong class="calibre4">rtt min/avg/max/mdev = 0.226/0.253/0.276/0.027 ms</strong><br class="calibre7"/><strong class="calibre4">root@debian:~#</strong>
</pre>


            </article>

            <footer class="calibre5">
                
            </footer>

        </section>
    

        <section class="calibre1">

            <header class="calibre1">
                </header><h1 class="header-title" id="calibre_pb_0">How it works...</h1>
            

            <article class="calibre1">
                
<p class="calibre3">When we first installed and started the <kbd class="calibre13">libvirt</kbd> daemon, a few things happened automatically:</p>
<ul class="calibre16">
<li class="calibre17">A new Linux bridge was created with the name and IP address defined in the <kbd class="calibre13">/etc/libvirt/qemu/networks/default.xml</kbd> configuration file</li>
<li class="calibre17">The <kbd class="calibre13">dnsmasq</kbd> service was started with a configuration specified in the <kbd class="calibre13">/var/lib/libvirt/dnsmasq/default.conf</kbd> file</li>
</ul>
<p class="calibre3">Let's examine the default <kbd class="calibre13">libvirt</kbd> bridge configuration:</p>
<pre class="calibre23">
<strong class="calibre4">root@kvm:~# cat /etc/libvirt/qemu/networks/default.xml</strong><br class="calibre7"/><strong class="calibre4">&lt;network&gt;</strong><br class="calibre7"/><strong class="calibre4"> &lt;name&gt;default&lt;/name&gt;</strong><br class="calibre7"/><strong class="calibre4"> &lt;bridge name="virbr0"/&gt;</strong><br class="calibre7"/><strong class="calibre4"> &lt;forward/&gt;</strong><br class="calibre7"/><strong class="calibre4"> &lt;ip address="192.168.122.1" netmask="255.255.255.0"&gt;</strong><br class="calibre7"/><strong class="calibre4">   &lt;dhcp&gt;</strong><br class="calibre7"/><strong class="calibre4">     &lt;range start="192.168.122.2" end="192.168.122.254"/&gt;</strong><br class="calibre7"/><strong class="calibre4">   &lt;/dhcp&gt;</strong><br class="calibre7"/><strong class="calibre4"> &lt;/ip&gt;</strong><br class="calibre7"/><strong class="calibre4">&lt;/network&gt;</strong><br class="calibre7"/><strong class="calibre4">root@kvm:~#</strong>
</pre>
<p class="calibre3">This is the default network that libvirt created for us, specifying the bridge name, IP address, and the IP range used by the DHCP server that was started. We are going to talk about libvirt networking in much more detail later in this chapter; however, we've shown it here to help you understand where all the IP addresses and the bridge name came from.</p>
<p class="calibre3">We can see that a DHCP server is running on the host OS and its configuration file by running the following command:</p>
<pre class="calibre23">
<strong class="calibre4">root@kvm:~# pgrep -lfa dnsmasq</strong><br class="calibre7"/><strong class="calibre4">38983 /usr/sbin/dnsmasq --conf-file=/var/lib/libvirt/dnsmasq/default.conf</strong><br class="calibre7"/><strong class="calibre4">root@kvm:~# cat /var/lib/libvirt/dnsmasq/default.conf</strong><br class="calibre7"/><strong class="calibre4">##WARNING: THIS IS AN AUTO-GENERATED FILE. CHANGES TO IT ARE LIKELY TO BE</strong><br class="calibre7"/><strong class="calibre4">##OVERWRITTEN AND LOST. Changes to this configuration should be made using:</strong><br class="calibre7"/><strong class="calibre4">## virsh net-edit default</strong><br class="calibre7"/><strong class="calibre4">## or other application using the libvirt API.</strong><br class="calibre7"/><strong class="calibre4">##</strong><br class="calibre7"/><strong class="calibre4">## dnsmasq conf file created by libvirt</strong><br class="calibre7"/><strong class="calibre4">strict-order</strong><br class="calibre7"/><strong class="calibre4">user=libvirt-dnsmasq</strong><br class="calibre7"/><strong class="calibre4">pid-file=/var/run/libvirt/network/default.pid</strong><br class="calibre7"/><strong class="calibre4">except-interface=lo</strong><br class="calibre7"/><strong class="calibre4">bind-dynamic</strong><br class="calibre7"/><strong class="calibre4">interface=virbr0</strong><br class="calibre7"/><strong class="calibre4">dhcp-range=192.168.122.2,192.168.122.254</strong><br class="calibre7"/><strong class="calibre4">dhcp-no-override</strong><br class="calibre7"/><strong class="calibre4">dhcp-leasefile=/var/lib/libvirt/dnsmasq/default.leases</strong><br class="calibre7"/><strong class="calibre4">dhcp-lease-max=253</strong><br class="calibre7"/><strong class="calibre4">dhcp-hostsfile=/var/lib/libvirt/dnsmasq/default.hostsfile</strong><br class="calibre7"/><strong class="calibre4">addn-hosts=/var/lib/libvirt/dnsmasq/default.addnhosts</strong><br class="calibre7"/><strong class="calibre4">root@kvm:~#</strong>
</pre>
<p class="calibre3">From the configuration file earlier, note how the IP address range for the DHCP service  and the name of the virtual bridge match what is configured in the default libvirt network file that we just saw.</p>
<p class="calibre3">With all this in mind, let's step through all the actions we performed earlier:</p>
<p class="calibre3">In step 1, we installed the userspace tool <kbd class="calibre13">brctl</kbd> that we use to create, configure, and inspect the Linux bridge configuration in the Linux kernel.</p>
<p class="calibre3">In step 2, we provisioned a new KVM instance using a custom raw image containing the guest OS. This step is not required if you completed the recipes in the previous chapters. </p>
<p class="calibre3">In step 3, we invoked the <kbd class="calibre13">bridge</kbd> utility to list all available bridge devices. From the output, we can observe that currently there's one bridge, named <kbd class="calibre13">virbr0</kbd>, which libvirt created automatically. Note that under the interfaces column, we can see the <kbd class="calibre13">vnet0</kbd> interface. This is the virtual NIC that was exposed to the host OS, when we started the KVM instance. This means that the virtual machine is connected to the host bridge.</p>
<p class="calibre3">In step 4, we first bring the bridge down in order to delete it, then we use the <kbd class="calibre13">brctl</kbd> command again to remove the bridge and ensure that it's not present on the host OS.</p>
<p class="calibre3">In step 5, we recreated the bridge and brought it back up. We do this to demonstrate the steps required to create a new bridge.</p>
<p class="calibre3">In step 6, we reassigned the same IP address to the bridge and listed it.</p>
<p class="calibre3">In steps 7 and 8, we list all virtual interfaces on the host OS. Because we only have one KVM guest currently running on the server, we only see one virtual interface, that is, <kbd class="calibre13">vnet0</kbd>. We then proceed to add/connect the virtual NIC to the bridge.</p>
<p class="calibre3">In step 9, we enabled the STP on the bridge. STP is a layer 2 protocol that helps prevent network loops if we have redundant network paths. This is especially useful in larger, more complex network topologies, where multiple bridges are connected together.</p>
<p class="calibre3">Finally, in step 10, we connect to the KVM guest using the console, list its interface configuration, and ensure that we can ping the bridge on the host OS. In order to do that, we need to bring the network interface inside the guest up with <kbd class="calibre13">ifconfig eth0 up</kbd>, then obtain an IP address with the <kbd class="calibre13">dhclient eth0</kbd> command from the <kbd class="calibre13">dnsmasq</kbd> server running on the host.</p>


            </article>

            <footer class="calibre5">
                
            </footer>

        </section>
    

        <section class="calibre1">

            <header class="calibre1">
                </header><h1 class="header-title" id="calibre_pb_0">There's more...</h1>
            

            <article class="calibre1">
                
<p class="calibre3">There are few more useful commands we can use on the Linux bridge.</p>
<p class="calibre3">We already know that a bridge forwards frames based on the MAC addresses contained therein. To examine the table of MAC addresses the bridge knows about, run the following command:</p>
<pre class="calibre23">
<strong class="calibre4">root@kvm:~# brctl showmacs virbr0</strong><br class="calibre7"/><strong class="calibre4">port no  mac addr               is local?      ageing timer</strong><br class="calibre7"/><strong class="calibre4">  1      52:54:00:55:9b:d6      no             268.02</strong><br class="calibre7"/><strong class="calibre4">  1      fe:54:00:55:9b:d6      yes            0.00</strong><br class="calibre7"/><strong class="calibre4">root@kvm:~#</strong>
</pre>
<p class="calibre3">From the preceding output, we can see that the bridge has recorded two MAC addresses on its only port. The first record is a nonlocal address, and it belongs to the network interface inside the KVM instances. We can confirm that by connecting to the KVM guest as follows:</p>
<pre class="calibre23">
<strong class="calibre4">root@kvm:~# virsh console kvm1</strong><br class="calibre7"/><strong class="calibre4">Connected to domain kvm1</strong><br class="calibre7"/><strong class="calibre4">Escape character is ^]</strong><br class="calibre7"/><br class="calibre7"/><strong class="calibre4">root@debian:~# ip a s eth0</strong><br class="calibre7"/><strong class="calibre4">2: eth0: &lt;BROADCAST,MULTICAST,UP,LOWER_UP&gt; mtu 1500 qdisc pfifo_fast state UP group default qlen 1000</strong><br class="calibre7"/><strong class="calibre4"> link/ether 52:54:00:55:9b:d6 brd ff:ff:ff:ff:ff:ff</strong><br class="calibre7"/><strong class="calibre4"> inet6 fe80::5054:ff:fe55:9bd6/64 scope link</strong><br class="calibre7"/><strong class="calibre4"> valid_lft forever preferred_lft forever</strong><br class="calibre7"/><strong class="calibre4">root@debian:~#</strong>
</pre>
<p class="calibre3">The second MAC address is the address of the bridge itself and the MAC address of the virtual interface, belonging to the KVM virtual machine, exposed to the host OS. To confirm this, run the following command:</p>
<pre class="calibre23">
<strong class="calibre4">root@kvm:~# ifconfig | grep "fe:54:00:55:9b:d6"</strong><br class="calibre7"/><strong class="calibre4">virbr0 Link encap:Ethernet HWaddr fe:54:00:55:9b:d6</strong><br class="calibre7"/><strong class="calibre4">vnet0  Link encap:Ethernet HWaddr fe:54:00:55:9b:d6</strong><br class="calibre7"/><strong class="calibre4">root@kvm:~#</strong>
</pre>
<p class="calibre3">When the bridge sees a frame on one of its ports, it records the time then after a set amount of time not seeing the same MAC address again, it will remove the record from the its CAM table. We can set the time limit in seconds before the bridge will expire the MAC address entry by executing the following command:</p>
<pre class="calibre23">
<strong class="calibre4">root@kvm:~# brctl setageing virbr0 600</strong><br class="calibre7"/><strong class="calibre4">root@kvm:~#</strong>
</pre>
<p class="calibre3">The <kbd class="calibre13">brctl</kbd> command is well documented; to list all available subcommands, run it without any parameters:</p>
<pre class="calibre28">
<strong class="calibre4">root@kvm:~# brctl</strong><br class="calibre7"/><strong class="calibre4">Usage: brctl [commands]</strong><br class="calibre7"/><strong class="calibre4">commands:</strong><br class="calibre7"/><strong class="calibre4">        addbr &lt;bridge&gt; add bridge</strong><br class="calibre7"/><strong class="calibre4">        delbr &lt;bridge&gt; delete bridge</strong><br class="calibre7"/><strong class="calibre4">        addif &lt;bridge&gt; &lt;device&gt; add interface to bridge</strong><br class="calibre7"/><strong class="calibre4">        delif &lt;bridge&gt; &lt;device&gt; delete interface from bridge</strong><br class="calibre7"/><strong class="calibre4">        hairpin &lt;bridge&gt; &lt;port&gt; {on|off} turn hairpin on/off</strong><br class="calibre7"/><strong class="calibre4">        setageing &lt;bridge&gt; &lt;time&gt; set ageing time</strong><br class="calibre7"/><strong class="calibre4">        setbridgeprio &lt;bridge&gt; &lt;prio&gt; set bridge priority</strong><br class="calibre7"/><strong class="calibre4">        setfd &lt;bridge&gt; &lt;time&gt; set bridge forward delay</strong><br class="calibre7"/><strong class="calibre4">        sethello &lt;bridge&gt; &lt;time&gt; set hello time</strong><br class="calibre7"/><strong class="calibre4">        setmaxage &lt;bridge&gt; &lt;time&gt; set max message age</strong><br class="calibre7"/><strong class="calibre4">        setpathcost &lt;bridge&gt; &lt;port&gt; &lt;cost&gt; set path cost</strong><br class="calibre7"/><strong class="calibre4">        setportprio &lt;bridge&gt; &lt;port&gt; &lt;prio&gt; set port priority</strong><br class="calibre7"/><strong class="calibre4">        show [ &lt;bridge&gt; ] show a list of bridges</strong><br class="calibre7"/><strong class="calibre4">        showmacs &lt;bridge&gt; show a list of mac addrs</strong><br class="calibre7"/><strong class="calibre4">        showstp &lt;bridge&gt; show bridge stp info</strong><br class="calibre7"/><strong class="calibre4">        stp &lt;bridge&gt; {on|off} turn stp on/off</strong><br class="calibre7"/><strong class="calibre4">root@kvm:~#</strong>
</pre>
<p class="calibre3">Most Linux distributions package the <kbd class="calibre13">brctl</kbd> utility and this is what we used in this recipe. However, to use the latest version, or if a package is not available for your distribution, we can build the utility from source by cloning the project with <kbd class="calibre13">git</kbd>, then configure and compile:</p>
<pre class="calibre23">
<strong class="calibre4">root@kvm:~# cd /usr/src/</strong><br class="calibre7"/><strong class="calibre4">root@kvm:/usr/src# apt-get update &amp;&amp; apt-get install build-essential automake pkg-config git</strong><br class="calibre7"/><strong class="calibre4">root@kvm:/usr/src# git clone git://git.kernel.org/pub/scm/linux/kernel/git/shemminger/bridge-utils.git</strong><br class="calibre7"/><strong class="calibre4">Cloning into 'bridge-utils'...</strong><br class="calibre7"/><strong class="calibre4">remote: Counting objects: 654, done.</strong><br class="calibre7"/><strong class="calibre4">remote: Total 654 (delta 0), reused 0 (delta 0)</strong><br class="calibre7"/><strong class="calibre4">Receiving objects: 100% (654/654), 131.72 KiB | 198.00 KiB/s, done.</strong><br class="calibre7"/><strong class="calibre4">Resolving deltas: 100% (425/425), done.</strong><br class="calibre7"/><strong class="calibre4">Checking connectivity... done.</strong><br class="calibre7"/><strong class="calibre4">root@kvm:/usr/src# cd bridge-utils/</strong><br class="calibre7"/><strong class="calibre4">root@kvm:/usr/src/bridge-utils# autoconf</strong><br class="calibre7"/><strong class="calibre4">root@kvm:/usr/src/bridge-utils# ./configure &amp;&amp; make &amp;&amp; make install</strong><br class="calibre7"/><strong class="calibre4">root@kvm:/usr/src/bridge-utils# brctl --version</strong><br class="calibre7"/><strong class="calibre4">bridge-utils, 1.5</strong><br class="calibre7"/><strong class="calibre4">root@kvm:/usr/src/bridge-utils#</strong>
</pre>
<p class="calibre3">From the preceding output, we can see that we first cloned the <kbd class="calibre13">git</kbd> repository for the <kbd class="calibre13">bridge-utils</kbd> project and then compiled the source code.</p>
<p class="calibre3">On a RedHat/CentOS host, the process is similar:</p>
<pre class="calibre23">
<strong class="calibre4">[root@centos ~]# cd /usr/src/</strong><br class="calibre7"/><strong class="calibre4">[root@centos src]#</strong><br class="calibre7"/><strong class="calibre4">[root@centos src]# yum groupinstall "Development tools"</strong><br class="calibre7"/><strong class="calibre4">[root@centos src]# git clone git://git.kernel.org/pub/scm/linux/kernel/git/shemminger/bridge-utils.git</strong><br class="calibre7"/><strong class="calibre4">Cloning into 'bridge-utils'...</strong><br class="calibre7"/><strong class="calibre4">remote: Counting objects: 654, done.</strong><br class="calibre7"/><strong class="calibre4">remote: Total 654 (delta 0), reused 0 (delta 0)</strong><br class="calibre7"/><strong class="calibre4">Receiving objects: 100% (654/654), 131.72 KiB | 198.00 KiB/s, done.</strong><br class="calibre7"/><strong class="calibre4">Resolving deltas: 100% (425/425), done.</strong><br class="calibre7"/><strong class="calibre4">Checking connectivity... done.</strong><br class="calibre7"/><strong class="calibre4">[root@centos src]# cd bridge-utils</strong><br class="calibre7"/><strong class="calibre4">[root@centos bridge-utils]# autoconf</strong><br class="calibre7"/><strong class="calibre4">[root@centos bridge-utils]# ./configure &amp;&amp; make &amp;&amp; make install</strong><br class="calibre7"/><strong class="calibre4">[root@centos bridge-utils]# brctl --version</strong><br class="calibre7"/><strong class="calibre4">bridge-utils, 1.5</strong><br class="calibre7"/><strong class="calibre4">[root@centos bridge-utils]#</strong>
</pre>


            </article>

            <footer class="calibre5">
                
            </footer>

        </section>
    

        <section class="calibre1">

            <header class="calibre1">
                </header><h1 class="header-title" id="calibre_pb_0">The Open vSwitch</h1>
            

            <article class="calibre1">
                
<p class="calibre3">OVS is another software bridging/switching device that can be used to create various virtual network topologies and connect KVM instances to it. OVS can be used instead of the Linux bridge, and it provides an extensive feature set, including policy routing, <strong class="calibre4">Access Control Lists</strong> (<strong class="calibre4">ACLs</strong>), <strong class="calibre4">Quality of Service</strong> (<strong class="calibre4">QoS</strong>) policing, traffic monitoring, flow management, VLAN tagging, GRE tunneling, and much more.</p>
<p class="calibre3">In this recipe, we are going to install, configure, and use the OVS bridge to connect a KVM instance to the host OS, in a similar way to what we did in the previous recipe with the Linux bridge.</p>


            </article>

            <footer class="calibre5">
                
            </footer>

        </section>
    

        <section class="calibre1">

            <header class="calibre1">
                </header><h1 class="header-title" id="calibre_pb_0">Getting ready</h1>
            

            <article class="calibre1">
                
<p class="calibre3">In order for this recipe to work, we need to ensure the following:</p>
<ul class="calibre16">
<li class="calibre17">The Linux bridge is deleted, if present, and OVS is installed</li>
<li class="calibre17">We have at least one KVM instance running</li>
</ul>


            </article>

            <footer class="calibre5">
                
            </footer>

        </section>
    

        <section class="calibre1">

            <header class="calibre1">
                </header><h1 class="header-title" id="calibre_pb_0">How to do it...</h1>
            

            <article class="calibre1">
                
<p class="calibre3">To create a new OVS bridge and attach the virtual interface of a KVM guest, follow these steps:</p>
<ol class="calibre18">
<li value="1" class="calibre17"><span>Remove the existing Linux</span> bridge<span>, if any:</span></li>
</ol>
<pre class="calibre25">
<strong class="calibre4">root@kvm:~# brctl show</strong><br class="calibre7"/><strong class="calibre4">bridge name      bridge id             STP enabled      interfaces</strong><br class="calibre7"/><strong class="calibre4">virbr0           8000.fe5400559bd6     yes              vnet0</strong><br class="calibre7"/><strong class="calibre4">root@kvm:~# ifconfig virbr0 down</strong><br class="calibre7"/><strong class="calibre4">root@kvm:~# brctl delbr virbr0</strong><br class="calibre7"/><strong class="calibre4">root@kvm:~# brctl show</strong><br class="calibre7"/><strong class="calibre4">bridge name bridge id STP enabled interfaces</strong><br class="calibre7"/><strong class="calibre4">root@kvm:~#</strong>
</pre>
<div class="packt_tip">On some Linux distributions, it helps to unload the kernel module for the Linux bridge before using OVS. To do this, execute <kbd class="calibre27">root@kvm:/usr/src# modprobe -r bridge</kbd>.</div>
<ol start="2" class="calibre18">
<li value="2" class="calibre17">Install the OVS package on Ubuntu:</li>
</ol>
<pre class="calibre25">
<strong class="calibre4">root@kvm:~# apt-get install openvswitch-switch</strong><br class="calibre7"/><strong class="calibre4">...</strong><br class="calibre7"/><strong class="calibre4">Setting up openvswitch-common (2.0.2-0ubuntu0.14.04.3) ...</strong><br class="calibre7"/><strong class="calibre4">Setting up openvswitch-switch (2.0.2-0ubuntu0.14.04.3) ...</strong><br class="calibre7"/><strong class="calibre4">openvswitch-switch start/running</strong><br class="calibre7"/><strong class="calibre4">...</strong><br class="calibre7"/><strong class="calibre4">root@kvm:~#</strong>
</pre>
<ol start="3" class="calibre18">
<li value="3" class="calibre17">Ensure that the OVS processes are running:</li>
</ol>
<pre class="calibre25">
<strong class="calibre4">root@kvm:~# pgrep -lfa switch</strong><br class="calibre7"/><strong class="calibre4">22255 ovsdb-server /etc/openvswitch/conf.db -vconsole:emer -vsyslog:err -vfile:info --remote=punix:/var/run/openvswitch/db.sock --private-key=db:Open_vSwitch,SSL,private_key --certificate=db:Open_vSwitch,SSL,certificate --bootstrap-ca-cert=db:Open_vSwitch,SSL,ca_cert --no-chdir --log-file=/var/log/openvswitch/ovsdb-server.log --pidfile=/var/run/openvswitch/ovsdb-server.pid --detach --monitor</strong><br class="calibre7"/><strong class="calibre4">22264 ovs-vswitchd: monitoring pid 22265 (healthy)</strong><br class="calibre7"/><strong class="calibre4">22265 ovs-vswitchd unix:/var/run/openvswitch/db.sock -vconsole:emer -vsyslog:err -vfile:info --mlockall --no-chdir --log-file=/var/log/openvswitch/ovs-vswitchd.log --pidfile=/var/run/openvswitch/ovs-vswitchd.pid --detach --monitor</strong><br class="calibre7"/><strong class="calibre4">root@kvm:~#</strong>
</pre>
<ol start="4" class="calibre18">
<li value="4" class="calibre17">Ensure that the OVS kernel module has been loaded:</li>
</ol>
<pre class="calibre25">
<strong class="calibre4">root@kvm:~# lsmod | grep switch</strong><br class="calibre7"/><strong class="calibre4">openvswitch       70989   0</strong><br class="calibre7"/><strong class="calibre4">gre               13796   1 openvswitch</strong><br class="calibre7"/><strong class="calibre4">vxlan             37611   1 openvswitch</strong><br class="calibre7"/><strong class="calibre4">libcrc32c         12644   1 openvswitch</strong><br class="calibre7"/><strong class="calibre4">root@kvm:~#</strong>
</pre>
<ol start="5" class="calibre18">
<li value="5" class="calibre17">List the available OVS switches:</li>
</ol>
<pre class="calibre25">
<strong class="calibre4">root@kvm:~# ovs-vsctl show</strong><br class="calibre7"/><strong class="calibre4">e5164e3e-7897-4717-b766-eae1918077b0</strong><br class="calibre7"/><strong class="calibre4"> ovs_version: "2.0.2"</strong><br class="calibre7"/><strong class="calibre4">root@kvm:~#</strong>
</pre>
<ol start="6" class="calibre18">
<li value="6" class="calibre17">Create a new OVS switch:</li>
</ol>
<pre class="calibre25">
<strong class="calibre4">root@kvm:~# ovs-vsctl add-br virbr1</strong><br class="calibre7"/><strong class="calibre4">root@kvm:~# ovs-vsctl show</strong><br class="calibre7"/><strong class="calibre4">e5164e3e-7897-4717-b766-eae1918077b0</strong><br class="calibre7"/><strong class="calibre4"> Bridge "virbr1"</strong><br class="calibre7"/><strong class="calibre4">   Port "virbr1"</strong><br class="calibre7"/><strong class="calibre4">     Interface "virbr1"</strong><br class="calibre7"/><strong class="calibre4">       type: internal</strong><br class="calibre7"/><strong class="calibre4"> ovs_version: "2.0.2"</strong><br class="calibre7"/><strong class="calibre4">root@kvm:~#</strong>
</pre>
<ol start="7" class="calibre18">
<li value="7" class="calibre17">Add the interface of the running KVM instance to the OVS switch:</li>
</ol>
<pre class="calibre25">
<strong class="calibre4">root@kvm:~# ovs-vsctl add-port virbr1 vnet0</strong><br class="calibre7"/><strong class="calibre4">root@kvm:~# ovs-vsctl show</strong><br class="calibre7"/><strong class="calibre4">e5164e3e-7897-4717-b766-eae1918077b0</strong><br class="calibre7"/><strong class="calibre4"> Bridge "virbr1"</strong><br class="calibre7"/><strong class="calibre4">   Port "virbr1"</strong><br class="calibre7"/><strong class="calibre4">     Interface "virbr1"</strong><br class="calibre7"/><strong class="calibre4">       type: internal</strong><br class="calibre7"/><strong class="calibre4">   Port "vnet0"</strong><br class="calibre7"/><strong class="calibre4">     Interface "vnet0"</strong><br class="calibre7"/><strong class="calibre4"> ovs_version: "2.0.2"</strong><br class="calibre7"/><strong class="calibre4">root@kvm:~#</strong>
</pre>
<ol start="8" class="calibre18">
<li value="8" class="calibre17">Configure an IP address on the OVS switch:</li>
</ol>
<pre class="calibre25">
<strong class="calibre4">root@kvm:~# ip addr add 192.168.122.1/24 dev virbr1</strong><br class="calibre7"/><strong class="calibre4">root@kvm:~# ip addr show virbr1</strong><br class="calibre7"/><strong class="calibre4">41: virbr1: &lt;BROADCAST,UP,LOWER_UP&gt; mtu 1500 qdisc noqueue state UNKNOWN group default</strong><br class="calibre7"/><strong class="calibre4"> link/ether b2:52:e0:73:89:4e brd ff:ff:ff:ff:ff:ff</strong><br class="calibre7"/><strong class="calibre4"> inet 192.168.122.1/24 scope global virbr1</strong><br class="calibre7"/><strong class="calibre4"> valid_lft forever preferred_lft forever</strong><br class="calibre7"/><strong class="calibre4"> inet6 fe80::b0a8:c2ff:fed4:bb3f/64 scope link</strong><br class="calibre7"/><strong class="calibre4"> valid_lft forever preferred_lft forever</strong><br class="calibre7"/><strong class="calibre4">root@kvm:~#</strong>
</pre>
<ol start="9" class="calibre18">
<li value="9" class="calibre17">Configure an IP address inside the KVM guest and ensure connectivity to the host OS (if the image does not have console access configure, connect to it using VNC):</li>
</ol>
<pre class="calibre25">
<strong class="calibre4">root@kvm:~# virsh console kvm1</strong><br class="calibre7"/><strong class="calibre4">Connected to domain kvm1</strong><br class="calibre7"/><strong class="calibre4">Escape character is ^]</strong><br class="calibre7"/><br class="calibre7"/><strong class="calibre4">root@debian:~# ifconfig eth0 up &amp;&amp; ip addr add 192.168.122.210/24 dev eth0</strong><br class="calibre7"/><strong class="calibre4">root@debian:~# ip addr show eth0</strong><br class="calibre7"/><strong class="calibre4">2: eth0: &lt;BROADCAST,MULTICAST,UP,LOWER_UP&gt; mtu 1500 qdisc pfifo_fast state UP group default qlen 1000</strong><br class="calibre7"/><strong class="calibre4"> link/ether 52:54:00:55:9b:d6 brd ff:ff:ff:ff:ff:ff</strong><br class="calibre7"/><strong class="calibre4"> inet 192.168.122.210/24 scope global eth0</strong><br class="calibre7"/><strong class="calibre4"> valid_lft forever preferred_lft forever</strong><br class="calibre7"/><strong class="calibre4"> inet6 fe80::5054:ff:fe55:9bd6/64 scope link</strong><br class="calibre7"/><strong class="calibre4"> valid_lft forever preferred_lft forever</strong><br class="calibre7"/><strong class="calibre4">root@debian:~# ping 192.168.122.1</strong><br class="calibre7"/><strong class="calibre4">PING 192.168.122.1 (192.168.122.1) 56(84) bytes of data.</strong><br class="calibre7"/><strong class="calibre4">64 bytes from 192.168.122.1: icmp_seq=1 ttl=64 time=0.711 ms</strong><br class="calibre7"/><strong class="calibre4">64 bytes from 192.168.122.1: icmp_seq=2 ttl=64 time=0.394 ms</strong><br class="calibre7"/><strong class="calibre4">64 bytes from 192.168.122.1: icmp_seq=3 ttl=64 time=0.243 ms</strong><br class="calibre7"/><strong class="calibre4">^C</strong><br class="calibre7"/><strong class="calibre4">--- 192.168.122.1 ping statistics ---</strong><br class="calibre7"/><strong class="calibre4">3 packets transmitted, 3 received, 0% packet loss, time 2001ms</strong><br class="calibre7"/><strong class="calibre4">rtt min/avg/max/mdev = 0.243/0.449/0.711/0.195 ms</strong><br class="calibre7"/><strong class="calibre4">root@debian:~#</strong>
</pre>


            </article>

            <footer class="calibre5">
                
            </footer>

        </section>
    

        <section class="calibre1">

            <header class="calibre1">
                </header><h1 class="header-title" id="calibre_pb_0">How it works...</h1>
            

            <article class="calibre1">
                
<p class="calibre3">In order to simplify our setup and avoid conflicts, it's prudent to first remove the Linux bridge before creating a new OVS switch. We delete the bridge in step 1 and optionally unloaded the kernel module.</p>
<p class="calibre3">In step 2, we install the OVS package that also starts the main OVS daemon <kbd class="calibre13">ovs-vswitchd</kbd> responsible for creating and modifying the bridges/switches on the host OS.</p>
<p class="calibre3">In step 4, we make sure that the OVS kernel module has been loaded, and we list all available OVS switches on the host in step 5.</p>
<p class="calibre3">In steps 6 and 7, we create a new OVS switch and add the KVM virtual interface to the switch.</p>
<p class="calibre3">The <kbd class="calibre13">ovsdb</kbd>-server process that was also started after installing the package, as seen from the output in step 3, is a database engine that uses JSON <strong class="calibre4">Remote Procedure Calls</strong> (<strong class="calibre4">RPC</strong>) to communicate with the main OVS daemon. The <kbd class="calibre13">ovsdb</kbd> server process stores information, such as the switch network flows, ports, and <kbd class="calibre13">QoS</kbd> to name just few. You can query the database by running the following command:</p>
<pre class="calibre23">
<strong class="calibre4">root@kvm:~# ovsdb-client list-dbs</strong><br class="calibre7"/><strong class="calibre4">Open_vSwitch</strong><br class="calibre7"/><strong class="calibre4">root@kvm:~# ovsdb-client list-tables</strong><br class="calibre7"/><strong class="calibre4">Table</strong><br class="calibre7"/><strong class="calibre4">-------------------------</strong><br class="calibre7"/><strong class="calibre4">Port</strong><br class="calibre7"/><strong class="calibre4">Manager</strong><br class="calibre7"/><strong class="calibre4">Bridge</strong><br class="calibre7"/><strong class="calibre4">Interface</strong><br class="calibre7"/><strong class="calibre4">SSL</strong><br class="calibre7"/><strong class="calibre4">IPFIX</strong><br class="calibre7"/><strong class="calibre4">Open_vSwitch</strong><br class="calibre7"/><strong class="calibre4">Queue</strong><br class="calibre7"/><strong class="calibre4">NetFlow</strong><br class="calibre7"/><strong class="calibre4">Mirror</strong><br class="calibre7"/><strong class="calibre4">QoS</strong><br class="calibre7"/><strong class="calibre4">Controller</strong><br class="calibre7"/><strong class="calibre4">Flow_Table</strong><br class="calibre7"/><strong class="calibre4">sFlow</strong><br class="calibre7"/><strong class="calibre4">Flow_Sample_Collector_Set</strong><br class="calibre7"/><strong class="calibre4">root@kvm:~# ovsdb-client dump Open_vSwitch</strong><br class="calibre7"/><strong class="calibre4">...</strong><br class="calibre7"/><strong class="calibre4">Port table</strong><br class="calibre7"/><strong class="calibre4">_uuid bond_downdelay bond_fake_iface bond_mode bond_updelay external_ids fake_bridge interfaces lacp mac name other_config qos statistics status tag trunks vlan_mode</strong><br class="calibre7"/><strong class="calibre4">------------------------------------ -------------- --------------- --------- ------------ ------------ ----------- -------------------------------------- ---- --- -------- ------------ --- ---------- ------ --- ------ ---------</strong><br class="calibre7"/><strong class="calibre4">9b4b743d-66b2-4779-9dd8-404b3aa55e18 0 false [] 0 {} false [e7ed4e2b-a73c-46c7-adeb-a203be56587c] [] [] "virbr1" {} [] {} {} [] [] []</strong><br class="calibre7"/><strong class="calibre4">f2a033aa-9072-4be3-808e-6e0fce67ce7b 0 false [] 0 {} false [86a10eed-698f-4ccc-b3b7-dd20c13e3ee3] [] [] "vnet0" {} [] {} {} [] [] []</strong><br class="calibre7"/><strong class="calibre4">...</strong><br class="calibre7"/><strong class="calibre4">root@kvm:~#</strong>
</pre>
<p class="calibre3">Note from the preceding output that the new switch <kbd class="calibre13">virbr1</kbd> and port <kbd class="calibre13">vnet0</kbd> are now displaying, when querying the OVS database.</p>
<p class="calibre3">In steps 8 and 9, we assign IP addresses to the OVS switch and the KVM guest and ensure that we can reach the host bridge from inside the virtual machine.</p>


            </article>

            <footer class="calibre5">
                
            </footer>

        </section>
    

        <section class="calibre1">

            <header class="calibre1">
                </header><h1 class="header-title" id="calibre_pb_0">There's more...</h1>
            

            <article class="calibre1">
                
<p class="calibre3">OVS is a rather complex software switch; in this recipe, we only scratched the surface. In the next few recipes, we can use both the Linux bridge and OVS, with minor configuration changes in libvirt, which we are going to point out as we go.</p>
<p class="calibre3">To remove the KVM virtual interface from the OVS switch, execute the following command:</p>
<pre class="calibre23">
<strong class="calibre4">root@kvm:~# ovs-vsctl del-port virbr1 vnet0</strong><br class="calibre7"/><strong class="calibre4">root@kvm:~#</strong>
</pre>
<p class="calibre3">To completely delete the OVS switch, run the following command:</p>
<pre class="calibre23">
<strong class="calibre4">root@kvm:~# ovs-vsctl del-br virbr1 &amp;&amp; ovs-vsctl show</strong><br class="calibre7"/><strong class="calibre4">e5164e3e-7897-4717-b766-eae1918077b0</strong><br class="calibre7"/><strong class="calibre4"> ovs_version: "2.0.2"</strong><br class="calibre7"/><strong class="calibre4">root@kvm:~#</strong>
</pre>
<div class="packt_infobox">For more information about the OVS, please visit the projects website, <a href="http://openvswitch.org/" class="calibre30">http://openvswitch.org/</a>.</div>


            </article>

            <footer class="calibre5">
                
            </footer>

        </section>
    

        <section class="calibre1">

            <header class="calibre1">
                </header><h1 class="header-title" id="calibre_pb_0">Configuring NAT forwarding network</h1>
            

            <article class="calibre1">
                
<p class="calibre3">When the <kbd class="calibre13">libvirt</kbd> daemon starts, it creates a default network defined in the <kbd class="calibre13">/etc/libvirt/qemu/networks/default.xml</kbd> configuration file. When a new KVM guest is build without specifying any networking options, it will use the default network to communicate with the host OS and other guests and networks. The default <kbd class="calibre13">libvirt</kbd> network is using the <strong class="calibre4">Network Address Translation</strong> (<strong class="calibre4">NAT</strong>) method.  NAT provides a mapping from one IP address space to another, by modifying the IP address in the header of the IP datagram packet. This is especially useful when the host OS provides one IP address allowing multiple guests on the same host to use that address to establish outbound connections. The virtual machines IP<span> addresses are essentially translated to appear as the host machine's IP address.<br class="calibre7"/></span></p>
<p class="calibre3"><span>The default NAT forwarding network defines and sets up a Linux</span> bridge, <span>for the guests to connect to. In this recipe, we are going to explore the default NAT network and learn about the XML attributes used to define it. Then, we are going to create a new NAT network and connect our KVM guest to it.</span></p>


            </article>

            <footer class="calibre5">
                
            </footer>

        </section>
    

        <section class="calibre1">

            <header class="calibre1">
                </header><h1 class="header-title" id="calibre_pb_0">Getting ready</h1>
            

            <article class="calibre1">
                
<p class="calibre3">For this recipe, we are going to need the following:</p>
<ul class="calibre16">
<li class="calibre17">A Linux host with libvirt installed and the daemon running.</li>
<li class="calibre17">The <kbd class="calibre13">iptables</kbd> and <kbd class="calibre13">iproute2</kbd> packages installed on the host OS. If you installed libvirt from a package, chances are that <kbd class="calibre13">iptables</kbd> and <kbd class="calibre13">iproute2</kbd>  have been installed, as dependencies of the <kbd class="calibre13">libvirt</kbd> package. If you've built libvirt from source, you might need to install them manually.</li>
<li class="calibre17">A running KVM instances.</li>
</ul>


            </article>

            <footer class="calibre5">
                
            </footer>

        </section>
    

        <section class="calibre1">

            <header class="calibre1">
                </header><h1 class="header-title" id="calibre_pb_0">How to do it...</h1>
            

            <article class="calibre1">
                
<p class="calibre3">To configure a new NAT network and connect a KVM instance to it, run the following:</p>
<ol class="calibre18">
<li value="1" class="calibre17"><span>List all available networks:</span></li>
</ol>
<pre class="calibre25">
<strong class="calibre4">root@kvm:~# virsh net-list --all</strong><br class="calibre7"/><strong class="calibre4"> Name       State    Autostart     Persistent</strong><br class="calibre7"/><strong class="calibre4">----------------------------------------------------------</strong><br class="calibre7"/><strong class="calibre4"> default    active    yes          yes</strong><br class="calibre7"/><br class="calibre7"/><strong class="calibre4">root@kvm:~#</strong>
</pre>
<ol start="2" class="calibre18">
<li value="2" class="calibre17">Dump the configuration of the default network:</li>
</ol>
<pre class="calibre25">
<strong class="calibre4">root@kvm:~# virsh net-dumpxml default</strong><br class="calibre7"/><strong class="calibre4">&lt;network connections='1'&gt;</strong><br class="calibre7"/><strong class="calibre4"> &lt;name&gt;default&lt;/name&gt;</strong><br class="calibre7"/><strong class="calibre4"> &lt;uuid&gt;2ab5d22c-5928-4304-920e-bc43b8731bcf&lt;/uuid&gt;</strong><br class="calibre7"/><strong class="calibre4"> &lt;forward mode='nat'&gt;</strong><br class="calibre7"/><strong class="calibre4">   &lt;nat&gt;</strong><br class="calibre7"/><strong class="calibre4">     &lt;port start='1024' end='65535'/&gt;</strong><br class="calibre7"/><strong class="calibre4">   &lt;/nat&gt;</strong><br class="calibre7"/><strong class="calibre4"> &lt;/forward&gt;</strong><br class="calibre7"/><strong class="calibre4"> &lt;bridge name='virbr0' stp='on' delay='0'/&gt;</strong><br class="calibre7"/><strong class="calibre4"> &lt;ip address='192.168.122.1' netmask='255.255.255.0'&gt;</strong><br class="calibre7"/><strong class="calibre4">   &lt;dhcp&gt;</strong><br class="calibre7"/><strong class="calibre4">     &lt;range start='192.168.122.2' end='192.168.122.254'/&gt;</strong><br class="calibre7"/><strong class="calibre4">   &lt;/dhcp&gt;</strong><br class="calibre7"/><strong class="calibre4"> &lt;/ip&gt;</strong><br class="calibre7"/><strong class="calibre4">&lt;/network&gt;</strong><br class="calibre7"/><br class="calibre7"/><strong class="calibre4">root@kvm:~#</strong>
</pre>
<ol start="3" class="calibre18">
<li value="3" class="calibre17">Compare that with the XML definition file for the default network:</li>
</ol>
<pre class="calibre25">
<strong class="calibre4">root@kvm:~# cat /etc/libvirt/qemu/networks/default.xml</strong><br class="calibre7"/><strong class="calibre4">&lt;network&gt;</strong><br class="calibre7"/><strong class="calibre4"> &lt;name&gt;default&lt;/name&gt;</strong><br class="calibre7"/><strong class="calibre4"> &lt;bridge name="virbr0"/&gt;</strong><br class="calibre7"/><strong class="calibre4"> &lt;forward/&gt;</strong><br class="calibre7"/><strong class="calibre4"> &lt;ip address="192.168.122.1" netmask="255.255.255.0"&gt;</strong><br class="calibre7"/><strong class="calibre4">   &lt;dhcp&gt;</strong><br class="calibre7"/><strong class="calibre4">     &lt;range start="192.168.122.2" end="192.168.122.254"/&gt;</strong><br class="calibre7"/><strong class="calibre4">   &lt;/dhcp&gt;</strong><br class="calibre7"/><strong class="calibre4"> &lt;/ip&gt;</strong><br class="calibre7"/><strong class="calibre4">&lt;/network&gt;</strong><br class="calibre7"/><strong class="calibre4">root@kvm:~#</strong>
</pre>
<ol start="4" class="calibre18">
<li value="4" class="calibre17">List all running instances on the host:</li>
</ol>
<pre class="calibre25">
<strong class="calibre4">root@kvm:~# virsh list --all</strong><br class="calibre7"/><strong class="calibre4"> Id    Name    State</strong><br class="calibre7"/><strong class="calibre4">----------------------------------------------------</strong><br class="calibre7"/><strong class="calibre4"> 3    kvm1     running</strong><br class="calibre7"/><br class="calibre7"/><strong class="calibre4">root@kvm:~#</strong>
</pre>
<ol start="5" class="calibre18">
<li value="5" class="calibre17">Ensure that the KVM instances are connected to the default Linux bridge:</li>
</ol>
<pre class="calibre25">
<strong class="calibre4">root@kvm:~# brctl show</strong><br class="calibre7"/><strong class="calibre4">bridge name    bridge id           STP enabled    interfaces</strong><br class="calibre7"/><strong class="calibre4">virbr0         8000.fe5400559bd6   yes            vnet0</strong><br class="calibre7"/><strong class="calibre4">root@kvm:~#</strong>
</pre>
<ol start="6" class="calibre18">
<li value="6" class="calibre17">Create a new NAT network definition:</li>
</ol>
<pre class="calibre25">
<strong class="calibre4">root@kvm:~# cat nat_net.xml</strong><br class="calibre7"/><strong class="calibre4">&lt;network&gt;</strong><br class="calibre7"/><strong class="calibre4"> &lt;name&gt;nat_net&lt;/name&gt;</strong><br class="calibre7"/><strong class="calibre4"> &lt;bridge name="virbr1"/&gt;</strong><br class="calibre7"/><strong class="calibre4"> &lt;forward/&gt;</strong><br class="calibre7"/><strong class="calibre4"> &lt;ip address="10.10.10.1" netmask="255.255.255.0"&gt;</strong><br class="calibre7"/><strong class="calibre4">   &lt;dhcp&gt;</strong><br class="calibre7"/><strong class="calibre4">     &lt;range start="10.10.10.2" end="10.10.10.254"/&gt;</strong><br class="calibre7"/><strong class="calibre4">   &lt;/dhcp&gt;</strong><br class="calibre7"/><strong class="calibre4"> &lt;/ip&gt;</strong><br class="calibre7"/><strong class="calibre4">&lt;/network&gt;</strong><br class="calibre7"/><strong class="calibre4">root@kvm:~#</strong>
</pre>
<ol start="7" class="calibre18">
<li value="7" class="calibre17">Define the new network:</li>
</ol>
<pre class="calibre25">
<strong class="calibre4">root@kvm:~# virsh net-define nat_net.xml</strong><br class="calibre7"/><strong class="calibre4">Network nat_net defined from nat_net.xml</strong><br class="calibre7"/><br class="calibre7"/><strong class="calibre4">root@kvm:~# virsh net-list --all</strong><br class="calibre7"/><strong class="calibre4"> Name       State      Autostart    Persistent</strong><br class="calibre7"/><strong class="calibre4">----------------------------------------------------------</strong><br class="calibre7"/><strong class="calibre4"> default    active     yes          yes</strong><br class="calibre7"/><strong class="calibre4"> nat_net    inactive   no           yes</strong><br class="calibre7"/><br class="calibre7"/><strong class="calibre4">root@kvm:~#</strong>
</pre>
<ol start="8" class="calibre18">
<li value="8" class="calibre17">Start the new network and enable autostarting:</li>
</ol>
<pre class="calibre25">
<strong class="calibre4">root@kvm:~# virsh net-start nat_net</strong><br class="calibre7"/><strong class="calibre4">Network nat_net started</strong><br class="calibre7"/><br class="calibre7"/><strong class="calibre4">root@kvm:~# virsh net-autostart nat_net</strong><br class="calibre7"/><strong class="calibre4">Network nat_net marked as autostarted</strong><br class="calibre7"/><br class="calibre7"/><strong class="calibre4">root@kvm:~# virsh net-list</strong><br class="calibre7"/><strong class="calibre4"> Name      State     Autostart    Persistent</strong><br class="calibre7"/><strong class="calibre4">----------------------------------------------------------</strong><br class="calibre7"/><strong class="calibre4"> default   active    yes          yes</strong><br class="calibre7"/><strong class="calibre4"> nat_net   active    yes          yes</strong><br class="calibre7"/><br class="calibre7"/><strong class="calibre4">root@kvm:~#</strong>
</pre>
<ol start="9" class="calibre18">
<li value="9" class="calibre17">Obtain more information about the new network:</li>
</ol>
<pre class="calibre25">
<strong class="calibre4">root@kvm:~# virsh net-info nat_net</strong><br class="calibre7"/><strong class="calibre4">Name: nat_net</strong><br class="calibre7"/><strong class="calibre4">UUID: fba2ca2b-8ca7-4dbb-beee-14799ee04bc3</strong><br class="calibre7"/><strong class="calibre4">Active: yes</strong><br class="calibre7"/><strong class="calibre4">Persistent: yes</strong><br class="calibre7"/><strong class="calibre4">Autostart: yes</strong><br class="calibre7"/><strong class="calibre4">Bridge: virbr1</strong><br class="calibre7"/><br class="calibre7"/><strong class="calibre4">root@kvm:~#</strong>
</pre>
<ol start="10" class="calibre18">
<li value="10" class="calibre17">Edit the XML definition of the <kbd class="calibre13">kvm1</kbd> instance and change the name of the source network:</li>
</ol>
<pre class="calibre25">
<strong class="calibre4">root@kvm:~# virsh edit kvm1</strong><br class="calibre7"/><strong class="calibre4">...</strong><br class="calibre7"/><strong class="calibre4"> &lt;interface type='network'&gt;</strong><br class="calibre7"/><strong class="calibre4">   ...</strong><br class="calibre7"/><strong class="calibre4">   &lt;source network='nat_net'/&gt;</strong><br class="calibre7"/><strong class="calibre4">   ...</strong><br class="calibre7"/><strong class="calibre4"> &lt;/interface&gt;</strong><br class="calibre7"/><strong class="calibre4">...</strong><br class="calibre7"/><br class="calibre7"/><strong class="calibre4">Domain kvm1 XML configuration edited.</strong><br class="calibre7"/><br class="calibre7"/><strong class="calibre4">root@kvm:~#</strong>
</pre>
<ol start="11" class="calibre18">
<li value="11" class="calibre17">Restart the KVM guest:</li>
</ol>
<pre class="calibre25">
<strong class="calibre4">root@kvm:~# virsh destroy kvm1</strong><br class="calibre7"/><strong class="calibre4">Domain kvm1 destroyed</strong><br class="calibre7"/><br class="calibre7"/><strong class="calibre4">root@kvm:~# virsh start kvm1</strong><br class="calibre7"/><strong class="calibre4">Domain kvm1 started</strong><br class="calibre7"/><br class="calibre7"/><strong class="calibre4">root@kvm:~#</strong>
</pre>
<ol start="12" class="calibre18">
<li value="12" class="calibre17">List all software bridges on the host:</li>
</ol>
<pre class="calibre25">
<strong class="calibre4">root@kvm:~# brctl show</strong><br class="calibre7"/><strong class="calibre4">bridge name     bridge id         STP enabled interfaces</strong><br class="calibre7"/><strong class="calibre4">virbr0          8000.000000000000 yes</strong><br class="calibre7"/><strong class="calibre4">virbr1          8000.525400ba8e2c yes         virbr1-nic</strong><br class="calibre7"/><strong class="calibre4">                                              vnet0</strong><br class="calibre7"/><strong class="calibre4">root@kvm:~#</strong>
</pre>
<ol start="13" class="calibre18">
<li value="13" class="calibre17">Connect to the KVM instances and check the IP address of the <kbd class="calibre13">eth0</kbd> interface and ensure connectivity to the host bridge (if the image is not configured for console access, use a VNC client instead):</li>
</ol>
<pre class="calibre25">
<strong class="calibre4">root@kvm:~# virsh console kvm1</strong><br class="calibre7"/><strong class="calibre4">Connected to domain kvm1</strong><br class="calibre7"/><strong class="calibre4">Escape character is ^]</strong><br class="calibre7"/><br class="calibre7"/><strong class="calibre4">Debian GNU/Linux 8 debian ttyS0</strong><br class="calibre7"/><br class="calibre7"/><strong class="calibre4">debian login: root</strong><br class="calibre7"/><strong class="calibre4">Password:</strong><br class="calibre7"/><strong class="calibre4">...</strong><br class="calibre7"/><strong class="calibre4">root@debian:~# ip a s eth0 | grep inet</strong><br class="calibre7"/><strong class="calibre4"> inet 10.10.10.92/24 brd 10.10.10.255 scope global eth0</strong><br class="calibre7"/><strong class="calibre4"> inet6 fe80::5054:ff:fe55:9bd6/64 scope link</strong><br class="calibre7"/><strong class="calibre4">root@debian:~# ifconfig eth0 up &amp;&amp; dhclient eth0</strong><br class="calibre7"/><strong class="calibre4">root@debian:~# ping 10.10.10.1 -c 3</strong><br class="calibre7"/><strong class="calibre4">PING 10.10.10.1 (10.10.10.1) 56(84) bytes of data.</strong><br class="calibre7"/><strong class="calibre4">64 bytes from 10.10.10.1: icmp_seq=1 ttl=64 time=0.313 ms</strong><br class="calibre7"/><strong class="calibre4">64 bytes from 10.10.10.1: icmp_seq=2 ttl=64 time=0.136 ms</strong><br class="calibre7"/><strong class="calibre4">64 bytes from 10.10.10.1: icmp_seq=3 ttl=64 time=0.253 ms</strong><br class="calibre7"/><br class="calibre7"/><strong class="calibre4">--- 10.10.10.1 ping statistics ---</strong><br class="calibre7"/><strong class="calibre4">3 packets transmitted, 3 received, 0% packet loss, time 2000ms</strong><br class="calibre7"/><strong class="calibre4">rtt min/avg/max/mdev = 0.136/0.234/0.313/0.073 ms</strong><br class="calibre7"/><strong class="calibre4">root@debian:~#</strong>
</pre>
<ol start="14" class="calibre18">
<li value="14" class="calibre17">On the host OS, examine which DHCP services are running:</li>
</ol>
<pre class="calibre25">
<strong class="calibre4">root@kvm:~# pgrep -lfa dnsmasq</strong><br class="calibre7"/><strong class="calibre4">38983 /usr/sbin/dnsmasq --conf-file=/var/lib/libvirt/dnsmasq/default.conf</strong><br class="calibre7"/><strong class="calibre4">40098 /usr/sbin/dnsmasq --conf-file=/var/lib/libvirt/dnsmasq/nat_net.conf</strong><br class="calibre7"/><strong class="calibre4">root@kvm:~#</strong>
</pre>
<ol start="15" class="calibre18">
<li value="15" class="calibre17">Check the IP of the new bridge interface:</li>
</ol>
<pre class="calibre25">
<strong class="calibre4">root@kvm:~# ip a s virbr1</strong><br class="calibre7"/><strong class="calibre4">43: virbr1: &lt;BROADCAST,MULTICAST,UP,LOWER_UP&gt; mtu 1500 qdisc noqueue state UP group default</strong><br class="calibre7"/><strong class="calibre4"> link/ether 52:54:00:ba:8e:2c brd ff:ff:ff:ff:ff:ff</strong><br class="calibre7"/><strong class="calibre4"> inet 10.10.10.1/24 brd 10.10.10.255 scope global virbr1</strong><br class="calibre7"/><strong class="calibre4">   valid_lft forever preferred_lft forever</strong><br class="calibre7"/><strong class="calibre4">root@kvm:~#</strong>
</pre>
<ol start="16" class="calibre18">
<li value="16" class="calibre17">List the <kbd class="calibre13">iptables</kbd> rules for the NAT table:</li>
</ol>
<pre class="calibre25">
<strong class="calibre4">root@kvm:~# iptables -L -n -t nat</strong><br class="calibre7"/><strong class="calibre4">Chain PREROUTING (policy ACCEPT)</strong><br class="calibre7"/><strong class="calibre4">target prot opt source destination</strong><br class="calibre7"/><br class="calibre7"/><strong class="calibre4">Chain INPUT (policy ACCEPT)</strong><br class="calibre7"/><strong class="calibre4">target prot opt source destination</strong><br class="calibre7"/><br class="calibre7"/><strong class="calibre4">Chain OUTPUT (policy ACCEPT)</strong><br class="calibre7"/><strong class="calibre4">target prot opt source destination</strong><br class="calibre7"/><br class="calibre7"/><strong class="calibre4">Chain POSTROUTING (policy ACCEPT)</strong><br class="calibre7"/><strong class="calibre4">target prot opt source destination</strong><br class="calibre7"/><strong class="calibre4">RETURN all -- 10.10.10.0/24 224.0.0.0/24</strong><br class="calibre7"/><strong class="calibre4">RETURN all -- 10.10.10.0/24 255.255.255.255</strong><br class="calibre7"/><strong class="calibre4">MASQUERADE tcp -- 10.10.10.0/24 !10.10.10.0/24 masq ports: 1024-65535</strong><br class="calibre7"/><strong class="calibre4">MASQUERADE udp -- 10.10.10.0/24 !10.10.10.0/24 masq ports: 1024-65535</strong><br class="calibre7"/><strong class="calibre4">MASQUERADE all -- 10.10.10.0/24 !10.10.10.0/24</strong><br class="calibre7"/><strong class="calibre4">RETURN all -- 192.168.122.0/24 224.0.0.0/24</strong><br class="calibre7"/><strong class="calibre4">RETURN all -- 192.168.122.0/24 255.255.255.255</strong><br class="calibre7"/><strong class="calibre4">MASQUERADE tcp -- 192.168.122.0/24 !192.168.122.0/24 masq ports: 1024-65535</strong><br class="calibre7"/><strong class="calibre4">MASQUERADE udp -- 192.168.122.0/24 !192.168.122.0/24 masq ports: 1024-65535</strong><br class="calibre7"/><strong class="calibre4">MASQUERADE all -- 192.168.122.0/24 !192.168.122.0/24</strong><br class="calibre7"/><strong class="calibre4">RETURN all -- 192.168.122.0/24 224.0.0.0/24</strong><br class="calibre7"/><strong class="calibre4">RETURN all -- 192.168.122.0/24 255.255.255.255</strong><br class="calibre7"/><strong class="calibre4">MASQUERADE tcp -- 192.168.122.0/24 !192.168.122.0/24 masq ports: 1024-65535</strong><br class="calibre7"/><strong class="calibre4">MASQUERADE udp -- 192.168.122.0/24 !192.168.122.0/24 masq ports: 1024-65535</strong><br class="calibre7"/><strong class="calibre4">MASQUERADE all -- 192.168.122.0/24 !192.168.122.0/24</strong><br class="calibre7"/><strong class="calibre4">root@kvm:~#</strong>
</pre>


            </article>

            <footer class="calibre5">
                
            </footer>

        </section>
    

        <section class="calibre1">

            <header class="calibre1">
                </header><h1 class="header-title" id="calibre_pb_0">How it works...</h1>
            

            <article class="calibre1">
                
<p class="calibre3">We start by listing all available networks on the host OS in step 1. As we can see from the output of the <kbd class="calibre13">virsh</kbd> command, there's only one default network running.</p>
<p class="calibre3">In step 2, we examine the configuration of the default network. The XML definition uses the following attributes:</p>
<ul class="calibre16">
<li class="calibre17">The <kbd class="calibre13">&lt;network&gt;</kbd> attribute is the root element, instructing libvirt that we are defining a network.</li>
<li class="calibre17">The <kbd class="calibre13">&lt;name&gt;</kbd> element specifies the name of the network and needs to be unique. </li>
<li class="calibre17">The <kbd class="calibre13">&lt;uuid&gt;</kbd> attribute <span>provides a globally unique identifier for the virtual network and if omitted, it will be autogenerated.</span></li>
<li class="calibre17">The <kbd class="calibre13">&lt;forward&gt;</kbd> element and its mode attribute define the network as being connected to the host network stack, using NAT. If this element is missing, libvirt will create an isolated network.</li>
<li class="calibre17">The <kbd class="calibre13">&lt;nat&gt;</kbd> subelement further defines the <kbd class="calibre13">&lt;port&gt;</kbd> range that will be used while the host is preforming NAT.</li>
<li class="calibre17">The <kbd class="calibre13">&lt;bridge&gt;</kbd> element specifies the bridge to be created, its name, and STP options.</li>
<li class="calibre17">The <kbd class="calibre13">&lt;ip&gt;</kbd> attribute defines the IP range for the DHCP server to assign addresses to the guest VMs.</li>
</ul>
<p class="calibre3">In step 3, we look at the config file for the default network on this. Note that some of the attributes are missing. Libvirt autogenerates certain attributes and assigns default values where appropriate. </p>
<p class="calibre3">In step 4 and 5, we make sure that we have a running instance connected to the default Linux bridge.</p>
<p class="calibre3">In step 6, we create a new network definition using the default network as a template. We change the name of the network and define new IP range.</p>
<p class="calibre3">With the new network definition file ready, in steps 7 and 8, we define the new network, start it, and make sure that it will automatically start when the <kbd class="calibre13">libvirt</kbd> daemon starts, in the case of a server reboot.</p>
<p class="calibre3">After obtaining more information about the newly created network in step 9, we proceed to edit the XML definition of the KVM guest in step 10. To make the VM part of the new network, all we need to do is update the <kbd class="calibre13">&lt;source network&gt;</kbd> element. </p>
<p class="calibre3">After restarting the KVM guest in step 11, we proceed to list all available software bridges on the host OS in step 12. Note that we now have two bridges, with the new bridge having the VMs virtual interface <kbd class="calibre13">vnet0</kbd> connected to it.</p>
<p class="calibre3">We then connect to the running KVM guest and ensure that its eth0 network interface has obtained an IP address from the DHCP server running on the host and that the IP is part of the address range we configured earlier. We also ensured connectivity to the host bridge using the <kbd class="calibre13">ping</kbd> command.</p>
<p class="calibre3">Back on the host OS, in steps 14 and 15, we check what DHCP services are running. Note, from the output of the <kbd class="calibre13">pgrep</kbd> command, that we now have two <kbd class="calibre13">dnsmasq</kbd> processes running: one for each defined network.</p>
<p class="calibre3">The NAT forwarding is achieved by setting iptables rules as we can see in step 18. Each time we define and start a new NAT network, libvirt creates the required rules in iptables. From the output in step 18, we can observe the presence of two sets of NAT rules, one for each running NAT network.</p>


            </article>

            <footer class="calibre5">
                
            </footer>

        </section>
    

        <section class="calibre1">

            <header class="calibre1">
                </header><h1 class="header-title" id="calibre_pb_0">Configuring bridged network</h1>
            

            <article class="calibre1">
                
<p class="calibre3">With full bridging, we can connect the KVM guests directly to the host network, without using NAT. However, this setup requires an IP address, which is part of the host subnet, for each virtual machine. If you cannot allocate that many IP addresses, consider using the NAT network setup, as described in the <em class="calibre22">Configuring NAT forwarding network</em> recipe given before. In this networking mode, the virtual machines still use the host OS bridge for connectivity; however, the bridge enslaves the physical interface that is going to be used for the guests.</p>


            </article>

            <footer class="calibre5">
                
            </footer>

        </section>
    

        <section class="calibre1">

            <header class="calibre1">
                </header><h1 class="header-title" id="calibre_pb_0">Getting ready</h1>
            

            <article class="calibre1">
                
<p class="calibre3">For this recipe, we are going to need the following:</p>
<ul class="calibre16">
<li class="calibre17">A server with at least two physical interfaces</li>
<li class="calibre17">The ability to provision and start KVM instances with libvirt</li>
<li class="calibre17">A running KVM instance</li>
</ul>


            </article>

            <footer class="calibre5">
                
            </footer>

        </section>
    

        <section class="calibre1">

            <header class="calibre1">
                </header><h1 class="header-title" id="calibre_pb_0">How to do it...</h1>
            

            <article class="calibre1">
                
<p class="calibre3">To define a new bridged network and attach a guest to it, follow the steps:</p>
<ol class="calibre18">
<li value="1" class="calibre17"><span>Take down the interface we are going to </span>bridge<span>:</span></li>
</ol>
<pre class="calibre25">
<strong class="calibre4">root@kvm:~# ifdown eth1</strong><br class="calibre7"/><strong class="calibre4">root@kvm:~#</strong>
</pre>
<ol start="2" class="calibre18">
<li value="2" class="calibre17">Edit the network configuration file on the host and replace the <kbd class="calibre13">eth1</kbd> block with the following, if your host OS is Debian/Ubuntu:</li>
</ol>
<pre class="calibre25">
<strong class="calibre4">root@kvm:~# vim /etc/network/interfaces</strong><br class="calibre7"/><strong class="calibre4">...</strong><br class="calibre7"/><strong class="calibre4"> auto virbr2</strong><br class="calibre7"/><strong class="calibre4"> iface virbr2 inet static</strong><br class="calibre7"/><strong class="calibre4">     address 192.168.1.2</strong><br class="calibre7"/><strong class="calibre4">     netmask 255.255.255.0</strong><br class="calibre7"/><strong class="calibre4">     network 192.168.1.0</strong><br class="calibre7"/><strong class="calibre4">     broadcast 192.168.1.255</strong><br class="calibre7"/><strong class="calibre4">     gateway 192.168.1.1</strong><br class="calibre7"/><strong class="calibre4">     bridge_ports eth1</strong><br class="calibre7"/><strong class="calibre4">     bridge_stp on</strong><br class="calibre7"/><strong class="calibre4">     bridge_maxwait 0</strong><br class="calibre7"/><strong class="calibre4">...</strong><br class="calibre7"/><strong class="calibre4">root@kvm:~#</strong>
</pre>
<ol start="3" class="calibre18">
<li value="3" class="calibre17">If using RedHat/CentOS distributions, edit the following two files instead:</li>
</ol>
<pre class="calibre25">
<strong class="calibre4">root@kvm:~# cat /etc/sysconfig/ifcfg-eth1</strong><br class="calibre7"/><strong class="calibre4">DEVICE=eth1</strong><br class="calibre7"/><strong class="calibre4">NAME=eth1</strong><br class="calibre7"/><strong class="calibre4">NM_CONTROLLED=yes</strong><br class="calibre7"/><strong class="calibre4">ONBOOT=yes</strong><br class="calibre7"/><strong class="calibre4">TYPE=Ethernet</strong><br class="calibre7"/><strong class="calibre4">BRIDGE=virbr2</strong><br class="calibre7"/><strong class="calibre4">root@kvm:~# cat /etc/sysconfig/ifcfg-bridge_net</strong><br class="calibre7"/><strong class="calibre4">DEVICE=virbr2</strong><br class="calibre7"/><strong class="calibre4">NAME=virbr2</strong><br class="calibre7"/><strong class="calibre4">NM_CONTROLLED=yes</strong><br class="calibre7"/><strong class="calibre4">ONBOOT=yes</strong><br class="calibre7"/><strong class="calibre4">TYPE=Bridge</strong><br class="calibre7"/><strong class="calibre4">STP=on</strong><br class="calibre7"/><strong class="calibre4">IPADDR=192.168.1.2</strong><br class="calibre7"/><strong class="calibre4">NETMASK=255.255.255.0</strong><br class="calibre7"/><strong class="calibre4">GATEWAY=192.168.1.1</strong><br class="calibre7"/><strong class="calibre4">root@kvm:~#</strong>
</pre>
<ol start="4" class="calibre18">
<li value="4" class="calibre17">Start the new interface up:</li>
</ol>
<pre class="calibre25">
<strong class="calibre4">root@kvm:~# ifup virbr2</strong><br class="calibre7"/><strong class="calibre4">root@kvm:~#</strong>
</pre>
<ol start="5" class="calibre18">
<li value="5" class="calibre17">Disable sending packets to <kbd class="calibre13">iptables</kbd> that originate from the guest VMs:</li>
</ol>
<pre class="calibre25">
<strong class="calibre4">root@kvm:~# sysctl -w net.bridge.bridge-nf-call-iptables=0</strong><br class="calibre7"/><strong class="calibre4">net.bridge.bridge-nf-call-iptables = 0</strong><br class="calibre7"/><strong class="calibre4">root@kvm:~# sysctl -w net.bridge.bridge-nf-call-iptables=0</strong><br class="calibre7"/><strong class="calibre4">net.bridge.bridge-nf-call-iptables = 0</strong><br class="calibre7"/><strong class="calibre4">root@kvm:~# sysctl -w net.bridge.bridge-nf-call-arptables=0</strong><br class="calibre7"/><strong class="calibre4">net.bridge.bridge-nf-call-arptables = 0</strong><br class="calibre7"/><strong class="calibre4">root@kvm:~#</strong>
</pre>
<ol start="6" class="calibre18">
<li value="6" class="calibre17">List all bridges on the host:</li>
</ol>
<pre class="calibre25">
<strong class="calibre4">root@kvm:~# # brctl show</strong><br class="calibre7"/><strong class="calibre4"> bridge name     bridge id            STP enabled     interfaces</strong><br class="calibre7"/><strong class="calibre4"> virbr0          8000.000000000000    yes</strong><br class="calibre7"/><strong class="calibre4"> virbr2          8000.000a0ac60210    yes             eth1</strong><br class="calibre7"/><strong class="calibre4">root@kvm:~#</strong>
</pre>
<ol start="7" class="calibre18">
<li value="7" class="calibre17">Edit the XML definition for the KVM instance:</li>
</ol>
<pre class="calibre25">
<strong class="calibre4">root@kvm:~# virsh edit kvm1</strong><br class="calibre7"/><strong class="calibre4">...</strong><br class="calibre7"/><strong class="calibre4"> &lt;interface type='bridge'&gt;</strong><br class="calibre7"/><strong class="calibre4">   &lt;source bridge='virbr2'/&gt;</strong><br class="calibre7"/><strong class="calibre4"> &lt;/interface&gt;</strong><br class="calibre7"/><strong class="calibre4">...</strong><br class="calibre7"/><br class="calibre7"/><strong class="calibre4">Domain kvm1 XML configuration edited.</strong><br class="calibre7"/><br class="calibre7"/><strong class="calibre4">root@kvm:~#</strong>
</pre>
<ol start="8" class="calibre18">
<li value="8" class="calibre17">Restart the KVM instance:</li>
</ol>
<pre class="calibre25">
<strong class="calibre4">root@kvm:~# virsh destroy kvm1</strong><br class="calibre7"/><strong class="calibre4">Domain kvm1 destroyed</strong><br class="calibre7"/><br class="calibre7"/><strong class="calibre4">root@kvm:~# virsh start kvm1</strong><br class="calibre7"/><strong class="calibre4">Domain kvm1 started</strong><br class="calibre7"/><br class="calibre7"/><strong class="calibre4">root@kvm:~#</strong>
</pre>


            </article>

            <footer class="calibre5">
                
            </footer>

        </section>
    

        <section class="calibre1">

            <header class="calibre1">
                </header><h1 class="header-title" id="calibre_pb_0">How it works...</h1>
            

            <article class="calibre1">
                
<p class="calibre3">To set up bridge networking, in steps 1 and 2, we first bring the physical interface (<kbd class="calibre13">eth1</kbd> in this example) down, in order to enslave it (make it a part of the new bridge we are going to create). We then create the network configuration, specifying the new bridge and the physical interface that is going to be a part of that bridge. This in effect maps the subnet that is configured on the physical interface to the bridge. If your server has only one network interface, you can still enslave it. However, you will need an additional way of connecting to the server because once you bring your main interface down, you will loose connectivity and troubleshooting might be impossible over an SSH connection.</p>
<p class="calibre3">Once the new bridge has been configured, we start it in step 3.</p>
<p class="calibre3">In step 4, we instruct the kernel not to apply iptable rules to any traffic originating from the virtual guests connected to the Linux bridge because we are not using any NAT rules.</p>
<p class="calibre3">With the new interface up, we can now see the bridge and the enslaved physical interface attached to it, in step 5.</p>
<p class="calibre3">In step 6, we edit the XML definition of the <kbd class="calibre13">kvm1</kbd> instance, where we specify the type of network we would like to use; for this recipe, it's the bridge network. If you recall from the <em class="calibre22">Configuring NAT forwarding network</em><span> recipe, we used the network type instead of</span> bridge <span>and we specified a <kbd class="calibre13">libvirt</kbd> network name, instead of the</span> bridge <span>name.</span></p>
<p class="calibre3"><span>Finally, after restarting the KVM instance in step 7, the guest OS should now be able to reach other instances that are a part of the same subnet without using NAT. </span></p>


            </article>

            <footer class="calibre5">
                
            </footer>

        </section>
    

        <section class="calibre1">

            <header class="calibre1">
                </header><h1 class="header-title" id="calibre_pb_0">Configuring PCI passthrough network</h1>
            

            <article class="calibre1">
                
<p class="calibre3">The KVM hypervisor supports directly attaching PCI devices from the host OS to the virtual machines. We can use this feature to attach a network interface directly to the guest OS, without the need for using NAT or software bridges.<br class="calibre7"/>
In this recipe, we are going to attach a <strong class="calibre4">Network Interface Card</strong> (<strong class="calibre4">NIC</strong>) that supports <span>SR-IOV <strong class="calibre4">Single Root I/O Virtualization</strong> (<strong class="calibre4">SR-IOV</strong>) from the host to the KVM guest. SR-IOV is a specification that allows a <strong class="calibre4">Peripheral Component Interconnect Expres</strong>s (<strong class="calibre4">PCIe</strong> ) device to appear as multiple separate physical devices that can be shared between many virtual machines on the same host, bypassing the hypervisor layer, thus achieving native network speeds. Cloud providers such as Amazon AWS expose this feature for its EC2 compute instances through API calls.<br class="calibre7"/></span></p>


            </article>

            <footer class="calibre5">
                
            </footer>

        </section>
    

        <section class="calibre1">

            <header class="calibre1">
                </header><h1 class="header-title" id="calibre_pb_0">Getting ready</h1>
            

            <article class="calibre1">
                
<p class="calibre3">In order to complete this recipe, we are going to need the following:</p>
<ul class="calibre16">
<li class="calibre17">A physical host with NIC that supports SR-IOV</li>
<li class="calibre17">A <span><kbd class="calibre13">802.1Qbh</kbd> capable switch with connection to the physical server</span></li>
<li class="calibre17">CPU with either the Intel VT-d or AMD IOMMU extensions</li>
<li class="calibre17">Linux host with <kbd class="calibre13">libvirt</kbd> installed, ready-to-provision KVM instances</li>
</ul>


            </article>

            <footer class="calibre5">
                
            </footer>

        </section>
    

        <section class="calibre1">

            <header class="calibre1">
                </header><h1 class="header-title" id="calibre_pb_0">How to do it...</h1>
            

            <article class="calibre1">
                
<p class="calibre3">To set up a new PCI passthrough network follow the steps:</p>
<ol class="calibre18">
<li value="1" class="calibre17"><span>Enumerate all devices on the host OS:</span></li>
</ol>
<pre class="calibre25">
<strong class="calibre4">root@kvm:~# virsh nodedev-list --tree</strong><br class="calibre7"/><strong class="calibre4">computer</strong><br class="calibre7"/><strong class="calibre4"> |</strong><br class="calibre7"/><strong class="calibre4"> +- net_lo_00_00_00_00_00_00</strong><br class="calibre7"/><strong class="calibre4"> +- net_ovs_system_0a_c6_62_34_19_b4</strong><br class="calibre7"/><strong class="calibre4"> +- net_virbr1_nic_52_54_00_ba_8e_2c</strong><br class="calibre7"/><strong class="calibre4"> +- net_vnet0_fe_54_00_55_9b_d6</strong><br class="calibre7"/><strong class="calibre4"> ...</strong><br class="calibre7"/><strong class="calibre4"> |</strong><br class="calibre7"/><strong class="calibre4"> +- pci_0000_00_03_0</strong><br class="calibre7"/><strong class="calibre4"> | |</strong><br class="calibre7"/><strong class="calibre4"> | +- pci_0000_03_00_0</strong><br class="calibre7"/><strong class="calibre4"> | | |</strong><br class="calibre7"/><strong class="calibre4"> | | +- net_eth0_58_20_b1_00_b8_61</strong><br class="calibre7"/><strong class="calibre4"> | |</strong><br class="calibre7"/><strong class="calibre4"> | +- pci_0000_03_00_1</strong><br class="calibre7"/><strong class="calibre4"> | |</strong><br class="calibre7"/><strong class="calibre4"> | +- net_eth1_58_20_b1_00_b8_61</strong><br class="calibre7"/><strong class="calibre4"> |</strong><br class="calibre7"/><strong class="calibre4"> ...</strong><br class="calibre7"/><strong class="calibre4"> root@kvm:~#</strong>
</pre>
<ol start="2" class="calibre18">
<li value="2" class="calibre17">List all PCI <kbd class="calibre13">Ethernet</kbd> adapters:</li>
</ol>
<pre class="calibre25">
<strong class="calibre4">root@kvm:~# lspci | grep Ethernet</strong><br class="calibre7"/><strong class="calibre4">03:00.0 Ethernet controller: Intel Corporation 82599ES 10-Gigabit SFI/SFP+ Network Connection (rev 01)</strong><br class="calibre7"/><strong class="calibre4">03:00.1 Ethernet controller: Intel Corporation 82599ES 10-Gigabit SFI/SFP+ Network Connection (rev 01)</strong><br class="calibre7"/><strong class="calibre4">root@kvm:~#</strong>
</pre>
<ol start="3" class="calibre18">
<li value="3" class="calibre17">Obtain more information about NIC that the <kbd class="calibre13">eth1</kbd> device is using:</li>
</ol>
<pre class="calibre25">
<strong class="calibre4">root@kvm:~# virsh nodedev-dumpxml pci_0000_03_00_1</strong><br class="calibre7"/><strong class="calibre4">&lt;device&gt;</strong><br class="calibre7"/><strong class="calibre4"> &lt;name&gt;pci_0000_03_00_1&lt;/name&gt;</strong><br class="calibre7"/><strong class="calibre4"> &lt;path&gt;/sys/devices/pci0000:00/0000:00:03.0/0000:03:00.1&lt;/path&gt;</strong><br class="calibre7"/><strong class="calibre4"> &lt;parent&gt;pci_0000_00_03_0&lt;/parent&gt;</strong><br class="calibre7"/><strong class="calibre4"> &lt;driver&gt;</strong><br class="calibre7"/><strong class="calibre4">   &lt;name&gt;ixgbe&lt;/name&gt;</strong><br class="calibre7"/><strong class="calibre4"> &lt;/driver&gt;</strong><br class="calibre7"/><strong class="calibre4"> &lt;capability type='pci'&gt;</strong><br class="calibre7"/><strong class="calibre4">   &lt;domain&gt;0&lt;/domain&gt;</strong><br class="calibre7"/><strong class="calibre4">   &lt;bus&gt;3&lt;/bus&gt;</strong><br class="calibre7"/><strong class="calibre4">   &lt;slot&gt;0&lt;/slot&gt;</strong><br class="calibre7"/><strong class="calibre4">   &lt;function&gt;1&lt;/function&gt;</strong><br class="calibre7"/><strong class="calibre4">   &lt;product id='0x10fb'&gt;82599ES 10-Gigabit SFI/SFP+ Network Connection&lt;/product&gt;</strong><br class="calibre7"/><strong class="calibre4">   &lt;vendor id='0x8086'&gt;Intel Corporation&lt;/vendor&gt;</strong><br class="calibre7"/><strong class="calibre4"> &lt;/capability&gt;</strong><br class="calibre7"/><strong class="calibre4">&lt;/device&gt;</strong><br class="calibre7"/><br class="calibre7"/><strong class="calibre4">root@kvm:~#</strong>
</pre>
<ol start="4" class="calibre18">
<li value="4" class="calibre17">Convert the domain, bus, slot, and function values to hexadecimal:</li>
</ol>
<pre class="calibre25">
<strong class="calibre4">root@kvm:~# printf %x 0</strong><br class="calibre7"/><strong class="calibre4">0</strong><br class="calibre7"/><strong class="calibre4">root@kvm:~# printf %x 3</strong><br class="calibre7"/><strong class="calibre4">3</strong><br class="calibre7"/><strong class="calibre4">root@kvm:~# printf %x 0</strong><br class="calibre7"/><strong class="calibre4">0</strong><br class="calibre7"/><strong class="calibre4">root@kvm:~# printf %x 1</strong><br class="calibre7"/><strong class="calibre4">1</strong><br class="calibre7"/><strong class="calibre4">root@kvm:~#</strong>
</pre>
<ol start="5" class="calibre18">
<li value="5" class="calibre17">Create a new <kbd class="calibre13">libvirt</kbd> network definition file:</li>
</ol>
<pre class="calibre25">
<strong class="calibre4">root@kvm:~# cat passthrough_net.xml</strong><br class="calibre7"/><strong class="calibre4">&lt;network&gt;</strong><br class="calibre7"/><strong class="calibre4"> &lt;name&gt;passthrough_net&lt;/name&gt;</strong><br class="calibre7"/><strong class="calibre4"> &lt;forward mode='hostdev' managed='yes'&gt;</strong><br class="calibre7"/><strong class="calibre4">   &lt;pf dev='eth1'/&gt;</strong><br class="calibre7"/><strong class="calibre4"> &lt;/forward&gt;</strong><br class="calibre7"/><strong class="calibre4">&lt;/network&gt;</strong><br class="calibre7"/><strong class="calibre4">root@kvm:~#</strong>
</pre>
<ol start="6" class="calibre18">
<li value="6" class="calibre17">Define, start, and enable autostarting on the new <kbd class="calibre13">libvirt</kbd> network:</li>
</ol>
<pre class="calibre25">
<strong class="calibre4">root@kvm:~# virsh net-define passthrough_net.xml</strong><br class="calibre7"/><strong class="calibre4">Network passthrough_net defined from passthrough_net.xml</strong><br class="calibre7"/><br class="calibre7"/><strong class="calibre4">root@kvm:~# virsh net-start passthrough_net</strong><br class="calibre7"/><strong class="calibre4">Network passthrough_nett started</strong><br class="calibre7"/><br class="calibre7"/><strong class="calibre4">root@kvm:~# virsh net-autostart passthrough_net</strong><br class="calibre7"/><strong class="calibre4">Network passthrough_net marked as autostarted</strong><br class="calibre7"/><br class="calibre7"/><strong class="calibre4">root@kvm:~# virsh net-list</strong><br class="calibre7"/><strong class="calibre4"> Name               State      Autostart    Persistent</strong><br class="calibre7"/><strong class="calibre4">----------------------------------------------------------</strong><br class="calibre7"/><strong class="calibre4"> default            active    yes           yes</strong><br class="calibre7"/><strong class="calibre4"> passthrough_net    active    yes           yes</strong><br class="calibre7"/><br class="calibre7"/><strong class="calibre4">root@kvm:~#</strong>
</pre>
<ol start="7" class="calibre18">
<li value="7" class="calibre17">Edit the XML definition for the KVM guest:</li>
</ol>
<pre class="calibre25">
<strong class="calibre4">root@kvm:~# virsh edit kvm1</strong><br class="calibre7"/><strong class="calibre4">...</strong><br class="calibre7"/><strong class="calibre4"> &lt;devices&gt;</strong><br class="calibre7"/><strong class="calibre4"> ...</strong><br class="calibre7"/><strong class="calibre4"> &lt;interface type='hostdev' managed='yes'&gt;</strong><br class="calibre7"/><strong class="calibre4">   &lt;source&gt;</strong><br class="calibre7"/><strong class="calibre4">     &lt;address type='pci' domain='0x0' bus='0x00' slot='0x07' function='0x0'/&gt;</strong><br class="calibre7"/><strong class="calibre4">   &lt;/source&gt;</strong><br class="calibre7"/><strong class="calibre4">   &lt;virtualport type='802.1Qbh' /&gt;</strong><br class="calibre7"/><strong class="calibre4"> &lt;/interface&gt;</strong><br class="calibre7"/><strong class="calibre4"> &lt;interface type='network'&gt;</strong><br class="calibre7"/><strong class="calibre4">   &lt;source network='passthrough_net'&gt;</strong><br class="calibre7"/><strong class="calibre4"> &lt;/interface&gt;</strong><br class="calibre7"/><strong class="calibre4"> ...</strong><br class="calibre7"/><strong class="calibre4"> &lt;/devices&gt;</strong><br class="calibre7"/><strong class="calibre4">...</strong><br class="calibre7"/><br class="calibre7"/><strong class="calibre4">Domain kvm1 XML configuration edited.</strong><br class="calibre7"/><br class="calibre7"/><strong class="calibre4">root@kvm:~#</strong>
</pre>
<ol start="8" class="calibre18">
<li value="8" class="calibre17">Restart the KVM instance:</li>
</ol>
<pre class="calibre25">
<strong class="calibre4">root@kvm:~# virsh destroy kvm1</strong><br class="calibre7"/><strong class="calibre4">Domain kvm1 destroyed</strong><br class="calibre7"/><br class="calibre7"/><strong class="calibre4">root@kvm:~# virsh start kvm1</strong><br class="calibre7"/><strong class="calibre4">Domain kvm1 started</strong><br class="calibre7"/><br class="calibre7"/><strong class="calibre4">root@kvm:~#</strong>
</pre>
<ol start="9" class="calibre18">
<li value="9" class="calibre17">List the <strong class="calibre4">Virtual Functions</strong> (<strong class="calibre4">VFs</strong>) provided by SR-IOV NIC:</li>
</ol>
<pre class="calibre25">
<strong class="calibre4">root@kvm:~# virsh net-dumpxml passthrough_net</strong><br class="calibre7"/><strong class="calibre4">&lt;network connections='1'&gt;</strong><br class="calibre7"/><strong class="calibre4">   &lt;name&gt;passthrough_net&lt;/name&gt;</strong><br class="calibre7"/><strong class="calibre4">   &lt;uuid&gt;a4233231-d353-a112-3422-3451ac78623a&lt;/uuid&gt;</strong><br class="calibre7"/><strong class="calibre4">   &lt;forward mode='hostdev' managed='yes'&gt;</strong><br class="calibre7"/><strong class="calibre4">     &lt;pf dev='eth1'/&gt;</strong><br class="calibre7"/><strong class="calibre4">     &lt;address type='pci' domain='0x0000' bus='0x02' slot='0x10' function='0x1'/&gt;</strong><br class="calibre7"/><strong class="calibre4">     &lt;address type='pci' domain='0x0000' bus='0x02' slot='0x10' function='0x3'/&gt;</strong><br class="calibre7"/><strong class="calibre4">     &lt;address type='pci' domain='0x0000' bus='0x02' slot='0x10' function='0x5'/&gt;</strong><br class="calibre7"/><strong class="calibre4">     &lt;address type='pci' domain='0x0000' bus='0x02' slot='0x10' function='0x7'/&gt;</strong><br class="calibre7"/><strong class="calibre4">     &lt;address type='pci' domain='0x0000' bus='0x02' slot='0x11' function='0x1'/&gt;</strong><br class="calibre7"/><strong class="calibre4">     &lt;address type='pci' domain='0x0000' bus='0x02' slot='0x11' function='0x3'/&gt;</strong><br class="calibre7"/><strong class="calibre4">     &lt;address type='pci' domain='0x0000' bus='0x02' slot='0x11' function='0x5'/&gt;</strong><br class="calibre7"/><strong class="calibre4">   &lt;/forward&gt;</strong><br class="calibre7"/><strong class="calibre4">&lt;/network&gt;</strong><br class="calibre7"/><strong class="calibre4">root@kvm:~#</strong>
</pre>


            </article>

            <footer class="calibre5">
                
            </footer>

        </section>
    

        <section class="calibre1">

            <header class="calibre1">
                </header><h1 class="header-title" id="calibre_pb_0">How it works...</h1>
            

            <article class="calibre1">
                
<p class="calibre3">In order to directly attach PCI NIC from the host OS to the guest VM, we first need to gather some hardware information about the device, such as <span>domain, bus, slot, and function IDs. In step 1, we collect information about all available devices on the host server. We are interested in using the eth1 network interface for this example; therefore, we note down the unique PCI identification from the output--<kbd class="calibre13">pci_0000_03_00_1</kbd> in this case.</span></p>
<p class="calibre3">To confirm this is indeed NIC we would like to expose to the guest, we list all PCI devices in step 2. From the output, we can see that the PCI ID is the same <kbd class="calibre13">03:00.1</kbd>.</p>
<p class="calibre3">Using the PCI ID from step 1, we proceed to collect more information about NIC in step 3. Note that <kbd class="calibre13">0000_03_00_1 ID</kbd> is broken down into <span>domain ID, bus ID, slot ID, and function ID, as shown by the XML attributes. We are going to use those IDs in step 7; however, we need to convert them to hexadecimals first, which we do in step 4. </span></p>
<p class="calibre3">In steps 5 and 6, we define a new <kbd class="calibre13">libvirt</kbd> network for our guest, start the network, and enable autostarting in case the host server restarts. If you completed the other recipes in this chapter, you should be already familiar with most of the attributes in the XML definition file for the network we just created. The <kbd class="calibre13">hostdev</kbd> mode defined in the <kbd class="calibre13">&lt;forward&gt;</kbd> attribute is what instructs <kbd class="calibre13">libvirt</kbd> that the new network is going to use PCI passthrough. The <kbd class="calibre13">managed=yes</kbd> parameter, as specified in the <kbd class="calibre13">&lt;forward&gt;</kbd> attribute, tells <kbd class="calibre13">libvirt</kbd> to first detach the PCI device from the host before passing it on to the guest and reattaching it back to the host after the guest terminates. Finally, the <kbd class="calibre13">&lt;pf&gt;</kbd> subelement specifies the physical interface that will be virtualized and presented to the guest.</p>
<div class="packt_infobox">For more information on the available XML attributes, please refer to <a href="http://libvirt.org/formatdomain.html" class="calibre30">http://libvirt.org/formatdomain.html</a>.</div>
<p class="calibre3">In step 7, we edit the XML definition of the KVM instance, specifying the PCI IDs we obtained in step 3 and defined an interface that will use the new PCI passthrough network we created in steps 5 and 6.</p>
<p class="calibre3">We restart the KVM instance in step 8 and finally verify that the physical PCI NIC device is now part of the new passthrough network we defined earlier. Note the presence of multiple PCI type devices. This is because the PCI passthrough device we are using supports <span>SR-IOV. All KVM guests that will use this network will now be able to directly use the host NIC by assigning one of the listed virtual PCI devices.</span></p>


            </article>

            <footer class="calibre5">
                
            </footer>

        </section>
    

        <section class="calibre1">

            <header class="calibre1">
                </header><h1 class="header-title" id="calibre_pb_0">Manipulating network interfaces</h1>
            

            <article class="calibre1">
                
<p class="calibre3">Libvirt provides a handy way to manage network interfaces on the host through the already familiar XML definition syntax. We can use the <kbd class="calibre13">virsh</kbd> command to define, provision, and delete Linux bridges and obtain more information about existing network interfaces, as you've already seen in this chapter.</p>
<p class="calibre3">In this recipe, we are going to define a new Linux bridge, create it, and finally remove it using <kbd class="calibre13">virsh</kbd>. If you recall from earlier recipes, we can manipulate the Linux bridge through utilities such as <kbd class="calibre13">brctl</kbd>. With libvirt, however, we have a way to control this programmatically by writing the definition file and using the API bindings, as we'll see in <a target="_blank" href="part0248.html#7CGBG0-c1e587dcccb14690b55c247c1809e6ce" class="calibre8">Chapter 7</a><em class="calibre22">, Using Python to Build and Manage KVM Instances</em>.  </p>


            </article>

            <footer class="calibre5">
                
            </footer>

        </section>
    

        <section class="calibre1">

            <header class="calibre1">
                </header><h1 class="header-title" id="calibre_pb_0">Getting ready</h1>
            

            <article class="calibre1">
                
<p class="calibre3">For this recipe, we are going to need the following:</p>
<ul class="calibre16">
<li class="calibre17">The <kbd class="calibre13">libvirt</kbd> package installed on the host</li>
<li class="calibre17">A Linux host with the bridge kernel module</li>
</ul>


            </article>

            <footer class="calibre5">
                
            </footer>

        </section>
    

        <section class="calibre1">

            <header class="calibre1">
                </header><h1 class="header-title" id="calibre_pb_0">How to do it...</h1>
            

            <article class="calibre1">
                
<p class="calibre3">To create a new bridge interface using libvirt, run the following commands: </p>
<ol class="calibre18">
<li value="1" class="calibre17"><span>Create a new</span> bridge <span>interface configuration file:</span></li>
</ol>
<pre class="calibre25">
<strong class="calibre4">root@kvm:~# cat test_bridge.xml</strong><br class="calibre7"/><strong class="calibre4">&lt;interface type='bridge' name='test_bridge'&gt;</strong><br class="calibre7"/><strong class="calibre4"> &lt;start mode="onboot"/&gt;</strong><br class="calibre7"/><strong class="calibre4">   &lt;protocol family='ipv4'&gt;</strong><br class="calibre7"/><strong class="calibre4"> &lt;ip address='192.168.1.100' prefix='24'/&gt;</strong><br class="calibre7"/><strong class="calibre4"> &lt;/protocol&gt;</strong><br class="calibre7"/><strong class="calibre4"> &lt;bridge&gt;</strong><br class="calibre7"/><strong class="calibre4">   &lt;interface type='ethernet' name='vnet0'&gt;</strong><br class="calibre7"/><strong class="calibre4">     &lt;mac address='fe:54:00:55:9b:d6'/&gt;</strong><br class="calibre7"/><strong class="calibre4">   &lt;/interface&gt;</strong><br class="calibre7"/><strong class="calibre4"> &lt;/bridge&gt;</strong><br class="calibre7"/><strong class="calibre4">&lt;/interface&gt;</strong><br class="calibre7"/><strong class="calibre4">root@kvm:~#</strong>
</pre>
<ol start="2" class="calibre18">
<li value="2" class="calibre17">Define the new interface:</li>
</ol>
<pre class="calibre25">
<strong class="calibre4">root@kvm:~# virsh iface-define test_bridge.xml</strong><br class="calibre7"/><strong class="calibre4">Interface test_bridge defined from test_bridge.xml</strong><br class="calibre7"/><br class="calibre7"/><strong class="calibre4">root@kvm:~#</strong>
</pre>
<ol start="3" class="calibre18">
<li value="3" class="calibre17">List all interfaces libvirt knows about:</li>
</ol>
<pre class="calibre25">
<strong class="calibre4">root@kvm:~# virsh iface-list --all</strong><br class="calibre7"/><strong class="calibre4"> Name            State       MAC Address</strong><br class="calibre7"/><strong class="calibre4">---------------------------------------------------</strong><br class="calibre7"/><strong class="calibre4"> bond0           active      58:20:b1:00:b8:61</strong><br class="calibre7"/><strong class="calibre4"> bond0.129       active      bc:76:4e:20:10:6b</strong><br class="calibre7"/><strong class="calibre4"> bond0.229       active      bc:76:4e:20:17:7e</strong><br class="calibre7"/><strong class="calibre4"> eth0            active      58:20:b1:00:b8:61</strong><br class="calibre7"/><strong class="calibre4"> eth1            active      58:20:b1:00:b8:61</strong><br class="calibre7"/><strong class="calibre4"> lo              active      00:00:00:00:00:00</strong><br class="calibre7"/><strong class="calibre4"> test_bridge     inactive</strong><br class="calibre7"/><br class="calibre7"/><strong class="calibre4">root@kvm:~#</strong>
</pre>
<ol start="4" class="calibre18">
<li value="4" class="calibre17">Start the new bridge interface:</li>
</ol>
<pre class="calibre25">
<strong class="calibre4">root@kvm:~# virsh iface-start test_bridge</strong><br class="calibre7"/><strong class="calibre4">Interface test_bridge started</strong><br class="calibre7"/><br class="calibre7"/><strong class="calibre4">root@kvm:~# virsh iface-list --all | grep test_bridge</strong><br class="calibre7"/><strong class="calibre4"> test_bridge    active    4a:1e:48:e1:e7:de</strong><br class="calibre7"/><strong class="calibre4">root@kvm:~#</strong>
</pre>
<ol start="5" class="calibre18">
<li value="5" class="calibre17">List all bridge devices on the host:</li>
</ol>
<pre class="calibre25">
<strong class="calibre4">root@kvm:~# brctl show</strong><br class="calibre7"/><strong class="calibre4">bridge name       bridge id           STP enabled   interfaces</strong><br class="calibre7"/><strong class="calibre4">test_bridge       8000.000000000000   no</strong><br class="calibre7"/><strong class="calibre4">virbr0            8000.000000000000   yes</strong><br class="calibre7"/><strong class="calibre4">virbr1            8000.525400ba8e2c   yes           virbr1-nic</strong><br class="calibre7"/><strong class="calibre4">                                                    vnet0</strong><br class="calibre7"/><strong class="calibre4">root@kvm:~#</strong>
</pre>
<ol start="6" class="calibre18">
<li value="6" class="calibre17">Check the active network configuration of the new bridge:</li>
</ol>
<pre class="calibre25">
<strong class="calibre4">root@kvm:~# ip a s test_bridge</strong><br class="calibre7"/><strong class="calibre4">46: test_bridge: &lt;BROADCAST,MULTICAST,UP,LOWER_UP&gt; mtu 1500 qdisc noqueue state UNKNOWN group default</strong><br class="calibre7"/><strong class="calibre4"> link/ether 4a:1e:48:e1:e7:de brd ff:ff:ff:ff:ff:ff</strong><br class="calibre7"/><strong class="calibre4"> inet 192.168.1.100/24 brd 192.168.1.255 scope global test_bridge</strong><br class="calibre7"/><strong class="calibre4"> valid_lft forever preferred_lft forever</strong><br class="calibre7"/><strong class="calibre4"> inet6 fe80::481e:48ff:fee1:e7de/64 scope link</strong><br class="calibre7"/><strong class="calibre4"> valid_lft forever preferred_lft forever</strong><br class="calibre7"/><strong class="calibre4">root@kvm:~#</strong>
</pre>
<ol start="7" class="calibre18">
<li value="7" class="calibre17">Obtain the MAC address of bridge:</li>
</ol>
<pre class="calibre25">
<strong class="calibre4">root@kvm:~# virsh iface-mac test_bridge</strong><br class="calibre7"/><strong class="calibre4">4a:1e:48:e1:e7:de</strong><br class="calibre7"/><br class="calibre7"/><strong class="calibre4">root@kvm:~#</strong>
</pre>
<ol start="8" class="calibre18">
<li value="8" class="calibre17">Obtain the name of the bridge based by providing its MAC address:</li>
</ol>
<pre class="calibre25">
<strong class="calibre4">root@kvm:~# virsh iface-name 4a:1e:48:e1:e7:de</strong><br class="calibre7"/><strong class="calibre4">test_bridge</strong><br class="calibre7"/><br class="calibre7"/><strong class="calibre4">root@kvm:~#</strong>
</pre>
<ol start="9" class="calibre18">
<li value="9" class="calibre17">Destroy the interface, as follows:</li>
</ol>
<pre class="calibre25">
<strong class="calibre4">root@kvm:~# virsh iface-destroy test_bridge</strong><br class="calibre7"/><strong class="calibre4">Interface test_bridge destroyed</strong><br class="calibre7"/><br class="calibre7"/><strong class="calibre4">root@kvm:~# virsh iface-list --all | grep test_bridge</strong><br class="calibre7"/><strong class="calibre4"> test_bridge inactive</strong><br class="calibre7"/><strong class="calibre4">root@kvm:~# virsh iface-undefine test_bridge</strong><br class="calibre7"/><strong class="calibre4">Interface test_bridge undefined</strong><br class="calibre7"/><br class="calibre7"/><strong class="calibre4">root@kvm:~# virsh iface-list --all | grep test_bridge</strong><br class="calibre7"/><strong class="calibre4">root@kvm:~#</strong>
</pre>


            </article>

            <footer class="calibre5">
                
            </footer>

        </section>
    

        <section class="calibre1">

            <header class="calibre1">
                </header><h1 class="header-title" id="calibre_pb_0">How it works...</h1>
            

            <article class="calibre1">
                
<p class="calibre3">In step 1, we write the XML definition for the new network interface. We specify bridge as the type, an IP address for the interface, and optionally a MAC address. </p>
<p class="calibre3">In steps 2 and 3, we define the new bridge interface and list it. Defining an interface does not automatically make it active, so we activate it in step 4.</p>
<p class="calibre3">Activating the bridge creates the actual interface on the host, as shown in step 5.</p>
<p class="calibre3">In step 6, we confirm that the IP and MAC address assigned to the bridge are indeed what we specified in step 1.</p>
<p class="calibre3">In steps 7 and 8, we obtain both the name and MAC address using the <kbd class="calibre13">virsh</kbd> utility and finally, in step 9, we remove the <kbd class="calibre13">bridge</kbd> interface.</p>


            </article>

            <footer class="calibre5">
                
            </footer>

        </section>
    </body></html>