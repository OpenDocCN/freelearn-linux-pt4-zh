<html><head></head><body><div class="chapter" title="Chapter&#xA0;7.&#xA0;Building a Web-Based Control Panel"><div class="titlepage"><div><div><h1 class="title"><a id="ch07"/>Chapter 7. Building a Web-Based Control Panel</h1></div></div></div><p>We've now got all of our hardware elements together for us to create a complete home-security system featuring contact switches for our doors and windows, and motion detectors and cameras to take happy snaps of wannabe intruders! I've deliberately guided you through this in a modular fashion so that you can pick and choose and expand on the hardware sensor elements that suit your requirements. In <a class="link" href="ch09.html" title="Chapter 9. Putting It All Together">Chapter 9</a>, <span class="emphasis"><em>Putting It All Together</em></span> we will be wiring all of this together to form the complete system based on zones that we looked at earlier.</p><p>One thing that all home security<a id="id274" class="indexterm"/> systems require is a <span class="strong"><strong>control panel</strong></span> that allows us to <span class="strong"><strong>arm</strong></span> and <span class="strong"><strong>disarm</strong></span> the system and monitor the status of the zones within our system. We might <a id="id275" class="indexterm"/>also want to do things such as only arm certain zones, or have the system automatically<a id="id276" class="indexterm"/> arm and disarm at certain times of the day.</p><p>The hardware required for this, such as switches, LEDs, and LCD displays, can be quite expensive and time-consuming to put together; they can also make the system less configurable and flexible. So, in our system, we're going to build a Web-based control panel that we can access from our mobile phone browser. This also means that we can control the system remotely, when we are out of the house.</p><p>In this chapter, we will cover the following:</p><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc">Defining the scope of our home security in terms of the number of zones we will be monitoring and the I/O ports we will use</li><li class="listitem" style="list-style-type: disc">Learning how to install and configure a web server on our Raspberry Pi</li><li class="listitem" style="list-style-type: disc">Developing a basic HTML5 web page for our alarm control panel</li><li class="listitem" style="list-style-type: disc">Learning how to use PHP scripts to dynamically configure our system from the web page</li></ul></div><div class="section" title="Installing the web server"><div class="titlepage"><div><div><h1 class="title"><a id="ch07lvl1sec47"/>Installing the web server</h1></div></div></div><p>There are several <span class="strong"><strong>web servers</strong></span> readily available that we could install on our Raspberry Pi, and they would all be suitable for our system. But I like the<a id="id277" class="indexterm"/> <span class="strong"><strong>lighttpd</strong></span> web server as it's easy to use and lightweight. lighttpd is often referred to, and affectionately known as, "Lighty"—which to be honest is less of a mouthful than lighttpd.</p><p>As well as the Web server itself, we're also going to install<a id="id278" class="indexterm"/> <span class="strong"><strong>PHP</strong></span> support, which will allow us to write <a id="id279" class="indexterm"/>dynamic web pages to interact with the Linux system. Now, to be honest, I'm not a massive fan of PHP for commercial Web-based deployments for many reasons, but for a small embedded-Linux system such as our home security system, it's perfect and works really well. It's also quite straightforward to get into if you've never done server-side Web-scripting as well.</p><p>To perform the following steps, you'll need to be logged into your Raspberry Pi via the terminal console (for example, PuTTY):</p><div class="orderedlist"><ol class="orderedlist arabic"><li class="listitem">Update the package installer:<div class="informalexample"><pre class="programlisting">
<span class="strong"><strong>$ sudo apt-get update</strong></span>
</pre></div></li><li class="listitem">Install the <code class="literal">lighttpd</code> Web server:<div class="informalexample"><pre class="programlisting">
<span class="strong"><strong>$ sudo apt-get install lighttpd</strong></span>
</pre></div><p>Once installed, it will automatically start up as a background service, and will do so each time your Raspberry Pi starts up.</p></li><li class="listitem">Install PHP5 support:<div class="informalexample"><pre class="programlisting">
<span class="strong"><strong>$ sudo apt-get install php5-cgi</strong></span>
</pre></div></li><li class="listitem">Now, we need to enable the PHP FastCGI module in our web server:<div class="informalexample"><pre class="programlisting">
<span class="strong"><strong>$ sudo lighty-enable-mod fastcgi-php</strong></span>
</pre></div></li><li class="listitem">And finally, we need to restart the Web server:<div class="informalexample"><pre class="programlisting">
<span class="strong"><strong>$ sudo /etc/init.d/lighttpd</strong></span>
</pre></div></li></ol></div><p>That's it! You should now have your PHP Web server installed. By default, the web content files get installed in the location, <code class="literal">/var/www</code>, and Lighty installs a test placeholder page in this location, which you can access from your browser by simply entering the IP address of your Raspberry Pi, as shown in the following screenshot:</p><div class="mediaobject"><img src="graphics/B04579_07_01.jpg" alt="Installing the web server"/><div class="caption"><p>The Lighttpd placeholder page</p></div></div><div class="section" title="Testing the PHP5 installation"><div class="titlepage"><div><div><h2 class="title"><a id="ch07lvl2sec60"/>Testing the PHP5 installation</h2></div></div></div><p>While we're at it, we should also test <a id="id280" class="indexterm"/>our PHP installation, as this<a id="id281" class="indexterm"/> is fundamental to building our console. This can be done by writing a simple PHP script page that, if PHP is installed correctly, will return information about its environment and configuration:</p><div class="orderedlist"><ol class="orderedlist arabic"><li class="listitem">First, go to the web content folder:<div class="informalexample"><pre class="programlisting">
<span class="strong"><strong>$ cd /var/www</strong></span>
</pre></div></li><li class="listitem">In Nano, create a file called <code class="literal">phpinfo.php</code>:<div class="informalexample"><pre class="programlisting">
<span class="strong"><strong>$ sudo nano phpinfo.php</strong></span>
</pre></div></li><li class="listitem">In the editor, enter just the following single line, then save and exit from Nano:<div class="informalexample"><pre class="programlisting">
<span class="strong"><strong>&lt;?php phpinfo(); ?&gt;</strong></span>
</pre></div></li></ol></div><p>Now, in your browser, enter the<a id="id282" class="indexterm"/> IP address of your Raspberry Pi<a id="id283" class="indexterm"/> followed by <code class="literal">/phpinfo.php</code>, for example, http://192.168.0.110/phpinfo.php, and you should be presented with the following page:</p><div class="mediaobject"><img src="graphics/B04579_07_02.jpg" alt="Testing the PHP5 installation"/><div class="caption"><p>The PHP info page generated by the Web server</p></div></div><p>Now that we know <a id="id284" class="indexterm"/>our web server is working properly, we <a id="id285" class="indexterm"/>can start creating our console web page.</p></div></div></div>
<div class="section" title="Being in control"><div class="titlepage"><div><div><h1 class="title"><a id="ch07lvl1sec48"/>Being in control</h1></div></div></div><p>So that we know what controls we want on our alarm control panel, we need to map out our system with the number of zone inputs and control inputs and outputs. As you'll remember from <a class="link" href="ch03.html" title="Chapter 3. Extending Your Pi to Connect More Things">Chapter 3</a>, <span class="emphasis"><em>Extending Your Pi to Connect More Things</em></span> we can essentially have up to 16 zones in our system using the two I/O ports on our port expander. We also have the eight GPIO pins at our disposal on the Raspberry Pi board itself. So, let's now allocate these outputs and <a id="id286" class="indexterm"/>document them in the table that follows.</p><p>I'm going to set up an 8-zone system for my alarm inputs using port A on the I/O expander board, using the native GPIO pins for things such as buttons and alert outputs. One reason for doing it in this configuration is that the system can always fail-safe—so if the expander board fails, the <a id="id287" class="indexterm"/>Raspberry Pi can still communicate alerts and buzzers connected to it.</p><div class="informaltable"><table border="1"><colgroup><col style="text-align: left"/><col style="text-align: left"/><col style="text-align: left"/></colgroup><thead><tr><th style="text-align: left" valign="bottom">
<p>Port</p>
</th><th style="text-align: left" valign="bottom">
<p>I/O Pin</p>
</th><th style="text-align: left" valign="bottom">
<p>Label/Purpose</p>
</th></tr></thead><tbody><tr><td style="text-align: left" valign="top">
<p>Expander A</p>
</td><td style="text-align: left" valign="top">
<p>0 (A0)</p>
</td><td style="text-align: left" valign="top">
<p>Zone 1 Input (Entry/Exit Channel)</p>
</td></tr><tr><td style="text-align: left" valign="top"> </td><td style="text-align: left" valign="top">
<p>1 (A1)</p>
</td><td style="text-align: left" valign="top">
<p>Zone 2 Input</p>
</td></tr><tr><td style="text-align: left" valign="top"> </td><td style="text-align: left" valign="top">
<p>2 (A2)</p>
</td><td style="text-align: left" valign="top">
<p>Zone 3 Input</p>
</td></tr><tr><td style="text-align: left" valign="top"> </td><td style="text-align: left" valign="top">
<p>3 (A3)</p>
</td><td style="text-align: left" valign="top">
<p>Zone 4 Input</p>
</td></tr><tr><td style="text-align: left" valign="top"> </td><td style="text-align: left" valign="top">
<p>4 (A4)</p>
</td><td style="text-align: left" valign="top">
<p>Zone 5 Input</p>
</td></tr><tr><td style="text-align: left" valign="top"> </td><td style="text-align: left" valign="top">
<p>5 (A5)</p>
</td><td style="text-align: left" valign="top">
<p>Zone 6 Input</p>
</td></tr><tr><td style="text-align: left" valign="top"> </td><td style="text-align: left" valign="top">
<p>6 (A6)</p>
</td><td style="text-align: left" valign="top">
<p>Zone 7 Input</p>
</td></tr><tr><td style="text-align: left" valign="top"> </td><td style="text-align: left" valign="top">
<p>7 (A7)</p>
</td><td style="text-align: left" valign="top">
<p>Zone 8 – Anti-Tamper Loop Input</p>
</td></tr><tr><td style="text-align: left" valign="top">
<p>Expander B</p>
</td><td style="text-align: left" valign="top">
<p>0 (B0)</p>
</td><td style="text-align: left" valign="top"> </td></tr><tr><td style="text-align: left" valign="top"> </td><td style="text-align: left" valign="top">
<p>1 (B1)</p>
</td><td style="text-align: left" valign="top"> </td></tr><tr><td style="text-align: left" valign="top"> </td><td style="text-align: left" valign="top">
<p>2 (B2)</p>
</td><td style="text-align: left" valign="top"> </td></tr><tr><td style="text-align: left" valign="top"> </td><td style="text-align: left" valign="top">
<p>3 (B3)</p>
</td><td style="text-align: left" valign="top"> </td></tr><tr><td style="text-align: left" valign="top"> </td><td style="text-align: left" valign="top">
<p>4 (B4)</p>
</td><td style="text-align: left" valign="top"> </td></tr><tr><td style="text-align: left" valign="top"> </td><td style="text-align: left" valign="top">
<p>5 (B5)</p>
</td><td style="text-align: left" valign="top"> </td></tr><tr><td style="text-align: left" valign="top"> </td><td style="text-align: left" valign="top">
<p>6 (B6)</p>
</td><td style="text-align: left" valign="top"> </td></tr><tr><td style="text-align: left" valign="top"> </td><td style="text-align: left" valign="top">
<p>7 (B7)</p>
</td><td style="text-align: left" valign="top"> </td></tr><tr><td style="text-align: left" valign="top">
<p>R-Pi GPIO</p>
</td><td style="text-align: left" valign="top">
<p>0 (GP0)</p>
</td><td style="text-align: left" valign="top">
<p>Arm/Disarm Switch (Input)</p>
</td></tr><tr><td style="text-align: left" valign="top"> </td><td style="text-align: left" valign="top">
<p>1 (GP1)</p>
</td><td style="text-align: left" valign="top"> </td></tr><tr><td style="text-align: left" valign="top"> </td><td style="text-align: left" valign="top">
<p>2 (GP2)</p>
</td><td style="text-align: left" valign="top"> </td></tr><tr><td style="text-align: left" valign="top"> </td><td style="text-align: left" valign="top">
<p>3 (GP3)</p>
</td><td style="text-align: left" valign="top"> </td></tr><tr><td style="text-align: left" valign="top"> </td><td style="text-align: left" valign="top">
<p>4 (GP4)</p>
</td><td style="text-align: left" valign="top">
<p>Armed LED (Output)</p>
</td></tr><tr><td style="text-align: left" valign="top"> </td><td style="text-align: left" valign="top">
<p>5 (GP5)</p>
</td><td style="text-align: left" valign="top">
<p>Arm/Disarm Buzzer (Output)</p>
</td></tr><tr><td style="text-align: left" valign="top"> </td><td style="text-align: left" valign="top">
<p>6 (GP6)</p>
</td><td style="text-align: left" valign="top">
<p>Alarm LED (Output)</p>
</td></tr><tr><td style="text-align: left" valign="top"> </td><td style="text-align: left" valign="top">
<p>7 (GP7)</p>
</td><td style="text-align: left" valign="top">
<p>Alarm Bell (Output)</p>
</td></tr></tbody></table></div><div class="section" title="Arming yourself"><div class="titlepage"><div><div><h2 class="title"><a id="ch07lvl2sec61"/>Arming yourself</h2></div></div></div><p>The terms <span class="emphasis"><em>arm</em></span> and <span class="emphasis"><em>disarm</em></span> are alarm system<a id="id288" class="indexterm"/>-speak for switching the alarm monitoring on (<span class="strong"><strong>arming</strong></span> the system) and off (<span class="strong"><strong>disarming</strong></span> the system). Zone 1 of our system is going to be linked to the arming<a id="id289" class="indexterm"/> and disarming part of the system as it will be <a id="id290" class="indexterm"/>connected to the sensors on the door that we leave or enter from; this will be a special zone<a id="id291" class="indexterm"/> for <span class="strong"><strong>entry</strong></span> or <span class="strong"><strong>exit</strong></span> purposes.</p><p>When we set the alarm, we need a bit of time to get out of the house. The way that the system knows we've left the property is by monitoring the <span class="emphasis"><em>exit</em></span> zone to see if we've opened and then closed the front door behind us within the time allowed.</p><p>Similarly, when we return, we will open the front door, but we don't want the alarm to go off straightaway—we need a chance to disarm the system within a given amount of time. We will arm and disarm the system via our web-based control panel, or by using a switch of some sort on the input GP0.</p></div></div>
<div class="section" title="The master configuration file"><div class="titlepage"><div><div><h1 class="title"><a id="ch07lvl1sec49"/>The master configuration file</h1></div></div></div><p>Our system will use a <span class="strong"><strong>master configuration file</strong></span> that will tell it how everything is set up and connected. This configuration file will be used by both the web control panel and the main alarm control <a id="id292" class="indexterm"/>scripts so that the two sub-systems can "talk" to each other. Let's create the file with our initial settings.</p><p>The settings file will be stored in the same location as where we will create our control scripts in <a class="link" href="ch09.html" title="Chapter 9. Putting It All Together">Chapter 9</a>, <span class="emphasis"><em>Putting It All Together</em></span>, which is in the folder. <code class="literal">/etc/pi-alarm</code>. So, let's create this folder, and give it execute rights so that our scripts can be run:</p><div class="informalexample"><pre class="programlisting">
<span class="strong"><strong>$ cd /etc</strong></span>
<span class="strong"><strong>$ sudo mkdir pi-alarm</strong></span>
<span class="strong"><strong>$ sudo chmod 777 pi-alarm</strong></span>
</pre></div><p>We'll now create the master configuration file, to be used by our system, in this folder:</p><div class="informalexample"><pre class="programlisting">
<span class="strong"><strong>$ cd pi-alarm</strong></span>
<span class="strong"><strong>$ sudo nano alarm.cfg</strong></span>
</pre></div><div class="note" title="Note" style=""><div class="inner"><h3 class="title"><a id="tip08"/>Tip</h3><p>As before, you don't have to create your files in Nano on the Raspberry Pi—you can create them on your <a id="id293" class="indexterm"/>desktop computer, and then transfer them to your Pi using SCP.</p></div></div><div class="informalexample"><pre class="programlisting"># ALARM MASTER CONFIG FILE #

#Number of zones in the system
NUM_ZONES=8

#Display labels for each zone
ZONE_LABEL_1="Zone 1 - Entry/Exit"
ZONE_LABEL_2="Zone 2"
ZONE_LABEL_3="Zone 3"
ZONE_LABEL_4="Zone 4"
ZONE_LABEL_5="Zone 5"
ZONE_LABEL_6="Zone 6"
ZONE_LABEL_7="Zone 7"
ZONE_LABEL_8="Zone 8"

#Zones that are enabled
#Set to 0 to Disable or 1 to Enable
ZONE_ENABLE_1=1
ZONE_ENABLE_2=1
ZONE_ENABLE_3=1
ZONE_ENABLE_4=1
ZONE_ENABLE_5=1
ZONE_ENABLE_6=1
ZONE_ENABLE_7=1
ZONE_ENABLE_8=1

SYSTEM_ARMED=0

#Zone status
#Set to 1 if zone is triggered
ZONE_STATUS_1=0
ZONE_STATUS_2=0
ZONE_STATUS_3=0
ZONE_STATUS_4=0
ZONE_STATUS_5=0
ZONE_STATUS_6=0
ZONE_STATUS_7=0
ZONE_STATUS_8=0</pre></div><p>
<code class="literal">alarm.cfg</code> file</p></div>
<div class="section" title="Creating the web page"><div class="titlepage"><div><div><h1 class="title"><a id="ch07lvl1sec50"/>Creating the web page</h1></div></div></div><p>Our Web-based control panel is going to be a single PHP-driven HTML5 web page which will be<a id="id294" class="indexterm"/> <span class="strong"><strong>mobile optimized</strong></span>. HTML5 is the latest mark-up standard for web pages and is supported by <a id="id295" class="indexterm"/>most modern smartphones and browsers. We will also create a <a id="id296" class="indexterm"/>
<span class="strong"><strong>cascading style-sheet</strong></span> (<span class="strong"><strong>CSS</strong></span>) that will make our page look half reasonable on mobile devices.</p><p>To create the web files, I recommend that you use something like the excellent Notepad++ on your desktop computer, rather than doing it directly on the Raspberry Pi. Alternatively, if you are a seasoned web developer, you may already have your IDE of choice.</p><div class="section" title="The control panel HTML template"><div class="titlepage"><div><div><h2 class="title"><a id="ch07lvl2sec62"/>The control panel HTML template</h2></div></div></div><p>The first thing we'll do is<a id="id297" class="indexterm"/> create an HTML file that we can use to test our layout before we put the HTML into a PHP file to make it interact with our system. This makes it easier to tweak the way we want it to look beforehand, without the PHP <a id="id298" class="indexterm"/>scripts getting in the way.</p><div class="note" title="Note" style=""><div class="inner"><h3 class="title"><a id="note32"/>Note</h3><p>This is not a tutorial on Web development—there is a plethora of books out there on that subject—but I hope the code is clear enough for you to work out what's going on. The code I'm going to show you is fully functional, so you can just use what I give you without having to do any more. Hopefully, it makes your control panel look OK too!</p></div></div><p>The following mark-up gives you a basic control panel with status for our 8 zones, a master arm and disarm switch, and switches to enable or disable any of our zones.</p><p>The <code class="literal">&lt;head&gt;</code> section of the code contains some <code class="literal">&lt;meta&gt;</code> tags that help mobile devices know that it's a mobile-friendly site. In the main <code class="literal">&lt;body&gt;</code> mark-up, we have a section for each zone that contains the zone's name and an on/off switch. Each zone is in its container so that we can also highlight a particular zone that needs our attention, for example, if it's triggered.</p><p>You can find the full HTML5 markup for our control panel in the <code class="literal">alarm-panel.html</code> file located inside the code folder of <code class="literal">chapter 7</code>.</p></div><div class="section" title="Giving it some style"><div class="titlepage"><div><div><h2 class="title"><a id="ch07lvl2sec63"/>Giving it some style</h2></div></div></div><p>At the moment, this page <a id="id299" class="indexterm"/>doesn't look that great (in fact, it looks awful, like something from the 1990s); it isn't particularly good for mobile devices and would most certainly fail the <span class="emphasis"><em>sausage test</em></span>. So, we're going to apply some styling to make it look not half bad. Although the preceding mark-up contains a reference to a CSS file—we haven't created that file—so this is what our page currently looks like (as I said: it looks awful):</p><div class="mediaobject"><img src="graphics/B04579_07_03.jpg" alt="Giving it some style"/><div class="caption"><p>The web control panel without any styling</p></div></div><p>The following CSS3 mark-up is designed specifically for our control panel, and it makes it look quite nice while also making it usable on <span class="strong"><strong>touch-screen</strong></span> mobile devices. The CSS is quite long and seems overwhelming, but you don't need to do anything with it, or understand it, if you don't want to—the only thing you need to know is that it's been designed for modern<a id="id300" class="indexterm"/> browsers and smartphones, so don't expect it to work on Internet Explorer 7, or probably even IE9!</p><p>In essence, it contains the styling for the following:</p><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc">Preparing the browser for our mobile layout</li><li class="listitem" style="list-style-type: disc">Our text and zone areas</li><li class="listitem" style="list-style-type: disc">Creating cool switches instead of boring checkboxes</li><li class="listitem" style="list-style-type: disc">Making an area flash on and off when we need it to</li></ul></div><div class="informalexample"><pre class="programlisting">/* Clear browser margin and padding defaults */
body, div, dl, dt, dd, ul, ol, li, h1, h2, h3, h4, h5, h6, pre, form, fieldset, input, textarea, p {
margin:0;padding:0;-webkit-text-size-adjust:none;
}

body {
  background: #ffffff;
  color: #4A5651;
  font-family: "Trebuchet MS", Helvetica, sans-serif;
  font-size:10px;  
  height: 100%;
  padding:0;
  margin:0 auto;
  max-width:320px;
  min-width:240px;
  text-align: left;
  width:100%;
  -webkit-box-shadow: 0px 20px 40px 0px rgba(0,0,0,0.50);
  -moz-box-shadow: 0px 20px 40px 0px rgba(0,0,0,0.50);
  box-shadow: 0px 20px 40px 0px rgba(0,0,0,0.50);
}

p, .zoneLabel {
  font-size:16px;
  margin:5px;
  line-height:1.4;
  color:#4A5651;
}

#header h1 {
  font-size:20px;
  line-height:40px;
  margin:0;
  padding:0 0 0 15px;
  text-align:center;
  text-overflow: ellipsis;
  font-weight:bold;
}

.zoneControl, .masterControl{
  border-bottom:1px solid #dddddd;
  margin-top:5px;
  margin-bottom:0px;
  padding:5px;
  display:block;
  width:100%;
}

.zoneLabel {
  font-weight:bold;
  text-overflow:ellipsis;
}

input[type="submit"] {
  border: none;
  background-color: #0b70cc;
  color: white;
  height: 32px;
  display: block;
  padding: 4px 7px;
  float: left;
  border-radius: 8px;
  position: relative;
  bottom: 1px;
  margin-left: 4px;
  text-align: center;
}
input[type="submit"]:hover {background-color: #b2ceec;color: #0b70cc;border: none;border: 1px solid #b2ceec;}

/* Flashing animation */
@-webkit-keyframes flash{0%, 50%, 100% {opacity: 1;} 25%, 75% {opacity: 0;}}
@keyframes flash {0%, 50%, 100% {opacity: 1;} 25%, 75% {opacity: 0;}}
.flash {
  -webkit-animation-name:
  flash;animation-name:
  flash;color:#f00000;
}
.animated { 
  -webkit-animation-duration: 1s; 
  animation-duration: 1s; 
  -webkit-animation-fill-mode: both; 
  animation-fill-mode: both; 
  animation-iteration-count:infinite; 
  -webkit-animation-iteration-count:infinite; 
}

/*
  ON/OFF SWITCH STYLES
  The rather cool On/Off switch styling was generated on
  https://proto.io/freebies/onoff/
*/
.onoffswitch {
  position: relative;
  width: 90px;
  -webkit-user-select: none;
  -moz-user-select: none;
  -ms-user-select: none;
}

.onoffswitch-checkbox {
  display: none;
}

.onoffswitch-label {
  display: block;
  overflow: hidden;
  cursor: pointer;
  border: 2px solid #FFFFFF;
  border-radius: 20px;
}

.onoffswitch-inner {
  display: block;
  width: 200%;
  margin-left: -100%;
  transition: margin 0.3s ease-in 0s;
}

  .onoffswitch-inner:before, .onoffswitch-inner:after {
    display: block;
    float: left;
    width: 50%;
    height: 30px;
    padding: 0;
    line-height: 30px;
    font-size: 14px;
    color: white;
    font-family: Trebuchet, Arial, sans-serif;
    font-weight: bold;
    box-sizing: border-box;
  }

  .onoffswitch-inner:before {
    content: "ON";
    padding-left: 10px;
    background-color: #34C290;
    color: #FFFFFF;
  }

  .onoffswitch-inner:after {
    content: "OFF";
    padding-right: 10px;
    background-color: #EEEEEE;
    color: #999999;
    text-align: right;
  }

.onoffswitch-switch {
  display: block;
  width: 18px;
  margin: 6px;
  background: #FFFFFF;
  position: absolute;
  top: 0;
  bottom: 0;
  right: 56px;
  border: 2px solid #FFFFFF;
  border-radius: 20px;
  transition: all 0.3s ease-in 0s;
}

.onoffswitch-checkbox:checked + .onoffswitch-label .onoffswitch-inner {
  margin-left: 0;
}
.onoffswitch-checkbox:checked + .onoffswitch-label .onoffswitch-switch {
  right: 0px;
}

.masterswitch {
  position: relative;
  width: 90px;
  -webkit-user-select: none;
  -moz-user-select: none;
  -ms-user-select: none;
}

.masterswitch-checkbox {
  display: none;
}

.masterswitch-label {
  display: block;
  overflow: hidden;
  cursor: pointer;
  border: 2px solid #FFFFFF;
  border-radius: 20px;
}

.masterswitch-inner {
  display: block;
  width: 200%;
  margin-left: -100%;
  transition: margin 0.3s ease-in 0s;
}

.masterswitch-inner:before, .masterswitch-inner:after {
  display: block;
  float: left;
  width: 50%;
  height: 30px;
  padding: 0;
  line-height: 30px;
  font-size: 12px;
  color: white;
  font-family: Trebuchet, Arial, sans-serif;
  font-weight: bold;
  box-sizing: border-box;
}

.masterswitch-inner:before {
  content: "ARMED";
  padding-left: 10px;
  background-color: #F00000;
  color: #FFFFFF;
}

.masterswitch-inner:after {
  content: "OFF";
  padding-right: 10px;
  background-color: #EEEEEE;
  color: #999999;
  text-align: right;
}

.masterswitch-switch {
  display: block;
  width: 18px;
  margin: 6px;
  background: #FFFFFF;
  position: absolute;
  top: 0;
  bottom: 0;
  right: 56px;
  border: 2px solid #FFFFFF;
  border-radius: 20px;
  transition: all 0.3s ease-in 0s;
}

.masterswitch-checkbox:checked + .masterswitch-label .masterswitch-inner {
  margin-left: 0;
}

.masterswitch-checkbox:checked + .masterswitch-label .masterswitch-switch {
  right: 0px;
}
/* END OF SWITCH STYLES */</pre></div><p>Web control panel style<a id="id301" class="indexterm"/> sheet – <code class="literal">alarm-panel.css</code>
</p><p>Apply the stylesheet and this is what you end up with (a little bit nicer, I think you'll agree):</p><div class="mediaobject"><img src="graphics/B04579_07_04.jpg" alt="Giving it some style"/><div class="caption"><p>The web control panel with styling</p></div></div></div><div class="section" title="Making it dynamic"><div class="titlepage"><div><div><h2 class="title"><a id="ch07lvl2sec64"/>Making it dynamic</h2></div></div></div><p>Now that we have the layout code defined for our control panel page, we can insert it in our PHP page so that it can be modified dynamically by the PHP script on the Web server, depending on the status<a id="id302" class="indexterm"/> of our home security system.</p><p>The PHP script will help us achieve the following basic functions:</p><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc">Updating the configuration file with the position of the on/off switches for zones</li><li class="listitem" style="list-style-type: disc">Arming and disarming the system</li><li class="listitem" style="list-style-type: disc">Telling us which zone has been triggered when an intrusion has been detected</li></ul></div><p>Again, I'm not going to go into detail about how the PHP code works, but hopefully the comments within the code <a id="id303" class="indexterm"/>will help you follow what's going on, and also help you modify it if you want to change its behavior.</p><div class="section" title="Getting a bit of help first"><div class="titlepage"><div><div><h3 class="title"><a id="ch07lvl3sec13"/>Getting a bit of help first</h3></div></div></div><p>Unless you change some of the PHP configuration, it can be a nightmare trying to work out what's gone wrong if you have a small bug in your code, as basically you are presented with…nothing!</p><p>So, before we create and build our PHP page, we'll change a couple of settings in the PHP configuration file to <a id="id304" class="indexterm"/>make sure we know if there are any issues:</p><div class="orderedlist"><ol class="orderedlist arabic"><li class="listitem">Open the configuration file with <a id="id305" class="indexterm"/><span class="strong"><strong>Nano</strong></span>:<div class="informalexample"><pre class="programlisting">
<span class="strong"><strong>$ sudo nano /etc/php5/cgi/php.ini</strong></span>
</pre></div></li><li class="listitem">The file is a bit large and unwieldy, but battle your way through it, find these settings, and change them as follows:<div class="informalexample"><pre class="programlisting">error_reporting = E_ALL
display_errors = On</pre></div></li><li class="listitem">Save the file and exit Nano.</li><li class="listitem">Finally, restart Lighty:<div class="informalexample"><pre class="programlisting">
<span class="strong"><strong>$ sudo /etc/init.d/lighttpd restart</strong></span>
</pre></div></li></ol></div></div><div class="section" title="The main PHP code"><div class="titlepage"><div><div><h3 class="title"><a id="ch07lvl3sec14"/>The main PHP code</h3></div></div></div><p>And here it is… But don't run it yet—there's still a bit more to do…</p><p>You can find the full main<a id="id306" class="indexterm"/> PHP code in the <code class="literal">index.php</code> file located inside the code folder of <code class="literal">chapter 7</code>. In our Web server content folder, we should now have the following files:</p><div class="informalexample"><pre class="programlisting">pi@raspberrypi ~ $ ls -1 /var/www
alarm-panel.css
alarm-panel.html
index.lighttpd.html
index.php
phpinfo.php</pre></div></div><div class="section" title="I'm someone else"><div class="titlepage"><div><div><h3 class="title"><a id="ch07lvl3sec15"/>I'm someone else</h3></div></div></div><p>Now, before we can actually open this PHP web page successfully, we need to be aware of the fact that the Web server, by default, actually runs as a different user called <code class="literal">www-data</code>. This means<a id="id307" class="indexterm"/> that it doesn't ordinarily have the right to perform certain operations; in particular, those that interact with the file system.</p><p>If you worked through the previous PHP script, you'll see that it actually executes some Linux commands to read and update our <code class="literal">alarm.cfg</code> file.</p><p>In the same way that we have to put <code class="literal">sudo</code> in front of many commands because we're not the root user, it is true for other users as well, including <code class="literal">www-data</code>. So, to give the Web server rights to execute certain commands, we need to add it<a id="id308" class="indexterm"/> as a <span class="strong"><strong>sudoer</strong></span>, using the <a id="id309" class="indexterm"/>
<span class="strong"><strong>visudo</strong></span> utility.</p><p>Run the utility to open the sudoer configuration file:</p><div class="informalexample"><pre class="programlisting">
<span class="strong"><strong>$ sudo visudo</strong></span>
</pre></div><p>At the bottom of the file, add the following line:</p><div class="informalexample"><pre class="programlisting">www-data ALL=(ALL) NOPASSWD:/bin/cat,/etc/pi-alarm/update-alarm-setting.sh</pre></div><p>Then save the file and exit.</p><p>The final thing we have to do is create a<a id="id310" class="indexterm"/> small <span class="strong"><strong>Bash script</strong></span> that will handle the task of updating settings in our <code class="literal">alarm.cfg</code> file. The reason why we need to do this is because we're going to use the Linux <code class="literal">sed</code> command to update the file. The way that we are invoking the <code class="literal">sed</code> command means that it needs to create a temporary file. Unless we do a bit of work with configuring the Web server because of its file location context, it won't work. So, it's easier to create a stub Bash script that is called by the PHP script. In this way, the Bash environment deals with the temporary file context.</p><p>So, we'll create the following Bash script and save it in our <code class="literal">/etc/pi-alarm</code> folder:</p><div class="informalexample"><pre class="programlisting">#!/bin/bash
#/etc/pi-alarm/update-alarm-setting.sh
############################################
# Provides access to the sed command from  #
# PHP as it needs write access to a temp   #
# folder.                                  #
# $1 - Setting Name                        #
# $2 - Setting Value                       #
############################################

sed -i "s/^\($1\s*= *\).*/\1$2/" /etc/pi-alarm/alarm.cfg</pre></div><p>update-alarm-setting.sh</p><p>And then we need to give the script execution rights:</p><div class="informalexample"><pre class="programlisting">
<span class="strong"><strong>$ sudo chmod 777 /etc/pi-alarm/update-alarm-setting.sh</strong></span>
</pre></div><p>This is what we should see in our <code class="literal">/etc/pi-alarm</code> folder at this time:</p><div class="informalexample"><pre class="programlisting">pi@raspberrypi ~ $ ls -1 /etc/pi-alarm
alarm.cfg
update-alarm-setting.sh</pre></div><p>Right, after all that, I think <a id="id311" class="indexterm"/>we can now launch the control panel page in our browser at</p><p>
<code class="literal">http://&lt;my-pi-ip&gt;</code>.</p><p>
<code class="literal">index.php</code> is configured as a default page in Lighty's config, so you don't need to add it to the end of the URL; just the IP address will suffice.</p><p>By changing the switch positions and then clicking on the <span class="strong"><strong>Update System</strong></span> button, you should find that the setting values get updated accordingly in <code class="literal">alarm.cfg</code>. You can now see how this file will be the way for the status to be exchanged between our web console and the security system scripts that we'll develop in <a class="link" href="ch09.html" title="Chapter 9. Putting It All Together">Chapter 9</a>, <span class="emphasis"><em>Putting It All Together</em></span>.</p><div class="mediaobject"><img src="graphics/B04579_07_05.jpg" alt="I'm someone else"/><div class="caption"><p>The final operational control panel</p></div></div></div></div></div>
<div class="section" title="Remote access to our control panel"><div class="titlepage"><div><div><h1 class="title"><a id="ch07lvl1sec51"/>Remote access to our control panel</h1></div></div></div><p>While we can set up our system to receive email alerts when our system detects an intrusion, it would be really useful to be able to access our Web-based control panel wherever we are so<a id="id312" class="indexterm"/> that we can perhaps arm and disarm the<a id="id313" class="indexterm"/> system or switch off certain zones when we're not there.</p><p>However, in order to make this possible we need to do a few things:</p><div class="section" title="Setting up a dynamic DNS account"><div class="titlepage"><div><div><h2 class="title"><a id="ch07lvl2sec65"/>Setting up a dynamic DNS account</h2></div></div></div><p>Most of us won't have a<a id="id314" class="indexterm"/> <span class="strong"><strong>fixed IP address</strong></span> for the Internet connection in our home; it is likely to change from time to time, especially when we reboot or unplug our router, whereby our Internet <a id="id315" class="indexterm"/>service provider assigns us a new one when we next connect to them. Because of this, we can't rely on using the IP address to get to our home network when we're out and about. To solve<a id="id316" class="indexterm"/> this, we need to set up a <span class="strong"><strong>dynamic DNS</strong></span> account that will allow us to set up a domain name for our home network (for example, <span class="emphasis"><em>myhomenetwork.com</em></span>).</p><p>It works by having a service that runs inside your network, such as on your router or laptop, that updates the dynamic DNS service hosting your domain name with the current IP address of your Internet connection. Then, when you use your domain name in your browser, it will take you to a Web server on your home network.</p><p>Popular dynamic DNS providers out there include<a id="id317" class="indexterm"/> No-IP (<a class="ulink" href="http://www.noip.com">www.noip.com</a>) and <a id="id318" class="indexterm"/>DynDNS (<a class="ulink" href="http://www.dyn.com">www.dyn.com</a>). You can also get a free DnsOMatic account <a id="id319" class="indexterm"/>with OpenDNS to manage your services (<a class="ulink" href="http://www.dnsomatic.com">www.dnsomatic.com</a>).</p><div class="mediaobject"><img src="graphics/B04579_07_06.jpg" alt="Setting up a dynamic DNS account"/><div class="caption"><p>My Netgear NAS device has a DnsOMatic updater service add-on</p></div></div><div class="mediaobject"><img src="graphics/B04579_07_07.jpg" alt="Setting up a dynamic DNS account"/><div class="caption"><p>My Netgear Router has the option of updating a Dynamic DNS service</p></div></div><div class="section" title="The Raspberry Pi dynamic DNS client"><div class="titlepage"><div><div><h3 class="title"><a id="ch07lvl3sec16"/>The Raspberry Pi dynamic DNS client</h3></div></div></div><p>Since your Raspberry Pi-based<a id="id320" class="indexterm"/> home security system is likely to always be on, you might want to install the <span class="strong"><strong>ddclient </strong></span>updater service<a id="id321" class="indexterm"/> on there instead:</p><div class="informalexample"><pre class="programlisting">
<span class="strong"><strong>$ sudo apt-get install ddclient</strong></span>
</pre></div><p>Once installed, you can set it up for your particular service and account details using the following config file:</p><div class="informalexample"><pre class="programlisting">
<span class="strong"><strong>$ sudo nano /etc/ddclient.conf</strong></span>
</pre></div></div></div><div class="section" title="Setting up a static IP on your Raspberry Pi"><div class="titlepage"><div><div><h2 class="title"><a id="ch07lvl2sec66"/>Setting up a static IP on your Raspberry Pi</h2></div></div></div><p>So that our home network<a id="id322" class="indexterm"/> always knows where to find your Raspberry Pi, we need to set up a <span class="strong"><strong>static IP address</strong></span> on it, assuming that it currently acquires an IP address from your router's DHCP server<a id="id323" class="indexterm"/> each time it boots up.</p><div class="orderedlist"><ol class="orderedlist arabic"><li class="listitem">To do this, we <a id="id324" class="indexterm"/>need to edit the network settings on the Raspberry Pi. In Nano, open the following configuration file:<div class="informalexample"><pre class="programlisting">
<span class="strong"><strong>$ sudo nano /etc/network/interfaces</strong></span>
</pre></div></li><li class="listitem">You'll probably find the Ethernet port configuration set to something like this:<div class="informalexample"><pre class="programlisting">
<span class="strong"><strong>auto eth0</strong></span>
<span class="strong"><strong>allow-hotplug eth0</strong></span>
<span class="strong"><strong>iface eth0 inet manual</strong></span>
</pre></div></li><li class="listitem">Change this configuration to be an unused static IP address on your network. In my case, I've set it to <code class="literal">192.168.0.99</code>. The gateway setting is the IP address of my Internet<a id="id325" class="indexterm"/> router:<div class="informalexample"><pre class="programlisting">auto eth0
allow-hotplug eth0
iface eth0 inet static
        address 192.168.0.99
        netmask 255.255.255.0
        gateway 192.168.0.1</pre></div></li><li class="listitem">Now, we need to<a id="id326" class="indexterm"/> restart the networking service—note that you'll be disconnected from <a id="id327" class="indexterm"/>your terminal session. You'll need to reconnect using the new IP address:<div class="informalexample"><pre class="programlisting">
<span class="strong"><strong>$ sudo /etc/init.d/networking restart</strong></span>
</pre></div></li></ol></div><p>If you have any issues, simply restart the Pi with <code class="literal">sudo reboot</code> and all should be good when it comes back up.</p></div><div class="section" title="Port-forwarding"><div class="titlepage"><div><div><h2 class="title"><a id="ch07lvl2sec67"/>Port-forwarding</h2></div></div></div><p>The final piece of this <a id="id328" class="indexterm"/>puzzle is to make sure that our Internet router will direct incoming traffic on a given port to our Raspberry Pi's Web server. For the purpose of this example, I'm going to assume that we are going to stick to<a id="id329" class="indexterm"/> the default, port 80, on our Web server.</p><div class="note" title="Note" style=""><div class="inner"><h3 class="title"><a id="tip09"/>Tip</h3><p>
<span class="strong"><strong>A word about security</strong></span>
</p><p>Given that our Web <a id="id330" class="indexterm"/>server will now be accessible from the outside world, we need to be mindful about securing our system properly. The two main ways to do this are to change the Web server port to a random number other than 80 (for example, 8799) and add password protection to your site by applying basic authentication. Both of these can be done in the <code class="literal">lighttpd</code> configuration file.</p></div></div><p>Most routers will allow you to set up<a id="id331" class="indexterm"/> <span class="strong"><strong>port-forwarding</strong></span> as part of their <span class="strong"><strong>firewall</strong></span> configuration. Essentially, setting this means that any incoming traffic from the Internet on a given TCP port will be allowed to pass through the router and will be directed to the device with the specified IP address. On my Netgear router, it's set up as shown in the following screenshot:</p><div class="mediaobject"><img src="graphics/B04579_07_08.jpg" alt="Port-forwarding"/><div class="caption"><p>Setting up port-forwarding on a Netgear router</p></div></div><p>Now, when you enter your personal domain name in your browser, when you're away from home you<a id="id332" class="indexterm"/> should be taken to your<a id="id333" class="indexterm"/> alarm control panel.</p><div class="note" title="Note" style=""><div class="inner"><h3 class="title"><a id="tip10"/>Tip</h3><p>You might also want to consider opening up port 22 so that you can access the Raspberry Pi directly using PuTTy and SSH from outside your network.</p></div></div></div></div>
<div class="section" title="Summary"><div class="titlepage"><div><div><h1 class="title"><a id="ch07lvl1sec52"/>Summary</h1></div></div></div><p>We've now started building the software that will control our home security system by determining the format of the main configuration file. We've also installed a Web server and built a basic single-page control panel with PHP, HTML5, and CSS3, which can be accessed nicely on our mobile phone, allowing us to configure our system and view the status.</p><p>In addition, we've learned how to configure our home network and Raspberry Pi so that we can access our control panel when we're away from home.</p><p>In <a class="link" href="ch09.html" title="Chapter 9. Putting It All Together">Chapter 9</a>, <span class="emphasis"><em>Putting It All Together</em></span>, we'll put all of the electronic elements together and write the main scripts that will run the home security system. But before that, in the next chapter, we're going to look at a few other bits and pieces, such as adding other sensors, not necessarily related to intruder detection, to our home security system. We'll also look at how we can administer our entire Raspberry Pi system remotely using a Web browser, in addition to accessing our home security control panel.</p></div></body></html>