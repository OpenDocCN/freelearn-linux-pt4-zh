<html><head></head><body><div class="chapter" title="Chapter&#xA0;4.&#xA0;Security with Ubuntu"><div class="titlepage"><div><div><h1 class="title"><a id="ch04"/>Chapter 4. Security with Ubuntu</h1></div></div></div><p>In the field of computer servers, security is a very hot key. That's why, Ubuntu Server gives it a lot of importance. In this chapter, we will take a look at how to activate, configure, and enhance a lot of security aspects. This chapter will be divided into the following three parts:</p><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc">Getting a basic security level for Ubuntu Server</li><li class="listitem" style="list-style-type: disc">Going in depth to see how to configure advanced security settings</li><li class="listitem" style="list-style-type: disc">Performing a backup/restore procedure for the whole Ubuntu Server</li></ul></div><div class="section" title="The basic security settings"><div class="titlepage"><div><div><h1 class="title"><a id="ch04lvl1sec28"/>The basic security settings</h1></div></div></div><p>First of all, let's <a class="indexterm" id="id211"/>have a look at how to set up a basic security level for Ubuntu Server. There is a saying in security circles that <span class="emphasis"><em>security is a process, not a product</em></span>. What this means is that despite what your vendor might tell you, you can't solve all your security problems with some application or software. Instead, you will find real security when you start to follow good security principles and develop good security procedures. This is what we will mainly see in this section.</p><div class="section" title="Managing users"><div class="titlepage"><div><div><h2 class="title"><a id="ch04lvl2sec44"/>Managing users</h2></div></div></div><p>In this<a class="indexterm" id="id212"/> subsection, you will discover best practices in terms of <a class="indexterm" id="id213"/>user management, which covers not only user creation, modification, and deletion, but also group attribution, permissions, and a lot of other details.</p><div class="section" title="User account administration"><div class="titlepage"><div><div><h3 class="title"><a id="ch04lvl3sec12"/>User account administration</h3></div></div></div><p>The <a class="indexterm" id="id214"/>following are the most useful commands <a class="indexterm" id="id215"/>that are required to set up and manage user accounts:</p><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc"><code class="literal">useradd</code>: This<a class="indexterm" id="id216"/> command adds the user that was passed in as a parameter to the local authentication system</li><li class="listitem" style="list-style-type: disc"><code class="literal">usermod</code>: This <a class="indexterm" id="id217"/>command modifies the properties of the user passed in as a parameter</li><li class="listitem" style="list-style-type: disc"><code class="literal">userdel</code>: This<a class="indexterm" id="id218"/> command properly deletes from a system the user passed in as a parameter</li><li class="listitem" style="list-style-type: disc"><code class="literal">passwd</code>: This <a class="indexterm" id="id219"/>command modifies the passwords for a user passed in as a parameter</li></ul></div><p>We can add some options to those commands, those options are listed and detailed using -for example for the case of <code class="literal">useradd-</code> either <code class="literal">man useradd</code> or <code class="literal">useradd --help</code>.</p><div class="note" style="" title="Note"><div class="inner"><h3 class="title"><a id="tip10"/>Tip</h3><p>There exists the <code class="literal">adduser</code> command that also allows you to create new users. The difference between <code class="literal">useradd</code> and <code class="literal">adduser</code> depends on the Linux distribution. For example, for Fedora/Centos/Gentoo, <code class="literal">adduser</code> is just a symbolic link to <code class="literal">useradd</code>. But in our case, on Debian or Ubuntu systems, <code class="literal">useradd</code> is the command itself, and you can create users and define options for these users by using it. On the other hand, <code class="literal">adduser</code> is a Perl script that uses <code class="literal">useradd</code> to create an account and asks you for a password, your full name, phone number, and other information. We can say that in this case, it simplifies things for you.</p></div></div><p>The following are the most important options that you need to take into account when creating a new user, especially for security reasons:</p><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc"><code class="literal">-m</code>: Use this <a class="indexterm" id="id220"/>option during the creation of a home directory for the user that needs to be created. Without it, you'd have to create a new directory, change its ownership and permissions that fit the needs of the user, put within it the default files and directories that should exist under a home directory, and then assign the default directories and files to the home directory by using the <code class="literal">usermod</code> command with the <code class="literal">-d</code> option.</li><li class="listitem" style="list-style-type: disc"><code class="literal">-e date</code>: This is <a class="indexterm" id="id221"/>used to set an expiration date for the user. After this date, the system will automatically disable the user's account. Use this in case you need to create temporary users for your server. So, even if you forget to delete them, the system will at least lock their accounts.</li><li class="listitem" style="list-style-type: disc"><code class="literal">-G groups</code>: This <a class="indexterm" id="id222"/>sets the group membership of users. It is good security practice to classify server users by groups and set specific parameters and permissions for each group.</li></ul></div><div class="note" style="" title="Note"><div class="inner"><h3 class="title"><a id="tip11"/>Tip</h3><p>Every user has a unique ID, which is the UID variable. In Ubuntu, this variable starts from <span class="emphasis"><em>1,000</em></span> for regular users, and values under <span class="emphasis"><em>500</em></span> are reserved for system accounts with a specification value; the UID variable <span class="emphasis"><em>0</em></span> is reserved for root users. Normally, this UID is unique, but there is only one case where you may want to give the same UID to more than one user—when you want to create a backup root user. To do this, you need to use either the <code class="literal">-o</code> option, or the <code class="literal">-u 0</code> option with the <code class="literal">useradd</code> command when creating a user.</p></div></div></div><div class="section" title="Password administration"><div class="titlepage"><div><div><h3 class="title"><a id="ch04lvl3sec13"/>Password administration</h3></div></div></div><p>Passwords are<a class="indexterm" id="id223"/> one of the security keys for an <a class="indexterm" id="id224"/>
<span class="strong"><strong>operating system</strong></span> (<span class="strong"><strong>OS</strong></span>). In Ubuntu Server, passwords are managed by using the <code class="literal">passwd</code> command. A simple user can use it to change their password, and an administrator can use it to change the password of another regular user. Not only that, the <code class="literal">passwd</code> command has other important features, such as the following ones, which are useful in the maintenance of system security:</p><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc">By using the <code class="literal">-l</code> option, an administrator can lock a user account temporarily. It can be unlocked later by using the <code class="literal">-u</code> option.</li><li class="listitem" style="list-style-type: disc">The status of the password for a given user account can be reported by using the <code class="literal">-S</code> option.</li><li class="listitem" style="list-style-type: disc">Users can be forced to change their password during the next login by using the <code class="literal">-e</code> option.</li><li class="listitem" style="list-style-type: disc">Setting a minimum number of days to use a password before the possibility of changing it again is done via the <code class="literal">-n min_days_number</code> option. This is useful when you wish to prevent users from changing their password after expiration and then changing it back to the old one immediately.</li><li class="listitem" style="list-style-type: disc">You can set a maximum period of days to use a password. After completing this period, users are obliged to change their password. This is done by using the <code class="literal">-x max_days_number</code> option.</li><li class="listitem" style="list-style-type: disc">You can notify a user about the expiration of their password; the period in days is specified in the argument of the <code class="literal">-c notif</code> option.</li><li class="listitem" style="list-style-type: disc">You can also set an automatic expiration of a user account in case there is no activity for a given period. This period is set in days and passed as an argument of the <code class="literal">-i exper</code> option.</li></ul></div><p>Some additional security features that are specifically related to password management and user login in general can be located and modified in the <code class="literal">/etc/login.defs</code> file. The following are the most important of these parameters:</p><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc"><code class="literal">FAIL_DELAY</code>: This sets the amount of time (in seconds) that is taken by a system after a failed login before a user is prompted again to re-enter their password. By default, it is <span class="emphasis"><em>3</em></span> seconds. By setting a suitable value here, we can block a <a class="indexterm" id="id225"/><span class="strong"><strong>brute force attack</strong></span>.</li><li class="listitem" style="list-style-type: disc"><code class="literal">LASTLOG_ENAB</code>: This is a Boolean value. When it is set to <span class="emphasis"><em>1</em></span>, it means that this feature is enabled. By enabling this feature, the system will log all the successful logins in the <code class="literal">/var/log/lastlog</code> file. The <code class="literal">lastlog</code> file should exist to have this feature working. In case it doesn't, you can create it by using the touch <code class="literal">/var/log/lastlog</code> command.</li><li class="listitem" style="list-style-type: disc"><code class="literal">PASS_MIN_LEN</code>: This parameter contains the minimum number of characters that must be used for new passwords.</li></ul></div></div><div class="section" title="Permission settings"><div class="titlepage"><div><div><h3 class="title"><a id="ch04lvl3sec14"/>Permission settings</h3></div></div></div><p>Permissions <a class="indexterm" id="id226"/>are the second security barrier after the <a class="indexterm" id="id227"/>login process in an OS. Ubuntu, like other Linux servers, has a strong and well-made permission structure. In this section, we will cover two main concepts—file ownership and operation permissions (read/write/execute).</p><div class="section" title="File ownership"><div class="titlepage"><div><div><h4 class="title"><a id="ch04lvl4sec01"/>File ownership</h4></div></div></div><p>Each file <a class="indexterm" id="id228"/>on Ubuntu Server has its owner (user) and group owner (the user's primary group in general). In some cases, an administrator needs to change a file ownership for some reason (general security reasons). To do this, we have to call either the <code class="literal">chown</code> or <code class="literal">chgrp</code> command.</p><p>For <code class="literal">chown</code>, the command has the following pattern:</p><div class="informalexample"><pre class="programlisting">
<span class="strong"><strong>chown [OWNER][:[GROUP]] file</strong></span>
</pre></div><p>Here are a couple of examples of this command:</p><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc"><code class="literal">chown one_user some_file</code>: This command changes the owner of <code class="literal">some_file</code> to <code class="literal">one_user</code>.</li><li class="listitem" style="list-style-type: disc"><code class="literal">chown one_user:one_group some_file</code>: This command not only does what the preceding command did, but also changes its group to <code class="literal">one_group</code>.</li></ul></div><p>We can also use <code class="literal">chown</code> to change only the group ownership. An example of this is <code class="literal">chown .one_group some_file</code>. Don't forget the (.) character just before the group name, which is <code class="literal">one_group</code> in this case. Note that we recently started using the colon character (<code class="literal">:</code>); both <code class="literal">.</code> and <code class="literal">:</code> are doing the job.</p><p>For group ownership, there is another alternative, namely the <code class="literal">chgrp</code> command. An example of its usage is <code class="literal">chgrp one_group some_file</code>. Note that we don't need the <code class="literal">.</code> character before the group name, which is <code class="literal">one_group</code> in this case.</p><div class="note" style="" title="Note"><div class="inner"><h3 class="title"><a id="note27"/>Note</h3><p>By default, the scope of the <code class="literal">chown</code> and <code class="literal">chgrp</code> commands applies only to the file or directory on which they are used. If you want to use these commands in a recursive way, you just have to add the <code class="literal">-R</code> option. For example, <code class="literal">chown -R one_user some_dir</code> makes the <code class="literal">one_user</code> user the owner of all the files in <code class="literal">some_dir</code> and all of its subdirectories.</p></div></div></div><div class="section" title="Configuring permissions"><div class="titlepage"><div><div><h4 class="title"><a id="ch04lvl4sec02"/>Configuring permissions</h4></div></div></div><p>Operation permissions<a class="indexterm" id="id229"/> are of three types, namely <span class="strong"><strong>read</strong></span> (the <span class="strong"><strong>r</strong></span> symbol or a value of <span class="strong"><strong>4</strong></span>), <span class="strong"><strong>write</strong></span> (the <span class="strong"><strong>w</strong></span> symbol or a value of <span class="strong"><strong>2</strong></span>), and <span class="strong"><strong>execute</strong></span> (the <span class="strong"><strong>x</strong></span> symbol or a value of <span class="strong"><strong>1</strong></span>). Each one of these three types can be applied on a file or directory for the <span class="strong"><strong>owner user</strong></span> (<span class="strong"><strong>u</strong></span>), its <span class="strong"><strong>primary user group</strong></span> (<span class="strong"><strong>g</strong></span>) members, and <span class="strong"><strong>other users</strong></span> (<span class="strong"><strong>o</strong></span>). We can apply permissions on <span class="strong"><strong>all users</strong></span> (<span class="strong"><strong>a</strong></span>). To set these permissions, you can use the following two ways:</p><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc"><span class="strong"><strong>Specific use</strong></span>: This is used to configure specific permissions for a specific file. This is done by using the <code class="literal">chmod</code> command.</li><li class="listitem" style="list-style-type: disc"><span class="strong"><strong>General use</strong></span>: This is used to configure default permissions attribution for new created files. This is done by using the <code class="literal">umask</code> command.</li></ul></div><div class="note" style="" title="Note"><div class="inner"><h3 class="title"><a id="tip12"/>Tip</h3><p>There are some additional specific permissions called <span class="strong"><strong>special permissions</strong></span>, namely <span class="strong"><strong>SUID</strong></span>, SGID, and Sticky bit. This is beyond the scope of this book. You can explore them in an advanced Linux administration guide.</p></div></div><p>For the <code class="literal">chmod</code> tool, you can use the following two modes:</p><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc">The relative mode: This can be used in the same way as we use the absolute mode, which is detailed in the next section, to set huge changes at a time in terms of permissions, but it is even more useful when you need to add or remove just one permission at a time in an easy and convenient manner. When using <code class="literal">chmod</code> in this mode, you need to specify the entity (u, g, o, a) to which we will grant permissions, which is followed by the granting symbol (<code class="literal">+</code> for adding, <code class="literal">-</code> for removing, and <code class="literal">=</code> for setting the permissions) and the permissions that you wish to apply (r, w, x). For example, the <code class="literal">chmod g+w some_file</code> command will add write permissions on the <code class="literal">some_file</code> file to the entity group. Let's take a look at another example where we set more than one permission at the same time by using the <code class="literal">chmod u+rwx,g+rx-w,o+r-wx another_file</code> mode, where we added all the rights to a user, added <code class="literal">read</code> and <code class="literal">execute</code> to the group and removed <code class="literal">write</code> from it, and added only <code class="literal">read</code> to others and removed <code class="literal">write</code> and <code class="literal">execute</code>.</li><li class="listitem" style="list-style-type: disc">The absolute mode: This mode offers a short and convenient way to set permissions, especially when you need to change more than one permission at a time. In this mode, we use numeric values to define permissions. The permission value is composed of four digits. The first one refers to the special permissions (not covered in this book, as explained in a previous note). This digit can be omitted, unless you want to use it (be careful because it is dangerous). The other values refer in the order from left to right to the permissions related to a user, group, and others. Values are counted for each entity by adding values related to each permission (r=4, w=2, x=1). For example, the equivalent of <code class="literal">chmod u+rwx,g+rx-w,o+r-wx another_file</code> should be <code class="literal">chmod 754 another_file</code>.</li></ul></div><p>For<a class="indexterm" id="id230"/> the <code class="literal">umask</code> tool, it is the <span class="strong"><strong>user file creation mode mask</strong></span>. It determines the default permissions that are set when creating a new file. The <code class="literal">umask</code> parameter is expressed in a numeric value, and this value is subtracted from the maximum permissions that can be set automatically; which is <span class="emphasis"><em>666</em></span> for files and <span class="emphasis"><em>777</em></span> for directories. The order of digits used in <code class="literal">umask</code> is the same as that for <code class="literal">chmod</code>; the first one from the left is for a user, the second digit is for a group, and the third digit is for others. By default, <code class="literal">umask</code> is set to <span class="emphasis"><em>022</em></span>, which gives <span class="emphasis"><em>644</em></span> permissions to all the newly created files and the <span class="emphasis"><em>755</em></span> permissions to all the newly created directories.</p><p>The <code class="literal">umask</code> setting can be changed either for all users or for individual ones. If you want to set the <code class="literal">umask</code> value for all users, you must make sure that the <code class="literal">umask</code> setting is entered in the <code class="literal">/etc/login.defs</code> configuration file (before, it was entered in the <code class="literal">/etc/profile</code> file, but now it is changed to <code class="literal">/etc/login.defs</code>). On the other hand, if you would like to apply specific <code class="literal">umask</code> settings to only a specific user, you have to edit the profile file that exists under this user's home directory and set the desired <code class="literal">umask</code> value there.</p></div></div></div><div class="section" title="Applying quota to user accounts"><div class="titlepage"><div><div><h2 class="title"><a id="ch04lvl2sec45"/>Applying quota to user accounts</h2></div></div></div><p>User quota<a class="indexterm" id="id231"/> is <a class="indexterm" id="id232"/>another security barrier for servers. They allow administrators to apply a quota<a class="indexterm" id="id233"/> restriction to the file and directory creation for users and groups.</p><p>To use this feature, you need to perform the following steps:</p><div class="orderedlist"><ol class="orderedlist arabic"><li class="listitem">First of all, install the <code class="literal">quota</code> software. This is done by using the <code class="literal">sudo apt-get install quota</code> command.</li><li class="listitem">Secondly, prepare the filesystem to support quota. To do this, you need to add the <code class="literal">usrquota</code> option (if you want to apply quota to users) or the <code class="literal">grpquota</code> option (for groups) in the options column in the <code class="literal">/etc/fstab</code> file for every filesystem in which you want to use quota. Then, remount all the partitions in which quota has been applied by using the following command:<div class="informalexample"><pre class="programlisting">
<span class="strong"><strong>sudo mount -o remount &lt;partition_name&gt;</strong></span>
</pre></div></li><li class="listitem">Next, initialize the quota software. The best way to initialize the quota system is by running the <code class="literal">sudo quotacheck -augmv</code> command, which will create the <code class="literal">aquota.user</code> and <code class="literal">aquota.group</code> files to list all the quota information for actual users.</li><li class="listitem">Finally, the <a class="indexterm" id="id234"/>real work involves setting up quota for users and groups. This is done via the <code class="literal">edquota</code> command. For example, the <code class="literal">sudo edquota -u &lt;username&gt;</code> command will open a temporary file for quota for that user in a text editor. This file contains six numbers that specify the quota for all the filesystems on your server. The first one represents the block's number, which is currently being used by the user that you're setting the quota for. The second number is the soft limit for the block's number, while the third number is the hard limit. The fifth and sixth numbers are the equivalents for inodes, which are almost equal to the number of files that this user can create on the filesystem. The first and fourth numbers are just used to record the number of blocks and inodes that are currently being used for this user.</li><li class="listitem">After <a class="indexterm" id="id235"/>setting up the quota, you need to use the <code class="literal">sudo edquota -t</code> command to set the grace time that you want to use either in hours, or in days. The grace time is set per filesystem. Therefore, there's no option to specify different grace time settings for different users.</li></ol></div><div class="note" style="" title="Note"><div class="inner"><h3 class="title"><a id="tip13"/>Tip</h3><p>The initialization step is mandatory in the setting up of quota for a new user; it makes sure that new users are known to the quota system.</p></div></div><p>After setting up quota, it is useful to monitor it. To do that, you can use the <code class="literal">repquota</code> command. With the <code class="literal">-aug</code> options, this command shows the current quota settings for all the users and groups on all the volumes.</p><p>Finally, after setting up quotas, don't forget to start the quota service by running the <code class="literal">/etc/init.d/quota start</code> command.</p><p>Once you have set quotas for one user, you may want to apply them to other users. Instead of following the same procedure for all the users on the system, you can use the <code class="literal">edquota -p</code> command. For example, <code class="literal">sudo edquota -p user1 user2</code> copies the quotas currently applied for <code class="literal">user1 user</code> to <code class="literal">user user2</code>.</p><div class="note" style="" title="Note"><div class="inner"><h3 class="title"><a id="tip14"/>Tip</h3><p>The <code class="literal">edquota</code> command works only with blocks and not bytes, kilobytes, or anything else. So, to set quota properly, you need to know the block size that's currently being used. To find this block size, use the <code class="literal">sudo dumpe2fs &lt;device&gt; | grep "Block size"</code> command.</p></div></div></div></div></div>
<div class="section" title="Configuring administration tasks with sudo"><div class="titlepage"><div><div><h1 class="title"><a id="ch04lvl1sec29"/>Configuring administration tasks with sudo</h1></div></div></div><p>Ubuntu implements <a class="indexterm" id="id236"/>a number of practices out of the box to make the default installation more secure. One of these practices is the disabling of the root account and the use of <code class="literal">sudo</code> for superuser privileges. The <code class="literal">sudo</code> program provides a much more robust set of features to increase user privileges as compared to the traditional su program.</p><p>The <code class="literal">sudo</code> command's configuration file can be found at <code class="literal">/etc/sudoers</code>. By default, Ubuntu provides a basic file that allows root users to do anything as any other user, and allows members of the admin group to become root users (the user that you create at the time of installation is automatically added to this group). </p><p>The <code class="literal">sudo</code> package provides a tool called <code class="literal">visudo</code> that you should use whenever you want to make changes to the file. Therefore, to view and edit the <code class="literal">/etc/sudoers</code> file, type in the following command:</p><div class="informalexample"><pre class="programlisting">
<span class="strong"><strong>sudo visudo</strong></span>
</pre></div><p>The reason you want to use <code class="literal">visudo</code> is that it automatically checks your <code class="literal">sudoers</code> file for mistakes. Since a mistake in the <code class="literal">sudoers</code> file could potentially lock you out of root access, this syntax check is pretty important. In case you do make a mistake, <code class="literal">visudo</code> will tell you about it after you save your settings and exit the page. So, you will have the option of going back and fixing your mistake, exiting without saving, or ignoring its warnings and saving anyway (which is not recommended).</p><div class="note" style="" title="Note"><div class="inner"><h3 class="title"><a id="note28"/>Note</h3><p>To edit the file and manage the <code class="literal">sudo</code> program in the best possible way, the easiest thing to do is to read and follow the examples in the manual pages. You can access it via the man <code class="literal">sudoers</code> command.</p></div></div><div class="section" title="Configuring the AppArmor tool"><div class="titlepage"><div><div><h2 class="title"><a id="ch04lvl2sec46"/>Configuring the AppArmor tool</h2></div></div></div><p>The <a class="indexterm" id="id237"/>AppArmor system that is installed by default in Ubuntu Server adds access control to specific system services with an aim to enhance the server security level. AppArmor is based on the security principle of least privileges. For every program, it assigns a series of rules that define a set of files and directories that this program is allowed to handle and explains how to handle them (<code class="literal">read only</code> or <code class="literal">read write</code>). When an application that is being managed by AppArmor violates these access controls, AppArmor intervenes, prevents it from doing so, and logs the event. There is a huge number of services that include AppArmor profiles by default, and more are being added in every Ubuntu release. In addition to the default profiles, the universe repository has an <code class="literal">apparmor-profiles</code> package that you can install to add more profiles for other services. Once you learn the syntax for the AppArmor rules, you can even add your own profiles.</p><p>The best way to see how AppArmor works is by using an example program. The MySQL database server is one program that is automatically managed by AppArmor under Ubuntu. So, once<a class="indexterm" id="id238"/> the MySQL package is installed, you can use the <code class="literal">aa-status</code> program to see that AppArmor is already managing it, as follows:</p><div class="informalexample"><pre class="programlisting">
<span class="strong"><strong>sudo aa-status</strong></span>
<span class="strong"><strong>apparmor module is loaded.</strong></span>
<span class="strong"><strong>7 profiles are loaded.</strong></span>
<span class="strong"><strong>7 profiles are in enforce mode.</strong></span>
<span class="strong"><strong>  /sbin/dhclient</strong></span>
<span class="strong"><strong>  /usr/lib/NetworkManager/nm-dhcp-client.action</strong></span>
<span class="strong"><strong>  /usr/lib/NetworkManager/nm-dhcp-helper</strong></span>
<span class="strong"><strong>  /usr/lib/connman/scripts/dhclient-script</strong></span>
<span class="strong"><strong>  /usr/sbin/mysqld</strong></span>
<span class="strong"><strong>  /usr/sbin/named</strong></span>
<span class="strong"><strong>  /usr/sbin/tcpdump</strong></span>
<span class="strong"><strong>0 profiles are in complain mode.</strong></span>
<span class="strong"><strong>3 processes have profiles defined.</strong></span>
<span class="strong"><strong>3 processes are in enforce mode.</strong></span>
<span class="strong"><strong>  /sbin/dhclient (945)</strong></span>
<span class="strong"><strong>  /usr/sbin/mysqld (6288)</strong></span>
<span class="strong"><strong>  /usr/sbin/named (13679)</strong></span>
<span class="strong"><strong>0 processes are in complain mode.</strong></span>
<span class="strong"><strong>0 processes are unconfined but have a profile defined.</strong></span>
</pre></div><p>Here you can see that the <code class="literal">/usr/sbin/mysqld profile</code> is loaded and is in the enforce mode and that the currently running <code class="literal">/usr/sbin/ mysqld process</code> (PID <span class="emphasis"><em>6288</em></span>) is being managed by AppArmor.</p><p>AppArmor stores its profiles under the <code class="literal">/etc/apparmor.d/ directory</code>, and each filename is derived from the binary file that they manage. For instance, the profile for <code class="literal">/usr/sbin/mysqld</code> is located at <code class="literal">/etc/apparmor.d/usr.sbin.mysqld</code>. If you look at the contents of the file, you will get an idea of how the AppArmor profiles work and what sort of protection they provide:</p><div class="informalexample"><pre class="programlisting">
<span class="strong"><strong>cat /etc/apparmor.d/usr.sbin.mysqld</strong></span>
<span class="strong"><strong># vim:syntax=apparmor</strong></span>
<span class="strong"><strong># Last Modified: Tue Jun 19 17:37:30 2007</strong></span>
<span class="strong"><strong>#include &lt;tunables/global&gt;</strong></span>

<span class="strong"><strong>/usr/sbin/mysqld {</strong></span>
<span class="strong"><strong>  #include &lt;abstractions/base&gt;</strong></span>
<span class="strong"><strong>  #include &lt;abstractions/nameservice&gt;</strong></span>
<span class="strong"><strong>  #include &lt;abstractions/user-tmp&gt;</strong></span>
<span class="strong"><strong>  #include &lt;abstractions/mysql&gt;</strong></span>
<span class="strong"><strong>  #include &lt;abstractions/winbind&gt;</strong></span>

<span class="strong"><strong>  capability dac_override,</strong></span>
<span class="strong"><strong>  capability sys_resource,</strong></span>
<span class="strong"><strong>  capability setgid,</strong></span>
<span class="strong"><strong>  capability setuid,</strong></span>

<span class="strong"><strong>  network tcp,</strong></span>

<span class="strong"><strong>  /etc/hosts.allow r,</strong></span>
<span class="strong"><strong>  /etc/hosts.deny r,</strong></span>

<span class="strong"><strong>  /etc/mysql/** r,</strong></span>
<span class="strong"><strong>  /usr/lib/mysql/plugin/ r,</strong></span>
<span class="strong"><strong>  /usr/lib/mysql/plugin/*.so* mr,</strong></span>
<span class="strong"><strong>  /usr/sbin/mysqld mr,</strong></span>
<span class="strong"><strong>  /usr/share/mysql/** r,</strong></span>
<span class="strong"><strong>  /var/log/mysql.log rw,</strong></span>
<span class="strong"><strong>  /var/log/mysql.err rw,</strong></span>
<span class="strong"><strong>  /var/lib/mysql/ r,</strong></span>
<span class="strong"><strong>  /var/lib/mysql/** rwk,</strong></span>
<span class="strong"><strong>  /var/log/mysql/ r,</strong></span>
<span class="strong"><strong>  /var/log/mysql/* rw,</strong></span>
<span class="strong"><strong>  /var/run/mysqld/mysqld.pid rw,</strong></span>
<span class="strong"><strong>  /var/run/mysqld/mysqld.sock w,</strong></span>
<span class="strong"><strong>  /run/mysqld/mysqld.pid rw,</strong></span>
<span class="strong"><strong>  /run/mysqld/mysqld.sock w,</strong></span>

<span class="strong"><strong>  /sys/devices/system/cpu/ r,</strong></span>

<span class="strong"><strong>  # Site-specific additions and overrides. See local/README for details.</strong></span>
<span class="strong"><strong>  #include &lt;local/usr.sbin.mysqld&gt;</strong></span>
<span class="strong"><strong>}</strong></span>
</pre></div><p>The syntax is <a class="indexterm" id="id239"/>pretty straightforward for these files. First, there is a file or a directory path, which is followed by the permissions that are allowed. Globs are also allowed. So for instance, <code class="literal">/etc/mysql/**</code> recursively applies the files to all the files in the <code class="literal">/etc/mysql</code> directory. A single <code class="literal">*</code> will apply files only to files within the current directory.</p><p>After modifying an AppArmor profile, you should reload the AppArmor daemon so that the changes take effect. You can do this by using the following command:</p><div class="informalexample"><pre class="programlisting">
<span class="strong"><strong>sudo /etc/init.d/apparmor reload</strong></span>
</pre></div><p>In AppArmor, there <a class="indexterm" id="id240"/>are two modes, namely <a class="indexterm" id="id241"/>
<span class="strong"><strong>enforce</strong></span> and <a class="indexterm" id="id242"/>
<span class="strong"><strong>complain</strong></span>. In the <span class="strong"><strong>enforce</strong></span> mode, AppArmor actively blocks all the attempts by a program to violate its profile. In the <span class="strong"><strong>complain</strong></span> mode, AppArmor simply logs the attempt but allows it to happen. You can easily change a profile so that it is in the enforce or complain mode by using the <code class="literal">aa-enforce</code> and <code class="literal">aa-complain</code> programs respectively.</p><p>For example, in case you would like to change the MySQL AppArmor profile from the enforce to complain mode, this profile can perform read and write without restrictions in the profile file, but just those actions will be logged. All that we need to do is run the following command:</p><div class="informalexample"><pre class="programlisting">
<span class="strong"><strong>sudo aa-complain /usr/sbin/mysqld</strong></span>
<span class="strong"><strong>Setting /usr/sbin/mysqld to complain mode.</strong></span>
</pre></div><p>We can check the AppArmor status after this change, as follows:</p><div class="informalexample"><pre class="programlisting">
<span class="strong"><strong>sudo aa-status</strong></span>
<span class="strong"><strong>apparmor module is loaded.</strong></span>
<span class="strong"><strong>7 profiles are loaded.</strong></span>
<span class="strong"><strong>6 profiles are in enforce mode.</strong></span>
<span class="strong"><strong>   /sbin/dhclient</strong></span>
<span class="strong"><strong>   /usr/lib/NetworkManager/nm-dhcp-client.action</strong></span>
<span class="strong"><strong>   /usr/lib/NetworkManager/nm-dhcp-helper</strong></span>
<span class="strong"><strong>   /usr/lib/connman/scripts/dhclient-script</strong></span>
<span class="strong"><strong>   /usr/sbin/named</strong></span>
<span class="strong"><strong>   /usr/sbin/tcpdump</strong></span>
<span class="strong"><strong>1 profiles are in complain mode.</strong></span>
<span class="strong"><strong>   /usr/sbin/mysqld</strong></span>
<span class="strong"><strong>3 processes have profiles defined.</strong></span>
<span class="strong"><strong>2 processes are in enforce mode.</strong></span>
<span class="strong"><strong>   /sbin/dhclient (945)</strong></span>
<span class="strong"><strong>   /usr/sbin/named (13679)</strong></span>
<span class="strong"><strong>1 processes are in complain mode.</strong></span>
<span class="strong"><strong>   /usr/sbin/mysqld (6288)</strong></span>
<span class="strong"><strong>0 processes are unconfined but have a profile defined.</strong></span>
</pre></div><div class="note" style="" title="Note"><div class="inner"><h3 class="title"><a id="note29"/>Note</h3><p>To be able to use the <code class="literal">aa-complain</code> and <code class="literal">aa-enforce</code> programs, you should first of all install the <code class="literal">apparmor-utils</code> package by using the following command:</p><div class="informalexample"><pre class="programlisting">
<span class="strong"><strong>sudo apt-get install apparmor-utils</strong></span>
</pre></div></div></div><p>If you want to temporary disable AppArmor (for instance, for some debugging purposes, in case some processes are not working as expected and you are trying to check whether the <code class="literal">apparmor</code> profiles are the reason behind it or if it's something else), you just have to run the following command:</p><div class="informalexample"><pre class="programlisting">
<span class="strong"><strong>sudo /etc/init.d/apparmor stop</strong></span>
<span class="strong"><strong>[ ok ] Stopping apparmor (via systemctl): apparmor.service.</strong></span>
</pre></div><p>Note that running <a class="indexterm" id="id243"/>the preceding command will only clear the profile's cache. In case you need to unload the profile, you need to run the following command:</p><div class="informalexample"><pre class="programlisting">
<span class="strong"><strong>sudo /etc/init.d/apparmor teardown</strong></span>
<span class="strong"><strong> * Unloading AppArmor profiles [ OK ]</strong></span>
</pre></div></div></div>
<div class="section" title="Advanced security configuration"><div class="titlepage"><div><div><h1 class="title"><a id="ch04lvl1sec30"/>Advanced security configuration</h1></div></div></div><p>In this section, we<a class="indexterm" id="id244"/> will discover some advanced security settings that are needed for most Ubuntu servers that are in a production environment, especially when they contain critical services. This advanced configuration is important because it will directly touch the behavior of services besides Ubuntu Server itself.</p><div class="section" title="SSH security enhancement"><div class="titlepage"><div><div><h2 class="title"><a id="ch04lvl2sec47"/>SSH security enhancement</h2></div></div></div><p>By <a class="indexterm" id="id245"/>definition, SSH is a secure communication protocol, but there are some additional enhancements that we can apply to take this security a step ahead.</p><p>Let's start with the default Ubuntu SSH configuration. The <code class="literal">/etc/ssh/sshd_config</code> file, which is very secure as it allows authentication keys to be used, uses privilege separation and allows only SSH protocol 2. The only questionable setting is <span class="strong"><strong>PermitRootLogin</strong></span> <code class="literal">yes</code>, which defines the option that allows root users to log in via SSH. In our case (Ubuntu Server with the default installation), this setting is useless since the root account is disabled, but in case you would like to enable the root account, you might want to set this option to no and run <code class="literal">sudo service ssh reload</code> to save the settings. By following these steps, you force users to log in with their regular accounts and they can perform <code class="literal">sudo up</code> command to root in case they need root privileges. This also allows you to prevent a user from being able to guess the root password and gain access.</p><p>Another important security enhancement with SSH is the use of key-based authentication instead of passwords. This feature allows you to keep your server safe from brute force attacks. The working of key-based authentication is really simple. It is based on a couple of keys (one public and one private) generated by users. Then, the public key is placed in a special file on the remote server, and the private one must be kept with the user and mustn't be shared with others. When a user logs in, these keys are used to authenticate the user instead of a password. With this approach, and, users can also work more comfortably since they are able to log in to their machines without typing in the password every time. However, in case you want an extra layer of security, you can set a passphrase on your keys as well.</p><p>It is relatively <a class="indexterm" id="id246"/>simple to set up key-based authentication. In this example, we have a user named <code class="literal">abdel</code> on a computer named <span class="strong"><strong>abdelmonam2</strong></span> who wants to set up key authentication on a server named <code class="literal">abdelmonam1</code>. The first step is to use the <code class="literal">ssh-keygen</code> program to create an RSA public and private key on <code class="literal">abdelmonam2</code>. At each prompt, you can press the <span class="emphasis"><em>Enter</em></span> key to accept the defaults, as shown in the following screenshot:</p><div class="mediaobject"><img alt="SSH security enhancement" src="graphics/B04800_04_01.jpg"/></div><p>The script creates the keys in the <code class="literal">.ssh</code> directory under your home directory, which is <code class="literal">/home/abdel/.ssh</code> in this case. The private key and the public key are named <code class="literal">id_rsa</code> and <code class="literal">id_rsa.pub</code> respectively. It's very important (especially if you chose an empty passphrase) to keep the private key (<code class="literal">id_rsa</code>) safe! If anyone else gets access to this file, they can copy it and will be able to log in to a machine that you have set up with this key.</p><p>Once you have created the keys, the next step is to copy the <code class="literal">id_rsa.pub</code> key to the server and then append it to the <code class="literal">~/.ssh/authorized_keys</code> file. There are a number of ways to do this. The automatic one involves using the following command:</p><div class="informalexample"><pre class="programlisting">
<span class="strong"><strong>ssh-copy-id -i ~/.ssh/id_rsa.pub &lt;username&gt;@&lt;ipaddress&gt;</strong></span>
</pre></div><p>One of the manual ways is to SSH into the remote machine, open <code class="literal">~/.ssh/authorized_keys</code> with a text editor, and paste in the contents of <code class="literal">id_rsa.pub</code>.</p><p>Once you <a class="indexterm" id="id247"/>have the keys set up on a machine, you should be able to log in without a password prompt unless you set a passphrase for your key. If the latter is the case, you will need to type it. After your keys work, you might want to disable SSH password authentication altogether. Just make sure that your SSH keys work first, or you could lock yourself out! To disable password authentication, edit <code class="literal">/etc/ssh/sshd_config</code> and locate the line that says <code class="literal">#PasswordAuthentication yes</code>. Uncomment this line and set it to no, as follows:</p><div class="informalexample"><pre class="programlisting">
<span class="strong"><strong>PasswordAuthentication no</strong></span>
</pre></div><p>Finally, run <code class="literal">sudo service sshd reload</code> to load the new change.</p><div class="note" style="" title="Note"><div class="inner"><h3 class="title"><a id="tip15"/>Tip</h3><p>The default is a <span class="emphasis"><em>2048 bit</em></span> key. You can increase this to <span class="emphasis"><em>4096 bits</em></span> with the <code class="literal">-b</code> flag (increasing the bits makes it harder to crack the key by brute force methods), as follows:</p><div class="informalexample"><pre class="programlisting">
<span class="strong"><strong>ssh-keygen -t rsa -b 4096</strong></span>
</pre></div></div></div><p>Another method that allows you to prevent SSH brute force attacks, especially when you can not disable password authentication for one reason or another, is the use of the <code class="literal">denyhosts</code> package. This package monitors for failed SSH logins. When a host attempts to log in either as a user that doesn't exist, or too many times, that host is added to <code class="literal">/etc/hosts.deny</code> and blocked from future SSH access.</p></div><div class="section" title="Configuring firewalls"><div class="titlepage"><div><div><h2 class="title"><a id="ch04lvl2sec48"/>Configuring firewalls</h2></div></div></div><p>One <a class="indexterm" id="id248"/>of the most common ways of protecting machines on a network is with a firewall. Essentially, a firewall gives you the ability to restrict access to services over the network. With a firewall, you can limit access to SSH, for instance, to hosts only within your internal network, while allowing HTTP access to everyone.</p><p>Historically, the firewall rules in Linux need to be set with a long and complicated set of <code class="literal">iptables</code> commands (also known as the <code class="literal">iptables</code> rules). This complexity is a weakness because one of the main security principles is to do things in a simple way. Luckily for Ubuntu administrators, there is now a simpler tool named <code class="literal">ufw</code>, which aims to simplify firewall administration by providing a frontend to the <code class="literal">iptables</code> commands.</p><p>The <code class="literal">ufw</code> program is installed by default on Ubuntu Server, but it is disabled; you need to enable it before you start adding rules.</p><p>The basic <a class="indexterm" id="id249"/>set of <code class="literal">ufw</code> commands is pretty straightforward. If you run <code class="literal">ufw -h</code>, you will get a help page that describes the main <code class="literal">ufw</code> commands, but if you want the entire syntax information, type in <code class="literal">man ufw</code> to read the entire manual page. First of all, let's identify the main commands and then see some examples:</p><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc">You can enable and disable <code class="literal">ufw</code> by using <code class="literal">sudo ufw enable</code> and <code class="literal">sudo ufw disable</code> respectively.</li><li class="listitem" style="list-style-type: disc">Check the <code class="literal">ufw</code> status by using <code class="literal">sudo ufw status</code>; the same command will list all the rules in case <code class="literal">ufw</code> is enabled.</li><li class="listitem" style="list-style-type: disc">You can also set the default policy of your firewall. A very important command that you need to consider is the <code class="literal">default</code> command. This command defines the default policy of your firewall, as in whether all the packets are allowed or denied by default. The general consensus is that a firewall is more secure if you deny all packets by default and then enable services as needed. That way, in case you start a new service (or worse, a user starts a service) and you forget to set firewall rules for it, it will be blocked by default. So, to deny all packets by default, type in <code class="literal">sudo ufw default deny</code>. To allow all packets by default, type in <code class="literal">sudo ufw default allow</code>. Note that <code class="literal">ufw</code> will deny all packets by default unless you change the settings.</li><li class="listitem" style="list-style-type: disc">You can configure the logging function to trace anything that it blocks, along with anything against your default policy. To enable logging, type in <code class="literal">sudo ufw logging on</code>, and to disable it, type in <code class="literal">sudo ufw logging off</code>.</li><li class="listitem" style="list-style-type: disc">A basic <code class="literal">ufw</code> rule takes a port or service as an argument. To open port 53 (used for DNS servers), you would run <code class="literal">sudo ufw allow 53</code>.</li><li class="listitem" style="list-style-type: disc">The <code class="literal">ufw</code> command also accepts service names that are defined in the <code class="literal">/etc/services</code> file instead of specific ports. If you look in the <code class="literal">/etc/services</code> file, you will see that port 53 TCP and UDP is set to the domain service. So, another way of stating this rule is <code class="literal">sudo ufw allow domain</code>.</li><li class="listitem" style="list-style-type: disc">You can also specify the transport protocol. An example of this is <code class="literal">sudo ufw allow 53/udp</code>.</li><li class="listitem" style="list-style-type: disc">You can also set a specific subnet that is allowed to access the server. Here's an example command that is used to limit web access (port 80) to just the <span class="emphasis"><em>192.168.1.0</em></span> network:<div class="informalexample"><pre class="programlisting">
<span class="strong"><strong>sudo ufw allow proto tcp from 192.168.1.0/24 to any port 80</strong></span>
</pre></div></li><li class="listitem" style="list-style-type: disc">Even if you deny all packets by default, there may be circumstances in which you may also add a deny rule. For instance, let's say that you are running an external SMTP (e-mail) server and you see that a host inside your network at <span class="emphasis"><em>192.168.1.111</em></span> appears to be infected with a virus and is flooding your e-mail server with invalid messages. To block just that IP address, you will execute the following command:<div class="informalexample"><pre class="programlisting">
<span class="strong"><strong>sudo ufw deny proto tcp from 192.168.1.111 to any port 25</strong></span>
</pre></div></li><li class="listitem" style="list-style-type: disc">In case <a class="indexterm" id="id250"/>you want to block all the packets from that host and not just the SMTP, you wouldn't need to define the proto and to arguments:<div class="informalexample"><pre class="programlisting">
<span class="strong"><strong>sudo ufw deny from 192.168.1.111</strong></span>
</pre></div></li><li class="listitem" style="list-style-type: disc">Later on, once the virus has been removed and the host is back to normal, you can remove the rule with the help of the following command:<div class="informalexample"><pre class="programlisting">
<span class="strong"><strong>sudo ufw delete deny proto tcp from 192.168.1.111 to any port 25</strong></span>
</pre></div></li><li class="listitem" style="list-style-type: disc">Alternatively, in case you dropped all the packets from the host, the following command will remove it:<div class="informalexample"><pre class="programlisting">
<span class="strong"><strong>sudo ufw delete deny from 192.168.1.111</strong></span>
</pre></div></li></ul></div><div class="note" style="" title="Note"><div class="inner"><h3 class="title"><a id="tip16"/>Tip</h3><p>Be careful when using <code class="literal">ufw</code> while you are connected via SSH because enabling <code class="literal">ufw</code> with its default action of denying all packets will close your SSH connection and isolate your server. The best thing to do when you start configuring <code class="literal">ufw</code> and before enabling it or adding any other rules is to add the following rule:</p><div class="informalexample"><pre class="programlisting">
<span class="strong"><strong>sudo ufw allow ssh</strong></span>
</pre></div></div></div><p>Now, let's have a look at a couple of examples:</p><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc">For a DNS server, we need to allow DNS packets and deny the others, of course after allowing SSH, and at the end, enable <code class="literal">ufw</code> and check its status. The following is a sequence of commands. Take care of the order; it matters a lot:<div class="informalexample"><pre class="programlisting">
<span class="strong"><strong>sudo ufw allow ssh</strong></span>
<span class="strong"><strong>sudo ufw allow domain</strong></span>
<span class="strong"><strong>sudo ufw default deny</strong></span>
<span class="strong"><strong>sudo ufw enable</strong></span>
<span class="strong"><strong>sudo ufw status</strong></span>
</pre></div></li><li class="listitem" style="list-style-type: disc">The following is another example where we have more than one service. This is the<a class="indexterm" id="id251"/> web server, where in general, we should allow <code class="literal">http (80)</code> and <code class="literal">https (443)</code> access:<div class="informalexample"><pre class="programlisting">
<span class="strong"><strong>sudo ufw allow ssh</strong></span>
<span class="strong"><strong>sudo ufw allow www</strong></span>
<span class="strong"><strong>sudo ufw allow https</strong></span>
<span class="strong"><strong>sudo ufw default deny</strong></span>
<span class="strong"><strong>sudo ufw enable</strong></span>
<span class="strong"><strong>sudo ufw status</strong></span>
</pre></div></li></ul></div></div></div>
<div class="section" title="Backuping and restoring"><div class="titlepage"><div><div><h1 class="title"><a id="ch04lvl1sec31"/>Backuping and restoring</h1></div></div></div><p>The<a class="indexterm" id="id252"/> tools and procedures that we saw in this chapter until now allow us to raise the server security level and enhance the ability to block attacks, but what if we are being attacked? In some cases, we can investigate and clean up the system, but in most cases, neither the time nor the means allow us to do that, and the best solution is to restore a healthy backed up image of the system. The backup and restore procedures solve not only problems related to attacks, but also problems related to data loss that are caused by human mistakes or physical accidents such as a server room fire.</p><p>In the following section, you will discover how to perform a backup/restore of Ubuntu Server in more than one way with more than one tool.</p><div class="section" title="The principles of backup"><div class="titlepage"><div><div><h2 class="title"><a id="ch04lvl2sec49"/>The principles of backup</h2></div></div></div><p>There are <a class="indexterm" id="id253"/>a number of principles that should guide you when you choose your backup strategy. Most of these are common sense but bear repeating:</p><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc">Back up your data to a separate system</li><li class="listitem" style="list-style-type: disc">Test your backups</li><li class="listitem" style="list-style-type: disc">RAID is not a substitute for backups</li><li class="listitem" style="list-style-type: disc">Create full and incremental backup schedules</li><li class="listitem" style="list-style-type: disc">Decide how often you need to back up</li><li class="listitem" style="list-style-type: disc">Archive your backups</li></ul></div></div><div class="section" title="Drive imaging"><div class="titlepage"><div><div><h2 class="title"><a id="ch04lvl2sec50"/>Drive imaging</h2></div></div></div><p>An <a class="indexterm" id="id254"/>image is a complete bit-for-bit copy of a drive. So, once you image a drive, you will get an identical image of the original drive.</p><div class="note" style="" title="Note"><div class="inner"><h3 class="title"><a id="note30"/>Note</h3><p>When imaging a drive, it's important that the drive is not in use. In case the drive changes when imaging it, you will not be able to guarantee that the image is consistent. So, be sure that the filesystems on a drive are unmounted.</p></div></div><p>Ubuntu Server <a class="indexterm" id="id255"/>uses the classic UNIX imaging tool named dd. Its working process is simple—it reads an input file bit by bit and copies it to an output file bit by bit. If you had two drives of identical size, say <code class="literal">/dev/sda and /dev/sdb</code>, use the following command to image <code class="literal">sda</code> to <code class="literal">sdb</code>:</p><div class="informalexample"><pre class="programlisting">
<span class="strong"><strong>sudo dd if=/dev/sda of=/dev/sdb</strong></span>
</pre></div><p>The <code class="literal">dd</code> tool also works with files as input and output arguments instead of drivers. So it's better to image our target in a file instead of a driver so that we can copy it easily in a transportable device such as a USB driver or send it to a remote file server.</p><p>For example, if you want to back up the <code class="literal">sda</code> partition in an image file under a USB driver mounted under <code class="literal">/media/myUSB/</code>, all you need to do is execute the following command:</p><div class="informalexample"><pre class="programlisting">
<span class="strong"><strong>sudo dd if=/dev/sda of=/media/myUSB/sda-image.img</strong></span>
</pre></div><p>To restore this image, just reverse the two arguments. Here are the commands to restore the two previous examples:</p><div class="informalexample"><pre class="programlisting">
<span class="strong"><strong>sudo dd if=/dev/sdb of=/dev/sda</strong></span>
<span class="strong"><strong>sudo dd if=/media/myUSB/sda-image.img of=/dev/sda</strong></span>
</pre></div><p>You can also image individual partitions. This can be useful because you can easily mount the image loopback and read through them. First, let's image a partition on <code class="literal">/dev/sda</code>, as follows:</p><div class="informalexample"><pre class="programlisting">
<span class="strong"><strong>sudo dd if=/dev/sda1 of=/media/myUSB/sda1-image.img</strong></span>
</pre></div><p>Now, you can create a directory named <code class="literal">/mnt/temp</code> and use the loop mount option to mount this image, as follows:</p><div class="informalexample"><pre class="programlisting">
<span class="strong"><strong>sudo mkdir /mnt/temp</strong></span>
<span class="strong"><strong>sudo mount loop /media/myUSB/sda1-image.img /mnt/temp</strong></span>
</pre></div><p>This is handy when you need to recover only a few files from an image. You can browse <code class="literal">/mnt/temp</code> like any other filesystem and copy individual files or entire directories from it.</p><p>We can directly back up an image of a given driver to a remote server by using SSH. For example, to transfer <code class="literal">/dev/sda</code> from the local machine over the network to <span class="emphasis"><em>192.168.1.200</em></span> and dump the image at <code class="literal">/media/MyBackupData/sda-image.img</code>, you would type in the following code:</p><div class="informalexample"><pre class="programlisting">
<span class="strong"><strong>sudo dd if=/dev/sda | ssh username@192.168.1.200 \</strong></span>
<span class="strong"><strong>"cat &gt; /media/MyBackupData/sda-image.img"</strong></span>
</pre></div><p>To restore this image, use the following code:</p><div class="informalexample"><pre class="programlisting">
<span class="strong"><strong>ssh username@192.168.1.200 "cat /media/MyBackupData/sda-image.img" \ sudo dd of=/dev/sda</strong></span>
</pre></div></div><div class="section" title="Database backups"><div class="titlepage"><div><div><h2 class="title"><a id="ch04lvl2sec51"/>Database backups</h2></div></div></div><p>For the most<a class="indexterm" id="id256"/> part, backing up a system is as easy as creating a copy of its files. However, on a database system, things aren't quite that simple. A database often won't commit changes to disk immediately. So, if you simply make a copy of the database files, the database itself might be in an inconsistent state. When you restore it, you can't necessarily guarantee that it is an uncorrupted copy.</p><p>The solution to this problem is to use tools included with the database to provide a consistent dump of the complete database to a file that you can back up. In the following section, you will learn how to use the tools provided for the MySQL databases in Ubuntu. A similar procedure is applied to other databases, depending on their own dumping tools.</p><p>The tool that MySQL uses to create a backup of its database is called <span class="strong"><strong>mysqldump</strong></span>. This tool dumps an entire database or databases to the screen. Most people then redirect the output to a file or pipe it to a tool such as gzip to compress it first. For instance, if your user had a database called <code class="literal">mySite</code>, here is how should will back it up:</p><div class="informalexample"><pre class="programlisting">
<span class="strong"><strong>mysqldump mySite &gt; mySite_backup.sql</strong></span>
</pre></div><p>If you wanted to compress the database as it was dumped, put a pipe to <code class="literal">gzip</code> in the middle, as follows:</p><div class="informalexample"><pre class="programlisting">
<span class="strong"><strong>mysqldump MySite | gzip &gt; MySite_backup.sql.gz</strong></span>
</pre></div><p>Now, if you want to back up more than one database, there are two main ways to do it. The first way is to use the <code class="literal">--databases</code> argument, followed by a space-separated list of databases that you need to back up. The other method is to use the <code class="literal">--all-databases</code> argument, which backs up everything, as follows:</p><div class="informalexample"><pre class="programlisting">
<span class="strong"><strong>mysqldump --all-databases &gt; all_databases_backup.sql</strong></span>
</pre></div><p>In case you set passwords for the MySQL users, you should provide them by using the <code class="literal">-u</code> and <code class="literal">-p</code> options to get this command working. For example, for the root user with a <code class="literal">mySecret</code> password, run the following command:</p><div class="informalexample"><pre class="programlisting">
<span class="strong"><strong>mysqldump --all-databases -u root -pmySecret \ &gt; all_databases_backup.sql</strong></span>
</pre></div><p>The preceding command will back up all the databases as the root user is using an insecure password. I gave this example only to say that while this option works, it is insecure. The reason is that the full list of arguments, including the password, will be visible to all the users on the system who run the <code class="literal">ps</code> command. A better method is to use <code class="literal">-p</code> without specifying a password:</p><div class="informalexample"><pre class="programlisting">
<span class="strong"><strong>mysqldump --all-databases -u root -p \ &gt;</strong></span>
<span class="strong"><strong>all_databases_backup.sql</strong></span>
</pre></div><p>When you specify <code class="literal">-p</code> without a password, <code class="literal">mysqldump</code> behaves like the <code class="literal">mysql</code> command and prompts you to enter a password. This provides good security, but it of course also means that you have<a class="indexterm" id="id257"/> to enter the password manually. Most people who back up their MySQL databases set up a <code class="literal">cron</code> job to do it at night. The way that MySQL recommends to solve this problem is to add the password to the client section in the <code class="literal">~/.my.cnf</code> file for the user performing the backups. If you already don't have a <code class="literal">~/.my.cnf</code> file, create a new one and add the following text in it:</p><div class="informalexample"><pre class="programlisting">
<span class="strong"><strong>[client]</strong></span>
<span class="strong"><strong>password=mypassword</strong></span>
</pre></div><p>Replace <code class="literal">mypassword</code> with the password that your user will use to log in. Once you set up this file, you don't need to specify the <code class="literal">-p</code> option anymore, because <code class="literal">mysqldump</code> will pick up the password from this file. The downside here is that this password is in a plain-text file on the system. So, you will want to set its permissions so that only your user can see it:</p><div class="informalexample"><pre class="programlisting">
<span class="strong"><strong>chmod 400 ~/.my.cnf</strong></span>
</pre></div><p>To restore a backup on MySQL, use the <code class="literal">mysql</code> command-line tool and point it at your backup. For instance, to back up the <code class="literal">mySite</code> database to <code class="literal">mySite_backup.sql</code>, execute the following command:</p><div class="informalexample"><pre class="programlisting">
<span class="strong"><strong>mysql mySite &lt; mySite_backup.sql</strong></span>
</pre></div><p>Instead, in case you are backing up a number of databases, just execute the following command:</p><div class="informalexample"><pre class="programlisting">
<span class="strong"><strong>mysql &lt; multiple_database_backup.sql</strong></span>
</pre></div><p>To restore all the databases, you need to log in as the root user. In case you set a root password, you must use the <code class="literal">-p</code> option (unless you set up a <code class="literal">.my.cnf</code> file; in that case, you can leave out <code class="literal">-p</code>), as follows:</p><div class="informalexample"><pre class="programlisting">
<span class="strong"><strong>mysql -u root -p &lt; all_databases.sql</strong></span>
</pre></div></div><div class="section" title="Backup tools"><div class="titlepage"><div><div><h2 class="title"><a id="ch04lvl2sec52"/>Backup tools</h2></div></div></div><p>There are a<a class="indexterm" id="id258"/> lot of backup tools that we can use to backup and easily restore Ubuntu Server. Some of them use CLI and others use GUI; some are free, while others<a class="indexterm" id="id259"/> come with a paid license. They also differ according to the backup mode, which can be <span class="strong"><strong>full</strong></span> (the tool backs up all the files in the backup target), <span class="strong"><strong>incremental</strong></span> (the tool backs up all the files that have been changed since the last backup), or <span class="strong"><strong>differential</strong></span> (the tool backs up all the files that have been changed since the last full backup).</p><p>Here's a comparison of some of the <a class="indexterm" id="id260"/>well-known tools:</p><div class="informaltable"><table border="1"><colgroup><col style="text-align: left"/><col style="text-align: left"/><col style="text-align: left"/></colgroup><thead><tr><th style="text-align: left" valign="bottom">
<p>Tool name</p>
</th><th style="text-align: left" valign="bottom">
<p>Interface</p>
</th><th style="text-align: left" valign="bottom">
<p>Remarks</p>
</th></tr></thead><tbody><tr><td style="text-align: left" valign="top">
<p>
<span class="strong"><strong>Areca Backup</strong></span>
</p>
</td><td style="text-align: left" valign="top">
<p>GUI</p>
</td><td style="text-align: left" valign="top">
<p>This<a class="indexterm" id="id261"/> is a great backup software that works locally or with FTP, is written in Java, has a very intuitive GTK graphical interface, and provides possibilities of complete restorations and file search.</p>
</td></tr><tr><td style="text-align: left" valign="top">
<p>
<span class="strong"><strong>Bacula</strong></span>
</p>
</td><td style="text-align: left" valign="top">
<p>GUI</p>
</td><td style="text-align: left" valign="top">
<p>This <a class="indexterm" id="id262"/>is a professional open source backup software. It saves the contents of a PC or a PC with multiple networks. Bacula has a lot of features. But it requires you to have advanced knowledge in terms of backups.</p>
</td></tr><tr><td style="text-align: left" valign="top">
<p>
<span class="strong"><strong>BackInTime</strong></span>
</p>
</td><td style="text-align: left" valign="top">
<p>GUI</p>
</td><td style="text-align: left" valign="top">
<p>This is <a class="indexterm" id="id263"/>a very simple backup tool that is available for Linux. The backup is done by taking "snapshots" of a set of directories. Currently, there are two available GUIs, namely Gnome and KDE.</p>
<p>This solution is one of the few tools that let you save the file on a remote server via SSH and store it in an encrypted form. It is possible to save the file on a dedicated server without concern for the security of its data once it's stored.</p>
</td></tr><tr><td style="text-align: left" valign="top">
<p>
<span class="strong"><strong>BackupPC</strong></span>
</p>
</td><td style="text-align: left" valign="top">
<p>GUI</p>
</td><td style="text-align: left" valign="top">
<p>This is <a class="indexterm" id="id264"/>a very powerful tool that can be used to back up multiple clients (Linux or Windows).</p>
<p>BackupPC is used to save a set of machines. It has a web interface to configure and initiate backups or restore files. It is also possible to back up databases.</p>
<p>BackupPC can automatically save the directories on networked computers at regular time intervals.</p>
<p>It can also do much more.</p>
</td></tr><tr><td style="text-align: left" valign="top">
<p>
<span class="strong"><strong>Déjà Dup</strong></span>
</p>
</td><td style="text-align: left" valign="top">
<p>GUI</p>
</td><td style="text-align: left" valign="top">
<p>This is a<a class="indexterm" id="id265"/> simple backup utility and a GUI tool for duplicity. It allows you to create backups in a local directory, on servers (SSH/FTP/HTTP), or on the Cloud. It also allows you to encrypt the saved files and schedule automatic backups.</p>
</td></tr><tr><td style="text-align: left" valign="top">
<p>
<span class="strong"><strong>LuckyBackup</strong></span>
</p>
</td><td style="text-align: left" valign="top">
<p>GUI</p>
</td><td style="text-align: left" valign="top">
<p>This is a <a class="indexterm" id="id266"/>simple tool with the power of rsync in a friendly interface. It offers features such as simple or advanced mode, restore, simulation, the remote operation, superuser mode, profiles, and planning.</p>
</td></tr><tr><td style="text-align: left" valign="top">
<p>
<span class="strong"><strong>SBackup</strong></span>
</p>
</td><td style="text-align: left" valign="top">
<p>GUI</p>
</td><td style="text-align: left" valign="top">
<p>This is <a class="indexterm" id="id267"/>a simple tool that you can use easily, and it is powerful. It allows you to perform an incremental backup but not a differential backup.</p>
</td></tr><tr><td style="text-align: left" valign="top">
<p>
<span class="strong"><strong>Backup-Manager</strong></span>
</p>
</td><td style="text-align: left" valign="top">
<p>CLI</p>
</td><td style="text-align: left" valign="top">
<p>With <a class="indexterm" id="id268"/>this tool, backup files are stored locally in archives and can be exported on a server (FTP, SSH, rsync, and so on) or burned on a CD/DVD.</p>
</td></tr><tr><td style="text-align: left" valign="top">
<p>
<span class="strong"><strong>Duplicity</strong></span>
</p>
</td><td style="text-align: left" valign="top">
<p>CLI</p>
</td><td style="text-align: left" valign="top">
<p>This<a class="indexterm" id="id269"/> tool performs backups by creating TAR archives that are encrypted with GnuPG. These archives are then sent to a local or remote backup directory. The supported remote protocols are FTP, SSH/SCP, Rsync, WebDAV/ WebDAVs, and Amazon S3.</p>
</td></tr><tr><td style="text-align: left" valign="top">
<p>
<span class="strong"><strong>Rsync</strong></span>
</p>
</td><td style="text-align: left" valign="top">
<p>CLI</p>
</td><td style="text-align: left" valign="top">
<p>Rsync (for remote synchronization) is a file synchronization software. It <a class="indexterm" id="id270"/>is frequently used to implement remote backup systems.</p>
<p>Rsync works unidirectionally, which means that it synchronizes, copies, or updates source data (local or remote) to a destination (local or remote) by transferring the bytes of the files that have been modified.</p>
</td></tr><tr><td style="text-align: left" valign="top">
<p>
<span class="strong"><strong>Unison</strong></span>
</p>
</td><td style="text-align: left" valign="top">
<p>CLI</p>
</td><td style="text-align: left" valign="top">
<p>Unison<a class="indexterm" id="id271"/> is a synchronization software. Unlike Rsync, it displays bidirectional synchronization.</p>
</td></tr></tbody></table></div><p>There are also<a class="indexterm" id="id272"/> some specific backup tools that are dedicated to partition cloning. The following are two such famous tools for Ubuntu:</p><div class="informaltable"><table border="1"><colgroup><col style="text-align: left"/><col style="text-align: left"/><col style="text-align: left"/></colgroup><thead><tr><th style="text-align: left" valign="bottom">
<p>Tool name</p>
</th><th style="text-align: left" valign="bottom">
<p>Interface</p>
</th><th style="text-align: left" valign="bottom">
<p>Remarks</p>
</th></tr></thead><tbody><tr><td style="text-align: left" valign="top">
<p>
<span class="strong"><strong>Clonezilla</strong></span>
</p>
</td><td style="text-align: left" valign="top">
<p>GUI</p>
</td><td style="text-align: left" valign="top">
<p>This <a class="indexterm" id="id273"/>is a free equivalent of Norton Ghost or Acronis True Image. It allows you to create an image backup of a hard disk or partition and then restore it.</p>
</td></tr><tr><td style="text-align: left" valign="top">
<p>
<span class="strong"><strong>Partclone</strong></span>
</p>
</td><td style="text-align: left" valign="top">
<p>CLI</p>
</td><td style="text-align: left" valign="top">
<p>It is <a class="indexterm" id="id274"/>used to backup a partition. It is somehow the equivalent of Norton Ghost. It can be installed on a <code class="literal">live usb</code> to save your system.</p>
</td></tr></tbody></table></div><p>Now, let's take as an example the powerful backup tool named <span class="strong"><strong>BackupPC</strong></span>. To install it, you need to run the following command:</p><div class="informalexample"><pre class="programlisting">
<span class="strong"><strong>sudo apt-get install backuppc</strong></span>
</pre></div><p>You will be asked for some information related to the mail server (postfix) and the web server that you wish to use (in our case, it is Apache), as shown in the following screenshot. In the end, you will get a message indicating the URL needed to manage BackupPC and the needed credentials to log in to the system:</p><div class="mediaobject"><img alt="Backup tools" src="graphics/B04800_04_02.jpg"/></div><p>To activate <a class="indexterm" id="id275"/>the new configuration, you need to run the following command:</p><div class="informalexample"><pre class="programlisting">
<span class="strong"><strong>sudo service apache2 restart</strong></span>
</pre></div><p>Then, you can start using BackupPC via a web browser by using either the URL given in the message, or the server IP address followed by <code class="literal">/backuppc/</code>. You will be asked for login credentials, as shown in the following screenshot. After entering them, you will get a a good interface that is easy to use with a very rich documentation:</p><div class="mediaobject"><img alt="Backup tools" src="graphics/B04800_04_03.jpg"/></div><div class="note" style="" title="Note"><div class="inner"><h3 class="title"><a id="note31"/>Note</h3><p>You can find out more information on how to use BackupPC in both GUI and CLI modes at <a class="ulink" href="https://help.ubuntu.com/community/BackupPC">https://help.ubuntu.com/community/BackupPC</a>.</p></div></div></div></div>
<div class="section" title="Summary"><div class="titlepage"><div><div><h1 class="title"><a id="ch04lvl2sec53"/>Summary</h1></div></div></div><p>In this chapter, we focused on a very important subject related to Ubuntu Server, namely security management. We covered the basic and advanced security features inside Ubuntu Server and explored how to use them to enhance a system's security level. Then, we got an overview of the backup/restore operations for Ubuntu Server.</p><p>In the next chapter, we will concentrate on one of the hottest IT subjects nowadays, which is virtualization and Cloud computing based on Ubuntu Server.</p></div></body></html>