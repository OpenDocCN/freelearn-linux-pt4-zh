<html><head></head><body><div class="chapter" title="Chapter&#xA0;9.&#xA0;Troubleshooting VCM"><div class="titlepage"><div><div><h1 class="title"><a id="ch09"/>Chapter 9. Troubleshooting VCM</h1></div></div></div><p>In this chapter, we will cover the following recipes:</p><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc">Troubleshooting tools - EcmDebugEventViewer</li><li class="listitem" style="list-style-type: disc">Troubleshooting tools - Job Manager | History</li><li class="listitem" style="list-style-type: disc">Troubleshooting tools - Machine Collection Status</li><li class="listitem" style="list-style-type: disc">Troubleshooting agent communication issues</li><li class="listitem" style="list-style-type: disc">Troubleshooting agent upgrade issues</li><li class="listitem" style="list-style-type: disc">Troubleshooting SCR download issues</li><li class="listitem" style="list-style-type: disc">Troubleshooting VCM console login failure</li><li class="listitem" style="list-style-type: disc">Troubleshooting vCenter and vCloud data collection issues</li><li class="listitem" style="list-style-type: disc">Troubleshooting the Recommended Action: Investigate Issue Linux server patch error</li><li class="listitem" style="list-style-type: disc">Troubleshooting not being able to see any jobs on the console</li><li class="listitem" style="list-style-type: disc">Troubleshooting not being able to see the Monthly option on the Schedule Job page</li></ul></div><div class="section" title="Introduction"><div class="titlepage"><div><div><h1 class="title"><a id="ch09lvl1sec87"/>Introduction</h1></div></div></div><p>Troubleshooting is the process of identifying the source of a problem and eliminating it. To start troubleshooting, you start with the most obvious possible problem and then pinpoint the exact issue. Doing this requires two things: experience of the entity you are troubleshooting and good tools to look at details such as logs and error codes.</p><p>In this chapter, we will talk about both. In the first three recipes, you will be introduced to the tools, as they are necessary to gain some expertise in VCM troubleshooting, and then, we will look at some general issues and their solutions.</p><p>The troubleshooting tools we will cover include <span class="strong"><strong>EcmDebugEventViewer.exe</strong></span>, <span class="strong"><strong>VCM logs</strong></span>, <span class="strong"><strong>Job Manager | History</strong></span>, and the <span class="strong"><strong>SQL log viewer</strong></span>. If you are good with SQL, you can try SQL trace as well.</p><p>The general issues include issues with data collection, issues faced during patching, and issues with agent communication.</p><p>Agent communication messages are too cryptic; they say <span class="strong"><strong>Pingfailed</strong></span> for every issue, You need to check what exactly went wrong.</p><p>So, let's get started with troubleshooting VCM.</p></div></div>
<div class="section" title="Troubleshooting tools &#x2013; EcmDebugEventViewer"><div class="titlepage"><div><div><h1 class="title"><a id="ch09lvl1sec88"/>Troubleshooting tools – EcmDebugEventViewer</h1></div></div></div><p>You can use the EcmDebugEventViewer tool to have a closer look at all the events that are stored in the VCM database. This will help you find event errors for your environment.</p><div class="section" title="Getting ready"><div class="titlepage"><div><div><h2 class="title"><a id="ch09lvl2sec253"/>Getting ready</h2></div></div></div><p>We need access to the VCM OS with admin rights.</p><p>The tool is called EcmDebugEventViewer.exe. It is a standalone executable available in <code class="literal">C:\Program Files (x86)\VMware\VCM\Tools</code> (if you installed VCM with defaults).</p></div><div class="section" title="How to do it..."><div class="titlepage"><div><div><h2 class="title"><a id="ch09lvl2sec254"/>How to do it...</h2></div></div></div><p>This recipe splits is in two parts: starting and filtering.</p><div class="section" title="Accessing events"><div class="titlepage"><div><div><h3 class="title"><a id="ch09lvl3sec75"/>Accessing events</h3></div></div></div><p>The tool can be launched from its own location, or you can copy the <code class="literal">.exe</code> file anywhere and start. Follow these steps:</p><div class="orderedlist"><ol class="orderedlist arabic"><li class="listitem">Connect to your VCM OS with administrator rights.</li><li class="listitem">Open an Explorer window and browse to <code class="literal">X:\Program Files (x86)\VMware\VCM\Tools</code> (<span class="emphasis"><em>X</em></span> is the drive where you installed VCM).</li><li class="listitem">Right-click on <span class="strong"><strong>EcmDebugEventViewer.exe</strong></span> and select <span class="strong"><strong>Run as Administrator</strong></span>.</li><li class="listitem">You are now presented with a blank screen. You can choose from three possibilities: <span class="strong"><strong>Database</strong></span>, <span class="strong"><strong>Collector DB</strong></span>, or <span class="strong"><strong>Open File</strong></span> to open a saved <code class="literal">.dbe</code> file. For this example, select <span class="strong"><strong>Database</strong></span>.</li><li class="listitem">Press <span class="emphasis"><em>F5</em></span>; it will fetch the content of the logs from the database.<div class="mediaobject"><img alt="Accessing events" src="graphics/image_09_001.jpg"/></div></li><li class="listitem">Double-click on a line to open more details. The following screenshot shows an error message that the VCM server is unable to resolve the mail server.<div class="mediaobject"><img alt="Accessing events" src="graphics/image_09_002.jpg"/></div></li><li class="listitem">You can use the <span class="strong"><strong>Up</strong></span> and <span class="strong"><strong>Down</strong></span> buttons on the details windows to see other log entries.</li><li class="listitem">Click on <span class="strong"><strong>Close </strong></span>to close the event details.</li></ol></div></div><div class="section" title="Filtering events"><div class="titlepage"><div><div><h3 class="title"><a id="ch09lvl3sec76"/>Filtering events</h3></div></div></div><p>As there are lots of entries, you might want to reduce the amount by deploying a filer. Continue with these steps:</p><div class="orderedlist"><ol class="orderedlist arabic"><li class="listitem">Click on <span class="strong"><strong>Filter settings</strong></span> and then define a filtering criteria, such as the source or type of the message, as shown in the following screenshot:<div class="mediaobject"><img alt="Filtering events" src="graphics/image_09_003.jpg"/></div></li><li class="listitem">You can also select the specific timeframes that should be shown. Click on <span class="strong"><strong>Date/Time</strong></span> in the top menu and modify the duration, as shown in the following screenshot.<div class="mediaobject"><img alt="Filtering events" src="graphics/image_09_004.jpg"/></div></li><li class="listitem">You can export the selected logs by going to <span class="strong"><strong>File | Save As dbe</strong></span>. This will save all the lines.</li><li class="listitem">To save only selected lines, select the lines and then go to <span class="strong"><strong>File | Save Selected As dbe.</strong></span></li></ol></div><p>This concludes our overview of the EcmDebugEventViewer tool.</p></div></div><div class="section" title="How it works"><div class="titlepage"><div><div><h2 class="title"><a id="ch09lvl2sec255"/>How it works</h2></div></div></div><p>You can open the main <code class="literal">VCM</code> database as well as the <code class="literal">VCM_Coll</code> database or any saved files.</p><p>When you are troubleshooting VCM issues, this is the first place to start. Always select the main VCM database as it contains the collected system data from the VCM agents along with all the processes it is performing.</p><p>Let's take an example:</p><p>You are trying to patch a Linux machine and it is failing, and it is giving you the PingFailed error code. You check and find that you are able to ping the managed Linux machine and you can Telnet to the port-everything with regards to communication with the Linux machine is working fine. The small catch here is that VCM first tries to communicate with the SCR server on port <code class="literal">26542</code>, and if that is not accessible for any reason, it just gives you a cryptic PingFailed error. Now, if you start the ECMDebug tool, and you have already enabled the debug log level to info, you can see that it is trying to communicate with the SCR server and failing there.</p><p>On further troubleshooting, you find that the agent was not communicating for some reason. After restarting it, you can proceed with patching.</p><p>The next option is the VCM collection database. The <code class="literal">VCM_Coll</code> database contains information about the UI, such as Collector settings and options. To be frank, I have hardly used it, so I don't really have a use case.</p><p>The last option is opening a DBE file. The VCM agent also saves its own logs in the <code class="literal">.dbe</code> file format, so to troubleshoot agent issues, you can copy the file from an agent to the server and read it, or someone can send you a saved <code class="literal">.dbe</code> file from their VCM installation, and after going through the file, you can provide suggestions. When you work with VMware, they will ask you to generate this <code class="literal">.dbe</code> file and send it to them so that they can review it and get back with some solution.</p></div></div>
<div class="section" title="Troubleshooting tools &#x2013; Job Manager | History"><div class="titlepage"><div><div><h1 class="title"><a id="ch09lvl1sec89"/>Troubleshooting tools – Job Manager | History</h1></div></div></div><p>The History tool is built in to VCM. With this tool, you can look at the status of the jobs completed earlier, and it gives you the logs to further troubleshoot.</p><div class="section" title="Getting ready"><div class="titlepage"><div><div><h2 class="title"><a id="ch09lvl2sec256"/>Getting ready</h2></div></div></div><p>You will need access to the VCM console and basic understanding of VCM to roam around the console.</p></div><div class="section" title="How to do it..."><div class="titlepage"><div><div><h2 class="title"><a id="ch09lvl2sec257"/>How to do it...</h2></div></div></div><p>To look at details about the jobs completed earlier, launch the VCM console and go to <span class="strong"><strong>Administration </strong></span>| <span class="strong"><strong>Job Manager</strong></span> | <span class="strong"><strong>History</strong></span>.</p><p>You have four options here: <span class="strong"><strong>Instant Collections</strong></span>, <span class="strong"><strong>Scheduled Collections</strong></span>, <span class="strong"><strong>Other Jobs</strong></span>, and <span class="strong"><strong>VCM remote</strong></span>. If you are not troubleshooting collection issues, then you most probably need to go to <span class="strong"><strong>Other jobs</strong></span> and select the job in the top-left pane, and the details will be visible in the bottom pane.</p><p>Select <span class="strong"><strong>Job History</strong></span> and click on <span class="strong"><strong>View Details</strong></span>. If the job had multiple machines, you will get an option to choose either of them, and then you can see what went wrong.</p><p>In the following screenshot, when we hover over <span class="strong"><strong>Status</strong></span>, we can see that there is something wrong with <span class="strong"><strong>Mutual authentication</strong></span>.</p><p>We can use the M<span class="strong"><strong>enu</strong></span> option at the top to copy the data, and it can then can be used to search on the Internet or provide an exact log to VMware for further troubleshooting.</p><div class="mediaobject"><img alt="How to do it..." src="graphics/image_09_005.jpg"/><div class="caption"><p>VCM Job Manager | History</p></div></div></div><div class="section" title="How it works"><div class="titlepage"><div><div><h2 class="title"><a id="ch09lvl2sec258"/>How it works</h2></div></div></div><p>Every time VCM performs a scheduled or on-demand job, it is captured at this location; you can have a look at them and see whether they failed or were successful. If they fail, it will give you errors, which you can use for further troubleshooting.</p><p>When you click on a job and select <span class="strong"><strong>View Details</strong></span>, it will give you a popup to either have a look at the selected machine or all machines. You have an option to resubmit the job from here.</p><p>Let's have a look at a real-life experience. We were not able to patch a Linux server. We had configured the SCR server and VCM as expected, but it was still failing. After checking the logs here, we found that VCM is looking for a file called <code class="literal">REDHAT-rt.ptoperties</code>, while as per the documentation, we had configured file called <code class="literal">redhat-rt.properties</code>. After correcting the name of the file (to capital letters), we were able to patch the server.</p></div></div>
<div class="section" title="Troubleshooting tools &#x2013; Machine Collection Status"><div class="titlepage"><div><div><h1 class="title"><a id="ch09lvl1sec90"/>Troubleshooting tools – Machine Collection Status</h1></div></div></div><p><span class="strong"><strong>Machine Collection Status</strong></span> in the VCM console is where you can see what data is collected from which server and whether it is a full collection or a delta. This can come in handy when you are troubleshooting data collection issues.</p><div class="section" title="Getting ready"><div class="titlepage"><div><div><h2 class="title"><a id="ch09lvl2sec259"/>Getting ready</h2></div></div></div><p>You will need access to the VCM console and basic understanding of VCM to roam around the console.</p></div><div class="section" title="How to do it..."><div class="titlepage"><div><div><h2 class="title"><a id="ch09lvl2sec260"/>How to do it...</h2></div></div></div><p>Go to <span class="strong"><strong>Administration </strong></span>| <span class="strong"><strong>Machines Manager | Machine Collection Status</strong></span>.</p><p>As mentioned, we can have a look at what data was collected, which filter set was used, and which filters were successful in obtaining the data.</p><p>Let's assume you are creating a machine group with a specific dynamic rule and the machines are not getting populated, perhaps because the datatype you are using for filtering was not collected.</p><p>You are running a report for compliance and see <span class="strong"><strong>Data not Available</strong></span> for performing the compliance test; as stated, perhaps the data was not collected.</p><p>You can see the details by applying lots of filters in the console, as this will be a large table to look at if you have a big infrastructure.</p><div class="mediaobject"><img alt="How to do it..." src="graphics/image_09_006.jpg"/><div class="caption"><p>Machine collection logs in VCM under Administration</p></div></div></div><div class="section" title="How it works"><div class="titlepage"><div><div><h2 class="title"><a id="ch09lvl2sec261"/>How it works</h2></div></div></div><p>When we collect data from managed machines, what we collect and when we made the collection is logged there.</p><p>We were working with an RHEL 7 machine to collect the data. The job was successful, but when we tried patching the server, it did not show the status, that is, whether the patch is required or not. When we checked in the Machine Collection Status tool, we did not find our machine, which means that details were not getting captured. After checking the logs, we concluded that the VCM collector was not able to capture details. After resolving the issue with the machine, we performed another collect operation and found that the details are available and the machine is listed in Machine Collection Status.</p></div></div>
<div class="section" title="Troubleshooting agent communication issues"><div class="titlepage"><div><div><h1 class="title"><a id="ch09lvl1sec91"/>Troubleshooting agent communication issues</h1></div></div></div><p>Now, we will have a look at multiple issues faced with agent communication  and how they can be resolved.</p><div class="section" title="Getting ready"><div class="titlepage"><div><div><h2 class="title"><a id="ch09lvl2sec262"/>Getting ready</h2></div></div></div><p>In this recipe, we will have a look at the following issues:</p><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc"><span class="emphasis"><em>Issue 01: Mutual Authentication failed</em></span></li><li class="listitem" style="list-style-type: disc"><span class="emphasis"><em>Issue 02: Rethrown certificate issue</em></span></li><li class="listitem" style="list-style-type: disc"><span class="emphasis"><em>Issue 03: PingFailed</em></span></li><li class="listitem" style="list-style-type: disc"><span class="emphasis"><em>Issue 04: CredentialsFailed</em></span></li></ul></div><div class="section" title="Issue 01: Mutual Authentication failed"><div class="titlepage"><div><div><h3 class="title"><a id="ch09lvl3sec77"/>Issue 01: Mutual Authentication failed</h3></div></div></div><p>Mutual authentication failure may happen after an upgrade. When you try to collect data, it fails with the error, as shown in the following screenshot:</p><div class="mediaobject"><img alt="Issue 01: Mutual Authentication failed" src="graphics/image_09_007.jpg"/><div class="caption"><p>VCM agent communication issue : <span class="strong"><strong>Mutual Authentication Failed</strong></span></p></div></div><p>You can see the error under <span class="strong"><strong>Administration </strong></span>| <span class="strong"><strong>Job Manager </strong></span>| <span class="strong"><strong>Instant Collection</strong></span>.</p><p>Then, select the appropriate subsection. After that, select the <span class="strong"><strong>Job</strong></span> in the top-left pane, and you'll be able to see the details in the bottom-left pane.</p></div></div><div class="section" title="How to do it..."><div class="titlepage"><div><div><h2 class="title"><a id="ch09lvl2sec263"/>How to do it...</h2></div></div></div><p>To resolve the issue, follow these steps:</p><div class="orderedlist"><ol class="orderedlist arabic"><li class="listitem">Select the machine for which you are not able to collect data.</li><li class="listitem">Click on <span class="strong"><strong>Re-establish Mutual Authentication</strong></span> (the handshake symbol on the menu bar).</li><li class="listitem">Select the machine or machines that are facing the issue.</li><li class="listitem">Click on <span class="strong"><strong>Finish</strong></span> to close the wizard.</li><li class="listitem">Confirm that the issue was resolved by performing the collection again.</li></ol></div><div class="section" title="Issue 02: Rethrown certificate issue"><div class="titlepage"><div><div><h3 class="title"><a id="ch09lvl3sec78"/>Issue 02: Rethrown certificate issue</h3></div></div></div><p>Agent-server communication is based on the certificate we use while installing the agent; if the certificate on the agent does not match the certificate on the server, then you will get the following error message:</p><div class="mediaobject"><img alt="Issue 02: Rethrown certificate issue" src="graphics/image_09_008.jpg"/><div class="caption"><p>VCM agent communication: the rethrown certificate issue</p></div></div></div></div><div class="section" title="How to do it..."><div class="titlepage"><div><div><h2 class="title"><a id="ch09lvl2sec264"/>How to do it...</h2></div></div></div><p>To resolve the issue, do the following:</p><div class="orderedlist"><ol class="orderedlist arabic"><li class="listitem">Reinstall the agent with the correct certificate and perform the collection again.</li><li class="listitem">In the case of a Linux server, use the installer from the correct VCM server, as the certificate is embedded in the installer.</li></ol></div><div class="section" title="Issue 03: PingFailed"><div class="titlepage"><div><div><h3 class="title"><a id="ch09lvl3sec79"/>Issue 03: PingFailed</h3></div></div></div><p>This issue could be because of many things:</p><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc">DNS resolution for the managed machine is not working</li><li class="listitem" style="list-style-type: disc">The firewall is blocking port 26542 (either on the agent or between the server and agent)</li><li class="listitem" style="list-style-type: disc">The service is not running</li><li class="listitem" style="list-style-type: disc">The agent is not installed</li><li class="listitem" style="list-style-type: disc">The machine is powered off</li><li class="listitem" style="list-style-type: disc">There are issues in routing; hence, the machine IP is not reachable</li></ul></div><div class="mediaobject"><img alt="Issue 03: PingFailed" src="graphics/image_09_009.jpg"/><div class="caption"><p>VCM agent communication issue: PingFailed</p></div></div></div></div><div class="section" title="How to do it..."><div class="titlepage"><div><div><h2 class="title"><a id="ch09lvl2sec265"/>How to do it...</h2></div></div></div><p>To resolve the issue, follow these steps:</p><div class="orderedlist"><ol class="orderedlist arabic"><li class="listitem">Make sure the managed machine is powered on.</li><li class="listitem">Ping the managed machine with the hostname or FQDN and see whether the IP is resolved.<p>Use the following commands:</p><pre class="programlisting">
<span class="strong"><strong>          ping -a 10.20.30.40&#13;
&#13;
</strong></span>
<span class="strong"><strong>          ping server01.study.local</strong></span>
</pre><p>Make sure the latter two hostnames resolve the same IP, and the first command gives the correct hostname. It has been observed that sometimes the name resolution does not work as intended and needs corrections.</p></li><li class="listitem">Trace the IP from the VCM server to check whether the machine can be reached from the VCM server and there are no routing issues; if there are any, add the required routes.<p>Use the following command to do this:</p><pre class="programlisting">
<span class="strong"><strong>          tracert server01.study.local</strong></span>
</pre><p>From the managed server, run this command:</p><pre class="programlisting">
<span class="strong"><strong>          tracert vcm.study.local</strong></span>
</pre><p>You must be able to reach from both the sides.</p></li><li class="listitem">Check the Telnet port 26542 from the VCM server; if it isn't working, check the local firewall on the managed machine. If that is disabled as well, check with the networking and security teams whether there is a firewall between the managed machine and VCM server and whether it has port 26542 open.<p>From the VCM server, try following command:</p><pre class="programlisting">
<span class="strong"><strong>          telnet server01.study.local 26542</strong></span>
</pre><p>For more on the required ports, have a look at the <span class="emphasis"><em>Understanding the requirements of VCM</em></span> section of <a class="link" href="ch01.html" title="Chapter 1. Installing VCM">Chapter 1</a>, <span class="emphasis"><em>Installing VCM</em></span>.</p></li><li class="listitem">Check the firewall on the local server.<p>This should either be disabled or should have the required ports open.</p><p>The procedure is different for Windows and Linux. Have a look at the following articles:</p><p><span class="strong"><strong>For Windows</strong></span>: <a class="ulink" href="https://technet.microsoft.com/en-us/library/cc753558.aspx">
https://technet.microsoft.com/en-us/library/cc753558.aspx
</a></p><p><span class="strong"><strong>For RedHat</strong></span>: <a class="ulink" href="https://access.redhat.com/documentation/en-US/Red_Hat_Enterprise_Linux/6/html/Security_Guide/sect-Security_Guide-Firewalls-Common_IPTables_Filtering.html">https://access.redhat.com/documentation/en-US/Red_Hat_Enterprise_Linux/6/html/Security_Guide/sect-Security_Guide-Firewalls-Common_IPTables_Filtering.html</a></p></li><li class="listitem">Check whether CMAgent is installed. This can be done in multiple ways:<p><span class="strong"><strong>For Windows</strong></span>:</p><div class="orderedlist"><ol class="orderedlist arabic"><li class="listitem">Check whether the CMagnet service is available.</li><li class="listitem">Check whether the <code class="literal">C:\Windows\CMAgent</code> folder is present and is not empty.</li><li class="listitem">Check whether CMAgent is listed in <span class="strong"><strong>Add/Remove Programs</strong></span>.</li></ol></div><p><span class="strong"><strong>For Linux</strong></span>:</p><p>Run <code class="literal">netstat -an | grep 26542</code>.</p><p>Make sure the service is listening on port <code class="literal">26542</code>.</p><p>Check whether the service is running by executing this command:</p><pre class="programlisting">
<span class="strong"><strong>          netstat -l | grep csi-agent</strong></span>
</pre><p>The command should return <code class="literal">tcp 0 0 :csi-agent *: LISTEN</code>.</p><p>Monitor processes with the top utility. If the top utility is installed and available, you can use it to monitor processes. Here's how:</p><div class="orderedlist"><ol class="orderedlist arabic"><li class="listitem">Start the top utility.</li><li class="listitem">Type <code class="literal">u</code>.</li><li class="listitem">At the <span class="strong"><strong>Which User (Blank for All):</strong></span> prompt, type the user account that the agent is installed as (<code class="literal">
csi_acct
</code>).</li><li class="listitem">Type <code class="literal">s</code>.</li><li class="listitem">At the D<span class="strong"><strong>elay between updates:</strong></span> prompt, type <code class="literal">1</code>.</li></ol></div></li><li class="listitem">Check whether the CMAgent service is running.<p>Follow the OS-specific actions to check the status.</p><p><span class="strong"><strong>For Windows</strong></span>:</p><p>Run <code class="literal">services.msc</code> and make sure the <span class="strong"><strong>CM Socket Listener</strong></span> service has been started.</p><p><span class="strong"><strong>For Linux</strong></span>:</p><p>Log in to the managed server with root privileges.</p><p>Go to <code class="literal">/etc/init.d</code>.</p><p>Execute <code class="literal">./csi-service status</code> and make sure it is running.</p></li></ol></div><div class="section" title="Issue 04: CredentialsFailed"><div class="titlepage"><div><div><h3 class="title"><a id="ch09lvl3sec80"/>Issue 04: CredentialsFailed</h3></div></div></div><p>As shown in the following screenshot, you might get an error called <span class="strong"><strong>CredentialsFailed</strong></span>. This happens when the network authority account configured for the managed machine does not have rights on the managed machine.</p><p>Chances are, the machine you are managing is either from another domain or in a workgroup, and you did not add the required credentials as the network authority account.</p><div class="mediaobject"><img alt="Issue 04: CredentialsFailed" src="graphics/image_09_010.jpg"/><div class="caption"><p>VCM agent communication issue: <span class="strong"><strong>CredentialsFailed</strong></span></p></div></div></div></div><div class="section" title="How to do it..."><div class="titlepage"><div><div><h2 class="title"><a id="ch09lvl2sec266"/>How to do it...</h2></div></div></div><p>Have a look at the <span class="emphasis"><em>Patching machines in multi-domain environments and workgroups</em></span> recipe in <a class="link" href="ch04.html" title="Chapter 4. Windows Patching">Chapter 4</a>, <span class="emphasis"><em>Windows Patching</em></span>, and the <span class="emphasis"><em>Adding a network authority account to manage machines in multiple domains </em></span>recipe in 
<a class="link" href="ch02.html" title="Chapter 2. Configuring VCM to Manage Your Infrastructure">Chapter 2</a>, <span class="emphasis"><em>Configuring  VCM to Manage Your Infrastructur</em></span>e, then add the appropriate network authority account for the managed machine and try collection again.</p></div><div class="section" title="How it works"><div class="titlepage"><div><div><h2 class="title"><a id="ch09lvl2sec267"/>How it works</h2></div></div></div><p>We discussed multiple issues here: VCM must communicate with the agents if we want to manage them. VCM agent communication is based on the certificate on the server; if that is not as expected, then the server won't communicate, and we need to replace that by reinstalling the agent with the correct certificate.</p><p>We need to make sure that we can resolve the hostname of the managed machine and connect on port 26542, so open firewall ports in between.</p></div></div>
<div class="section" title="Troubleshooting agent upgrade issues"><div class="titlepage"><div><div><h1 class="title"><a id="ch09lvl1sec92"/>Troubleshooting agent upgrade issues</h1></div></div></div><p>After upgrading VCM to version 5.8.1, you might face some issues while upgrading the agent to the latest version. The upgrade fails, but if you choose <span class="strong"><strong>Install </strong></span>
<span class="strong"><strong>with Remove Current version </strong></span>from the VCM console, then the agent gets installed/upgraded to the latest version.</p><div class="note" style="" title="Note"><div class="inner"><h3 class="title"><a id="note67"/>Note</h3><p>Note that this issue has been resolved in the latest version of VCM at the time of writing this book, that is, VCM 5.8.2. This is applicable only if you are upgrading to VCM 5.8.1.</p></div></div><div class="section" title="Getting ready"><div class="titlepage"><div><div><h2 class="title"><a id="ch09lvl2sec268"/>Getting ready</h2></div></div></div><p>When you select a machine on the VCM console, choose the Upgrade option, and run the job, it should fail while creating the service on the managed machines and throw an error as per the following code, which is present in <code class="literal">C:\Windows\CMAgent</code>.</p><pre class="programlisting">    ***  Installation Started 03/03/2016 3:57  ***&#13;
    Title: EcmComSocketListenerService&#13;
    Source: C:\windows\TEMP\GLB90C6.tmp | 03-03-2016 | 03:57:04 | 71680&#13;
    Rem Wise Error Number: 141&#13;
    Rem Function Name: EcmCreateService&#13;
    Rem Error Message: Caught an exception from wise : Call to &#13;
    EcmCreateService for service CSI Socket Listener failed with error code &#13;
    of 1072 : error code 141&#13;
    141&#13;
</pre></div><div class="section" title="How to do it..."><div class="titlepage"><div><div><h2 class="title"><a id="ch09lvl2sec269"/>How to do it...</h2></div></div></div><p>In the 5.8.1 release, VMware promoted the HTTP listener module, which stops the listener service before upgrading while the Collector is waiting for it. The Collector contacts the agent for the upgrade status when the listener is being upgraded. As a result, the collector receives a ping failed response, and it signals the collector to FAIL the upgrade job.</p><p>The following setting allows the collector to fall back to DCOM when the HTTP connection fails:</p><div class="orderedlist"><ol class="orderedlist arabic"><li class="listitem">Run the following query in the SQL management server while selecting VCM as the database:<pre class="programlisting">
<span class="strong"><strong>       UPDATE dbo.ecm_sysdat_configuration_values SET configuration_value = </strong></span>
<span class="strong"><strong>       '1' WHERE configuration_name = 'config_allow_http_failover_to_dcom' &#13;
</strong></span>
</pre></li><li class="listitem">Also, correct the module filename of <code class="literal">ECMSocketListenerService</code> using this query:<pre class="programlisting">
<span class="strong"><strong>       UPDATE dbo.ecm_sysdat_install_modules SET module_file_name =</strong></span>
<span class="strong"><strong>       'EcmComSocketListenerService6_6.exe' WHERE module_name = </strong></span>
<span class="strong"><strong>       'EcmComSocketListenerService'   AND module_version = '6.6' &#13;
</strong></span>
</pre></li><li class="listitem">Restart the SSRS and VCM collector service.</li></ol></div><p>After that, you can upgrade the agent from the console.</p></div></div>
<div class="section" title="Troubleshooting SCR download issues"><div class="titlepage"><div><div><h1 class="title"><a id="ch09lvl1sec93"/>Troubleshooting SCR download issues</h1></div></div></div><p>As you know, SCR is a tool that is used to synchronize patches for Linux/Unix operating systems from vendor sites to local repositories. Sometimes, the synchronization fails and can't download content from vendor sites.</p><div class="section" title="Getting ready"><div class="titlepage"><div><div><h2 class="title"><a id="ch09lvl2sec270"/>Getting ready</h2></div></div></div><p>We are able to log in to the RedHat portal with the same account, but the patch download fails with an error. When we try to synchronize patches with vendors (in this case, RedHat) from SCR, it throws an error, as shown in the following code:</p><pre class="programlisting">    Nov 19, 2015 9:11:32 AM com.lumension.scr.log.CommonsLogging error&#13;
    SEVERE: Error processing architecture X86_64&#13;
    com.lumension.scr.exception.AuthenticationFailedException: Failed to&#13;
    establish login session with RHN&#13;
            at&#13;
    com.lumension.scr.pojo.SCPackage.getAllPackageFiles(SCPackage.java:508)&#13;
            at&#13;
    com.lumension.scr.pojo.SCPackage.download(SCPackage.java:363)&#13;
            at  &#13;
    com.lumension.scr.client.StandaloneSCRepositoryClient.download &#13;
    (StandaloneSCRepositoryClient.java:596)&#13;
            at&#13;
    com.lumension.scr.client.StandaloneSCRepositoryClient.process&#13;
    (StandaloneSCRepositoryClient.java:492)&#13;
            at&#13;
    com.lumension.scr.client.StandaloneSCRepositoryClient.main&#13;
    (StandaloneSCRepositoryClient.java:644)&#13;
</pre><p>As it indicates an issue with login, the first suspect is, as always, the account used to synchronize the repository with RHN. We can log in with the same account on RHN, and if we try changing to another account, the problem still persists.</p></div><div class="section" title="How to do it..."><div class="titlepage"><div><div><h2 class="title"><a id="ch09lvl2sec271"/>How to do it...</h2></div></div></div><p>The resolution for this is as follows:</p><div class="orderedlist"><ol class="orderedlist arabic"><li class="listitem">Resynchronize the SCR Tool with the RedHat repository.</li><li class="listitem">Select the SCR Tool output folder and delete all of the <code class="literal">SystemId*.xml</code> files:<pre class="programlisting">
<span class="strong"><strong>       cd "PatchRepo/Repos"/unix &#13;
       rm SystemId*.xml</strong></span>
<span class="strong"><strong>       [root@scr unix]# pwd/opt/vcmpatches/unix[root@scr unix]# &#13;
       lsSystemId_5Server_i386.xml    &#13;
       SystemId_6Server_i386.xml</strong></span>
<span class="strong"><strong>SystemId_5Server_x86_64.xml  &#13;
       SystemId_6Server_x86_64.xml</strong></span>
</pre><p>Take a backup of the files by running the following command for each file:</p><pre class="programlisting">
<span class="strong"><strong>[root@scr unix]# cp SystemId_5Server_i386.xml &#13;
          SystemId_5Server_i386.xml.bak</strong></span>
<span class="strong"><strong>[root@scr unix]# rm -f *.xml</strong></span>
<span class="strong"><strong>[root@scr unix]# ls</strong></span>
<span class="strong"><strong>[root@scr unix]#</strong></span>
</pre><p>The path to the <code class="literal">unix</code> folder is located in the <code class="literal">properties</code> file and is defined using the <code class="literal">folder=value</code> parameter.</p><p>For example, <code class="literal">folder=/PatchRepo/Repos</code>.</p></li><li class="listitem">Run the replication process manually or allow it to run on schedule:<pre class="programlisting">
<span class="strong"><strong>       [root@scr unix]# cd /etc/cron.daily/ &#13;
       [root@scr cron.daily]# ./SCR</strong></span>
</pre></li><li class="listitem">The XML files will be created at the earlier location (<code class="literal">/PatchRepo/Repos</code>) and the synchronization will also start:<pre class="programlisting">
<span class="strong"><strong>       [root@scr unix]# pwd &#13;
       /opt/vcmpatches/unix &#13;
       [root@scr unix]# ls &#13;
       SystemId_5Server_i386.xml    SystemId_6Server_i386.xml &#13;
       SystemId_5Server_x86_64.xml  SystemId_6Server_x86_64.xml</strong></span>
</pre></li></ol></div></div><div class="section" title="How it works"><div class="titlepage"><div><div><h2 class="title"><a id="ch09lvl2sec272"/>How it works</h2></div></div></div><p>The real problem was that the source machine information was changed or deleted on the <span class="strong"><strong>Red Hat Network</strong></span> (<span class="strong"><strong>RHN</strong></span>).</p><p>When we delete the XML files and restart the synchronization, the machine information is updated again and we are allowed to download patches from RHN.</p></div></div>
<div class="section" title="Troubleshooting VCM console login failure"><div class="titlepage"><div><div><h1 class="title"><a id="ch09lvl1sec94"/>Troubleshooting VCM console login failure</h1></div></div></div><p>You are trying to log in to VCM and it throws an error: <span class="strong"><strong>Your ID is disabled</strong></span>.</p><div class="section" title="Getting ready"><div class="titlepage"><div><div><h2 class="title"><a id="ch09lvl2sec273"/>Getting ready</h2></div></div></div><p>You will need access to SQL server to resolve the issue.</p><div class="mediaobject"><img alt="Getting ready" src="graphics/image_09_011.jpg"/></div><p>Consider this: you do not have anyone who can help you enable the ID or, even worse, you were setting up the VCM and still haven't added anyone, so yours is the only account that can log in and make the necessary settings.</p><p>No worries; we have a solution.</p><p>You will need SQL Managemnt Studio and access to your SQL server that holds the VCM DB.</p></div><div class="section" title="How to do it..."><div class="titlepage"><div><div><h2 class="title"><a id="ch09lvl2sec274"/>How to do it...</h2></div></div></div><p>Follow these steps to unlock the user:</p><div class="orderedlist"><ol class="orderedlist arabic"><li class="listitem">Log in to the VCM SQL server and launch SQL Management Studio.<p>Select VCM as the database and run the first query:</p><pre class="programlisting">          select * from ecm_sysdat_logins &#13;
</pre><p>This will show all the users with their login IDs.</p></li><li class="listitem">Note the login ID for the user you were trying and run the following query:<pre class="programlisting">          update ecm_sysdat_logins set login_active = 1 where login_id = X &#13;
</pre><p><code class="literal">X</code> is the login ID of the user you noted earlier.</p></li></ol></div><p>The login is now enabled. Try logging in to the VCM console, and if you were the only administrator, start adding others.</p></div><div class="section" title="How it works"><div class="titlepage"><div><div><h2 class="title"><a id="ch09lvl2sec275"/>How it works</h2></div></div></div><p>VCM stores all the information about everything it does in the SQL database. In this case, we found that the account we were trying to log in to was locked and needed a reset.</p><p>After running the first SQL query, we checked the status of the account in the database, and as it was locked (that is, <code class="literal">login_active = 0</code>), we ran another query and enabled the account, that is, <code class="literal">login_active = 1</code>.</p><p>After that, we can log in to the VCM console.</p><p>It is recommended to have an AD group added to the VCM for administration purposes as described in the <span class="emphasis"><em>Managing users</em></span> recipe in <a class="link" href="ch07.html" title="Chapter 7. Maintenance of VCM">Chapter 7</a>, <span class="emphasis"><em>Maintenance of  VCM</em></span>.</p></div></div>
<div class="section" title="Troubleshooting vCenter and vCloud data collection issues"><div class="titlepage"><div><div><h1 class="title"><a id="ch09lvl1sec95"/>Troubleshooting vCenter and vCloud data collection issues</h1></div></div></div><p>The issue: when trying to collect data from vCenter and vCloud Director, the operation fails.</p><div class="section" title="Getting ready"><div class="titlepage"><div><div><h2 class="title"><a id="ch09lvl2sec276"/>Getting ready</h2></div></div></div><p>You should have the following problem: when you try to collect data from either vCenter or vCloud Director, it either fails or you are not able to see any details in the VCM console, under <span class="strong"><strong>Console </strong></span>| <span class="strong"><strong>Virtual Environments</strong></span>.</p></div><div class="section" title="How to do it..."><div class="titlepage"><div><div><h2 class="title"><a id="ch09lvl2sec277"/>How to do it...</h2></div></div></div><p>There could be few reasons for this.</p><p>The details of the error or failure can be seen with the <span class="strong"><strong>EcmDebugEventViewer</strong></span> tool or in <span class="strong"><strong>Job manager | History</strong></span>; based on the error codes, you can try any or all of the following solutions:</p><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc">The credentials set while configuring vCenter and/or vCloud may not be right; try changing them.</li><li class="listitem" style="list-style-type: disc">The certificate thumbprint set while configuring vCenter and/or vCloud may not be correct.<p>If this is the case, then under <span class="strong"><strong>Job manager | History</strong></span>, VCM will show the configured thumbprint and expected thumbprint; you can copy the expected thumbprint. Make sure it's correct, and then, change the wrong certificate thumbprint.</p></li><li class="listitem" style="list-style-type: disc">As you know, we have filter sets, and most of the time, we choose the default filter set for performing collection. Validate the default filter set and see whether it has all the vCenter and/or vCloud-related filters present; if not, add them and perform a collection.<p>The setting is available under <span class="strong"><strong>Administration</strong></span>|<span class="strong"><strong>Collection Filters</strong></span>| <span class="strong"><strong>Filter Sets</strong></span>. Select <span class="strong"><strong>Default Filter</strong></span>, click on <span class="strong"><strong>Edit</strong></span>, and add any missing vCenter and/or vCloud filters, as shown in the following screenshot.</p><p>You can define a filter to limit the filters with criteria like in the screenshot:</p><div class="mediaobject"><img alt="How to do it..." src="graphics/image_09_012.jpg"/></div><p>This will limit the filters to only vCenter, vCloud, and vShield. Make sure these are part of the default filter set; if not, then use the down arrow to add all of them to the default filter, and click on <span class="strong"><strong>Next</strong></span>. Complete the wizard and then perform a collection for vCenter, vCloud, and/or vShield. It will work.</p><div class="mediaobject"><img alt="How to do it..." src="graphics/image_09_013.jpg"/><div class="caption"><p>Modifying the default filter set</p></div></div></li></ul></div></div><div class="section" title="How it works"><div class="titlepage"><div><div><h2 class="title"><a id="ch09lvl2sec278"/>How it works</h2></div></div></div><p>VCM uses filter sets, and those include filters to collect data from various managed objects. Filters define what data needs to be collected, such as operating system name, some registry value, or file permissions. There are thousands of filters available, and not all filters are used in one filter set. We have a default filter set, which includes filters for all the managed machine types, such as vCenter, vCloud Director, Windows, and Linux. Sometimes, certain required filters go missing from the filter set. We then need to add them back so that the next time we use them to collect details, VCM will know what data needs to be collected.</p><p>In this troubleshooting recipe, we did the same thing and added missing filters to the default filter set.</p></div></div>
<div class="section" title="Troubleshooting the Recommended Action: Investigate Issue Linux server patch error"><div class="titlepage"><div><div><h1 class="title"><a id="ch09lvl1sec96"/>Troubleshooting the Recommended Action: Investigate Issue Linux server patch error</h1></div></div></div><p>When trying to patch a Linux server, you might get a message saying <span class="strong"><strong>Recommended Action: Investigate Issue</strong></span> and hence are not able to patch the server.</p><div class="section" title="Getting ready"><div class="titlepage"><div><div><h2 class="title"><a id="ch09lvl2sec279"/>Getting ready</h2></div></div></div><p>The error will look like the following screenshot. The recommended action is <span class="strong"><strong>Investigate Issue</strong></span>:</p><div class="mediaobject"><img alt="Getting ready" src="graphics/B05400_09_15.jpg"/></div></div><div class="section" title="How to do it..."><div class="titlepage"><div><div><h2 class="title"><a id="ch09lvl2sec280"/>How to do it...</h2></div></div></div><div class="orderedlist"><ol class="orderedlist arabic"><li class="listitem">To resolve the issue, follow these steps on the VCM database:</li><li class="listitem">Run this SQL query to know the <code class="literal">machine_id</code> for which it shows <span class="strong"><strong>Investigate Issue</strong></span>:<pre class="programlisting">       select machine_id, machine_name from ecm_dat_machines where &#13;
       machine_name = '&lt;Machine Name&gt;' &#13;
</pre></li><li class="listitem">The machine name is the name of the service creating issues.</li><li class="listitem">Update the timestamp for that <code class="literal">machine_id</code> value using the following query:<pre class="programlisting">       update ecm_sysdat_imd_machine_timestamp_xref set timestamp = 0 where &#13;
       machine_id = &lt;&gt; &#13;
</pre></li><li class="listitem">Carry out another assessment on that machine, and it will tell you that patches are required.</li></ol></div></div></div>
<div class="section" title="Troubleshooting not being able to see any jobs on the console"><div class="titlepage"><div><div><h1 class="title"><a id="ch09lvl1sec97"/>Troubleshooting not being able to see any jobs on the console</h1></div></div></div><p>The issue: VCM is not running or showing any jobs. When jobs are started manually, they are not being executed, rendering VCM close to useless.</p><div class="section" title="Getting ready"><div class="titlepage"><div><div><h2 class="title"><a id="ch09lvl2sec281"/>Getting ready</h2></div></div></div><p>When we run any job such as data collection, patching, or compliance checks, they might not start and be absent from the <span class="strong"><strong>Jobs</strong></span> window. Because of this, there is no update in the VCM database, you can't patch a managed machine, and compliance checks can't be executed.</p><p>We need access to the SQL server hosting the VCM database.</p></div><div class="section" title="How to do it..."><div class="titlepage"><div><div><h2 class="title"><a id="ch09lvl2sec282"/>How to do it...</h2></div></div></div><p>Here is the resolution. To determine whether the SQL Server Service Broker is enabled, run the following script in SQL Server using SQL Server Management Studio:</p><div class="orderedlist"><ol class="orderedlist arabic"><li class="listitem">Launch SQL Server Management Studio and create a new query, as follows.<pre class="programlisting">       USE master;&#13;
       GO&#13;
       SELECT name, is_broker_enabled FROM sys.databases;&#13;
       GO &#13;
</pre></li><li class="listitem">Check whether the value of <code class="literal">is_broker_enabled</code> is <code class="literal">0</code> (zero) for the VCM database, and re-enable the SQL Server Service Broker by running the following script in SQL Server:<pre class="programlisting">       USE master;&#13;
       GO&#13;
       ALTER DATABASE {db-name} SET ENABLE_BROKER WITH ROLLBACK IMMEDIATE;      &#13;
       GO &#13;
</pre></li></ol></div><p>Here, <code class="literal">db-name</code> is the name of your VCM database. The database name is VCM by default.</p></div><div class="section" title="How it works"><div class="titlepage"><div><div><h2 class="title"><a id="ch09lvl2sec283"/>How it works</h2></div></div></div><p>With Service Broker, a feature in Microsoft SQL Server, internal or external processes can send and receive guaranteed, asynchronous messages. Messages can be sent to a queue in the same database as the sender, to another database in the same SQL Server instance, or to another SQL Server instance either on the same server or on a remote server. We fixed the broken broker service on the VCM database so that it can function again.</p></div></div>
<div class="section" title="Troubleshooting not being able to see the Monthly option on the Schedule Job page&#xA0;"><div class="titlepage"><div><div><h1 class="title"><a id="ch09lvl1sec98"/>Troubleshooting not being able to see the Monthly option on the Schedule Job page </h1></div></div></div><p>Sometimes, it may happen that when we are trying to schedule something in VCM, when we are about to complete the wizard, on the schedule page, the <span class="strong"><strong>Monthly </strong></span>option is disabled (grayed out), and we can't set a monthly schedule.</p><div class="section" title="Getting ready"><div class="titlepage"><div><div><h2 class="title"><a id="ch09lvl2sec284"/>Getting ready</h2></div></div></div><p>The <span class="strong"><strong>Monthly</strong></span> scheduling option is disabled, as shown here<span class="strong"><strong>:</strong></span></p><div class="mediaobject"><img alt="Getting ready" src="graphics/image_09_015.jpg"/></div></div><div class="section" title="How to do it..."><div class="titlepage"><div><div><h2 class="title"><a id="ch09lvl2sec285"/>How to do it...</h2></div></div></div><p>The monthly scheduling option is <span class="strong"><strong>disabled</strong></span> if the time zone setting of the VCM user launching the console is different from the VCM database's time zone setting.</p><p>Make sure the time zone of the machine that is used to connect to the VCM server is the same as the VCM database server's.</p></div></div></body></html>