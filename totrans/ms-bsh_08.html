<html><head></head><body>
        <section>

                            <header>
                    </header><h1 class="header-title" id="calibre_pb_0">We Want to Chat</h1>
                
            
            <article>
                
<p class="calibre1">In the previous chapter, we just had a dive through the planning and coding of a Nagios plugin. We studied the bits needed to understand what is a plugin, what is expected from it, and how to integrate it with the monitoring system; and this is because creating a script or program is not just the coding itself: this is the last step of a long and complex workflow.</p>
<p class="calibre1"><span><span>Now, we will venture into something a bit different, creating a small client to send information to a Slack channel. This will allow us to touch on some new topics, such as JSON, and have a look at how to interact with a cloud-based service. We will not write a fully-fledged client with the capability to read and write, but just the sending bit, since Bash is not the optimal tool to build a whole interactive client. The goal here is to write a tool that we could use to send notifications to a channel so that we can, for instance, notify the members of the channel of the outcome of a task, a cronjob, and so on.</span></span></p>


            </article>

            
        </section>
    

        <section>

                            <header>
                    </header><h1 class="header-title" id="calibre_pb_0">The Slack messaging service</h1>
                
            
            <article>
                
<p class="calibre1"><span><span><strong class="calibre2">Slack</strong> is the acronym of <span><span><strong class="calibre2">Searchable Log of All Conversation and Knowledge</strong> </span></span><span><span><span>and it is a collaboration tool widely used by small and large teams to share information, documentation, and ideas. Slack, at a glance, offers the following:</span></span></span></span></span></p>
<ul class="calibre12">
<li class="calibre13"><span><span><strong class="calibre2">Chat rooms:</strong><span><span><span> Public or private, the chat rooms allow team mates to discuss any topic without interfering with other people. A channel is persistent, can have a topic, and anyone invited can take part in it.</span></span></span></span></span></li>
<li class="calibre13"><span><span><strong class="calibre2">Direct messages:</strong><span><span><span> People can send direct messages to other people or groups so that they can have private direct conversations.</span></span></span></span></span></li>
<li class="calibre13"><span><span><strong class="calibre2">Integrated searches:</strong><span><span><span> Everything in Slack is searchable, from the messages shared in a chat, to the files uploaded to it, and to the people we dealt with; and this is probably one of the most interesting features of this platform.</span></span></span></span></span></li>
<li class="calibre13"><span><span><strong class="calibre2">Calls:</strong><span><span><span> Direct or group calls can be made from inside a channel or on a direct message; and this is without the need of an external application, so there is no need to leave the platform.</span></span></span></span></span></li>
<li class="calibre13"><span><span><strong class="calibre2">Teams:</strong><span><span><span> Anyone can join a team using a URL or invitation provided by a team owner; and this is probably the most community-like feature of this tool.</span></span></span></span></span></li>
<li class="calibre13"><span><span><strong class="calibre2">Integration with external services:</strong><span><span><span> Slack can connect to a variety of external services so to enhance its offering, from Google Drive to Dropbox, from GitHub to Zendesk, just to name a few.</span></span></span></span></span></li>
<li class="calibre13"><span><span><strong class="calibre2">Clients:</strong><span><span><span> The platform has plenty of clients, native or via web, for many platforms such as Windows, macOS, Linux, Android, just to name some, so we do not need another client.</span></span></span></span></span></li>
</ul>
<p class="calibre1">So we want to interact with Slack by sending messages to one channel and having them displayed nicely. The first step will be to create a new team at the URL:</p>
<p class="calibre1"><a href="https://slack.com/" target="_blank" class="calibre4">https://slack.com/</a></p>
<div class="packt_figref"><span><span><img class="image-border2" src="../images/00020.jpeg"/></span></span></div>
<div class="packt_figref"><span><span>Creating a new team</span></span></div>
<p class="cdpalignleft"><span><span>In our first step, we are going to create a new team. </span></span><span><span>We have to do all the usual stuff, insert an email, the confirmation code, and choose a team URL:</span></span></p>
<div class="packt_figure"><span><span><img class="image-border2" src="../images/00021.jpeg"/></span></span></div>
<p class="cdpalignleft"><span><span>A team URL will gather people with shared interests, </span></span><span><span>invite some friend if you are done; your team is ready to fill the ranks!</span></span></p>
<div class="packt_figure"><span><span><img class="image-border2" src="../images/00022.jpeg"/><br class="title-page-name"/></span></span></div>
<p class="calibre1"><span><span>We are ready to share our messages. </span></span><span><span>Once you are done creating the team space, we will have two default channels available:</span></span></p>
<pre class="codepackt">
<strong class="calibre2">#general<br class="title-page-name"/></strong><strong class="calibre2">#random</strong>
</pre>
<p class="cdpalignleft"><span><span>We can use the default channel or create a new one; in our case, we will create a brand new public channel called </span></span><kbd class="calibre9">#test</kbd>.</p>
<p class="cdpalignleft"><span><span>There we will send there all the messages created by our script and conveyed by a WebHook. Now, we have introduced a new term, WebHook, and this is crucial to our script, since it is a method we use to interact with Slack. So, it is better for us to stop a moment and deepen the concept of WebHook for Slack</span></span></p>


            </article>

            
        </section>
    

        <section>

                            <header>
                    </header><h1 class="header-title" id="calibre_pb_0">Slack WebHooks</h1>
                
            
            <article>
                
<p class="calibre1"><span><span>What is a WebHook? We could define it as a method to make some web pages reactive to user input based on a simple HTTP POST method to support a user-defined HTTP callback. Still a bit obscure, isn't it? Let's put it this way: Slack has some endpoints, sensitive URLs; and when you post something through HTTP to endpoints, you actually communicate with Slack. What makes these WebHook interesting is that they are stateless, since they do not rely on a continuously open connection to the service; and you just ping Slack whenever you need to post or retrieve some pieces of information. Slack supports two different kinds of WebHooks:</span></span></p>
<ul class="calibre12">
<li class="calibre13"><span><span><strong class="calibre2">Incoming WebHook:</strong> This is the URL that we will be posting to when we want some messages to appear on our test channel</span></span></li>
<li class="calibre13"><span><span><strong class="calibre2">Outgoing WebHook:</strong> This is the URL that Slack uses to notify us of some events in a channel</span></span></li>
</ul>
<p class="calibre1">We will be using the Incoming WebHook for our notification script. So, what will we need? We will need the following things:</p>
<ul class="calibre12">
<li class="calibre13"><span>Slack incoming WebHook linked to one of our channels.</span></li>
<li class="calibre13">A JSON holding the message we want to post.</li>
<li class="calibre13">An application, which will connect to the URL and post the JSON. It will be our script.</li>
</ul>
<ol class="calibre15">
<li value="1" class="calibre13"><span><span>Our first task will be to create a new incoming WebHook and link it to our test channel. As the administrator of the team login, we have to log in at </span></span><span><span><a href="https://my.slack.com/services/new/incoming-webhook/" target="_blank" class="calibre4">https://my.slack.com/services/new/incoming-webhook/</a>. </span></span><span><span>And from the dropdown menu, we must select our test channel as shown here:</span></span></li>
</ol>
<div class="packt_figure"><span><span><img class="image-border14" src="../images/00023.jpeg"/><br class="title-page-name"/></span></span></div>
<ol start="2" class="calibre15">
<li value="2" class="calibre13">Select the <span>#test</span> channel from the drop-down menu.</li>
</ol>
<ol start="3" class="calibre15">
<li value="3" class="calibre13">Now, let's click on the <span>Add Incoming WebHooks Integration</span> button; and we are led to the Incoming WebHooks page, where we will find the URL that we have to call to send a message to our test channel.</li>
</ol>
<div class="packt_figure"><span><span><img class="image-border15" src="../images/00024.jpeg"/></span></span></div>
<p class="calibre1"> </p>
<ol start="4" class="calibre15">
<li value="4" class="calibre13">In the Incoming WebHooks page, you can <span>find </span> your newly created WebHook.</li>
</ol>
<div class="packt_infobox"><span class="calibre30"><span class="calibre30">In our case, the WebHook has the following URL: </span></span><span class="calibre30"><span class="calibre30"><a href="https://hooks.slack.com/services/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" target="_blank" class="calibre31">https://hooks.slack.com/services/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</a>.</span></span></div>
<p class="calibre1">As explained earlier, we have two options to send a message through this WebHook:</p>
<ul class="calibre12">
<li class="calibre13">As a JSON string in the payload parameter of a POST request</li>
<li class="calibre13">As a JSON string in the body of a POST request</li>
</ul>
<p class="calibre1">So, JSON is something crucial for our messaging system, but what exactly is a JSON?</p>


            </article>

            
        </section>
    

        <section>

                            <header>
                    </header><h1 class="header-title" id="calibre_pb_0">What is a JSON?</h1>
                
            
            <article>
                
<p class="calibre1"><span><span><strong class="calibre2">JSON</strong>, or <strong class="calibre2">JavaScript Object Notation</strong>, is an open, standard format (ECMA-404) widely used to exchange data between applications. Created in 2007 as a subset of the JavaScript programing language, it quickly became adopted by many languages as a means to deliver data regardless of the language of the sending and receiving applications to be a neutral conveyor. We can find a JSON file modeled on two different structures.</span></span></p>
<p class="calibre1"><span><span>An object composed by name: value pairs, opened and closed by a bracket with each name separated from the corresponding value by a colon and each pair separated by a comma, such as the following example:</span></span></p>
<pre class="codepackt">
{<br class="title-page-name"/>"name" : "Janet",<br class="title-page-name"/>"state" : "California",<br class="title-page-name"/>"cake" : "Toffee sticky pudding"<br class="title-page-name"/>}
</pre>
<p class="calibre1"><span><span>An ordered list of values inside an array opened and closed by a square bracket and the values separated by a comma: </span></span><kbd class="calibre9">[ "1", "2", "3"]</kbd>.</p>
<p class="calibre1"><span><span>A value in JSON can be a number, object, array, string, true, false, or null.</span></span></p>
<p class="calibre1"><span><span>So, JSON will be the format that we will use to transmit our messages to the channel using the WebHook, and it will be structured in an object made of name:value pairs. The simplest message in Slack would bear a simple <kbd class="calibre9">"text"</kbd> keyword as the name part of the JSON and the message to deliver as its value:</span></span></p>
<pre class="codepackt">
<strong class="calibre2">{<br class="title-page-name"/>    "text": "This is the first line of a message This is <br class="title-page-name"/>             the second line."<br class="title-page-name"/>}</strong>
</pre>
<p class="calibre1"><span><span>Now that we have our first message formatted into a neat JSON, we must proceed to deliver this content to our <kbd class="calibre9">#test</kbd> channel.</span></span></p>


            </article>

            
        </section>
    

        <section>

                            <header>
                    </header><h1 class="header-title" id="calibre_pb_0">Do you like cURLing?</h1>
                
            
            <article>
                
<p class="calibre1"><span><span>One of the easiest ways to post JSON content is to use an external utility, such as a cURL, whose task is to transfer data over URLs. We have two ways to transfer data:</span></span></p>
<ul class="calibre12">
<li class="calibre13"><span><span>Directly as a JSON in the body of an HTTP POST request, with a specific content-type header, and this is the preferred method</span></span></li>
<li class="calibre13"><span><span>As a URL-escaped JSON inside the payload parameter as part of the POST body</span></span></li>
</ul>
<p class="calibre1"><span><span>In the first case, we are going to use cURL with the following bits:</span></span></p>
<pre class="codepackt">
<strong class="calibre2">-X POST</strong>
</pre>
<p class="calibre1"><span><span>It specifies the method to use to communicate with an HTTP server. The default method is <kbd class="calibre9">GET</kbd> , but here, we have to <kbd class="calibre9">POST</kbd> some information:</span></span></p>
<pre class="codepackt">
<strong class="calibre2">-H 'Content-type: application/json' </strong>
</pre>
<p class="calibre1"><span><span>This option allows us to send extra headers to the HTTP server. In our case, we are sending a <span><span><strong class="calibre2">Multipurpose Internet Mail Extensions</strong> (<strong class="calibre2">MIME</strong>) type, informing the Slack server that it has to expect a JSON (rfc4627) application type object in the body:</span></span></span></span></p>
<pre class="codepackt">
<strong class="calibre2">--data '{"text":"This is our first message,.n which continues on <br class="title-page-name"/></strong><strong class="calibre2">another line."}' </strong>
</pre>
<p class="calibre1"><span><span>The</span></span> <kbd class="calibre9">--data</kbd> <span><span>option allows us to send the JSON object in the body of the <kbd class="calibre9">POST</kbd> request so that it can be passed to the HTTP server to be processed:</span></span></p>
<p class="calibre1"><a href="https://hooks.slack.com/services/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" target="_blank" class="calibre4"><span><span>https://hooks.slack.com/services/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</span></span></a></p>
<p class="calibre1"><span><span>This is the final bit: the address of the WebHook that <kbd class="calibre9">cURL</kbd> will call to make its <kbd class="calibre9">POST</kbd> request. Now, we have all we need, so it's just a matter of creating our command line. Install it if you do not have it already; the <kbd class="calibre9">cURL</kbd> utility and issue the following command on a single line:</span></span></p>
<pre class="codepackt">
<strong class="calibre2">cURL -X POST -H 'Content-type: application/json' --data <br class="title-page-name"/>'{<br class="title-page-name"/>"text":"This is a line of text.nAnd this is another one.<br class="title-page-name"/>"}'</strong><strong class="calibre2">  <br class="title-page-name"/>https://hooks.slack.com/services/T4P7TPSP9/B4ND2E2E4/<br class="title-page-name"/>lIzhH84lg21ZJ0zdaeQHZ7ls</strong>
</pre>
<p class="calibre1">And here is our first message to the channel:</p>
<div class="packt_figure"><span><span><img class="image-border2" src="../images/00025.jpeg"/><br class="title-page-name"/></span></span></div>
<div class="packt_figref"><span><span>A simple cURL gave us the first message to the channel.</span></span></div>
<p class="calibre1"><span><span>The second way to send a message with <kbd class="calibre9">cURL</kbd> is to have its URL encoded inside the payload parameter of the <kbd class="calibre9">POST</kbd> body. Your URL will become a messy string filled by a bunch of percentage characters, but it is more of a traditional way, so you could feel more confident using it.<br class="title-page-name"/>
To send a JSON file inside the payload parameter, we need the following bits:</span></span></p>
<pre class="codepackt">
<strong class="calibre2">-X POST </strong>
</pre>
<p class="calibre1">This specifies the method to use to communicate with an HTTP server. The default method is <kbd class="calibre9">GET</kbd> , but here, we have to <kbd class="calibre9">POST</kbd> some information:</p>
<pre class="codepackt">
<strong class="calibre2">--data-URLencode 'payload={"text":"This is our second message."}'</strong>
</pre>
<p class="calibre1">This URL encodes our JSON, so it can be posted. The structure of the data part is a bit different because to be CGI compliant; it must begin with a keyword: </p>
<p class="calibre1"><a href="https://hooks.slack.com/services/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" target="_blank" class="calibre4">https://hooks.slack.com/services/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</a></p>
<p class="calibre1">Finally, we have the URL, which is the same as for the first method. Let's assemble our command line and try it out:</p>
<pre class="codepackt">
<strong class="calibre2">cURL -X POST  --data-URL<br class="title-page-name"/>encode 'payload={"text":"This is our second message."}' <br class="title-page-name"/>https://hooks.slack.com/services/T4P7TPSP9/B4ND2E2E4/lI<br class="title-page-name"/>zhH84lg21ZJ0zdaeQHZ7ls</strong>
</pre>
<p class="calibre1"><img class="image-border16" src="../images/00026.jpeg"/></p>
<div class="packt_figref"><span><span>Creating a new team.</span></span></div>
<p class="calibre1"><span><span>That's it, our second message is being displayed on the channel. It is still in a basic form without any whistles and bells, but it does its job and helps us in understanding how to interact with the Slack server. Anyway, basic is fine, but why not try to embellish our conversations with some special effects?</span></span></p>


            </article>

            
        </section>
    

        <section>

                            <header>
                    </header><h1 class="header-title" id="calibre_pb_0">Formatting our messages</h1>
                
            
            <article>
                
<p class="calibre1"><span><span>We can add some style to our messages, from text properties to links and buttons, so that they can become something more than a simple bunch of text. Actually, modifying by hand all the payloads to check what combinations of attributes best suits your messages can be too much hassle, but Slack helps us with an online <em class="calibre20">Message Builder</em> that lets you customize and preview your messages without the need to post it anywhere. Just head to your browser at  <a href="https://api.slack.com/docs/messages/builder" target="_blank" class="calibre4">https://api.slack.com/docs/messages/builder,</a> and let's start having fun:</span></span></p>
<div class="packt_figure"><span><span><img class="image-border17" src="../images/00027.jpeg"/></span></span></div>
<div class="packt_figure"><img class="image-border18" src="../images/00028.jpeg"/></div>
<div class="packt_figref"><span><span><span><span><span>The payload editor lets you try your message before sending it.</span></span></span></span></span></div>
<p class="calibre1"><span><span>Inside the upper box, we can forge our payload as we wish and preview it in the lower box, so let's see some of the more interesting bits that we can add to our messages:</span></span></p>
<ul class="calibre12">
<li class="calibre13"><span><span><strong class="calibre2">Bold:</strong> Well, this is a classic. You can turn any strings of text in bold simply by wrapping it between two asterisks, try out this payload:</span></span></li>
</ul>
<pre class="calibre21">
{<br class="title-page-name"/>    "text": "This is a *bold string* and this a *bold* word"<br class="title-page-name"/>}
</pre>
<div class="packt_figure"><span><span><img class="image-border19" src="../images/00029.jpeg"/><br class="title-page-name"/></span></span></div>
<p class="calibre27"><span><span><span><span><span>Here is how our bold lines appear in the <span>Message Builder</span>.</span></span></span></span></span></p>
<ul class="calibre12">
<li class="calibre13"><span><span><strong class="calibre2">Italics:</strong> This stresses the importance of a word or a sentence, and you can get this effect simply by wrapping a string between the two underlines:</span></span></li>
</ul>
<pre class="calibre21">
{<br class="title-page-name"/>    "text": "This is a _string in italics_."<br class="title-page-name"/>}

</pre>
<ul class="calibre12">
<li class="calibre13"><span><span><strong class="calibre2">Code:</strong> If you are writing some text that belongs to a command line or a some kind of code, you can enclose it between to back tickles and have it outstanding:</span></span></li>
</ul>
<pre class="calibre21">
{<br class="title-page-name"/>    "text": "We can use the code attribute to write some code    <br class="title-page-name"/>             like:n`x=y+1`"<br class="title-page-name"/>}
</pre>
<div class="packt_figure"><span><span><img class="image-border20" src="../images/00030.jpeg"/></span></span></div>
<p class="calibre27"><span><span><span><span><span>Here is how your code is shown in the channel.</span></span></span></span></span></p>
<ul class="calibre12">
<li class="calibre13"><span><span><strong class="calibre2">Code block:</strong> But how do you enclose a <kbd class="calibre9">multi line</kbd> code block? Let's see:</span></span></li>
</ul>
<pre class="calibre21">
{<br class="title-page-name"/>    "text": "We can use the block code attribute to write some <br class="title-page-name"/>     multi line code like:n```y=1nx=y+1nx=2```"<br class="title-page-name"/>}
</pre>
<div class="packt_figure"><span><span><img class="image-border21" src="../images/00031.jpeg"/></span></span></div>
<p class="calibre27"><span><span><span><span><span>A <kbd class="calibre9">multi line</kbd> code block appears a little different compare to a single line code string.</span></span></span></span></span></p>
<ul class="calibre12">
<li class="calibre13"><span><span><strong class="calibre2">URL linking:</strong> You can insert clickable links in a message by enclosing the URL in <kbd class="calibre9">&lt;&gt;</kbd>. You can use two different ways to insert a link:</span></span>
<ul class="calibre23">
<li class="calibre13"> Just p<span><span>ut the link itself surrounded by <kbd class="calibre9">&lt;&gt;</kbd>: </span></span><kbd class="calibre9">&lt;http://www.packtpub.com&gt;</kbd></li>
<li class="calibre13">Add to the previous syntax  <kbd class="calibre9">"|linked"</kbd> to make the linked string referring to the URL called <kbd class="calibre9">&lt;http://www.zarrelli.org|this&gt;"</kbd></li>
</ul>
</li>
</ul>
<p class="calibre27">So, our payload with both syntaxes could well be this:</p>
<pre class="calibre21">
{<br class="title-page-name"/>    "text": "This is a web link &lt;http://www.packtpub.com&gt; and <br class="title-page-name"/>          &lt;http://www.zarrelli.org|this too&gt;"<br class="title-page-name"/>}
</pre>
<div class="packt_figure"><span><span><img class="image-border22" src="../images/00032.jpeg"/></span></span></div>
<p class="calibre1"><span><span><span><span><span>We have two different ways to link a URL:</span></span></span></span></span></p>
<ul class="calibre12">
<li class="calibre13"><span><span><strong class="calibre2">Email address linking:</strong> In a way similar to URL linking, just surround the email link and a <kbd class="calibre9">"|linked"</kbd> by <kbd class="calibre9">&lt;&gt;</kbd>:</span></span></li>
</ul>
<pre class="calibre21">
{<br class="title-page-name"/>    "text": "Just email the &lt;mail-<br class="title-page-name"/>to:giorgio.zarrelli@gmail.com|author&gt;."<br class="title-page-name"/>}
</pre>
<div class="packt_figure"><span><span><img class="image-border23" src="../images/00033.jpeg"/><br class="title-page-name"/></span></span></div>
<p class="calibre27"><span><span><span><span><span>Click on the highlighted word, and your email client will fire up with the email address that is filled in as the recipient.</span></span></span></span></span></p>
<ul class="calibre12">
<li class="calibre13"><span><span><strong class="calibre2">Date:</strong> We can format a date in your message using a Unix epoch timestamp and some selector to modify its appearance. We can optionally link a URL, but we always have to provide some fallback text to be displayed to older clients in case the time token conversion fails. The keyword to you in this case is <kbd class="calibre9">&lt;!date&gt;</kbd>, but with a tad more complex syntax:</span></span></li>
</ul>
<pre class="calibre21">
{<br class="title-page-name"/>    "text": "&lt;!date^unix_timestamp^ Some optional text {date_selector}|Fallback text&gt;"<br class="title-page-name"/>}
</pre>
<p class="calibre27"><span><span>We have a bunch of different selectors available to modify how dates and times will appear in the channel:</span></span></p>
<ul class="calibre12">
<li class="calibre13"><span><span><strong class="calibre2"><kbd class="calibre9">{date}</kbd>:</strong> Your date will appear as classic <em class="calibre20">March 26th</em>, so try out the following payload:</span></span></li>
</ul>
<pre class="calibre21">
{<br class="title-page-name"/>    "text": "&lt;!date^1490531695^ {date}|Fallback&gt;"<br class="title-page-name"/>}
</pre>
<p class="calibre27"><span><span>So, our <kbd class="calibre9">cURL</kbd> line would be:</span></span></p>
<pre class="calibre21">
cURL -X POST -H 'Content-type: application/json' --data <br class="title-page-name"/>'{"<br class="title-page-name"/>text": <br class="title-page-name"/>"&lt;!date^1490531695^ {date}|Fallback&gt;"<br class="title-page-name"/>}' https://hooks.slack.com/services/T4P7TPSP9/B4ND2E2E4/<br class="title-page-name"/>lIzhH84lg21ZJ<br class="title-page-name"/>0zdaeQHZ7ls
</pre>
<div class="packt_figure"><span><span><img class="image-border2" src="../images/00034.jpeg"/><br class="title-page-name"/></span></span></div>
<p class="calibre1"><span><span><span><span><span>Here is how our messages will appear in the channel:</span></span></span></span></span></p>
<ul class="calibre12">
<li class="calibre13"><span><span><strong class="calibre2"><kbd class="calibre9">{date_short}</kbd></strong>:<span> As the name states, this is an even more compact <kbd class="calibre9">"Mar 26"</kbd></span></span></span></li>
<li class="calibre13"><span><span><strong class="calibre2"><kbd class="calibre9">{date_long}</kbd></strong>: <span> This gives you an extended date called <kbd class="calibre9">"Sunday, March 26th"</kbd></span></span></span></li>
<li class="calibre13"><span><span><strong class="calibre2"><kbd class="calibre9">{date_pretty}</kbd></strong>:<span> This displays the date as <kbd class="calibre9">{date}</kbd>, but it uses <kbd class="calibre9">"yesterday</kbd>, <kbd class="calibre9">"today"</kbd> or <kbd class="calibre9">"tomorrow"</kbd> when it fits</span></span></span></li>
<li class="calibre13"><span><span><strong class="calibre2"><kbd class="calibre9">{date_short_pretty}</kbd></strong>:<span> This displays the date as <kbd class="calibre9">{date_short}</kbd>, but it uses <kbd class="calibre9">"yesterday</kbd>, <kbd class="calibre9">"today"</kbd> , or <kbd class="calibre9">"tomorrow"</kbd> when it fits</span></span></span></li>
<li class="calibre13"><span><span><strong class="calibre2"><kbd class="calibre9">{date_long_pretty}</kbd></strong>: This <span>displays the date as <kbd class="calibre9">{date_long}</kbd>, but it uses <kbd class="calibre9">"yesterday</kbd>, <kbd class="calibre9">"today"</kbd> , or <kbd class="calibre9">"tomorrow"</kbd> when it fits</span></span></span></li>
<li class="calibre13"><span><span><strong class="calibre2"><kbd class="calibre9">{time}</kbd></strong>:<span> This displays the time in a 12-hour format, and in our example, it is <kbd class="calibre9">1:34 PM</kbd>; but if the client is set on a 24-hour format, it would be displayed as <kbd class="calibre9">13:34</kbd></span></span></span></li>
<li class="calibre13"><span><span><strong class="calibre2"><kbd class="calibre9">{time_secs}</kbd></strong>:<span> This displays the time to the seconds bit in a 12-hour format <kbd class="calibre9">1:34:55 PM</kbd>; but if the client is set on a 24-hour format, it would be displayed as <kbd class="calibre9">13:34:55</kbd></span></span></span></li>
</ul>
<p class="calibre1"><span><span>We can also add a URL to the date so that when you click on the date/time, you will be brought the website pointed as follows:</span></span></p>
<pre class="codepackt">
{<br class="title-page-name"/>    "text": <br class="title-page-name"/>"&lt;!date^1490531695^{date}^http://www.packtpub.com|Fallback&gt;"<br class="title-page-name"/>}
</pre>
<p class="calibre1"><span><span>Obviously, you can mix the formatter to have a more meaningful message as follows:</span></span></p>
<pre class="codepackt">
{<br class="title-page-name"/>    "text": "&lt;!date^1490531695^Let's meet on {date} at <br class="title-page-name"/>{time}|Meeting info&gt;"<br class="title-page-name"/>}
</pre>
<p class="calibre1"><span><span>And the complete <kbd class="calibre9">cURL</kbd> line would be as follows:</span></span></p>
<pre class="codepackt">
cURL -X POST -H 'Content-type: application/json' --data '{"text": <br class="title-page-name"/>"&lt;!date^1490531695^Let's meet on {date} at {time}|Meeting info&gt;"}' https://hooks.slack.com/services/T4P7TPSP9/B4ND2E2E4/lIzhH84lg21ZJ<br class="title-page-name"/>0zdaeQHZ7ls
</pre>
<p class="calibre1"><span><span>Apart from the dates, we can use some special commands in your messages to get our audience to head up and pay attention to us:</span></span></p>
<ul class="calibre12">
<li class="calibre13"><span><span><strong class="calibre2"><kbd class="calibre9">&lt;!here&gt;</kbd>:</strong> This will notify all our team members in the channel who are active:</span></span></li>
</ul>
<pre class="calibre21">
{<br class="title-page-name"/>  "text": "&lt;!here&gt;&lt;!date^1490531695^{date}^http://www.packtpub.com|Fallback&gt;"<br class="title-page-name"/>}
</pre>
<ul class="calibre12">
<li class="calibre13"><span><span><strong class="calibre2"><kbd class="calibre9">&lt;!channel&gt;</kbd>:</strong> <span><span>This will notify all our team members in the channel regardless of their status. A notify icon will appear close to the channel name.</span></span></span></span></li>
<li class="calibre13"><span><span><strong class="calibre2"><kbd class="calibre9">&lt;!group&gt;</kbd>:</strong> <span><span>This is a synonym of <kbd class="calibre9">&lt;!channel&gt;</kbd> and both can be used inside a channel or a group.</span></span></span></span></li>
<li class="calibre13"><span><span><strong class="calibre2"><kbd class="calibre9">&lt;!everyone&gt;</kbd>:</strong> <span><span>This notifies all of our team members. This can be used in the team wide channel, which is usually called <span>#general</span>.</span></span></span></span></li>
</ul>
<div class="packt_figure"><span><span><img class="image-border24" src="../images/00035.jpeg"/><br class="title-page-name"/></span></span></div>
<p class="calibre1"><span><span><span><span><span>Using one of the notification tags will cause a notification icon to appear closer to the channel name.</span></span></span></span></span></p>
<p class="calibre1"><span><span>If we want to have the attention of our audience, we can make use of the classical tools that are popular in the social networks: the so-called emojis. Slack will let us display any emoji we like, so let's just go to <a href="https://unicodey.com/emoji-data/table.htm" target="_blank" class="calibre4">https://unicodey.com/emoji-data/table.htm,</a> and choose the little drawings you like the most.</span></span></p>
<p class="calibre1"><span><span>Once we have chosen our emojis, we can then forge a payload like this:</span></span></p>
<pre class="codepackt">
{<br class="title-page-name"/>    "text": "Guys, read carefully the examples:bangbang:, take <br class="title-page-name"/>your time :hourglass:, be :b:rave and love the :shell:"<br class="title-page-name"/>}
</pre>
<p class="calibre1"><span><span>And <kbd class="calibre9">cURL</kbd> it:</span></span></p>
<pre class="codepackt">
cURL -X POST -H 'Content-type: application/json' --data '{ "text": "Guys, read carefully the examples:bangbang:, take your :hourglass:, be :b:rave and love the :shell:"}' https://hooks.slack.com/services/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
</pre>
<p class="calibre1"><span><span>The results, in the following screenshot, are really nice: they attract attention in a fancy way, so our team members will not be haunted by our messages!</span></span></p>
<div class="packt_figure"><span><span><img class="image-border25" src="../images/00036.jpeg"/><br class="title-page-name"/></span></span></div>
<p class="calibre1"><span>A fancy message can nicely convey the urgency of a statement. </span><span><span>Finally, we can address a single user just using </span></span><kbd class="calibre9">&lt;@user| Optional handle&gt;</kbd> , <span><span>and we can also override the channel we want to send the message to using this:</span></span></p>
<pre class="codepackt">
"channel": "#name_of_channel"
</pre>
<p class="calibre1"><span><span>So, we could address the user called <kbd class="calibre9">Giorgio</kbd> who is in the channel called <kbd class="calibre9">#general</kbd>, asking him to join the test channel:</span></span></p>
<pre class="codepackt">
{ <br class="title-page-name"/>   "text": "Hey &lt;@giorgio|Giorgio&gt; did you join the <br class="title-page-name"/>    &lt;#test|Test&gt;   channel?", "channel": "#general"<br class="title-page-name"/>}'<strong class="calibre2"> </strong>
</pre>
<p class="calibre1"><span><span>So, the complete <kbd class="calibre9">cURL</kbd> line would be as follows:</span></span></p>
<pre class="codepackt">
cURL -X POST -H 'Content-type: application/json' --data '{ "text": "Hey &lt;@giorgio|Giorgio&gt; did you join the &lt;#test|Test&gt; channel?", "channel": "#general"}' https://hooks.slack.com/services/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
</pre>
<p class="calibre1"><span><span>With this message, the user Giorgio will receive a notification in the <kbd class="calibre9">#general</kbd> channel; and the content will be brought to his attention.</span></span></p>
<div class="packt_tip"><span class="calibre30">You do not need to convert in HTML the entire text of your message, but there are three characters that must be necessarily turned into HTML entities:<br class="calibre29"/></span><span class="calibre30">&amp; must be replaced with &amp;amp<br class="calibre29"/></span><span class="calibre30">&lt; must be replaced with &amp;lt<br class="calibre29"/></span><span class="calibre30">&gt; must be replaced with &amp;gt</span></div>
<p class="calibre1"><span><span>What we did so far was pretty--all you can do with a plain JSON without any hurdles, but if we want to further spice up our messages, we have to reply to message attachments, which will enable us to send images, attach buttons, and much more. So, our next step will be the message attachments to see not only how to embellish our messages, but how to make them more useful and effective.</span></span></p>


            </article>

            
        </section>
    

        <section>

                            <header>
                    </header><h1 class="header-title" id="calibre_pb_0">Message attachments</h1>
                
            
            <article>
                
<p class="calibre1"><span><span>A message attachment lets us convey more content to the user, and lets it be displayed with more whistles and bells; but we have to keep an eye on a restriction imposed by Slack: no more than 20 attachments per message. It makes sense, otherwise our messages would be so messy that it would distract the average user.</span></span></p>
<p class="calibre1"><span><span>What we have seen so far is a simple JSON: a one-level object, which is more or less like this example:</span></span></p>
<pre class="codepackt">
{<br class="title-page-name"/>    "text": "This is the first line of a messagen<br class="title-page-name"/>    This is the second line."<br class="title-page-name"/>}
</pre>
<p class="calibre1"><span><span>In a message attachment, though we are going to see more details, more content modifier, and a flat structure like the one we just saw that has not enough complexity to convey all the information. We need structured container, still a JSON; but this time, it will be an array holding several properties, which will resemble this snippet:</span></span></p>
<pre class="codepackt">
{<br class="title-page-name"/>    "attachments": [<br class="title-page-name"/>        {<br class="title-page-name"/>            "fallback": "Text to be displayed in case of client <br class="title-page-name"/>                         not supporting formatted text",<br class="title-page-name"/>            "color": "#ff1493",<br class="title-page-name"/>            "pretext": "This goes above the attachment",<br class="title-page-name"/>            "author_name": "Giorgio Zarrelli",<br class="title-page-name"/>            "author_link": "http://www.zarrelli.org",<br class="title-page-name"/>            "author_icon": "https://www.zarrelli.org/blog/wp-content/uploads/2017/03/IMG_20161113_150052.jpg",<br class="title-page-name"/>            "title": "Title example",<br class="title-page-name"/>            "title_link": "http://www.zarrelli.org",<br class="title-page-name"/>            "text": "This text is optional and it is shown in the  <br class="title-page-name"/>                    attachment",<br class="title-page-name"/>            "fields": [<br class="title-page-name"/>                {<br class="title-page-name"/>                    "title": "Priority",<br class="title-page-name"/>                    "value": "Medium",<br class="title-page-name"/>                    "short": false<br class="title-page-name"/>                }<br class="title-page-name"/>            ],<br class="title-page-name"/>            "image_URL": <br class="title-page-name"/>"http://www.zarrelli.org/path/to/image.jpg",<br class="title-page-name"/>            "thumb_URL": "https://www.zarrelli.org/blog/wp-content/uploads/2017/03/IMG_20161113_150052-1-e1490610507795.jpg",<br class="title-page-name"/>            "footer": "Slack API",<br class="title-page-name"/>            "footer_icon": "https://www.zarrelli.org/blog/wp-content/uploads/2017/03/IMG_20161113_150052.jpg",<br class="title-page-name"/>            "ts": 1490531695<br class="title-page-name"/>        }<br class="title-page-name"/>    ]<br class="title-page-name"/>}
</pre>
<p class="calibre1"><span><span>What does this snippet look like? We can see in the following screenshot how the attachment gets displayed:</span></span></p>
<div class="packt_figure"><span><span><img class="image-border26" src="../images/00037.jpeg"/></span></span></div>
<div class="packt_figref"><span><span><span><span><span>Lots of things in a single message, with a touch of pink!</span></span></span></span></span></div>
<p class="calibre1"><span><span>This is a nice output, much better than the previous basic examples; but things get a bit more complicated, since the structure of the JSON becomes more complex, and we have more fields available. So, let's have a look at the main directives, so we can use their meaning and limitations.</span></span></p>
<p class="calibre1"><span><span>What we are looking at is one out of 20 possible attachments, which start with a </span></span><span><span>fallback. As the name states, it is plain text without any markup, which is to be displayed if a client does not support formatted text:</span></span></p>
<ul class="calibre12">
<li class="calibre13"><span><span><strong class="calibre2"><kbd class="calibre9">color</kbd></strong>: You can color code your message giving a hue to the left-side bar. This can be useful either to make your message stand out in the discussion flow or to have a quick glance at its severity. The color can have three predefined attributes:</span></span>
<ul class="calibre23">
<li class="calibre13"><kbd class="calibre9">good</kbd>: This turns the side bar to green</li>
<li class="calibre13"><kbd class="calibre9">warning</kbd>: <span>This </span>turns the side bar to yellow</li>
<li class="calibre13"><kbd class="calibre9">danger</kbd>: <span>This </span>turns the side bar to red</li>
</ul>
</li>
</ul>
<p class="calibre27"><span><span>Apart from these predefined settings, you can use whatever color defined in hex code to turn your left-side bar into an attractive highlighted sign:</span></span></p>
<ul class="calibre12">
<li class="calibre13"><span><span><strong class="calibre2"><kbd class="calibre9">Pretext</kbd></strong>: This is optional text that is shown above the attachment.</span></span></li>
<li class="calibre13"><span><span><strong class="calibre2"><kbd class="calibre9">author_name</kbd></strong>: This is the name of the author of the message.</span></span></li>
<li class="calibre13"><span><span><strong class="calibre2"><kbd class="calibre9">author_link</kbd></strong>: Any valid URL and it will turn the author's name content into a link. It only works if author_name is available.</span></span></li>
<li class="calibre13"><span><span><strong class="calibre2"><kbd class="calibre9">author_icon</kbd></strong>: Any valid URL pointing to a 16x16 pixels image, which will be displayed to the left of <kbd class="calibre9">author_name</kbd>: This only works if the author's name is available.</span></span></li>
</ul>
<p class="calibre27"><span><span>The author's information, if available, will be displayed at the very beginning of each message.</span></span></p>
<ul class="calibre12">
<li class="calibre13"><span><span><strong class="calibre2"><kbd class="calibre9">title</kbd></strong>: As the name states, this is the title of the message and it gets displayed in a bigger size and bold text at the top of the message, but preceding the author's information.</span></span></li>
<li class="calibre13"><span><span><strong class="calibre2"><kbd class="calibre9">title_link</kbd></strong>: This is a full blown URL that will  turn the tile in a clickable link.</span></span></li>
<li class="calibre13"><span><span><strong class="calibre2"><kbd class="calibre9">Text</kbd></strong>: This is the actual body of the message, and the content can be formatted with the basic attributes that we saw in the previous pages. If the content exceeds the 500 characters of 5 line breaks, the content will collapse and a <span>Show more</span> link will allow the user to expand the content. Any URLs inside the text field will not unfurl.</span></span></li>
<li class="calibre13"><span><span><strong class="calibre2"><kbd class="calibre9">Fields</kbd></strong>: This is an array in the main array, and the bits inside it will be displayed in a table in the attachment. You can have more than one hash inside the array, just separate them with a comma, such as in the following example:</span></span></li>
</ul>
<pre class="calibre21">
"fields": [<br class="title-page-name"/>         {<br class="title-page-name"/>                   "title": "Who's in charge",<br class="title-page-name"/>                   "value": "Giorgio",<br class="title-page-name"/>                   "short": true<br class="title-page-name"/>                },<br class="title-page-name"/>                {<br class="title-page-name"/>                   "title": "Priority",<br class="title-page-name"/>                   "value": "Medium",<br class="title-page-name"/>                   "short": true<br class="title-page-name"/>                }<br class="title-page-name"/>          ]
</pre>
<ul class="calibre12">
<li class="calibre13"><span><span><strong class="calibre2"><kbd class="calibre9">title</kbd></strong>: <span><span>This is plain text shown in bold just above the value. It cannot contain any markup.</span></span></span></span></li>
<li class="calibre13"><span><span><strong class="calibre2"><kbd class="calibre9">value</kbd></strong>: <span><span>This can contain multiline text formatted with the markups that we saw in the previous pages.</span></span></span></span></li>
<li class="calibre13"><span><span><span><span><strong class="calibre2"><kbd class="calibre9">short</kbd></strong>: </span></span><span><span>This optional bit will mark the value short enough to be displayed side by side with other values as shown here:</span></span></span></span></li>
</ul>
<div class="packt_figure"><img class="image-border27" src="../images/00038.jpeg"/></div>
<div class="packt_figref">Values can be displayed side by side.</div>
<ul class="calibre12">
<li class="calibre13"><span><span><strong class="calibre2"><kbd class="calibre9">image_URL</kbd>:</strong> This is any valid URL of our choice, which points to a valid image in the PNG, JPEG, GIF, and BMP formats. The displayed size is of 400 x 500 pixels, and any wider or higher images will be automatically resized keeping the original aspect ratio. The image will be displayed inside the message attachment.</span></span></li>
<li class="calibre13"><span><span><strong class="calibre2"><kbd class="calibre9">thumb_URL</kbd>:</strong> This is a</span></span><span><span>ny URL pointing to an image file in the PNG, JPEG, GIF, and BMP format. It will be displayed on the right side of the message of the attachment, and it will be rescaled to 75 x 75 pixels keeping the aspect ratio. There is a file size limit to less than 500 KB.</span></span></li>
<li class="calibre13"><span><span><strong class="calibre2"><kbd class="calibre9">footer</kbd>:</strong> This is the small chunk of text, limited to 300 characters to give some extra information to the readers.</span></span></li>
<li class="calibre13"><span><span><strong class="calibre2"><kbd class="calibre9">footer_icon</kbd>:</strong> Provide a valid URL to an image, and it will be displayed beside your footer text. The image will be displayed with a fixed size of 16 x 16 pixels and only if you provided a footer.</span></span></li>
<li class="calibre13"><span><span><strong class="calibre2"><kbd class="calibre9">ts</kbd>:</strong> Each message has its own timestamp when published, but we can attach a specific timestamp to an event or happening mentioned into the message attachment using the ts field and time info expressed in epoch time.</span></span></li>
</ul>
<p class="calibre1"><span><span>For what we are interested in, it is all about the message formatting. There are some fancy things such as buttons, but that would require a full-blown application able to read from the channel and react to the user actions. As of now, we will stick to a simpler interaction with our script by just sending nicely formatted information to the channel; but no one will prevent you from starting off this example and build up some more complex and suited to your needs.</span></span></p>


            </article>

            
        </section>
    

        <section>

                            <header>
                    </header><h1 class="header-title" id="calibre_pb_0">Our wee chatty script for Slack</h1>
                
            
            <article>
                
<p class="calibre1"><span><span>Time to start planning our script for Slack, and the first step is to ask ourselves what do we want out of it. Let's recap our requirements, the script has to do as follows:</span></span></p>
<ul class="calibre12">
<li class="calibre13">Accept the text message to display: required</li>
<li class="calibre13">Accept a title for the message<span>:</span> required</li>
<li class="calibre13">Accept a title_link<span>:</span> optional and only if a title is available</li>
<li class="calibre13">Accept a fallback message<span>:</span> required</li>
<li class="calibre13">Accept an author_name<span>:</span> optional</li>
<li class="calibre13">Accept an author_link<span>:</span> optional and only if an author_link available</li>
<li class="calibre13">Accept an author_icon<span>:</span> optional and only if an author_link available</li>
<li class="calibre13">Accept a color<span>:</span> required</li>
<li class="calibre13">Accept a pretext<span>:</span> optional</li>
<li class="calibre13">Accept fields<span>:</span> required and required title, value and short</li>
<li class="calibre13">Accept image_URL<span>:</span> optional</li>
<li class="calibre13">Accept thumb_URL<span>:</span> optional</li>
<li class="calibre13">Accept footer<span>:</span> optional</li>
<li class="calibre13">Accept footer_icon<span>:</span> optional and only if the footer is available</li>
<li class="calibre13">Accept ts<span>:</span> optional</li>
</ul>
<p class="calibre1"><span><span>Now, we have a matrix to start building our bits and to parse the command line, and we are ready to start coding. We know what to do, but due to the complexity of the task, we will proceed step by step, adding bits to bits; and since the core of our message is the JSON, we will start coding its structure. But what to do before the first step? We have to think about which utilities we are going to use. As a start, we would say at least cURL, so check if you have it installed on your system; and if you don't, install it. The first lines of our script will have a sha-bang, and try to locate the utility in our <kbd class="calibre9">PATH</kbd>:</span></span></p>
<pre class="codepackt">
<strong class="calibre2">#!/bin/bash<br class="title-page-name"/># License: GPL</strong><br class="title-page-name"/><strong class="calibre2"># <br class="title-page-name"/># Author: Giorgio Zarrelli &lt;zarrelli@linux.it&gt;<br class="title-page-name"/>#<br class="title-page-name"/># This program is free software; you can redistribute it and/or modify<br class="title-page-name"/># it under the terms of the GNU General Public License version 2 as<br class="title-page-name"/># published by the Free Software Foundation.<br class="title-page-name"/>#<br class="title-page-name"/># This program is distributed in the hope that it will be useful,<br class="title-page-name"/># but WITHOUT ANY WARRANTY; without even the implied warranty of<br class="title-page-name"/># MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE. See the<br class="title-page-name"/># GNU General Public License for more details.<br class="title-page-name"/>#<br class="title-page-name"/># You should have received a copy of the GNU General Public License<br class="title-page-name"/># along with this program. If not, see &lt;http://www.gnu.org/licenses/&gt;.<br class="title-page-name"/>#<br class="title-page-name"/># Retrieve the full path to the system utilities</strong><br class="title-page-name"/><strong class="calibre2">cURL=$(which cURL)</strong>
</pre>
<p class="calibre1"><span><span>These first lines resemble the previous Nagios plugin, and this script starts off with a license statement as well. It can be quite useless to state a license, but if we plan to make our scripts available to the public, it is upon us to let the potential user know what they can do with our scripts. The author of this book encourages distributing the software under the GNU GPL license, as it makes it easier to use it to create new programs from it and reutilizing the code. But it is up to the creator of the program what kind of license to use. To have a glance at the various GNU licenses available, we can just go to </span></span><span><span><a href="https://www.gnu.org/licenses/licenses.html" target="_blank" class="calibre4">https://www.gnu.org/licenses/licenses.html</a> </span></span><span><span>and have a look at the numerous licenses on one of them, which will surely fit our purposes. Notice that for this script, we will use lower case variables just to get used to the different kinds of notations adopted by different coders.</span></span></p>
<p class="calibre1"><span><span>So, we pointed to the <kbd class="calibre9">cURL</kbd> utility, but how can we be sure that it is installed and we can reach it? Well, we have to bear in mind that the command substitution given to the variable the output of which and this latter will print out something only if the argument passed to it is reachable in one of the directories pointed out by the user <kbd class="calibre9">$PATH</kbd> environment variable. Just for a test, let's call which with cURL as an argument:</span></span></p>
<pre class="codepackt">
<strong class="calibre2">zarrelli:~$ which cURL<br class="title-page-name"/>/usr/bin/cURL</strong>
</pre>
<p class="calibre1"><span><span>Now, let's call which with some blurb:</span></span></p>
<pre class="codepackt">
<strong class="calibre2">zarrelli:~$ which cr234a<br class="title-page-name"/>zarrelli:~$ </strong>
</pre>
<p class="calibre1"><span><span>We get nothing in the output, so our <kbd class="calibre9">cURL</kbd> variable will bear no value. One more check, let's test ifconfig as the root:</span></span></p>
<pre class="codepackt">
<strong class="calibre2">root:# which ifconfig<br class="title-page-name"/>/sbin/ifconfig</strong>
</pre>
<p class="calibre1"><span><span>Then, let's check it again as a non-privileged user:</span></span></p>
<pre class="codepackt">
<strong class="calibre2">zarrelli:~$ which ifconfig<br class="title-page-name"/>zarrelli:~$</strong>
</pre>
<p class="calibre1"><span><span>So, since the path to <kbd class="calibre9">ifconfig</kbd> is in the <kbd class="calibre9">$PATH</kbd> variable of the root user only, which, for the non-privileged user, will return nothing. Based on this, we can implement a check with just a few lines:</span></span></p>
<pre class="codepackt">
if [ -z "$cURL" ]<br class="title-page-name"/>   then<br class="title-page-name"/>         echo "Cannot reach the utility, is it in the $PATH or <br class="title-page-name"/>even installed?"<br class="title-page-name"/>         exit 1<br class="title-page-name"/>      else<br class="title-page-name"/>         echo "The utility is reachable"<br class="title-page-name"/>fi
</pre>
<p class="calibre1"><span><span>So, if the <kbd class="calibre9">$cURL</kbd> variable is not empty, the utility is reachable; if not, we receive a warning and exit from the script with an error:</span></span></p>
<pre class="codepackt">
<strong class="calibre2">zarrelli:~$ ./my_slack.sh <br class="title-page-name"/>The utility is reachable</strong>
</pre>
<p class="calibre1"><span><span>Great, it seems to work. Now let's change </span></span><kbd class="calibre9">cURL=$(which cURL)</kbd> <span><span>into </span></span><kbd class="calibre9">cURL=$(which cur1l2)</kbd>.</p>
<p class="calibre1"><span><span>Let's run the script again:</span></span></p>
<pre class="codepackt">
<strong class="calibre2">zarrelli:~$ /bin/bash -x my_slack.sh <br class="title-page-name"/>++ which cur1l2<br class="title-page-name"/>+ cURL=<br class="title-page-name"/>+ '[' -z '' ']'<br class="title-page-name"/>+ echo 'Cannot reach the utility, is it in the $PATH or even in <br class="title-page-name"/>stalled?'<br class="title-page-name"/>Cannot reach the utility, is it in the $PATH or even installed?<br class="title-page-name"/>+ exit 1</strong>
</pre>
<p class="calibre1"><span><span>Correct, the script exits because which cannot find that non sense string in the user <kbd class="calibre9">$PATH</kbd> variable. So, this check can come in handy, but as it is written it is not so useful, so let's make a function out of it:</span></span></p>
<pre class="codepackt">
# Check if which comes back with a path to a utility<br class="title-page-name"/>check_which()<br class="title-page-name"/>{<br class="title-page-name"/>   for i in "$@"<br class="title-page-name"/>   do<br class="title-page-name"/>         if [ -z "$i" ];<br class="title-page-name"/>               then<br class="title-page-name"/>                     echo "Cannot reach the utility $i, is it in <br class="title-page-name"/>the $PATH or even installed?"<br class="title-page-name"/>                      exit 1<br class="title-page-name"/>               else<br class="title-page-name"/>                      :<br class="title-page-name"/>           fi<br class="title-page-name"/>    done<br class="title-page-name"/>}<br class="title-page-name"/>check_which "$cURL"
</pre>
<p class="calibre1"><span><span>We simply check if which outputs the path to the utility checked; if it outputs nothing, then the variable is empty and we exit with a message and an exit code. If the variable holds something, then we do nothing since we assume this is the path to the utility. This check resembles the one we used for the Nagios plugin:</span></span></p>
<pre class="codepackt">
# Check if we have all the system tools we need<br class="title-page-name"/>path_exists()<br class="title-page-name"/>{<br class="title-page-name"/>for i in "$@"<br class="title-page-name"/>do<br class="title-page-name"/>       if [ -e "$i" ];<br class="title-page-name"/>               then <br class="title-page-name"/>                          (( VERB )) &amp;&amp; echo "$i is a valid path"<br class="title-page-name"/>                          disk_exists "$DISK"<br class="title-page-name"/>               else<br class="title-page-name"/>                          (( VERB )) &amp;&amp; echo "$i is not reachable, <br class="title-page-name"/>is this the correct path?"<br class="title-page-name"/>                        echo "SMART UNKNOWN: Please check the <br class="title-page-name"/>plugin"<br class="title-page-name"/>                        exit "$STATE_UNKNOWN"<br class="title-page-name"/>        fi<br class="title-page-name"/>done<br class="title-page-name"/>}
</pre>
<p class="calibre1"><span><span>This other one check tests if the content of the variable actually points to a file. Which is better? Depends on what you are checking for. If we need to verify that the variable points to a real file, then <kbd class="calibre9">[ -e "$i" ]</kbd> is what we are looking for. Otherwise, when we want a more generic check, <kbd class="calibre9">[ -z "$i" ]</kbd> will do the job for us.</span></span></p>
<p class="calibre1"><span><span>What do we need next in our script? Let's recall a <kbd class="calibre9">cURL</kbd> that we made a few pages ago:</span></span></p>
<pre class="codepackt">
cURL -X POST -H 'Content-type: application/json' --data '{"text": "&lt;!date^1490531695^ {date}|Fallback&gt;"}' https://hooks.slack.com/services/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 
</pre>
<p class="calibre1"><span><span>Once we deal with the <kbd class="calibre9">cURL</kbd> command, we have to manage the headers:</span></span></p>
<pre class="codepackt">
-X POST<br class="title-page-name"/>-H 'Content-type: application/json'<br class="title-page-name"/>--data
</pre>
<p class="calibre1"><span><span>These are static and will not change, so we can use them without enclosing in a variable.</span></span></p>
<p class="calibre1"><span><span>We must not forget our WebHook URL:</span></span></p>
<pre class="codepackt">
# WebHook URLwebhook="https://hooks.slack.com/services/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"
</pre>
<p class="calibre1"><span><span>Now, it is time to build our first, static payload; and here comes the tricky part. Since the payload is a long multiline JSON, writing it in a single long line would be cumbersome, so we are going to give this burden to a function, which will create this content on our behalf; and it will be nicely formatted too:</span></span></p>
<pre class="codepackt">
generate_payload()<br class="title-page-name"/>{<br class="title-page-name"/>   cat &lt;&lt;MARKER<br class="title-page-name"/>{<br class="title-page-name"/>    "attachments": [<br class="title-page-name"/>       {<br class="title-page-name"/>            "fallback": "Text to be displayed in case of client <br class="title-page-name"/>                          not supporting formatted text",<br class="title-page-name"/>            "color": "#ff1493",<br class="title-page-name"/>            "pretext": "This goes above the attachment",<br class="title-page-name"/>            "author_name": "Giorgio Zarrelli",<br class="title-page-name"/>            "author_link": "http://www.zarrelli.org",<br class="title-page-name"/>            "author_icon": "https://www.zarrelli.org/blog/wp-content/uploads/2017/03/IMG_20161113_150052.jpg",<br class="title-page-name"/>            "title": "Title example",<br class="title-page-name"/>            "title_link": "http://www.zarrelli.org",<br class="title-page-name"/>            "text": "This text is optional and it is shown in the        <br class="title-page-name"/>                        attachment",<br class="title-page-name"/>            "fields": [<br class="title-page-name"/>                {<br class="title-page-name"/>                   "title": "Priority",<br class="title-page-name"/>                   "value": "Medium",<br class="title-page-name"/>                   "short": false<br class="title-page-name"/>                }<br class="title-page-name"/>          ],<br class="title-page-name"/>           "image_URL": <br class="title-page-name"/>"http://www.zarrelli.org/path/to/image.jpg",<br class="title-page-name"/>           "thumb_URL": "https://www.zarrelli.org/blog/wp-<br class="title-page-name"/>content/uploads/2017/03/IMG_20161113_150052-1-e1490610507795.jpg",<br class="title-page-name"/>           "footer": "Slack API",<br class="title-page-name"/>           "footer_icon": "https://www.zarrelli.org/blog/wp-content/uploads/2017/03/IMG_20161113_150052.jpg",<br class="title-page-name"/>            "ts": 1490531695<br class="title-page-name"/>        }<br class="title-page-name"/>    ]<br class="title-page-name"/>}<br class="title-page-name"/>MARKER<br class="title-page-name"/>}
</pre>
<p class="calibre1"><span><span>We used a <em class="calibre20">here</em> document which, as we saw previously, is one of the best ways to deal with multiline content in Bash scripts. The function will create the content for us, so let's check whether this is true by adding </span></span><kbd class="calibre9">generate_payload</kbd> <span><span>at the bottom of our script; and let's run it:</span></span></p>
<pre class="codepackt">
<strong class="calibre2">zarrelli:~$ ./my_slack.sh <br class="title-page-name"/>{<br class="title-page-name"/>    "attachments": [<br class="title-page-name"/>        {<br class="title-page-name"/>            "fallback": "Text to be displayed in case of client <br class="title-page-name"/>                         not supporting formatted text",<br class="title-page-name"/>            "color": "#ff1493",<br class="title-page-name"/>            "pretext": "This goes above the attachment",<br class="title-page-name"/>            "author_name": "Giorgio Zarrelli",<br class="title-page-name"/>            "author_link": "http://www.zarrelli.org",<br class="title-page-name"/>            "author_icon": "https://www.zarrelli.org/blog/wp<br class="title-page-name"/>content/uploads/2017/03/IMG_20161113_150052.jpg",<br class="title-page-name"/>            "title": "Title example",<br class="title-page-name"/>            "title_link": "http://www.zarrelli.org",<br class="title-page-name"/>            "text": "This text is optional and it is shown in the <br class="title-page-name"/>                       attachment",<br class="title-page-name"/>            "fields": [<br class="title-page-name"/>                {<br class="title-page-name"/>                    "title": "Priority",<br class="title-page-name"/>                    "value": "Medium",<br class="title-page-name"/>                    "short": false<br class="title-page-name"/>                }<br class="title-page-name"/>            ],<br class="title-page-name"/>             "image_URL": <br class="title-page-name"/>"http://www.zarrelli.org/path/to/image.jpg",<br class="title-page-name"/>            "thumb_URL": "https://www.zarrelli.org/blog/wp<br class="title-page-name"/>content/uploads/2017/03/IMG_20161113_150052-1-e1490610507795.jpg",<br class="title-page-name"/>            "footer": "Slack API",<br class="title-page-name"/>            "footer_icon": "https://www.zarrelli.org/blog/wp<br class="title-page-name"/>content/uploads/2017/03/IMG_20161113_150052.jpg",<br class="title-page-name"/>            "ts": 1490531695<br class="title-page-name"/>        }<br class="title-page-name"/>    ]<br class="title-page-name"/>}</strong>
</pre>
<p class="calibre1"><span><span>Great, it works! Our content is here, and so we can proceed in building the command line. Let's delete the call to the function at the bottom of the script and add the following line:</span></span></p>
<pre class="codepackt">
<strong class="calibre2">"$cURL" -f -X POST -H 'Content-type: application/json' --data "$(generate_payload)" "$webhook" </strong>
</pre>
<p class="calibre1"><kbd class="calibre9">$(generate_payload)</kbd> <span><span>is a command substitution that will give<kbd class="calibre9">--data</kbd> the output generated by the function; but do not forget to enclose it in double quotes, or your output will be taken line by line and not as a single object. Time to save and execute the script and check our <kbd class="calibre9">#test</kbd> channel:</span></span></p>
<pre class="codepackt">
<strong class="calibre2">zarrelli:~$ ./my_slack.sh <br class="title-page-name"/>ok</strong>
</pre>
<div class="packt_figure"><span><span><span><span><span><img class="image-border28" src="../images/00039.jpeg"/><br class="title-page-name"/></span></span></span></span></span></div>
<p class="calibre1"><span><span><span><span><span>We checked our script just to be sure that it works as intended.</span></span></span></span></span></p>
<p class="calibre1"><span><span>Nice, the script works, we can see the results in the <kbd class="calibre9">#test</kbd> channel and a tiny <kbd class="calibre9">OK</kbd> in the command line. Well, nice, but we cannot rely on a third-party output to know if anything went wrong, so let's modify our command line to get some useful response:</span></span></p>
<pre class="codepackt">
<strong class="calibre2">"$cURL" -f -X POST -H 'Content-type: application/json' --data "$(generate_payload)" "$webhook" &amp;&amp; echo " - Success exit code: $?" || echo "There was an error, exit code: $?"</strong>
</pre>
<p class="calibre1"><span><span>We added a <kbd class="calibre9">-f</kbd> flag to <kbd class="calibre9">cURL</kbd> so that it exits silently in case of error, letting us write something meaningful on the output. It is not 100% failsafe and, as we will see, sometimes an error message slips through, but it is still usable. Then we add this:</span></span></p>
<pre class="codepackt">
<strong class="calibre2">&amp;&amp; echo " - Success exit code: $?" || echo "There was an error, <br class="title-page-name"/>exit code: $?"</strong>
</pre>
<p class="calibre1"><span><span>We have already seen this kind of test before. We are checking if the command was successful or not and echoing the exit code called <kbd class="calibre9">"$?"</kbd> to the <kbd class="calibre9">stdout</kbd>. Let's have a look:</span></span></p>
<pre class="codepackt">
<strong class="calibre2">zarrelli:~$ ./my_slack.sh <br class="title-page-name"/>ok - Success exit code: 0</strong>
</pre>
<p class="calibre1"><span><span>Great! cURL just printed <kbd class="calibre9">ok</kbd> on the command line, and since the execution went fine, we printed a <kbd class="calibre9">Success</kbd> message with <kbd class="calibre9">exit code</kbd>. Now, let's remove <kbd class="calibre9">k</kbd> from <kbd class="calibre9">$webhook</kbd> on the last line and execute the script again:</span></span></p>
<pre class="codepackt">
<strong class="calibre2">zarrelli:~$ ./my_slack.sh <br class="title-page-name"/>cURL: (3) &lt;URL&gt; malformed</strong>
</pre>
<p class="calibre1"><span><span>There was an error, exit code: <kbd class="calibre9">3</kbd>.</span></span></p>
<p class="calibre1"><span><span>It should have failed silently, but anyway, we were able to write our meaningful error message; and this is all we want.</span></span></p>
<p class="calibre1"><span><span>Our first step is accomplished: we can send a static message to our WebHook and have the message displayed in the <kbd class="calibre9">#test</kbd> channel. This is interesting, but not so flexible. What we really want is to be able to modify the message based on our input. To reach this goal, we have to turn into variables all the bits inside our attachment so that we will be able to pass the values on the command line. Let's start creating a couple of variables:</span></span></p>
<pre class="codepackt">
<strong class="calibre2"># Message attachment variables<br class="title-page-name"/>fallback=${fallback:="This is a text shown on older clients"}<br class="title-page-name"/>text=${text:="This line of text is optional"}</strong>
</pre>
<p class="calibre1"><span><span>Now, we just have to modify the payload:</span></span></p>
<pre class="codepackt">
{<br class="title-page-name"/>            "fallback": "$fallback",<br class="title-page-name"/>            "color": "#ff1493",<br class="title-page-name"/>            "pretext": "This goes above the attachment",<br class="title-page-name"/>            "author_name": "Giorgio Zarrelli",<br class="title-page-name"/>            "author_link": "http://www.zarrelli.org",<br class="title-page-name"/>            "author_icon": "https://www.zarrelli.org/<br class="title-page-name"/>            blog/wp-content/uploads/2017/03/IMG_20161113_150052.jpg",<br class="title-page-name"/>            "title": "Title example",<br class="title-page-name"/>            "title_link": "http://www.zarrelli.org",<br class="title-page-name"/>            "text": "$text",<br class="title-page-name"/>            "fields": [<br class="title-page-name"/>                {<br class="title-page-name"/>                    "title": "Priority",<br class="title-page-name"/>                    "value": "Medium",<br class="title-page-name"/>                    "short": false<br class="title-page-name"/>                }<br class="title-page-name"/>            ],<br class="title-page-name"/>                "image_URL": <br class="title-page-name"/>               "http://www.zarrelli.org/path/to/image.jpg",<br class="title-page-name"/>                "thumb_URL": "https://www.zarrelli.org/<br class="title-page-name"/>                 blog/wpcontent/uploads/2017/03/IMG_20<br class="title-page-name"/>                161113_150052-1-e1490610507795.jpg",<br class="title-page-name"/>            "footer": "Slack API",<br class="title-page-name"/>            "footer_icon": "https://www.zarrelli.org/blog/wpcontent/<br class="title-page-name"/>             uploads/2017/03/IMG_20161113_150052.jpg",<br class="title-page-name"/>            "ts": 1490531695<br class="title-page-name"/>        }
</pre>
<p class="calibre1">Now, let's run the script to see if our modifications are taken into account:</p>
<pre class="codepackt">
<strong class="calibre2">zarrelli:~$ ./my_slack.sh <br class="title-page-name"/>ok - Success exit code: 0</strong>
</pre>
<p class="calibre1"><span><span>It seems it worked; a check to the <kbd class="calibre9">#test</kbd> channel will confirm the outcome, as we can see in the following screenshot:</span></span></p>
<div class="packt_figure"><span><span><span><span><span><img class="image-border29" src="../images/00040.jpeg"/><br class="title-page-name"/></span></span></span></span></span></div>
<p class="calibre1"><span><span><span><span><span>Our variables are being taken into account by the script.</span></span></span></span></span></p>
<p class="calibre1"><span><span>Since our variables seem to be working, let's create a new whole bunch of them:</span></span></p>
<pre class="codepackt">
<strong class="calibre2"># Message attachment variables<br class="title-page-name"/>fallback=${fallback:="This is a text shown on older clients"}<br class="title-page-name"/>color=${color:="good"}<br class="title-page-name"/>pretext=${pretext:="Announcement:"}<br class="title-page-name"/></strong><span><span><strong class="calibre2">author_name=${author_name:="Giorgio Zarrelli"}</strong><br class="title-page-name"/></span></span><strong class="calibre2">author_link=${author_link:="http://www.zarrelli.org"}<br class="title-page-name"/>author_icon=${author_icon:="https://www.zarrelli.org/blog/wp<br class="title-page-name"/>content/uploads/2017/03/IMG_20161113_150052.jpg"}<br class="title-page-name"/>title=${title:="New message"}<br class="title-page-name"/>title_link=${title_link:="Announcement:"}<br class="title-page-name"/>text=${text:="This line of text is optional"}<br class="title-page-name"/>fields_title=${fields_title:="Priority"}<br class="title-page-name"/>fields_value=${fields_value:="Medium"}<br class="title-page-name"/>fields_short=${fields_short:="true"}<br class="title-page-name"/>im-<br class="title-page-name"/>age_URL=${image_URL:="http://www.zarrelli.org/path/to/image.jpg"}<br class="title-page-name"/>thumb_URL=${thumb_URL:="https://www.zarrelli.org/blog/wp-content/uploads/2017/03/IMG_20161113_150052-1-e1490610507795.jpg"}<br class="title-page-name"/>footer=${footer:="Mastering Bash"}<br class="title-page-name"/>footer_icon=${footer_icon:="https://www.zarrelli.org/blog/wp-content/uploads/2017/03/IMG_20161113_150052.jpg"}<br class="title-page-name"/>ts=${ts:="1490531695"}</strong>
</pre>
<p class="calibre1"><span><span>Obviously, the payload must be modified accordingly:</span></span></p>
<pre class="codepackt">
 {<br class="title-page-name"/>            "fallback": "$fallback",<br class="title-page-name"/>            "color": "$color",<br class="title-page-name"/>            "pretext": "$pretext",<br class="title-page-name"/>            "author_name": "$author_name",<br class="title-page-name"/>            "author_link": "$author_link",<br class="title-page-name"/>            "author_icon": "$author_icon",<br class="title-page-name"/>            "title": "$title",<br class="title-page-name"/>            "title_link": "$title_link",<br class="title-page-name"/>            "text": "$text",<br class="title-page-name"/>            "fields": [<br class="title-page-name"/>                {<br class="title-page-name"/>                    "title": "$fields_title",<br class="title-page-name"/>                    "value": "$fields_value",<br class="title-page-name"/>                    "short": "fields_short"<br class="title-page-name"/>                }<br class="title-page-name"/>            ],<br class="title-page-name"/>            "image_URL": "$image_URL",<br class="title-page-name"/>            "thumb_URL": "$thumb_URL",<br class="title-page-name"/>            "footer": "$footer",<br class="title-page-name"/>            "footer_icon": "$footer_icon",<br class="title-page-name"/>            "ts": "$ts"<br class="title-page-name"/>    }
</pre>
<p class="calibre1"><span><span><span><span><span>Again, let's test our code:</span></span></span></span></span></p>
<pre class="codepackt">
zarrelli:~$ ./my_slack.sh <br class="title-page-name"/>ok - Success exit code: 0
</pre>
<p class="calibre1"><span><span><span><span><span>The screenshot here shows our newly formatted message:</span></span></span></span></span></p>
<div class="packt_figure"><img class="image-border30" src="../images/00041.jpeg"/></div>
<p class="calibre1"><span><span><span><span><span>It seems that our new payload works well.</span></span></span></span></span></p>
<p class="calibre1"><span><span>Now that we have all the variables in place, it is time to create a menu that will help us manage the user input. Let's start writing a help function; we already saw how to do this in the previous chapter, but this time, we have a lot of options to deal with, so we start associating a switch to each variable:</span></span></p>
<pre class="codepackt">
<strong class="calibre2">-f --fallback<br class="title-page-name"/>-c --color <br class="title-page-name"/>-p --pretext<br class="title-page-name"/>-an --author_name<br class="title-page-name"/>-al --author_link<br class="title-page-name"/>-ai --author_icon<br class="title-page-name"/>-t --title<br class="title-page-name"/>-tl --title_link<br class="title-page-name"/>-tx --text<br class="title-page-name"/>-ft --fields_title<br class="title-page-name"/>-fv --fields_value<br class="title-page-name"/>-fs --fields_short<br class="title-page-name"/>-iu --image_URL<br class="title-page-name"/>-tu --thumb_URL<br class="title-page-name"/>-fr --footer<br class="title-page-name"/>-fi --footer_icon<br class="title-page-name"/>-ts –-timestamp</strong>
</pre>
<p class="calibre1"><span><span>What we use as short and long options is up to us, but we must keep in mind a golden rule: these must be meaningful not for us, but for the potential users of the script, so we have to take a step aside and try to think as our users. Once we have decided on the best options, we must proceed creating the actual command-line parser:</span></span></p>
<pre class="codepackt">
# Parse parameters on the command line<br class="title-page-name"/>while (( $# &gt; 0 ))<br class="title-page-name"/>   do<br class="title-page-name"/>               case "$1" in<br class="title-page-name"/>               -h | --help)<br class="title-page-name"/>                         print_help<br class="title-page-name"/>                             exit 1<br class="title-page-name"/>                             ;;<br class="title-page-name"/>               -f | --fallback)<br class="title-page-name"/>                           shift<br class="title-page-name"/>                           fallback="$1"<br class="title-page-name"/>                           ;;<br class="title-page-name"/>                    -c | --color)<br class="title-page-name"/>                             shift<br class="title-page-name"/>                          color="$1"<br class="title-page-name"/>                         ;;<br class="title-page-name"/>                    -p | -pretext)<br class="title-page-name"/>                           shift<br class="title-page-name"/>                         pretext="$1"<br class="title-page-name"/>                             ;;<br class="title-page-name"/>                    -an | --author_name)<br class="title-page-name"/>                            shift<br class="title-page-name"/>                         author_name="$1"<br class="title-page-name"/>                           ;;<br class="title-page-name"/>               -al | --author_link)<br class="title-page-name"/>                           shift<br class="title-page-name"/>                         author_link="$1"<br class="title-page-name"/>                           ;;<br class="title-page-name"/>         -ai | --author_icon)<br class="title-page-name"/>                           shift<br class="title-page-name"/>                         author_icon="$1"<br class="title-page-name"/>                           ;;<br class="title-page-name"/>               -t | --title)<br class="title-page-name"/>                           shift<br class="title-page-name"/><br class="title-page-name"/>                           ;;<br class="title-page-name"/>               -tl | --title_link)<br class="title-page-name"/>                               shift<br class="title-page-name"/>                             title_link="$1"<br class="title-page-name"/>                               ;;<br class="title-page-name"/>               -tx | --text)<br class="title-page-name"/>                           shift<br class="title-page-name"/>                         author_icon="$1"<br class="title-page-name"/>                           ;;<br class="title-page-name"/>               -ft | --fields_title)<br class="title-page-name"/>                           shift<br class="title-page-name"/>                        fields_<br class="title-page-name"/>                          ;;<br class="title-page-name"/>               -fv | --fields_value)<br class="title-page-name"/>                           shift<br class="title-page-name"/>                        fields_value="$1"<br class="title-page-name"/>                          ;;<br class="title-page-name"/>               -fs | --fields_title)<br class="title-page-name"/>                           shift<br class="title-page-name"/>                         fields_short="$1"<br class="title-page-name"/>                           ;;<br class="title-page-name"/>               -iu | --image_URL)<br class="title-page-name"/>                           shift<br class="title-page-name"/>                         image_URL="$1"<br class="title-page-name"/>                            ;;<br class="title-page-name"/>               -tu | --thumb_URL)<br class="title-page-name"/>                           shift<br class="title-page-name"/>                         thumb_URL="$1"<br class="title-page-name"/>                           ;;<br class="title-page-name"/>               -fr | --footer)<br class="title-page-name"/>                           shift<br class="title-page-name"/>                         footer="$1"<br class="title-page-name"/>                           ;;<br class="title-page-name"/>               -fi | --footer_icon)<br class="title-page-name"/>                           shift<br class="title-page-name"/>                         image_URL="$1"<br class="title-page-name"/>                           ;;<br class="title-page-name"/>               -ts | --timestamp)<br class="title-page-name"/>                           shift<br class="title-page-name"/>                        ts="$1"<br class="title-page-name"/>                          ;;<br class="title-page-name"/>     *) echo "Unknown argument: $1"<br class="title-page-name"/>                          print_help<br class="title-page-name"/>                          exit 1<br class="title-page-name"/>                          ;;<br class="title-page-name"/>         esac<br class="title-page-name"/>         shift<br class="title-page-name"/>       done<br class="title-page-name"/><span><span><br class="title-page-name"/></span></span>
</pre>
<p class="calibre1"><span><span>And now the <kbd class="calibre9">print_help</kbd> function:</span></span><span><span> </span></span></p>
<pre class="codepackt">
# Print help and usage<br class="title-page-name"/>print_help()<br class="title-page-name"/>{<br class="title-page-name"/>   cat &lt;&lt; HERE<br class="title-page-name"/><br class="title-page-name"/>   Slack sender v1.0<br class="title-page-name"/>         ---------------<br class="title-page-name"/>Please enter one or more of the following options: <br class="title-page-name"/>            -h | --help<br class="title-page-name"/>            -f | --fallback<br class="title-page-name"/>              -c | --color<br class="title-page-name"/>              -p | -pretext<br class="title-page-name"/>             -an | --author_name<br class="title-page-name"/>             -al | --author_link<br class="title-page-name"/>             -ai | --author_icon<br class="title-page-name"/>              -t | --title<br class="title-page-name"/>             -tl | --title_link<br class="title-page-name"/>             -tx | --text<br class="title-page-name"/>             -ft | --fields_title<br class="title-page-name"/>             -fv | --fields_value<br class="title-page-name"/>             -fs | --fields_title<br class="title-page-name"/>             -iu | --image_URL<br class="title-page-name"/>             -tu | --thumb_URL<br class="title-page-name"/>             -fr | --footer<br class="title-page-name"/>             -fi | --footer_icon<br class="title-page-name"/>             -ts | --timestamp<br class="title-page-name"/>HERE<br class="title-page-name"/>}
</pre>
<p class="calibre1"><span><span>Now, let's comment the last line of the script: the one calling cURL. Then, let's call the script with the <kbd class="calibre9">-h</kbd> switch:</span></span></p>
<pre class="codepackt">
<strong class="calibre2">zarrelli:~$ ./my_slack.sh -h<br class="title-page-name"/><br class="title-page-name"/><span>Slack sender v1.0<br class="title-page-name"/>     -------------------<br class="title-page-name"/></span></strong><span><span><strong class="calibre2">Please enter one or more of the following options:</strong><br class="title-page-name"/></span></span><strong class="calibre2">             -h | --help</strong><br class="title-page-name"/><strong class="calibre2">             -f | --fallback</strong><br class="title-page-name"/><strong class="calibre2">               -c | --color</strong><br class="title-page-name"/><strong class="calibre2">               -p | -pretext</strong><br class="title-page-name"/><strong class="calibre2">              -an | --author_name</strong><br class="title-page-name"/><strong class="calibre2">              -al | --author_link</strong><br class="title-page-name"/><strong class="calibre2">              -ai | --author_icon</strong><br class="title-page-name"/><strong class="calibre2">             -t | --title</strong><br class="title-page-name"/><strong class="calibre2">              -tl | --title_link</strong><br class="title-page-name"/><strong class="calibre2">              -tx | --text</strong><br class="title-page-name"/><strong class="calibre2">              -ft | --fields_title</strong><br class="title-page-name"/><strong class="calibre2">              -fv | --fields_value</strong><br class="title-page-name"/><strong class="calibre2">              -fs | --fields_title</strong><br class="title-page-name"/><strong class="calibre2">              -iu | --image_URL</strong><br class="title-page-name"/><strong class="calibre2">              -tu | --thumb_URL</strong><br class="title-page-name"/><strong class="calibre2">              -fr | --footer</strong><br class="title-page-name"/><strong class="calibre2">              -fi | --footer_icon</strong><br class="title-page-name"/><strong class="calibre2">              -ts | --timestamp</strong>
</pre>
<p class="calibre1"><span><span>There is a small issue: even the Nagios plugin had it, so it is time to solve it. Let's call the script without any parameters:</span></span></p>
<pre class="codepackt">
<strong class="calibre2">zarrelli:~$ ./my_slack.sh -h<br class="title-page-name"/>zarrelli:~$</strong>
</pre>
<p class="calibre1"><span><span>Nothing, we do not have anything as feedback, so we do not even know if we can use a <kbd class="calibre9">-h</kbd> switch to get more information. How do we solve this hindrance? Well, we have different options available; we could modify the while clause for instance or adopt a different strategy:</span></span></p>
<pre class="codepackt">
if (( $# == 0 ))<br class="title-page-name"/>   then<br class="title-page-name"/>         echo "No options provided, you can use -h for help but <br class="title-page-name"/>this time I will do it for you..."<br class="title-page-name"/>         print_help<br class="title-page-name"/>fi
</pre>
<p class="calibre1"><span><span>We have to put these lines before the menu creation, and they will check the input: if nothing is given on the command line, it will write an error message and call the <kbd class="calibre9">print_help</kbd> function. Time to test our script now and see what happens:</span></span></p>
<pre class="codepackt">
<strong class="calibre2">./my_slack.sh -c warning -an Me -t "My cli test" -tx "This is a cli text"<br class="title-page-name"/>ok - Success exit code: 0</strong>
</pre>
<p class="calibre1"><span><span>It seems it worked, and the screenshot of the <kbd class="calibre9">#test</kbd> channel confirms our guess:</span></span></p>
<div class="packt_figure"><span><span><span><span><span><img class="image-border31" src="../images/00042.jpeg"/><br class="title-page-name"/></span></span></span></span></span></div>
<p class="calibre1"><span><span><span><span><span>Our script now accepts the command-line parameters.</span></span></span></span></span></p>


            </article>

            
        </section>
    

        <section>

                            <header>
                    </header><h1 class="header-title" id="calibre_pb_0">Summary</h1>
                
            
            <article>
                
<p class="calibre1"><span><span>We are now able to send formatted messages to the <kbd class="calibre9">#test</kbd> channel, but is this all we can do with this script? No, as you will learn over time with a bit more experience, programming is also setting a scope to our efforts: we must define our goals, plan accordingly, accomplish them, and assess the results. Overdoing, in a professional environment, breaks one of the fundamental rules of the project management, the so-called <em class="calibre20">iron triangle</em> that defines the quality of a project as the intersection between scope, time, and costs that are the top three constrains driving us in creating our programs. Spend too long on a program or exceed the goals, the cost will levitate and the overall quality, not the quality of the code, but of our project, will be impacted.</span></span></p>
<p class="calibre1"><span><span>This script was an example on how to plan and execute, how to check for the information we need to code a working script, and how to write down our steps. There are many ways to improve this framework, for example, by allowing the user to pass a date on the command line, not as epoch time, but in one format allowed by the date command, and then translating it with a tiny function or even inline into the code. We can, for instance, put a check on the option arguments so that the user will be forced to pass an argument if they specify an option on the command line. This is a play field and these can be advises on how to have fun and develop the script further. We are now moving further to deepen what we can do with a subshell, how to execute a bunch of processes in parallel and, as always, how to have fun!</span></span></p>
<p class="calibre1"> </p>


            </article>

            
        </section>
    </body></html>