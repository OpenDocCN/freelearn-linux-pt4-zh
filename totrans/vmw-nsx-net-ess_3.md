# 第三章：NSX Manager 安装与配置

本章介绍了 NSX Manager 安装的前提条件和安装步骤。以下是我们将讨论的关键点：

+   NSX Manager 要求

+   NSX Manager 安装

+   NSX Manager 设计考虑

+   控制器要求

+   NSX 控制器部署设计考虑

+   NSX 数据平面安装

# NSX Manager 要求

VMware NSX Manager 是一个预配置的虚拟设备，我们可以像下载任何其他 VMware 软件一样，从 VMware 网站上下载。这个预配置的虚拟机配备了 16 GB 内存、4 个 VCPU 和 60 GB 存储空间。

让我们快速查看 NSX Manager 6.2 安装的前提条件：

+   VMware vCenter Server 6.0

+   VMware ESXi 6.0

+   准备好 NSX 6.2 的主机集群

+   支持的 vSphere 分布式交换机，适用于相应版本的主机和虚拟中心

+   确保我们有共享数据存储，可以利用 vSphere HA/DRS 功能来防止 NSX Manager 虚拟机的停机时间

+   确认我们是否使用双栈或仅 IPV4/IPV6 网络

+   收集网关、DNS、Syslog 和 NTP 服务器配置

+   所有端口要求已在 VMware 公共知识库文章 [`kb.vmware.com/kb/2079386`](https://kb.vmware.com/kb/2079386) 中更新。

下载 NSX Manager OVA 后，我们将按照以下四个步骤进行管理软件的安装和配置：

1.  部署 NSX Manager OVA 文件

1.  登录到 NSX Manager

1.  建立 NSX Manager 和 vCenter Server 的连接

1.  配置备份选项

话虽如此，让我们开始安装过程。根据我的经验，我可以自信地说，部署任何虚拟设备都是一项非常简单的任务。然而，当事情变得奇怪时，我们不得不回头查看部署过程，结果发现大多数问题都是我们在安装过程中完全忽视的——我们只是点击了 **下一步** 和 **完成** 按钮。

# NSX Manager 安装

安装 NSX Manager，请执行以下步骤：

1.  通过 VMware Web 客户端打开 vCenter。

1.  选择 **虚拟机和模板**，右键点击数据中心，选择 **部署 OVF 模板**。

1.  粘贴 VMware 下载 URL 或点击 **浏览** 选择计算机上的文件。

1.  点击复选框 **接受额外配置选项**。

    这允许你在安装过程中设置 IPv4 和 IPv6 地址、默认网关、DNS、NTP 和 SSH 属性。如果在部署过程中未设置这些配置，我们可以在部署后随时进行设置。

1.  接受 VMware 许可协议。

1.  编辑 NSX Manager 名称（如有需要）。选择部署 NSX Manager 的位置。

1.  该名称将出现在 vCenter Server 清单中。

1.  你选择的文件夹将用于为 NSX Manager 应用权限。

1.  选择一个主机或集群来部署 NSX Manager 设备。我更倾向于选择一个集群，然后让 DRS 决定将设备放置在哪个主机上。

1.  将虚拟磁盘格式更改为**厚预配**，并为虚拟机配置文件和虚拟磁盘选择目标数据存储。

1.  选择 NSX Manager 的管理端口组。

最后，在配置完所有选项后，检查屏幕，可以看到这是一个仅支持 IPV4 的部署。所以要集中注意力，再次检查屏幕，如果需要做任何修改，我们应该回到前一步进行修正。

现在我们已成功部署 NSX Manager，值得再次确认所有配置是否完好无损，并且管理设备能够与 DNS、NTP、网关、ESXi 主机和 VC 进行通信。这是一个非常重要的步骤，因为管理设备与这些组件之间的任何通信问题都会直接影响 VMware NSX 功能的正常运行/部署。

下图显示了 NSX Manager OVF 的详细信息：

![NSX Manager 安装](img/image_03_001.jpg)

我们先记录下前面图片中的关键配置细节，然后我会解释选择这些配置的设计决策。

## 理解关键配置细节

如我之前所说，在部署 NSX Manager 设备时，我们需要注意几个关键的设计因素。接下来我们详细讨论一下。

### 目标 - 管理和边缘集群

管理和边缘集群是 vSphere 中的专用集群，建议始终为所有管理组件部署一个独立的集群，这样可以在不影响计算集群的情况下轻松进行集群升级，计算集群是专门用于部署最终用户虚拟机的。在这个示例中，我们有一个预配置的 vSphere 集群。我们将利用这个集群来部署以下组件：

+   NSX Manager

+   NSX 控制器

+   Vcenter Server

+   任何其他第三方或 VMware 管理软件

但请记住，NSX 可以与多种 VMware 产品集成，例如 Horizon View、SRM、vCloud Director、VRA、VIO 和 VCO。因此，根据产品集成类型和数据中心设计，某些情况可能要求有多个管理集群用于隔离。例如，如果在主站点有两个 vCenter Server，一个用于与 NSX 集成的 vSphere，另一个用于与 SRM 集成的 vCenter Server，那么创建两个独立的管理集群是可以的。再次强调，这是一种设计选择，取决于我们是否愿意将所有资源集中在一个集群中，或者是否愿意将它们分布在不同的集群（机架）中。

### 网络映射

我们已将 NSX Manager 连接到一个名为**Mgmt_VDS_MGT**的 vSphere 分布式交换机端口组。这些是预先配置的端口组，理想情况下会配置一个 VLAN 端口组。我们可以为管理和边缘集群创建一个单独的分布式交换机，或者可以使用一个跨多个集群的单一分布式交换机。首选的部署方法是使用独特的分布式交换机，因为这将成为管理虚拟机的 VMotion 边界。是的，我们不希望为这些虚拟机进行**分布式资源调度器**（**DRS**）或手动迁移，以便将其移动到任何其他计算集群，因为这样会违背为管理和计算机器创建独立集群的目的。此外，基于物理网络设计，假设如以下截图所示，我们为管理和边缘集群配置了一个位于单个机架上的顶层交换机。TOR 交换机中的任何网络级更改都不会影响计算集群。我们是计划使用 LACP、静态 EtherChannel 还是类似虚拟 PortChannel 的配置？需要注意的是，LACP 配置应该在来自同一分布式交换机的所有端口组中保持一致。下图展示了一个典型的 NSX 企业 vSphere 设计，具有单独的计算、管理和边缘集群：

![网络映射](img/image_03_002.jpg)

带顶层交换机设计的计算和边缘集群

在确认所有初始配置完好无损后，我们可以通过支持的 Web 浏览器登录到 NSX Manager，如下方截图所示：

![网络映射](img/image_03_003.jpg)

NSX Manager 初始屏幕

从前面的图片中，我们可以看到 NSX Manager 的初始页面，我认为 vCloud 网络安全和 NSX Manager 初始页面之间有显著的区别：所有选项都排列得井井有条，并有简明的解释。默认情况下，我们可以使用以下凭据登录到 NSX Manager。NSX Manager 的默认用户名和密码如下：

+   用户名：`admin`

+   密码：`default`

出于安全加固的目的，我们可以随时更改密码并创建多个用户进行管理访问。从前面的图片中，我们可以看到在右上角有 NSX Manager 的初始配置，以及 NSX 的版本号 6.2 和构建号。

## NSX Manager 虚拟设备管理

让我们讨论在前面的 GUI 中列出的不同选项。所有这些都是 NSX 设备配置和集成的关键选项：

+   **查看摘要**：查看摘要页面为我们提供了 NSX Manager 的完整配置摘要。包括虚拟设备 DNS、IP、版本、运行时间/当前时间，以及常见的组件和管理服务，如下方截图所示：![NSX Manager 虚拟设备管理](img/image_03_004.jpg)

    NSX Manager 摘要

    看一下前面的屏幕截图，我们可以解读出 vPostgres、RabbitMQ 和管理服务应该正在运行。**RabbitMQ** 服务器是一个托管在 NSX 管理器上的进程，它们通过消息总线与运行在 ESXi 主机上的**防火墙守护进程 (vsfwd)** 进行交互。我们将在第六章 *配置和管理 NSX 网络服务* 中更详细地讨论 vsfwd；不过，目前我们需要了解这个服务的重要性以及它们在 NSX 环境中的通信方式。Postgres 是 NSX 管理器数据库，它随设备一起提供。因此，需要特别注意通过任何方法编辑或更改数据库中的表将直接影响系统，强烈建议在 VMware 支持团队的帮助下执行此类操作。

+   **管理设备设置**：管理设置对于对 NSX 管理器进行任何配置更改将极为有用。例如，如果配置了一个新的 Syslog 服务器，并且我们希望将新的 Syslog 服务器与当前的 NSX 管理器一起配置，我们可以通过编辑**Syslog 服务器**标签轻松更新这些更改。在早期版本的 NSX 中，默认情况下禁用了 SSL。但是，从 NSX 6.1 版本开始，SSL 默认启用。所以让我们看一下以下屏幕截图，它显示了 NSX 管理器的**常规**设置：![NSX 管理器虚拟设备管理](img/B03244_03_05-1024x586.jpg)

    设置 NSX 管理器的时间设置、Syslog 服务器和区域设置

+   **管理 vCenter 注册**：NSX 管理器和 vCenter 服务器之间是一对一的关系。在跨 vCenter 服务器的 NSX 安装中，这是最容易混淆的主题之一，因为我们认为多个 vCenter 可以通过一个 NSX 实例来支持，这是完全错误的。NSX 6.2 允许你通过单个主 NSX 管理器来管理多个 vCenter NSX 环境。即使在跨 vCenter 服务器的 NSX 安装中，NSX 管理器与 vCenter 服务器之间的关系仍然是一对一的。关于跨 vCenter 安装的更多内容将会在第七章中讨论，*NSX 跨 vCenter*，NSX-v 跨 vCenter 功能和设计决策。

### 将 vCenter 服务器与 NSX 管理器注册

我们将快速进行将 NSX 管理器与 vCenter 服务器注册的操作，按照以下步骤进行。NSX 管理器注册的流程：

1.  首先，登录到 NSX 管理器虚拟设备。

1.  在**设备管理**下，点击**管理设备设置**。

1.  我们需要输入 vCenter 服务器的 IP 地址。

1.  输入 vCenter 服务器的用户名和密码。

1.  点击 `OK`。

1.  等待几秒钟以确保成功连接到 vCenter 服务器。

![将 vCenter 服务器与 NSX 管理器注册](img/B03244_03_06.jpg)

### 将 SSO 与 NSX 管理器注册

对于 **单点登录**（**SSO**）服务与 NSX 的集成，我们需要配置查找服务，这将增强 vCenter 用户身份验证的安全性，并使得 NSX 能够从身份服务（如 AD、NIS 和 LDA）进行身份验证。

查找服务注册过程：

1.  登录到 NSX Manager 虚拟设备。

1.  在 **设备管理** 下，点击 **管理设置**。

1.  点击 **NSX 管理服务**。

1.  点击 **编辑**，位于 **查找服务** 旁边。

1.  输入具有查找服务的主机的名称或 IP 地址。

1.  如有需要，更改端口号。默认端口为 **7444**。

1.  查找服务的 URL 会根据指定的主机和端口显示。输入 vCenter 管理员用户名和密码。

1.  这使得 NSX Manager 能够将自身注册到安全令牌服务服务器。

1.  点击 **确定**。

1.  确认查找服务状态已连接。

下图显示了查找服务成功注册以及 vCenter 服务器为 NSX Manager 注册的情况：

![使用 NSX Manager 注册 SSO](img/B03244_03_07-1024x628.jpg)

现在是时候探索其他 NSX Manager 设置，例如技术支持日志、升级和恢复管理设备：

+   **下载技术支持日志**：出于诊断目的，我们可以通过点击 **下载** 按钮下载 NSX Manager 日志，该按钮位于 **NSX Manager 虚拟设备管理** 下。

+   **备份与恢复**：NSX Manager 数据，包括系统配置、事件和审计日志表（存储在 Postgres 数据库中），可以随时通过在 NSX Manager 图形界面执行按需备份来进行备份。还可以安排定期备份（每小时、每天或每周）。

+   **升级**：根据 NSX Manager 或 vCloud 网络安全解决方案的版本，我们可能需要升级管理平面。下载升级包后，我们需要将其上传到 **NSX Manager-Upgrade-Upload New Bundle** 标签，然后点击 **升级**。请注意，升级 NSX Manager 不会升级控制平面或数据平面组件。

请记住，我们使用管理员角色账户将 vCenter 服务器注册到 NSX。另外，请注意，密码中的 ASCII 字符会导致与 NSX Manager 的同步问题。成功将 NSX Manager 注册到 vCenter 服务器后，我们可以通过 VMware Web 客户端管理 NSX Manager，并且在 Web 客户端的库存中会看到 **网络与安全** 解决方案，如下图所示：

![使用 NSX Manager 注册 SSO](img/B03244_03_08.jpg)

最后，让我们为 NSX Manager 分配许可证。

使用 vSphere Web 客户端登录 vCenter 服务器，并执行以下步骤：

1.  在中间窗格中，点击 **解决方案** 标签。

1.  选择 **NSX** for vSphere 解决方案。

1.  点击 **分配许可证密钥** 链接。

1.  在 **分配许可证密钥** 面板中，从下拉菜单中选择 **分配新许可证密钥**。

1.  在**许可证密钥**文本框中，输入或粘贴您的 NSX for vSphere 许可证密钥。

1.  点击**确定**。

VMware NSX 的多虚拟化平台许可证密钥也可用于授权 VMware NSX for vSphere。

# NSX 管理器部署注意事项

由于 NSX 在 vSphere 环境中扮演着关键角色，因此了解和实施 NSX 管理、控制平面和数据平面功能至关重要。NSX 管理由 NSX 管理器提供，它为配置所有 NSX 功能提供了一个单一的入口点。此外，我们还可以利用 REST-API 调用进行部署、配置及其他任务。那么，接下来我们来谈谈从管理平面到其他组件的通信渠道。

## 通信路径

以下列表展示了 NSX 管理器与各个组件之间的通信路径：

+   **NSX 管理器到 vCenter Server**：管理器与 vCenter 之间的通信通过 vSphere API 实现。

+   **NSX 管理器到控制器**：管理器与控制器之间的通信通过 HTTPS 实现。

+   **NSX 管理器到 ESXi 主机**：管理器与底层 ESXi 主机之间的通信通过消息总线进行。

## 网络和端口要求

作为管理平面一部分的 NSX 管理器虚拟机，通常 NSX 管理器和 vCenter 会放置在同一个管理网络（vSphere PortGroup）中。我知道大多数架构师会好奇，是否可以将 NSX 管理器和 vCenter Server 放置在隔离的网络（不同子网）中？答案是*可以*，它们可以位于不同的网络中，甚至不同的 VLAN 中。

如下截图所示，NSX for vSphere 的协议和端口要求已更新：

![网络和端口要求](img/B03244_03_09.jpg)

确保网络中允许所有这些端口和协议。

## 用户角色和权限

首先，NSX 角色和权限与 vCenter Server 角色和权限完全不同。因此，确保用户访问安全是非常重要的。通过**基于角色的访问控制**（**RBAC**），我们可以保障用户访问的安全。除此之外，在正确配置 NSX 管理器的查找服务后，我们还可以利用 vCenter SSO 身份源的用户和组。NSX 提供了范围限制功能，用于限制用户可以访问的 NSX 系统区域：

+   **全局**：用户可以访问 NSX 的所有区域。

+   **限制访问**：用户仅能访问用户配置文件中定义的 NSX 区域。

各种用户角色如下：

+   **企业管理员**：NSX 操作和安全管理。

+   **NSX 管理员**：仅限于 NSX 操作，例如安装虚拟设备、配置端口组等。

+   **安全管理员**：对 NSX 安全区域具有读写访问权限，例如定义数据安全策略、创建端口组和创建 NSX 模块的报告，并对其他区域具有只读访问权限。

+   **审计员**：对所有区域拥有只读访问权限。

用户在没有角色的情况下无法定义。为用户分配角色后，可以更改该角色。这些角色在为 NSX 用户授予权限时极其重要，确保我们只为非企业管理员帐户提供有限的访问权限。

# 控制器要求

既然我们已经明确了管理器部署和设计决策，让我们讨论一下控制器的要求。NSX 控制器也作为虚拟设备进行部署，每个控制器都有默认的计算资源。由于我们已经将 NSX 管理器与虚拟中心注册，并确保我们已打开端口和协议，我再次强调为什么需要控制器：

+   VXLAN 单播和混合模式复制

+   分布式逻辑路由

由于 NSX 控制器是具有控制平面智能的虚拟机，从网络需求的角度来看，它们需要有一个 IP 地址。然而，我们并不依赖传统的手动或 DHCP 自动发现过程来分配 IP 地址。在部署控制器之前，让我们先配置 IP 池。

## 控制器 IP 池创建过程

IP 池用于为控制器和**VXLAN 隧道端点**（**VTEP**）分配 IP 地址。我特别喜欢这个功能，它减少了手动操作的过程。我们只需要创建一个 IP 池，控制器在创建时会从池中选择一个 IP 地址；而且，在删除时，它也会释放一个 IP 地址：

1.  从**vCenter Server Web 客户端**中，导航到**网络安全**，在**管理**下选择**分组对象**，如下图所示：![控制器 IP 池创建过程](img/B03244_03_10-1024x280.jpg)

1.  点击**+**图标，我们需要配置一个静态 IP 池，以便各个控制器能够从这个池中选择一个 IP 地址，如下图所示：![控制器 IP 池创建过程](img/B03244_03_11.jpg)

1.  现在我们已经准备好 IP 池，可以返回到 NSX 主页面，并点击**NSX 控制器节点**下的**+**号，如下图所示：![控制器 IP 池创建过程](img/B03244_03_12-1024x624.jpg)

1.  分别选择并更新**vCenter 数据中心**、**集群/资源池**、共享的**数据存储**位置、vSphere 网络组（PortGroup）以确保连通性，最后选择我们在步骤 2 中创建的**IP 池**名称。完成此任务后，您将看到以下截图：![控制器 IP 池创建过程](img/image_03_013.jpg)

1.  在第一个控制器部署完成后，我们可以通过相同的步骤再部署两个控制器，因为三节点控制集群是强制性的。

1.  成功部署的控制器将显示**正常**状态，并且会有一个绿色的勾选标记，如下图所示：![控制器 IP 池创建过程](img/image_03_014.jpg)

让我们记录下所有三个控制器的 IP 地址：

+   **控制器 1**：**192.168.110.201**

+   **控制器 2**：**192.168.110.202**

+   **控制器 3**：**192.168.110.203**

即使我们已经部署了控制器并且状态为绿色，仍然需要从命令行检查控制集群连接及其状态，这将提供更为详细的信息。SSH 到所有三个控制器并发出以下命令：

```
 Show Control-cluster status
    # Command to Check Controller Status and ID 

```

控制器类型及其状态解释如下：

+   `加入状态`：验证控制器节点是否报告加入完成

+   `大多数状态`：验证控制器是否已连接到集群的大多数节点

+   `集群 ID`：集群中的所有控制器节点应具有相同的集群 ID

记得我们在 第二章 讨论的控制器角色吗？*NSX 架构*？是的，这些就是五个角色，它们在这里填充，如下面的截图所示：`api_provider`、`persistence_server`、`switch_manager`、`logical_manager` 和 `directory_server`：

![控制器 IP 池创建过程](img/image_03_015.jpg)

好的，这一切都很棒，但我知道我们还有一些问题。让我们逐一看一下这些问题。

我们如何检查哪些控制器是这些角色的主控？

以下命令将为我们显示该输出：

```
Show Control-Cluster roles

```

让我们对其中一个控制器进行随机检查，在这个例子中是 `控制器 2`，其 IP 地址为 `192.168.110.202`。从下面的截图可以看到，除了持久化服务器，所有角色在控制器 `192.168.110.202` 上都是主控：

![控制器 IP 池创建过程](img/image_03_016.jpg)

SSH 会话 NSX 控制器

控制器集群的大多数领导者监听端口 `2878`，并在 `listening` 列中显示 `Y`。要检查这一点，我们在步骤 2 中检查的同一控制器 `192.168.110.202` 上发出以下命令：

```
 S**how Control-Cluster Connections** 

```

我们得到了以下输出：

![控制器 IP 池创建过程](img/image_03_017.jpg)

这看起来有点奇怪吗？

我们知道控制器集群的大多数领导者监听端口 `2878`，并且对于控制器 `192.168.110.202` 的持久化服务器，在 `listening` 列中会显示 `**-**`。这里没有什么难度；根据我们在第 7 步中测试的 `Show Control-Cluster roles` 输出，除持久化服务器角色外，控制器集群 2 的其他所有角色都是主控，因此 `Show Control-Cluster Connections` 报告持久化服务器的状态为 `-`。我希望我们现在对控制器角色有了基本的了解。我们将在 第八章，*NSX 故障排除* 中讨论一些故障排除场景。

# NSX 控制器设计考虑因素

NSX 控制器虚拟机是控制平面的核心，因此决定安装和连接控制器的位置非常重要。最后，我们不希望控制器暴露给利用 NSX 特性的用户；基本上，不允许控制平面受到攻击。

## 通信路径

了解 NSX Manager、控制器和 NSX Edge 之间使用的通信协议是很有帮助的：

+   控制器和 NSX Manager 之间的通信 - HTTPS

+   Edge 和控制器之间的通信 - HTTPS

## 网络和端口要求

确保满足以下截图中提到的端口要求，以支持控制器之间的通信：

![网络和端口要求](img/image_03_018.jpg)

## 控制器部署注意事项

我知道，我一直在告诉你：NSX 的真正强大之处就在于控制器。我们如何部署控制器、实施哪些最佳实践，都在 NSX 设计中起着至关重要的作用。你现在应该明白，由于覆盖网络，我们可能需要在物理和虚拟环境中实施大量设计最佳实践。但在这里，我们将讨论控制器部署的注意事项：

+   首先，NSX 控制器应该部署在与 NSX Manager 注册的同一个 vCenter 中。唯一的例外是采用跨 vCenter 的 NSX 设计，我们将在第七章中讨论 *跨 vCenter 的 NSX*。

+   在部署控制器时，不要进行其他配置更改，也不要部署其他 NSX 功能。即使是在故障修复场景中删除一个控制器并部署新控制器时，这个规则依然适用。

+   对于控制器部署，建议使用单独的 vSphere Edge 集群。对于小规模部署，将控制器部署到管理集群中也是可以的。

+   NSX 控制器应该能够与所有 ESXi 主机的 vmkernel 网络和 NSX Manager 管理网络进行通信。

+   由于控制器是虚拟机，大多数企业环境将启用 vSphere **分布式资源调度器**（**DRS**）功能，它会将控制器视为普通虚拟机，并根据部署算法将其迁移或放置在同一 ESXi 主机上。为了确保控制器不会被部署或迁移到同一主机上，并避免主机故障时直接影响控制器及整个控制平面，我们需要利用 vSphere 的反亲和性规则，避免在同一 ESXi 主机上部署多个控制器。此外，我强烈建议从多个主机集群（至少三个）开始，并根据需要进行扩展。这样，我们就能轻松将控制器部署到不同的 ESXi 主机上并扩展规模。不要误解我的意思，我们是在三个不同的主机上部署三个控制器，而不是将剩余的主机作为备用主机。在任何环境中，我们都需要进行维护操作，有时是软件升级的一部分，或者是从服务器中添加或移除硬件设备。在这种情况下，当我们对某台主机进行停机维护时，其他主机依然存在，因此控制器会根据反亲和性规则部署到这些主机上。

+   集群中的所有主机应启用自动 VM 启动/关闭功能。

### 注意

部署控制器的第一个主机默认启用自动 VM 启动/关闭。

以上总结了控制器部署和关键设计方面。现在，我们来谈谈数据平面准备。是时候回顾我们目前为止所做的工作了吗？是的，让我们来回顾一下。我们已部署了 NSX 管理器（管理平面）并将解决方案注册到 vCenter Server。接着，我们部署了 NSX 控制器（控制平面），最后，我们进入了安装的最后阶段——数据平面。

# NSX 数据平面

NSX 数据平面包括**vSphere 分布式交换机**（**VDS**）、内核模块、用户世界代理、NSX 边缘设备、分布式路由/防火墙及桥接模块。首先，让我们讨论如何为 NSX 准备 ESXi 集群。

什么是主机准备？它的作用就是安装内核模块，并构建一个管理和控制平面域。我们在这里提到的内核模块如下：

+   分布式路由

+   分布式防火墙

+   VXLAN 桥接

在多集群环境中，我们需要在每个集群层级执行此安装。根据 vSphere 设计，我们始终可以将新主机添加到集群中，且对于新添加的主机，准备工作会自动完成，这使得架构师的工作更加轻松。

## 主机准备过程

让我们讨论如何准备 ESXi 主机以推送内核模块：

1.  在 vCenter 中，导航到**主页**|**网络与安全**|**安装**，并选择**主机准备**标签。

1.  选择相应的集群，点击齿轮图标并点击**安装**，如下图所示：![主机准备过程](img/image_03_019.jpg)

1.  监控安装过程。对其他集群重复相同步骤。

    现在，所有 vSphere 用户常有的一个问题是：安装了 VIBS 后，我们是否需要重启主机？答案是**绝对不需要**！只有在卸载场景下，我们才需要重启主机。我们人类总是容易忘记一些事情，不是吗？没问题，我们的 ESXi 主机图标旁会弹出提示，提醒*需要重启*。

1.  对于每个 vSphere 集群，我们将继续配置****VXLAN**** 网络先决条件。

首先，我们将为**VTEP IP** 分配配置一个**静态池**，这类似于我们之前配置的控制器**IP 池**。当然，也可以使用**DHCP**池分配，但在这里，我展示的是通过静态池分配 IP 的方式。

从 NSX 管理器中，导航到管理**IP 池**并点击**+**号。更新以下内容：

+   VTEP **名称**

+   **网关** 地址

+   **前缀长度**

+   为 VTEP IP 分配配置**静态 IP 池**。

请参考下图：

![主机准备过程](img/image_03_020.jpg)

选择一个 vSphere 集群，并点击 VXLAN 列中的配置链接：

1.  选择 vSphere 分布式交换机。

1.  更新**VLAN**编号。如果不使用 VLAN，请输入`0`，这将通过未标记的流量传递。

1.  确保**MTU**为`**1600**`（VXLAN 开销）

1.  对于 VMKnic IP 地址配置，我们需要利用先前配置的 VTEP IP 池。

**VMKNic 聚合策略**方法用于将 vmnic（物理 NIC）绑定到 VTEP 端口组。我选择了故障转移。其他选项包括静态 EtherChannel、LACP（主动）、LACP（被动）、按源 ID 负载平衡、按源 MAC 负载平衡以及增强型 LACP。以下截图更新了支持的 VXLAN NIC 聚合策略列表：

![主机准备过程](img/image_03_021.jpg)

VTEP NIC 聚合设计在 NSX 环境中至关重要。大多数客户会选择单一 VTEP 配置，主要是因为设计的简单性。然而，如果我们的 VXLAN 流量超过 10G，LACP 或静态 EtherChannel 将是首选的负载均衡策略。

VTEP 值是每个主机的 VTEP 数量。为什么我们要选择多 VTEP 配置？如果我们有多个物理链路希望用于 VXLAN 流量，并且上游交换机不支持 LACP，使用多个 VTEP 可以使我们在物理链路之间平衡流量。

以下截图展示了前面的步骤：

![主机准备过程](img/image_03_022.jpg)

根据需求，我们也可以对其他集群重复相同的步骤，每个这样的配置将在 vSphere 中创建一个 VXLAN 分布式端口组。

VXLAN 模块的成功安装将显示为**已配置**，如下图所示：

![主机准备过程](img/image_03_023.jpg)

我知道我们大多数人对于 VXLAN 及其工作原理会有一些设计相关的疑问。保持专注：我们正在朝着正确的方向前进，并将在后续章节中讨论这一点。

# 概述

本章开始时，我们介绍了 NSX Manager 的要求，并覆盖了管理平面的所有设计方面。随后，我们讨论了 NSX Controller 的要求和关键设计决策。最后，我们进入了数据平面的安装。在下一章中，我们将讨论如何管理和部署 NSX 逻辑网络。
