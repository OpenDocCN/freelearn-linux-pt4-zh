- en: Chapter 6. Allowing Remote Access
  id: totrans-0
  prefs:
  - PREF_H1
  type: TYPE_NORMAL
  zh: 第6章 允许远程访问
- en: 'This chapter contains the following recipes:'
  id: totrans-1
  prefs: []
  type: TYPE_NORMAL
  zh: 本章包含以下内容：
- en: Running commands remotely through SSH
  id: totrans-2
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: 通过 SSH 远程执行命令
- en: Configuring a more secure SSH login
  id: totrans-3
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: 配置更安全的 SSH 登录
- en: Securely connecting to SSH without a password
  id: totrans-4
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: 无需密码安全连接到 SSH
- en: Restricting SSH access by user or group
  id: totrans-5
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: 按用户或组限制 SSH 访问
- en: Protecting SSH with Fail2ban
  id: totrans-6
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: 使用 Fail2ban 保护 SSH
- en: Confining sessions to a chroot jail
  id: totrans-7
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: 将会话限制在 chroot 监狱中
- en: Configuring TigerVNC
  id: totrans-8
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: 配置 TigerVNC
- en: Tunneling VNC connections through SSH
  id: totrans-9
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: 通过 SSH 隧道连接 VNC
- en: Introduction
  id: totrans-10
  prefs:
  - PREF_H1
  type: TYPE_NORMAL
  zh: 介绍
- en: The recipes in this chapter will help you provide remote access to your CentOS
    system in a security-conscious way. You'll learn how to execute commands on a
    remote system through SSH, configure the OpenSSH SSH server to increase security
    surrounding remote logins, and use key-based authentication to connect. You'll
    also learn how to allow or deny access to different users, configure Fail2ban
    to automatically block suspected IP addresses to protect your server from brute
    force attacks better, and restrict users to a chroot jail once they've logged
    in. The concluding recipes show you how to provide remote access to a complete
    desktop environment using VNC, and how to secure that access by tunneling VNC
    traffic through an SSH tunnel.
  id: totrans-11
  prefs: []
  type: TYPE_NORMAL
  zh: 本章中的食谱将帮助你以安全的方式提供远程访问 CentOS 系统。你将学习如何通过 SSH 在远程系统上执行命令，配置 OpenSSH SSH 服务器以增强远程登录的安全性，并使用基于密钥的认证进行连接。你还将学习如何允许或拒绝不同用户的访问，配置
    Fail2ban 自动阻止可疑的 IP 地址，以更好地保护你的服务器免受暴力破解攻击，并限制用户在登录后进入 chroot 监狱。结尾的食谱展示了如何通过
    VNC 提供远程桌面环境的访问，并通过 SSH 隧道加密 VNC 流量来保障该访问的安全。
- en: Running commands remotely through SSH
  id: totrans-12
  prefs:
  - PREF_H1
  type: TYPE_NORMAL
  zh: 通过 SSH 远程执行命令
- en: This recipe shows you how to execute one-shot commands on a remote system through
    **Secure Shell** (**SSH**). Having the ability to run commands without establishing
    a full interactive session can be convenient because you can avoid running a second
    terminal; everything can be done directly from the same command line.
  id: totrans-13
  prefs: []
  type: TYPE_NORMAL
  zh: 本篇展示了如何通过 **安全外壳**（**SSH**）在远程系统上执行一次性命令。无需建立完整的交互式会话就能执行命令，这非常方便，因为你可以避免打开第二个终端；所有操作都可以直接在同一命令行中完成。
- en: Getting ready
  id: totrans-14
  prefs:
  - PREF_H2
  type: TYPE_NORMAL
  zh: 准备工作
- en: This recipe requires a remote system running the OpenSSH server and a local
    computer with the OpenSSH SSH client installed (both should be installed by default
    on CentOS). The examples assume that the remote system is configured with the
    IP address `192.168.56.100`. Also, you will need a user account available on the
    remote system.
  id: totrans-15
  prefs: []
  type: TYPE_NORMAL
  zh: 本食谱要求远程系统运行 OpenSSH 服务器，并且本地计算机已安装 OpenSSH SSH 客户端（CentOS 上默认安装）。示例假设远程系统的 IP
    地址为 `192.168.56.100`。此外，你还需要在远程系统上有一个用户账户。
- en: How to do it...
  id: totrans-16
  prefs:
  - PREF_H2
  type: TYPE_NORMAL
  zh: 如何操作...
- en: 'The following examples show you how to run commands on a remote system from
    your local system through SSH:'
  id: totrans-17
  prefs: []
  type: TYPE_NORMAL
  zh: 以下示例展示了如何通过 SSH 从本地系统远程执行命令：
- en: 'To execute a command remotely, use `ssh` and specify the hostname or IP address
    of the target system followed by the command and its arguments:'
  id: totrans-18
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: 要远程执行命令，使用 `ssh` 并指定目标系统的主机名或 IP 地址，然后是命令及其参数：
- en: '[PRE0]'
  id: totrans-19
  prefs:
  - PREF_IND
  type: TYPE_PRE
  zh: '[PRE0]'
- en: 'To execute the command as a different user, provide a username with the remote
    system''s address:'
  id: totrans-20
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: 若要以不同用户身份执行命令，请提供远程系统的用户名和地址：
- en: '[PRE1]'
  id: totrans-21
  prefs:
  - PREF_IND
  type: TYPE_PRE
  zh: '[PRE1]'
- en: 'If the remote command requires `sudo`, supply `ssh` with the `-t` argument:'
  id: totrans-22
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: 如果远程命令需要 `sudo`，请为 `ssh` 提供 `-t` 参数：
- en: '[PRE2]'
  id: totrans-23
  prefs:
  - PREF_IND
  type: TYPE_PRE
  zh: '[PRE2]'
- en: 'Use the `-X` argument to forward the remote system''s X11 display to execute
    a graphical program:'
  id: totrans-24
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: 使用 `-X` 参数将远程系统的 X11 显示转发，用于执行图形程序：
- en: '[PRE3]'
  id: totrans-25
  prefs:
  - PREF_IND
  type: TYPE_PRE
  zh: '[PRE3]'
- en: 'Use quotes when you execute a complex command, for example, a series of commands
    or when using I/O redirection. This avoids ambiguity between the local and remote
    shells:'
  id: totrans-26
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: 执行复杂命令时，请使用引号，例如一系列命令或使用 I/O 重定向时。这样可以避免本地和远程 shell 之间的歧义：
- en: '[PRE4]'
  id: totrans-27
  prefs:
  - PREF_IND
  type: TYPE_PRE
  zh: '[PRE4]'
- en: 'You can pipe input from the local system to remote commands that read from
    stdin:'
  id: totrans-28
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: 你可以将来自本地系统的输入传输到远程命令，这些命令从 stdin 读取：
- en: '[PRE5]'
  id: totrans-29
  prefs:
  - PREF_IND
  type: TYPE_PRE
  zh: '[PRE5]'
- en: How it works...
  id: totrans-30
  prefs:
  - PREF_H2
  type: TYPE_NORMAL
  zh: 它是如何工作的...
- en: '`ssh` is used mainly to log in to a remote system and access an interactive
    shell because it''s possible that many people don''t know that commands can be
    executed remotely without a shell. This recipe presented several examples that
    illustrate how you can use `ssh` to run remote commands, each of which follow
    this general invocation pattern:'
  id: totrans-31
  prefs: []
  type: TYPE_NORMAL
  zh: '`ssh` 主要用于登录远程系统并访问交互式 shell，因为很多人可能不知道命令可以在没有 shell 的情况下远程执行。本篇提供了几个示例，说明了如何使用
    `ssh` 远程执行命令，每个示例都遵循这个通用调用模式：'
- en: '[PRE6]'
  id: totrans-32
  prefs: []
  type: TYPE_PRE
  zh: '[PRE6]'
- en: 'Anything provided after the remote host is accepted as the command to execute
    remotely by `ssh` as demonstrated in the following two examples. The first invokes
    `uname` to print information about the remote system such as the kernel, processor,
    and operating system, and the second runs `id` to display the username of the
    current effective user ID:'
  id: totrans-33
  prefs: []
  type: TYPE_NORMAL
  zh: 在远程主机后提供的任何内容都被 `ssh` 接受作为远程执行的命令，如以下两个示例所示。第一个命令调用 `uname` 打印关于远程系统的信息，例如内核、处理器和操作系统，第二个命令运行
    `id` 显示当前有效用户的用户名：
- en: '[PRE7]'
  id: totrans-34
  prefs: []
  type: TYPE_PRE
  zh: '[PRE7]'
- en: '`ssh` doesn''t launch an interactive shell when running these commands as there''s
    no reason for it to allocate a tty/pseudo-terminal; it acts as the shell itself
    and routes input and output between the remote and local systems. However, some
    commands require a terminal to function properly. For example, `sudo` uses the
    terminal to ensure the user''s password isn''t printed on the screen as they type
    it. Without a terminal, `sudo` refuses to run and reports back that `you must
    have a tty to run sudo`. We can provide the `-t` argument when executing such
    commands to force `ssh` to allocate a remote terminal resource:'
  id: totrans-35
  prefs: []
  type: TYPE_NORMAL
  zh: 当执行这些命令时，`ssh` 不会启动交互式 shell，因为没有必要分配一个 tty/伪终端；它本身作为 shell 执行，处理远程和本地系统之间的输入输出。然而，一些命令需要终端才能正常运行。例如，`sudo`
    使用终端确保用户输入密码时不会将其显示在屏幕上。如果没有终端，`sudo` 会拒绝运行，并报告 `you must have a tty to run sudo`。我们可以在执行这些命令时提供
    `-t` 参数，强制 `ssh` 分配远程终端资源：
- en: '[PRE8]'
  id: totrans-36
  prefs: []
  type: TYPE_PRE
  zh: '[PRE8]'
- en: 'The `-X` argument forwards the X11 display and allows us to run graphical programs.
    The program appears as if it were running in our local desktop environment, although
    in reality it''s running on the remote system:'
  id: totrans-37
  prefs: []
  type: TYPE_NORMAL
  zh: '`-X` 参数转发 X11 显示，允许我们运行图形化程序。尽管程序实际上是在远程系统上运行，但它显示得就像是在本地桌面环境中运行一样：'
- en: '[PRE9]'
  id: totrans-38
  prefs: []
  type: TYPE_PRE
  zh: '[PRE9]'
- en: '![How it works...](img/image_06_001.jpg)'
  id: totrans-39
  prefs: []
  type: TYPE_IMG
  zh: '![它是如何工作的...](img/image_06_001.jpg)'
- en: Graphical applications can be run using X11 forwarding
  id: totrans-40
  prefs: []
  type: TYPE_NORMAL
  zh: 可以通过 X11 转发运行图形化应用程序
- en: 'To make sure an invocation is interpreted how you intend, you may need to quote
    commands. This is especially true when using I/O redirection or when you are running
    multiple commands. To see why, consider the following example:'
  id: totrans-41
  prefs: []
  type: TYPE_NORMAL
  zh: 为了确保命令按您的意图被解析，您可能需要对命令加引号。当使用 I/O 重定向或运行多个命令时，尤其需要这样做。为了理解原因，请参考以下示例：
- en: '[PRE10]'
  id: totrans-42
  prefs: []
  type: TYPE_PRE
  zh: '[PRE10]'
- en: '`tar` outputs a list of files in the archive which is then redirected to create
    the `contents.txt` file. Everything happens remotely—`tar` runs on the remote
    system and the new file is created on the remote system.'
  id: totrans-43
  prefs: []
  type: TYPE_NORMAL
  zh: '`tar` 输出归档文件中的文件列表，然后将其重定向以创建 `contents.txt` 文件。所有操作都发生在远程系统——`tar` 在远程系统上运行，新文件也在远程系统上创建。'
- en: 'Now, here''s the same invocation but without quoting:'
  id: totrans-44
  prefs: []
  type: TYPE_NORMAL
  zh: 现在，这是相同的命令调用，但没有加引号：
- en: '[PRE11]'
  id: totrans-45
  prefs: []
  type: TYPE_PRE
  zh: '[PRE11]'
- en: '`tar` still executes remotely, but the local shell interprets the redirect
    and `contents.txt` is created on the local system.'
  id: totrans-46
  prefs: []
  type: TYPE_NORMAL
  zh: '`tar` 仍然在远程执行，但本地 shell 解析重定向，`contents.txt` 文件在本地系统上创建。'
- en: 'I/O redirection is possible in both directions. That is, we can pipe input
    from the local system to the remote system''s stdin:'
  id: totrans-47
  prefs: []
  type: TYPE_NORMAL
  zh: I/O 重定向可以在两个方向上进行。也就是说，我们可以将本地系统的输入通过管道传输到远程系统的标准输入：
- en: '[PRE12]'
  id: totrans-48
  prefs: []
  type: TYPE_PRE
  zh: '[PRE12]'
- en: In this example, `foo.txt` is read by `cat` and the contents are piped to the
    remote system. There, a remotely running instance of `cat` will be waiting to
    read the input. When it detects the end of the transmission, `cat` outputs what
    it received, which is then redirected to create `foo.txt` on the remote system.
    In essence, we've just made a copy of `foo.txt` from the local system to the remote
    system.
  id: totrans-49
  prefs: []
  type: TYPE_NORMAL
  zh: 在此示例中，`foo.txt` 被 `cat` 读取，内容通过管道传送到远程系统。在远程系统上，正在运行的 `cat` 实例将等待读取输入。当它检测到传输结束时，`cat`
    输出它接收到的内容，随后该内容被重定向以在远程系统上创建 `foo.txt`。本质上，我们刚刚将本地系统上的 `foo.txt` 复制到远程系统。
- en: See also
  id: totrans-50
  prefs:
  - PREF_H2
  type: TYPE_NORMAL
  zh: 另见
- en: 'Refer to the following resources for more information on running commands remotely
    through SSH:'
  id: totrans-51
  prefs: []
  type: TYPE_NORMAL
  zh: 有关通过 SSH 远程运行命令的更多信息，请参考以下资源：
- en: The `ssh` manual page (`man 1 ssh`)
  id: totrans-52
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: '`ssh` 手册页面（`man 1 ssh`）'
- en: Piping with SSH ([http://linux.icydog.net/ssh/piping.php](http://linux.icydog.net/ssh/piping.php))
  id: totrans-53
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: 使用 SSH 进行管道传输 ([http://linux.icydog.net/ssh/piping.php](http://linux.icydog.net/ssh/piping.php))
- en: Commandlinefu.com SSH commands ([http://www.commandlinefu.com/commands/matching/ssh/c3No/sort-by-votes](http://www.commandlinefu.com/commands/matching/ssh/c3No/sort-by-votes))
  id: totrans-54
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: Commandlinefu.com SSH 命令 ([http://www.commandlinefu.com/commands/matching/ssh/c3No/sort-by-votes](http://www.commandlinefu.com/commands/matching/ssh/c3No/sort-by-votes))
- en: Configuring a more secure SSH login
  id: totrans-55
  prefs:
  - PREF_H1
  type: TYPE_NORMAL
  zh: 配置更安全的 SSH 登录
- en: SSH is considered a secure alternative to older protocols, such as Telnet, rsh,
    and rlogin, because it encrypts the connection between the client and server.
    This encryption protects the traffic from any ne'er-do-wells who may be eavesdropping
    on the network. However, your system can still fall victim to the denial of service
    attacks or a malicious user who takes advantage of an idle session that was carelessly
    left unattended. This recipe takes the first steps in hardening SSH by updating
    the server's configuration to increase security surrounding remote logins.
  id: totrans-56
  prefs: []
  type: TYPE_NORMAL
  zh: SSH被认为是比旧的协议（如Telnet、rsh和rlogin）更安全的替代方案，因为它加密了客户端和服务器之间的连接。这种加密保护了网络中可能窃听的恶意用户免受攻击。然而，系统仍然可能遭遇拒绝服务攻击或恶意用户利用无人看管的空闲会话。此步骤通过更新服务器配置，增强了SSH的安全性，特别是在远程登录方面。
- en: Getting ready
  id: totrans-57
  prefs:
  - PREF_H2
  type: TYPE_NORMAL
  zh: 准备工作
- en: This recipe requires a CentOS system running the OpenSSH server. Administrative
    privileges are also required, either by logging in with the `root` account or
    through the use of `sudo`.
  id: totrans-58
  prefs: []
  type: TYPE_NORMAL
  zh: 本步骤适用于运行OpenSSH服务器的CentOS系统。也需要管理员权限，可以通过登录`root`账户或使用`sudo`来获得。
- en: How to do it...
  id: totrans-59
  prefs:
  - PREF_H2
  type: TYPE_NORMAL
  zh: 如何操作...
- en: 'Follow these steps to increase the security of your SSH logins:'
  id: totrans-60
  prefs: []
  type: TYPE_NORMAL
  zh: 按照以下步骤增强SSH登录的安全性：
- en: 'Open the SSH server''s configuration file with your text editor:'
  id: totrans-61
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
  zh: 使用文本编辑器打开SSH服务器的配置文件：
- en: '[PRE13]'
  id: totrans-62
  prefs:
  - PREF_IND
  type: TYPE_PRE
  zh: '[PRE13]'
- en: 'Locate the `LoginGraceTime` option. Uncomment it and change its value to `30`
    seconds to limit the amount of time users are given to provide their credentials:'
  id: totrans-63
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
  zh: 定位到`LoginGraceTime`选项。取消注释并将其值更改为`30`秒，以限制用户提供凭证的时间：
- en: '[PRE14]'
  id: totrans-64
  prefs:
  - PREF_IND
  type: TYPE_PRE
  zh: '[PRE14]'
- en: 'Find and uncomment the `PrintLastLog` option and change its value to `yes`
    to show the user the time and location of their last login:'
  id: totrans-65
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
  zh: 找到并取消注释`PrintLastLog`选项，并将其值更改为`yes`，以显示用户上次登录的时间和地点：
- en: '[PRE15]'
  id: totrans-66
  prefs:
  - PREF_IND
  type: TYPE_PRE
  zh: '[PRE15]'
- en: 'Uncomment the `Banner` option and set its value to `/etc/banner` to display
    a login warning to users:'
  id: totrans-67
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
  zh: 取消注释`Banner`选项并将其值设置为`/etc/banner`，以便向用户显示登录警告：
- en: '[PRE16]'
  id: totrans-68
  prefs:
  - PREF_IND
  type: TYPE_PRE
  zh: '[PRE16]'
- en: Save your changes and close the configuration file.
  id: totrans-69
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
  zh: 保存更改并关闭配置文件。
- en: 'Create the `/etc/banner` file with the following (or similar) verbiage:'
  id: totrans-70
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
  zh: 创建`/etc/banner`文件，并写入以下（或类似）内容：
- en: '[PRE17]'
  id: totrans-71
  prefs:
  - PREF_IND
  type: TYPE_PRE
  zh: '[PRE17]'
- en: 'Restart the SSH server for the configuration changes to take effect:'
  id: totrans-72
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
  zh: 重启SSH服务器，使配置更改生效：
- en: '[PRE18]'
  id: totrans-73
  prefs:
  - PREF_IND
  type: TYPE_PRE
  zh: '[PRE18]'
- en: 'To automatically log out sessions after 10 minutes of inactivity, create the
    `/etc/profile.d/timeout.sh` file with the following:'
  id: totrans-74
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
  zh: 为了在10分钟不活动后自动注销会话，请创建`/etc/profile.d/timeout.sh`文件，内容如下：
- en: '[PRE19]'
  id: totrans-75
  prefs:
  - PREF_IND
  type: TYPE_PRE
  zh: '[PRE19]'
- en: How it works...
  id: totrans-76
  prefs:
  - PREF_H2
  type: TYPE_NORMAL
  zh: 工作原理...
- en: 'The first option we adjusted in the SSH server''s configuration file was `LoginGraceTime`,
    to determine how long a user is allowed to enter their username and password.
    By default, the connection attempt times out if the user doesn''t provide their
    credentials within two minutes. We reduced this time to `30` seconds, but you
    can set a more appropriate value if you find this not to be long enough:'
  id: totrans-77
  prefs: []
  type: TYPE_NORMAL
  zh: 我们在SSH服务器配置文件中调整的第一个选项是`LoginGraceTime`，用于确定用户输入用户名和密码的时间长度。默认情况下，如果用户在两分钟内没有提供凭证，连接尝试会超时。我们将此时间减少到`30`秒，但如果您觉得时间不够，可以设置一个更合适的值：
- en: '[PRE20]'
  id: totrans-78
  prefs: []
  type: TYPE_PRE
  zh: '[PRE20]'
- en: 'Then, setting the `PrintLastLog` option''s value to `yes` causes the time and
    location of the user''s last log in to be displayed. This is helpful because an
    unknown time or location can alert a user if their account has been compromised
    and is being used for unauthorized access:'
  id: totrans-79
  prefs: []
  type: TYPE_NORMAL
  zh: 然后，将`PrintLastLog`选项的值设置为`yes`，使用户的上次登录时间和地点显示出来。这有助于因为不熟悉的时间或地点可能会警告用户其账户可能已经被入侵并用于未经授权的访问：
- en: '[PRE21]'
  id: totrans-80
  prefs: []
  type: TYPE_PRE
  zh: '[PRE21]'
- en: Next, we configured a login banner. A strongly-worded warning isn't likely to
    deter a malicious user, but many organizations require them to be prominently
    displayed when a user logs in for legal reasons. Such messages are considered
    to be sufficient notification in some jurisdictions to inform users that their
    actions are monitored and they should have no expectations of privacy for what
    they do on the system. This gives the organization better legal standing to prosecute
    any abuse.
  id: totrans-81
  prefs: []
  type: TYPE_NORMAL
  zh: 接下来，我们配置了登录横幅。虽然强烈措辞的警告不太可能威慑恶意用户，但许多组织要求在用户登录时根据法律要求显著显示这些警告信息。此类消息在一些司法管辖区被视为足够的通知，告知用户他们的行为正在被监视，且对系统上的活动不应期望隐私。这为组织提供了更强的法律依据，追究任何滥用行为。
- en: 'To display the warning before the login prompt, we set `Banner` with the path
    to a file containing our message. Then we created the file with the desired text:'
  id: totrans-82
  prefs: []
  type: TYPE_NORMAL
  zh: 为了在登录提示前显示警告，我们将`Banner`设置为指向包含消息的文件路径。然后我们创建了一个包含所需文本的文件：
- en: '[PRE22]'
  id: totrans-83
  prefs: []
  type: TYPE_PRE
  zh: '[PRE22]'
- en: '![How it works...](img/image_06_002.jpg)'
  id: totrans-84
  prefs: []
  type: TYPE_IMG
  zh: '![它是如何工作的...](img/image_06_002.jpg)'
- en: The user is presented with a banner message before logging in to the remote
    system
  id: totrans-85
  prefs: []
  type: TYPE_NORMAL
  zh: 用户在登录远程系统之前会看到横幅信息
- en: Note
  id: totrans-86
  prefs:
  - PREF_H3
  type: TYPE_NORMAL
  zh: 注意
- en: '`nroff` can be used to justify the banner''s text:'
  id: totrans-87
  prefs: []
  type: TYPE_NORMAL
  zh: '`nroff`可以用来调整横幅的文本对齐：'
- en: '`` `**(echo -e ".ll 75\n.pl 0\n.nh"; cat) | nroff > /etc/banner**` ``'
  id: totrans-88
  prefs: []
  type: TYPE_NORMAL
  zh: '`` `**(echo -e ".ll 75\n.pl 0\n.nh"; cat) | nroff > /etc/banner**` ``'
- en: '`cat` reads text from stdin (press ***Ctrl*** + ***D*** when you''re finished)
    and both the echo''d instructions and the text are piped to `nroff` for formatting.'
  id: totrans-89
  prefs: []
  type: TYPE_NORMAL
  zh: '`cat`从标准输入读取文本（当完成时按***Ctrl*** + ***D***），然后将echo输出的指令和文本通过管道传送到`nroff`进行格式化。'
- en: '`.ll` tells `nroff` to set the line length at `75` characters. It''s a good
    idea to use a value less than `80` because the traditional terminal displays `80`
    characters per line.'
  id: totrans-90
  prefs: []
  type: TYPE_NORMAL
  zh: '`.ll`告诉`nroff`将行长度设置为`75`个字符。建议使用小于`80`的值，因为传统终端每行显示`80`个字符。'
- en: '`.pl` sets the page length, and setting it `0` prevents `nroff` from adding
    additional whitespace after the text in an attempt to fill the length of some
    imaginary printed page.'
  id: totrans-91
  prefs: []
  type: TYPE_NORMAL
  zh: '`.pl`设置页面长度，将其设置为`0`可以防止`nroff`在文本后添加额外的空白，以试图填充某个假设的打印页面长度。'
- en: '`.nh` prevents `nroff` from hyphenating words at the end of a line.'
  id: totrans-92
  prefs: []
  type: TYPE_NORMAL
  zh: '`.nh`可以防止`nroff`在行末进行单词分割。'
- en: If you want to display the banner after the user logs in instead of before,
    you can use the message of the day file instead. In this case, uncomment the `PrintMotd`
    option and set its value to `yes` and then save your text in `/etc/motd`.
  id: totrans-93
  prefs: []
  type: TYPE_NORMAL
  zh: 如果你希望在用户登录后而不是之前显示横幅，可以使用当天消息文件。在这种情况下，取消注释`PrintMotd`选项并将其值设置为`yes`，然后将文本保存到`/etc/motd`中。
- en: 'Finally, we created the `/etc/profile.d/timeout.sh` file to set the `TMOUT`
    environment variable. Setting `TMOUT` under `/etc/profile.d` applies it globally
    to all users when they log in. To target individual users instead, or if you want
    to override the global value for specific users, you can place the export in their
    `~/.bash_profile` file:'
  id: totrans-94
  prefs: []
  type: TYPE_NORMAL
  zh: 最后，我们创建了`/etc/profile.d/timeout.sh`文件来设置`TMOUT`环境变量。在`/etc/profile.d`下设置`TMOUT`会在用户登录时全球应用它。要针对单个用户，或者如果你想为特定用户覆盖全局值，可以将`export`命令放入他们的`~/.bash_profile`文件中：
- en: '[PRE23]'
  id: totrans-95
  prefs: []
  type: TYPE_PRE
  zh: '[PRE23]'
- en: 'Now with the variable set, bash automatically closes the user''s session if
    it''s been inactive for the specified amount of time with the message `timed out
    waiting for input: auto-logout`. The value is given in seconds, with the recipe''s
    example closing idle sessions after 10 minutes.'
  id: totrans-96
  prefs: []
  type: TYPE_NORMAL
  zh: '现在，设置了该变量后，bash会在用户一段时间未活动时自动关闭会话，显示消息`timed out waiting for input: auto-logout`。该值以秒为单位，示例配方会在10分钟后关闭空闲会话。'
- en: See also
  id: totrans-97
  prefs:
  - PREF_H2
  type: TYPE_NORMAL
  zh: 另请参见
- en: 'Refer to the following resources for more information on tightening security
    on SSH logins:'
  id: totrans-98
  prefs: []
  type: TYPE_NORMAL
  zh: 请参考以下资源，了解如何加强SSH登录的安全性：
- en: The `sshd_config` manual page (`man 5 sshd_config`)
  id: totrans-99
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: '`sshd_config` 手册页 (`man 5 sshd_config`)'
- en: 'RHEL 7 System Administrator''s Guide: OpenSSH ([https://access.redhat.com/documentation/en-US/Red_Hat_Enterprise_Linux/7/html/System_Administrators_Guide/ch-OpenSSH.html](https://access.redhat.com/documentation/en-US/Red_Hat_Enterprise_Linux/7/html/System_Administrators_Guide/ch-OpenSSH.html))'
  id: totrans-100
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: RHEL 7 系统管理员指南：OpenSSH ([https://access.redhat.com/documentation/en-US/Red_Hat_Enterprise_Linux/7/html/System_Administrators_Guide/ch-OpenSSH.html](https://access.redhat.com/documentation/en-US/Red_Hat_Enterprise_Linux/7/html/System_Administrators_Guide/ch-OpenSSH.html))
- en: 'CentOS Wiki: Securing OpenSSH ([https://wiki.centos.org/HowTos/Network/SecuringSSH](https://wiki.centos.org/HowTos/Network/SecuringSSH))'
  id: totrans-101
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: CentOS Wiki：保护OpenSSH ([https://wiki.centos.org/HowTos/Network/SecuringSSH](https://wiki.centos.org/HowTos/Network/SecuringSSH))
- en: Should I use a login banner? ([http://serverfault.com/questions/24376/should-i-use-a-login-banner-and-if-so-what-should-it-say](http://serverfault.com/questions/24376/should-i-use-a-login-banner-and-if-so-what-should-it-say))
  id: totrans-102
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: 我应该使用登录横幅吗？([http://serverfault.com/questions/24376/should-i-use-a-login-banner-and-if-so-what-should-it-say](http://serverfault.com/questions/24376/should-i-use-a-login-banner-and-if-so-what-should-it-say))
- en: Securely connecting to SSH without a password
  id: totrans-103
  prefs:
  - PREF_H1
  type: TYPE_NORMAL
  zh: 无密码安全连接到SSH
- en: This recipe teaches you how to generate a key pair and set up key-based authentication
    for SSH sessions, allowing you to secretly connect to a remote system without
    using a password. Key-based authentication is considered more secure than using
    a password because a weak password can be easy to guess and a strong password
    can be easy to forget and more likely to be written down. In either case, an attacker
    has a fairly good chance of discovering a user's password. With key-based authentication,
    a user must supply the correct private key file, which is practically impossible
    to crack or spoof.
  id: totrans-104
  prefs: []
  type: TYPE_NORMAL
  zh: 本教程教你如何生成密钥对，并为 SSH 会话设置基于密钥的认证，允许你在不使用密码的情况下秘密连接到远程系统。基于密钥的认证被认为比使用密码更安全，因为弱密码容易被猜测，而强密码则可能容易忘记且更容易被记录下来。在这两种情况下，攻击者都有较大的机会发现用户的密码。而通过基于密钥的认证，用户必须提供正确的私钥文件，几乎不可能被破解或伪造。
- en: Getting ready
  id: totrans-105
  prefs:
  - PREF_H2
  type: TYPE_NORMAL
  zh: 准备工作
- en: This recipe requires a remote system running the OpenSSH server and a local
    computer with the OpenSSH SSH client installed. Its examples assume that the remote
    system is configured with the IP address `192.168.56.100`. Also, you will need
    an available user account on the remote system.
  id: totrans-106
  prefs: []
  type: TYPE_NORMAL
  zh: 本教程需要远程系统运行 OpenSSH 服务器，并且本地计算机上已安装 OpenSSH SSH 客户端。示例假设远程系统的 IP 地址为 `192.168.56.100`。另外，你需要在远程系统上有一个可用的用户账户。
- en: How to do it...
  id: totrans-107
  prefs:
  - PREF_H2
  type: TYPE_NORMAL
  zh: 如何操作...
- en: 'Follow these steps to set up key-based authentication for SSH sessions:'
  id: totrans-108
  prefs: []
  type: TYPE_NORMAL
  zh: 按照以下步骤设置 SSH 会话的基于密钥的认证：
- en: 'On the local computer, use the `ssh-keygen` command to create a pair of authentication
    keys. Accept the default path/filename for the keys and leave the passphrase empty:'
  id: totrans-109
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
  zh: 在本地计算机上，使用 `ssh-keygen` 命令创建一对认证密钥。接受默认路径/文件名并保持空白的密码短语：
- en: '[PRE24]'
  id: totrans-110
  prefs:
  - PREF_IND
  type: TYPE_PRE
  zh: '[PRE24]'
- en: 'Create the `.ssh` directory if it doesn''t already exist in your remote home
    directory:'
  id: totrans-111
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
  zh: 如果远程主目录下还没有 `.ssh` 目录，创建该目录：
- en: '[PRE25]'
  id: totrans-112
  prefs:
  - PREF_IND
  type: TYPE_PRE
  zh: '[PRE25]'
- en: 'Append the contents of `id_rsa.pub` to `.ssh/authorized_keys` on the remote
    system:'
  id: totrans-113
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
  zh: 将 `id_rsa.pub` 的内容追加到远程系统上的 `.ssh/authorized_keys` 文件中：
- en: '[PRE26]'
  id: totrans-114
  prefs:
  - PREF_IND
  type: TYPE_PRE
  zh: '[PRE26]'
- en: 'Secure the `authorized_keys` file''s permissions:'
  id: totrans-115
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
  zh: 确保 `authorized_keys` 文件的权限：
- en: '[PRE27]'
  id: totrans-116
  prefs:
  - PREF_IND
  type: TYPE_PRE
  zh: '[PRE27]'
- en: 'Verify that you can connect to the remote system without providing a password:'
  id: totrans-117
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
  zh: 验证是否可以在不提供密码的情况下连接到远程系统：
- en: '[PRE28]'
  id: totrans-118
  prefs:
  - PREF_IND
  type: TYPE_PRE
  zh: '[PRE28]'
- en: Repeat steps 2 through 5 for any additional remote systems you want to log in
    to using key-based authentication.
  id: totrans-119
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
  zh: 对于任何额外的远程系统，只要你希望使用基于密钥的认证登录，重复步骤 2 到 5。
- en: How it works...
  id: totrans-120
  prefs:
  - PREF_H2
  type: TYPE_NORMAL
  zh: 工作原理...
- en: 'Key-based authentication is considered more secure than using passwords because
    it''s nearly impractical to crack a suitable encryption key while brute forcing
    a password is trivial. This recipe used the OpenSSH suite''s `ssh-keygen` program
    to generate a new pair of keys, which we then used to authenticate our SSH session:'
  id: totrans-121
  prefs: []
  type: TYPE_NORMAL
  zh: 基于密钥的认证被认为比使用密码更安全，因为破解合适的加密密钥几乎不可能，而暴力破解密码则很简单。本教程使用了 OpenSSH 套件中的 `ssh-keygen`
    程序生成了新的密钥对，然后我们用它来验证我们的 SSH 会话：
- en: '[PRE29]'
  id: totrans-122
  prefs: []
  type: TYPE_PRE
  zh: '[PRE29]'
- en: '`-C` embeds a brief comment in the key which is useful for identifying the
    owner or purpose of a key and `-b` sets the number of bits used for the key''s
    modulus. The more bits used, the larger the number that can be represented, which
    means greater resistance to cracking attacks. If `-b` isn''t provided, the default
    value is 2,048 bits. Based on the estimates of the rate at which computing power
    increases, 2,048 is generally thought to be suitable until around the year 2030
    (researchers developed a successful attack against 1,024-bit keys in 2010). A
    3,072-bit key is considered suitable beyond 2030.'
  id: totrans-123
  prefs: []
  type: TYPE_NORMAL
  zh: '`-C` 在密钥中嵌入一个简短的注释，这对于识别密钥的所有者或用途很有帮助，`-b` 设置用于密钥模数的位数。使用的位数越多，可以表示的数字越大，这意味着更强的破解抗性。如果没有提供
    `-b`，默认值为 2,048 位。根据计算能力增长的估算，2,048 位的密钥通常认为适用于 2030 年之前（研究人员在 2010 年成功攻破了 1,024
    位的密钥）。3,072 位的密钥被认为适用于 2030 年以后。'
- en: We accepted the suggested `~/.ssh/id_rsa` value as the name of the output file
    when prompted (this is where `ssh` looks for our private identity key by default
    when we connect to a remote server). We also didn't provide a passphrase. If we
    were to give one, then the key would be encrypted and we'd need to provide the
    password to decrypt the key every time we wanted to use it.
  id: totrans-124
  prefs: []
  type: TYPE_NORMAL
  zh: 在提示时，我们接受了建议的 `~/.ssh/id_rsa` 作为输出文件名（这是 `ssh` 默认在连接到远程服务器时查找我们的私钥的位置）。我们也没有提供密码短语。如果我们提供密码短语，那么密钥将被加密，并且每次使用密钥时，我们都需要提供密码来解密它。
- en: 'When `ssh-keygen` is finished, the private key `id_rsa` and the public key
    `id_rsa.pub` can be found in the `.ssh` directory:'
  id: totrans-125
  prefs: []
  type: TYPE_NORMAL
  zh: 当`ssh-keygen`完成时，私钥`id_rsa`和公钥`id_rsa.pub`将保存在`.ssh`目录中：
- en: '![How it works...](img/image_06_003.jpg)'
  id: totrans-126
  prefs: []
  type: TYPE_IMG
  zh: '![如何工作...](img/image_06_003.jpg)'
- en: The pair of keys is generated for password-less authentication
  id: totrans-127
  prefs: []
  type: TYPE_NORMAL
  zh: 密钥对用于无密码认证
- en: 'Then, we created the `.ssh` directory in our home directory on the remote system.
    You can execute the `mkdir` command while being logged in to the remote system,
    otherwise you can execute the command remotely through SSH:'
  id: totrans-128
  prefs: []
  type: TYPE_NORMAL
  zh: 然后，我们在远程系统的主目录中创建了`.ssh`目录。你可以在登录远程系统时执行`mkdir`命令，否则可以通过SSH远程执行该命令：
- en: '[PRE30]'
  id: totrans-129
  prefs: []
  type: TYPE_PRE
  zh: '[PRE30]'
- en: 'Next, we added the public key to `.ssh/authorized_keys` on the remote system:'
  id: totrans-130
  prefs: []
  type: TYPE_NORMAL
  zh: 接下来，我们将公钥添加到远程系统的`.ssh/authorized_keys`中：
- en: '[PRE31]'
  id: totrans-131
  prefs: []
  type: TYPE_PRE
  zh: '[PRE31]'
- en: 'Because proper permissions help ensure the security of your keys, `ssh` won''t
    consider them safe to use if the permissions are too lax. The permissions on the
    `.ssh` directory should be read, write, and execute permissions only for the owner
    (`700`), read permissions for the owner and group, and write permissions for the
    owner (`640`) on `authorized_keys`. A simple `chmod` call ensures that everything
    is correct:'
  id: totrans-132
  prefs: []
  type: TYPE_NORMAL
  zh: 由于正确的权限有助于确保密钥的安全，`ssh`不会考虑使用权限过于宽松的密钥。`.ssh`目录的权限应该仅限于所有者的读、写、执行权限（`700`），`authorized_keys`文件的权限应该是所有者和组的读权限，以及所有者的写权限（`640`）。通过简单的`chmod`命令确保一切正确：
- en: '[PRE32]'
  id: totrans-133
  prefs: []
  type: TYPE_PRE
  zh: '[PRE32]'
- en: When we connect, `ssh` sees the `id_rsa` file and sends our private key as part
    of the connection request. The server checks for the corresponding public key
    in the `authorized_keys` file, and if everything matches up then we're authorized
    and logged in.
  id: totrans-134
  prefs: []
  type: TYPE_NORMAL
  zh: 当我们连接时，`ssh`会看到`id_rsa`文件，并将我们的私钥作为连接请求的一部分发送。服务器在`authorized_keys`文件中检查相应的公钥，如果一切匹配，我们就会被授权并登录。
- en: See also
  id: totrans-135
  prefs:
  - PREF_H2
  type: TYPE_NORMAL
  zh: 另请参见
- en: 'Refer to the following resources for more information on using key-based authentication
    with OpenSSH:'
  id: totrans-136
  prefs: []
  type: TYPE_NORMAL
  zh: 有关使用基于密钥的身份验证与OpenSSH的更多信息，请参考以下资源：
- en: 'RHEL 7 System Administrator''s Guide: OpenSSH ([https://access.redhat.com/documentation/en-US/Red_Hat_Enterprise_Linux/7/html/System_Administrators_Guide/ch-OpenSSH.html](https://access.redhat.com/documentation/en-US/Red_Hat_Enterprise_Linux/7/html/System_Administrators_Guide/ch-OpenSSH.html))'
  id: totrans-137
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: RHEL 7 系统管理员指南：OpenSSH ([https://access.redhat.com/documentation/en-US/Red_Hat_Enterprise_Linux/7/html/System_Administrators_Guide/ch-OpenSSH.html](https://access.redhat.com/documentation/en-US/Red_Hat_Enterprise_Linux/7/html/System_Administrators_Guide/ch-OpenSSH.html))
- en: SSH password versus key authentication ([http://security.stackexchange.com/questions/33381/ssh-password-vs-key-authentication](http://security.stackexchange.com/questions/33381/ssh-password-vs-key-authentication))
  id: totrans-138
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: SSH 密码与密钥认证 ([http://security.stackexchange.com/questions/33381/ssh-password-vs-key-authentication](http://security.stackexchange.com/questions/33381/ssh-password-vs-key-authentication))
- en: Restricting SSH access by user or group
  id: totrans-139
  prefs:
  - PREF_H1
  type: TYPE_NORMAL
  zh: 按用户或组限制SSH访问
- en: Depending on the role of your system and which user accounts are configured
    on it, you may not want all of its registered users to have access through SSH.
    This recipe shows you how to configure the SSH server to restrict remote user
    access by explicitly granting or denying the users access.
  id: totrans-140
  prefs: []
  type: TYPE_NORMAL
  zh: 根据你系统的角色和已配置的用户帐户，你可能不希望所有已注册的用户都能通过SSH访问。此指南向你展示了如何配置SSH服务器，明确授予或拒绝用户访问权限。
- en: Getting ready
  id: totrans-141
  prefs:
  - PREF_H2
  type: TYPE_NORMAL
  zh: 准备工作
- en: This recipe requires a CentOS system running the OpenSSH server. Administrative
    privileges are also required, either by logging in with the `root` account or
    through the use of `sudo`.
  id: totrans-142
  prefs: []
  type: TYPE_NORMAL
  zh: 本指南要求在运行OpenSSH服务器的CentOS系统上操作。还需要管理员权限，可以通过`root`账户登录，或者使用`sudo`来获取权限。
- en: How to do it...
  id: totrans-143
  prefs:
  - PREF_H2
  type: TYPE_NORMAL
  zh: 操作步骤...
- en: 'Follow these steps to restrict users'' SSH access:'
  id: totrans-144
  prefs: []
  type: TYPE_NORMAL
  zh: 按照以下步骤限制用户的SSH访问：
- en: 'Open the SSH server''s configuration file with your text editor:'
  id: totrans-145
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
  zh: 使用文本编辑器打开SSH服务器的配置文件：
- en: '[PRE33]'
  id: totrans-146
  prefs:
  - PREF_IND
  type: TYPE_PRE
  zh: '[PRE33]'
- en: 'Find the `PermitEmptyPasswords` option. Uncomment it and set its value to `no`
    to disallow accounts with empty passwords:'
  id: totrans-147
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
  zh: 找到`PermitEmptyPasswords`选项。取消注释并将其值设置为`no`，以禁止使用空密码的帐户：
- en: '[PRE34]'
  id: totrans-148
  prefs:
  - PREF_IND
  type: TYPE_PRE
  zh: '[PRE34]'
- en: 'To disallow remote access with the `root` account, locate and uncomment the
    `PermitRootLogin` option and set its value to `no`:'
  id: totrans-149
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
  zh: 要禁用`root`账户的远程访问，找到并取消注释`PermitRootLogin`选项，将其值设置为`no`：
- en: '[PRE35]'
  id: totrans-150
  prefs:
  - PREF_IND
  type: TYPE_PRE
  zh: '[PRE35]'
- en: 'Deny remote access for specific user accounts by adding an entry for `DenyUsers`.
    The option''s value should be a space-separated list of usernames you want to
    deny:'
  id: totrans-151
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
  zh: 通过为`DenyUsers`添加条目，禁止特定用户帐户的远程访问。该选项的值应该是一个空格分隔的用户名列表，表示你要拒绝访问的用户：
- en: '[PRE36]'
  id: totrans-152
  prefs:
  - PREF_IND
  type: TYPE_PRE
  zh: '[PRE36]'
- en: 'Deny remote access for users who are members of a specific group by adding
    an entry for `DenyGroups`:'
  id: totrans-153
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
  zh: 通过为`DenyGroups`添加条目，拒绝特定组成员的远程访问：
- en: '[PRE37]'
  id: totrans-154
  prefs:
  - PREF_IND
  type: TYPE_PRE
  zh: '[PRE37]'
- en: 'Add an `AllowUsers` entry to deny access to everyone except those in the list
    of permitted users:'
  id: totrans-155
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
  zh: 添加`AllowUsers`条目，以拒绝所有除许可用户列表中的人以外的访问：
- en: '[PRE38]'
  id: totrans-156
  prefs:
  - PREF_IND
  type: TYPE_PRE
  zh: '[PRE38]'
- en: 'Add an `AllowGroups` entry to deny access to everyone except those in the list
    of permitted groups:'
  id: totrans-157
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
  zh: 添加`AllowGroups`条目，以拒绝所有除许可组列表中的人以外的访问：
- en: '[PRE39]'
  id: totrans-158
  prefs:
  - PREF_IND
  type: TYPE_PRE
  zh: '[PRE39]'
- en: Save your changes and close the file.
  id: totrans-159
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
  zh: 保存更改并关闭文件。
- en: 'Restart the SSH server for the changes to take effect:'
  id: totrans-160
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
  zh: 重启 SSH 服务器使更改生效：
- en: '[PRE40]'
  id: totrans-161
  prefs:
  - PREF_IND
  type: TYPE_PRE
  zh: '[PRE40]'
- en: How it works...
  id: totrans-162
  prefs:
  - PREF_H2
  type: TYPE_NORMAL
  zh: 它是如何工作的...
- en: 'First, we uncommented `PermitEmptyPasswords` and set its value to `no`. This
    prevents user accounts that don''t have a password from being used to log in over
    SSH:'
  id: totrans-163
  prefs: []
  type: TYPE_NORMAL
  zh: 首先，我们取消注释`PermitEmptyPasswords`并将其值设置为`no`。这可以防止没有密码的用户帐户通过 SSH 登录：
- en: '[PRE41]'
  id: totrans-164
  prefs: []
  type: TYPE_PRE
  zh: '[PRE41]'
- en: Passwords are the first level of defense in protecting ourselves from malicious
    attacks using compromised user accounts. Without a strong password, anyone can
    log in simply by knowing the username. This is a scary thought because usernames
    can be easily guessed and sometimes are even publicly available in the form of
    e-mail addresses and so on.
  id: totrans-165
  prefs: []
  type: TYPE_NORMAL
  zh: 密码是保护我们免受恶意攻击（通过被破坏的用户帐户）的第一道防线。没有强密码，任何人只需知道用户名就可以轻松登录。这是一个可怕的想法，因为用户名很容易被猜到，有时甚至以电子邮件地址等形式公开。
- en: 'Next, we uncommented the `PermitRootLogin` option and set its value to `no`.
    This prevents `root` from establishing an SSH session directly:'
  id: totrans-166
  prefs: []
  type: TYPE_NORMAL
  zh: 接下来，我们取消注释`PermitRootLogin`选项并将其值设置为`no`。这可以防止`root`直接建立 SSH 会话：
- en: '[PRE42]'
  id: totrans-167
  prefs: []
  type: TYPE_PRE
  zh: '[PRE42]'
- en: Such restrictions were of critical importance when protocols such as Telnet
    were used because the username and password were often sent across the network
    in plain text—an attacker could easily monitor the network traffic and capture
    the password. However, even though SSH makes this concern moot by encrypting its
    traffic, the password is still vulnerable from brute force cracking attacks. For
    this reason, it's wise to require users to authenticate using their unprivileged
    account first and then use `su` or `sudo` to elevate their privileges when necessary
    (refer to [Chapter 3](ch03.html "Chapter 3. User and Permission Management"),
    *User and Permission Management*).
  id: totrans-168
  prefs: []
  type: TYPE_NORMAL
  zh: 这样的限制在使用 Telnet 等协议时至关重要，因为用户名和密码经常以明文形式通过网络传输——攻击者可以轻松监控网络流量并捕获密码。然而，尽管 SSH
    通过加密其流量使这个问题变得无关紧要，但密码仍然容易受到暴力破解攻击。因此，明智的做法是要求用户首先使用其无特权帐户进行身份验证，然后在必要时使用`su`或`sudo`提升权限（请参阅[第3章](ch03.html
    "第3章 用户与权限管理")，*用户与权限管理*）。
- en: The recipe then presented the `DenyUsers`, `DenyGroups`, `AllowUsers`, and `AllowGroups`
    options as a way to restrict SSH access on a larger scale.
  id: totrans-169
  prefs: []
  type: TYPE_NORMAL
  zh: 该方案随后介绍了`DenyUsers`、`DenyGroups`、`AllowUsers`和`AllowGroups`选项，作为大范围限制 SSH 访问的方法。
- en: 'The `DenyUsers` option prohibits specific users from logging in. While other
    user accounts will be able to access the system remotely, the users listed under
    `DenyUsers` will see the message `Permission Denied`. The recipe''s example denies
    access to the users `bbarrera`, `jbhuse`, and `mbutterfield`:'
  id: totrans-170
  prefs: []
  type: TYPE_NORMAL
  zh: '`DenyUsers`选项禁止特定用户登录。其他用户帐户仍然可以远程访问系统，但在`DenyUsers`下列出的用户将看到`Permission Denied`消息。该方案的示例拒绝`bbarrera`、`jbhuse`和`mbutterfield`的访问：'
- en: '[PRE43]'
  id: totrans-171
  prefs: []
  type: TYPE_PRE
  zh: '[PRE43]'
- en: 'The `DenyGroups` option works similarly, but denies users based on their group
    membership; the following example denies access to anyone who''s a member of the
    `users` group or the `noremote` group:'
  id: totrans-172
  prefs: []
  type: TYPE_NORMAL
  zh: '`DenyGroups`选项的工作原理类似，但它根据用户的组成员资格来拒绝用户访问；以下示例拒绝所有属于`users`组或`noremote`组的用户访问：'
- en: '[PRE44]'
  id: totrans-173
  prefs: []
  type: TYPE_PRE
  zh: '[PRE44]'
- en: 'The denial options are useful for blacklisting a small number of users. To
    block all users except for a select few, we use the allow options. `AllowUsers`
    denies access to everyone except those specified. `AllowGroups` is its counterpart
    allowing only those users who are members of the specified group:'
  id: totrans-174
  prefs: []
  type: TYPE_NORMAL
  zh: 拒绝选项对于将少数用户列入黑名单非常有用。要阻止所有用户，除了几个特定的用户，我们使用允许选项。`AllowUsers`拒绝所有人访问，除非在指定的用户列表中。`AllowGroups`是其对应选项，仅允许指定组成员的用户访问：
- en: '[PRE45]'
  id: totrans-175
  prefs: []
  type: TYPE_PRE
  zh: '[PRE45]'
- en: 'The options can also have values that use `*` and `?` as wildcards. `*` matches
    zero or more characters and `?` matches a single character. For example, the following
    denies all users:'
  id: totrans-176
  prefs: []
  type: TYPE_NORMAL
  zh: 这些选项也可以具有使用`*`和`?`作为通配符的值。`*`匹配零个或多个字符，`?`匹配单个字符。例如，以下内容拒绝所有用户：
- en: '[PRE46]'
  id: totrans-177
  prefs: []
  type: TYPE_PRE
  zh: '[PRE46]'
- en: Note
  id: totrans-178
  prefs:
  - PREF_H3
  type: TYPE_NORMAL
  zh: 注意
- en: '`AllowUsers` and `AllowGroups` deny all users/groups except the ones they list.
    Be careful if you depend on SSH to administer your servers because it''s very
    easy to block yourself with these. Before logging out of your current SSH session,
    check that you can successfully log in using a second terminal. If there''s a
    problem, you''ll still be logged in with the first session and will able to fix
    the issue.'
  id: totrans-179
  prefs: []
  type: TYPE_NORMAL
  zh: '`AllowUsers` 和 `AllowGroups` 会拒绝所有未列出的用户/组。使用这些选项时要小心，特别是如果你依赖 SSH 来管理服务器，因为很容易会把自己屏蔽出去。在退出当前
    SSH 会话之前，请确保你能通过第二个终端成功登录。如果出现问题，你仍然可以通过第一个会话登录并解决问题。'
- en: See also
  id: totrans-180
  prefs:
  - PREF_H2
  type: TYPE_NORMAL
  zh: 另见
- en: 'Refer to the following for more information on restricting remote SSH access:'
  id: totrans-181
  prefs: []
  type: TYPE_NORMAL
  zh: 请参考以下内容，了解如何限制远程 SSH 访问：
- en: The `sshd_config` manual page (`man 5 sshd_config`)
  id: totrans-182
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: '`sshd_config` 手册页面 (`man 5 sshd_config`)'
- en: 'RHEL 7 System Administrator''s Guide: OpenSSH ([https://access.redhat.com/documentation/en-US/Red_Hat_Enterprise_Linux/7/html/System_Administrators_Guide/ch-OpenSSH.html](https://access.redhat.com/documentation/en-US/Red_Hat_Enterprise_Linux/7/html/System_Administrators_Guide/ch-OpenSSH.html))'
  id: totrans-183
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: RHEL 7 系统管理员指南：OpenSSH ([https://access.redhat.com/documentation/en-US/Red_Hat_Enterprise_Linux/7/html/System_Administrators_Guide/ch-OpenSSH.html](https://access.redhat.com/documentation/en-US/Red_Hat_Enterprise_Linux/7/html/System_Administrators_Guide/ch-OpenSSH.html))
- en: SSH how to deny all users except for one? ([http://www.linuxquestions.org/questions/linux-security-4/howto-sshd-deny-all-users-except-for-one-368752/](http://www.linuxquestions.org/questions/linux-security-4/howto-sshd-deny-all-users-except-for-one-368752/))
  id: totrans-184
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: 如何在 SSH 中拒绝所有用户，除了一个用户？ ([http://www.linuxquestions.org/questions/linux-security-4/howto-sshd-deny-all-users-except-for-one-368752/](http://www.linuxquestions.org/questions/linux-security-4/howto-sshd-deny-all-users-except-for-one-368752/))
- en: Protecting SSH with Fail2ban
  id: totrans-185
  prefs:
  - PREF_H1
  type: TYPE_NORMAL
  zh: 使用 Fail2ban 保护 SSH
- en: A determined attacker may try to brute force a user's password to gain access
    or attempt repeated logins to consume network and system resources as part of
    a denial of service attack. Fail2ban can help protect you from such attacks by
    monitoring a server's log files, identifying suspicious activity, and automatically
    banning the IP addresses responsible for the activity. This recipe teaches you
    how to install Fail2ban to safeguard your system.
  id: totrans-186
  prefs: []
  type: TYPE_NORMAL
  zh: 一名决心十足的攻击者可能会尝试暴力破解用户密码以获取访问权限，或者进行多次尝试登录，以消耗网络和系统资源，作为拒绝服务攻击的一部分。Fail2ban 可以帮助你防范此类攻击，通过监控服务器的日志文件，识别可疑活动，并自动封禁这些活动的
    IP 地址。本教程将教你如何安装 Fail2ban 来保护你的系统。
- en: Getting ready
  id: totrans-187
  prefs:
  - PREF_H2
  type: TYPE_NORMAL
  zh: 准备工作
- en: This recipe requires a CentOS system running the OpenSSH server. Administrative
    privileges are also required, either by logging in with the `root` account or
    through the use of `sudo`. The `fail2ban` package is hosted by the EPEL repository;
    if the repository is not already registered, refer to the *Registering the EPEL
    and Remi repositories* recipe in [Chapter 4](ch04.html "Chapter 4. Software Installation
    Management"), *Software Installation Management*.
  id: totrans-188
  prefs: []
  type: TYPE_NORMAL
  zh: 本教程需要一台运行 OpenSSH 服务器的 CentOS 系统，并且需要管理员权限，可以通过登录 `root` 账户或使用 `sudo` 获取权限。`fail2ban`
    包由 EPEL 仓库提供，如果仓库尚未注册，请参考 [第 4 章](ch04.html "第 4 章 软件安装管理")中的 *注册 EPEL 和 Remi
    仓库* 配方，*软件安装管理*。
- en: How to do it...
  id: totrans-189
  prefs:
  - PREF_H2
  type: TYPE_NORMAL
  zh: 如何操作...
- en: 'Follow these steps to protect your system with Fail2ban:'
  id: totrans-190
  prefs: []
  type: TYPE_NORMAL
  zh: 按照以下步骤使用 Fail2ban 保护你的系统：
- en: 'Install the `fail2ban` package:'
  id: totrans-191
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
  zh: 安装 `fail2ban` 包：
- en: '[PRE47]'
  id: totrans-192
  prefs:
  - PREF_IND
  type: TYPE_PRE
  zh: '[PRE47]'
- en: 'Create the jail configuration file `/etc/fail2ban/jail.local` using the following
    contents:'
  id: totrans-193
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
  zh: 使用以下内容创建监狱配置文件 `/etc/fail2ban/jail.local`：
- en: '[PRE48]'
  id: totrans-194
  prefs:
  - PREF_IND
  type: TYPE_PRE
  zh: '[PRE48]'
- en: 'Start the Fail2ban service and enable its automatic start-up when the system
    boots:'
  id: totrans-195
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
  zh: 启动 Fail2ban 服务，并在系统启动时启用其自动启动：
- en: '[PRE49]'
  id: totrans-196
  prefs:
  - PREF_IND
  type: TYPE_PRE
  zh: '[PRE49]'
- en: 'To view the `sshd` jail''s status, use `fail2ban-client` with the `status`
    command:'
  id: totrans-197
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
  zh: 要查看 `sshd` 监狱的状态，可以使用 `fail2ban-client` 配合 `status` 命令：
- en: '[PRE50]'
  id: totrans-198
  prefs:
  - PREF_IND
  type: TYPE_PRE
  zh: '[PRE50]'
- en: How it works...
  id: totrans-199
  prefs:
  - PREF_H2
  type: TYPE_NORMAL
  zh: 它是如何工作的...
- en: You've learned how to install Fail2ban and configure automated IP blocking after
    several failed login attempts. You also learned how to manually ban and unban
    addresses using `fail2ban-client`.
  id: totrans-200
  prefs: []
  type: TYPE_NORMAL
  zh: 你已经学会了如何安装 Fail2ban 并配置在多次登录失败后自动屏蔽 IP 地址。你还学会了如何使用 `fail2ban-client` 手动封禁和解封地址。
- en: A Fail2ban jail configuration brings together filter and action definitions
    to perform an activity whenever certain patterns are observed in a server's log
    file. Filters specify the pattern definitions for identifying interesting log
    entries, for example, repeated authentication failures. Actions, on the other
    hand, define the commands that run when a filter is matched. Fail2ban is shipped
    with several predefined filters for common servers such as Apache, MySQL, Sendmail,
    and SSH, and several predefined actions such as managing iptable entries to block
    and unblock IP addresses, sending e-mail notifications, and triggering DNS updates.
  id: totrans-201
  prefs: []
  type: TYPE_NORMAL
  zh: 一个 Fail2ban 监狱配置将过滤器和操作定义结合起来，当在服务器的日志文件中观察到某些模式时，执行相应的活动。过滤器指定用于识别有意义日志条目的模式定义，例如，重复的身份验证失败。另一方面，操作定义了当过滤器匹配时要执行的命令。Fail2ban
    随附了多个预定义的过滤器，适用于 Apache、MySQL、Sendmail 和 SSH 等常见服务器，并且还提供了多个预定义操作，例如管理 iptable
    条目以封禁和解除封禁 IP 地址、发送电子邮件通知以及触发 DNS 更新。
- en: 'There are several jails defined in `/etc/fail2ban/jail.conf`. To activate the
    `sshd` jail, we created the `jail.local` file with entries that override and extend
    the default jail definition:'
  id: totrans-202
  prefs: []
  type: TYPE_NORMAL
  zh: 在 `/etc/fail2ban/jail.conf` 中定义了多个监狱。为了激活 `sshd` 监狱，我们创建了 `jail.local` 文件，并在其中添加了覆盖和扩展默认监狱定义的条目：
- en: '[PRE51]'
  id: totrans-203
  prefs: []
  type: TYPE_PRE
  zh: '[PRE51]'
- en: Intuitively, the `enabled` option enables or disables the jail. `maxretry`,
    which we set to `5`, is the number of failed login attempts permitted before Fail2ban
    enacts the ban. `bantime` sets how long the ban will last, which we set to `86400`
    seconds. With this configuration, users are allowed up to `5` failed attempts
    before their IP address is banned for 24 hours.
  id: totrans-204
  prefs: []
  type: TYPE_NORMAL
  zh: 从直观上看，`enabled` 选项用于启用或禁用监狱。`maxretry` 设置为 `5`，表示允许失败的登录尝试次数，在超过这个次数后，Fail2ban
    将执行封禁操作。`bantime` 设置封禁的持续时间，我们将其设置为 `86400` 秒。通过这个配置，用户最多允许 `5` 次失败尝试，超过后他们的 IP
    地址将被封禁 24 小时。
- en: The existing definition from `jail.conf` already identifies the default port
    and the log file location. If you're running SSH on a nonstandard port, you can
    override the original definition's setting using `port`. The location of the SSH's
    log file can be overridden with `logfile`.
  id: totrans-205
  prefs: []
  type: TYPE_NORMAL
  zh: '`jail.conf` 中已有的定义已经确定了默认端口和日志文件的位置。如果你在非标准端口上运行 SSH，可以使用 `port` 来覆盖原始定义的设置。SSH
    的日志文件位置也可以通过 `logfile` 来覆盖。'
- en: '`fail2ban-client` is used to interact with the Fail2ban service. Its `status`
    command outputs information about the service''s current state, and if `status`
    is followed by a jail name then status information about the jail is returned
    instead. Perhaps of particular interest in the jail''s status is a list of IP
    addresses that have been banned:'
  id: totrans-206
  prefs: []
  type: TYPE_NORMAL
  zh: '`fail2ban-client` 用于与 Fail2ban 服务进行交互。其 `status` 命令输出服务当前状态的信息，如果 `status`
    后面跟着监狱名称，则返回该监狱的状态信息。监狱状态中可能特别值得注意的是被封禁的 IP 地址列表：'
- en: '[PRE52]'
  id: totrans-207
  prefs: []
  type: TYPE_PRE
  zh: '[PRE52]'
- en: '![How it works...](img/image_06_004.jpg)'
  id: totrans-208
  prefs: []
  type: TYPE_IMG
  zh: '![它是如何工作的...](img/image_06_004.jpg)'
- en: The jail's status output presents the list of banned addresses
  id: totrans-209
  prefs: []
  type: TYPE_NORMAL
  zh: 监狱的状态输出展示了被封禁地址的列表
- en: The client also has `get` and `set` commands to inspect and update various properties
    of the running service. For example, `get sshd bantime` returns the configured
    ban duration. `set sshd bantime` temporarily updates the duration until the service
    is restarted.
  id: totrans-210
  prefs: []
  type: TYPE_NORMAL
  zh: 客户端还提供 `get` 和 `set` 命令，用于检查和更新正在运行的服务的各种属性。例如，`get sshd bantime` 返回配置的封禁时长。`set
    sshd bantime` 临时更新封禁时长，直到服务重启。
- en: 'You can manually ban an IP address by setting the jail''s `banip` property:'
  id: totrans-211
  prefs: []
  type: TYPE_NORMAL
  zh: 你可以通过设置监狱的 `banip` 属性来手动封禁某个 IP 地址：
- en: '[PRE53]'
  id: totrans-212
  prefs: []
  type: TYPE_PRE
  zh: '[PRE53]'
- en: 'To manually unban an address, set `unbanip`:'
  id: totrans-213
  prefs: []
  type: TYPE_NORMAL
  zh: 若要手动解除封禁某个地址，请设置 `unbanip`：
- en: '[PRE54]'
  id: totrans-214
  prefs: []
  type: TYPE_PRE
  zh: '[PRE54]'
- en: 'Being able to manually unban addresses is important in case a legitimate address
    is banned for some reason. If there are addresses that should never be blocked,
    perhaps a test integration server executing failed logins on purpose, or perhaps
    an administrator''s computer, you can identify them using the `ignoreip` option
    in your `jail.local` configuration file and Fail2ban will avoid banning those
    addresses:'
  id: totrans-215
  prefs: []
  type: TYPE_NORMAL
  zh: 能够手动解除封禁地址非常重要，因为有时合法的地址可能会由于某些原因被误封。如果有些地址永远不应该被封禁，可能是某个测试集成服务器故意执行了失败登录，或者是管理员的计算机，你可以在
    `jail.local` 配置文件中使用 `ignoreip` 选项来标识这些地址，Fail2ban 将避免封禁这些地址：
- en: '[PRE55]'
  id: totrans-216
  prefs: []
  type: TYPE_PRE
  zh: '[PRE55]'
- en: See also
  id: totrans-217
  prefs:
  - PREF_H2
  type: TYPE_NORMAL
  zh: 另见
- en: 'Refer to the following resources for more information on Fail2ban:'
  id: totrans-218
  prefs: []
  type: TYPE_NORMAL
  zh: 更多关于 Fail2ban 的信息，请参考以下资源：
- en: The `fail2ban-client` manual page (`man 1 fail2ban-client`)
  id: totrans-219
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: '`fail2ban-client` 手册页面 (`man 1 fail2ban-client`)'
- en: Fail2ban Wiki ([http://www.fail2ban.org/wiki/index.php/Main_Page](http://www.fail2ban.org/wiki/index.php/Main_Page))
  id: totrans-220
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: Fail2ban Wiki ([http://www.fail2ban.org/wiki/index.php/Main_Page](http://www.fail2ban.org/wiki/index.php/Main_Page))
- en: Permanently ban repeat offenders with Fail2ban ([http://stuffphilwrites.com/2013/03/permanently-ban-repeat-offenders-fail2ban/](http://stuffphilwrites.com/2013/03/permanently-ban-repeat-offenders-fail2ban/))
  id: totrans-221
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: 使用Fail2ban永久禁止重复违规者（[http://stuffphilwrites.com/2013/03/permanently-ban-repeat-offenders-fail2ban/](http://stuffphilwrites.com/2013/03/permanently-ban-repeat-offenders-fail2ban/)）
- en: Monitoring the Fail2ban log ([http://www.the-art-of-web.com/system/fail2ban-log/](http://www.the-art-of-web.com/system/fail2ban-log/))
  id: totrans-222
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: 监控Fail2ban日志（[http://www.the-art-of-web.com/system/fail2ban-log/](http://www.the-art-of-web.com/system/fail2ban-log/)）
- en: Confining sessions to a chroot jail
  id: totrans-223
  prefs:
  - PREF_H1
  type: TYPE_NORMAL
  zh: 将会话限制在chroot监狱中
- en: This recipe teaches you how to set up a chroot jail. A chroot call changes the
    user's view of the filesystem hierarchy by setting a particular path as the root;
    for the user, the path appears as `/` and they are unable to traverse beyond it.
    This creates a sandbox or jail, confining the user to a small branch of the real
    hierarchy. Chroot jails are commonly used for security purposes, for example,
    user containment and honeypots and also for application testing and in recovery
    procedures.
  id: totrans-224
  prefs: []
  type: TYPE_NORMAL
  zh: 本食谱教你如何设置一个chroot监狱。chroot调用通过将特定路径设置为根目录，改变用户对文件系统层次结构的视图；对于用户来说，这个路径看起来就像是`/`，并且无法越过这个路径。这就创建了一个沙盒或监狱，将用户限制在真实层次结构的一个小分支内。chroot监狱通常用于安全目的，例如用户隔离、蜜罐以及应用程序测试和恢复程序。
- en: Getting ready
  id: totrans-225
  prefs:
  - PREF_H2
  type: TYPE_NORMAL
  zh: 准备工作
- en: This recipe requires a CentOS system running the OpenSSH server. Administrative
    privileges are also required, either by logging in with the `root` account or
    through the use of `sudo`.
  id: totrans-226
  prefs: []
  type: TYPE_NORMAL
  zh: 本食谱要求运行OpenSSH服务器的CentOS系统。还需要管理员权限，可以通过`root`账户登录或使用`sudo`。
- en: How to do it...
  id: totrans-227
  prefs:
  - PREF_H2
  type: TYPE_NORMAL
  zh: 如何操作...
- en: 'Follow these steps to configure a chroot jail and confine users to it:'
  id: totrans-228
  prefs: []
  type: TYPE_NORMAL
  zh: 按照以下步骤配置chroot监狱并将用户限制在其中：
- en: 'Download the `cpchroot` script needed to copy commands and their dependencies
    into the chroot environment:'
  id: totrans-229
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
  zh: 下载`cpchroot`脚本，必要时将命令及其依赖项复制到chroot环境中：
- en: '[PRE56]'
  id: totrans-230
  prefs:
  - PREF_IND
  type: TYPE_PRE
  zh: '[PRE56]'
- en: 'Make the script executable using `chmod`:'
  id: totrans-231
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
  zh: 使用`chmod`使脚本可执行：
- en: '[PRE57]'
  id: totrans-232
  prefs:
  - PREF_IND
  type: TYPE_PRE
  zh: '[PRE57]'
- en: 'Create the `/jail` directory and its subdirectories to mimic a root filesystem:'
  id: totrans-233
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
  zh: 创建`/jail`目录及其子目录，以模拟根文件系统：
- en: '[PRE58]'
  id: totrans-234
  prefs:
  - PREF_IND
  type: TYPE_PRE
  zh: '[PRE58]'
- en: 'Execute the `chroot` script to copy the desired programs and commands:'
  id: totrans-235
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
  zh: 执行`chroot`脚本以复制所需的程序和命令：
- en: '[PRE59]'
  id: totrans-236
  prefs:
  - PREF_IND
  type: TYPE_PRE
  zh: '[PRE59]'
- en: 'Copy the `terminfo` database:'
  id: totrans-237
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
  zh: 复制`terminfo`数据库：
- en: '[PRE60]'
  id: totrans-238
  prefs:
  - PREF_IND
  type: TYPE_PRE
  zh: '[PRE60]'
- en: 'Create the special device files under `/jail/dev` using `mknod`:'
  id: totrans-239
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
  zh: 使用`mknod`在`/jail/dev`下创建特殊设备文件：
- en: '[PRE61]'
  id: totrans-240
  prefs:
  - PREF_IND
  type: TYPE_PRE
  zh: '[PRE61]'
- en: 'Create a group for chroot''d users:'
  id: totrans-241
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
  zh: 为chroot用户创建一个组：
- en: '[PRE62]'
  id: totrans-242
  prefs:
  - PREF_IND
  type: TYPE_PRE
  zh: '[PRE62]'
- en: 'Open the `/etc/ssh/sshd_config` file with your text editor and add the following
    to the end of the file:'
  id: totrans-243
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
  zh: 使用文本编辑器打开`/etc/ssh/sshd_config`文件，并将以下内容添加到文件的末尾：
- en: '[PRE63]'
  id: totrans-244
  prefs:
  - PREF_IND
  type: TYPE_PRE
  zh: '[PRE63]'
- en: Save your changes and close the configuration file.
  id: totrans-245
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
  zh: 保存更改并关闭配置文件。
- en: 'Restart the SSH server for the changes to take effect:'
  id: totrans-246
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
  zh: 重新启动SSH服务器以使更改生效：
- en: '[PRE64]'
  id: totrans-247
  prefs:
  - PREF_IND
  type: TYPE_PRE
  zh: '[PRE64]'
- en: 'To create a new chroot''d user, create the user with `useradd` and assign them
    to the `sandbox` group:'
  id: totrans-248
  prefs: []
  type: TYPE_NORMAL
  zh: 要创建一个新的chroot用户，使用`useradd`命令创建用户，并将其分配到`sandbox`组：
- en: '[PRE65]'
  id: totrans-249
  prefs: []
  type: TYPE_PRE
  zh: '[PRE65]'
- en: 'Then, move their `home` directory to reside under the chroot `jail`:'
  id: totrans-250
  prefs: []
  type: TYPE_NORMAL
  zh: 然后，将他们的`home`目录移动到chroot`jail`下：
- en: '[PRE66]'
  id: totrans-251
  prefs: []
  type: TYPE_PRE
  zh: '[PRE66]'
- en: 'To chroot an existing user, assign them to the `sandbox` group and move their
    `home` directory to the `jail`:'
  id: totrans-252
  prefs: []
  type: TYPE_NORMAL
  zh: 要将现有用户设置为chroot环境，将其分配到`sandbox`组，并将其`home`目录移至`jail`：
- en: '[PRE67]'
  id: totrans-253
  prefs: []
  type: TYPE_PRE
  zh: '[PRE67]'
- en: How it works...
  id: totrans-254
  prefs:
  - PREF_H2
  type: TYPE_NORMAL
  zh: 工作原理...
- en: 'Identifying and copying dependencies is tedious and error-prone if done manually.
    So, I''ve written a helper script to automate the process of finding and cloning
    programs with their dependencies into the jail. Our first steps were to download
    the script using `curl` and then make it executable using `chmod`:'
  id: totrans-255
  prefs: []
  type: TYPE_NORMAL
  zh: 手动识别和复制依赖项是繁琐且容易出错的。因此，我编写了一个辅助脚本来自动化寻找和克隆程序及其依赖项到监狱中的过程。我们的第一步是使用`curl`下载脚本，然后使用`chmod`使其可执行：
- en: '[PRE68]'
  id: totrans-256
  prefs: []
  type: TYPE_PRE
  zh: '[PRE68]'
- en: The script is hosted on GitHub, but its direct URL was prohibitively long so
    I used a URL-shortening service to shorten the address. We need to provide `-L`
    for `curl` to follow any redirects (the service responds with a redirect to GitHub)
    and `-o` sets the name of the download, in this case `cpchroot`, in your `home`
    directory.
  id: totrans-257
  prefs: []
  type: TYPE_NORMAL
  zh: 该脚本托管在GitHub上，但其直接网址过长，因此我使用了一个网址缩短服务来缩短地址。我们需要为`curl`提供`-L`，以便跟踪任何重定向（该服务会响应一个指向GitHub的重定向），`-o`设置下载文件的名称，此处为`cpchroot`，并保存到`home`目录下。
- en: Note
  id: totrans-258
  prefs:
  - PREF_H3
  type: TYPE_NORMAL
  zh: 注意
- en: If you're having problems because of the URL-shortening service, you can find
    the direct link by visiting [https://gist.github.com/tboronczyk/00d77b1baafd13daab3b](https://gist.github.com/tboronczyk/00d77b1baafd13daab3b),
    clicking on the **Raw** button, and then copying the URL that appears in your
    browser's address bar.
  id: totrans-259
  prefs: []
  type: TYPE_NORMAL
  zh: 如果您遇到由于网址缩短服务而出现的问题，可以通过访问[https://gist.github.com/tboronczyk/00d77b1baafd13daab3b](https://gist.github.com/tboronczyk/00d77b1baafd13daab3b)，点击**Raw**按钮，然后复制浏览器地址栏中出现的网址来找到直接链接。
- en: 'Next, we created the `/jail` directory containing a directory structure that
    mimics the root filesystem. When a user logs in and is chroot''d, they and everything
    they do will be contained to `/jail`. They will not be able to traverse outside
    that directory, so we need to replicate the directory layout the programs expect:'
  id: totrans-260
  prefs: []
  type: TYPE_NORMAL
  zh: 接下来，我们创建了`/jail`目录，并在其中创建了一个模仿根文件系统的目录结构。当用户登录并进入chroot环境时，他们及其所有操作都会局限在`/jail`目录内。他们将无法访问该目录之外的内容，因此我们需要复制程序所期望的目录布局：
- en: '[PRE69]'
  id: totrans-261
  prefs: []
  type: TYPE_PRE
  zh: '[PRE69]'
- en: 'We used `mkdir` with the `-p` option and took advantage of shell expansion
    to create most of the layout with a single command. CentOS sets up its top-level
    `/bin`, `/lib`, and `/lib64` directories as symbolic links to the corresponding
    directories under `/usr`, which we duplicated using `ln` within the `/jail` directory.
    The final layout looks like the following one presented:'
  id: totrans-262
  prefs: []
  type: TYPE_NORMAL
  zh: 我们使用了带有`-p`选项的`mkdir`，并利用Shell扩展通过一个命令创建了大部分布局。CentOS将其顶级的`/bin`、`/lib`和`/lib64`目录设置为指向`/usr`下相应目录的符号链接，我们通过在`/jail`目录内使用`ln`命令复制了这些链接。最终的布局如下所示：
- en: '![How it works...](img/image_06_005.jpg)'
  id: totrans-263
  prefs: []
  type: TYPE_IMG
  zh: '![它是如何工作的...](img/image_06_005.jpg)'
- en: The layout of the sandbox root mimics that of the host's root filesystem
  id: totrans-264
  prefs: []
  type: TYPE_NORMAL
  zh: 沙盒根目录的布局模仿了主机的根文件系统。
- en: 'Next, we used the script to copy the desired commands to the jail. The script
    does the hard work of finding each program''s binary and identifies all of the
    libraries it depends on, and then it copies everything into the appropriate location
    in the sandboxed filesystem:'
  id: totrans-265
  prefs: []
  type: TYPE_NORMAL
  zh: 接下来，我们使用脚本将所需的命令复制到`jail`中。该脚本负责查找每个程序的二进制文件，识别其依赖的所有库，然后将所有文件复制到沙盒文件系统的适当位置：
- en: '[PRE70]'
  id: totrans-266
  prefs: []
  type: TYPE_PRE
  zh: '[PRE70]'
- en: Its first argument is the directory acting as our chroot'd root, and then following
    that is a list of one or more programs we want to make available to the user.
    The recipe provides a dozen programs as an example, and you should feel free to
    add or omit some as you see fit. At a minimum, you need a shell (`bash`). I recommend
    that you include at least `ls` and `pwd` so that the user can navigate.
  id: totrans-267
  prefs: []
  type: TYPE_NORMAL
  zh: 它的第一个参数是作为我们chroot根目录的目录，后面跟着我们希望提供给用户的一个或多个程序列表。该配方提供了12个程序作为示例，您可以根据需要自由添加或删除。最低要求是必须有一个Shell（`bash`）。我建议您至少包含`ls`和`pwd`，这样用户就可以进行导航。
- en: 'Then, we copied the `terminfo` database to the `jail`:'
  id: totrans-268
  prefs: []
  type: TYPE_NORMAL
  zh: 然后，我们将`terminfo`数据库复制到`jail`中：
- en: '[PRE71]'
  id: totrans-269
  prefs: []
  type: TYPE_PRE
  zh: '[PRE71]'
- en: Some programs, such as `screen`, `less`, and `vi`, use the `terminfo` database
    to make sure their output displays correctly. The database is a collection of
    files that describe the capabilities of different terminal types, such as the
    number of lines per screen, how to clear the screen, what colors are supported,
    and so on. If this information isn't accessible, users will be warned that the
    `terminal is not fully functional` and the output may be garbled.
  id: totrans-270
  prefs: []
  type: TYPE_NORMAL
  zh: 一些程序，如`screen`、`less`和`vi`，使用`terminfo`数据库来确保其输出正确显示。该数据库是一个文件集合，描述了不同终端类型的功能，如每屏的行数、如何清除屏幕、支持哪些颜色等。如果这些信息无法访问，用户将被警告`终端功能不完全`，并且输出可能会出现乱码。
- en: 'To finish making the `jail`, we created the `/dev/null`, `/dev/zero`, and `/dev/random`
    devices with the `mknod` command:'
  id: totrans-271
  prefs: []
  type: TYPE_NORMAL
  zh: 为了完成创建`jail`，我们使用`mknod`命令创建了`/dev/null`、`/dev/zero`和`/dev/random`设备：
- en: '[PRE72]'
  id: totrans-272
  prefs: []
  type: TYPE_PRE
  zh: '[PRE72]'
- en: '`mknod` is used to create special files such as character files and block files.
    These files are special because they can generate data (as is the case with `null`
    and `zero`) or represent physical devices and receive data. Both `null` and `zero`
    are character files, as indicated by the letter `c`, since we read from them one
    character at a time. Block files, on the other hand, operate with several characters
    at a time. A physical storage disk is often represented as a block device.'
  id: totrans-273
  prefs: []
  type: TYPE_NORMAL
  zh: '`mknod`用于创建特殊文件，如字符文件和块文件。这些文件之所以特殊，是因为它们可以生成数据（如`null`和`zero`）或表示物理设备并接收数据。`null`和`zero`都是字符文件，正如字母`c`所表示的那样，因为我们一次从中读取一个字符。另一方面，块文件一次操作多个字符。物理存储磁盘通常表示为块设备。'
- en: We also need to provide a major and minor number when creating a character or
    block device. These values are predefined and understood by the kernel as to how
    the device file should behave. `1` and `3` are the major and minor numbers that
    define a null device. `1` and `5` define the file as a null byte source. You can
    see the full list of major and minor number assignments in the Linux Allocated
    Device document listed in this recipe's *See also* section.
  id: totrans-274
  prefs: []
  type: TYPE_NORMAL
  zh: 我们在创建字符设备或块设备时，还需要提供主次设备号。这些值是预定义的，内核理解这些值如何影响设备文件的行为。`1` 和 `3` 是定义空设备的主次设备号，`1`
    和 `5` 定义文件为空字节源。你可以在本配方的 *另请参见* 部分中找到 Linux 分配的设备文档，查看完整的主次设备号分配列表。
- en: 'After the chroot environment was set up, we turned our attention to configure
    the SSH server. First, we created the `sandbox` group, which can be assigned to
    any user we want contained:'
  id: totrans-275
  prefs: []
  type: TYPE_NORMAL
  zh: 设置 chroot 环境后，我们开始配置 SSH 服务器。首先，我们创建了一个 `sandbox` 组，任何我们想要隔离的用户都可以分配到该组：
- en: '[PRE73]'
  id: totrans-276
  prefs: []
  type: TYPE_PRE
  zh: '[PRE73]'
- en: 'Next, we added a `Match` block to the SSH server''s configuration file targeting
    the new group:'
  id: totrans-277
  prefs: []
  type: TYPE_NORMAL
  zh: 接下来，我们在 SSH 服务器的配置文件中添加了一个 `Match` 块，目标是新的组：
- en: '[PRE74]'
  id: totrans-278
  prefs: []
  type: TYPE_PRE
  zh: '[PRE74]'
- en: '`Match` starts a new conditional section in the configuration file that applies
    only when its condition is matched. In this case, we''re matching the user''s
    group to `sandbox`. When the user is a member of the group, the `ChrootDirectory`
    option is applied and it sets `/jail` as the user''s root directory. Now when
    a user connects, anything they do will be confined to the chroot jail, including
    actions that happen automatically such as launching an interactive shell (`bash`).'
  id: totrans-279
  prefs: []
  type: TYPE_NORMAL
  zh: '`Match` 在配置文件中开始一个新的条件块，仅在满足条件时应用。在本例中，我们将用户的组匹配为 `sandbox`。当用户属于该组时，`ChrootDirectory`
    选项会被应用，并将 `/jail` 设置为用户的根目录。现在，当用户连接时，他们所做的一切都会被限制在 chroot 监狱中，包括自动发生的操作，如启动交互式
    shell (`bash`)。'
- en: 'Bash tries to place the user in their `home` directory after signing in. However,
    if their `home` directory isn''t accessible, the user will see the error message
    `Could not chdir to home directory` and find themselves in the root directory.
    To avoid this, we moved their `home` directory into the `jail`:'
  id: totrans-280
  prefs: []
  type: TYPE_NORMAL
  zh: Bash 在用户登录后会尝试将其放入 `home` 目录。但是，如果他们的 `home` 目录无法访问，用户会看到错误信息 `Could not chdir
    to home directory`，并且会被定位到根目录。为了避免这种情况，我们将他们的 `home` 目录移入了 `jail`：
- en: '[PRE75]'
  id: totrans-281
  prefs: []
  type: TYPE_PRE
  zh: '[PRE75]'
- en: Note
  id: totrans-282
  prefs:
  - PREF_H3
  type: TYPE_NORMAL
  zh: 注意
- en: 'You might be tempted to specify the `home` directory when creating a new user,
    as follows:'
  id: totrans-283
  prefs: []
  type: TYPE_NORMAL
  zh: 你可能会想在创建新用户时指定 `home` 目录，如下所示：
- en: '`**useradd -m -D /jail/home/jbhuse -G sandbox jbhuse**`'
  id: totrans-284
  prefs: []
  type: TYPE_NORMAL
  zh: '`**useradd -m -D /jail/home/jbhuse -G sandbox jbhuse**`'
- en: Unfortunately, this doesn't work. The `home` directory is created in the desired
    location, the user is chroot'd, and the path is viewed in relation to `/jail`
    so that bash looks for `/jail/jail/home/jbhuse`. This is why the recipe demonstrates
    moving the `home` directory as a second step. The entry in `/etc/passwd` stays,
    `/home/jbhuse` is interpreted as `/jail/home/jbhuse`, and all is right with the
    world.
  id: totrans-285
  prefs: []
  type: TYPE_NORMAL
  zh: 不幸的是，这不起作用。`home` 目录在期望的位置创建，用户被 chroot，路径相对于 `/jail` 进行查看，这样 bash 就会寻找 `/jail/jail/home/jbhuse`。这就是为什么示例中演示了将
    `home` 目录移到第二步的原因。`/etc/passwd` 中的条目保持不变，`/home/jbhuse` 被解释为 `/jail/home/jbhuse`，一切正常。
- en: See also
  id: totrans-286
  prefs:
  - PREF_H2
  type: TYPE_NORMAL
  zh: 另请参见
- en: 'Refer to the following for more information on setting up chroot environments:'
  id: totrans-287
  prefs: []
  type: TYPE_NORMAL
  zh: 更多关于设置 chroot 环境的信息，请参阅以下内容：
- en: The `sshd_config` manual page (`man 5 sshd_config`)
  id: totrans-288
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: '`sshd_config` 手册页 (`man 5 sshd_config`)'
- en: How to Configure SFTP with Chroot ([http://www.unixmen.com/configure-sftp-chroot-rhel-centos-7](http://www.unixmen.com/configure-sftp-chroot-rhel-centos-7))
  id: totrans-289
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: 如何配置带有 Chroot 的 SFTP ([http://www.unixmen.com/configure-sftp-chroot-rhel-centos-7](http://www.unixmen.com/configure-sftp-chroot-rhel-centos-7))
- en: Safely identify dependencies for chrooting ([http://zaemis.blogspot.com/2016/02/safely-identify-dependencies-for-chroot.html](http://zaemis.blogspot.com/2016/02/safely-identify-dependencies-for-chroot.html))
  id: totrans-290
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: 安全地识别用于 chroot 的依赖项 ([http://zaemis.blogspot.com/2016/02/safely-identify-dependencies-for-chroot.html](http://zaemis.blogspot.com/2016/02/safely-identify-dependencies-for-chroot.html))
- en: Linux allocated devices ([https://www.kernel.org/doc/Documentation/devices.txt](https://www.kernel.org/doc/Documentation/devices.txt))
  id: totrans-291
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: Linux 分配的设备 ([https://www.kernel.org/doc/Documentation/devices.txt](https://www.kernel.org/doc/Documentation/devices.txt))
- en: Configuring TigerVNC
  id: totrans-292
  prefs:
  - PREF_H1
  type: TYPE_NORMAL
  zh: 配置 TigerVNC
- en: Virtual Network Computing (VNC) works by capturing the display's frame buffer
    and making it available across the network. This recipe shows you how to install
    TigerVNC and configure it to provide remote users access to their graphical desktop
    environment as if they were physically in front of the system.
  id: totrans-293
  prefs: []
  type: TYPE_NORMAL
  zh: 虚拟网络计算（VNC）通过捕获显示的帧缓冲区并通过网络提供访问。这个教程展示了如何安装TigerVNC并将其配置为提供远程用户访问图形桌面环境，就像他们物理上坐在系统前面一样。
- en: Getting ready
  id: totrans-294
  prefs:
  - PREF_H2
  type: TYPE_NORMAL
  zh: 准备工作
- en: This recipe requires two systems, a CentOS system to host the VNC server (remote
    system) and a local computer with a VNC client to connect to it. It assumes that
    the remote system is running the OpenSSH SSH server and a graphical desktop environment
    such as GNOME or KDE. Administrative privileges are required on the remote server,
    either by logging in with the `root` account or through the use of `sudo`. The
    local computer is expected to have a VNC client installed.
  id: totrans-295
  prefs: []
  type: TYPE_NORMAL
  zh: 本教程需要两台系统，一台CentOS系统用于托管VNC服务器（远程系统），另一台本地计算机通过VNC客户端连接到它。假设远程系统正在运行OpenSSH
    SSH服务器和图形桌面环境，如GNOME或KDE。需要在远程服务器上拥有管理员权限，可以通过登录`root`账户或使用`sudo`来获得。预计本地计算机已经安装了VNC客户端。
- en: How to do it...
  id: totrans-296
  prefs:
  - PREF_H2
  type: TYPE_NORMAL
  zh: 如何操作...
- en: 'Follow these steps to install and configure TigerVNC:'
  id: totrans-297
  prefs: []
  type: TYPE_NORMAL
  zh: 按照以下步骤安装和配置TigerVNC：
- en: 'On the remote system, install the TigerVNC server package:'
  id: totrans-298
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
  zh: 在远程系统上安装TigerVNC服务器软件包：
- en: '[PRE76]'
  id: totrans-299
  prefs:
  - PREF_IND
  type: TYPE_PRE
  zh: '[PRE76]'
- en: 'Copy the example unit file provided with the package to `/etc/systemd/system`,
    adjusting its name to include the username of the person using VNC:'
  id: totrans-300
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
  zh: 将随软件包提供的示例单元文件复制到`/etc/systemd/system`，并调整其名称，以包含使用VNC的用户的用户名：
- en: '[PRE77]'
  id: totrans-301
  prefs:
  - PREF_IND
  type: TYPE_PRE
  zh: '[PRE77]'
- en: 'Open the new unit file with your text editor:'
  id: totrans-302
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
  zh: 使用文本编辑器打开新的单元文件：
- en: '[PRE78]'
  id: totrans-303
  prefs:
  - PREF_IND
  type: TYPE_PRE
  zh: '[PRE78]'
- en: 'Replace the `<USER>` placeholder that appears in the `[Service]` section''s
    `ExecStart` and `PIDFile` entries:'
  id: totrans-304
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
  zh: 替换`[Service]`部分中`ExecStart`和`PIDFile`条目中出现的`<USER>`占位符：
- en: '[PRE79]'
  id: totrans-305
  prefs:
  - PREF_IND
  type: TYPE_PRE
  zh: '[PRE79]'
- en: Save your changes and close the file.
  id: totrans-306
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
  zh: 保存更改并关闭文件。
- en: Repeat steps 2 to 5 for each user who will use VNC to connect to their desktop.
  id: totrans-307
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
  zh: 对每个将使用VNC连接到桌面的用户，重复步骤2到5。
- en: 'Reload systemd''s configuration to make it aware of the new unit files:'
  id: totrans-308
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
  zh: 重新加载systemd的配置，使其意识到新的单元文件：
- en: '[PRE80]'
  id: totrans-309
  prefs:
  - PREF_IND
  type: TYPE_PRE
  zh: '[PRE80]'
- en: 'Open ports `5900` through `5903` in the system''s firewall to accept incoming
    VNC requests:'
  id: totrans-310
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
  zh: 在系统的防火墙中开放`5900`到`5903`端口，以接受来自VNC的请求：
- en: '[PRE81]'
  id: totrans-311
  prefs:
  - PREF_IND
  type: TYPE_PRE
  zh: '[PRE81]'
- en: 'The users using VNC should set the password they''ll use to authenticate with
    the VNC server using `vncpasswd`:'
  id: totrans-312
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
  zh: 使用VNC的用户应该使用`vncpasswd`设置他们将用于身份验证的密码：
- en: '[PRE82]'
  id: totrans-313
  prefs:
  - PREF_IND
  type: TYPE_PRE
  zh: '[PRE82]'
- en: 'When a user wants to connect, specify a display number after `@` in the unit''s
    name when starting TigerVNC:'
  id: totrans-314
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
  zh: 当用户想要连接时，在启动TigerVNC时在单元名称后指定一个显示号`@`：
- en: '[PRE83]'
  id: totrans-315
  prefs:
  - PREF_IND
  type: TYPE_PRE
  zh: '[PRE83]'
- en: 'Stop the server when it''s not in use:'
  id: totrans-316
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
  zh: 当服务器不使用时停止它：
- en: '[PRE84]'
  id: totrans-317
  prefs:
  - PREF_IND
  type: TYPE_PRE
  zh: '[PRE84]'
- en: How it works...
  id: totrans-318
  prefs:
  - PREF_H2
  type: TYPE_NORMAL
  zh: 它是如何工作的...
- en: Along with the VNC server, the `tigervnc-server` package installs a `systemd`
    unit file to start and stop the server. However, there's some configuration we
    need to attend to before using it because the server runs under the user's account
    to obtain their desktop.
  id: totrans-319
  prefs: []
  type: TYPE_NORMAL
  zh: 除了VNC服务器，`tigervnc-server`软件包还安装了一个`systemd`单元文件，用于启动和停止服务器。然而，在使用之前我们需要进行一些配置，因为服务器是在用户账户下运行，以获取他们的桌面。
- en: When TigerVNC starts, it connects to the X server and logs in to the user's
    desktop just as if the user was sitting in front of the system itself. This means
    each user needs their own instance of the server running and we need to configure
    it for each user. We made a copy of the original unit file found under `/usr/lib/systemd/system`,
    one for each user.
  id: totrans-320
  prefs: []
  type: TYPE_NORMAL
  zh: 当TigerVNC启动时，它会连接到X服务器并登录到用户的桌面，就像用户坐在系统前面一样。这意味着每个用户都需要自己的服务器实例运行，我们需要为每个用户进行配置。我们复制了位于`/usr/lib/systemd/system`下的原始单元文件，每个用户一个副本。
- en: '[PRE85]'
  id: totrans-321
  prefs: []
  type: TYPE_PRE
  zh: '[PRE85]'
- en: The name of the copied file contains the username so that we can keep everything
    organized. They're placed under `/etc/systemd/system` because `systemd` looks
    in `/etc/systemd` for units before searching `/usr/lib/systemd` (in fact, many
    entries in `/etc/systemd` are symbolic links to their original files under `/usr/lib/systemd`).
    So, placing the copies there lets us keep the original intact and safeguards us
    from loosing our configuration in the event of an upgrade where the original until
    file is replaced.
  id: totrans-322
  prefs: []
  type: TYPE_NORMAL
  zh: 复制文件的名称包含用户名，以便我们可以保持一切有序。它们被放置在`/etc/systemd/system`下，因为`systemd`会先在`/etc/systemd`中查找单元文件，然后才会搜索`/usr/lib/systemd`（实际上，`/etc/systemd`中的许多条目是指向`/usr/lib/systemd`下原始文件的符号链接）。因此，将副本放在这里可以让我们保持原始文件的完整，并且在升级时，如果原始单元文件被替换，这样可以保护我们不丢失配置。
- en: '![How it works...](img/image_06_006.jpg)'
  id: totrans-323
  prefs: []
  type: TYPE_IMG
  zh: '![它是如何工作的...](img/image_06_006.jpg)'
- en: This system has VNC access configured for several users
  id: totrans-324
  prefs: []
  type: TYPE_NORMAL
  zh: 该系统已为多个用户配置了VNC访问
- en: 'We replaced any occurrence of the `<USER>` placeholder under the `[SERVICE]`
    section in each configuration file with the appropriate username:'
  id: totrans-325
  prefs: []
  type: TYPE_NORMAL
  zh: 我们在每个配置文件的`[SERVICE]`部分中，将所有出现的`<USER>`占位符替换为相应的用户名：
- en: '[PRE86]'
  id: totrans-326
  prefs: []
  type: TYPE_PRE
  zh: '[PRE86]'
- en: The command specified in the `ExecStart` entry is invoked when we start the
    server using `systemctl start`; it uses `runuser` to run TigerVNC under the user's
    account. The `-l` (lowercase L) argument provides the username and `-c` specifies
    the command and its arguments that `runuser` will execute. The `PIDFile` entry
    specifies the directory in which the running process will keep track of its process
    ID.
  id: totrans-327
  prefs: []
  type: TYPE_NORMAL
  zh: 在`ExecStart`条目中指定的命令是在我们使用`systemctl start`启动服务器时调用的；它使用`runuser`在用户账户下运行TigerVNC。`-l`（小写L）参数提供用户名，`-c`指定`runuser`将执行的命令及其参数。`PIDFile`条目指定运行进程将跟踪其进程ID的目录。
- en: Note
  id: totrans-328
  prefs:
  - PREF_H3
  type: TYPE_NORMAL
  zh: 注意
- en: Dan Walsh, the author of `runuser`, wrote a blog entry entitled *runuser vs
    su* detailing the backstory behind the command. You can read it online at [http://danwalsh.livejournal.com/55588.html](http://danwalsh.livejournal.com/55588.html).
  id: totrans-329
  prefs: []
  type: TYPE_NORMAL
  zh: '`runuser`的作者Dan Walsh写了一篇名为*runuser vs su*的博客，详细讲述了该命令的背景故事。你可以在[http://danwalsh.livejournal.com/55588.html](http://danwalsh.livejournal.com/55588.html)在线阅读。'
- en: 'The `@` symbol appearing in the filename has special significance to systemd.
    Anything after it and before the file suffix is passed to the commands in the
    unit file replacing `%i`. This lets us pass limited information to the server,
    for example, the display number for TigerVNC to run on. When we start the server
    as shown in the recipe, `:1` is given after `@`. The value is parsed by systemd
    and TigerVNC is started on display 1\. If we use `:2`, the server will start on
    display 2\. We can start multiple instances of TigerVNC for different users or
    even for the same user as long as the display is different for each:'
  id: totrans-330
  prefs: []
  type: TYPE_NORMAL
  zh: '`@`符号出现在文件名中对systemd具有特殊意义。它后面的内容和文件后缀之间的部分会传递给单元文件中的命令，替换`%i`。这让我们能够向服务器传递有限的信息，例如TigerVNC运行的显示号。当我们按照示例中的方法启动服务器时，`@`后面会跟上`:1`。这个值会被systemd解析，TigerVNC会在显示器1上启动。如果我们使用`:2`，服务器将在显示器2上启动。我们可以为不同的用户或即使是同一个用户启动多个TigerVNC实例，只要每个显示器号不同即可：'
- en: '[PRE87]'
  id: totrans-331
  prefs: []
  type: TYPE_PRE
  zh: '[PRE87]'
- en: 'Traffic for the display''s corresponding port should be allowed by the firewall.
    Display 0 uses port `5900`, display 1 uses port `5901`, display 2 uses port `5902`,
    and so on. If you''re using FirewallD, the predefined `vnc-server` service opens
    ports `5900`-`5903`:'
  id: totrans-332
  prefs: []
  type: TYPE_NORMAL
  zh: 显示对应端口的流量应允许通过防火墙。显示0使用端口`5900`，显示1使用端口`5901`，显示2使用端口`5902`，依此类推。如果你使用的是FirewallD，预定义的`vnc-server`服务会打开端口`5900`-`5903`：
- en: '[PRE88]'
  id: totrans-333
  prefs: []
  type: TYPE_PRE
  zh: '[PRE88]'
- en: 'If you need additional ports or if you don''t need to open the entire range,
    you can open just what you need using `--add-port`:'
  id: totrans-334
  prefs: []
  type: TYPE_NORMAL
  zh: 如果你需要额外的端口，或者不需要打开整个范围，你可以使用`--add-port`只打开所需的端口：
- en: '[PRE89]'
  id: totrans-335
  prefs: []
  type: TYPE_PRE
  zh: '[PRE89]'
- en: The user needs to set a VNC password using `vncpasswd` before they can connect
    to the display. The password must be at least six characters long, although only
    the first eight characters are significant. Moreover, the password is stored in
    the user's `~/.vnc/` directory. In the light of these issues, it's recommended
    that the user doesn't use the same password as their account password. It's also
    wise to run the VNC server only when needed since anyone who knows the display
    number and password can connect to it.
  id: totrans-336
  prefs: []
  type: TYPE_NORMAL
  zh: 用户在连接到显示器之前需要使用`vncpasswd`设置VNC密码。密码必须至少为六个字符长，尽管只有前八个字符才是有效的。此外，密码存储在用户的`~/.vnc/`目录中。考虑到这些问题，建议用户不要使用与账户密码相同的密码。也建议用户仅在需要时运行VNC服务器，因为任何知道显示号和密码的人都可以连接。
- en: 'The user also needs a VNC client to connect from their local computer. CentOS
    users can install the `tigervnc` package to use TigerVNC''s client. Other popular
    clients are Vinagre for Ubuntu, RealVNC for TightVNC on Windows, and Chicken of
    the VNC for OS X:'
  id: totrans-337
  prefs: []
  type: TYPE_NORMAL
  zh: 用户还需要一个VNC客户端才能从本地计算机连接。CentOS用户可以安装`tigervnc`包来使用TigerVNC的客户端。其他流行的客户端包括Ubuntu的Vinagre，Windows上TightVNC的RealVNC，以及OS
    X上的Chicken of the VNC：
- en: '[PRE90]'
  id: totrans-338
  prefs: []
  type: TYPE_PRE
  zh: '[PRE90]'
- en: 'The IP address or hostname for the remote system and the display (port) that
    VNC is running are needed to establish the connection. They can be provided in
    different ways depending on the client, but the standard format accepted by most
    clients appends the display to the system''s address, for example, `192.168.56.100:1`.
    The user will then be prompted for their password, and if all goes well they''ll
    be connected to the remote display:'
  id: totrans-339
  prefs: []
  type: TYPE_NORMAL
- en: '![How it works...](img/image_06_007.jpg)'
  id: totrans-340
  prefs: []
  type: TYPE_IMG
- en: A user prepares to connect to a remote display using VNC
  id: totrans-341
  prefs: []
  type: TYPE_NORMAL
- en: See also
  id: totrans-342
  prefs:
  - PREF_H2
  type: TYPE_NORMAL
- en: 'Refer to the following resources for more information on running TigerVNC and
    how systemd uses `@` in filenames:'
  id: totrans-343
  prefs: []
  type: TYPE_NORMAL
- en: TigerVNC ([http://tigervnc.org/](http://tigervnc.org/))
  id: totrans-344
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
- en: 'RHEL 7 System Administrator''s Guide: TigerVNC ([https://access.redhat.com/documentation/en-US/Red_Hat_Enterprise_Linux/7/html/System_Administrators_Guide/ch-TigerVNC.html](https://access.redhat.com/documentation/en-US/Red_Hat_Enterprise_Linux/7/html/System_Administrators_Guide/ch-TigerVNC.html))'
  id: totrans-345
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
- en: 'ArchWiki: TigerVNC ([https://wiki.archlinux.org/index.php/TigerVNC](https://wiki.archlinux.org/index.php/TigerVNC))'
  id: totrans-346
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
- en: The `@` symbol and `systemctl` ([http://superuser.com/questions/393423/the-symbol-and-systemctl-and-vsftpd/393429#393429](http://superuser.com/questions/393423/the-symbol-and-systemctl-and-vsftpd/393429#393429))
  id: totrans-347
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
- en: Understanding Systemd Units and Unit Files ([https://www.digitalocean.com/community/tutorials/understanding-systemd-units-and-unit-files](https://www.digitalocean.com/community/tutorials/understanding-systemd-units-and-unit-files))
  id: totrans-348
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
- en: Tunneling VNC connections through SSH
  id: totrans-349
  prefs:
  - PREF_H1
  type: TYPE_NORMAL
- en: The previous recipe showed you how to give remote access to the user's desktop
    through VNC. However, there are clearly some security concerns if the service
    is running on an untrusted network. Only the display number and password are required
    to connect, and the password can be relatively easy for a malicious user to crack
    given that only the first eight characters are significant. Moreover, the traffic
    is unencrypted and it may be snooped. To help mitigate these risks, this recipe
    teaches you how to route the VNC connection through an encrypted SSH tunnel.
  id: totrans-350
  prefs: []
  type: TYPE_NORMAL
- en: Getting ready
  id: totrans-351
  prefs:
  - PREF_H2
  type: TYPE_NORMAL
- en: This recipe requires two systems, a CentOS system hosting the VNC server (remote
    system) and a local computer with a VNC client to connect to it. It assumes that
    the remote system is running the OpenSSH SSH server and TigerVNC server and is
    configured with the IP address `192.168.56.100`. It also assumes that you have
    administrative privileges. The VNC server should be configured as described in
    the previous recipe. The local computer should have the OpenSSH SSH client (`ssh`)
    and a VNC client installed.
  id: totrans-352
  prefs: []
  type: TYPE_NORMAL
- en: How to do it...
  id: totrans-353
  prefs:
  - PREF_H2
  type: TYPE_NORMAL
- en: 'Follow these steps to route VNC connections through an encrypted SSH tunnel:'
  id: totrans-354
  prefs: []
  type: TYPE_NORMAL
- en: 'On the remote server, open a `vncserver@.service` configuration file using
    your text editor:'
  id: totrans-355
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
- en: '[PRE91]'
  id: totrans-356
  prefs:
  - PREF_IND
  type: TYPE_PRE
  zh: '[PRE91]'
- en: 'Locate the `ExecStart` entry and add the `-localhost` argument to the `vncserver`
    command invoked by `runuser`:'
  id: totrans-357
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
- en: '[PRE92]'
  id: totrans-358
  prefs:
  - PREF_IND
  type: TYPE_PRE
  zh: '[PRE92]'
- en: Save your change and close the file.
  id: totrans-359
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
- en: Repeat steps 1 to 3 as necessary for the other users' configuration files.
  id: totrans-360
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
- en: 'Reload systemd''s configuration to make it aware of the updates:'
  id: totrans-361
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
- en: '[PRE93]'
  id: totrans-362
  prefs:
  - PREF_IND
  type: TYPE_PRE
  zh: '[PRE93]'
- en: 'Start the VNC server:'
  id: totrans-363
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
- en: '[PRE94]'
  id: totrans-364
  prefs:
  - PREF_IND
  type: TYPE_PRE
  zh: '[PRE94]'
- en: 'On your local system, establish an SSH session to the server with `-L` to define
    the tunnel:'
  id: totrans-365
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
- en: '[PRE95]'
  id: totrans-366
  prefs:
  - PREF_IND
  type: TYPE_PRE
  zh: '[PRE95]'
- en: Connect to the tunnel's local endpoint (`localhost:1`) using a VNC client.
  id: totrans-367
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
- en: How it works...
  id: totrans-368
  prefs:
  - PREF_H2
  type: TYPE_NORMAL
- en: This recipe showed you how to secure VNC by tunneling its traffic through SSH.
    We configured the TigerVNC server to only accept connections from its localhost
    and then set up a tunnel on the local client side to route traffic through an
    SSH connection. This helps mitigate some of the aforementioned security risks
    because proper authentication is needed to establish the tunnel and encrypt the
    VNC traffic.
  id: totrans-369
  prefs: []
  type: TYPE_NORMAL
- en: 'First, you edited the `ExecStart` command in the unit files used to start instances
    of the VNC server. The `-localhost` argument to `vncserver` instructs the server
    to communicate only with the local system; any incoming connections originating
    from the network will be refused:'
  id: totrans-370
  prefs: []
  type: TYPE_NORMAL
- en: '[PRE96]'
  id: totrans-371
  prefs: []
  type: TYPE_PRE
  zh: '[PRE96]'
- en: 'On the client side, the user now needs to establish an SSH tunnel using `ssh`
    before they can connect to the remote display:'
  id: totrans-372
  prefs: []
  type: TYPE_NORMAL
- en: '[PRE97]'
  id: totrans-373
  prefs: []
  type: TYPE_PRE
  zh: '[PRE97]'
- en: The `-L` argument defines the tunnel as `local-port:target-host:target-port`.
    The target host and port represent the final destination in relation to the server
    `ssh` is connected to. For example, we know that the recipe is running the user's
    desktop on display 1 which uses port `5901`. We also know that TigerVNC server
    is running on `192.168.56.100` but configured to listen only to its localhost.
    This means, we need to connect to `localhost:5901` from `192.168.56.100`. Thus,
    `localhost:5901` is the target in relation to that system.
  id: totrans-374
  prefs: []
  type: TYPE_NORMAL
- en: Once the user has an established tunnel, they can minimize the session's terminal.
    (Don't close it!) `ssh` is connected to the remote system while also listening
    on the local port (also `5901`). On the remote server, `ssh` has established a
    second connection to the target host and port. The VNC client will connect to
    the local port by using the address `localhost:1` where the traffic is then routed
    through the SSH tunnel to the remote server and then forwarded to the final destination.
  id: totrans-375
  prefs: []
  type: TYPE_NORMAL
- en: The remote system acts as a gateway as traffic travels through it from the client's
    tunnel to the final destination. Keep in mind, unless a tunnel to the target has
    also been created on the remote server, the second leg of the data's journey is
    not encrypted. This isn't a concern for this recipe because the remote and target
    hosts are the same. If your final destination is anything other than localhost,
    ensure that the network is trusted or create a second tunnel.
  id: totrans-376
  prefs: []
  type: TYPE_NORMAL
- en: Note
  id: totrans-377
  prefs:
  - PREF_H3
  type: TYPE_NORMAL
- en: 'Routing traffic with SSH in this fashion can be done to secure other services
    as well, for example, NFS, FTP, HTTP, POP3, and SMTP. The overall process is the
    same: configure the server to listen locally and then establish the tunnel on
    the client.'
  id: totrans-378
  prefs: []
  type: TYPE_NORMAL
- en: See also
  id: totrans-379
  prefs:
  - PREF_H2
  type: TYPE_NORMAL
- en: 'Refer to the following resources to learn more about SSH tunneling:'
  id: totrans-380
  prefs: []
  type: TYPE_NORMAL
  zh: 参考以下资源了解更多关于 SSH 隧道的信息：
- en: The `ssh` manual page (`man 1 ssh`)
  id: totrans-381
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: '`ssh` 手册页（`man 1 ssh`）'
- en: Securing network traffic with SSH ([https://security.berkeley.edu/resources/best-practices-how-articles/securing-network-traffic-ssh-tunnels](https://security.berkeley.edu/resources/best-practices-how-articles/securing-network-traffic-ssh-tunnels))
  id: totrans-382
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: 使用 SSH 加密网络流量（[https://security.berkeley.edu/resources/best-practices-how-articles/securing-network-traffic-ssh-tunnels](https://security.berkeley.edu/resources/best-practices-how-articles/securing-network-traffic-ssh-tunnels)）
- en: SSH tunneling made easy ([http://www.revsys.com/writings/quicktips/ssh-tunnel.html](http://www.revsys.com/writings/quicktips/ssh-tunnel.html))
  id: totrans-383
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: 简化的 SSH 隧道使用教程（[http://www.revsys.com/writings/quicktips/ssh-tunnel.html](http://www.revsys.com/writings/quicktips/ssh-tunnel.html)）
