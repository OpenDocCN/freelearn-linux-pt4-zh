<html><head></head><body><div class="chapter" title="Chapter&#xA0;11.&#xA0;Network Security with firewalld" id="aid-2LQIK1"><div class="titlepage"><div><div><h1 class="title"><a id="ch11"/>Chapter 11. Network Security with firewalld</h1></div></div></div><p>The default user interface for <code class="literal">netfilter</code>, the kernel-based firewall, on RHEL7 is <code class="literal">firewalld</code>. Administrators now have a choice to use <code class="literal">firewalld</code> or <code class="literal">iptables</code> to manage firewalls. Underlying either process, we can still implement the kernel-based <code class="literal">netfilter</code> firewall. The frontend command to this new interface is <code class="literal">firewall-cmd</code>. The main benefit this offers is the ability to refresh the <code class="literal">netfilter</code> setting when the firewall is running. This is not possible with the <code class="literal">iptables</code> interface; additionally, we are able to use zone management. This enables us to have different firewall configurations, which depends on the network we are connected to.</p><p>In this chapter, we will be cover the following topics:</p><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem">The firewall status</li><li class="listitem">Routing</li><li class="listitem">The zone management</li><li class="listitem">The source management</li><li class="listitem">Firewall rules using services</li><li class="listitem">Firewall rules using ports</li><li class="listitem">Masquerading and the network address translation</li><li class="listitem">Using rich rules</li><li class="listitem">Implementing direct rules</li><li class="listitem">Reverting to iptables</li></ul></div><div class="section" title="The firewall status"><div class="titlepage"><div><div><h1 class="title"><a id="ch11lvl1sec84"/>The firewall status</h1></div></div></div><p>The firewall service can <a id="id419" class="indexterm"/>provide protection for your RHEL system and services from other hosts on the local network or Internet. Although firewalling is often maintained on the border routers to your network, additional protection can be provided by host-based firewalls, such as the <code class="literal">netfilter</code> firewall on the Linux kernel. The <code class="literal">netfilter</code> firewall on RHEL 7 can be implemented via the <code class="literal">iptables</code> or <code class="literal">firewalld</code> service, with the latter being the default.</p><p>The status of the <code class="literal">firewalld</code> service can be interrogated in a normal manner using the <code class="literal">systemctl</code> command. This will provide a verbose output if the service is running. This will include the <a id="id420" class="indexterm"/>
<span class="strong"><strong>PID</strong></span> (<span class="strong"><strong>process ID</strong></span>) of <code class="literal">firewalld</code> along with recent log messages. The <a id="id421" class="indexterm"/>following is a command extract along with a screenshot of the output from RHEL7.1:</p><div class="informalexample"><pre class="programlisting">
<span class="strong"><strong># systemctl status firewalld</strong></span>
</pre></div><div class="mediaobject"><img src="../Images/image00316.jpeg" alt="The firewall status"/></div><p style="clear:both; height: 1em;"> </p><p>If you just need a quick check with a less verbose output, make use of the <code class="literal">firewall-cmd</code> command. This is the main administrative tool used to manage <code class="literal">firewalld</code>. The <code class="literal">--state</code> option will provide all that you need, as shown in the following screenshot:</p><div class="mediaobject"><img src="../Images/image00317.jpeg" alt="The firewall status"/></div><p style="clear:both; height: 1em;"> </p><p>If <code class="literal">firewalld</code> was not active, the output would show as <code class="literal">not running</code>.</p></div></div>
<div class="section" title="Routing" id="aid-2MP361"><div class="titlepage"><div><div><h1 class="title"><a id="ch11lvl1sec85"/>Routing</h1></div></div></div><p>Although not strictly necessary <a id="id422" class="indexterm"/>for a firewall, you may need to implement routing on your RHEL7 system. Often, this will be associated with multi-homed systems with more than one network interface card; however, this is not a requirement of network routing, which allows packets to be forwarded to the correct destination network. Network <a id="id423" class="indexterm"/>routing is enabled in <code class="literal">procfs</code> in the <code class="literal">/proc/sys/net/ipv4/ip_forward</code> file. If this file contains a value of <code class="literal">0</code>, then routing is disabled; if it has a value of <code class="literal">1</code>, routing is enabled. This can be set using the <code class="literal">echo</code> command as follows:</p><div class="informalexample"><pre class="programlisting">
<span class="strong"><strong># echo 1 &gt; /proc/sys/net/ipv4/ip_forward</strong></span>
</pre></div><p>However, this is then turned on until the next reboot when the routing will revert to the configured setting. To make this setting permanent traditionally, the <code class="literal">/etc/sysctl.conf</code> file has been used. It's now recommended to add you own configurations to <code class="literal">/etc/sysctl.d/</code>. Here is an example of this:</p><div class="informalexample"><pre class="programlisting">
<span class="strong"><strong># echo "net.ipv4.ip_forward  =  1" &gt; /etc/sysctl.d/ipforward.conf</strong></span>
</pre></div><p>This will create a file and set its directive. To make this setting effective prior to the next reboot, we can make use of the <code class="literal">sysctl</code> command, as shown in the following command:</p><div class="informalexample"><pre class="programlisting">
<span class="strong"><strong># sysctl -p /etc/sysctl.d/ipforward.conf</strong></span>
</pre></div><p>This can also be seen in the <a id="id424" class="indexterm"/>following screenshot. Here, you can see that we read from the running configuration in <code class="literal">procfs</code> before implementing a change. It also shows the change to the running <code class="literal">procfs</code>:</p><div class="mediaobject"><img src="../Images/image00318.jpeg" alt="Routing"/></div><p style="clear:both; height: 1em;"> </p></div>
<div class="section" title="Zone management" id="aid-2NNJO1"><div class="titlepage"><div><div><h1 class="title"><a id="ch11lvl1sec86"/>Zone management</h1></div></div></div><p>A new feature you will find in <code class="literal">firewalld</code> that is more aimed at mobile systems—such as laptops—is the inclusion of zones. However, these zones can be equally used on a multihomed system, which <a id="id425" class="indexterm"/>associates different NICs with appropriate zones. Using zones in either mobile or multihomed systems, firewall rules can be assigned to zones and these rules will be associated with NICs included in that zone. If an interface is not assigned explicitly to a zone, then it will become a part of the default zone. To interrogate the default zone on your system, we can use the <code class="literal">firewall-cmd</code> command, as shown in the following command line:</p><div class="informalexample"><pre class="programlisting">
<span class="strong"><strong># firewall-cmd --get-default-zone</strong></span>
</pre></div><p>Should you need to list all the configured zones on your system, the following command can be used:</p><div class="informalexample"><pre class="programlisting">
<span class="strong"><strong># firewall-cmd --get-zones</strong></span>
</pre></div><p>The following screenshot demonstrates this command and the default zones on RHEL 7.1:</p><div class="mediaobject"><img src="../Images/image00319.jpeg" alt="Zone management"/></div><p style="clear:both; height: 1em;"> </p><p>Perhaps more usefully, we <a id="id426" class="indexterm"/>can display zones with interfaces assigned to them; if no assignments have been made, then all the interfaces will be in the public zone. The <code class="literal">--get-active-zones</code> option will help us with this, as shown in the following command:</p><div class="informalexample"><pre class="programlisting">
<span class="strong"><strong># firewall-cmd --get-active-zones</strong></span>
</pre></div><p>Should we require a more verbose output, we can list all the zone names, associated rules, and interfaces. The following command demonstrates how this can be achieved:</p><div class="informalexample"><pre class="programlisting">
<span class="strong"><strong># firewall-cmd --list-all-zones</strong></span>
</pre></div><p>If you need to utilize zones, you can choose the default zone and assign interfaces to specific zones as well. Firstly, assign a new default zone as follows:</p><div class="informalexample"><pre class="programlisting">
<span class="strong"><strong># firewall-cmd --set-default-zone=work</strong></span>
</pre></div><p>Here, we redirect the default zone to the work zone. In this way, all NICs that have not been explicitly assigned will participate in the work zone. The preceding command should report back with <code class="literal">success</code>. Take a look at the following screenshot to see how this works:</p><div class="mediaobject"><img src="../Images/image00320.jpeg" alt="Zone management"/></div><p style="clear:both; height: 1em;"> </p><p>We can also explicitly assign a zone to an interface as follows:</p><div class="informalexample"><pre class="programlisting">
<span class="strong"><strong># firewall-cmd --zone=public --change-interface=eno16777736</strong></span>
</pre></div><p>The change made through this command will be temporary until the next reboot; to make it permanent, we will add the <code class="literal">--permanent</code> option:</p><div class="informalexample"><pre class="programlisting">
<span class="strong"><strong># firewall-cmd --zone=public --change-interface=eno16777736 --permanent</strong></span>
</pre></div><p>Making a setting permanent will persist the configuration within the zone file located in the <code class="literal">/etc/firewalld/zones/</code> directory. In our case, the file is <code class="literal">/etc/firewalld/zones/public.xml</code>. After having implemented the permanent change as detailed here, we can list the contents of the XML file with the <code class="literal">cat</code> command. This is shown in the following screenshot:</p><div class="mediaobject"><img src="../Images/image00321.jpeg" alt="Zone management"/></div><p style="clear:both; height: 1em;"> </p><p>We can either interrogate an individual NIC to view the zone it's associated with or list all interfaces within a zone; the <a id="id427" class="indexterm"/>following commands illustrate this:</p><div class="informalexample"><pre class="programlisting">
<span class="strong"><strong># firewall-cmd --get-zone-of-interface=eno16777736</strong></span>
<span class="strong"><strong># firewall-cmd --zone=public --list-all</strong></span>
</pre></div><div class="note" title="Note"><h3 class="title"><a id="tip32"/>Tip</h3><p>You can use tab completion to assist with options and arguments with <code class="literal">firewall-cmd</code>.</p></div><p>If the supplied zones are not ample or perhaps the names do not work for your naming schemes, it's possible to create your own zones and add interfaces and rules. After adding your zone, you can reload the configuration to allow it to be used immediately as follows:</p><div class="informalexample"><pre class="programlisting">
<span class="strong"><strong># firewall-cmd --permanent --new-zone=packt</strong></span>
<span class="strong"><strong># firewall-cmd --reload</strong></span>
</pre></div><p>The <code class="literal">--reload</code> option can reload the configuration that allows current connections to continue uninterrupted; whereas the <code class="literal">--complete-reload</code> option will stop all connections during the process.</p></div>
<div class="section" title="Source management" id="aid-2OM4A1"><div class="titlepage"><div><div><h1 class="title"><a id="ch11lvl1sec87"/>Source management</h1></div></div></div><p>The problem that you <a id="id428" class="indexterm"/>may encounter using interfaces assigned to your zones is that it does not differentiate between network addresses. Often, this is not an issue as only one network address is bound to the NIC; however, if you have more than one address bound to the NIC, you may want to implement the <code class="literal">firewalld</code> source. Like interfaces, sources can be assigned to zones. In the following command, we will add a network range to the <code class="literal">trusted</code> zone and another range, perhaps on the same NIC to the <code class="literal">public</code> zone:</p><div class="informalexample"><pre class="programlisting">
<span class="strong"><strong># firewall-cmd --permanent --zone=trusted --add-source=192.168.1.0/24</strong></span>
<span class="strong"><strong># firewall-cmd --permanent --zone=public --add-source=172.17.0.0/16</strong></span>
</pre></div><p>Similar to interfaces, binding a source to a zone will activate that zone and will be listed with the <code class="literal">--get-active-zones</code> option.</p></div>
<div class="section" title="Firewall rules using services" id="aid-2PKKS1"><div class="titlepage"><div><div><h1 class="title"><a id="ch11lvl1sec88"/>Firewall rules using services</h1></div></div></div><p>When we think of <a id="id429" class="indexterm"/>firewalls, we think of allowing or denial of access to ports. The use of service XML files can ease the port management with one service, perhaps listing multiple ports. The other point to take note of is that <code class="literal">firewalld</code> daemon's default policy is to deny access, so any access needed has to be explicitly granted to a port associated with a service. To list services that have been allowed on the default zone, we can simply use the <code class="literal">--list-services</code> option, as shown in the following example:</p><div class="informalexample"><pre class="programlisting">
<span class="strong"><strong># firewall-cmd --list-services</strong></span>
</pre></div><p>Similarly, we can gain access to services allowed in a specific zone by including the <code class="literal">--zone=</code> option. This can be seen in the following example:</p><div class="informalexample"><pre class="programlisting">
<span class="strong"><strong># firewall-cmd --zone=home --list-services</strong></span>
</pre></div><p>The output from this command is shown in the following screenshot. It lists services associated with the <code class="literal">home</code> zone:</p><div class="mediaobject"><img src="../Images/image00322.jpeg" alt="Firewall rules using services"/></div><p style="clear:both; height: 1em;"> </p><p>As you start enabling services, you can easily allow a predefined service through a zone. Predefined services are listed as XML files in the <code class="literal">/usr/lib/firewalld/services</code> directory. They are listed in the following screenshot for you to examine:</p><div class="mediaobject"><img src="../Images/image00323.jpeg" alt="Firewall rules using services"/></div><p style="clear:both; height: 1em;"> </p><div class="note" title="Note"><h3 class="title"><a id="tip33"/>Tip</h3><p>RHEL 7 is representative of a more mature Linux distribution; as such, it recognizes that the need to separate the <code class="literal">/usr</code> directory from the <code class="literal">root</code> filesystem is depreciated and the <code class="literal">/lib</code>, <code class="literal">/bin</code>, and <code class="literal">/sbin</code> directories are soft-linked to their respective directories after <code class="literal">/usr/</code>. Hence, <code class="literal">/lib</code> is now the same as <code class="literal">/usr/lib</code>. This is illustrated in the following screenshot:</p><div class="mediaobject"><img src="../Images/image00324.jpeg" alt="Firewall rules using services"/></div><p style="clear:both; height: 1em;"> </p></div><p>While defining your own services, you may create XML files within the <code class="literal">/etc/firewalld/services</code> directory. The squid proxy server does not have its own service file, and if we choose to allow this as a service rather than just opening the required port the file would look <a id="id430" class="indexterm"/>similar to the <code class="literal">/etc/firewalld/services/squid.xml</code>, as follows:</p><div class="informalexample"><pre class="programlisting">&lt;?xml version="1.0" encoding="utf-8"?&gt;
&lt;service&gt;
  &lt;short&gt;Squid&lt;/short&gt;
  &lt;description&gt;Squid Web Proxy&lt;/description&gt;
  &lt;port protocol="tcp" port="3128"/&gt;
&lt;/service&gt;</pre></div><p>Assuming that we are using SELinux in the <code class="literal">Enforcing</code> mode, we will need to set the correct context for the new file using the following commands:</p><div class="informalexample"><pre class="programlisting">
<span class="strong"><strong># cd /etc/firewalld/services</strong></span>
<span class="strong"><strong># restorecon squid.xml</strong></span>
</pre></div><p>The permissions on this file should be <code class="literal">640</code> and it will be set using the following command:</p><div class="informalexample"><pre class="programlisting">
<span class="strong"><strong># chmod 640 /etc/firewalld/services/squid.xml</strong></span>
</pre></div><p>The output of <code class="literal">ls -lZ</code> should read similar to the following screenshot, where we display the correct SELinux context and permission:</p><div class="mediaobject"><img src="../Images/image00325.jpeg" alt="Firewall rules using services"/></div><p style="clear:both; height: 1em;"> </p><p>Having defined the new <a id="id431" class="indexterm"/>service now or using pre-existing services, we can add them to a zone. If we are using the default zone, this is achieved simply with the following commands. Note that we reload the configuration at the start to identify the new squid service as follows:</p><div class="informalexample"><pre class="programlisting">
<span class="strong"><strong># firewall-cmd --reload</strong></span>
<span class="strong"><strong># firewall-cmd --permanent --add-service=squid</strong></span>
<span class="strong"><strong># firewall-cmd --reload</strong></span>
</pre></div><p>Similarly, to update a specified zone other than the default zone, we will use the following commands:</p><div class="informalexample"><pre class="programlisting">
<span class="strong"><strong># firewall-cmd --permanent --add-service=squid --zone=work</strong></span>
<span class="strong"><strong># firewall-cmd --reload</strong></span>
</pre></div><p>Should we later need to remove this service from the work zone, we can use the following command:</p><div class="informalexample"><pre class="programlisting">
<span class="strong"><strong># firewall-cmd --permanent --remove-service=squid --zone=work</strong></span>
<span class="strong"><strong># firewall-cmd --reload</strong></span>
</pre></div></div>
<div class="section" title="Firewall rules using ports" id="aid-2QJ5E1"><div class="titlepage"><div><div><h1 class="title"><a id="ch11lvl1sec89"/>Firewall rules using ports</h1></div></div></div><p>In the previous <a id="id432" class="indexterm"/>example, where the squid service only required a single port, we could easily add a port rule to allow access to a service. Although the process is <a id="id433" class="indexterm"/>simple, in some organizations, the preference will still be to create the service file that documents the need of the port in the description field.</p><p>If we need to add a port, we have similar options in <code class="literal">--add-port</code> and <code class="literal">--remove-port</code>. The following command shows how to add the squid TCP port <code class="literal">3128</code> to the work zone without the need to <a id="id434" class="indexterm"/>define the service file:</p><div class="informalexample"><pre class="programlisting">
<span class="strong"><strong># firewall-cmd --permanent --add-port=3128/tcp --zone=work</strong></span>
<span class="strong"><strong># firewall-cmd --reload</strong></span>
</pre></div></div>
<div class="section" title="Masquerading and Network Address Translation" id="aid-2RHM01"><div class="titlepage"><div><div><h1 class="title"><a id="ch11lvl1sec90"/>Masquerading and Network Address Translation</h1></div></div></div><p>If your <code class="literal">firewalld</code> server is your network router running RHEL 7, you may wish to provide access to the Internet to your internal hosts on a private network. If this is the case, we can enable masquerading. This is also known as <span class="strong"><strong>NAT</strong></span> (<span class="strong"><strong>Network Address Translation</strong></span>), where <a id="id435" class="indexterm"/>the server's public IP address is used by internal clients. To establish this, we can make use of the built-in internal and external zones and configure masquerading on the external zone. The internal NIC should be assigned to the internal zone and the external NIC should be assigned to the external zone.</p><p>To establish masquerading on the external zone, we can use the following command:</p><div class="informalexample"><pre class="programlisting">
<span class="strong"><strong># firewall-cmd --zone=external --add-masquerade</strong></span>
</pre></div><p>Masquerading is removed <a id="id436" class="indexterm"/>using the <code class="literal">--remove-masquerade</code> option. We may also query the status of masquerading in a zone using the <code class="literal">--query-masquerade</code> option. In the following screenshot, we can see masquerading being enabled and then queried with the resulting <code class="literal">yes</code> output:</p><div class="mediaobject"><img src="../Images/image00326.jpeg" alt="Masquerading and Network Address Translation"/></div><p style="clear:both; height: 1em;"> </p></div>
<div class="section" title="Using rich rules" id="aid-2SG6I1"><div class="titlepage"><div><div><h1 class="title"><a id="ch11lvl1sec91"/>Using rich rules</h1></div></div></div><p>The <code class="literal">firewalld</code> rich language <a id="id437" class="indexterm"/>allows an administrator to easily configure more complex firewall rules without having knowledge of the <code class="literal">iptables</code> syntax. This can include logging and examination of the source address.</p><p>To add a rule to allow NTP connection on the default zone, but logging the connection at no more than 1 per minute, use the following command:</p><div class="informalexample"><pre class="programlisting">
<span class="strong"><strong># firewall-cmd --permanent \</strong></span>
<span class="strong"><strong>--add-rich-rule='rule service name="ntp" audit limit value="1/m" accept'</strong></span>
<span class="strong"><strong># firewall-cmd --reload</strong></span>
</pre></div><p>Similarly, we can add a rule that only allows access to the squid service from one subnet only:</p><div class="informalexample"><pre class="programlisting">
<span class="strong"><strong># firewall-cmd --permanent \</strong></span>
<span class="strong"><strong>--add-rich-rule='rule family="ipv4" \ </strong></span>
<span class="strong"><strong>source address="192.166.0.0/24" service name="squid" accept'</strong></span>
<span class="strong"><strong># firewall-cmd --reload</strong></span>
</pre></div><p>From the following screenshot, we can see the rich rule being added:</p><div class="mediaobject"><img src="../Images/image00327.jpeg" alt="Using rich rules"/></div><p style="clear:both; height: 1em;"> </p><div class="note" title="Note"><h3 class="title"><a id="note02"/>Note</h3><p>The Fedora project <a id="id438" class="indexterm"/>maintains the documentation for rich rules in <a id="id439" class="indexterm"/>
<code class="literal">firewalld</code> and these can be accessed at <a class="ulink" href="https://fedoraproject.org/wiki/Features/FirewalldRichLanguage">https://fedoraproject.org/wiki/Features/FirewalldRichLanguage</a> should you need more detailed examples.</p></div></div>
<div class="section" title="Implementing direct rules" id="aid-2TEN41"><div class="titlepage"><div><div><h1 class="title"><a id="ch11lvl1sec92"/>Implementing direct rules</h1></div></div></div><p>If you have a prior experience with <code class="literal">iptables</code> and want to <a id="id440" class="indexterm"/>combine you knowledge of <code class="literal">iptables</code> with the features in <code class="literal">firewalld</code>, direct rules are here to help with this migration. Firstly, if we want to implement a rule on the INPUT chain, we can check the current settings with the following command:</p><div class="informalexample"><pre class="programlisting">
<span class="strong"><strong># firewall-cmd --direct --get-rules ipv4 filter INPUT</strong></span>
</pre></div><p>If you have not added any rules, the output will be empty. We will add a new rule and use a priority of <code class="literal">0</code>. This means that it will be listed at the top of the chain; however, this means little when no other rules are in place. We do need to verify that rules are added in the correct order to process if other rules are implemented:</p><div class="informalexample"><pre class="programlisting">
<span class="strong"><strong># firewall-cmd --permanent --direct --add-rule ipv4 filter \</strong></span>
<span class="strong"><strong>INPUT 0 -p tcp --dport 3128 -j ACCEPT</strong></span>
<span class="strong"><strong># firewall-cmd --reload</strong></span>
</pre></div><div class="section" title="Reverting to iptables"><div class="titlepage"><div><div><h2 class="title"><a id="ch11lvl2sec68"/>Reverting to iptables</h2></div></div></div><p>Additionally, there is <a id="id441" class="indexterm"/>nothing stopping you from using the <code class="literal">iptables</code> service if this is what you are most familiar with.</p><p>Firstly, we can install <code class="literal">iptables</code> with the following command:</p><div class="informalexample"><pre class="programlisting">
<span class="strong"><strong># yum install iptables-service</strong></span>
</pre></div><p>We can mask the <code class="literal">firewalld</code> service to more effectively disable the service, preventing it from being started without first unmasking this service:</p><div class="informalexample"><pre class="programlisting">
<span class="strong"><strong># systemctl mask firewalld</strong></span>
</pre></div><p>We can enable <code class="literal">iptables</code> with the following commands:</p><div class="informalexample"><pre class="programlisting">
<span class="strong"><strong># systemctl enable iptables</strong></span>
<span class="strong"><strong># systemctl enable ip6tables</strong></span>
<span class="strong"><strong># systemctl start iptables</strong></span>
<span class="strong"><strong># systemctl start ip6tables</strong></span>
</pre></div><p>Permanent rules are added as they always have been, via the <code class="literal">/etc/sysconfig</code> directory and the <code class="literal">iptables</code> and <code class="literal">ip6tables</code> files.</p></div></div>
<div class="section" title="Summary" id="aid-2UD7M1"><div class="titlepage"><div><div><h1 class="title"><a id="ch11lvl1sec93"/>Summary</h1></div></div></div><p>The <code class="literal">firewalld</code> project is maintained by Fedora and is the new administrative service and interface for the <code class="literal">netfilter</code> firewall on the Linux Kernel. As administrators, we can choose to use this default service or switch back to <code class="literal">iptables</code>; however, <code class="literal">firewalld</code> is able to provide us with the ability to reload configuration without dropping connections and mechanisms to migrate from <code class="literal">iptables</code>. We have seen how we can use zones to segregate network interfaces and sources if we need to share address ranges on a single NIC. Neither the NIC nor the source is bound to the zone. We can then add rules to a zone to control access to our resources. These rules are based on services or ports. If more complexity is required, we have the option of using rich or direct rules. Rich rules are written in the rich language from <code class="literal">firewalld</code>, whereas direct rules are written in the <code class="literal">iptables</code> syntax.</p></div></body></html>