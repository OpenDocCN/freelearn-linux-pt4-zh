<html><head></head><body>
        <section>

                            <header>
                    </header><h1 class="header-title" id="calibre_pb_0">Its Time for a Timer</h1>
                
            
            <article>
                
<p class="calibre1"><span><span>Having had a peek into daemons and SSH tunnels, dealing with <kbd class="calibre9">cronjob</kbd> could look like a humble task, but let's think for a while about our daily routine: how many times do we need to schedule a job to be executed in a specific time frame, maybe late at night or while we are on vacation? How many times do we need a certain task to be executed every day at a precise hour, every single day? Do we really want to stay up late at night or give up our vacations, or more importantly, can we be sure we will always be available to run a task every day at the same hour? Simply, we can't be. So, a method to schedule jobs and have them executed when needed, everytime it is needed, can be humble, but it is what makes a system easier to manage and saves us a lot of headaches.</span></span></p>
<p class="calibre1"><span><span>We have many tools and forked projects available, but we will focus on a couple of them. The most famous old tools around are <strong class="calibre2">at</strong> and <strong class="calibre2">cron</strong>. They do quite the same thing, but with a different spin and definitely with a different goal.</span></span></p>


            </article>

            
        </section>
    

        <section>

                            <header>
                    </header><h1 class="header-title" id="calibre_pb_0">One shot at it</h1>
                
            
            <article>
                
<p class="calibre1"><span><span>Sometimes, we need to fire a job at a specific hour without any need to repeat the action, so just a one off. What we can use in this case is a simple utility called <kbd class="calibre9">at</kbd> with its companion batch. What does it do? It simply reads from the input or a file on what to execute and when, and it will use <kbd class="calibre9">/bin/sh</kbd> to invoke whatever we want. There is a little twist though: batch will do it but not at a specific time. It will be done when the system load drops below 1.5 or any level specified at the <kbd class="calibre9">atd</kbd> runtime.</span></span></p>
<p class="calibre1"><span><span>So, we introduced <kbd class="calibre9">atd</kbd>; what is this? This is the daemon that executes the one shot jobs defined and put in its queue by the <kbd class="calibre9">at</kbd> utility, and so, it is a daemon that usually runs under a dedicated daemon user:</span></span></p>
<pre class="codepackt">
<strong class="calibre2">root:# ps -fC atd<br class="title-page-name"/></strong><strong class="calibre2">UID PID PPID C STIME TTY TIME CMD<br class="title-page-name"/></strong><strong class="calibre2">daemon 722 1 0 Apr25 ? 00:00:00 /usr/sbin/atd -f</strong>
</pre>
<p class="calibre1"><span><span>So, this is a daemon that is fired up as a system service, but we have some other options; we can pass it to modify how it deals with the scheduled jobs. Let's see what we can make use of:</span></span></p>
<ul class="calibre12">
<li class="calibre13"><span><span><kbd class="calibre9">-l</kbd>: Defines the load factor over which the scheduled jobs will not be run. If no limit is imposed, it defaults to 1.5; but, in systems with x CPUs, a good limit value could be higher than x-1.</span></span></li>
<li class="calibre13"><span><span><kbd class="calibre9">-b</kbd>: This sets the minimum interval in seconds between two consecutive jobs being fired. This defaults to <kbd class="calibre9">60</kbd>.</span></span></li>
<li class="calibre13"><span><span><kbd class="calibre9">-d</kbd>: Having issues here? This will enable a debug feature that will divert the error messages from <kbd class="calibre9">syslog</kbd> to <kbd class="calibre9">stderr</kbd>, usually the terminal. This option goes along with the <kbd class="calibre9">-f</kbd> option.</span></span></li>
<li class="calibre13"><span><span><kbd class="calibre9">-f</kbd>: Good for debugging, this options forces <kbd class="calibre9">atd</kbd> to run in the foreground.</span></span></li>
<li class="calibre13"><span><span><kbd class="calibre9">-s</kbd>: Forces the processing of the <kbd class="calibre9">at</kbd> and <kbd class="calibre9">batch</kbd> queue to only a single run. This is used for backward compatibility with older versions of <kbd class="calibre9">at</kbd>; and it is run as we ran the old <kbd class="calibre9">atrun</kbd> command.</span></span></li>
</ul>
<p class="calibre1"><span><span>Few files are involved in the <kbd class="calibre9">atd</kbd> running process:</span></span></p>
<ul class="calibre12">
<li class="calibre13"><span><span><kbd class="calibre9">/var/spool/cron/atjobs</kbd>: This is the directory where the jobs created by <kbd class="calibre9">at</kbd> are stored and <kbd class="calibre9">atd</kbd> will read the queue from. It must be owned by the same owner of the process (in our case, daemon) and have strict access rights of 700.</span></span></li>
<li class="calibre13"><span><span><kbd class="calibre9">/var/spool/cron/atspool</kbd>: This is the directory that temporarily holds the output of the jobs. It is owned by a daemon user with an access mode of 700.</span></span></li>
<li class="calibre13"><span><span><kbd class="calibre9">/etc/at.allow</kbd>, <kbd class="calibre9">/etc/at.deny</kbd>: In this file, we can set which account can submit jobs to <kbd class="calibre9">atd</kbd> and which are forbidden.</span></span></li>
</ul>
<p class="calibre1"><span><span>There is one limit in using <kbd class="calibre9">atd</kbd>; if it's spool directory is mounted with NFS, then whichever option you use for mounting, it will simply not work.</span></span></p>
<p class="calibre1"><span><span>We saw a couple of interesting files:</span></span></p>
<pre class="codepackt">
<strong class="calibre2">/etc/at.allow<br class="title-page-name"/></strong><strong class="calibre2">/etc/at.deny</strong>
</pre>
<p class="calibre1"><span><span>This administrator who can submit jobs to the <kbd class="calibre9">atd</kbd> daemon can have a really simple syntax: it is a simple list of account names, one per line, with no whitespaces. There is a precedence order in which the files are parsed:</span></span><span><span><kbd class="calibre9">/etc/at.allow</kbd> is the first one to be read. If any account names are found in it, these will be the only accounts to be allowed to submit the jobs.</span></span></p>
<p class="calibre1"><span><span>If <kbd class="calibre9">/etc/at.allow</kbd> does not exist, then </span></span><span><span><kbd class="calibre9">/etc/at.deny</kbd> is parsed and every account name found in it will be forbidden to send jobs to <kbd class="calibre9">atd</kbd>. If the file exists but it is empty, it is interpreted as that every account can submit jobs to <kbd class="calibre9">atd</kbd>.</span></span></p>
<p class="calibre1"><span><span>If neither <kbd class="calibre9">/etc/at.allow</kbd> or <kbd class="calibre9">/etc/at.deny</kbd> exists, this means that only the superuser can submit jobs to <kbd class="calibre9">atd</kbd>.</span></span></p>
<p class="calibre1"><span><span>In the systems, we use a sandbox. We have </span></span><span><span><kbd class="calibre9">/etc/at.deny</kbd> </span></span><span><span>and its contents here:</span></span></p>
<pre class="codepackt">
<strong class="calibre2">root:# cat /etc/at.deny <br class="title-page-name"/></strong><strong class="calibre2">alias<br class="title-page-name"/></strong><strong class="calibre2">backup<br class="title-page-name"/></strong><strong class="calibre2">bin<br class="title-page-name"/></strong><strong class="calibre2">daemon<br class="title-page-name"/></strong><strong class="calibre2">ftp<br class="title-page-name"/></strong><strong class="calibre2">games<br class="title-page-name"/></strong><strong class="calibre2">gnats<br class="title-page-name"/></strong><strong class="calibre2">guest<br class="title-page-name"/></strong><strong class="calibre2">irc<br class="title-page-name"/></strong><strong class="calibre2">lp<br class="title-page-name"/></strong><strong class="calibre2">mail<br class="title-page-name"/></strong><strong class="calibre2">man<br class="title-page-name"/></strong><strong class="calibre2">nobody<br class="title-page-name"/></strong><strong class="calibre2">operator<br class="title-page-name"/></strong><strong class="calibre2">proxy<br class="title-page-name"/></strong><strong class="calibre2">qmaild<br class="title-page-name"/></strong><strong class="calibre2">qmaill<br class="title-page-name"/></strong><strong class="calibre2">qmailp<br class="title-page-name"/></strong><strong class="calibre2">qmailq<br class="title-page-name"/></strong><strong class="calibre2">qmailr<br class="title-page-name"/></strong><strong class="calibre2">qmails<br class="title-page-name"/></strong><strong class="calibre2">sync<br class="title-page-name"/></strong><strong class="calibre2">sys<br class="title-page-name"/></strong><strong class="calibre2">www-data</strong>
</pre>
<p class="calibre1"><span><span>So for the rules we just saw, </span></span><span><span>if  <kbd class="calibre9">/etc/at</kbd></span></span>. <kbd class="calibre9">allow</kbd> <span><span>is absent, all the accounts listed in <kbd class="calibre9">/etc/at.deny</kbd> are forbidden to submit jobs to <kbd class="calibre9">atd</kbd>. This makes sense as we can see that these are accounts related to services or a nobody user, and these are not supposed to have any need to submit a job.</span></span></p>
<p class="calibre1"><span><span>This is all we need to know about the service part of the <kbd class="calibre9">at</kbd> facility; let's see what we can rely on to schedule a job. On the client side, we have the following utilities that we can use to submit jobs to <kbd class="calibre9">atd</kbd>.</span></span></p>
<p class="calibre1"><span><span>The </span></span><span><span><kbd class="calibre9">at</kbd> and <kbd class="calibre9">batch read</kbd> commands from a standard input or a specified file, which are to be executed at a later time, using <kbd class="calibre9">/bin/sh</kbd>.</span></span></p>
<ul class="calibre12">
<li class="calibre13"><span><span><kbd class="calibre9">at</kbd>: This is the main utility we deal with, and its function is to submit jobs that are to be executed at a specific time. Time specification can be really smart and flexible.</span></span></li>
<li class="calibre13"><span><span><kbd class="calibre9">HH:MM</kbd>: This specifies the time of the current day to run a command called by <kbd class="calibre9">at</kbd>. If the time has already passed, the command is intended to be run on the next day at the same hour.</span></span></li>
<li class="calibre13"><span><span><kbd class="calibre9">midnight</kbd>: The job is meant to be run at midnight:</span></span></li>
</ul>
<pre class="calibre21">
<strong class="calibre2">root:# at midnight<br class="title-page-name"/>warning: commands will be executed using /bin/sh<br class="title-page-name"/>at&gt; ls<br class="title-page-name"/>at&gt; &lt;EOT&gt;<br class="title-page-name"/>job 6 at Fri Apr 28 00:00:00 2017</strong>
</pre>
<p class="calibre1"><span>To submit a job, simply press <em class="calibre20">Ctrl</em>+<em class="calibre20">D </em>on a newline:</span></p>
<ul class="calibre12">
<li class="calibre13"><span><span><kbd class="calibre9">noon</kbd>: This job is meant to be run at noon</span></span></li>
<li class="calibre13"><span><span><kbd class="calibre9">teatime</kbd>: This job will be run at 4 PM</span></span></li>
<li class="calibre13"><span><span><kbd class="calibre9">AM-PM</kbd>: We can add a trailing AM or PM to have the job be executed at a certain hour in the morning or in the afternoon:</span></span></li>
</ul>
<pre class="calibre21">
<strong class="calibre2">root:# echo "systemctl restart ssh" | at 04:43 AM<br class="title-page-name"/></strong><strong class="calibre2">warning: commands will be executed using /bin/sh<br class="title-page-name"/></strong><strong class="calibre2">job 7 at Thu Apr 27 04:43:00 2017<br class="title-page-name"/></strong><strong class="calibre2">root:# echo "systemctl restart ssh" | at 04:43 PM<br class="title-page-name"/></strong><strong class="calibre2">warning: commands will be executed using /bin/sh<br class="title-page-name"/></strong><strong class="calibre2">job 8 at Thu Apr 27 16:43:00 2017
</strong>
</pre>
<ul class="calibre12">
<li class="calibre13"><span><span><kbd class="calibre9">date month_name [year]</kbd>: We can also have a job running at a specific time on a precise day, month, and optionally, a year too; but, we have to keep in mind that whatever format we choose, the date must follow the time specification and not precede it:</span></span></li>
</ul>
<pre class="calibre21">
<strong class="calibre2">root:# echo "systemctl restart ssh" | at 11:45 Aug 28<br class="title-page-name"/></strong><strong class="calibre2">warning: commands will be executed using /bin/sh<br class="title-page-name"/></strong><strong class="calibre2">job 12 at Mon Aug 28 11:45:00 2017<br class="title-page-name"/></strong><strong class="calibre2">root:# echo "systemctl restart ssh" | at 11:45 Aug 28 2018<br class="title-page-name"/></strong><strong class="calibre2">warning: commands will be executed using /bin/sh<br class="title-page-name"/></strong><strong class="calibre2">job 13 at Tue Aug 28 11:45:00 2018</strong>
</pre>
<ul class="calibre12">
<li class="calibre13"><span><span><kbd class="calibre9">MMDD[CC]YY</kbd>: Date specification as month, day, optional century, and year without spaces:</span></span></li>
</ul>
<pre class="calibre21">
<strong class="calibre2">root:# echo "systemctl restart ssh" | at 11:45 070527<br class="title-page-name"/></strong><strong class="calibre2">warning: commands will be executed using /bin/sh<br class="title-page-name"/></strong><strong class="calibre2">job 14 at Mon Jul 5 11:45:00 2027</strong>
</pre>
<ul class="calibre12">
<li class="calibre13"><span><span><kbd class="calibre9">MM/DD/[CC]YY</kbd>: Date specification as month/day/optional century/year separated by a slash:</span></span></li>
</ul>
<pre class="calibre21">
<strong class="calibre2">root:# echo "systemctl restart ssh" | at 07:23 PM 08222017<br class="title-page-name"/></strong><strong class="calibre2">warning: commands will be executed using /bin/sh<br class="title-page-name"/></strong><strong class="calibre2">job 15 at Tue Aug 22 19:23:00 2017</strong>
</pre>
<ul class="calibre12">
<li class="calibre13"><span><span><kbd class="calibre9">DD.MM.[CC]YY</kbd>: Date specification as day.month.optional century.year separated by a dot:</span></span></li>
</ul>
<pre class="calibre21">
<strong class="calibre2">root:# echo "systemctl restart ssh" | at 18:05 15.09.29<br class="title-page-name"/></strong><strong class="calibre2">warning: commands will be executed using /bin/sh<br class="title-page-name"/></strong><strong class="calibre2">job 17 at Sat Sep 15 18:05:00 2029</strong>
</pre>
<ul class="calibre12">
<li class="calibre13"><span><span><kbd class="calibre9">[CC]YY-MM-DD</kbd>: Date specification as optional century year-month-day, separated by a dash:</span></span></li>
</ul>
<pre class="calibre21">
<strong class="calibre2">root:# echo "systemctl restart ssh" | at 18:15 17-09-15<br class="title-page-name"/></strong><strong class="calibre2">warning: commands will be executed using /bin/sh<br class="title-page-name"/></strong><strong class="calibre2">job 18 at Fri Sep 15 18:15:00 2017
</strong>
</pre>
<ul class="calibre12">
<li class="calibre13"><span><span><kbd class="calibre9">now + minutes | hours | days | weeks</kbd>: We can also set the time in minutes, hours, days, or weeks from the time/date on the system at the moment of creating the job:</span></span></li>
</ul>
<pre class="calibre21">
<strong class="calibre2">root:# date ; echo "systemctl restart ssh" | at now + 1 minutes <br class="title-page-name"/></strong><strong class="calibre2">Thu Apr 27 05:22:11 EDT 2017<br class="title-page-name"/></strong><strong class="calibre2">warning: commands will be executed using /bin/sh<br class="title-page-name"/></strong><strong class="calibre2">job 20 at Thu Apr 27 05:23:00 2017<br class="title-page-name"/></strong><strong class="calibre2">root:# date ; echo "systemctl restart ssh" | at now + 1 days<br class="title-page-name"/></strong><strong class="calibre2">Thu Apr 27 05:22:59 EDT 2017<br class="title-page-name"/></strong><strong class="calibre2">warning: commands will be executed using /bin/sh<br class="title-page-name"/></strong><strong class="calibre2">job 21 at Fri Apr 28 05:22:00 2017<br class="title-page-name"/></strong><strong class="calibre2">root:# date ; echo "systemctl restart ssh" | at now + 2 weeks<br class="title-page-name"/></strong><strong class="calibre2">Thu Apr 27 05:23:05 EDT 2017<br class="title-page-name"/></strong><strong class="calibre2">warning: commands will be executed using /bin/sh<br class="title-page-name"/></strong><strong class="calibre2">job 22 at Thu May 11 05:23:00 2017</strong>
</pre>
<ul class="calibre12">
<li class="calibre13"><span><span><kbd class="calibre9">today</kbd>: We can set a job to be run at a specific hour relative to today; if we do not define an hour, it will be simply executed immediately:</span></span></li>
</ul>
<pre class="calibre21">
<strong class="calibre2">root:# date ; echo "systemctl restart ssh" | at today<br class="title-page-name"/></strong><strong class="calibre2">Thu Apr 27 05:25:06 EDT 2017<br class="title-page-name"/></strong><strong class="calibre2">warning: commands will be executed using /bin/sh<br class="title-page-name"/></strong><strong class="calibre2">job 23 at Thu Apr 27 05:25:00 2017<br class="title-page-name"/></strong><strong class="calibre2">root:# date ; echo "systemctl restart ssh" | at 14:28 today<br class="title-page-name"/></strong><strong class="calibre2">Thu Apr 27 05:25:19 EDT 2017<br class="title-page-name"/></strong><strong class="calibre2">warning: commands will be executed using /bin/sh<br class="title-page-name"/></strong><strong class="calibre2">job 24 at Thu Apr 27 14:28:00 2017</strong>
</pre>
<ul class="calibre12">
<li class="calibre13"><span><span><kbd class="calibre9">tomorrow</kbd>:  We can set a job to be run at a specific hour the next day; if we do not define an hour, it will be simply executed at the same hour that the job has been created, but the next day:</span></span></li>
</ul>
<pre class="calibre21">
<strong class="calibre2">root:# date ; echo "systemctl restart ssh" | at tomorrow<br class="title-page-name"/></strong><strong class="calibre2">Thu Apr 27 05:27:34 EDT 2017<br class="title-page-name"/></strong><strong class="calibre2">warning: commands will be executed using /bin/sh<br class="title-page-name"/></strong><strong class="calibre2">job 25 at Fri Apr 28 05:27:00 2017<br class="title-page-name"/></strong><strong class="calibre2">root:# date ; echo "systemctl restart ssh" | at 14:28 tomorrow<br class="title-page-name"/></strong><strong class="calibre2">Thu Apr 27 05:27:41 EDT 2017<br class="title-page-name"/></strong><strong class="calibre2">warning: commands will be executed using /bin/sh<br class="title-page-name"/></strong><strong class="calibre2">job 26 at Fri Apr 28 14:28:00 2017</strong>
</pre>
<p class="calibre1"><span>The complete reference for time specification is available at <kbd class="calibre9">/usr/share/doc/at/timespec</kbd>.</span></p>
<p class="calibre1"><span><span>As we can see from the examples, the commands are read from <kbd class="calibre9">stdin</kbd> or from a file, if using the option </span></span><kbd class="calibre9">-f</kbd> filename:</p>
<pre class="calibre33">
<strong class="calibre2">root:# echo "systemctl restart ssh" &gt; /root/atjob1<br class="title-page-name"/></strong><strong class="calibre2">root:# at -f /root/atjob1 14:28 tomorrow<br class="title-page-name"/></strong><strong class="calibre2">warning: commands will be executed using /bin/sh<br class="title-page-name"/></strong><strong class="calibre2">job 27 at Fri Apr 28 14:28:00 2017 </strong>
</pre>
<p class="calibre1">Once the job is put in the queue, it retains some bits from the moment it was created:</p>
<p class="calibre1"><span><span>The environment variables except for <kbd class="calibre9">BASH_VERSINFO</kbd>, <kbd class="calibre9">DISPLAY</kbd>, <kbd class="calibre9">EUID</kbd>, <kbd class="calibre9">GROUPS</kbd>, <kbd class="calibre9">SHELLOPTS</kbd>, <kbd class="calibre9">TERM</kbd>, <kbd class="calibre9">UID</kbd>, <kbd class="calibre9">_</kbd> , and <kbd class="calibre9">umask</kbd> are retained from the time of invocation.</span></span></p>
<pre class="codepackt">
<strong class="calibre2">the working directory.<br class="title-page-name"/></strong><strong class="calibre2">the umask.</strong>
</pre>
<p class="calibre1"><span><span>What kind of environment libraries are exported to the job depends on the future developments; but, for instance, if we want to schedule a compile job for some program sources, we will have to set such libraries as <kbd class="calibre9">LD_LIBRARY_PATH</kbd> or <kbd class="calibre9">LD_PRELOAD</kbd> from inside the job itself since they are not inherited.</span></span></p>
<p class="calibre1"><span><span>Once the job is executed, its results will be displayed to <kbd class="calibre9">stdout</kbd> and <kbd class="calibre9">stderr</kbd> and mailed to the user using <kbd class="calibre9">/usr/sbin/sendmail</kbd>, but, if it is executed from <kbd class="calibre9">su</kbd> and <kbd class="calibre9">at</kbd> and retains its original user id, the results will be mailed to the user who originally logged in to <kbd class="calibre9">su</kbd>.</span></span></p>
<p class="calibre1"><span><span>Let's run a simple command that will generate some output, and then let's make sure an email is sent:</span></span></p>
<pre class="codepackt">
<strong class="calibre2">root:# echo "df" | at -m now</strong>
</pre>
<p class="calibre1"><span><span>And now, let's check the mailbox for the default alias user for root (check <kbd class="calibre9">/etc/aliases</kbd> to know whom the emails to root will be delivered to):</span></span></p>
<pre class="codepackt">
<strong class="calibre2">From root@debian Thu Apr 27 07:56:28 2017<br class="title-page-name"/></strong><strong class="calibre2">Return-path: &lt;root@debian&gt;<br class="title-page-name"/></strong><strong class="calibre2">Envelope-to: root@debian<br class="title-page-name"/></strong><strong class="calibre2">Delivery-date: Thu, 27 Apr 2017 07:56:28 -0400<br class="title-page-name"/></strong><strong class="calibre2">Received: from root by spoton with local (Exim 4.84_2)<br class="title-page-name"/></strong><strong class="calibre2"> (envelope-from &lt;root@debian&gt;)<br class="title-page-name"/></strong><strong class="calibre2"> id 1d3i28-0002vS-Ep<br class="title-page-name"/></strong><strong class="calibre2"> for root@debian; Thu, 27 Apr 2017 07:56:28 -0400<br class="title-page-name"/></strong><strong class="calibre2">Subject: Output from your job 37<br class="title-page-name"/></strong><strong class="calibre2">To: root@debian<br class="title-page-name"/></strong><strong class="calibre2">Message-Id: &lt;E1d3i28-0002vS-Ep@spoton&gt;<br class="title-page-name"/></strong><strong class="calibre2">From: root &lt;root@debian&gt;<br class="title-page-name"/></strong><strong class="calibre2">Date: Thu, 27 Apr 2017 07:56:28 -0400<br class="title-page-name"/></strong><strong class="calibre2">Filesystem 1K-blocks Used Available Use% Mounted on<br class="title-page-name"/></strong><strong class="calibre2">/dev/sda1 117913932 12476420 99424792 12% /<br class="title-page-name"/></strong><strong class="calibre2">udev 10240 0 10240 0% /dev<br class="title-page-name"/></strong><strong class="calibre2">tmpfs 779256 9192 770064 2% /run<br class="title-page-name"/></strong><strong class="calibre2">tmpfs 1948140 0 1948140 0% /dev/shm<br class="title-page-name"/></strong><strong class="calibre2">tmpfs 5120 4 5116 1% /run/lock<br class="title-page-name"/></strong><strong class="calibre2">tmpfs 1948140 0 1948140 0% /sys/fs/cgroup<br class="title-page-name"/></strong><strong class="calibre2">tmpfs 389628 0 389628 0% /run/user/0</strong>
</pre>
<p class="calibre1"><span><span>Now that we saw how to schedule a job, let's see what options it supports:</span></span></p>
<ul class="calibre12">
<li class="calibre13"><span><span><kbd class="calibre9">-q</kbd>: <span>Force <kbd class="calibre9">at</kbd> to use the specified queue to place a job. Queues are designated with a single character, from a to z and from A to Z; the default queue is named after <em class="calibre20">a for at</em> and <em class="calibre20">b for batch</em>. Queues with higher letters have an increased niceness while there is a special queue named <kbd class="calibre9">=</kbd> , which is reserved for jobs that are actually running. If a job is submitted to a queue with a capital letter, it is treated as if it was submitted to batch; so, once the time specification is hit, the job is executed only if the load average of the system is below the threshold.</span></span></span></li>
<li class="calibre13"><span><span><kbd class="calibre9">-V</kbd>: <span>Just</span> prints the version number of the utility to </span></span><kbd class="calibre9">stderr</kbd> <span><span>and <kbd class="calibre9">exit</kbd> successfully.</span></span></li>
<li class="calibre13"><span><span><kbd class="calibre9">-m</kbd>: Sends an email to the user once the job has been completed, even if the job itself has no output.</span></span></li>
<li class="calibre13"><span><span><kbd class="calibre9">-M</kbd>: Never sends any emails to the user.</span></span></li>
<li class="calibre13"><span><span><kbd class="calibre9">-f</kbd> filename: We already saw this option; it forces <kbd class="calibre9">at</kbd> to read from the specified file the commands to run within the job, rather than from the <kbd class="calibre9">stdin</kbd>.</span></span></li>
<li class="calibre13"><span><span><kbd class="calibre9">-t [[CC]YY]MMDDhhmm[.ss]</kbd>: Defines the time to run the job named <kbd class="calibre9">at/</kbd>.</span></span></li>
<li class="calibre13"><span><span><kbd class="calibre9">-l</kbd>: This is actually an alias for <kbd class="calibre9">atq</kbd>.</span></span></li>
<li class="calibre13"><span><span><kbd class="calibre9">-r</kbd>: This is actually an alias for <kbd class="calibre9">atrm</kbd>.</span></span></li>
<li class="calibre13"><span><span><kbd class="calibre9">-d</kbd>: This is actually an alias for <kbd class="calibre9">atrm</kbd>.</span></span></li>
<li class="calibre13"><span><span><kbd class="calibre9">-b</kbd>: This is actually an alias for <kbd class="calibre9">batch</kbd>.</span></span></li>
<li class="calibre13"><span><span><kbd class="calibre9">-v</kbd>: Shows when a job will be executed before reading it:</span></span></li>
</ul>
<pre class="calibre21">
<strong class="calibre2">root:# at -vf /root/atjob1 14:28 tomorrow<br class="title-page-name"/></strong><strong class="calibre2">Fri Apr 28 14:28:00 2017<br class="title-page-name"/></strong><strong class="calibre2">warning: commands will be executed using /bin/sh<br class="title-page-name"/></strong><strong class="calibre2">job 31 at Fri Apr 28 14:28:00 2017
</strong>
</pre>
<ul class="calibre12">
<li class="calibre13"><span><span><kbd class="calibre9">-c</kbd>: Shows on the <kbd class="calibre9">stdout</kbd> the specified job:</span></span></li>
</ul>
<pre class="calibre21">
<strong class="calibre2">root:# at -c 21<br class="title-page-name"/></strong><strong class="calibre2">#!/bin/sh<br class="title-page-name"/></strong><strong class="calibre2"># atrun uid=0 gid=0<br class="title-page-name"/></strong><strong class="calibre2"># mail root 0<br class="title-page-name"/></strong><strong class="calibre2">umask 22<br class="title-page-name"/></strong><strong class="calibre2">XDG_SESSION_ID=68; export XDG_SESSION_ID<br class="title-page-name"/></strong><strong class="calibre2">SSH_CLIENT=192.168.0.10\ 32994\ 9999; export SSH_CLIENT<br class="title-page-name"/></strong><strong class="calibre2">SSH_TTY=/dev/pts/0; export SSH_TTY<br class="title-page-name"/></strong><strong class="calibre2">USER=root; export USER<br class="title-page-name"/></strong><strong class="calibre2">MAIL=/var/mail/root; export MAIL<br class="title-page-name"/></strong><strong class="calibre2">PATH=/usr/local/sbin:/usr/local/bin:/usr/sbin:/usr/bin:/sbin:/bin; export PATH<br class="title-page-name"/></strong><strong class="calibre2">PWD=/root; export PWD<br class="title-page-name"/></strong><strong class="calibre2">LANG=en_US.UTF-8; export LANG<br class="title-page-name"/></strong><strong class="calibre2">SHLVL=1; export SHLVL<br class="title-page-name"/></strong><strong class="calibre2">HOME=/root; export HOME<br class="title-page-name"/></strong><strong class="calibre2">LOGNAME=root; export LOGNAME<br class="title-page-name"/></strong><strong class="calibre2">SSH_CONNECTION=192.168.0.10\ 32994\ 192.168.0.5\ 9999; export SSH_CONNECTION<br class="title-page-name"/></strong><strong class="calibre2">XDG_RUNTIME_DIR=/run/user/0; export XDG_RUNTIME_DIR<br class="title-page-name"/></strong><strong class="calibre2">cd /root || {<br class="title-page-name"/></strong><strong class="calibre2"> echo 'Execution directory inaccessible' &gt;&amp;2<br class="title-page-name"/></strong><strong class="calibre2"> exit 1<br class="title-page-name"/></strong><strong class="calibre2">}<br class="title-page-name"/></strong><strong class="calibre2">systemctl restart ssh</strong>
</pre>
<ul class="calibre12">
<li class="calibre13"><span><span><kbd class="calibre9">batch</kbd>: Runs a job when the average system load is under a specific threshold, the default threshold defaulting to 1.5. There is a major caveat though: in order to work correctly, batch depends on Linux on a proc filesystem mounted on <kbd class="calibre9">/proc</kbd>:</span></span></li>
</ul>
<pre class="calibre21">
<strong class="calibre2">root:# echo "systemctl restart ssh" | batch <br class="title-page-name"/></strong><strong class="calibre2">warning: commands will be executed using /bin/sh<br class="title-page-name"/></strong><strong class="calibre2">job 33 at Thu Apr 27 07:08:00 2017</strong>
</pre>
<div class="packt_infobox"><span class="calibre30">If a user is not logged on at the time <kbd class="calibre28">at</kbd> is invoked or when the file named <kbd class="calibre28">/var/run/utmp</kbd> is not readable, the email at the end of the job is sent to the account found as the value of the environment variable LOGNAME. If this variable is unavailable, the current user id will receive the email.</span></div>
<ul class="calibre12">
<li class="calibre13"><span><span><kbd class="calibre9">atq</kbd>: Shows a list of pending job, for the user. If run by superuser, it shows the list of all the scheduled jobs for all the accounts. The format of the list is here:</span></span></li>
</ul>
<pre class="calibre21">
<strong class="calibre2">job_id, date, hour, queue, account name</strong>
</pre>
<p class="calibre27"><span><span>Here, what the unprivileged users see is as follows:</span></span></p>
<pre class="calibre21">
<strong class="calibre2">root:# atq<br class="title-page-name"/></strong><strong class="calibre2">3 Thu Apr 27 08:00:00 2017 a zarrelli</strong>
</pre>
<p class="calibre27"><span><span>And this is what <kbd class="calibre9">root</kbd> sees at the same time on the same system:</span></span></p>
<pre class="calibre21">
<strong class="calibre2">root:# atq<br class="title-page-name"/></strong><strong class="calibre2">2 Wed Apr 26 14:00:00 2017 a root<br class="title-page-name"/></strong><strong class="calibre2">3 Thu Apr 27 08:00:00 2017 a zarrelli</strong>
</pre>
<p class="calibre1"><span><span>As we can see from the list, the queue with the name of <kbd class="calibre9">a</kbd>, and <kbd class="calibre9">indeed</kbd> queues, are designated with a single character, from a to z and from A to Z, the default queue being named after <em class="calibre20">a for at</em> and <em class="calibre20">b for batch</em>. Queues with higher letters have an increased niceness, while there is a special queue named <kbd class="calibre9">=</kbd> , which is reserved for jobs actually running. If <kbd class="calibre9">atq</kbd> is given a specific queue as an argument, it will show only the jobs in that queue. Let's see what <kbd class="calibre9">atq</kbd> can show without arguments:</span></span></p>
<pre class="codepackt">
<strong class="calibre2">root:# atq <br class="title-page-name"/></strong><strong class="calibre2">5 Wed Apr 26 05:46:00 2017 b root<br class="title-page-name"/></strong><strong class="calibre2">2 Wed Apr 26 14:00:00 2017 a root<br class="title-page-name"/></strong><strong class="calibre2">3 Thu Apr 27 08:00:00 2017 a zarrelli</strong>
</pre>
<p class="calibre1"><span><span>Now, let's restrict the list to just the batch queue:</span></span></p>
<pre class="codepackt">
<strong class="calibre2">root:# atq -q b<br class="title-page-name"/></strong><strong class="calibre2">5 Wed Apr 26 05:46:00 2017 b root</strong>
</pre>
<p class="calibre1"><span><span>So, <kbd class="calibre9">atq</kbd> supports the following options: </span></span></p>
<ul class="calibre12">
<li class="calibre13"><span><span><kbd class="calibre9">-q</kbd>: It </span></span><span><span>is the only option, along with <kbd class="calibre9">V</kbd>, accepted by <kbd class="calibre9">atq</kbd> and restricts its output to the specified queue content</span></span></li>
<li class="calibre13"><span><span><kbd class="calibre9">-V</kbd><span>: Just</span> prints the version number of the utility to the <kbd class="calibre9">stderr</kbd> and <kbd class="calibre9">exit</kbd> successfully</span></span></li>
<li class="calibre13"><span><span><kbd class="calibre9">atrm</kbd>: Deletes jobs identified by the job id:</span></span></li>
</ul>
<pre class="codepackt">
<strong class="calibre2">root:# atq<br class="title-page-name"/></strong><strong class="calibre2">9 Wed Jan 31 11:45:00 2018 a root<br class="title-page-name"/></strong><strong class="calibre2">3 Thu Apr 27 08:00:00 2017 a zarrelli<br class="title-page-name"/></strong><strong class="calibre2">13 Tue Aug 28 11:45:00 2018 a root<br class="title-page-name"/></strong><strong class="calibre2">29 Fri Apr 28 14:28:00 2017 a root</strong>
</pre>
<p class="calibre1"><span><span>So, we have four jobs whose ids are <kbd class="calibre9">3</kbd>, <kbd class="calibre9">9</kbd>, <kbd class="calibre9">13</kbd>, and <kbd class="calibre9">29</kbd>; let's remove them:</span></span></p>
<pre class="codepackt">
<strong class="calibre2">root:# atrm 3 9 13 29<br class="title-page-name"/></strong><strong class="calibre2">And check the queue again:<br class="title-page-name"/></strong><strong class="calibre2">root:# atq<br class="title-page-name"/></strong><strong class="calibre2">root:#</strong>
</pre>
<p class="calibre1"><span><span>N</span></span><span><span>othing left, we are done. On a final note, <kbd class="calibre9">atrm</kbd> accepts only one option, that is </span></span><span><span><kbd class="calibre9">-V</kbd>.</span></span></p>
<p class="calibre1"><span><span>What we saw so far is good for a one shot job, since <kbd class="calibre9">at</kbd> will not allow us to set some recurring task; so, if we want to execute some recurring jobs over time, we need to resort to a different kind of facility: the well-known cron service.</span></span></p>


            </article>

            
        </section>
    

        <section>

                            <header>
                    </header><h1 class="header-title" id="calibre_pb_0">The cron scheduler</h1>
                
            
            <article>
                
<p class="calibre1"><span><span>One of the most used facilities on a server is actually the scheduler, even if we do not realize how much we rely on it. Some of the services that run unattended on our systems are dealt with by a scheduler, which is in charge to run them at specific times over a span of days, weeks, and months. All those humble, repetitive tasks, which are so essential for the correct functioning of our environment, are hidden behind the curtains and do what we would not like to do, for instance, rotate all the system logs when it is needed. Would we do these jobs every day, at crazy hours, for all the services that require maintenance? No, we have better things to do. The cron scheduler does not have any better things to do; its purpose is to wake up every minute and check if something has to be done, and this makes it the best candidate to perform tedious repetitive tasks, at the same hour, maybe every day or every week. So, since one of the purposes of this book is to get the best we can from our system, we will have a look at this humble servant and learn how to configure and administer it so that it will side us in the necessary but not-so-funny task of administering our systems.</span></span></p>
<p class="calibre1"><span><span>As with <kbd class="calibre9">at</kbd>, crontab relies on three different components: a utility, called <kbd class="calibre9">cron</kbd><strong class="calibre2">;</strong> a set of configuration files, the most renowned being <kbd class="calibre9">/etc/crontab</kbd><span>; and a client/editor called</span> crontab. Does it look a bit confusing? Let's go in an orderly manner and have a look at the cron service first.</span></span></p>


            </article>

            
        </section>
    

        <section>

                            <header>
                    </header><h1 class="header-title" id="calibre_pb_0">cron</h1>
                
            
            <article>
                
<p class="calibre1"><span><span>This service runs every minute, looks for jobs stored in its crontab files, and checks if it must be run in the current minute. If anything is found, it is executed; otherwise, cron will be rerun the next minute and so forth. Once the job has been executed, the output of the commands issued is mailed to the owner of the crontab or to the user specified in the MAILTO environment variable in the crontab, if any. Notably, every minute, cron not only reads the crontab files but also checks the modification file of its spool directory or if <kbd class="calibre9">/etc/crontab</kbd> has changed and, if so, it will analyze the modification time of all the crontab files and reload them to get any changes made to the job's specification. So, we do not worry about restarting cron if we changed anything. It will manage the changes by itself, but cron is also able to cope with clock changes: if the time has been changed by less than 3 hours backward, the already run jobs will not be rerun. Then, if the time shifts forward to less than 3 hours, the <em class="calibre20">skipped</em> jobs will be run as soon as the clock will hit the new time. This affects only those jobs that have been set with a specific execution time. So, those tasks, using keywords such as <kbd class="calibre9">@hourly</kbd>, and those who have the wildcard <kbd class="calibre9">*</kbd> in the hour or minute specification for the runtime will not be affected. If the clock is shifted by more than 3 hours, all the jobs will be run following the new time set.</span></span></p>
<p class="calibre1"><span>Each distribution can implement a different kind of cron facility and have the configuration files in a slightly different location. If unsure, <kbd class="calibre9">man cron</kbd> and <kbd class="calibre9">man crontab</kbd> will show what is supported by the service and which locations the relevant files are kept at.</span></p>
<p class="calibre1"><span><span>Then, there is one more surprise: there is no cron. Well, we can chuckle because actually we call cron the daemon part of the service, but what is actually used to provide that service can change according to the distribution that we are using. There are different schedulers available for our purposes. Here are some of them:</span></span></p>
<ul class="calibre12">
<li class="calibre13"><span><span><kbd class="calibre9">vixie-cron</kbd>: This is the father of all the modern crons: the venerable cron from Paul Vixie, coded in 1987.</span></span></li>
<li class="calibre13"><span><span><kbd class="calibre9">bcron</kbd>: It is a cron replacement focused to provide a secure service.</span></span></li>
<li class="calibre13"><span><span><kbd class="calibre9">cronie</kbd>: It is a Fedora-based form of vixie-cron.</span></span></li>
<li class="calibre13"><span><span><kbd class="calibre9">dcron</kbd>: Dillon's cron is a stripped-down version of a cron; it is secure and simple.</span></span></li>
<li class="calibre13"><span><span><kbd class="calibre9">fcron</kbd>: It could be a nice replacement to the classic vixie cron and it is designed for a system that is not continuously running. So, it has some interesting features like the ability to schedule jobs at startup.</span></span></li>
</ul>
<p class="calibre1"><span><span>These are just some cron implementations, and we are confident that somewhere there are some more, a fork or something original that addresses some precise requirement. For the purpose of this book, we will refer to vixie-cron as installed on a Debian system.</span></span></p>
<p class="calibre1"><span><span>We do not have many options to interact with cron, but let's see what it supports:</span></span></p>
<ul class="calibre12">
<li class="calibre13"><span><span><kbd class="calibre9">-f</kbd>: It does not daemonize and will stay in the foreground. It is useful to debug what is going on with it.</span></span></li>
<li class="calibre13"><span><span><kbd class="calibre9">-l</kbd>: It enables the Linux Standard Base compliant script names for files inside <kbd class="calibre9">/etc/cron.d</kbd> (<a href="http://lanana.org/lsbreg/cron/index.html" class="calibre4">http://lanana.org/lsbreg/cron/index.html</a>). Only the files inside this directory will be affected; those under <kbd class="calibre9">/etc/cron.hourly</kbd>, <kbd class="calibre9">/etc/cron.daily</kbd>, <kbd class="calibre9">/etc/cron/weekly</kbd> , and <kbd class="calibre9">/etc/cron/monthly</kbd> will not be affected.</span></span></li>
<li class="calibre13"><span><span><kbd class="calibre9">-n</kbd>: Includes the Fully Qualified Domain Name in the subject of the email sent after a job has been run; otherwise, only the hostname will be used.</span></span></li>
<li class="calibre13"><span><span><kbd class="calibre9">-l</kbd>: Sets the log level. Errors are always logged; but, different levels unlock additional information that is recorded using the system log facility, usually syslog under the <em class="calibre20">cron</em> facility. The single level values can be summed and the resulting value will enable the collection of more than one kind of information:</span></span>
<ul class="calibre23">
<li class="calibre13"><span><span><kbd class="calibre9">1</kbd>: It logs the start of all cron jobs</span></span></li>
<li class="calibre13"><span><span><kbd class="calibre9">2</kbd>: It logs the end of all cron jobs</span></span></li>
<li class="calibre13"><span><span><kbd class="calibre9">4</kbd>: It logs the end of all failed jobs, so all jobs with exit status are different from <kbd class="calibre9">0</kbd></span></span></li>
<li class="calibre13"><span><span><kbd class="calibre9">8</kbd>: It logs the process identification number of all cron jobs</span></span></li>
<li class="calibre13"><span><span><kbd class="calibre9">15</kbd>: It will collect all the information (8+4+2+1) grabbed in the preceding levels</span></span></li>
<li class="calibre13"><span><span>The default log level is 1, but we can specify 0 if we want to disable logging at all</span></span></li>
</ul>
</li>
</ul>
<p class="calibre1"><span><span>There are a couple of things to keep in mind when using cron:</span></span></p>
<p class="calibre1"><span><span>The cron daemons set up a number of environment variables when dealing with jobs, such as follows:</span></span></p>
<ul class="calibre12">
<li class="calibre13"><span><span><kbd class="calibre9">SHELL</kbd>: Set to <kbd class="calibre9">/bin/sh</kbd></span></span></li>
<li class="calibre13"><span><span><kbd class="calibre9">LOGNAME</kbd>: Set from the content of <kbd class="calibre9">/etc/passwd</kbd> line related to the crontab owner</span></span></li>
<li class="calibre13"><span><span><kbd class="calibre9">HOME</kbd>: Set from the content of <kbd class="calibre9">/etc/passwd</kbd> line related to the crontab owner</span></span></li>
<li class="calibre13"><span><span><kbd class="calibre9">PATH</kbd>: Set to <kbd class="calibre9">/usr/bin:/bin</kbd></span></span></li>
</ul>
<p class="calibre1"><span><span>If any other environment variables must be set by the user, the easiest way to accomplish this is to set them into crontab definitions for vixie-cron; other implementations such as cronie do not allow this, so you can resort to prepend them on the crontab line entry before calling the script or program belonging to the job:</span></span></p>
<pre class="codepackt">
<strong class="calibre2"># m h dom mon dow command<br class="title-page-name"/></strong><strong class="calibre2">export HTTP_PROXY=http://192.168.0.1:8080; env &gt;&gt; /var/log/proxy</strong>
</pre>
<p class="calibre1"><span><span>If we take a look at the syslog file, we can see the crontab being installed:</span></span></p>
<pre class="codepackt">
<strong class="calibre2">Apr 28 16:57:35 moveaway crontab[27929]: (root) REPLACE (root)<br class="title-page-name"/></strong><strong class="calibre2">Apr 28 16:57:35 moveaway crontab[27929]: (root) END EDIT (root)<br class="title-page-name"/></strong><strong class="calibre2">Apr 28 16:58:01 moveaway cron[607]: (root) RELOAD (crontabs/root)<br class="title-page-name"/></strong><strong class="calibre2">Apr 28 16:58:01 moveaway CRON[27977]: (root) CMD (export HTTP_PROXY=http://192.168.0.1:8080; env &gt;&gt; /var/log/proxy)</strong>
</pre>
<p class="calibre1"><span><span>So, if we did not make any mistakes, we should see the <kbd class="calibre9">/var/log/proxy</kbd> file b</span></span><span><span>eing created and updated with the content of the environment the command named <kbd class="calibre9">env</kbd> has been invoked from:</span></span></p>
<pre class="codepackt">
<strong class="calibre2">root:# cat /var/log/proxy<br class="title-page-name"/></strong><strong class="calibre2">LANGUAGE=en_GB:en<br class="title-page-name"/></strong><strong class="calibre2">HOME=/root<br class="title-page-name"/></strong><strong class="calibre2">LOGNAME=root<br class="title-page-name"/></strong><strong class="calibre2">PATH=/usr/bin:/bin<br class="title-page-name"/></strong><strong class="calibre2">LANG=en_GB.UTF-8<br class="title-page-name"/></strong><strong class="calibre2">SHELL=/bin/sh<br class="title-page-name"/></strong><strong class="calibre2">PWD=/root<br class="title-page-name"/></strong><strong class="calibre2">HTTP_PROXY=http://192.168.0.1:8080<br class="title-page-name"/></strong><strong class="calibre2">LANGUAGE=en_GB:en<br class="title-page-name"/></strong><strong class="calibre2">HOME=/root<br class="title-page-name"/></strong><strong class="calibre2">LOGNAME=root<br class="title-page-name"/></strong><strong class="calibre2">PATH=/usr/bin:/bin<br class="title-page-name"/></strong><strong class="calibre2">LANG=en_GB.UTF-8<br class="title-page-name"/></strong><strong class="calibre2">SHELL=/bin/sh<br class="title-page-name"/></strong><strong class="calibre2">PWD=/root</strong>
</pre>
<p class="calibre1"><span><span>The <kbd class="calibre9">HTTP_PROXY</kbd> environment variable is set for the job, and we will see more and more of these lines growing into the file, so we will see in a while how to remove this crontab or the single job.</span></span></p>
<p class="calibre1"><span><span>One environment is read instead of being set and this is called <strong class="calibre2">MAILTO</strong>. If it is defined, the output of the job will be sent to the name specified; if it is empty, no mail will be sent. MAILTO can also be set to send emails to a list of users separated by commas. If not, MAILTO is set so the outcome of a job will be sent to the owner of the crontab.</span></span></p>
<p class="calibre1"><span><span>Some of the cron implementations support PAM, so if they happen to set up a new cron job for a user, and we face some authorization issues we have three files to look at:</span></span></p>
<ul class="calibre12">
<li class="calibre13"><kbd class="calibre9"><span><span>/etc/cron.allow</span></span></kbd></li>
<li class="calibre13"><kbd class="calibre9"><span><span>/etc/cron.deny</span></span></kbd></li>
<li class="calibre13"><kbd class="calibre9"><span><span>/etc/pam.d/cron</span></span></kbd></li>
</ul>
<p class="calibre1"><kbd class="calibre9">/etc/at.allow</kbd> is the first file to be read if it exists. If any account names are found in it, these will be the only accounts to be allowed to submit jobs using the crontab utility. If <kbd class="calibre9">/etc/cron.allow</kbd> does not exist, then <kbd class="calibre9">/etc/cron.deny</kbd> is parsed and every account name found in it will be forbidden to send jobs to cron. If the file exists, but it is empty, only the superuser or those listed in <kbd class="calibre9">/etc/cron.allow</kbd> will be able to submit jobs. If neither <kbd class="calibre9">/etc/cron.allow</kbd> nor <kbd class="calibre9">/etc/cron.deny</kbd> are available, any user will be allowed to submit jobs to cron.</p>
<p class="calibre1"><span><span>We talked about the <kbd class="calibre9">crontab</kbd> utility. What is this? It is actually the program that lets us write the crontab files, which instruct cron on which jobs to execute, when, and on behalf of whom. Indeed, each user can have his/her own <kbd class="calibre9">crontab</kbd>, which is stored in </span></span><span><span><kbd class="calibre9">/var/spool/cron/crontabs</kbd>; </span></span><span><span>but we should not edit them manually. We must resort to the <kbd class="calibre9">crontab</kbd> utility, which will let us edit and install the <kbd class="calibre9">crontab</kbd> file in the correct way. So, how do we use</span></span> <kbd class="calibre9">crontab</kbd><span><span>? Let's say we already have a file with our job specifications, and we will see later on how to write it; the only command we have to issue is here:</span></span></p>
<pre class="codepackt">
<strong class="calibre2">crontab filename</strong>
</pre>
<p class="calibre1"><span><span>This will install a new crontab for the current user from the file specified, but we can also manually enter our job details by typing them on the command line with </span></span><kbd class="calibre9">crontab</kbd>.</p>
<p class="calibre1"><span><span>As we can imply from the preceding command lines, if <kbd class="calibre9">crontab</kbd> is called without passing a username, it will work on the cron jobs of the user who invoked it. So, if we want to list or modify a user <kbd class="calibre9">crontab</kbd>, given that we have sufficient privileges, this is being superuser, we can issue the following:</span></span></p>
<pre class="codepackt">
<strong class="calibre2">root:# crontab -u zarrelli -l<br class="title-page-name"/></strong><strong class="calibre2">no crontab for zarrelli</strong>
</pre>
<p class="calibre1"><span><span>If we want to edit and install a new cron job, we can use the following syntax:</span></span></p>
<pre class="codepackt">
<strong class="calibre2">crontab -u user -e</strong>
</pre>
<p class="calibre1"><span><span>Look at the following example:</span></span></p>
<pre class="codepackt">
<strong class="calibre2">root:# crontab -e -u zarrelli<br class="title-page-name"/></strong><strong class="calibre2">no crontab for zarrelli - using an empty one<br class="title-page-name"/><br class="title-page-name"/></strong><strong class="calibre2">Select an editor. To change later, run 'select-editor'.<br class="title-page-name"/></strong><strong class="calibre2">1. /bin/nano &lt;---- easiest<br class="title-page-name"/></strong><strong class="calibre2">2. /usr/bin/mcedit<br class="title-page-name"/></strong><strong class="calibre2">3. /usr/bin/vim.gtk<br class="title-page-name"/></strong><strong class="calibre2">4. /usr/bin/vim.tiny<br class="title-page-name"/><br class="title-page-name"/></strong><strong class="calibre2">Choose 1-4 [1]: </strong>
</pre>
<p class="calibre1"><span><span>Being the first time the <kbd class="calibre9">crontab</kbd> utility is invoked by the user, it could ask for the default editor to be used; if not, the visual or editor environment variable are instanced. If nothing is set, </span></span><span><span><kbd class="calibre9">/usr/bin/editor</kbd> </span></span><span><span>will be used.</span></span></p>
<p class="calibre1"><span><span>In the example shown, the Debian distribution triggered the configuration of <kbd class="calibre9">/etc/alternatives</kbd>, which provides the link to the default editor.</span></span></p>
<p class="calibre1"><span><span>Once into the editor, each cron job must be specified on a line on its own, such as </span></span><span><span><kbd class="calibre9">* * * * * ps</kbd>.  </span></span></p>
<p class="calibre1"><span><span>We will see later what this sequence means; as of now, we just exit the editor and save the content:</span></span></p>
<pre class="codepackt">
<strong class="calibre2">crontab: installing new crontab</strong>
</pre>
<p class="calibre1"><span><span>Once done, <kbd class="calibre9">crontab</kbd> informs us that the crontab has been installed, and it could be interesting to have it displayed on the <kbd class="calibre9">stdout</kbd>:</span></span></p>
<pre class="codepackt">
<strong class="calibre2">crontab -u zarrelli -l</strong>
</pre>
<p class="calibre1"><span><span>As shown in the following example:</span></span></p>
<pre class="codepackt">
<strong class="calibre2">root:# crontab -u zarrelli -l<br class="title-page-name"/></strong><strong class="calibre2"># Edit this file to introduce tasks to be run by cron.<br class="title-page-name"/></strong><strong class="calibre2"># <br class="title-page-name"/></strong><strong class="calibre2"># Each task to run has to be defined through a single line<br class="title-page-name"/></strong><strong class="calibre2"># indicating with different fields when the task will be run<br class="title-page-name"/></strong><strong class="calibre2"># and what command to run for the task<br class="title-page-name"/></strong><strong class="calibre2"># <br class="title-page-name"/></strong><strong class="calibre2"># To define the time you can provide concrete values for<br class="title-page-name"/></strong><strong class="calibre2"># minute (m), hour (h), day of month (dom), month (mon),<br class="title-page-name"/></strong><strong class="calibre2"># and day of week (dow) or use '*' in these fields (for 'any').# <br class="title-page-name"/></strong><strong class="calibre2"># Notice that tasks will be started based on the cron's system<br class="title-page-name"/></strong><strong class="calibre2"># daemon's notion of time and timezones.<br class="title-page-name"/></strong><strong class="calibre2"># <br class="title-page-name"/></strong><strong class="calibre2"># Output of the crontab jobs (including errors) is sent through<br class="title-page-name"/></strong><strong class="calibre2"># email to the user the crontab file belongs to (unless redirected).<br class="title-page-name"/></strong><strong class="calibre2"># <br class="title-page-name"/></strong><strong class="calibre2"># For example, you can run a backup of all your user accounts<br class="title-page-name"/></strong><strong class="calibre2"># at 5 a.m every week with:<br class="title-page-name"/></strong><strong class="calibre2"># 0 5 * * 1 tar -zcf /var/backups/home.tgz /home/<br class="title-page-name"/></strong><strong class="calibre2"># <br class="title-page-name"/></strong><strong class="calibre2"># For more information see the manual pages of crontab(5) and cron(8)<br class="title-page-name"/></strong><strong class="calibre2"># <br class="title-page-name"/></strong><strong class="calibre2"># m h dom mon dow command<br class="title-page-name"/></strong><strong class="calibre2">* * * * * ps</strong>
</pre>
<p class="calibre1"><span><span>If we want to get rid of the crontab, there is a handy option that will remove it completely:</span></span></p>
<pre class="codepackt">
<strong class="calibre2">crontab -u zarrelli -r </strong>
</pre>
<p class="calibre1"><span><span>But be careful-if you want to get rid of some jobs but retain the others, the best solution is to edit the <kbd class="calibre9">crontab</kbd> again, delete the lines related to the jobs we do not want, and then save it. The new <kbd class="calibre9">crontab</kbd> with the remaining jobs will be installed and will completely replace the old one.</span></span></p>
<p class="calibre1"><span><span>If we are not confident in deleting a crontab, we could set an alias that points to </span></span><span><span><kbd class="calibre9">crontab -i -r</kbd> , </span></span><span><span>which works with <kbd class="calibre9">-r</kbd> and prompts the user for a confirmation before deleting the crontab:</span></span></p>
<pre class="codepackt">
<strong class="calibre2">root:# crontab -ir<br class="title-page-name"/></strong><strong class="calibre2">crontab: really delete root's crontab? (y/n)</strong>
</pre>
<p class="calibre1"><span><span>We will not touch some distribution specific configurations, such as the support for </span></span><span><span><kbd class="calibre9">/etc/cron.hourly</kbd>, </span></span><span><span><kbd class="calibre9">/etc/cron.daily</kbd>, </span></span><span><span><kbd class="calibre9">/etc/cron.weekly</kbd>, and </span></span><span><span><kbd class="calibre9">/etc/cron.monthly</kbd> </span></span><span><span>provided through the </span></span><span><span><kbd class="calibre9">/etc/crontab</kbd> </span></span><span><span>file, since otherwise, we would end up drilling down all the bits and configurations of all possible cron implementations in all the main distributions.</span></span></p>
<p class="calibre1"><span><span>What interests us here is to understand the underlying basic notions on how to deal with cron so that whatever different implementation we find, we will be able to deal with it and look into its idiosyncrasies. There are a couple of interesting things left to see now: one is the syntax we will use to define a job and the other is a quick glance to anacron: a utility we have often heard of.</span></span></p>
<p class="calibre1"><span><span>Even if a <kbd class="calibre9">crontab</kbd> file can look a bit cryptic at first glance, it is not so difficult to understand what the sequence of the characters mean: the first field is for the minute when the job must be executed; the second for the hour; the third for the day of the month; the fourth for the month; the fifth for the day of the week; and the sixth for the command to execute. So, the <kbd class="calibre9">crontab</kbd> we just created a few lines ago can be read as laid out in the following table:</span></span></p>
<table class="table">
<tbody class="calibre6">
<tr class="calibre7">
<td class="calibre8">
<p class="calibre1"><strong class="calibre2">Fields</strong></p>
</td>
<td class="calibre8">
<div class="packt_figure"><strong class="calibre2">*</strong></div>
</td>
<td class="calibre8">
<div class="packt_figure"><strong class="calibre2">*</strong></div>
</td>
<td class="calibre8">
<div class="packt_figure"><strong class="calibre2">*</strong></div>
</td>
<td class="calibre8">
<div class="packt_figure"><strong class="calibre2">*</strong></div>
</td>
<td class="calibre8">
<div class="packt_figure"><strong class="calibre2">*</strong></div>
</td>
<td class="calibre8">
<div class="packt_figure"><strong class="calibre2">ps</strong></div>
</td>
</tr>
<tr class="calibre7">
<td class="calibre8">
<p class="calibre1">Minutes</p>
</td>
<td class="calibre8">
<div class="packt_figure">X</div>
</td>
<td class="calibre8"/>
<td class="calibre8"/>
<td class="calibre8"/>
<td class="calibre8"/>
<td class="calibre8"/>
</tr>
<tr class="calibre7">
<td class="calibre8">
<p class="calibre1">Hours</p>
</td>
<td class="calibre8"/>
<td class="calibre8">
<div class="packt_figure">X</div>
</td>
<td class="calibre8"/>
<td class="calibre8"/>
<td class="calibre8"/>
<td class="calibre8"/>
</tr>
<tr class="calibre7">
<td class="calibre8">
<p class="calibre1">Day of the month</p>
</td>
<td class="calibre8"/>
<td class="calibre8"/>
<td class="calibre8">
<div class="packt_figure">X</div>
</td>
<td class="calibre8"/>
<td class="calibre8"/>
<td class="calibre8"/>
</tr>
<tr class="calibre7">
<td class="calibre8">
<p class="calibre1">Month</p>
</td>
<td class="calibre8"/>
<td class="calibre8"/>
<td class="calibre8"/>
<td class="calibre8">
<div class="packt_figure">X</div>
</td>
<td class="calibre8"/>
<td class="calibre8"/>
</tr>
<tr class="calibre7">
<td class="calibre8">
<p class="calibre1">Day of the week</p>
</td>
<td class="calibre8"/>
<td class="calibre8"/>
<td class="calibre8"/>
<td class="calibre8"/>
<td class="calibre8">
<div class="packt_figure">X</div>
</td>
<td class="calibre8"/>
</tr>
<tr class="calibre7">
<td class="calibre8">
<p class="calibre1">Command</p>
</td>
<td class="calibre8"/>
<td class="calibre8"/>
<td class="calibre8"/>
<td class="calibre8"/>
<td class="calibre8"/>
<td class="calibre8">
<div class="packt_figure">X</div>
</td>
</tr>
</tbody>
</table>
<div class="packt_figref"><span><span>What the fields mean</span></span></div>
<p class="calibre1"><span><span>Okay, now we know what these fields mean, but what are those asterisks and what can we write into each field? Another table will make all this easier to understand:</span></span></p>
<table class="table">
<tbody class="calibre6">
<tr class="calibre7">
<td class="calibre8">
<p class="calibre1"><strong class="calibre2">Field</strong></p>
</td>
<td class="calibre8">
<p class="calibre1"><strong class="calibre2">Allowed values</strong></p>
</td>
<td class="calibre8">
<p class="calibre1"><strong class="calibre2">Metacharacters</strong></p>
</td>
</tr>
<tr class="calibre7">
<td class="calibre8">
<p class="calibre1">Minutes</p>
</td>
<td class="calibre8">
<p class="calibre1">0-59</p>
</td>
<td class="calibre8">
<p class="calibre1">* , - /</p>
</td>
</tr>
<tr class="calibre7">
<td class="calibre8">
<p class="calibre1">Hours</p>
</td>
<td class="calibre8">
<p class="calibre1">0-23</p>
</td>
<td class="calibre8">
<p class="calibre1">* , - /</p>
</td>
</tr>
<tr class="calibre7">
<td class="calibre8">
<p class="calibre1">Day of the month</p>
</td>
<td class="calibre8">
<p class="calibre1">1-31</p>
</td>
<td class="calibre8">
<p class="calibre1">* , - /</p>
</td>
</tr>
<tr class="calibre7">
<td class="calibre8">
<p class="calibre1">Month</p>
</td>
<td class="calibre8">
<p class="calibre1">1-12 or Jan-Dec</p>
</td>
<td class="calibre8">
<p class="calibre1">* , - /</p>
</td>
</tr>
<tr class="calibre7">
<td class="calibre8">
<p class="calibre1">Day of the week</p>
</td>
<td class="calibre8">
<p class="calibre1">0-7 or Sun-Sat</p>
</td>
<td class="calibre8">
<p class="calibre1">* , - /</p>
</td>
</tr>
</tbody>
</table>
<div class="packt_figref"><span><span>Which values can be used inside each field</span></span></div>
<p class="calibre1"><span><span>We are almost there. Just a few things more to learn and we will be able to fully understand a crontab line; but first, what are those metacharacters and what do they mean?</span></span></p>
<div class="packt_infobox"><span class="calibre30">Keep in mind that Sunday can be specified both as <kbd class="calibre28">0</kbd> and <kbd class="calibre28">7</kbd> in the day of the week field.</span></div>
<ul class="calibre12">
<li class="calibre13"><span><span><kbd class="calibre9">*</kbd>: This stands for <em class="calibre20">every</em> and can be used in all the fields. So, inside a minute field it will tell cron to run the job every minute, inside the hour every hour, and so forth.</span></span></li>
<li class="calibre13"><span><span><kbd class="calibre9">,</kbd>: The comma defines a list. For instance, <kbd class="calibre9">1</kbd>, <kbd class="calibre9">5</kbd>, and <kbd class="calibre9">15</kbd> in the day of the month will instruct cron to run the job on the first, the fifth, and on the fifteenth day.</span></span></li>
<li class="calibre13"><span><span><kbd class="calibre9">-</kbd>: The hyphen defines an inclusive range. For instance, 4-7 in the day of the week field will force cron to execute the job from Thursday to Sunday.</span></span></li>
<li class="calibre13"><span><span><kbd class="calibre9">/</kbd>: The forward slash is used to define steps, and it can be used with ranges so that it will skip the value of the number through the range. So, 1-59/2 in the minute field will give us all the odd minutes in one hour, since it will start from one and wait 2 minutes before the next execution; this can be specified as a list as well: <kbd class="calibre9">1</kbd>, <kbd class="calibre9">3</kbd>, <kbd class="calibre9">5</kbd>, <kbd class="calibre9">7</kbd>, <kbd class="calibre9">9</kbd>, <kbd class="calibre9">11</kbd>, <kbd class="calibre9">13</kbd>, <kbd class="calibre9">15</kbd>, <kbd class="calibre9">17</kbd>, <kbd class="calibre9">19</kbd>, <kbd class="calibre9">21</kbd>, <kbd class="calibre9">23</kbd>, <kbd class="calibre9">25</kbd>, <kbd class="calibre9">27</kbd>, <kbd class="calibre9">29</kbd>, <kbd class="calibre9">31</kbd>, <kbd class="calibre9">33</kbd>, <kbd class="calibre9">35</kbd>, <kbd class="calibre9">37</kbd>, <kbd class="calibre9">39</kbd>, <kbd class="calibre9">41</kbd>, <kbd class="calibre9">43</kbd>, <kbd class="calibre9">45</kbd>, <kbd class="calibre9">47</kbd>, <kbd class="calibre9">49</kbd>, <kbd class="calibre9">51</kbd>, <kbd class="calibre9">53</kbd>, <kbd class="calibre9">55</kbd>, <kbd class="calibre9">57</kbd>, and</span></span> <kbd class="calibre9">59</kbd><span><span>.</span></span></li>
</ul>
<p class="calibre1"><span><span>As we can see, steps can be quite handy. The forward slash can also be combined with the asterisk: <kbd class="calibre9">*/2</kbd> in the hours field means <em class="calibre20">every 2 hours</em>, in the month field would be <em class="calibre20">every two months,</em> and so forth.</span></span></p>
<div class="packt_infobox"><span class="calibre30">Some implementations of cron support an extra field for the <em class="calibre34">year,</em> with values from <kbd class="calibre28">1970</kbd> to <kbd class="calibre28">2099</kbd> supporting the <kbd class="calibre28">*</kbd>  and  <kbd class="calibre28">-</kbd> metacharacters.</span></div>
<p class="calibre1">There is one set of special markers we have to see before analyzing a crontab line. We can define some recurrences using special keywords prefixed by an <kbd class="calibre9">@</kbd>, as shown in the next table:</p>
<table class="calibre35">
<tbody class="calibre6">
<tr class="calibre7">
<td class="calibre8">
<p class="calibre1"><strong class="calibre2">Keyword</strong></p>
</td>
<td class="calibre8">
<p class="calibre1"><strong class="calibre2">Execution</strong></p>
</td>
<td class="calibre8">
<p class="calibre1"><strong class="calibre2">The same as</strong></p>
</td>
</tr>
<tr class="calibre7">
<td class="calibre8">
<p class="calibre1"><kbd class="calibre9">@yearly</kbd></p>
</td>
<td class="calibre8">
<p class="calibre1">Once a year, at midnight of Jan 1st</p>
</td>
<td class="calibre8">
<p class="calibre1"><kbd class="calibre9">0 0 1 1 *</kbd></p>
</td>
</tr>
<tr class="calibre7">
<td class="calibre8">
<p class="calibre1"><kbd class="calibre9">@annually</kbd></p>
</td>
<td class="calibre8">
<p class="calibre1">Equivalent to <kbd class="calibre9">@yearly</kbd></p>
</td>
<td class="calibre8">
<p class="calibre1"><kbd class="calibre9">0 0 1 1 *</kbd></p>
</td>
</tr>
<tr class="calibre7">
<td class="calibre8">
<p class="calibre1"><kbd class="calibre9">@montly</kbd></p>
</td>
<td class="calibre8">
<p class="calibre1">Once a month, at midnight of the first day of the month</p>
</td>
<td class="calibre8">
<p class="calibre1"><kbd class="calibre9">0 0 1 * *</kbd></p>
</td>
</tr>
<tr class="calibre7">
<td class="calibre8">
<p class="calibre1"><kbd class="calibre9">@weekly</kbd></p>
</td>
<td class="calibre8">
<p class="calibre1">Once a week, at midnight between Sat and Sun</p>
</td>
<td class="calibre8">
<p class="calibre1"><kbd class="calibre9">0 0 * * 0</kbd></p>
</td>
</tr>
<tr class="calibre7">
<td class="calibre8">
<p class="calibre1"><kbd class="calibre9">@daily</kbd></p>
</td>
<td class="calibre8">
<p class="calibre1">Once a day, at midnight</p>
</td>
<td class="calibre8">
<p class="calibre1"><kbd class="calibre9">0 0 * * *</kbd></p>
</td>
</tr>
<tr class="calibre7">
<td class="calibre8">
<p class="calibre1"><kbd class="calibre9">@midnight</kbd></p>
</td>
<td class="calibre8">
<p class="calibre1">Equivalent to <kbd class="calibre9">@daily</kbd></p>
</td>
<td class="calibre8">
<p class="calibre1"><kbd class="calibre9">0 0 * * *</kbd></p>
</td>
</tr>
<tr class="calibre7">
<td class="calibre8">
<p class="calibre1"><kbd class="calibre9">@hourly</kbd></p>
</td>
<td class="calibre8">
<p class="calibre1">Once an hour, at the tick of the hour</p>
</td>
<td class="calibre8">
<p class="calibre1"><kbd class="calibre9">0 * * * *</kbd></p>
</td>
</tr>
<tr class="calibre7">
<td class="calibre8">
<p class="calibre1"><kbd class="calibre9">@reboot</kbd></p>
</td>
<td class="calibre8">
<p class="calibre1">At cron daemon startup</p>
</td>
<td class="calibre8">
<p class="calibre1"><kbd class="calibre9">nothing</kbd></p>
</td>
</tr>
</tbody>
</table>
<div class="packt_figref"><span><span>Keywords with special meanings</span></span></div>
<p class="calibre1"><span><span><kbd class="calibre9">This</kbd> replaces all the first five fields altogether and can become handy if you do not have special constraints about hours or days, but you want something being executed in a generic time frame.</span></span></p>
<p class="calibre1"><span><span>Before proceeding there are a few things to be aware of:</span></span></p>
<ul class="calibre12">
<li class="calibre13"><span><span>Each line specifying a cron job must be ended by a newline.</span></span></li>
<li class="calibre13"><span><span>The percent sign <kbd class="calibre9">%</kbd> used in the command field is turned into a newline character, and all the data after the first <kbd class="calibre9">%</kbd> is sent to the <kbd class="calibre9">stdin</kbd> of the command to be executed. The percentage can be escaped by doubling it <kbd class="calibre9">%%</kbd> so that it will not be interpreted as a newline.</span></span></li>
<li class="calibre13"><span><span>Inside the crontab file, blank lines, leading spaces, and tabs are not parsed. If a line starts with <kbd class="calibre9">#</kbd> , it will be treated as a comment and not parsed.</span></span></li>
<li class="calibre13"><span><span>In the crontab file, we can either set some variables or define a cron job; nothing else is allowed.</span></span></li>
<li class="calibre13"><span><span>A variable can be assigned as </span></span><kbd class="calibre9"><span><span>VARIABLE_NAME = value</span></span></kbd><span><span>.</span></span></li>
<li class="calibre13"><span><span>Spaces surrounding the equals sign are optional.</span></span></li>
<li class="calibre13"><span><span>No expansions or substitutions are performed on variables. So, </span></span><span><span><kbd class="calibre9">VARIABLE_NAME=$LOGNAME</kbd> </span></span><span><span>will not instance <kbd class="calibre9">VARIABLE_NAME</kbd> since the value string is not even parsed for expansion or substitution.</span></span></li>
<li class="calibre13"><span><span>An empty value must be surrounded by quotes, and if the values contain blanks, quotes are required to preserve them.</span></span></li>
<li class="calibre13"><span><span>No per user time zones are available. The default system time zone is used instead.</span></span></li>
</ul>
<p class="calibre1"><span><span>So, with this in mind, let's have a look at a cron job specification:</span></span></p>
<table class="table">
<tbody class="calibre6">
<tr class="calibre7">
<td class="calibre8">
<p class="calibre1">35</p>
</td>
<td class="calibre8">
<p class="calibre1">1-24/4</p>
</td>
<td class="calibre8">
<p class="calibre1">*</p>
</td>
<td class="calibre8">
<p class="calibre1">*</p>
</td>
<td class="calibre8">
<p class="calibre1">Mon,Thu</p>
</td>
<td class="calibre8">
<p class="calibre1">/opt/scripts/script.sh</p>
</td>
</tr>
<tr class="calibre7">
<td class="calibre8">
<p class="calibre1">minutes</p>
</td>
<td class="calibre8">
<p class="calibre1">hours</p>
</td>
<td class="calibre8">
<p class="calibre1">Day of the month</p>
</td>
<td class="calibre8">
<p class="calibre1">month</p>
</td>
<td class="calibre8">
<p class="calibre1">Day of the week</p>
</td>
<td class="calibre8">
<p class="calibre1">command</p>
</td>
</tr>
<tr class="calibre7">
<td class="calibre8">
<p class="calibre1">Execute at minute 35 past every 4th hour, from 1 through 24 on Monday and Thursday</p>
</td>
</tr>
</tbody>
</table>
<div class="packt_figref"><br class="title-page-name"/>
A useful grid to make sense of a job specification line</div>
<p class="calibre1"><span><span>Caged in a table, the job specification is easier to understand and becomes much easier if we use some keywords:</span></span></p>
<pre class="codepackt">
<strong class="calibre2">@weekly /opt/scripts/script.sh</strong>
</pre>
<p class="calibre1"><span><span>That's all, the definition was shortened to two simple fields. But fiddling with the fields can lead us to something tricky:</span></span></p>
<pre class="codepackt">
<strong class="calibre2">1-59/2 * * * * /opt/scripts/script.sh</strong>
</pre>
<p class="calibre1"><span><span>What does this do? Simply executes the script every odd minute, not even, odd.</span></span></p>
<p class="calibre1"><span><span>But what if the system is rebooted or is a desktop, which can stay off for days or weeks? Using cron would lead to some jobs not being executed at all or just skipped, and this is not a desirable behavior. This is where anacron comes in handy: it will run a job even if we switch on the desktop after the scheduled time. How can it be? Simply, this utility keeps a log of all the jobs and when they were executed using a series of timestamped files held in </span></span><span><span><kbd class="calibre9">/var/spool/anacron</kbd>.</span></span></p>
<p class="calibre1"><span><span>Let's proceed in an orderly manner and have a look at the file which drives anacron, whose name is </span></span><span><span><kbd class="calibre9">/etc/anacron</kbd>.</span></span></p>
<p class="calibre1"><span><span>To better understand it, we must have a peek into its content:</span></span></p>
<pre class="codepackt">
<strong class="calibre2">root:# cat /etc/anacrontab <br class="title-page-name"/></strong><strong class="calibre2"># /etc/anacrontab: configuration file for anacron<br class="title-page-name"/></strong><strong class="calibre2"># See anacron(8) and anacrontab(5) for details.<br class="title-page-name"/></strong><strong class="calibre2">SHELL=/bin/sh<br class="title-page-name"/></strong><strong class="calibre2">PATH=/usr/local/sbin:/usr/local/bin:/sbin:/bin:/usr/sbin:/usr/bin<br class="title-page-name"/></strong><strong class="calibre2">HOME=/root<br class="title-page-name"/></strong><strong class="calibre2">LOGNAME=root<br class="title-page-name"/></strong><strong class="calibre2"># These replace cron's entries<br class="title-page-name"/></strong><strong class="calibre2">1 5 cron.daily run-parts --report /etc/cron.daily<br class="title-page-name"/></strong><strong class="calibre2">7 10 cron.weekly run-parts --report /etc/cron.weekly<br class="title-page-name"/></strong><strong class="calibre2">@monthly 15 cron.monthly run-parts --report /etc/cron.monthly</strong>
</pre>
<p class="calibre1"><span><span>As we can notice, we can have variables with crontab, but the format of a job definition is slightly different and can have one of the following syntaxes:</span></span></p>
<pre class="codepackt">
<strong class="calibre2">period delay job_name command<br class="title-page-name"/></strong><strong class="calibre2">@period_identifier delay job_name command</strong>
</pre>
<ul class="calibre12">
<li class="calibre13"><span><span><kbd class="calibre9">period</kbd>: Expressed in days specifying the frequency the job is run at. For instance, 10 is every 10 days.</span></span></li>
<li class="calibre13"><span><span><kbd class="calibre9">@period</kbd>: Allows to use some keywords to specify the frequency: <kbd class="calibre9">@daily</kbd>, <kbd class="calibre9">@weekly</kbd>, and <kbd class="calibre9">@monthly</kbd> for once per day, week, and month.</span></span></li>
<li class="calibre13"><span><span><kbd class="calibre9">delay</kbd>: Expressed in minutes, defines the delay after which anacron executes a scheduled job when the threshold is hit.</span></span></li>
<li class="calibre13"><span><span><kbd class="calibre9">job-name</kbd>: We can give a job whatever identifier we want, but no slashes are allowed. It will be used by anacron as the name for the timestamp file of the job.</span></span></li>
<li class="calibre13"><span><span><kbd class="calibre9">command</kbd>: Can be whatever command.</span></span></li>
</ul>
<p class="calibre1"><span><span>As we can see, the standard anacron file in the example will run the run-parts utility along with the directory argument. And, the exact job of run-parts is to run the scripts it finds in the directory it is being given as arguments. So, interpreting the anacron lines should be easy now, should't it? Editing it is easy as well: we can do it by hand, no special utilities are required or available.</span></span></p>
<p class="calibre1"><span><span>The way anacron works is amazingly straightforward and effective: it checks each job specified in the <kbd class="calibre9">anacrontab</kbd> file and sees whether it has been executed in the last x specified in the period field. If it has not been run and the threshold is hit, it will execute the job after waiting for the delay set in the second field of the job definition. Once the task has been executed, anacron records the date in a timestamp file related to the job; so next time, it will just have to read it to know what to do:</span></span></p>
<pre class="codepackt">
<strong class="calibre2">root:# cat /var/spool/anacron/cron.weekly<br class="title-page-name"/></strong><strong class="calibre2">20170424</strong>
</pre>
<p class="calibre1"><span><span>Once all the jobs scheduled have been executed, anacron exits; but, we also send anacron a SIGUSR1 signal to kill it: it will wait for any running jobs to finish and then will cleanly exit.</span></span></p>
<p class="calibre1"><span><span>But there is also another task performed by anacron once a job has been executed: if any output is created by the job, it is mailed to the user running anacron, usually root, or the one whose email is specified in the MAILTO environment variable from anacrontab. If a <kbd class="calibre9">LOGNAME</kbd> variable is instanced, it will be used as the sender of the email.</span></span></p>
<p class="calibre1"><span><span>Finally, let's see which options are supported by anacron:</span></span></p>
<ul class="calibre12">
<li class="calibre13"><span><span><kbd class="calibre9">-f</kbd>: Forces anacron to execute all the defined jobs, regardless of the timestamps.</span></span></li>
<li class="calibre13"><span><span><kbd class="calibre9">-u</kbd>: Just updates the timestamps of the jobs to the current date without executing them.</span></span></li>
<li class="calibre13"><span><span><kbd class="calibre9">-s</kbd>: Serializes the execution of the jobs; meaning that, before starting the next job, anacron will wait for the current one to be completed.</span></span></li>
<li class="calibre13"><span><span><kbd class="calibre9">-n</kbd>: Ignores the delay specification for each job and runs them as they hit the threshold. Implies the -s option.</span></span></li>
<li class="calibre13"><span><span><kbd class="calibre9">-d</kbd>: Usually anacron goes in background, but this option will force it to the foreground. It is useful for debugging, since anacron will sendn the runtime messages to the stderr and to syslog. The output emails will be sent to the recipient anyway.</span></span></li>
<li class="calibre13"><span><span><kbd class="calibre9">-q</kbd>: Does not print messages to the stderr and implies the <kbd class="calibre9">-d</kbd> option.</span></span></li>
<li class="calibre13"><span><span><kbd class="calibre9">-t</kbd> file: Reads the jobs, definitions from the specified file instead of the default anacrontab.</span></span></li>
<li class="calibre13"><span><span><kbd class="calibre9">-T</kbd>: Tests the validity of anacrontab. If there are any errors, they will be shown and anacron will return the value of</span></span> <kbd class="calibre9">1</kbd>; <span><span>otherwise, it will return <kbd class="calibre9">0</kbd>.</span></span></li>
<li class="calibre13"><span><span><kbd class="calibre9">-S</kbd> <span>directory:</span> Uses the specified directory to store the timestamp files.</span></span></li>
<li class="calibre13"><span><span><kbd class="calibre9">-V</kbd>: Prints anacron version and exits.</span></span></li>
<li class="calibre13"><span><span><kbd class="calibre9">-h</kbd>: Prints the usage help and exits.</span></span></li>
</ul>


            </article>

            
        </section>
    

        <section>

                            <header>
                    </header><h1 class="header-title" id="calibre_pb_0">Summary</h1>
                
            
            <article>
                
<p class="calibre1"><span><span>We now have two methods available to execute jobs: one is a daemon, which forks in the background and stays there working on some, hopefully, important tasks; the other is the schedulers, great for those jobs that must be executed with a recurring pattern. These tools can really help us to keep everything in order, and execute complex and boring tasks by easing the maintenance of a server or even a desktop. But Bash is not only made of commands, scripts, tasks, and services: it is the home we are working in on a daily basis. It is our playground, our workbench, something to get familiar with. So, the next chapter will deal with some utilities, configurations, and advice to make our Bash a cozy place to live our digital life.</span></span></p>


            </article>

            
        </section>
    </body></html>