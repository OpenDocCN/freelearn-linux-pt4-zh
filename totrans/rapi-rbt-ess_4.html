<html><head></head><body><div class="chapter" title="Chapter&#xA0;4.&#xA0;Avoiding Obstacles Using Sensors"><div class="titlepage"><div><div><h1 class="title"><a id="ch04"/>Chapter 4. Avoiding Obstacles Using Sensors</h1></div></div></div><p>You've constructed your biped robot. Now, your robot can move around. But what if you want the robot to sense the outside world, so you don't run into things? In this chapter, you'll discover how to add some sensors to help avoid barriers.</p><p>Specifically, you'll learn:</p><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc">How to<a id="id149" class="indexterm"/> connect Raspberry Pi to an <span class="strong"><strong>IR</strong></span> (<span class="strong"><strong>infrared</strong></span>) sensor</li><li class="listitem" style="list-style-type: disc">How to <a id="id150" class="indexterm"/>connect Raspberry Pi to a USB <span class="strong"><strong>sonar sensor</strong></span> to detect the world</li><li class="listitem" style="list-style-type: disc">How to connect Raspberry Pi and its GPIO to a sonar sensor to detect the world</li></ul></div><div class="section" title="Connecting Raspberry Pi to an infrared sensor"><div class="titlepage"><div><div><h1 class="title"><a id="ch04lvl1sec25"/>Connecting Raspberry Pi to an infrared sensor</h1></div></div></div><p>Your <a id="id151" class="indexterm"/>robot can now move around, but you'll <a id="id152" class="indexterm"/>want to be able to sense a barrier or a target. One of the ways to do this is with an IR sensor. First, a tutorial on IR sensors is required. An IR sensor has both a transmitter and a sensor. The transmitter sends out a narrow beam of light, and the sensor receives this beam of light. </p><p>The difference in transit ends up as an angle measurement in the sensor, as shown in the following figure:</p><div class="mediaobject"><img src="graphics/B04591_04_01.jpg" alt="Connecting Raspberry Pi to an infrared sensor"/></div><p>The <a id="id153" class="indexterm"/>different angles give you an indication <a id="id154" class="indexterm"/>of the distance from the object. The sensor turns these angle measurements into a voltage that you can sense to determine the distance. Unfortunately, the relationship between the output of the sensor and the distance is not linear, so you'll need to do some calibration in order to predict the actual distance and its relationship to the output of the sensor.</p><div class="note" title="Note" style=""><div class="inner"><h3 class="title"><a id="note08"/>Note</h3><p>IR sensors are quite accurate, certainly with a low percentage of errors; however, they may not work well if the area is brightly lit. The accuracy is also affected by the reflective nature of the material being sensed. This can be a consideration when deciding which sensors to use.</p></div></div><p>Before you get started, you'll need to get a sensor. One of the more popular ones is an inexpensive IR sensor by Sharp. It is available at many online electronics stores, and it comes in models that sense various distances. You'll be using the <span class="strong"><strong>Sharp 2Y0A02</strong></span> model, a unit <a id="id155" class="indexterm"/>that provides sensing to a distance of 150 cm. Here is a picture of the sensor:</p><div class="mediaobject"><img src="graphics/B04591_04_02.jpg" alt="Connecting Raspberry Pi to an infrared sensor"/></div><p>You'll <a id="id156" class="indexterm"/>also want to make sure you also<a id="id157" class="indexterm"/> get the connector cable for the device; it normally comes with the device. Here is a picture of the sensor with the cable attached:</p><div class="mediaobject"><img src="graphics/B04591_04_03.jpg" alt="Connecting Raspberry Pi to an infrared sensor"/></div><p>As noted in the tutorial, the voltage out of the sensor will be a voltage that will be an indication of the distance. However, this is an analog signal, and the Raspberry Pi doesn't have an analog-to-digital converter that can convert this analog voltage to a number that you can read in your program. You'll need to add an analog to digital converter to your project.</p><p>There are two choices. If you want an analog-to-digital converter that plugs directly into the USB interface, there<a id="id158" class="indexterm"/> is one offered by <a class="ulink" href="http://www.phidgets.com">www.phidgets.com</a>. This board is really quite amazing; it takes the analog signals, turns them into digital numbers using an analog to digital converter, and then makes them available<a id="id159" class="indexterm"/> so that they can be read from the USB port. The model number of this part is <span class="strong"><strong>1011_0 - PhidgetInterfaceKit 2/2/2</strong></span> and it is shown in the following:</p><div class="mediaobject"><img src="graphics/B04591_04_04.jpg" alt="Connecting Raspberry Pi to an infrared sensor"/></div><p>Unfortunately, it <a id="id160" class="indexterm"/>takes a bit of programming<a id="id161" class="indexterm"/> expertise to get it up and running. The other choice is to use an analog-to-digital converter that connects to the GPIO pins of the Raspberry Pi. There is a part, the <span class="strong"><strong>ADC pi+</strong></span> from <a class="ulink" href="http://www.abelectronics.co.uk">www.abelectronics.co.uk</a>, that <a id="id162" class="indexterm"/>does this. It is pictured here:</p><div class="mediaobject"><img src="graphics/B04591_04_05.jpg" alt="Connecting Raspberry Pi to an infrared sensor"/></div><p>This device is easier to program, so this is what you'll use in this project. Now, let's connect<a id="id163" class="indexterm"/> the<a id="id164" class="indexterm"/> sensor:</p><div class="orderedlist"><ol class="orderedlist arabic"><li class="listitem">Solder header pins to the ADC Pi+ board to connect it to the ADC, like this:<div class="mediaobject"><img src="graphics/B04591_04_06.jpg" alt="Connecting Raspberry Pi to an infrared sensor"/></div></li><li class="listitem">Now, plug the board into the Raspberry Pi B 2. Here is a picture of the combination:<div class="mediaobject"><img src="graphics/B04591_04_07.jpg" alt="Connecting Raspberry Pi to an infrared sensor"/></div></li><li class="listitem">Now, you'll connect the IR sensor to the ADC. To connect this unit, you'll connect<a id="id165" class="indexterm"/> the three pins that <a id="id166" class="indexterm"/>are available at the bottom<a id="id167" class="indexterm"/> of the sensor. Here is the connection list:<div class="informaltable"><table border="1"><colgroup><col style="text-align: left"/><col style="text-align: left"/></colgroup><thead><tr><th style="text-align: left" valign="bottom">
<p>ADC-DAC Board</p>
</th><th style="text-align: left" valign="bottom">
<p>Sensor Pin</p>
</th></tr></thead><tbody><tr><td style="text-align: left" valign="top">
<p>5V</p>
</td><td style="text-align: left" valign="top">
<p>Vcc</p>
</td></tr><tr><td style="text-align: left" valign="top">
<p>GND</p>
</td><td style="text-align: left" valign="top">
<p>Gnd</p>
</td></tr><tr><td style="text-align: left" valign="top">
<p>In1</p>
</td><td style="text-align: left" valign="top">
<p>Vo</p>
</td></tr></tbody></table></div><p>Unfortunately, there are no labels on the unit, but here are the pins you'll connect:</p><div class="mediaobject"><img src="graphics/B04591_04_08.jpg" alt="Connecting Raspberry Pi to an infrared sensor"/></div><p>It's <a id="id168" class="indexterm"/>easiest to connect <a id="id169" class="indexterm"/>to the three-wire cable that normally comes with the sensor. Once the pins are connected, you are ready to access the data from the sensor via a Python program on the Raspberry Pi. The entire system looks like this:</p><div class="mediaobject"><img src="graphics/B04591_04_09.jpg" alt="Connecting Raspberry Pi to an infrared sensor"/></div></li></ol></div><p>Now, you<a id="id170" class="indexterm"/> are <a id="id171" class="indexterm"/>ready to add some code to read the IR sensor. You'll need to follow these steps to talk to the ADC:</p><div class="orderedlist"><ol class="orderedlist arabic"><li class="listitem">The first step in enabling the ADC is to enable the I2C interface. This is done by running <code class="literal">raspi-config</code> and selecting <span class="strong"><strong>8 Advanced Options</strong></span> like this:<div class="mediaobject"><img src="graphics/B04591_04_10.jpg" alt="Connecting Raspberry Pi to an infrared sensor"/></div></li><li class="listitem">Once <a id="id172" class="indexterm"/>there, go to the <span class="strong"><strong>A7 I2C</strong></span> selection<a id="id173" class="indexterm"/> to enable the I2C like this:<div class="mediaobject"><img src="graphics/B04591_04_10.jpg" alt="Connecting Raspberry Pi to an infrared sensor"/></div><p>Perform all the selections to enable the I2C interface and load the library, and then reboot the Raspberry Pi.</p><p>You'll also need to edit the <code class="literal">/etc/modules</code> file and add the following two<a id="id174" class="indexterm"/> lines:</p><div class="mediaobject"><img src="graphics/B04591_04_12.jpg" alt="Connecting Raspberry Pi to an infrared sensor"/></div><p>Reboot<a id="id175" class="indexterm"/> the Raspberry Pi. You can see whether the I2C is enabled by typing <code class="literal">sudo i2cdetect -y 1</code>, and you should see something like this:</p><div class="mediaobject"><img src="graphics/B04591_04_13.jpg" alt="Connecting Raspberry Pi to an infrared sensor"/></div><p>The I2C device, your ADC, is available at the <span class="strong"><strong>68</strong></span> and <span class="strong"><strong>69</strong></span> addresses.</p></li><li class="listitem">Now, you<a id="id176" class="indexterm"/> can download the <a id="id177" class="indexterm"/>code. To do this, type <code class="literal">git clone https://github.com/abelectronicsuk/ABElectronics_Python_Libraries.git</code> from the home directory, and the Python libraries will be installed on your Raspberry Pi.</li><li class="listitem">Go to the <code class="literal">./ABElecttronics_Python_Libraries/ADCPi</code> directory; here are the programs for your specific hardware. Following the instructions in the <code class="literal">README.md</code> file, type <code class="literal">sudo apt-get update</code>, and then type <code class="literal">sudo apt-get install python-smbus</code>. This will install the <code class="literal">smbus</code> library, which are required for the ADC to work. Also, type <code class="literal">sudo adduser pi i2c</code> to add <code class="literal">pi</code> to the group that can access i2c.</li><li class="listitem">You'll need to edit your <code class="literal">.bashrc</code> file in your home directory, adding the following lines:<div class="mediaobject"><img src="graphics/B04591_04_14.jpg" alt="Connecting Raspberry Pi to an infrared sensor"/></div><p>Adding<a id="id178" class="indexterm"/> this line will <a id="id179" class="indexterm"/>add this library to the path so that you can access the functionality. Reboot the Raspberry Pi.</p></li><li class="listitem">Now, you can run one of the demo programs. Type <code class="literal">python demo-readvoltage.py</code>, and you should see something like this:<div class="mediaobject"><img src="graphics/B04591_04_15.jpg" alt="Connecting Raspberry Pi to an infrared sensor"/></div><p>These <a id="id180" class="indexterm"/>raw readings <a id="id181" class="indexterm"/>are great, but now you'll want to build a program that takes the data from the first ADC and translates it to the distance. To do this, you'll need a graph of the voltage to distance readings for your sensor. Here is the graph for the IR sensor in this example:</p><div class="mediaobject"><img src="graphics/B04591_04_16.jpg" alt="Connecting Raspberry Pi to an infrared sensor"/></div><p>There<a id="id182" class="indexterm"/> are really two<a id="id183" class="indexterm"/> parts to the curve; the first is the distance up to about 15 centimeters, and the second is the distance from 15 centimeters to 150 centimeters. It is easiest to build a simple mathematical model that ignores distances closer than 15 centimeters and models the distance from 15 centimeters. For <a id="id184" class="indexterm"/>more information on how to build this model, refer to <a class="ulink" href="http://davstott.me.uk/index.php/2013/06/02/raspberry-pi-sharp-infrared/">http://davstott.me.uk/index.php/2013/06/02/raspberry-pi-sharp-infrared/</a>. Here is the Python program using this model:</p><div class="mediaobject"><img src="graphics/B04591_04_17.jpg" alt="Connecting Raspberry Pi to an infrared sensor"/></div><p>The <a id="id185" class="indexterm"/>only new line of <a id="id186" class="indexterm"/>code is the distance = (1.0 / (adc.read_adc_voltage(1) / 13.15)) - 0.35 line. It converts your voltage to distance. You can now run your program and you'll see the results in centimeters, like this:</p><div class="mediaobject"><img src="graphics/B04591_04_18.jpg" alt="Connecting Raspberry Pi to an infrared sensor"/></div><p>Now, you can measure the distance to objects using your IR sensor!</p></li></ol></div></div></div>
<div class="section" title="Connecting Raspberry Pi to a USB sonar sensor"><div class="titlepage"><div><div><h1 class="title"><a id="ch04lvl1sec26"/>Connecting Raspberry Pi to a USB sonar sensor</h1></div></div></div><p>There<a id="id187" class="indexterm"/> is yet another way to sense the<a id="id188" class="indexterm"/> presence of objects: using a sonar sensor. But before you add this capability to your system, here's a little tutorial on sonar sensors. This type of sensor uses ultrasonic sound to calculate the distance from an object. The sound wave travels out from the sensor, as illustrated in the following figure:</p><div class="mediaobject"><img src="graphics/B04591_04_19.jpg" alt="Connecting Raspberry Pi to a USB sonar sensor"/></div><p>The device sends out a sound wave 10 times a second. If an object is in the path of these waves, then the waves reflect off the object, sending waves that return to the sensor, as shown in the following figure:</p><div class="mediaobject"><img src="graphics/B04591_04_20.jpg" alt="Connecting Raspberry Pi to a USB sonar sensor"/></div><p>The<a id="id189" class="indexterm"/> sensor then measures any return. It uses<a id="id190" class="indexterm"/> the time difference between when the sound wave was sent out and when it returned to measure the distance from the object.</p><div class="note" title="Note" style=""><div class="inner"><h3 class="title"><a id="note09"/>Note</h3><p>Sonar sensors<a id="id191" class="indexterm"/> are also quite accurate, normally with low percentage errors, and are not affected by the lighting or color in the environment.</p></div></div><p>There are several choices if you want to use a sonar sensor to sense the distance. The first is to use a sonar sensor that connects to the USB port. The following is an image of a USB sonar sensor:</p><div class="mediaobject"><img src="graphics/B04591_04_21.jpg" alt="Connecting Raspberry Pi to a USB sonar sensor"/></div><p>This is the <span class="strong"><strong>USB-ProxSonar-EZ</strong></span> sensor, and can be purchased directly from MaxBotix or on<a id="id192" class="indexterm"/> Amazon. There are several models, each with a different distance specification; however, they all work in the same way.</p><p>You<a id="id193" class="indexterm"/> can also choose a sonar sensor<a id="id194" class="indexterm"/> that connects to the GPIO of the Raspberry Pi. Here is a picture of this sort of inexpensive sonar sensor:</p><div class="mediaobject"><img src="graphics/B04591_04_22.jpg" alt="Connecting Raspberry Pi to a USB sonar sensor"/></div><p>This sensor is less expensive and easy to use; it takes a bit of processing power to coordinate the efforts of timing the send and receive signals, but the Raspberry Pi B 2 has the <a id="id195" class="indexterm"/>processing power needed. Here are the steps to set up this sonar sensor to sense the distance:</p><div class="orderedlist"><ol class="orderedlist arabic"><li class="listitem">The first step is to understand the GPIO pins of the Raspberry Pi B 2. Here is a diagram of the layout of the pins:<div class="mediaobject"><img src="graphics/B04591_04_23.jpg" alt="Connecting Raspberry Pi to a USB sonar sensor"/></div><p>In <a id="id196" class="indexterm"/>this case, you'll need to connect to the 5 volt connection of the Raspberry Pi B2, which is pin 2. You'll also need to connect to the GND, which is pin 6. You'll use pin 16 as an output trigger pin and pin 18 (GPIO24) as an input to time the echo from the sonar sensor.</p></li><li class="listitem">Now<a id="id197" class="indexterm"/> that <a id="id198" class="indexterm"/>you know the pins you'll connect to, you can connect the sonar sensor. There is a problem, as you can't connect the 5 volt return from the sonar sensor directly to the Raspberry Pi GPIO pins; they want 3.3 volts. You'll need to build a voltage divider that will reduce the 5 volts to 3.3 volts. This can be done with two resistors, which are connected as shown in this diagram:<div class="mediaobject"><img src="graphics/B04591_04_24.jpg" alt="Connecting Raspberry Pi to a USB sonar sensor"/></div><p>If <a id="id199" class="indexterm"/>you'd like more information on<a id="id200" class="indexterm"/> how the voltage divider works in this configuration, refer to <a class="ulink" href="http://www.modmypi.com/blog/hc-sr04-ultrasonic-range-sensor-on-the-raspberry-pi">http://www.modmypi.com/blog/hc-sr04-ultrasonic-range-sensor-on-the-raspberry-pi</a>. The combination of these two resistors will <a id="id201" class="indexterm"/>reduce the voltage to the desired levels. You may want to put all of this is in a small breadboard, as shown here:</p><div class="mediaobject"><img src="graphics/B04591_04_25.jpg" alt="Connecting Raspberry Pi to a USB sonar sensor"/></div><p>Finally, connect it to the Raspberry Pi, like this:</p><div class="mediaobject"><img src="graphics/B04591_04_26.jpg" alt="Connecting Raspberry Pi to a USB sonar sensor"/></div></li><li class="listitem">Now<a id="id202" class="indexterm"/> that the device is<a id="id203" class="indexterm"/> connected, you'll need a bit of code to read in the value, make sure it is settled (a stable measurement), and then convert it to distance. Here is the Python code for this program:<div class="mediaobject"><img src="graphics/B04591_04_27.jpg" alt="Connecting Raspberry Pi to a USB sonar sensor"/></div><p>Now, you should be able to <a id="id204" class="indexterm"/>run the program<a id="id205" class="indexterm"/> and see a result, like this:</p><div class="mediaobject"><img src="graphics/B04591_04_28.jpg" alt="Connecting Raspberry Pi to a USB sonar sensor"/></div><p>Now that you have your sensors up and working, you can avoid or find<a id="id206" class="indexterm"/> objects with your<a id="id207" class="indexterm"/> biped.</p></li></ol></div></div>
<div class="section" title="Summary"><div class="titlepage"><div><div><h1 class="title"><a id="ch04lvl1sec27"/>Summary</h1></div></div></div><p>Congratulations! You can now detect and avoid walls and other barriers to your robot. You can also use these sensors to detect objects that you might want to find. In the next chapter, you'll learn how to perform path planning to move your robot from point A to point B and even give your robot intelligence as to what to do if it encounters a barrier in its path.</p></div></body></html>