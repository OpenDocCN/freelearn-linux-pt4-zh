<html><head></head><body><div class="chapter" title="Chapter&#xA0;7.&#xA0;Maintenance of VCM"><div class="titlepage"><div><div><h1 class="title"><a id="ch07"/>Chapter 7. Maintenance of VCM</h1></div></div></div><p>In this chapter, we will cover the following recipes:</p><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc">Upgrading VCM from a previous version - in place</li><li class="listitem" style="list-style-type: disc">Upgrading VCM from a previous version - parallel</li><li class="listitem" style="list-style-type: disc">Migrating VCM from another domain</li><li class="listitem" style="list-style-type: disc">Applying a new license key</li><li class="listitem" style="list-style-type: disc">Upgrading VCM agents</li><li class="listitem" style="list-style-type: disc">Changing service account passwords</li><li class="listitem" style="list-style-type: disc">Managing users</li><li class="listitem" style="list-style-type: disc">Decommissioning VMs - manual VM purge</li><li class="listitem" style="list-style-type: disc">Decommissioning VMs - scheduled VM record purge</li></ul></div><div class="section" title="Introduction"><div class="titlepage"><div><div><h1 class="title"><a id="ch07lvl1sec69"/>Introduction</h1></div></div></div><p>After installation and configuration, another extremely important aspect we need to look at is the lifecycle management of VCM. VMware will keep on improving VCM, and to have those improvements implemented, we also need to invest our time to maintain the infrastructure we have built.</p><p>This is not just limited to VMware updates and upgrades but also to our own infrastructure changes; for example, relocating a datacenter might need us to change IP or we might have decided to change our Active Directory domain and we need to migrate our management servers to the newly created domain. All this falls under maintenance, and we will have a look what we can do for VCM.</p><p>Apart from this, we are managing our infrastructure, and it has its own lifecycle to manage; for example, once the server is decommissioned, we need to remove it from VCM, and after upgrading VCM, we need to upgrade VCM agents on the managed servers.</p><p>To manage VCM, we will have a support team; everyone does not need to have admin access on the server. In order to adhere to the security principle of least privilege, we need to create some groups and give them proper access to VCM.</p><p>We will have a look at those points in this chapter to make sure we have a maintained VCM infrastructure so that it can manage our infrastructure better.</p></div></div>
<div class="section" title="Upgrading VCM from a previous version &#x2013; in place"><div class="titlepage"><div><div><h1 class="title"><a id="ch07lvl1sec70"/>Upgrading VCM from a previous version – in place</h1></div></div></div><p>In this recipe, we will upgrade VCM in place, meaning we will do a regular upgrade without changing the OS underneath. If you want to change the OS underneath, have a look at the following recipe.</p><div class="section" title="Getting ready"><div class="titlepage"><div><div><h2 class="title"><a id="ch07lvl2sec194"/>Getting ready</h2></div></div></div><p>To start with this activity, you must have all the user accounts in place, and they must have permissions as described in the <span class="emphasis"><em>Service accounts</em></span> subsection under the <span class="emphasis"><em>Understanding the requirements of VCM</em></span> recipe in <a class="link" href="ch01.html" title="Chapter 1. Installing VCM">Chapter 1</a>, <span class="emphasis"><em>Installing VCM</em></span>. You must have a user apart from the service account, which may be your own account, with admin privilege on the VCM Collector server.</p><p>If you are using a physical server, then take a backup of the server with the tool you are using in your infrastructure; otherwise, if that Collector server is a virtual machine, take a snapshot of the VM.</p><p>Take a backup of the databases (<code class="literal">Excel VCM_Raw</code>) so that if something goes wrong, you can get back to where you were before the upgrade. If you don't know how, you can get help from your SQL admin to take a backup of the databases.</p><p>You must have access to <a class="ulink" href="https://my.vmware.com">https://my.vmware.com</a> to download the latest VCM installation ISO files.</p></div><div class="section" title="How to do it..."><div class="titlepage"><div><div><h2 class="title"><a id="ch07lvl2sec195"/>How to do it...</h2></div></div></div><p>In the following example, we will perform an in-place upgrade of a two-tier VCM deployment:</p><div class="note" style="" title="Note"><div class="inner"><h3 class="title"><a id="note51"/>Note</h3><p>Note that you should not use a VCM service account to upgrade VCM. Use any domain account that is an admin on the VCM server. You can use your own account to log in to the VCM Collector server if you have those privileges; if not, assign them to your account for the time being.</p></div></div><div class="orderedlist"><ol class="orderedlist arabic"><li class="listitem">Mount the ISO downloaded from the Internet on your VCM Collector VM.</li><li class="listitem">Log in to the Collector OS with a [user right/role].</li><li class="listitem">Open an Explorer window and navigate to the CD-ROM drive just mounted.</li><li class="listitem">Right-click on <code class="literal">setup.exe</code> and select <span class="strong"><strong>Run as Administrator</strong></span>.</li><li class="listitem">Select <span class="strong"><strong>Upgrade </strong></span>and click on <span class="strong"><strong>Next</strong></span>:<div class="mediaobject"><img alt="How to do it..." src="graphics/image_07_001.jpg"/></div></li><li class="listitem">Accept the license agreement, and click on <span class="strong"><strong>Next</strong></span>.</li><li class="listitem">Confirm the components to be upgraded, and click on <span class="strong"><strong>Next</strong></span><span class="strong"><strong>:</strong></span><div class="mediaobject"><img alt="How to do it..." src="graphics/image_07_002.jpg"/></div></li><li class="listitem">Wait until the checks are completed and click on <span class="strong"><strong>Next </strong></span>once they are successful; if not, check what needs a fix, resolve any issues, and then perform a recheck.<div class="note" style="" title="Note"><div class="inner"><h3 class="title"><a id="note52"/>Note</h3><p>Note that while performing the upgrade, the details asked in the wizard should be automatically filled in. If not, fill in the appropriate details; if you want to make any changes, then this is the time to make those changes, such as changing service accounts.</p></div></div></li><li class="listitem">If you want to change the Tomcat service account, provide the details; otherwise, go with the default value and click on <span class="strong"><strong>Next</strong></span>.</li><li class="listitem">Enter the SQL reporting service details and credentials here, and click on <span class="strong"><strong>Validate</strong></span>; when validated, click on <span class="strong"><strong>Next</strong></span>:<div class="mediaobject"><img alt="How to do it..." src="graphics/image_07_003.jpg"/></div></li><li class="listitem">Enter the Collector service account (if required) and click on <span class="strong"><strong>Next</strong></span>.</li><li class="listitem">If not populated automatically, enter the default network authority account and click on <span class="strong"><strong>Next</strong></span>.</li><li class="listitem">The certificates should be selected automatically already. If not, select your certificates by clicking on <span class="strong"><strong>Select</strong></span>, and once done, click on <span class="strong"><strong>Next</strong></span>.</li><li class="listitem">If not populated automatically, enter your remote virtual directory details and click on <span class="strong"><strong>Next</strong></span>.</li><li class="listitem">If not populated automatically, enter your virtualization client plugin details and click on <span class="strong"><strong>Next</strong></span>.</li><li class="listitem">If not populated automatically, enter the installation directory, and click on <span class="strong"><strong>Next</strong></span>.</li><li class="listitem">There is no option for you to change this path for the local packages cache location; click on <span class="strong"><strong>Next</strong></span>.</li><li class="listitem">The option for the path for the software repository is preselected and can't be changed; click on <span class="strong"><strong>Next</strong></span>.</li><li class="listitem">Enter the Package Studio folder location and click on <span class="strong"><strong>Next</strong></span>.</li><li class="listitem">Confirm the details and click on <span class="strong"><strong>Upgrade</strong></span>:<div class="mediaobject"><img alt="How to do it..." src="graphics/image_07_004.jpg"/></div></li><li class="listitem">The process of upgrading all components can take half an hour or more.</li><li class="listitem">Check whether the upgrade was successful by checking the version of VCM.</li><li class="listitem">Once the installation is complete, log in to VCM and check the version; it should be <span class="strong"><strong>5.8.2.160</strong></span>, as in the following screenshot, or the version you downloaded from <a class="ulink" href="http://www.vmware.com/">http://www.vmware.com/</a>:<div class="mediaobject"><img alt="How to do it..." src="graphics/image_07_005.jpg"/></div></li></ol></div></div><div class="section" title="How it works..."><div class="titlepage"><div><div><h2 class="title"><a id="ch07lvl2sec196"/>How it works...</h2></div></div></div><p>We installed the latest version of VCM on the same server, using the old data collected for our infrastructure.</p><p>Here are the upgrade options to upgrade the version:</p><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc">Upgrade directly from VCM 5.6 or later by running VCM 5.8.x Installation Manager</li><li class="listitem" style="list-style-type: disc">Upgrade VCM versions earlier than 5.6 to VCM 5.6 and then upgrade from VCM 5.6 to VCM 5.8.x</li></ul></div><p>Earlier versions include VMware VCM 5.5.x, 5.4, 5.3, 5.2.1, EMC Ionix SCM 5.0 or later, or Configuresoft ECM 4.11.1 or later.</p><div class="section" title="Aftercare"><div class="titlepage"><div><div><h3 class="title"><a id="ch07lvl3sec63"/>Aftercare</h3></div></div></div><p>After upgrading VCM, we need to upgrade the agents to the latest versions; have a look at the <span class="emphasis"><em>Upgrading VCM agents</em></span> recipes in this chapter to do that:</p><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc">There is a small bug with the agent upgrade to version 5.8.1 (resolved in 5.8.2) from an older version; have a look at the <span class="emphasis"><em>Troubleshooting agent upgrade</em></span> issues recipe and the one after that in <a class="link" href="ch09.html" title="Chapter 9. Troubleshooting VCM">Chapter 9</a>, <span class="emphasis"><em>Troubleshooting VCM</em></span> for how to solve it</li><li class="listitem" style="list-style-type: disc">Once the upgrade is complete, roam through the VCM console to have a look at whether all the servers that were managed earlier, such as vCenter, vCloud, and VCNS, are visible</li></ul></div></div></div><div class="section" title="There's more..."><div class="titlepage"><div><div><h2 class="title"><a id="ch07lvl2sec197"/>There's more...</h2></div></div></div><p>If you have designated a managing agent in your infrastructure, then after an upgrade, there is a chance that the trust between the managing agent and the VCM Collector will be broken. To fix this issue, follow these steps:</p><p>Follow the steps of the <span class="emphasis"><em>Issue 1 - mutual authentication failure</em></span> subsection of the <span class="emphasis"><em>Troubleshooting agent communication issues</em></span> recipe in <a class="link" href="ch09.html" title="Chapter 9. Troubleshooting VCM">Chapter 9</a>, <span class="emphasis"><em>Troubleshooting VCM</em></span>.</p><p>To re-enable the server as a managing agent, we need VCM Collector to trust the server again; for this, log in to VCM console and follow these steps:</p><div class="orderedlist"><ol class="orderedlist arabic"><li class="listitem">Go to <span class="strong"><strong>Administration</strong></span>| <span class="strong"><strong>Certificate</strong></span> and select the managing agent server. Click on <span class="strong"><strong>Change Trust Status</strong></span> at the top.</li><li class="listitem">In the wizard, select the managing agent machine and tick the <span class="strong"><strong>Check to trust and uncheck to untrust the selected machine</strong></span> option.</li></ol></div><p>You should see a handshake sign in front of managing agent server.</p><p>Now, we need to re-enable the old managing agent to do its job again as was done in the <span class="emphasis"><em>Configuring a managing agent machine for virtual environment management</em></span> recipe in <a class="link" href="ch02.html" title="Chapter 2. Configuring VCM to Manage Your Infrastructure">Chapter 2</a>, <span class="emphasis"><em>Configuring  VCM to Manage Your Infrastructure</em></span>.</p></div></div>
<div class="section" title="Upgrading VCM from a previous version &#x2013; parallel"><div class="titlepage"><div><div><h1 class="title"><a id="ch07lvl1sec71"/>Upgrading VCM from a previous version – parallel</h1></div></div></div><p>If you want to upgrade not only VCM but also the OS underneath it, this is the recipe to look at. VCM 5.8.2 now supports Windows Server 2012 R2, and it's a good chance to perform an upgrade.</p><div class="section" title="Getting ready"><div class="titlepage"><div><div><h2 class="title"><a id="ch07lvl2sec198"/>Getting ready</h2></div></div></div><p>To start with this activity, you must have all the user accounts in place and they must have permissions as described in the first chapter. You must have a user apart from the service account, which may be your own account, with admin privileges on the VCM Collector server to perform the installation.</p><p>If you are using a physical server, then take a backup of the server with the tool you are using in your infrastructure; if that Collector server is a virtual machine, take a snapshot of the VM.</p><p>Take a backup of the databases so that if something goes wrong, you can get back to where you were before the upgrade. If you are not aware, you can get help from your SQL admin to take a backup of the databases.</p><p>You must have access to <a class="ulink" href="https://my.vmware.com">https://my.vmware.com</a> to download the latest VCM installation ISO files.</p><p>Deploy another server with the latest supported OS available with you, that is, Windows Server 2008 R2, Windows Server 2012, or Windows Server 2012 R2. Check the VCM requirements in the <span class="emphasis"><em>Software requirements</em></span> subsection under the <span class="emphasis"><em>Understanding the requirements of VCM</em></span> recipe in <a class="link" href="ch01.html" title="Chapter 1. Installing VCM">Chapter 1</a>, <span class="emphasis"><em>Installing VCM</em></span>.</p></div><div class="section" title="How to do it..."><div class="titlepage"><div><div><h2 class="title"><a id="ch07lvl2sec199"/>How to do it...</h2></div></div></div><p>In the following example, we will perform a parallel upgrade of a two-tier VCM deployment.</p><p>This recipe splits into multiple sections.</p><div class="section" title="Migrating the VCM certificate"><div class="titlepage"><div><div><h3 class="title"><a id="ch07lvl3sec64"/>Migrating the VCM certificate</h3></div></div></div><p>First, we will export the VCM Enterprise certificate and then we will start installing VCM.</p><p>So, let's log in to the old VCM server and follow these steps to export the certificate:</p><div class="orderedlist"><ol class="orderedlist arabic"><li class="listitem">Launch <code class="literal">mmc.exe</code> and add a snap-in for <span class="strong"><strong>Certificates (Local Computer)</strong></span>.</li><li class="listitem">Go to <span class="strong"><strong>Trusted Root Certification Authority</strong></span> | <span class="strong"><strong>Certificates</strong></span>; select <span class="strong"><strong>VMWare VCM Enterprise Certificate...</strong></span> and right-click on the certificate under <span class="strong"><strong>All Tasks</strong></span> | <span class="strong"><strong>Export...</strong></span>:<div class="mediaobject"><img alt="Migrating the VCM certificate" src="graphics/image_07_006.jpg"/></div></li><li class="listitem">This will launch the wizard; export the private key.</li><li class="listitem">For the file format, select <span class="strong"><strong>Personal Information Exchange</strong></span> and do the following:<div class="orderedlist"><ol class="orderedlist arabic"><li class="listitem">Include all certificates in the certification path if possible.</li><li class="listitem">Export all extended properties.</li></ol></div><p>
</p></li><li class="listitem">Type and confirm the password; copy it to a safe place–we will need it later.</li><li class="listitem">Provide a name and path to save the file to, and you are done with the certificate export.</li><li class="listitem">Follow the same process for the Collector certificate, under <span class="strong"><strong>Personal</strong></span> | <span class="strong"><strong>Certificate</strong></span>.</li><li class="listitem">Copy the certificates to the new VCM server and then import them to the respective folders from where they were exported. Use the same password given earlier while importing both the certificates.</li><li class="listitem"><span class="emphasis"><em>Shut down</em></span> the old VCM server after <span class="emphasis"><em>disabling and stopping VCM services </em></span>on the server.</li></ol></div></div><div class="section" title="Migrating VCM to the new server"><div class="titlepage"><div><div><h3 class="title"><a id="ch07lvl3sec65"/>Migrating VCM to the new server</h3></div></div></div><p>Once the certificate is available, we can start deploying a new VCM instance by following these steps:</p><div class="orderedlist"><ol class="orderedlist arabic"><li class="listitem">Log in to the newly created VCM server and mount the VCM installer ISO downloaded from <a class="ulink" href="https://my.vmware.com/">https://my.vmware.com/</a>.</li><li class="listitem">Navigate to the mounted ISO, right-click on <code class="literal">setup.exe</code>, and select <span class="strong"><strong>Run as Administrator</strong></span>.</li><li class="listitem">Choose <span class="strong"><strong>Advanced Installation</strong></span>.</li><li class="listitem">Click on <span class="strong"><strong>Next </strong></span>for the introduction page.</li><li class="listitem">Click on <span class="strong"><strong>Next </strong></span>for the patent information page.</li><li class="listitem">Read and accept the license agreement and select <span class="strong"><strong>I am an authorized agent and/or representative of the customer/end user</strong></span> and <span class="strong"><strong>I have read the terms and conditions stated above</strong></span>.</li><li class="listitem">Under <span class="strong"><strong>Select Installation Type</strong></span>, select the following:<div class="itemizedlist"><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc"><span class="strong"><strong>VMware vRealize Configuration Manager</strong></span><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc"><span class="strong"><strong>VCM Web Console</strong></span></li><li class="listitem" style="list-style-type: disc"><span class="strong"><strong>VCM Collector Components</strong></span></li></ul></div><p>
</p></li><li class="listitem" style="list-style-type: disc"><span class="strong"><strong>Tools</strong></span><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc"><span class="strong"><strong>Import Export Utility</strong></span></li><li class="listitem" style="list-style-type: disc"><span class="strong"><strong>Foundation Checker</strong></span></li><li class="listitem" style="list-style-type: disc"><span class="strong"><strong>VMware VCM package manager for Windows</strong></span></li></ul></div><p>
</p></li><li class="listitem" style="list-style-type: disc"><span class="strong"><strong>VMware VCM package Studio</strong></span></li></ul></div></li><li class="listitem">The installer will perform a prerequisite check and present the results on successful checks. Click on <span class="strong"><strong>Next</strong></span>; if there are failures, click on <span class="strong"><strong>View Results</strong></span>, remedy any errors and warnings, and perform a recheck.<div class="note" style="" title="Note"><div class="inner"><h3 class="title"><a id="tip53"/>Tip</h3><p>Do not proceed further until there are zero errors.</p></div></div></li><li class="listitem">On the next page, enter the serial key.</li><li class="listitem">On the <span class="strong"><strong>Configure Components</strong></span> page, provide the hostname of the SQL server that was used with the earlier VCM instance and VCM as the database name (if you have named the VCM database with a different name, then provide that name) and click on <span class="strong"><strong>Validate</strong></span>:<div class="mediaobject"><img alt="Migrating VCM to the new server" src="graphics/image_07_007.jpg"/></div></li><li class="listitem">On the next page, provide the Tomcat service account and its password.</li><li class="listitem">On the next page, provide the details in <span class="strong"><strong>WebService URL</strong></span> (this is the path to the SQL server–the same as the old VCM deployment). Provide the path to install the web console. Check out the following screenshot for more details:<div class="mediaobject"><img alt="Migrating VCM to the new server" src="graphics/image_07_008.jpg"/></div></li><li class="listitem">Provide a URL to the application; the default is fine.</li><li class="listitem">We can provide an SMTP address; the default is the Collector server's. If you don't know it right now, this can be configured in the VCM console later.</li><li class="listitem">Provide the path for installing the Collector component and accept the SSL3 warning.</li><li class="listitem">Provide the path to store staging data; this is the path where data is temporarily stored before adding it to the database.</li><li class="listitem">Provide the details of the Collector service account; this account will be given rights to log in as a service; accept the prompt.</li><li class="listitem">Provide details of the network authority account; we can add as many accounts as we want later. We need at least one for the time being. More details about this account can be found under the <span class="emphasis"><em>Service accounts</em></span> section in <a class="link" href="ch01.html" title="Chapter 1. Installing VCM">Chapter 1</a>, <span class="emphasis"><em>Installing VCM</em></span>.</li><li class="listitem">The next page is for the certificate; here, we need to reuse the certificate exported from the old VCM server.</li><li class="listitem">Click on <span class="strong"><strong>Select </strong></span>and provide the Collector and Enterprise certificates:<div class="mediaobject"><img alt="Migrating VCM to the new server" src="graphics/image_07_009.jpg"/></div></li><li class="listitem">Provide details about Virtual Directory and the credentials to access it.</li><li class="listitem">Provide the credentials for the Virtualization Client plugin.</li><li class="listitem">On the next page, provide the path to install the package manager components to.</li><li class="listitem">On the next page, provide the path to the local package cache.</li><li class="listitem">On the next page, provide the path for the software repository and local cache.</li><li class="listitem">Provide a Virtual Directory name.</li><li class="listitem">Provide the path for the Package Studio components.</li><li class="listitem">Finally, you will reach the summary page. Check the options and click on <span class="strong"><strong>Install</strong></span>:<div class="mediaobject"><img alt="Migrating VCM to the new server" src="graphics/image_07_010.jpg"/></div></li><li class="listitem">Once VCM is installed successfully, log in to the console with the account you used to install VCM. Check whether all the managed machines are available and all the virtual infrastructure elements you configured are present.</li><li class="listitem">Also check the version–it should be <span class="strong"><strong>5.8.2.160</strong></span>, as in the following screenshot:<div class="mediaobject"><img alt="Migrating VCM to the new server" src="graphics/image_07_011.jpg"/></div></li><li class="listitem">Perform a collection of any managed VMs available on the console.</li></ol></div></div></div><div class="section" title="How it works..."><div class="titlepage"><div><div><h2 class="title"><a id="ch07lvl2sec200"/>How it works...</h2></div></div></div><p>We went to the latest Windows OS and then migrated the VCM installation to give us the edge, that is, if you are on an older version of the OS that is not supported by Microsoft or not supported as a <span class="emphasis"><em>base</em></span> OS for VCM, then you can migrate retaining all the old data. You can perform a hardware refresh if your old server was on a physical server.</p><p>When we perform a parallel upgrade, we migrate from the old operating system but still using the old database. As we keep the old database, all the data collected is retained after the upgrade. We have all the agents and all the already configured vCenter servers. This helps in keeping our old configuration with the latest build of VCM and the latest supported base OS.</p><p>Selecting the right certificate is the key to success here. As you know, the certificate is used by agents when we install them. If we regenerate or use the wrong certificate, the agent-server communication will break and we will be forced to install a new agent with the latest certificate from the server.</p><div class="section" title="Aftercare"><div class="titlepage"><div><div><h3 class="title"><a id="ch07lvl3sec66"/>Aftercare</h3></div></div></div><p>Refer to the corresponding section of the previous recipe for aftercare instructions.</p></div></div><div class="section" title="There's more..."><div class="titlepage"><div><div><h2 class="title"><a id="ch07lvl2sec201"/>There's more...</h2></div></div></div><p>Refer to the corresponding section of the previous recipe. The same steps need to be followed.</p></div></div>
<div class="section" title="Migrating VCM from another domain"><div class="titlepage"><div><div><h1 class="title"><a id="ch07lvl1sec72"/>Migrating VCM from another domain</h1></div></div></div><p>There are scenarios in which we need to migrate from one domain to another and can't afford to lose all the historical data of our managed machines. In this recipe, we will look at how to migrate the VCM server from an old domain to a new domain.</p><div class="section" title="Getting ready"><div class="titlepage"><div><div><h2 class="title"><a id="ch07lvl2sec202"/>Getting ready</h2></div></div></div><p>Make sure that the network and DNS (forward and reverse) is correct for the VCM Collector server. Add the VCM Collector to the new domain and create or identify the domain account that you want to use, as described in <span class="emphasis"><em>Service accounts</em></span> subsection under the <span class="emphasis"><em>Understanding the requirements of VCM</em></span> recipe in <a class="link" href="ch01.html" title="Chapter 1. Installing VCM">Chapter 1</a>, <span class="emphasis"><em>Installing VCM</em></span>.</p></div><div class="section" title="How to do it..."><div class="titlepage"><div><div><h2 class="title"><a id="ch07lvl2sec203"/>How to do it...</h2></div></div></div><p>To change VCM service accounts to run under a different domain account, follow these steps:</p><div class="orderedlist"><ol class="orderedlist arabic"><li class="listitem">On the VCM database server, run the following SQL update queries against the core VCM database. Make the appropriate name substitutions:<pre class="programlisting">       DECLARE     @collector_service_account NVARCHAR(128) &#13;
       SET @collector_service_account = N'domain-name\account-name'      &#13;
 &#13;
       DECLARE     @collector_config_id INT &#13;
       SELECT @collector_config_id = c.configuration_id       &#13;
             FROM dbo.ecm_sysdat_configuration_values c       &#13;
             WHERE c.configuration_name = 'collector_service_account'      &#13;
 &#13;
       EXEC dbo.ecm_sp_configuration_values_update       &#13;
             @configuration_id = @collector_config_id,       &#13;
             @configuration_value = @collector_service_account      &#13;
    &#13;
       EXEC dbo.ecm_sp_security_collector_service_account_setup       &#13;
             @collector_service_account = @collector_service_account &#13;
</pre></li><li class="listitem">Select and stop the following services:<div class="itemizedlist"><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc"><span class="strong"><strong>VCM Collector</strong></span></li><li class="listitem" style="list-style-type: disc"><span class="strong"><strong>VCM Database Service</strong></span></li><li class="listitem" style="list-style-type: disc"><span class="strong"><strong>VCM Patch Management</strong></span></li></ul></div></li><li class="listitem">Right-click on each service, select <span class="strong"><strong>Properties</strong></span>, and select the <span class="strong"><strong>Log On</strong></span> tab.</li><li class="listitem">Change the account credentials to the new account, and click on <span class="strong"><strong>OK</strong></span>.</li><li class="listitem">Go to <span class="strong"><strong>Start </strong></span>| <span class="strong"><strong>Administrative Tools</strong></span> | <span class="strong"><strong>Component Services</strong></span>.</li><li class="listitem">On the left, go to <span class="strong"><strong>Console Root</strong></span> | <span class="strong"><strong>Component Services</strong></span> | <span class="strong"><strong>Computers </strong></span>| <span class="strong"><strong>My Computer</strong></span> | <span class="strong"><strong>DCOM Config</strong></span> | <span class="strong"><strong>LicenseDcom</strong></span>.</li><li class="listitem">Right-click, select <span class="strong"><strong>Properties</strong></span>, and select the <span class="strong"><strong>Identity </strong></span>tab.</li><li class="listitem">Select <span class="strong"><strong>This </strong></span>user, enter the new domain account credentials, and click on <span class="strong"><strong>OK</strong></span>.</li><li class="listitem">From <span class="strong"><strong>Start </strong></span>| <span class="strong"><strong>Administrative Tools</strong></span> | <span class="strong"><strong>Services</strong></span>, restart the services you stopped.</li><li class="listitem">Go to <span class="strong"><strong>Start </strong></span>| <span class="strong"><strong>Administrative Tools </strong></span>| <span class="strong"><strong>Server Manager</strong></span>.</li><li class="listitem">On the left, navigate to <span class="strong"><strong>Server Manager </strong></span>(hostname) | <span class="strong"><strong>Configuration </strong></span>| <span class="strong"><strong>Local Users and Groups</strong></span>.</li><li class="listitem">Double-click on <span class="strong"><strong>Groups</strong></span>.</li><li class="listitem">Select <code class="literal">VCM_LDP_GROUP</code>, right-click, and select <span class="strong"><strong>Properties</strong></span>.</li><li class="listitem">Remove the old account and add the new one.</li><li class="listitem">Navigate to <span class="strong"><strong>Server Manager</strong></span> (hostname) | <span class="strong"><strong>Configuration </strong></span>| <span class="strong"><strong>Services</strong></span>, double-click on <span class="strong"><strong>Groups</strong></span>, select <code class="literal">CSI_COMM_PROXY_SVC</code>, and repeat the process for replacing the account.<div class="note" style="" title="Note"><div class="inner"><h3 class="title"><a id="note54"/>Note</h3><p>Note that if you run the <span class="strong"><strong>Repair </strong></span>option of the VCM installer, account changes revert to what you specified during installation.</p><p>
</p><p>Note that if you run the VCM installer to upgrade to a newer version of VCM, account changes default to what you specified during the older installation. Enter the account changes that you want during the upgrade process.</p></div></div></li><li class="listitem">Add the new domain to the network authority in VCM.</li><li class="listitem">Add any new users required for the new domain.</li></ol></div></div><div class="section" title="How it works..."><div class="titlepage"><div><div><h2 class="title"><a id="ch07lvl2sec204"/>How it works...</h2></div></div></div><p>VCM runs its services under accounts that you specify during installation. After installing VCM, the conditions at your site might require that you change from running under the initial domain account to a different domain account.</p><p>This procedure also applies when you need to change from running under a built-in Windows account to a domain account. To change from domain accounts to built-in accounts, refer to the next recipe, where we provide new credentials to run services in the new domain and retain historical data in VCM.</p></div></div>
<div class="section" title="Applying a new license key"><div class="titlepage"><div><div><h1 class="title"><a id="ch07lvl1sec73"/>Applying a new license key</h1></div></div></div><p>You might have had a temporary license key when you installed VCM or the infrastructure might have grown more than you expected and you now need to provide new licenses to manage the infrastructure. This is where you need to provide new keys, and entering a new serial key is not a straightforward console option; there is a command-line utility called <span class="strong"><strong>jlicense.cmd</strong></span> available to do this.</p><div class="section" title="Getting ready"><div class="titlepage"><div><div><h2 class="title"><a id="ch07lvl2sec205"/>Getting ready</h2></div></div></div><p>Get the new key to be used. You must have VCM admin access on the VCM console.</p></div><div class="section" title="How to do it..."><div class="titlepage"><div><div><h2 class="title"><a id="ch07lvl2sec206"/>How to do it...</h2></div></div></div><p>Log in to the VCM server with VCM admin privileges, and follow these steps:</p><div class="orderedlist"><ol class="orderedlist arabic"><li class="listitem">Launch CMD with administrative privileges and go to <code class="literal">X:\Program Files (x86)\VMware\VCM\Tools</code> (<span class="emphasis"><em>X</em></span> is the drive where VCM is installed).</li><li class="listitem">Run <code class="literal">jlicense.cmd -k xxxxx-xxxxx-xxxxx-xxxxx-xxxxx</code> (this is the new key you want to add to VCM), as shown in the following screenshot:</li></ol></div><div class="mediaobject"><img alt="How to do it..." src="graphics/image_07_012.jpg"/></div></div><div class="section" title="How it works..."><div class="titlepage"><div><div><h2 class="title"><a id="ch07lvl2sec207"/>How it works...</h2></div></div></div><p>It will append to the already available capacity of VCM, that is, the number of machines we can manage and the expiration date of the key.</p><p>Using the<span class="strong"><strong> jlicense.cmd</strong></span> utility, you can:</p><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc">Update a single license key for servers</li><li class="listitem" style="list-style-type: disc">Update a single license key for workstations</li><li class="listitem" style="list-style-type: disc">Enter two keys for servers and workstations</li><li class="listitem" style="list-style-type: disc">Enter a single license key for servers or workstations or enter two license keys for both servers and workstations</li></ul></div><p>Here's how to use the JLicense tool:</p><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc">To display the JLicense help information, run this command: <code class="literal">jlicense -h</code></li><li class="listitem" style="list-style-type: disc">To evaluate the license key but not to install it, run this command:<pre class="programlisting">
<span class="strong"><strong>       jlicense -n -k xxxxx-xxxxx-xxxxx-xxxxx-xxxxx</strong></span>
</pre><p>Here, <code class="literal">xxxxx-xxxxx-xxxxx-xxxxx-xxxxx</code> is the license key</p></li><li class="listitem" style="list-style-type: disc">To change a license, run this command:<pre class="programlisting">
<span class="strong"><strong>       jlicense -k xxxxx-xxxxx-xxxxx-xxxxx-xxxxx</strong></span>
</pre><p>Here, <code class="literal">xxxxx-xxxxx-xxxxx-xxxxx-xxxxx</code> is the license key</p></li></ul></div></div></div>
<div class="section" title="Upgrading VCM agents"><div class="titlepage"><div><div><h1 class="title"><a id="ch07lvl1sec74"/>Upgrading VCM agents</h1></div></div></div><p>After an upgrade of the VCM server, you need to upgrade the VCM agent. This recipe deals with the Windows and Linux VCM agent upgrades from their previous versions.</p><div class="section" title="Getting ready"><div class="titlepage"><div><div><h2 class="title"><a id="ch07lvl2sec208"/>Getting ready</h2></div></div></div><p>You must have some old agents to be upgraded to the latest version and they should be communicating with VCM server.</p></div><div class="section" title="How to do it..."><div class="titlepage"><div><div><h2 class="title"><a id="ch07lvl2sec209"/>How to do it...</h2></div></div></div><p>There are two ways to upgrade the agent in the case of Windows. From the console, you can choose <span class="strong"><strong>Upgrade </strong></span>as an option, or you can choose Install and in the wizard choose<span class="strong"><strong> Remove Current Agent</strong></span> from the machine. Both the processes do the same thing–upgrading the agent to the latest build–but <span class="strong"><strong>Install with Remove Current</strong></span> version takes more time. Both the options retain all the old collected data.</p><p>We will use the <span class="strong"><strong>Upgrade </strong></span>method in this recipe.</p><div class="section" title="Windows"><div class="titlepage"><div><div><h3 class="title"><a id="ch07lvl3sec67"/>Windows</h3></div></div></div><p>This is the way to do it in Windows:</p><div class="orderedlist"><ol class="orderedlist arabic"><li class="listitem">Log in to VCM with administrative privileges.</li><li class="listitem">Navigate to <span class="strong"><strong>Administration </strong></span>| <span class="strong"><strong>Machines Manager</strong></span> | <span class="strong"><strong>Licensed Machines</strong></span> | <span class="strong"><strong>Licensed Windows Machines</strong></span>.</li><li class="listitem">Right-click on the machine and select <span class="strong"><strong>Upgrade Agent</strong></span>:<div class="mediaobject"><img alt="Windows" src="graphics/image_07_013.jpg"/></div></li><li class="listitem">On the <span class="strong"><strong>Machines </strong></span>page, select the Windows machines to upgrade and click on the arrow to move the machines to the selected pane. Click on <span class="strong"><strong>Next</strong></span>.</li><li class="listitem">On the installation options page, select or verify the option for the agent installation, and click on <span class="strong"><strong>Next</strong></span>.</li><li class="listitem">On the <span class="strong"><strong>Schedule </strong></span>page, schedule the operation and click on <span class="strong"><strong>Next</strong></span>.</li><li class="listitem">On the <span class="strong"><strong>Important </strong></span>page, verify the summary and click on <span class="strong"><strong>Finish</strong></span>.</li><li class="listitem">Click on the <span class="strong"><strong>Jobs </strong></span>button and see whether the job is completed successfully.</li><li class="listitem">Once the job is finished, check the console for the agent version. It should be the latest one, as in the following screenshot:<div class="mediaobject"><img alt="Windows" src="graphics/image_07_014.jpg"/></div></li></ol></div></div><div class="section" title="Linux"><div class="titlepage"><div><div><h3 class="title"><a id="ch07lvl3sec68"/>Linux</h3></div></div></div><p>Here's how to do it in Linux:</p><div class="orderedlist"><ol class="orderedlist arabic"><li class="listitem">Log in to VCM with administrative privileges.</li><li class="listitem">Click on <span class="strong"><strong>Console </strong></span>and go to <span class="strong"><strong>UNIX Remote Commands</strong></span> | <span class="strong"><strong>UNIX Agent Upgrade</strong></span>.</li><li class="listitem">In the <span class="strong"><strong>UNIX Agent Upgrade</strong></span> data grid, click on the appropriate remote upgrade package for the operating system and the version of the machines to upgrade:<div class="mediaobject"><img alt="Linux" src="graphics/image_07_015.jpg"/></div></li><li class="listitem">Click on <span class="strong"><strong>Run </strong></span>and follow the wizard to send the remote command and upgrade packages on the agents on the selected machines.<p>The agents will execute the package upgrade.</p></li><li class="listitem">Select the managed machine whose agent you want to upgrade.</li><li class="listitem">On the <span class="strong"><strong>Schedule</strong></span> page, select <span class="strong"><strong>Run Remote Command Now</strong></span> or schedule the operation for later and click on <span class="strong"><strong>Next</strong></span>.</li><li class="listitem">On the <span class="strong"><strong>Important</strong></span> page, verify the summary and click on <span class="strong"><strong>Finish</strong></span>.</li><li class="listitem">Verify that the job completes successfully.</li><li class="listitem">Perform a collection on the managed machine.</li><li class="listitem">Check the status of the agent on the console of VCM; it should look something like the following screenshot:<div class="mediaobject"><img alt="Linux" src="graphics/image_07_016.jpg"/></div></li></ol></div></div></div><div class="section" title="How it works..."><div class="titlepage"><div><div><h2 class="title"><a id="ch07lvl2sec210"/>How it works...</h2></div></div></div><p>We push the latest installer from the VCM console, it gets copied to the managed machine, starts upgrading the old agent files, and finally creates a VCM service on the managed machines and comes back with a status of success.</p><p>You can perform a collection after the agent is installed to be sure nothing was broken during the upgrade.</p><p>In case of a Linux upgrade, the process copies the latest agent installer from the VCM console along with the remote command to run on the Linux/Unix machine. Then, it executes the script to install the agent.</p></div><div class="section" title="There's more..."><div class="titlepage"><div><div><h2 class="title"><a id="ch07lvl2sec211"/>There's more...</h2></div></div></div><p>It is observed that after most of the agent or server upgrades, we need to perform the steps as described in the <span class="emphasis"><em>Issue 1 - mutual authentication failure</em></span> subsection of the <span class="emphasis"><em>Troubleshooting agent communication issues</em></span> recipe in <a class="link" href="ch09.html" title="Chapter 9. Troubleshooting VCM">Chapter 9</a>, <span class="emphasis"><em>Troubleshooting VCM</em></span>, as the trust between the upgraded agent and VCM Collector is broken.</p><p>You will see the error message described in the previous recipe, so simply follow the steps to resolve it.</p></div><div class="section" title="See also"><div class="titlepage"><div><div><h2 class="title"><a id="ch07lvl2sec212"/>See also</h2></div></div></div><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc">There is a small bug with the agent upgrade to version 5.8.1 (resolved in 5.8.2) from an older version; have a look at the <span class="emphasis"><em>Troubleshooting agent upgrade</em></span> issues recipe in <a class="link" href="ch09.html" title="Chapter 9. Troubleshooting VCM">Chapter 9</a>, <span class="emphasis"><em>Troubleshooting VCM</em></span> </li></ul></div></div></div>
<div class="section" title="Changing service account passwords"><div class="titlepage"><div><div><h1 class="title"><a id="ch07lvl1sec75"/>Changing service account passwords</h1></div></div></div><p>There are occasions when we need to change passwords for service accounts; in this recipe, we will learn how to.</p><div class="section" title="Getting ready"><div class="titlepage"><div><div><h2 class="title"><a id="ch07lvl2sec213"/>Getting ready</h2></div></div></div><p>You must have new passwords available to be replaced.</p></div><div class="section" title="How to do it..."><div class="titlepage"><div><div><h2 class="title"><a id="ch07lvl2sec214"/>How to do it...</h2></div></div></div><p>We'll look at the various service accounts used by VCM that we can change if we want to.</p><p>To update a password for VCM service accounts, follow these steps.</p><div class="section" title="Collector service accounts"><div class="titlepage"><div><div><h3 class="title"><a id="ch07lvl3sec69"/>Collector service accounts</h3></div></div></div><div class="orderedlist"><ol class="orderedlist arabic"><li class="listitem">On the Collector, go to <span class="strong"><strong>Start |</strong></span> <span class="strong"><strong>Administrative Tools</strong></span> | <span class="strong"><strong>Services</strong></span>.</li><li class="listitem">Select and stop the following services:<div class="itemizedlist"><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc"><span class="strong"><strong>VCM Collector</strong></span></li><li class="listitem" style="list-style-type: disc"><span class="strong"><strong>VCM Database Service</strong></span></li><li class="listitem" style="list-style-type: disc"><span class="strong"><strong>VCM Patch Management</strong></span></li></ul></div></li><li class="listitem">Right-click on each service, select <span class="strong"><strong>Properties</strong></span>, and select the <span class="strong"><strong>Log On</strong></span> tab.</li><li class="listitem">Update the account password and click on <span class="strong"><strong>OK</strong></span>.</li><li class="listitem">Go to <span class="strong"><strong>Start </strong></span>| <span class="strong"><strong>Administrative Tools</strong></span> | <span class="strong"><strong>Component Services</strong></span>.</li><li class="listitem">On the left, go to <span class="strong"><strong>Console Root</strong></span> | <span class="strong"><strong>Component Services</strong></span> | <span class="strong"><strong>Computers </strong></span>| <span class="strong"><strong>My Computer</strong></span> | <span class="strong"><strong>DCOM Config</strong></span> | <span class="strong"><strong>LicenseDcom</strong></span>.</li><li class="listitem">Right-click, select <span class="strong"><strong>Properties</strong></span>, and select the <span class="strong"><strong>Identity </strong></span>tab.</li><li class="listitem">Under <span class="strong"><strong>This </strong></span>user, update the password and click on <span class="strong"><strong>OK</strong></span>.</li></ol></div></div><div class="section" title="VCM remote service accounts"><div class="titlepage"><div><div><h3 class="title"><a id="ch07lvl3sec70"/>VCM remote service accounts</h3></div></div></div><p>We provided details about the VCM remote user when we performed the installation.</p><p>The VCM remote service account is used by the VCM remote client for anonymous access to the VCM remote virtual directory on the web server. Follow these steps:</p><div class="orderedlist"><ol class="orderedlist arabic"><li class="listitem">On the web server, go to <span class="strong"><strong>Start </strong></span>| <span class="strong"><strong>Administrative Tools</strong></span> |<span class="strong"><strong> IIS Manager</strong></span>.</li><li class="listitem">On the left, navigate to <span class="strong"><strong>{web-server-hostname}</strong></span> | <span class="strong"><strong>Sites </strong></span>| <span class="strong"><strong>Default Web Site</strong></span> | <span class="strong"><strong>ECMRemoteHTTP</strong></span>.</li><li class="listitem">Double-click on <span class="strong"><strong>Authentication</strong></span>.</li><li class="listitem">Select <span class="strong"><strong>Anonymous Authentication</strong></span>.</li><li class="listitem">In the <span class="strong"><strong>Actions </strong></span>pane on the right, select <span class="strong"><strong>Edit</strong></span>.</li><li class="listitem">Click on <span class="strong"><strong>Set</strong></span>.</li><li class="listitem">Enter the existing domain/username, then the new password, and click on <span class="strong"><strong>OK</strong></span>.</li><li class="listitem">Navigate to <span class="strong"><strong>{web-server-hostname}</strong></span> | <span class="strong"><strong>Sites </strong></span>| <span class="strong"><strong>Default Web Site</strong></span> | <span class="strong"><strong>VCMRemote</strong></span>, and repeat the steps to change the password.</li></ol></div><p><span class="strong"><strong>Network authority accounts</strong></span></p><p>Follow these steps for a network authority account:</p><div class="orderedlist"><ol class="orderedlist arabic"><li class="listitem">In VCM, click on <span class="strong"><strong>Administration </strong></span>and go to <span class="strong"><strong>Settings </strong></span>| <span class="strong"><strong>Network Authority</strong></span> | <span class="strong"><strong>Available Accounts.</strong></span></li><li class="listitem">Click on <span class="strong"><strong>Edit Password</strong></span>.</li></ol></div><p><span class="strong"><strong>SSRS</strong></span></p><p>For an SSRS account, run the <code class="literal">RSConfig</code> command to change the embedded account information.</p></div></div><div class="section" title="How it works..."><div class="titlepage"><div><div><h2 class="title"><a id="ch07lvl2sec215"/>How it works...</h2></div></div></div><p>VCM runs its services under accounts that you specify during installation. After installing VCM, conditions at your site might require that passwords on the accounts be changed, making it necessary to update the passwords in VCM as well.</p><p>We can make those changes using the steps we just went through.</p></div></div>
<div class="section" title="Managing users"><div class="titlepage"><div><div><h1 class="title"><a id="ch07lvl1sec76"/>Managing users</h1></div></div></div><p>You need to manage VCM logins and assign roles to users who have access to VCM. Roles determine the level of access for each user and can be adjusted for access to specific machine groups and VCM functionality.</p><div class="section" title="Getting ready"><div class="titlepage"><div><div><h2 class="title"><a id="ch07lvl2sec216"/>Getting ready</h2></div></div></div><p>If you are planning to create custom roles, they must be ready before starting this recipe.</p></div><div class="section" title="How to do it..."><div class="titlepage"><div><div><h2 class="title"><a id="ch07lvl2sec217"/>How to do it...</h2></div></div></div><p>Follow these steps to add new users and groups and give them appropriate permissions:</p><div class="orderedlist"><ol class="orderedlist arabic"><li class="listitem">Navigate to <span class="strong"><strong>Administration </strong></span>| <span class="strong"><strong>User Manager</strong></span> | <span class="strong"><strong>VCM Logins</strong></span>.</li><li class="listitem">Click on <span class="strong"><strong>Add Users</strong></span>.<div class="note" style="" title="Note"><div class="inner"><h3 class="title"><a id="note55"/>Note</h3><p>Note that you cannot add the Collector service account as a VCM login.</p></div></div></li><li class="listitem">Select <span class="strong"><strong>Enter Domain Account</strong></span> and click on <span class="strong"><strong>Next</strong></span>.<div class="note" style="" title="Note"><div class="inner"><h3 class="title"><a id="note56"/>Note</h3><p>Note that individual Active Directory accounts can also be added. Adding a group ensures that role-based access is governed by Active Directory.</p></div></div></li><li class="listitem">Enter the security group in the <code class="literal">DOMAIN\Group</code> format and click on <span class="strong"><strong>Next</strong></span>.</li><li class="listitem">Double-click on <span class="strong"><strong>Admin </strong></span>(or a lesser role for general access) and click on <span class="strong"><strong>Next</strong></span>.</li><li class="listitem">Click on <span class="strong"><strong>Finish</strong></span>.</li></ol></div></div><div class="section" title="How it works..."><div class="titlepage"><div><div><h2 class="title"><a id="ch07lvl2sec218"/>How it works...</h2></div></div></div><p>When VCM is installed, the user who installs it gets administrative access on the console. We need to add users or groups to give them access. By following this recipe, we can add users who need access.</p><div class="note" style="" title="Note"><div class="inner"><h3 class="title"><a id="note57"/>Note</h3><p>Note that when a user starts VCM, if more than one role is assigned to their login, a drop-down list appears and allows the user to select the desired role. To automatically log in to VCM using a particular role, users can check the <span class="strong"><strong>
<span class="strong"><strong>Automatically</strong></span> log in using this role</strong></span> option. To switch roles or not log in automatically, users can select a different role or uncheck this option.</p></div></div><div class="section" title="Default roles"><div class="titlepage"><div><div><h3 class="title"><a id="ch07lvl3sec71"/>Default roles</h3></div></div></div><p>This is the list of default roles available with VCM and a short description of each of them:</p><div class="informaltable"><table border="1"><colgroup><col/><col/><col/></colgroup><tbody><tr><td>
<p><span class="strong"><strong>Sr. no.</strong></span></p>
</td><td>
<p><span class="strong"><strong>Name</strong></span></p>
</td><td>
<p><span class="strong"><strong>Description</strong></span></p>
</td></tr><tr><td>
<p><span class="strong"><strong>1</strong></span></p>
</td><td>
<p>Admin</p>
</td><td>
<p>Top-level role. Admin has rights to everything in the database.</p>
</td></tr><tr><td>
<p><span class="strong"><strong>2</strong></span></p>
</td><td>
<p>Domain Controller Manager</p>
</td><td>
<p>Role with full access to the Domain Controllers dynamic machine group.</p>
</td></tr><tr><td>
<p><span class="strong"><strong>3</strong></span></p>
</td><td>
<p>Read-Only</p>
</td><td>
<p>Role with read access to all machines and data.</p>
</td></tr><tr><td>
<p><span class="strong"><strong>4</strong></span></p>
</td><td>
<p>Help Desk</p>
</td><td>
<p>Only allows password changes on domain controllers.</p>
</td></tr><tr><td>
<p><span class="strong"><strong>5</strong></span></p>
</td><td>
<p>IIS Admins</p>
</td><td>
<p>Role with full access to the Microsoft Internet Information Servers dynamic machine group.</p>
</td></tr><tr><td>
<p><span class="strong"><strong>6</strong></span></p>
</td><td>
<p>Server Managers</p>
</td><td>
<p>Role with full access to the Servers dynamic machine group.</p>
</td></tr><tr><td>
<p><span class="strong"><strong>7</strong></span></p>
</td><td>
<p>SQL Server Admins</p>
</td><td>
<p>Role with full access to the Microsoft SQL Servers dynamic machine group.</p>
</td></tr><tr><td>
<p><span class="strong"><strong>8</strong></span></p>
</td><td>
<p>Workstation Managers</p>
</td><td>
<p>Role with full access to the Workstation dynamic machine group.</p>
</td></tr><tr><td>
<p><span class="strong"><strong>9</strong></span></p>
</td><td>
<p>VCM Auditor</p>
</td><td>
<p>Role with read access to License Manager.</p>
</td></tr><tr><td>
<p><span class="strong"><strong>10</strong></span></p>
</td><td>
<p><code class="literal">AD_Admin</code></p>
</td><td>
<p>Built in role with access to AD data and Administration for AD.</p>
</td></tr><tr><td>
<p><span class="strong"><strong>11</strong></span></p>
</td><td>
<p><code class="literal">AD_User</code></p>
</td><td>
<p>Built in role with access to AD data only.</p>
</td></tr><tr><td>
<p><span class="strong"><strong>12</strong></span></p>
</td><td>
<p>Change Restricted</p>
</td><td>
<p>VCM <span class="strong"><strong>Change Restricted</strong></span> role.</p><p>
</p><p>With this role, users can discover machines, collect data from them, assess them, display bulletin and template details, check for updates, and view history. Users can add, edit, and delete reports, compliance rules and rule groups, and compliance and patch assessment templates. Users with the <span class="strong"><strong>Change Restricted</strong></span> role can also install the VCM agent, upgrade VCM, and uninstall it.</p>
</td></tr></tbody></table></div></div></div><div class="section" title="There's more..."><div class="titlepage"><div><div><h2 class="title"><a id="ch07lvl2sec219"/>There's more...</h2></div></div></div><p>When creating a role, we need to understand access rules as they define the areas of VCM that users can access and the actions that they can perform.</p><p>VCM roles and access rules go hand in hand; roles define which areas can be accessed by whom while rules define what kind of access is provided to the user, such as <span class="strong"><strong>None</strong></span>, <span class="strong"><strong>Read Only</strong></span>, <span class="strong"><strong>Full Access,</strong></span> or <span class="strong"><strong>Custom</strong></span>. When you select <span class="strong"><strong>Custom</strong></span>, it goes to a very granular level and you can select a single privilege, such as only <span class="strong"><strong>Add Automatic Deployment</strong></span> or <span class="strong"><strong>Run a Report</strong></span>.</p><p>You can either use the 14 default access rules or you can create new ones as per your requirement:</p><div class="orderedlist"><ol class="orderedlist arabic"><li class="listitem">To create a new access rule, log in to the VCM console, go to <span class="strong"><strong>Administration </strong></span>| <span class="strong"><strong>User Manager</strong></span> | <span class="strong"><strong>VCM Access</strong></span> | <span class="strong"><strong>Access Rules</strong></span>, and click on <span class="strong"><strong>Add Rule</strong></span>.</li><li class="listitem">Provide a nice name and description.</li><li class="listitem">Under <span class="strong"><strong>Rule Type</strong></span>, select <span class="strong"><strong>Basic Rule</strong></span> (this defines data types and areas of VCM to access) or <span class="strong"><strong>Admin Access Rule</strong></span> (to access administrative areas of VCM).</li><li class="listitem">For <span class="strong"><strong>Basic Rule</strong></span>, under <span class="strong"><strong>Data Type</strong></span>, include what type of data, that is, machine data or Active Directory data, and then define access to the VCM console, except the <span class="strong"><strong>Administration </strong></span>tab.</li><li class="listitem"><span class="strong"><strong>Admin Access Rule</strong></span> defines what type of access is defined in the <span class="strong"><strong>Administration </strong></span>tab, such as <span class="strong"><strong>None</strong></span>, <span class="strong"><strong>Read Only</strong></span>, <span class="strong"><strong>Full Control</strong></span>, or going granular with <span class="strong"><strong>Custom</strong></span>.</li><li class="listitem">Lastly, click on <span class="strong"><strong>Finish </strong></span>on the <span class="strong"><strong>Important </strong></span>page of the wizard to close and create this new access rule.</li></ol></div><p>As seen previously, there are 12 default roles created, but if you still have a use case that requires a different role, then you can create your own role. Follow these steps:</p><div class="orderedlist"><ol class="orderedlist arabic"><li class="listitem">Log in to the VCM console and go to <span class="strong"><strong>Administration </strong></span>| <span class="strong"><strong>User Manager</strong></span> | <span class="strong"><strong>VCM Access</strong></span> | <span class="strong"><strong>Roles</strong></span>.</li><li class="listitem">Click on the <span class="strong"><strong>Add Role</strong></span> button and follow the wizard.</li><li class="listitem">When creating a role, you will need some information. To start with, provide a name and description for the newly created role.</li><li class="listitem">For <span class="strong"><strong>Role Access</strong></span>, we can select either <span class="strong"><strong>Machine Data</strong></span> (access to data based on the selected machine groups), <span class="strong"><strong>Active Directory</strong></span> (access to Active Directory objects based on the AD structure), or <span class="strong"><strong>Admin </strong></span>(access to administrative functions) access.</li><li class="listitem">On the next page, under <span class="strong"><strong>Machine Data Access</strong></span>, you can filter which machine group this new role user can access.</li><li class="listitem">On the <span class="strong"><strong>Active Directory</strong></span> page, under <span class="strong"><strong>Enterprise</strong></span>, select the <span class="strong"><strong>Access Rule</strong></span> that will be applied at the root of AD, if you have configured any.</li><li class="listitem">For <span class="strong"><strong>Admin Access</strong></span>, select a proper rule to provide access.</li><li class="listitem">Under <span class="strong"><strong>Logins</strong></span>, select any logins to assign this role to and, after reviewing it under <span class="strong"><strong>Important</strong></span>, close the wizard to finish it.</li></ol></div></div></div>
<div class="section" title="Decommissioning VMs &#x2013; manual VM purge"><div class="titlepage"><div><div><h1 class="title"><a id="ch07lvl1sec77"/>Decommissioning VMs – manual VM purge</h1></div></div></div><p>As a part of the lifecycle management of a managed machine, we need to remove the details of the managed machine from the VCM console.</p><div class="section" title="Getting ready"><div class="titlepage"><div><div><h2 class="title"><a id="ch07lvl2sec220"/>Getting ready</h2></div></div></div><p>You must have the name of the machine that you want to remove from VCM.</p></div><div class="section" title="How to do it..."><div class="titlepage"><div><div><h2 class="title"><a id="ch07lvl2sec221"/>How to do it...</h2></div></div></div><p>It's a two-step process: First, free up a license and keep the data. Next, purge everything and remove the managed machine from the VCM database.</p><div class="section" title="Unlicense a managed machine"><div class="titlepage"><div><div><h3 class="title"><a id="ch07lvl3sec72"/>Unlicense a managed machine</h3></div></div></div><div class="orderedlist"><ol class="orderedlist arabic"><li class="listitem">Log in to VCM with administrative privileges.</li><li class="listitem">Go to <span class="strong"><strong>Administration </strong></span>| <span class="strong"><strong>Machines Manager </strong></span>| <span class="strong"><strong>Licensed Machines</strong></span> | <span class="strong"><strong>Licensed Windows Machines</strong></span> or <span class="strong"><strong>Licensed UNIX Machines</strong></span>.</li><li class="listitem">Right-click on the name of the machine you want to remove from the display.</li><li class="listitem">Select the <span class="strong"><strong>Unlicense </strong></span>option and follow the prompts.</li></ol></div><div class="note" style="" title="Note"><div class="inner"><h3 class="title"><a id="note58"/>Note</h3><p>Note that this returns the machine to the <span class="strong"><strong>Available Machines</strong></span> list and frees up the machine's license for reuse.</p></div></div></div><div class="section" title="Purge the machine"><div class="titlepage"><div><div><h3 class="title"><a id="ch07lvl3sec73"/>Purge the machine</h3></div></div></div><div class="orderedlist"><ol class="orderedlist arabic"><li class="listitem">Log in to VCM with administrative privileges.</li><li class="listitem">Go to <span class="strong"><strong>Administration </strong></span>| <span class="strong"><strong>Machines Manager</strong></span> | <span class="strong"><strong>Available Machine</strong></span>.</li><li class="listitem">From here, if required, we can license the machine and move it to <span class="strong"><strong>Licensed Windows Machines</strong></span> or <span class="strong"><strong>Licensed UNIX Machines</strong></span> or remove it from the VCM database.</li><li class="listitem">Select the machine and click on <span class="strong"><strong>Purge </strong></span>in the top menu.</li><li class="listitem">Follow the wizard; it will remove the machine completely from the VCM database.</li></ol></div></div></div><div class="section" title="How it works..."><div class="titlepage"><div><div><h2 class="title"><a id="ch07lvl2sec222"/>How it works...</h2></div></div></div><p>The process will obtain records as well as collected data from the VCM database and help us clean the clutter in the VCM, as the machines we want to delete have already been decommissioned. If those machines are not deleted from VCM, we could have an incorrect compliance score. We will always have machines that will fail patch installation and we will never reach the score we want.</p></div><div class="section" title="There's more..."><div class="titlepage"><div><div><h2 class="title"><a id="ch07lvl2sec223"/>There's more...</h2></div></div></div><p>If you are good with vRealize Orchestrator, VMware had released a package for VCM (which is available for download at <a class="ulink" href="https://my.vmware.com">https://my.vmware.com</a>). With the help of this package, you can create a workflow to remove/purge managed machines.</p></div></div>
<div class="section" title="Decommissioning VMs &#x2013; scheduled VM record purge"><div class="titlepage"><div><div><h1 class="title"><a id="ch07lvl1sec78"/>Decommissioning VMs – scheduled VM record purge</h1></div></div></div><p>In the era of the cloud, we would like VM decommissioning to be done automatically so that our operations team can do more creative stuff than cleaning up the VCM database.</p><div class="section" title="Getting ready"><div class="titlepage"><div><div><h2 class="title"><a id="ch07lvl2sec224"/>Getting ready</h2></div></div></div><p>You must have access to the SQL server where the VCM database is hosted. You must know the basics of SQL Management Studio.</p></div><div class="section" title="How to do it..."><div class="titlepage"><div><div><h2 class="title"><a id="ch07lvl2sec225"/>How to do it...</h2></div></div></div><p>The following stored procedure can be implemented on the VCM database (<code class="literal">VCM</code>) as a scheduled task. This will purge the records of the VMs that haven't been contacted in the last 3 weeks.</p><p>Change the value of <code class="literal">@expire int = xx</code> (the number of days for which the machine has not been contacted) in the script:</p><pre class="programlisting">USE [VCM] &#13;
GO &#13;
/****** Object:  StoredProcedure [dbo].[ecmSVC_sp_remove_noncollected_machines]    Script Date: 11/20/2012 11:40:58 ******/ &#13;
SET ANSI_NULLS ON &#13;
GO &#13;
SET QUOTED_IDENTIFIER ON &#13;
GO &#13;
ALTER PROCEDURE [dbo].[ecmSVC_sp_remove_noncollected_machines] &#13;
@expire int = 21, &#13;
@value NVARCHAR(5) = 'True' &#13;
 AS &#13;
/**************************************************************************/&#13;
Procedure:  dbo.ecmSVC_sp_remove_noncollected_machine &#13;
--------------------------------------------------------------------------- &#13;
REVISION HISTORY &#13;
Modified:  &lt;YYYY.MM.DD&gt; by &lt;Author&gt; &#13;
    Description - &#13;
    Issue/ATS# - &#13;
Created:   2006-05-11 by Chris Lennon &#13;
--------------------------------------------------------------------------- &#13;
DESCRIPTION &#13;
  Check for machines not pingable and haven't been collected over x amount&#13;
  of days &#13;
  Removed from the Licensed Machines into the Available Machines and as an &#13;
  option purge from ECM. &#13;
---------------------------- Copyright Notice ----------------------------- &#13;
This code may not be copied, altered, reused, or redistributed in any way without the express written consent of Configuresoft, Inc. &#13;
   Copyright 1998-2006 Configuresoft, Inc.  All rights reserved. &#13;
---------------------------- Configuresoft, Inc. -------------------------- &#13;
**************************************************************************/ &#13;
BEGIN &#13;
    DECLARE &#13;
        @uids VARCHAR(8000), &#13;
        @creator_id int, &#13;
        @owner_id int &#13;
    SELECT @uids = '' &#13;
    &#13;
    --Locate machines with no ping and not collected over x amount of days &#13;
    SELECT @uids = @uids + ISNULL(LTRIM(CAST(machine_id AS NVARCHAR(32))), &#13;
    '') + N'|' &#13;
    FROM ecm_view_rpt_machine_info_all &#13;
    WHERE (connection_state = 'ICOStatusConnectionNoPing16' &#13;
    or connection_state = 'ICOStatusConnectionNoName16') &#13;
    and [date last contacted] &lt; DATEADD(dd, -@expire, GETUTCDATE()) &#13;
    and managed = '1' &#13;
    -- remove trailing pipe if it exists &#13;
    IF RIGHT(@uids, 1) = '|' &#13;
    BEGIN &#13;
        SELECT @uids = SUBSTRING(@uids, 1, LEN(@uids) - 1) &#13;
    END &#13;
    IF @uids &lt;&gt; '' &#13;
    BEGIN &#13;
            --Remove from Licensed Machines &#13;
            exec dbo.ecm_sp_machines_set_state @uids, N'|', 5 &#13;
        &#13;
            --Purge from ECM if @value is TRUE &#13;
            IF @value = 'TRUE' &#13;
            BEGIN &#13;
                SELECT @creator_id = dbo.userid() &#13;
                SELECT @owner_id = dbo.role_current() &#13;
                exec dbo.ecm_sp_machine_delete_all_data @uids, 1, N'|',             &#13;
                @owner_id, @creator_id &#13;
            END &#13;
    END &#13;
END &#13;
</pre><div class="section" title="Schedule a job in SQL"><div class="titlepage"><div><div><h3 class="title"><a id="ch07lvl3sec74"/>Schedule a job in SQL</h3></div></div></div><div class="orderedlist"><ol class="orderedlist arabic"><li class="listitem">Expand the <span class="strong"><strong>SQL Server Agent </strong></span>node, right-click on the <span class="strong"><strong>Jobs </strong></span>node in <span class="strong"><strong>SQL Server Agent</strong></span>, and select <span class="strong"><strong>New Job</strong></span>:<div class="mediaobject"><img alt="Schedule a job in SQL" src="graphics/image_07_017.jpg"/></div></li><li class="listitem">In the <span class="strong"><strong>New Job</strong></span> window, enter the name of the job and a description in the <span class="strong"><strong>General </strong></span>tab:<div class="mediaobject"><img alt="Schedule a job in SQL" src="graphics/image_07_018.jpg"/></div></li><li class="listitem">Select <span class="strong"><strong>Steps</strong></span> on the left-hand side of the window and click on <span class="strong"><strong>New</strong></span> at the bottom.</li><li class="listitem">In the <span class="strong"><strong>Steps </strong></span>window, enter a step name and select the database you want the query to run against:<div class="mediaobject"><img alt="Schedule a job in SQL" src="graphics/image_07_019.jpg"/></div></li><li class="listitem">Paste in the <code class="literal">T-SQL</code> command you want to run in the command window, and click on <span class="strong"><strong>OK</strong></span>.</li><li class="listitem">Click on the <span class="strong"><strong>Schedule </strong></span>menu to the left of the <span class="strong"><strong>New Job</strong></span> window and enter the schedule information (for example, daily and a time).</li><li class="listitem">Click on <span class="strong"><strong>OK</strong></span>, and that should be it.</li></ol></div></div></div><div class="section" title="How it works..."><div class="titlepage"><div><div><h2 class="title"><a id="ch07lvl2sec226"/>How it works...</h2></div></div></div><p>The job will run on the schedule provided by you and clean the managed machines that have not been communicating for the last 21 days; if this seems too much, then the number can be changed in the script to a suitable number as per your requirements.</p></div></div></body></html>