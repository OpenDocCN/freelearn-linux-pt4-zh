<html><head></head><body><div id="sbo-rt-content" class="calibre1"><section class="calibre2">

                            <header class="calibre2">
                    <h1 class="header-title">Making a Script Behave Like a Daemon</h1>
                </header>
            
            <article class="calibre2">
                
<p class="mce-root">In this chapter, we will introduce the following topics:</p>
<ul class="calibre13">
<li class="calibre14"><span class="calibre11">Running a program continuously (forever) using looping constructs or recursion</span></li>
<li class="calibre14">Keeping programs/scripts running after logoff</li>
<li class="calibre14">Invoking commands when they require permissions</li>
<li class="calibre14">Sanitizing user input and for repeatable results</li>
<li class="calibre14">Making a simple multi-level user menu using select</li>
<li class="calibre14">Generating and trapping signals for cleanup</li>
<li class="calibre14">Using temporary files and lock files in your program</li>
<li class="calibre14">Leveraging timeout when waiting for command completion</li>
<li class="calibre14">Creating a file-in-file-out program and running processes in parallel</li>
<li class="calibre14">Executing your script on startup</li>
</ul>


            </article>

            
        </section>
    </div>



  
<div id="sbo-rt-content" class="calibre1"><section class="calibre2">

                            <header class="calibre2">
                    <h1 class="header-title">Introduction</h1>
                </header>
            
            <article class="calibre2">
                
<p class="mce-root">This chapter is about creating components that mimic application functionality such as menus or a daemon. For that to happen, let's step back for a second and determine: what defines an application or daemon? Is it menus? Is it the ability to run <em class="calibre18">forever?</em> Or the ability to run <em class="calibre18">headless</em> in the background? All of this defines behaviors that an application may exhibit, but nothing prevents a script from also having these behaviors as well!</p>
<p class="mce-root">For example, if a bash script did not have an extension (for example, <kbd class="calibre17">.sh</kbd>) and was not ran explicitly with the Bash interpreter, how would you know on the first inspection that it was a script and not a binary? While there are a number of ways such as opening, or using the <kbd class="calibre17">file</kbd> command, on the surface, a script can appear the same as a program!</p>


            </article>

            
        </section>
    </div>



  
<div id="sbo-rt-content" class="calibre1"><section class="calibre2">

                            <header class="calibre2">
                    <h1 class="header-title">Running a program continuously (forever) using looping constructs or recursion</h1>
                </header>
            
            <article class="calibre2">
                
<p class="mce-root">So far, this cookbook has mostly shown scripts that serve a single purpose and exit upon task completion. This is great for single use scripts, but what about if we wanted to have scripts execute multiple scripts through a menu, or perform tasks in the background automatically forever without being executed each time by scheduling processes (like cron)? This recipe introduces a few ways for a script to run forever until it is killed or exits.</p>


            </article>

            
        </section>
    </div>



  
<div id="sbo-rt-content" class="calibre1"><section class="calibre2">

                            <header class="calibre2">
                    <h1 class="header-title">Getting ready</h1>
                </header>
            
            <article class="calibre2">
                
<p class="mce-root">Besides having a terminal open, we need to remember a few concepts:</p>
<ul class="calibre13">
<li class="calibre14">Recursive functions combined with a prompt (for example, the <kbd class="calibre17">read</kbd> command) can result in a script that loops based on user input</li>
<li class="calibre14">Looping constructs such as <kbd class="calibre17">for</kbd>, <kbd class="calibre17">while</kbd>, and <kbd class="calibre17">until</kbd> can be executed in such a way that a condition is never met and cannot exit</li>
</ul>
<p class="mce-root">Therefore, a loop or something that causes a loop will force a program to run for an indefinite period of time until an exit event occurs.</p>
<div class="packt_infobox">In many programming languages, a program will be executed through the concept of a main function. Within this <kbd class="calibre23">main</kbd> function, often programmers create what's called a run loop, which allows the program to run forever (even if it is doing nothing).</div>
<p class="mce-root">Using the recursive method, the operation may look like this:</p>
<ol class="calibre20">
<li class="chapter">The script or program enters a recursive function</li>
<li class="chapter">The recursive function can continue calling itself indefinitely, or, wait for a blocking input (for example, the <kbd class="calibre17">read</kbd><strong class="calibre3"> </strong>command)</li>
<li class="chapter">Based on the input provided by the <kbd class="calibre17">read</kbd> command, you could call the same function again</li>
<li class="chapter">Go back to step 1 until exit</li>
</ol>
<p class="mce-root">Alternatively, the looping mechanism is similar except functions are not necessarily executed. A loop with an effectively unreachable condition will continuously run unless something interrupts the execution (for example, <kbd class="calibre17">sleep</kbd>).</p>
<div class="packt_infobox">A loop running continuously without pause will use CPU resources that could be used elsewhere or waste CPU cycles. If you are running on a battery or a resource constrained platform, extra CPU activity is best to be avoided where possible.</div>
<div class="packt_tip">Using the <kbd class="calibre23">sleep</kbd> command is an excellent way to limit CPU usage when using loops in simple scripts. However, time adds up if you are running a long script!</div>


            </article>

            
        </section>
    </div>



  
<div id="sbo-rt-content" class="calibre1"><section class="calibre2">

                            <header class="calibre2">
                    <h1 class="header-title">How to do it...</h1>
                </header>
            
            <article class="calibre2">
                
<p class="mce-root"> Let's start our activity as follows:</p>
<ol class="calibre20">
<li class="chapter">Open a terminal and create the <kbd class="calibre17">recursive_read_input.sh</kbd> script:</li>
</ol>
<pre class="calibre27">#!/bin/bash<br class="calibre2"/><br class="calibre2"/>function recursive_func() {<br class="calibre2"/><br class="calibre2"/>    echo -n "Press anything to continue loop "<br class="calibre2"/>    read input<br class="calibre2"/>    recursive_func<br class="calibre2"/>}<br class="calibre2"/><br class="calibre2"/>recursive_func<br class="calibre2"/>exit 0</pre>
<ol start="2" class="calibre20">
<li class="chapter">Execute the <kbd class="calibre17">$ bash recursive_read_input.sh</kbd><strong class="calibre3"> </strong>script<span class="calibre11">—</span>press <em class="calibre26">Enter</em> at the prompt and wait for another prompt.</li>
<li class="chapter">Exit the program with <em class="calibre26">Ctrl</em> + C.</li>
<li class="chapter">Open a terminal and create the <kbd class="calibre17">loop_for_input.sh</kbd> script:</li>
</ol>
<pre class="calibre27">#!/bin/bash<br class="calibre2"/><span class="calibre11">for</span> <span class="calibre11">(</span><span class="calibre11">(</span> ; ; <span class="calibre11">)</span><span class="calibre11">)</span>
<span class="calibre11">do</span>
   <span class="calibre11">echo</span> <span class="calibre11">"Shall run for ever"</span>
   <span class="calibre11">sleep</span> <span class="calibre11">1</span>
<span class="calibre11">done<br class="calibre2"/>exit 0</span></pre>
<ol start="5" class="calibre20">
<li class="chapter">Execute the<span class="calibre11"> </span><kbd class="calibre17">$ bash loop_for_input.sh</kbd><strong class="calibre3"> </strong>script<span class="calibre11">—</span>press <em class="calibre26">Enter</em> at the prompt and wait for another prompt.</li>
</ol>
<p class="mce-root"> </p>
<ol start="6" class="calibre20">
<li class="chapter">Exit the program with <em class="calibre26">Ctrl</em> + <em class="calibre26">C.</em></li>
<li class="chapter">Open a terminal and create the <kbd class="calibre17">loop_while_input.sh</kbd> script:</li>
</ol>
<pre class="calibre27">#!/bin/bash<br class="calibre2"/>EXIT_PLEASE=0<br class="calibre2"/>while : # Notice no conditions?<br class="calibre2"/>do<br class="calibre2"/>   echo "Pres CTRL+C to stop..."<br class="calibre2"/>   sleep 1<br class="calibre2"/>   if [ $EXIT_PLEASE != 0 ]; then<br class="calibre2"/>      break <br class="calibre2"/>    fi <br class="calibre2"/>done<br class="calibre2"/>exit 0</pre>
<ol start="8" class="calibre20">
<li class="chapter">Execute the <kbd class="calibre17"><span class="calibre11">$ bash loop_while_input.sh</span></kbd> script<span class="calibre11">—</span>press <em class="calibre26">Enter</em> at the prompt and wait for another prompt.</li>
<li class="chapter">Exit the program with <em class="calibre26">Ctrl</em> + <em class="calibre26">C.</em></li>
<li class="chapter">Open a terminal and create the<span class="calibre11"> </span><kbd class="calibre17">loop_until_input.sh</kbd> script:</li>
</ol>
<pre class="calibre27">#!/bin/bash
EXIT_PLEASE=0<br class="calibre2"/>until [ $EXIT_PLEASE != 0 ] # EXIT_PLEASE is set to 0, until will never be satisfied<br class="calibre2"/>do<br class="calibre2"/>   echo "Pres CTRL+C to stop..."<br class="calibre2"/>   sleep 1<br class="calibre2"/>done<br class="calibre2"/>exit 0</pre>
<ol start="11" class="calibre20">
<li class="chapter">Execute the <span class="calibre11"><kbd class="calibre17">$ bash loop_until_input.sh</kbd> </span>script<span class="calibre11">—</span>press <em class="calibre26">Enter</em> at the prompt and wait for another prompt.</li>
<li class="chapter">Exit the program with <em class="calibre26">Ctrl</em> + <em class="calibre26">C.</em></li>
</ol>


            </article>

            
        </section>
    </div>



  
<div id="sbo-rt-content" class="calibre1"><section class="calibre2">

                            <header class="calibre2">
                    <h1 class="header-title">How it works...</h1>
                </header>
            
            <article class="calibre2">
                
<p class="mce-root">Let's understand our script in detail:</p>
<ol class="calibre20">
<li class="chapter">Creating the <kbd class="calibre17">recursive_read_input.sh</kbd> script is a simple process. We can see that the <kbd class="calibre17">read</kbd> command expects input (and will store it in the <kbd class="calibre17">$input</kbd> variable), then the script calls <kbd class="calibre17">recursive_func()</kbd> again for <em class="calibre26">each</em> time a read exits.</li>
</ol>
<p class="mce-root"> </p>
<ol start="2" class="calibre20">
<li class="chapter">Executing the script with<span class="calibre11"> </span><kbd class="calibre17">$ bash recursive_read_input.sh</kbd><strong class="calibre3"> </strong>runs the script indefinitely. No matter the input, <em class="calibre26">Ctrl + C</em> or killing the script will exit it.</li>
<li class="chapter">Creating the <kbd class="calibre17">loop_for_input.sh</kbd> script is relatively trivial as well. We can notice two things: the for loop has no parameters, except for <kbd class="calibre17">(( ; ; ))</kbd> and the <kbd class="calibre17">sleep</kbd> command. This will make it run forever, but upon each execution of the loop, it will echo <kbd class="calibre17">Shall run for ever</kbd> to the console and sleep one second before continuing to the next loop.</li>
<li class="chapter">Executing the<span class="calibre11"> </span><kbd class="calibre17">$ bash loop_for_input.sh</kbd> script<strong class="calibre3"> </strong>will cause the script to loop forever.</li>
<li class="chapter"><em class="calibre26">Ctrl</em> + <em class="calibre26">C</em> will cause the script to exit.</li>
<li class="chapter"><span class="calibre11">Use the </span><kbd class="calibre17">loop_while_input.sh</kbd> script by using a <kbd class="calibre17">while</kbd> loop with the <kbd class="calibre17">: noop</kbd> command. However, there is a small difference of an if statement (which will never evaluate to true), but it can still be used in another script to set a condition which causes the script to break the <kbd class="calibre17">while</kbd> loop and exit.</li>
<li class="chapter">Executing the <kbd class="calibre17"><span class="calibre11">$ bash loop_while_input.sh</span></kbd> script <span class="calibre11">will cause the script to loop forever.</span></li>
<li class="chapter"><em class="calibre26">Ctrl</em> + <em class="calibre26">C</em> will cause the script to exit.</li>
<li class="chapter">The<span class="calibre11"> </span><kbd class="calibre17">loop_until_input.sh</kbd> script is similar to the <kbd class="calibre17">while</kbd> loop forever example, but it is different because you can also embed a condition, which will never evaluate to <kbd class="calibre17">true.</kbd> This causes the script to loop forever unless the <kbd class="calibre17">$EXIT_PLEASE</kbd> variable is set to <kbd class="calibre17">1</kbd>.</li>
<li class="chapter">Executing the <span class="calibre11"><kbd class="calibre17">$ bash loop_until_input.sh</kbd> script </span>will cause the script to loop forever.</li>
<li class="chapter"><span class="calibre11"><em class="calibre26">Ctrl</em> + <em class="calibre26">C</em> will cause the script to exit.</span></li>
</ol>


            </article>

            
        </section>
    </div>



  
<div id="sbo-rt-content" class="calibre1"><section class="calibre2">

                            <header class="calibre2">
                    <h1 class="header-title">Keeping programs/scripts running after logoff</h1>
                </header>
            
            <article class="calibre2">
                
<p class="mce-root">Leading up to getting our scripts to run as daemons, we need to know how to keep commands running after a user logs off (or better yet, have them started by the system itself (we will look at this in more detail later). When a user logs in, a session for that user is created, but when they log off—unless the system owns it, processes and scripts typically get killed or closed.</p>
<p class="mce-root">This recipe is about keeping your scripts and activities running in the background after you log off.</p>


            </article>

            
        </section>
    </div>



  
<div id="sbo-rt-content" class="calibre1"><section class="calibre2">

                            <header class="calibre2">
                    <h1 class="header-title">Getting ready</h1>
                </header>
            
            <article class="calibre2">
                
<p class="mce-root">Besides having a terminal open, we need to remember a few concepts:</p>
<ul class="calibre13">
<li class="calibre14">When a user logs off, any apps or processes owned by the current user will exit (the shell will send a signal)</li>
<li class="calibre14">The shell is configurable to not send a shutdown signal to processes</li>
<li class="calibre14">Applications and scripts use stdin and stdout for the usual operations</li>
<li class="calibre14">Applications or scripts in the background can be referred to as <strong class="calibre3">jobs</strong></li>
</ul>
<p class="mce-root">The purpose of this chapter is to not show you process management, but how we can manipulate the shell to keep our programs running. One neat way is by using <kbd class="calibre17">&amp;</kbd>,<strong class="calibre6"> </strong>which is used this way: <kbd class="calibre17">$ bash runforver.sh &amp;</kbd>. Unfortunately, using only this technique, we are back at square one—our binary still dies when we exit. Therefore, we need to use programs such as <strong class="calibre6">screen</strong>, <strong class="calibre6">disown</strong>, and <strong class="calibre6">sighup</strong>.</p>
<div class="packt_infobox">The screen command is not available on all systems. It is recommended that we use another command in case <strong class="calibre3">screen</strong> is absent (it is still useful to know!).</div>


            </article>

            
        </section>
    </div>



  
<div id="sbo-rt-content" class="calibre1"><section class="calibre2">

                            <header class="calibre2">
                    <h1 class="header-title">How to do it...</h1>
                </header>
            
            <article class="calibre2">
                
<p class="mce-root">Let's start our activity as follows:</p>
<ol class="calibre20">
<li class="chapter">Open a terminal and create the <kbd class="calibre17">loop_and_print.sh</kbd> script:</li>
</ol>
<pre class="calibre27">#!/bin/bash
EXIT_PLEASE=0<br class="calibre2"/>INC=0<br class="calibre2"/><br class="calibre2"/>until [ ${EXIT_PLEASE} != 0 ] # EXIT_PLEASE is set to 0, until will never be satisfied<br class="calibre2"/>do<br class="calibre2"/>   echo "Boo $INC" &gt; /dev/null<br class="calibre2"/>   INC=$((INC + 1))<br class="calibre2"/>   sleep 1<br class="calibre2"/>done<br class="calibre2"/>exit 0</pre>
<ol start="2" class="calibre20">
<li class="chapter">Open a terminal and run the following commands:</li>
</ol>
<pre class="calibre27">$ bash loop_and_print.sh &amp;<br class="calibre2"/>$ ps aux | grep loop_and_print.sh # Take note of the PID - write it down</pre>
<ol start="3" class="calibre20">
<li class="chapter">Next, log off, then log in and run the following command in a new terminal:</li>
</ol>
<pre class="calibre27">$ ps aux | grep loop_and_print.sh # Take note of the PID - write it down</pre>
<ol start="4" class="calibre20">
<li class="chapter">Can you find the process running? Next, run the following command:</li>
</ol>
<pre class="calibre27">$ bash loop_and_print.sh &amp; # note the PID againg<br class="calibre2"/>$ disown</pre>
<ol start="5" class="calibre20">
<li class="chapter">Next, log off, then log in and run the following command in a new terminal:</li>
</ol>
<pre class="calibre27">$ ps aux | grep loop_and_print.sh # Take note of the PID - write it down</pre>
<ol start="6" class="calibre20">
<li class="chapter">Next, run the following command:</li>
</ol>
<pre class="calibre27">$ nohup bash loop_and_print.sh &amp;</pre>
<ol start="7" class="calibre20">
<li class="chapter">Next, log off, then log in and run the following command in a new terminal:</li>
</ol>
<pre class="calibre27">$ ps aux | grep loop_and_print.sh # Take note of the PID - write it down</pre>


            </article>

            
        </section>
    </div>



  
<div id="sbo-rt-content" class="calibre1"><section class="calibre2">

                            <header class="calibre2">
                    <h1 class="header-title">How it works...</h1>
                </header>
            
            <article class="calibre2">
                
<ol class="calibre20">
<li class="chapter">In step 1, we opened a terminal and created the <kbd class="calibre17">loop_and_print.sh</kbd><strong class="calibre3"> </strong>script. This script merely loops forever, printing as it does.</li>
<li class="chapter">The following commands will use the <kbd class="calibre17">loop_and_print.sh</kbd> script and run in the background as a <strong class="calibre3">job</strong>. The <kbd class="calibre17">ps</kbd> command outputs process information and is piped through grep to simplify the output. In the command, we can see the process ID (PID) next to the username column. Keep note of PIDs so that you can kill zombie processes or stop unnecessary applications:</li>
</ol>
<pre class="calibre27">$ bash loop_and_print.sh &amp;<br class="calibre2"/>[1]<strong class="calibre3">4510</strong><br class="calibre2"/>$ ps aux | grep loop_and_print.sh # Take note of the PID - write it down<br class="calibre2"/>rbrash <strong class="calibre3">4510</strong> 0.0 0.0 12548 3024 pts/2 S 12:58 0:00 bash loop_and_print.sh</pre>
<ol start="3" class="calibre20">
<li class="chapter">Logging back on and running the <kbd class="calibre17">ps</kbd> command will produce <em class="calibre26">zero</em> results. This is because the script we put into the background using <kbd class="calibre17">&amp;</kbd> has been sent a signal to shutdown or die. </li>
<li class="chapter">Again, we run the <kbd class="calibre17">loop_and_print.sh</kbd> script; command puts it into the <em class="calibre26">background</em>, and disown removes the the background process(es) from the known list of jobs. This <em class="calibre26">disconnects</em> the script and <em class="calibre26">all</em> output from any terminal. </li>
<li class="chapter">Upon logging back in and using the <kbd class="calibre17">ps</kbd> command, you shall see the PID of the command:</li>
</ol>
<pre class="calibre27">rbrash <strong class="calibre3">8097</strong> 0.0 0.0 12548 3024 pts/2 S 13:02 0:00 bash loop_and_print.sh</pre>
<ol start="6" class="calibre20">
<li class="chapter">The <kbd class="calibre17">nohup</kbd> command is similar to the <kbd class="calibre17">disown</kbd> command, except that it explicitly <em class="calibre26">disconnects</em> the script from the current shell. It is <em class="calibre26">also</em> different from disown because <kbd class="calibre17">nohup</kbd> allows you still retain output from the script, which is accessible by other applications after the fact in the <kbd class="calibre17">nohup.out</kbd> file:</li>
</ol>
<pre class="calibre27">$ nohup bash loop_and_print.sh &amp;<br class="calibre2"/>[2] 14256<br class="calibre2"/>$ nohup: ignoring input and appending output to 'nohup.out'</pre>
<ol start="7" class="calibre20">
<li class="chapter">Upon logging back in and using the <kbd class="calibre17">ps</kbd> command, you shall see the PIDs of the <em class="calibre26">two</em> scripts that survived the logoff:</li>
</ol>
<pre class="calibre27">$ ps aux | grep loop_and_print.sh<br class="calibre2"/>rbrash <strong class="calibre3">4510</strong> 0.0 0.0 12548 3024 pts/2 S 12:58 0:00 bash loop_and_print.sh<br class="calibre2"/>rbrash <strong class="calibre3">14256 </strong>0.0 0.0 12548 3024 pts/2 S 13:02 0:00 bash loop_and_print.sh</pre>


            </article>

            
        </section>
    </div>



  
<div id="sbo-rt-content" class="calibre1"><section class="calibre2">

                            <header class="calibre2">
                    <h1 class="header-title">Invoking commands when they require permissions</h1>
                </header>
            
            <article class="calibre2">
                
<p class="mce-root">Running as root is dangerous, although sometimes convenient<span class="calibre16">—</span>especially when you are new to Linux and password prompts seem to be a hassle. So far, as a Linux user, you may have seen the <kbd class="calibre17">sudo</kbd> command or the <kbd class="calibre17">su</kbd><strong class="calibre6"> </strong>command. These commands can allow a user to change users on the system at the console or execute commands momentarily with higher permissions (if the user has <kbd class="calibre17">sudo</kbd> permissions). <kbd class="calibre17">Sudo</kbd>, or <strong class="calibre6">substitute user do, </strong>enables a regular user to escalate (raise) their user permissions to a more privileged level for a SINGLE command. </p>
<p class="mce-root">Alternatively, the substitute user command, or <kbd class="calibre17">su</kbd>, allows you to also run commands that are privileged and to even change shells (for example, to become a root user). <kbd class="calibre17">Sudo</kbd> doesn't activate a root shell or allow you access to other user accounts, which is unlike the <kbd class="calibre17">su</kbd> command.</p>
<p class="mce-root">Here are some example uses of the two commands:</p>
<pre class="calibre22">$ sudo ls /root<br class="calibre2"/>$ su -c 'ls /root'<br class="calibre2"/>$ su -</pre>
<p class="mce-root">While both commands require knowledge of a root password, <kbd class="calibre17">sudo</kbd> also requires that the user executing the <kbd class="calibre17">sudo</kbd> command is listed in the <kbd class="calibre17">/etc/sudoers</kbd> file:</p>
<pre class="calibre22">$ sudo /etc/sudoers<br class="calibre2"/>[sudo] password for rbrash: <br class="calibre2"/>#<br class="calibre2"/># This file MUST be edited with the 'visudo' command as root.<br class="calibre2"/>#<br class="calibre2"/># Please consider adding local content in /etc/sudoers.d/ instead of<br class="calibre2"/># directly modifying this file.<br class="calibre2"/>#<br class="calibre2"/># See the man page for details on how to write a sudoers file.<br class="calibre2"/>#<br class="calibre2"/>Defaults env_reset<br class="calibre2"/>Defaults mail_badpass<br class="calibre2"/>Defaults secure_path="/usr/local/sbin:/usr/local/bin:/usr/sbin:/usr/bin:/sbin:/bin:/snap/bin"<br class="calibre2"/><br class="calibre2"/># Host alias specification<br class="calibre2"/><br class="calibre2"/># User alias specification<br class="calibre2"/><br class="calibre2"/># Cmnd alias specification<br class="calibre2"/><br class="calibre2"/># User privilege specification<br class="calibre2"/>root ALL=(ALL:ALL) ALL<br class="calibre2"/><br class="calibre2"/># Members of the admin group may gain root privileges<br class="calibre2"/>%admin ALL=(ALL) ALL<br class="calibre2"/><br class="calibre2"/># Allow members of group sudo to execute any command<br class="calibre2"/>%sudo ALL=(ALL:ALL) ALL<br class="calibre2"/><br class="calibre2"/># See sudoers(5) for more information on "#include" directives:<br class="calibre2"/><br class="calibre2"/>#includedir /etc/sudoers.d<br class="calibre2"/><br class="calibre2"/></pre>
<p class="mce-root">In the preceding standard Ubuntu sudoers file, we can see that the admin group of users can use the <kbd class="calibre17">sudo</kbd> command (and likely the reason you are able to do so as well without tinkering). We can also see that there can be specific user privilege execution:</p>
<pre class="calibre22">root ALL=(ALL:ALL) ALL</pre>
<p class="mce-root">This indicates that the root user can run all the commands available on the system. In fact, we could add a line for a user named <kbd class="calibre17">rbrash</kbd>, such as <kbd class="calibre17">rbrash ALL=(ALL) ALL</kbd>.</p>
<p class="mce-root"><kbd class="calibre17">/etc/sudoers</kbd> can be edited by a user with root permissions using the <kbd class="calibre17">visudo</kbd> command:</p>
<pre class="calibre22">$ sudo visudo</pre>
<div class="packt_tip">Be careful when adding permissions or alterations to users. It could become a security risk if the account is not secure!</div>
<p class="mce-root">At the end of the day, you might wonder why this is so important for a Bash script (besides being able to escalate permissions). Well, imagine that you might have a system in place that performs Continuous Integration or a process that builds software continuously (for example, Jenkins)—it might just be desirable to have a build running various commands without your input, hence the use of giving a user access to specific commands (especially if they are <strong class="calibre6">sandboxed </strong>or within a <strong class="calibre6">virtual machine</strong>).</p>


            </article>

            
        </section>
    </div>



  
<div id="sbo-rt-content" class="calibre1"><section class="calibre2">

                            <header class="calibre2">
                    <h1 class="header-title">Getting ready</h1>
                </header>
            
            <article class="calibre2">
                
<p class="mce-root">Besides having a terminal open, we need to remember a few concepts:</p>
<ul class="calibre13">
<li class="calibre14"><kbd class="calibre17">sudo</kbd> requires a password (unless specified)</li>
<li class="calibre14"><kbd class="calibre17">sudo</kbd> can also be limited to specific commands, users, or hosts</li>
<li class="calibre14"><kbd class="calibre17">sudo</kbd> commands are also logged in either <kbd class="calibre17">/var/log/secure</kbd> or <kbd class="calibre17">/var/log/auth.log</kbd>:</li>
</ul>
<pre class="calibre27">Dec 23 16:16:19 moon sudo: rbrash : TTY=pts/2 ; PWD=/home/rbrash/Desktop/book ; USER=root ; COMMAND=/usr/bin/vi /var/log/auth.log<br class="calibre2"/>Dec 23 16:16:19 moon sudo: pam_unix(sudo:session): session opened for user root by (uid=0)</pre>
<p class="mce-root">Additionally, we can create a new user for this recipe:</p>
<pre class="calibre22">$ sudo useradd bob<br class="calibre2"/>$ sudo passwd bob #use password</pre>


            </article>

            
        </section>
    </div>



  
<div id="sbo-rt-content" class="calibre1"><section class="calibre2">

                            <header class="calibre2">
                    <h1 class="header-title">How to do it...</h1>
                </header>
            
            <article class="calibre2">
                
<p class="mce-root">Let's start our activity as follows:</p>
<ol class="calibre20">
<li class="chapter">Run the command in a new terminal, <em class="calibre26">not</em> as <kbd class="calibre17">root</kbd>, and without any previous <kbd class="calibre17">sudo</kbd> authorization:</li>
</ol>
<pre class="calibre27">$ shutdown -h 10<br class="calibre2"/>$ shutdown -c</pre>
<ol start="2" class="calibre20">
<li class="chapter">Now, execute the <strong class="calibre3"><kbd class="calibre17">$ sudo visudo</kbd></strong> command and edit the script to include the following lines:</li>
</ol>
<pre class="calibre27">$ sudo visudo<br class="calibre2"/>[sudo] password for rbrash: <br class="calibre2"/>#<br class="calibre2"/>Defaults env_reset<br class="calibre2"/>Defaults mail_badpass<br class="calibre2"/>Defaults secure_path="/usr/local/sbin:/usr/local/bin:/usr/sbin:/usr/bin:/sbin:/bin:/snap/bin"<br class="calibre2"/><br class="calibre2"/># Host alias specification<br class="calibre2"/><br class="calibre2"/># User alias specification<br class="calibre2"/><br class="calibre2"/># Cmnd alias specification<br class="calibre2"/><br class="calibre2"/><strong class="calibre3">Cmnd_Alias READ_CMDS = /sbin/halt, /sbin/shutdown</strong><br class="calibre2"/><br class="calibre2"/># User privilege specification<br class="calibre2"/>root ALL=(ALL:ALL) ALL<br class="calibre2"/><br class="calibre2"/><strong class="calibre3">bob ALL=(ALL:ALL) NOPASSWD: READ_CMDS</strong><br class="calibre2"/><br class="calibre2"/># Members of the admin group may gain root privileges<br class="calibre2"/>%admin ALL=(ALL) ALL<br class="calibre2"/><br class="calibre2"/># Allow members of group sudo to execute any command<br class="calibre2"/>%sudo ALL=(ALL:ALL) ALL<br class="calibre2"/><br class="calibre2"/># See sudoers(5) for more information on "#include" directives:<br class="calibre2"/><br class="calibre2"/>#includedir /etc/sudoers.d<br class="calibre2"/><br class="calibre2"/></pre>
<ol start="3" class="calibre20">
<li class="chapter">Run the command in a new terminal, <em class="calibre26">not</em> as <kbd class="calibre17">root</kbd> and without any previous <kbd class="calibre17">sudo</kbd> authorization:</li>
</ol>
<pre class="calibre27">$ shutdown -h 10<br class="calibre2"/>$ shutdown -c</pre>
<ol start="4" class="calibre20">
<li class="chapter">Notice anything different? Now, make sure to cancel the shutdown using the previous command:<kbd class="calibre17"> $ shutdown -c</kbd>.</li>
</ol>


            </article>

            
        </section>
    </div>



  
<div id="sbo-rt-content" class="calibre1"><section class="calibre2">

                            <header class="calibre2">
                    <h1 class="header-title">How it works...</h1>
                </header>
            
            <article class="calibre2">
                
<p class="mce-root">The preceding recipe is pretty slim, but there is a fair bit of assumption and knowledge that you need to know about in regards to <kbd class="calibre17">sudo</kbd>. First, be careful. Second, be more careful. And finally, take care to keep your account secure with adequate password policies:</p>
<ol class="calibre20">
<li class="chapter">In step one, we tried to run two commands that require user permissions. Normally, rebooting or halting a system requires privilege escalation (unless done through the GUI). The <kbd class="calibre17">shutdown -c</kbd> command cancels a shutdown. If you used <kbd class="calibre17">shutdown -h</kbd> now, the system would shut down immediately. This cannot be stopped.</li>
<li class="chapter">In the second step, we use the new <kbd class="calibre17">visudo</kbd> command to make edits to the <kbd class="calibre17">/etc/sudoers</kbd> file. In bold, <kbd class="calibre17">Cmnd_Alias</kbd> allows you define a group of commands, however, you have to use the full path of binaries. The user Bob is assigned to this Alias as well. <kbd class="calibre17">NOPASSWD:</kbd> is used to specify that the password is not required for these commands</li>
<li class="chapter">In the third step, shutdown commands can be run without a password prompt.</li>
<li class="chapter">The final step is to guarantee an accidental shutdown is cancelled.</li>
</ol>


            </article>

            
        </section>
    </div>



  
<div id="sbo-rt-content" class="calibre1"><section class="calibre2">

                            <header class="calibre2">
                    <h1 class="header-title">Sanitizing user input and for repeatable results</h1>
                </header>
            
            <article class="calibre2">
                
<p class="mce-root">One of the best practices for scripts (or programs, for that matter) is controlling user input, not only for security, but for controlling functionality in a way that input provides predictable results. For example, imagine a user who enters a number instead of a string. Did you check it? Will it cause your script to exit prematurely? Or will an unforeseen event occur such as the user entering <kbd class="calibre17">rm -rf /*</kbd> instead of a valid user name?</p>
<p class="mce-root">In any case, limiting program user input is also useful to you as the author because it can limit paths users take and reduce undefined behavior or bugs. Therefore, if quality assurance is important, test cases and input/output validation can be reduced.</p>


            </article>

            
        </section>
    </div>



  
<div id="sbo-rt-content" class="calibre1"><section class="calibre2">

                            <header class="calibre2">
                    <h1 class="header-title">Getting ready</h1>
                </header>
            
            <article class="calibre2">
                
<p class="mce-root">This recipe might be introducing some readers to a concept they would like to avoid: software engineering. It's true, you are probably writing scripts to quickly get a task completed, but if your script is to be used by other people (or for a long time), its great to catch errors early when they occur and prevent program misbehaviour.</p>
<div class="packt_infobox">Even without formal computer science or engineering training, the idea of use cases is based on having any particular piece of functionality, with X input, and seeing whether Y does as expected. Sometimes, limits or ranges can be imposed, an action may complete or fail, and any results compared can conclude whether the "use case" passes or fails.</div>
<p class="mce-root">Let's look at a step by step example using a program that should <kbd class="calibre17">echo</kbd> the username of the user who executed the script via a prompt:</p>
<ol class="calibre20">
<li class="chapter">The script expects input to be read into a variable using the read command (for example).</li>
<li class="chapter">The variable is assumed to be a string, but it could be the user's name, a number, a post address in a foreign country, an email, or even a malicious command.</li>
<li class="chapter">The script reads the variable and runs the <kbd class="calibre17">echo</kbd> command.</li>
<li class="chapter">The results returned could be garbage, but could also be executed by another script—what could go wrong?</li>
</ol>
<div class="packt_infobox">For example, usernames, by default, should contain alphabetic characters and numbers, but no special characters except underscores, periods, dashes, and a dollar sign (<kbd class="calibre23">$</kbd>) at the <em class="calibre26">end</em> of a name.</div>
<p class="mce-root">In all efforts, if security is not important, then the robustness of an application could be!</p>


            </article>

            
        </section>
    </div>



  
<div id="sbo-rt-content" class="calibre1"><section class="calibre2">

                            <header class="calibre2">
                    <h1 class="header-title">How to do it...</h1>
                </header>
            
            <article class="calibre2">
                
<p class="mce-root">Let's start our activity as follows:</p>
<ol class="calibre20">
<li class="chapter">Begin by opening a terminal and a new shell script called <kbd class="calibre17">bad_input.sh</kbd> with the following contents:</li>
</ol>
<pre class="calibre27">#!/bin/bash<br class="calibre2"/><br class="calibre2"/>FILE_NAME=$1<br class="calibre2"/>echo $FILE_NAME<br class="calibre2"/>ls $FILE_NAME</pre>
<ol start="2" class="calibre20">
<li class="chapter">Now, run the following commands:</li>
</ol>
<pre class="calibre27">$ touch TEST.txt<br class="calibre2"/>$ mkdir new_dir/<br class="calibre2"/>$ bash bad_input.sh "."<br class="calibre2"/>$ bash bad_input.sh "../"</pre>
<ol start="3" class="calibre20">
<li class="chapter">Create a second script called <kbd class="calibre17">better_input.sh</kbd>:</li>
</ol>
<pre class="calibre27">#!/bin/bash<br class="calibre2"/>FILE_NAME=$1<br class="calibre2"/><br class="calibre2"/># first, strip underscores<br class="calibre2"/>FILE_NAME_CLEAN=${FILE_NAME//_/}<br class="calibre2"/><br class="calibre2"/>FILE_NAME_CLEAN=$(sed 's/..//g' &lt;&lt;&lt; ${FILE_NAME_CLEAN})<br class="calibre2"/><br class="calibre2"/># next, replace spaces with underscores<br class="calibre2"/>FILE_NAME_CLEAN=${FILE_NAME_CLEAN// /_}<br class="calibre2"/><br class="calibre2"/># now, clean out anything that's not alphanumeric or an underscore<br class="calibre2"/>FILE_NAME_CLEAN=${FILE_NAME_CLEAN//[^a-zA-Z0-9_.]/}<br class="calibre2"/><br class="calibre2"/># here you should check to see if the file exists before running the command<br class="calibre2"/>ls "${FILE_NAME_CLEAN}"</pre>
<ol start="4" class="calibre20">
<li class="chapter">Next, run the script using these commands and not the output:</li>
</ol>
<pre class="calibre27">$ bash better_input.sh "."<br class="calibre2"/>$ bash better_input.sh "../"<br class="calibre2"/>$ bash better_input.sh "anyfile"</pre>
<ol start="5" class="calibre20">
<li class="chapter">Next, create a new script called <kbd class="calibre17">validate_email.sh</kbd> to validate email addresses (similarly to how one would validate DNS names):</li>
</ol>
<pre class="calibre27">#!/bin/bash<br class="calibre2"/><br class="calibre2"/>EMAIL=$1<br class="calibre2"/>echo "${EMAIL}" | grep '^[a-zA-Z0-9._]*@[a-zA-Z0-9]*\.[a-zA-Z0-9]*<br class="calibre2"/>RES=$?<br class="calibre2"/>if [ $RES -ne 1 ]; then<br class="calibre2"/>    echo "${EMAIL} is valid"<br class="calibre2"/>else<br class="calibre2"/>    echo "${EMAIL} is NOT valid"<br class="calibre2"/>fi &gt;/dev/null<br class="calibre2"/>RES=$?<br class="calibre2"/>if [ $RES -ne 1 ]; then<br class="calibre2"/>    echo "${EMAIL} is valid"<br class="calibre2"/>else<br class="calibre2"/>    echo "${EMAIL} is NOT valid"<br class="calibre2"/>fi</pre>
<ol start="6" class="calibre20">
<li class="chapter">Again, we can test the output:</li>
</ol>
<pre class="calibre27">$ bash validate_email.sh ron.brash@somedomain.com<br class="calibre2"/>ron.brash@somedomain.com is valid<br class="calibre2"/>$ bash validate_email.sh ron.brashsomedomain.com<br class="calibre2"/>ron.brashsomedomain.com is NOT valid</pre>
<ol start="7" class="calibre20">
<li class="chapter">Another common task would be to validate IP addresses. Create another script called <kbd class="calibre17">validate_ip.sh</kbd> with the following contents:</li>
</ol>
<pre class="calibre27">#!/bin/bash<br class="calibre2"/><br class="calibre2"/>IP_ADDR=$1<br class="calibre2"/>IFS=.<br class="calibre2"/>if echo "$IP_ADDR" | { read octet1 octet2 octet3 octet4 extra;<br class="calibre2"/>  [[ "$octet1" == *[[:digit:]]* ]] &amp;&amp; <br class="calibre2"/>  test "$octet1" -ge 0 &amp;&amp; test "$octet1" -le 255 &amp;&amp;<br class="calibre2"/>  [[ "$octet2" == *[[:digit:]]* ]] &amp;&amp; <br class="calibre2"/>  test "$octet2" -ge 0 &amp;&amp; test "$octet2" -le 255 &amp;&amp;<br class="calibre2"/>  [[ "$octet3" == *[[:digit:]]* ]] &amp;&amp; <br class="calibre2"/>  test "$octet3" -ge 0 &amp;&amp; test "$octet3" -le 255 &amp;&amp;<br class="calibre2"/>  [[ "$octet4" == *[[:digit:]]* ]] &amp;&amp; <br class="calibre2"/>  test "$octet4" -ge 0 &amp;&amp; test "$octet4" -le 255 &amp;&amp;<br class="calibre2"/>  test -z "$extra" 2&gt; /dev/null; }; then<br class="calibre2"/>  echo "${IP_ADDR} is valid"<br class="calibre2"/>else<br class="calibre2"/>    echo "${IP_ADDR} is NOT valid"<br class="calibre2"/>fi</pre>
<ol start="8" class="calibre20">
<li class="chapter">Try running the following commands:</li>
</ol>
<pre class="calibre27">$ bash validate_ip.sh "a.a.a.a"<br class="calibre2"/>$ bash validate_ip.sh "0.a.a.a"<br class="calibre2"/>$ bash validate_ip.sh "255.255.255.255"<br class="calibre2"/>$ bash validate_ip.sh "0.0.0.0"<br class="calibre2"/>$ bash validate_ip.sh "192.168.0.10"</pre>


            </article>

            
        </section>
    </div>



  
<div id="sbo-rt-content" class="calibre1"><section class="calibre2">

                            <header class="calibre2">
                    <h1 class="header-title">How it works...</h1>
                </header>
            
            <article class="calibre2">
                
<p class="mce-root">Let's understand our script in detail:</p>
<ol class="calibre20">
<li class="chapter">First, we begin by creating the <kbd class="calibre17">bad_input.sh</kbd> script—it takes <kbd class="calibre17">$1</kbd> (or argument 1) and runs the list or <kbd class="calibre17">ls</kbd> command.</li>
<li class="chapter">Running the following commands, we can either list everything in the directory, subdirectory, or even traverse directories backwards! This is clearly not good and security vulnerabilities have even allowed malicious hackers to traverse through a web server—the idea is to contain the input for predictable results and to control input instead of allowing everything:</li>
</ol>
<pre class="calibre27">$ touch TEST.txt<br class="calibre2"/>$ mkdir new_dir/<br class="calibre2"/>$ bash bad_input.sh "."<br class="calibre2"/>...<br class="calibre2"/>$ bash bad_input.sh "../"<br class="calibre2"/>../all the files backwards</pre>
<ol start="3" class="calibre20">
<li class="chapter">In the second script, <kbd class="calibre17">better_input.sh</kbd>, the input is sanitized by the following steps. Additionally, one could also check whether the file being listed is in fact there as well:<br class="calibre2"/>
<ol class="calibre20">
<li class="chapter">Remove any underscores (necessary).</li>
<li class="chapter">Remove any sets of double spaces.</li>
<li class="chapter">Replace spaces with underscores.</li>
<li class="chapter">Remove any non-alphanumeric values or anything else that is not an underscore.</li>
<li class="chapter">Then, run the <kbd class="calibre17">ls</kbd> command.</li>
</ol>
</li>
</ol>
<ol start="4" class="calibre20">
<li class="chapter">Next, running <kbd class="calibre17">better_input.sh</kbd> will allow us to view the current working directory or any file contained within it. Wildcards have been removed and now we cannot traverse directories.</li>
<li class="chapter">To validate the form of an email, we use the <kbd class="calibre17">grep</kbd> command combined with a regex. We are merely looking for the form of an email account name, an <kbd class="calibre17">@</kbd> symbol, and a domain name in the form of acme.x. It is important to note that we are not looking to see whether an email is truly valid or can make its way to the intended destination, but merely whether it fits what an email should look like. Additional tests such as testing the domain's MX or DNS mail records could extend this functionality to improve the likelihood of a user entering a valid email.</li>
<li class="chapter">In the next step, we test two domain names—one without the <kbd class="calibre17">@</kbd> symbol (invalid) and one with the <kbd class="calibre17">@</kbd> symbol (valid). Feel free to try several combinations.</li>
<li class="chapter">Validating an IP address is always something that could be done with a regex, but for the purpose of easy-to-use tools that get the job done, <strong class="calibre3">read</strong> and simple tests using <strong class="calibre3">test</strong> (and evaluations) will work just fine. In its basic form, an IP address consists of four octets (or in layman terms, four values separated by a period). Without exploring what a truly valid IP address is, normally a valid octet is between <kbd class="calibre17">0</kbd> and <kbd class="calibre17">255</kbd> (never more and never less). IP addresses can have various categories and classes called <strong class="calibre3">subnets</strong>.</li>
<li class="chapter">In our examples, we know that an IP address containing alphabetic characters is not a valid IP address (excluding the periods), and that the values range between <kbd class="calibre17">0</kbd> and <kbd class="calibre17">255</kbd> per octet. <kbd class="calibre17">192.168.0.x</kbd> (or <kbd class="calibre17">192.168.1.x</kbd>) is an IP subnet many people see on their home routers.</li>
</ol>


            </article>

            
        </section>
    </div>



  
<div id="sbo-rt-content" class="calibre1"><section class="calibre2">

                            <header class="calibre2">
                    <h1 class="header-title">Making a simple multi-level user menu using select</h1>
                </header>
            
            <article class="calibre2">
                
<p class="mce-root">Earlier in this book, we saw that you can make a script that uses recursive functions and conditional logic to create a simple menu. It worked, but another tool that can be used is <kbd class="calibre17">select</kbd>. Select works using a provided list (for example, it can be a wildcard selection for files) and will give you a list, such as:</p>
<pre class="calibre22">Select a file from the list:<br class="calibre2"/>1.) myfirst.file<br class="calibre2"/>2.) mysecond.file<br class="calibre2"/>You chose: mysecond.file</pre>
<p class="mce-root">Clearly, a menu such as about is very trivial; it can be useful for utility functions and for repeatable subtasks like deleting users or modifying files/archives. </p>
<div class="packt_tip">Simple select scripts could also be useful for a number of activities such as mounting a drop box, decrypting or mounting a drive, or generating administrative reports.</div>


            </article>

            
        </section>
    </div>



  
<div id="sbo-rt-content" class="calibre1"><section class="calibre2">

                            <header class="calibre2">
                    <h1 class="header-title">Getting ready</h1>
                </header>
            
            <article class="calibre2">
                
<p class="mce-root">Select is already a part of the Bash shell, but it has a few less than obvious points. Select relies on three variables:</p>
<ul class="calibre13">
<li class="calibre14"><kbd class="calibre17">PS3</kbd>: The prompt that's echoed to the user before the menu is created</li>
<li class="calibre14"><kbd class="calibre17">REPLY</kbd>: The index of the item selected from the array</li>
<li class="calibre14"><kbd class="calibre17">opt</kbd>: The value of the item selected from the array<span class="calibre11">—</span>not the index</li>
</ul>
<p class="mce-root">Technically, <kbd class="calibre17">opt</kbd> is not mandatory, but it is the value of the element being iterated by Select in our example. You could use another name and call it <strong class="calibre6">element</strong>, for example.</p>


            </article>

            
        </section>
    </div>



  
<div id="sbo-rt-content" class="calibre1"><section class="calibre2">

                            <header class="calibre2">
                    <h1 class="header-title">How to do it...</h1>
                </header>
            
            <article class="calibre2">
                
<p class="mce-root">Let's start our activity as follows:</p>
<ol class="calibre20">
<li class="chapter">Open a terminal and create a script called <kbd class="calibre17">select_menu.sh</kbd> with the following contents:</li>
</ol>
<pre class="calibre27">#!/bin/bash<br class="calibre2"/>TITLE="Select file menu"<br class="calibre2"/>PROMPT="Pick a task:"<br class="calibre2"/>OPTIONS=("list" "delete" "modify" "create")<br class="calibre2"/><br class="calibre2"/>function list_files() {<br class="calibre2"/>  PS3="Choose a file from the list or type \"back\" to go back to the main: "<br class="calibre2"/>  select OPT in *; do <br class="calibre2"/>    if [[ $REPLY -le ${#OPT[@]} ]]; then<br class="calibre2"/>      if [[ "$REPLY" == "back" ]]; then <br class="calibre2"/>        return<br class="calibre2"/>      fi<br class="calibre2"/>      echo "$OPT was selected"<br class="calibre2"/>    else<br class="calibre2"/>      list_files<br class="calibre2"/>    fi<br class="calibre2"/>  done<br class="calibre2"/>}<br class="calibre2"/><br class="calibre2"/>function main_menu() {<br class="calibre2"/>  echo "${TITLE}"<br class="calibre2"/>  PS3="${PROMPT} "<br class="calibre2"/>  select OPT in "${OPTIONS[@]}" "quit"; do <br class="calibre2"/>    case "$REPLY" in<br class="calibre2"/>      1 ) <br class="calibre2"/>        # List<br class="calibre2"/>        list_files<br class="calibre2"/>        main_menu # Recursive call to regenerate the menu<br class="calibre2"/>      ;;<br class="calibre2"/>      2 ) <br class="calibre2"/>        echo "not used"<br class="calibre2"/>      ;;<br class="calibre2"/>      3 ) <br class="calibre2"/>        echo "not used"<br class="calibre2"/>      ;;<br class="calibre2"/>      4 )<br class="calibre2"/>        echo "not used"<br class="calibre2"/>      ;;<br class="calibre2"/>      $(( ${#OPTIONS[@]}+1 )) ) echo "Exiting!"; break;;<br class="calibre2"/>      *) echo "Invalid option. Try another one.";continue;;<br class="calibre2"/>    esac<br class="calibre2"/>  done<br class="calibre2"/>}<br class="calibre2"/><br class="calibre2"/>main_menu # Enter recursive loop</pre>
<ol start="2" class="calibre20">
<li class="chapter">Execute the script using the following command:</li>
</ol>
<pre class="calibre27">$ bash select_menu.sh</pre>
<ol start="3" class="calibre20">
<li class="chapter"> Press <em class="calibre26">1</em> to enter the file list functionality. Enter the number of any files in the menu. Once satisfied, type "back" and press <em class="calibre26">Enter</em> to return to the main menu.</li>
</ol>


            </article>

            
        </section>
    </div>



  
<div id="sbo-rt-content" class="calibre1"><section class="calibre2">

                            <header class="calibre2">
                    <h1 class="header-title">How it works...</h1>
                </header>
            
            <article class="calibre2">
                
<p class="mce-root">Let's understand our script in detail:</p>
<ol class="calibre20">
<li class="chapter">Creating the <kbd class="calibre17">select_menu.sh</kbd><span class="calibre11"> </span>script was trivial, but besides the use of select, some of the concepts should look familiar: functions, return, case statements, and recursion. </li>
<li class="chapter">The script enters the menu by calling the <kbd class="calibre17">main_menu</kbd> function and then proceeds to use select to generate a menu from the <kbd class="calibre17">${OPTIONS}</kbd><strong class="calibre3"> </strong>array. The hard-coded variable named <kbd class="calibre17">PS3</kbd> will output the prompt before the menu, and <kbd class="calibre17">$REPLY</kbd> contains the index of the item selected.</li>
<li class="chapter">Pressing <em class="calibre26">1</em> and pressing <em class="calibre26">Enter</em> will cause select to walk through the items and then execute the <kbd class="calibre17">list_files</kbd> function. This function creates a submenu by using select for the second time to list all of the files in the directory. Selecting any directory will return a <kbd class="calibre17">$OPT was selected</kbd> message, but if <kbd class="calibre17">back</kbd> is entered, then the script will return from this function and call <kbd class="calibre17">main_menu</kbd> from within itself (recursion). At this point, you may select any items in the main menu.</li>
</ol>


            </article>

            
        </section>
    </div>



  
<div id="sbo-rt-content" class="calibre1"><section class="calibre2">

                            <header class="calibre2">
                    <h1 class="header-title">Generating and trapping signals for cleanup</h1>
                </header>
            
            <article class="calibre2">
                
<p class="mce-root">Throughout this book, you have probably pressed <em class="calibre18">Ctrl</em> + <em class="calibre18">C</em> or <em class="calibre18">Ctrl</em> + <em class="calibre18">Z</em> without knowing what was occurring—it's just like pressing <em class="calibre18">Ctrl</em> + <em class="calibre18">Alt</em> + <em class="calibre18">Delete</em> in another OS, right? Well, in one regard, yes—it is a signal, but the action itself is very different in Linux. A signal at the hardware level is similar to a flag or some sort of immediate notification that says <em class="calibre18">hey - something happened here</em>. If the appropriate listener is set up, that signal can execute some sort of functionality. </p>
<p class="mce-root">On the other hand, software signaling is far more flexible and we can use signals as <em class="calibre18">simple</em> notification mechanisms that are far more flexible than their hardware siblings. In Linux, <em class="calibre18">Ctrl</em> + <em class="calibre18">C</em> equates to SIGINT (program interrupt), which typically exits a program. It can be stopped, and other functionality such as cleanup can be executed. <em class="calibre18">Ctrl</em> + <em class="calibre18">Z</em> or <span class="calibre16">SIGTSTP (keyboard stop) typically tells a program to be <strong class="calibre6">suspended</strong> and pushed to the background (more about jobs in a later section), but it can also be blocked—just like SIGINT. </span></p>
<div class="packt_infobox">SIGHUP is already a signal we are familiar with<span class="calibre11">—the s</span>ame as with SIGKILL. We saw them when we used <kbd class="calibre23">disown</kbd> or exited a shell. For more information regarding signals, see the <a href="http://man7.org/linux/man-pages/man7/signal.7.html" class="calibre25 pcalibre pcalibre3 pcalibre2 pcalibre1">manual page for a great signal overview</a>.</div>


            </article>

            
        </section>
    </div>



  
<div id="sbo-rt-content" class="calibre1"><section class="calibre2">

                            <header class="calibre2">
                    <h1 class="header-title">Getting ready</h1>
                </header>
            
            <article class="calibre2">
                
<p class="mce-root">Besides using the keyboard within a program, we can also send signals to programs using the <kbd class="calibre17">kill</kbd> command. The <kbd class="calibre17">kill</kbd> command can kill programs, but these signals can also be used for reloading configurations or sending user-defined signals. The most common signals you may use are SIGHUP (1), SIGINT (2), SIGKILL(9), SIGTERM(15), SIGSTOP(17,18,23), SIGSEGV(12), and SIGUSR1(10)/SIGUSR2(12). The latter two can be defined within your program or leveraged by other developers. </p>
<p class="mce-root">The <kbd class="calibre17">kill</kbd> command can be used easily as follows:</p>
<pre class="calibre22">$ kill -s SIGUSR1 &lt;processID&gt;<br class="calibre2"/>$ kill -9 &lt;processID&gt;<br class="calibre2"/>$ kill -9 `pidof myprogram.sh`</pre>
<div class="packt_infobox">The <kbd class="calibre23">kill</kbd> command can refer to the signal number itself or by its name. It does require a process ID number to target. This can easily be found either by searching using <kbd class="calibre23">ps | grep X</kbd> or by using the preceding <kbd class="calibre23">final</kbd> using <kbd class="calibre23">pidof</kbd>.</div>


            </article>

            
        </section>
    </div>



  
<div id="sbo-rt-content" class="calibre1"><section class="calibre2">

                            <header class="calibre2">
                    <h1 class="header-title">How to do it...</h1>
                </header>
            
            <article class="calibre2">
                
<p class="mce-root">Let's start our activity as follows:</p>
<ol class="calibre20">
<li class="chapter">Open a terminal and begin a new script called <kbd class="calibre17">mytrap.sh</kbd> with the following contents:</li>
</ol>
<pre class="calibre27">#!/bin/bash<br class="calibre2"/><br class="calibre2"/>function setup() {<br class="calibre2"/>  trap "cleanup" SIGINT SIGTERM<br class="calibre2"/>  echo "PID of script is $$"<br class="calibre2"/>}<br class="calibre2"/><br class="calibre2"/>function cleanup() {<br class="calibre2"/>  echo "cleaning up"<br class="calibre2"/>  exit 1<br class="calibre2"/>}<br class="calibre2"/><br class="calibre2"/>setup<br class="calibre2"/><br class="calibre2"/># Loop forever with a noop (:)<br class="calibre2"/>while :<br class="calibre2"/>do<br class="calibre2"/>  sleep 1<br class="calibre2"/>done<br class="calibre2"/><br class="calibre2"/></pre>
<ol start="2" class="calibre20">
<li class="chapter">Execute the script with <kbd class="calibre17">$ bash mtrap.sh</kbd>.</li>
<li class="chapter">Press <em class="calibre26">Enter</em> several times and watch the behavior of the program.</li>
<li class="chapter">Press <em class="calibre26">Ctrl</em> + <em class="calibre26">C</em>; notice anything different?</li>
</ol>


            </article>

            
        </section>
    </div>



  
<div id="sbo-rt-content" class="calibre1"><section class="calibre2">

                            <header class="calibre2">
                    <h1 class="header-title">How it works...</h1>
                </header>
            
            <article class="calibre2">
                
<p class="mce-root">Let's understand our script in detail:</p>
<ol class="calibre20">
<li class="chapter">The <kbd class="calibre17">mytrap.sh</kbd> script leverages functions and the trap call. Inside of the <kbd class="calibre17">setup</kbd> function, we set the function to be called by the <kbd class="calibre17">trap</kbd> command. Therefore, when <em class="calibre26">Ctrl</em> + <em class="calibre26">C</em> is called, the <kbd class="calibre17">cleanup</kbd><strong class="calibre3"> </strong>function<strong class="calibre3"> </strong>is executed.</li>
<li class="chapter">Running the script will cause the script to run forever after printing out the PID of the script.</li>
<li class="chapter">Pressing regular keys such as <em class="calibre26">Enter</em> will not have an effect on the program.</li>
<li class="chapter">Pressing <em class="calibre26">Ctrl+</em> <em class="calibre26">C</em> will echo <kbd class="calibre17">cleanup</kbd> on the console and the script will exit using the <kbd class="calibre17">exit</kbd> command.</li>
</ol>


            </article>

            
        </section>
    </div>



  
<div id="sbo-rt-content" class="calibre1"><section class="calibre2">

                            <header class="calibre2">
                    <h1 class="header-title">Using temporary files and lock files in your program</h1>
                </header>
            
            <article class="calibre2">
                
<p class="mce-root">Another mechanism or component programs and scripts often use is called a lock file. It's usually temporary (it resides in <kbd class="calibre17">/tmp</kbd>) and is sometimes used when multiple entities rely on a single source of data or need to know that other programs exist. Sometimes, it's merely the presence of a file, a particular timestamp on a file, or another simple artifact.</p>
<p class="mce-root">There are several ways to test for the existence of a file, but one important attribute that has not been demonstrated or explored is the concept of a <strong class="calibre6">hidden</strong> file. A hidden file in Linux is not really hidden (like in Windows), but it is not usually apparently unless a particular flag or command is ran. For example, the <kbd class="calibre17">ls</kbd> command does not return hidden files among the results, but the <kbd class="calibre17">ls</kbd><strong class="calibre6"> </strong>command with the <kbd class="calibre17">-a</kbd><strong class="calibre6"> </strong>flag will (<kbd class="calibre17">-a</kbd> for all).</p>
<div class="packt_infobox">Most file explorers have hidden files that aren't visible by default. In Ubuntu, <em class="calibre26">Ctrl</em> + <em class="calibre26">H</em> inside of the file explorer toggles this feature.</div>
<p class="mce-root">To create a hidden file, a <kbd class="calibre17">.</kbd> (period) needs to be present at the beginning of a file's name:</p>
<pre class="calibre22">$ touch .myfirsthiddenfile.txt</pre>
<p class="mce-root">Besides the presence of any regular file, we can also use the <kbd class="calibre17">mktemp</kbd> command to create lock files.</p>


            </article>

            
        </section>
    </div>



  
<div id="sbo-rt-content" class="calibre1"><section class="calibre2">

                            <header class="calibre2">
                    <h1 class="header-title">Getting ready</h1>
                </header>
            
            <article class="calibre2">
                
<p class="mce-root">We briefly mentioned that temporary files can reside inside the <kbd class="calibre17">/tmp</kbd> directory. Often, <kbd class="calibre17">/tmp</kbd> is home to short lived files such as lock files or information that can be volatile (destroyed on a power event without any detriment to the system). It is also usually RAM-based, which can offer performance benefits as well, especially if used as part of an inter-process communication system (more on this later in another recipe).</p>
<p class="mce-root">However, it is important to know that other programs can access your file in <kbd class="calibre17">/tmp</kbd>, so it should be secured with the sufficient permissions. It should also be given a name that is suitably random so that a filename collision does not occur.</p>


            </article>

            
        </section>
    </div>



  
<div id="sbo-rt-content" class="calibre1"><section class="calibre2">

                            <header class="calibre2">
                    <h1 class="header-title">How to do it...</h1>
                </header>
            
            <article class="calibre2">
                
<p class="mce-root">Let's start our activity as follows:</p>
<ol class="calibre20">
<li class="chapter">Open a new terminal and create a new script by the name of <kbd class="calibre17">mylock.sh</kbd> with the following contents:</li>
</ol>
<pre class="calibre27">#!/bin.bash<br class="calibre2"/><br class="calibre2"/>LOCKFILE="/tmp/mylock"<br class="calibre2"/><br class="calibre2"/>function setup() { <br class="calibre2"/>  # $$ will provide the process ID<br class="calibre2"/>  TMPFILE="${LOCKFILE}.$$"<br class="calibre2"/>  echo "$$" &gt; "${TMPFILE}"<br class="calibre2"/>  <br class="calibre2"/>  # Now we use hard links for atomic file operations <br class="calibre2"/>  if ln "${TMPFILE}" "${LOCKFILE}" 2&gt;&amp;- ; then<br class="calibre2"/>      echo "Created tmp lock"<br class="calibre2"/>  else<br class="calibre2"/>      echo "Locked by" $(&lt;$LOCKFILE)<br class="calibre2"/>      rm "${TMPFILE}"<br class="calibre2"/>      exit 1<br class="calibre2"/>  fi<br class="calibre2"/>  trap "rm ${TMPFILE} ${LOCKFILE}" SIGINT SIGTERM SIGKILL<br class="calibre2"/>}<br class="calibre2"/><br class="calibre2"/>setup<br class="calibre2"/><br class="calibre2"/>echo "Door was left unlocked"<br class="calibre2"/><br class="calibre2"/>exit 0</pre>
<ol start="2" class="calibre20">
<li class="chapter">Execute the script with the <kbd class="calibre17">$ bash mylock.sh</kbd> script and review the console's output.</li>
<li class="chapter">Next, we know that the script is looking for a particular lock file. What happens when we create a lock file and then re-run the script?</li>
</ol>
<pre class="calibre27">$ echo "1000" &gt; /tmp/mylock<br class="calibre2"/>$ bash mylock.sh<br class="calibre2"/>$ rm /tmp/mylock<br class="calibre2"/>$ bash mylock.sh</pre>


            </article>

            
        </section>
    </div>



  
<div id="sbo-rt-content" class="calibre1"><section class="calibre2">

                            <header class="calibre2">
                    <h1 class="header-title">How it works...</h1>
                </header>
            
            <article class="calibre2">
                
<p class="mce-root">Let's understand our script in detail:</p>
<ol class="calibre20">
<li class="chapter">The <kbd class="calibre17">mylock.sh</kbd> script reuses a couple of concepts that we are already familiar with: traps and symbolic links. We know that if a trap is called or rather, it catches a particular signal, it can clean up a lock file (as is the case in this script). Symbolic links are used since they can survive atomic operations over network file systems. If a file is present at the <kbd class="calibre17">LOCKFILE</kbd> location, then a lock is present. If the <kbd class="calibre17">LOCKFILE</kbd> is absent, the doors are open.</li>
<li class="chapter">When we run <kbd class="calibre17">mylock.sh</kbd>, we will get the following because no lock file exists yet<span class="calibre11">—</span>including any temporary ones:</li>
</ol>
<pre class="calibre27">$ bash mylock.sh<br class="calibre2"/>Created tmp lock<br class="calibre2"/>Door was left unlocked</pre>
<ol start="3" class="calibre20">
<li class="chapter">Since the preceding script exited correctly, the <kbd class="calibre17">SIGKILL</kbd> signal was handled and the temporary lockfile was removed. In this case, we want to create our own lockfiles that bypass this mechanism. Create a lockfile with a faux PID of <kbd class="calibre17">1000</kbd>; running the script will return <kbd class="calibre17">Locked by 1000</kbd>, and upon deleting the lockfile, the regular behavior will occur once more (doors are unlocked). </li>
</ol>


            </article>

            
        </section>
    </div>



  
<div id="sbo-rt-content" class="calibre1"><section class="calibre2">

                            <header class="calibre2">
                    <h1 class="header-title">Leveraging timeout when waiting for command completion</h1>
                </header>
            
            <article class="calibre2">
                
<p class="mce-root">Sometimes, <span class="calibre16">waiting for a command to finish execution</span> or ignoring commands until completion might not be considered a solid practice in scripting, though it does have applications:</p>
<ul class="calibre13">
<li class="calibre14">Where commands take variable lengths of time to complete (for example, pinging a network host)</li>
<li class="calibre14">Where tasks or commands can be executed in such a way that the <em class="calibre26">master</em> script waits for the success or failure of several multiple operations</li>
</ul>
<p class="mce-root">However, the important thing to note is that timeout/wait requires a process, or even a subshell so that it can be monitored (by the Process ID or PID). In this recipe, we will demonstrate the use of waiting for a subshell with the timeout command (which was added into the coreutils package 7.0) and how to do so using trap and kill (for alarms/timers).</p>


            </article>

            
        </section>
    </div>



  
<div id="sbo-rt-content" class="calibre1"><section class="calibre2">

                            <header class="calibre2">
                    <h1 class="header-title">Getting ready</h1>
                </header>
            
            <article class="calibre2">
                
<p class="mce-root">In earlier recipes, we introduced the use of <kbd class="calibre17">trap</kbd> to catch signals, and the use of <kbd class="calibre17">kill</kbd> to send signals to processes. These will be explained further in this recipe, but here are three new native Bash variables:</p>
<ul class="calibre13">
<li class="calibre14"><span class="calibre11"><kbd class="calibre17">$$</kbd></span>: Which returns the PID of the current script</li>
<li class="calibre14"><kbd class="calibre17">$?</kbd>: W<span class="calibre11">hich returns the PID of the last job that was sent to the background</span></li>
<li class="calibre14"><kbd class="calibre17">$@</kbd> :Which returns the array of input variables (for example, <kbd class="calibre17">$!</kbd>, <kbd class="calibre17">$2</kbd>)</li>
</ul>
<div class="packt_infobox">We are skirting around the ideas of jobs, tasks, background, and foreground as they will appear again in proper detail in a later administrative recipe.</div>


            </article>

            
        </section>
    </div>



  
<div id="sbo-rt-content" class="calibre1"><section class="calibre2">

                            <header class="calibre2">
                    <h1 class="header-title">How to do it...</h1>
                </header>
            
            <article class="calibre2">
                
<p class="mce-root">We begin this recipe knowing that there is a command called <kbd class="calibre17">timeout</kbd> available to the Bash shell. However, it falls short of being able to provide the functionality of timeouts in functions within a script itself. Using <kbd class="calibre17">trap</kbd>, <kbd class="calibre17">kill</kbd>, and signals, we can set timers or <kbd class="calibre17">alarms</kbd> (<kbd class="calibre17">ALRM</kbd>) to perform clean exits from runaway functions or commands. Let's begin:</p>
<ol class="calibre20">
<li class="chapter">Open a new terminal and create a new script by the name of <kbd class="calibre17">mytimeout.sh</kbd><span class="calibre11"> </span>with the following contents:</li>
</ol>
<pre class="calibre27">#!/bin/bash<br class="calibre2"/><br class="calibre2"/>SUBPID=0<br class="calibre2"/><br class="calibre2"/>function func_timer() {<br class="calibre2"/>  trap "clean_up" SIGALRM<br class="calibre2"/>  sleep $1&amp; wait<br class="calibre2"/>  kill -s SIGALRM $$<br class="calibre2"/>}<br class="calibre2"/><br class="calibre2"/>function clean_up() {<br class="calibre2"/>  trap - ALRM<br class="calibre2"/>  kill -s SIGALRM $SUBPID<br class="calibre2"/>  kill $! 2&gt;/dev/null<br class="calibre2"/>}<br class="calibre2"/><br class="calibre2"/># Call function for timer &amp; notice we record the job's PID<br class="calibre2"/>func_timer $1&amp; SUBPID=$!<br class="calibre2"/><br class="calibre2"/># Shift the parameters to ignore $0 and $1<br class="calibre2"/>shift <br class="calibre2"/><br class="calibre2"/># Setup the trap for signals SIGALRM and SIGINT<br class="calibre2"/>trap "clean_up" ALRM INT<br class="calibre2"/><br class="calibre2"/># Execute the command passed and then wait for a signal<br class="calibre2"/>"$@" &amp; wait $!<br class="calibre2"/><br class="calibre2"/># kill the running subpid and wait before exit<br class="calibre2"/>kill -ALRM $SUBPID <br class="calibre2"/>wait $SUBPID <br class="calibre2"/>exit 0</pre>
<ol start="2" class="calibre20">
<li class="chapter">Using a command with variable times (<kbd class="calibre17">ping</kbd>), we can test <kbd class="calibre17">mytimeout.sh</kbd> using the first parameter to <kbd class="calibre17">mytimeout.sh</kbd> as the timeout variable!</li>
</ol>
<pre class="calibre27">$ bash mytimeout.sh 1 ping -c 10 google.ca<br class="calibre2"/>$ bash mytimeout.sh 10 ping -c 10 google.ca</pre>


            </article>

            
        </section>
    </div>



  
<div id="sbo-rt-content" class="calibre1"><section class="calibre2">

                            <header class="calibre2">
                    <h1 class="header-title">How it works...</h1>
                </header>
            
            <article class="calibre2">
                
<p class="mce-root">You might be asking yourself, <em class="calibre18">can I put functions to the background?</em> Absolutely<span class="calibre16">—</span>and you could even use a command called <kbd class="calibre17">export</kbd> with the -f flag (although it may not be supported in all environments). If you were to use the timeout command instead, you would have to either run ONLY the command you wish to monitor or put the function inside of a second script to be called by timeout. Clearly, this is less than optimal in some situations. In this recipe, we use signals or rather, the <kbd class="calibre17">alarm</kbd> signal, to act as a timer. When we set the alarm with a specific variable, it will raise <kbd class="calibre17">SIGALARM</kbd> once the timer expires! If the process is still alive, we merely kill it and exit the script if we haven't already exited:</p>
<ol class="calibre20">
<li class="chapter">In step 1, we create the <kbd class="calibre17">mytimeout.sh</kbd> script. It uses a few of our new primitives such as <kbd class="calibre17">$!</kbd> to monitor the PID of the function we sent to execute in the background as a job (or subshell, in this case). We <kbd class="calibre17">arm</kbd> the timer and then carry on with the execution of the script. Then, we use shift to literally <em class="calibre26">shift<strong class="calibre3"> </strong></em>the parameters passed to our script to ignore <kbd class="calibre17">$1</kbd> (or the timeout variable). Finally, we watch for <kbd class="calibre17">SIGALRM</kbd> and perform a cleanup if necessary.</li>
<li class="chapter">In step 2, <kbd class="calibre17">mytimeout.sh</kbd> is executed twice using the <kbd class="calibre17">ping</kbd> command, which is targeting <kbd class="calibre17">google.ca</kbd>. In the first instance, we use a timeout of <kbd class="calibre17">1</kbd> second, and in the second instance, we use a timeout of 10 seconds. Ping, in both cases, will perform 10 pings (for example, one ping there and back to whatever host is answering ICMP requests for the DNS entry for google.ca). The first instance will execute early, and the second allows 10 pings to execute cleanly and exit:</li>
</ol>
<pre class="calibre27">$ bash mytimeout.sh 1 ping -c 10 google.ca<br class="calibre2"/>PING google.ca (172.217.13.99) 56(84) bytes of data.<br class="calibre2"/>64 bytes from yul02s04-in-f3.1e100.net (172.217.13.99): icmp_seq=1 ttl=57 time=10.0 ms<br class="calibre2"/><br class="calibre2"/>$ bash mytimeout.sh 10 ping -c 10 google.ca<br class="calibre2"/>PING google.ca (172.217.13.99) 56(84) bytes of data.<br class="calibre2"/>64 bytes from yul02s04-in-f3.1e100.net (172.217.13.99): icmp_seq=1 ttl=57 time=11.8 ms<br class="calibre2"/>64 bytes from yul02s04-in-f3.1e100.net (172.217.13.99): icmp_seq=2 ttl=57 time=14.5 ms<br class="calibre2"/>64 bytes from yul02s04-in-f3.1e100.net (172.217.13.99): icmp_seq=3 ttl=57 time=10.8 ms<br class="calibre2"/>64 bytes from yul02s04-in-f3.1e100.net (172.217.13.99): icmp_seq=4 ttl=57 time=13.1 ms<br class="calibre2"/>64 bytes from yul02s04-in-f3.1e100.net (172.217.13.99): icmp_seq=5 ttl=57 time=12.7 ms<br class="calibre2"/>64 bytes from yul02s04-in-f3.1e100.net (172.217.13.99): icmp_seq=6 ttl=57 time=13.4 ms<br class="calibre2"/>64 bytes from yul02s04-in-f3.1e100.net (172.217.13.99): icmp_seq=7 ttl=57 time=9.15 ms<br class="calibre2"/>64 bytes from yul02s04-in-f3.1e100.net (172.217.13.99): icmp_seq=8 ttl=57 time=14.0 ms<br class="calibre2"/>64 bytes from yul02s04-in-f3.1e100.net (172.217.13.99): icmp_seq=9 ttl=57 time=12.0 ms<br class="calibre2"/>64 bytes from yul02s04-in-f3.1e100.net (172.217.13.99): icmp_seq=10 ttl=57 time=11.2 ms<br class="calibre2"/><br class="calibre2"/>--- google.ca ping statistics ---<br class="calibre2"/>10 packets transmitted, 10 received, 0% packet loss, time 9015ms<br class="calibre2"/>rtt min/avg/max/mdev = 9.155/12.307/14.520/1.545 ms</pre>
<div class="packt_infobox">Notice that google.ca could be replaced with another DNS name, but the times may vary depending on your location. Therefore, 10 PINGs may not actually have time to be executed fully.</div>


            </article>

            
        </section>
    </div>



  
<div id="sbo-rt-content" class="calibre1"><section class="calibre2">

                            <header class="calibre2">
                    <h1 class="header-title">Creating a file-in-file-out program and running processes in parallel</h1>
                </header>
            
            <article class="calibre2">
                
<p class="mce-root"><span class="calibre16">In this recipe, we use a concept called file-in-file-out (FIFO), also known as</span> <strong class="calibre6">pipes</strong><span class="calibre16">, </span><span class="calibre16">to pass along a parameter to several "worker" scripts. These workers operate in parallel (in other words, mostly independent of the master process), read an input, and execute a command. FIFOS are useful because they can reduce file system activities or input/output (IO), and data can flow directly to listeners or recipients. They are represented on the file system as files and are bidirectional—they can be read and written to at the same time.</span></p>


            </article>

            
        </section>
    </div>



  
<div id="sbo-rt-content" class="calibre1"><section class="calibre2">

                            <header class="calibre2">
                    <h1 class="header-title">Getting ready</h1>
                </header>
            
            <article class="calibre2">
                
<p class="mce-root">To create FIFOs, we use the <kbd class="calibre17">mkinfo</kbd> command to create what appears to be a file (everything is a file in Linux). This file has a special property, though, which is different than normal files and also different from the pipes we had been previously using: the pipes, in this case, can allow for multiple readers and writers!</p>
<p class="mce-root">As with any file, you can also provide permissions using the <kbd class="calibre17">-m</kbd> flag such as this: <kbd class="calibre17">-m a=rw</kbd>, or use the <kbd class="calibre17">mknod</kbd> command (this isn't covered as it requires that you use a second command called <kbd class="calibre17">chown</kbd> to change <strong class="calibre6"><kbd class="calibre17">permissions</kbd></strong> after creation).</p>


            </article>

            
        </section>
    </div>



  
<div id="sbo-rt-content" class="calibre1"><section class="calibre2">

                            <header class="calibre2">
                    <h1 class="header-title">How to do it...</h1>
                </header>
            
            <article class="calibre2">
                
<p class="mce-root">To start this exercise, we will introduce two terms: leader and follower, or master and worker. In this case, the master (the central host) will create the workers (or minions). While the recipe is a bit contrived, it should make for an easy go-to template for a simple <strong class="calibre6">named pipes</strong> or FIFO pattern. Essentially, there is a master that creates five workers, and those newly created workers echo out what is provided to them through the named pipe:</p>
<ol class="calibre20">
<li class="chapter">To get started, open a new terminal and create two new scripts: <kbd class="calibre17">master.sh</kbd> and <kbd class="calibre17">worker.sh</kbd>.</li>
<li class="chapter">In <kbd class="calibre17">master.sh</kbd>, add the following contents:</li>
</ol>
<pre class="calibre27">#!/bin/bash<br class="calibre2"/><br class="calibre2"/>FIFO_FILE=/tmp/WORK_QUEUE_FIFO<br class="calibre2"/>mkfifo "${FIFO_FILE}"<br class="calibre2"/><br class="calibre2"/>NUM_WORKERS=5<br class="calibre2"/>I=0<br class="calibre2"/>while [ $I -lt $NUM_WORKERS ]; do<br class="calibre2"/><br class="calibre2"/>  bash worker.sh "$I" &amp;<br class="calibre2"/>  I=$((I+1))<br class="calibre2"/><br class="calibre2"/>done <br class="calibre2"/><br class="calibre2"/>I=0<br class="calibre2"/>while [ $I -lt $NUM_WORKERS ]; do<br class="calibre2"/><br class="calibre2"/>  echo "$I" &gt; "${FIFO_FILE}"<br class="calibre2"/>  I=$((I+1))<br class="calibre2"/><br class="calibre2"/>done <br class="calibre2"/><br class="calibre2"/>sleep 5 <br class="calibre2"/>rm -rf "${FIFO_FILE}"<br class="calibre2"/>exit 0</pre>
<ol start="3" class="calibre20">
<li class="chapter">In <kbd class="calibre17">worker.sh</kbd>, add the following contents:</li>
</ol>
<pre class="calibre27">#!/bin/bash<br class="calibre2"/><br class="calibre2"/>FIFO_FILE=/tmp/WORK_QUEUE_FIFO<br class="calibre2"/><br class="calibre2"/>BUFFER=""<br class="calibre2"/>echo "WORKER started: $1"<br class="calibre2"/><br class="calibre2"/>while :<br class="calibre2"/>do<br class="calibre2"/><br class="calibre2"/>read BUFFER &lt; "${FIFO_FILE}"<br class="calibre2"/><br class="calibre2"/>if [ "${BUFFER}" != "" ]; then<br class="calibre2"/>  echo "Worker received: $BUFFER"<br class="calibre2"/>  exit 1<br class="calibre2"/>fi<br class="calibre2"/><br class="calibre2"/>done<br class="calibre2"/><br class="calibre2"/>exit 0</pre>
<ol start="4" class="calibre20">
<li class="chapter">In the terminal, run the following command and observe the output:</li>
</ol>
<pre class="calibre27">$ bash master.sh</pre>


            </article>

            
        </section>
    </div>



  
<div id="sbo-rt-content" class="calibre1"><section class="calibre2">

                            <header class="calibre2">
                    <h1 class="header-title">How it works...</h1>
                </header>
            
            <article class="calibre2">
                
<p class="mce-root">The idea of this recipe is that if you have several repetitive tasks such as bulk operations and potentially multiple cores, you can perform tasks in parallel (often seen in the Linux world as Jobs). This recipe creates a single master that spawns several worker scripts into the background, which await input from the named pipe. Once they read input from the named pipe, they will echo it to the screen and then exit. Eventually, the master will exit too, removing the pipe along with it:</p>
<ol class="calibre20">
<li class="chapter">In step 1, we open a new terminal and create the two scripts: <kbd class="calibre17">master.sh</kbd> and <kbd class="calibre17">worker.sh</kbd>.</li>
</ol>
<p class="mce-root"> </p>
<ol start="2" class="calibre20">
<li class="chapter">In step 2, we create the <kbd class="calibre17">master.sh</kbd> script. It uses two while loops to create <em class="calibre26">n</em> numbers of worker scripts with <kbd class="calibre17">$I</kbd> identifiers and then sends the same number of values to the FIFO before sleeping/exit.</li>
<li class="chapter">In step 3, we create the <kbd class="calibre17">worker.sh</kbd> script, which echos an initialization message and then waits until <kbd class="calibre17">$BUFFER</kbd> is not empty (NULL, as it can be sometimes referred to). Once <kbd class="calibre17">$BUFFER</kbd> is full or rather, contains a message, then it echos it to the console and the script exits.</li>
<li class="chapter">In step 4, the console should contain an output similar to the following:</li>
</ol>
<pre class="calibre27">$ bash master.sh <br class="calibre2"/>WORKER started: 0<br class="calibre2"/>WORKER started: 1<br class="calibre2"/>We got 0<br class="calibre2"/>We got 1<br class="calibre2"/>WORKER started: 4<br class="calibre2"/>We got 2<br class="calibre2"/>WORKER started: 2<br class="calibre2"/>We got 3<br class="calibre2"/>WORKER started: 3<br class="calibre2"/>We got 4<br class="calibre2"/><br class="calibre2"/></pre>
<p class="mce-root">With the two scripts working in tandem over the FIFO, a numeric value is passed between them and the workers perform their <em class="calibre18">work</em>. These values or messages could easily be modified so that the workers execute commands instead!</p>
<div class="packt_infobox"><span class="calibre11">Notice that the output can be in a different order. This is because Linux is not deterministic and spawning processes or reading from the FIFO might be blocked, or someone might get there before it (due to scheduling). Keep this in mind as the FIFO is also not atomic or synchronous—if you wish to designate which message goes to what host, you could create an identifier or messaging scheme. </span></div>


            </article>

            
        </section>
    </div>



  
<div id="sbo-rt-content" class="calibre1"><section class="calibre2">

                            <header class="calibre2">
                    <h1 class="header-title">Executing your script on startup</h1>
                </header>
            
            <article class="calibre2">
                
<p class="mce-root">This recipe is not limited to running only applications or services at startup, but to also start scripts on bootup (power on) of a system. For example, if your system boots up and you would like to apply several tweaks to the OS such as performance enhancements or battery tweaks, you can do this on startup via the <kbd class="calibre17">systemd</kbd> or <kbd class="calibre17">init.d</kbd> script. Another example could be to run a never ending script that creates logging events, like an electronic version of a pulse monitor.</p>
<p class="mce-root">In short, Linux or most *NIX systems use either the venerable <kbd class="calibre17">rc.d</kbd> system or the newer and more controversial systemd system to manage the starting and stopping of system resources. Without diving into the entire boot sequence of Linux, here is how it works:</p>
<ol class="calibre20">
<li class="chapter">The Linux kernel is loaded and mounts the root filesystem.</li>
<li class="chapter">The rootfile system contains a shell at a particular path (the init level).</li>
<li class="chapter">Then, the systemd works its way through a series of services to start (the run level).</li>
</ol>
<p class="mce-root">If a service or script is added, it will likely be added at the <strong class="calibre6">run level</strong>. It can also be started, stopped, reloaded, and restarted from the command line at any time as well. When the system is booting, it merely uses the start functionality provided by the <kbd class="calibre17">init.d</kbd> or <kbd class="calibre17">system.d</kbd> script. However, even though the semantics of either the rc.d or systemd system differ, they still require the following:</p>
<ul class="calibre13">
<li class="calibre14">Scripts or services need to be enabled for specific system startup levels.</li>
<li class="calibre14">Scripts to be started and/or stopped can be configured to be started in a specific order.</li>
<li class="calibre14">Directives for starting (at a minimum), stopping, restarting and/or reloading are executed based on a parameter when executing one of these actions (or blocks). Any number of commands can also be executed when calling start, for example.</li>
</ul>
<div class="packt_infobox">You may notice when scouring the web when looking for resources that a number of init systems exist: upstart, <span class="calibre11">SysVinit, rc.d, procd, and the list goes on. You can refer to your <span class="calibre11">distribution</span> documentation for a current explanation on the startup system in use.</span></div>


            </article>

            
        </section>
    </div>



  
<div id="sbo-rt-content" class="calibre1"><section class="calibre2">

                            <header class="calibre2">
                    <h1 class="header-title">Getting ready</h1>
                </header>
            
            <article class="calibre2">
                
<p class="mce-root">In Ubuntu 16.04 LTS (and other distributions), use systemd. Knowledge of both the init.d and systemd service control systems is certainly worth having as many embedded systems use Busybox. BusyBox uses the init.d system instead of systemd.</p>
<p class="mce-root">Before diving into the "how to do it" section, we are going to create a template init script for posterity and awareness should you run into them. It will be called <kbd class="calibre17">myscript</kbd> and it will run <kbd class="calibre17">myscript.sh</kbd>. At a minimum, a system.d compatible script looks like the following:</p>
<pre class="calibre22">#!/bin/sh<br class="calibre2"/>### BEGIN INIT INFO<br class="calibre2"/># Provides: myscript<br class="calibre2"/># Required-Start: $local_fs<br class="calibre2"/># Required-Stop: $local_fs<br class="calibre2"/># Default-Start: 2 3 4 5<br class="calibre2"/># Default-Stop: 0 1 6<br class="calibre2"/># Short-Description: Start script or daemons example<br class="calibre2"/>### END INIT INFO<br class="calibre2"/><br class="calibre2"/>PATH=/sbin:/bin:/usr/sbin:/usr/bin<br class="calibre2"/>DAEMON_NAME=myscript.sh<br class="calibre2"/>DESC=myscript<br class="calibre2"/><br class="calibre2"/>DAEMON=/usr/sbin/$DAEMON_NAME<br class="calibre2"/><br class="calibre2"/>case $1 in<br class="calibre2"/>  start)<br class="calibre2"/>  log_daemon_msg "Starting $DESC"<br class="calibre2"/>  $DAEMON_NAME<br class="calibre2"/>  log_end_msg 0<br class="calibre2"/>  ;;<br class="calibre2"/>  stop)<br class="calibre2"/>  log_daemon_msg "Stopping $DESC"<br class="calibre2"/>  killall $DAEMON_NAME<br class="calibre2"/>  log_end_msg 0<br class="calibre2"/>  ;;<br class="calibre2"/>  restart|force-reload)<br class="calibre2"/>  $0 stop<br class="calibre2"/>  sleep 1<br class="calibre2"/>  $0 start<br class="calibre2"/>  ;;<br class="calibre2"/>  status)<br class="calibre2"/>  status_of_proc "$DAEMON" "$DESC" &amp;&amp; exit 0 || exit $?<br class="calibre2"/>  ;;<br class="calibre2"/>  *)<br class="calibre2"/>  N=/etc/init.d/$DESC<br class="calibre2"/>  echo "Usage: $N {start|stop|restart|force-reload|status}" &gt;&amp;2<br class="calibre2"/>  exit 1<br class="calibre2"/>  ;;<br class="calibre2"/>esac<br class="calibre2"/><br class="calibre2"/>exit 0<br class="calibre2"/><br class="calibre2"/># vim:noet</pre>
<p class="mce-root">The content should be fairly easy to read if you have worked through the cookbook until this point. It relies on the comments in the header to determine the name, run levels, orders, and dependencies. Below that, it uses a switch statement while looking for several predetermined/standardized parameters: start, stop, restart, force-reload, and status. Inside of the start case, we start the binary, and in the stop case, we use the <kbd class="calibre17">killall</kbd> function to stop the binary.</p>
<p class="mce-root">It is important to know that the mere installation of an init script does not guarantee execution on startup. There is a process to <strong class="calibre6">enable</strong> the service or script. In the older system (SysV), you may have heard/seen of the command <kbd class="calibre17">chkconfig</kbd> being used. In systemd, you may use the <kbd class="calibre17">systemctl</kbd> command to enable/disable a service. In this section, we are only going to focus on systemd.</p>
<div class="packt_tip"><span class="calibre11">SysV executes the scripts in sequential order based on their number in the filename (for example, <kbd class="calibre23">S99-myinit</kbd>). Systemd does not because it also reviews <span class="calibre11">dependencies</span> and waits for their completion.</span></div>


            </article>

            
        </section>
    </div>



  
<div id="sbo-rt-content" class="calibre1"><section class="calibre2">

                            <header class="calibre2">
                    <h1 class="header-title">How to do it...</h1>
                </header>
            
            <article class="calibre2">
                
<p class="mce-root">Let's start our activity as follows:</p>
<ol class="calibre20">
<li class="chapter">Create a script called <kbd class="calibre17">myscript.sh</kbd> with the following contents:</li>
</ol>
<pre class="calibre27">#!/bin/bash<br class="calibre2"/><br class="calibre2"/>for (( ; ; ))<br class="calibre2"/>do<br class="calibre2"/>   sleep 1<br class="calibre2"/>done</pre>
<ol start="2" class="calibre20">
<li class="chapter">Next, let's add the correct permissions to the script so that we can create a systemd service using it. Notice the use of the <kbd class="calibre17">sudo</kbd><strong class="calibre3"> </strong>command<span class="calibre11">—</span>enter your password where appropriate:</li>
</ol>
<pre class="calibre27">$ sudo cp myscript.sh /usr/bin<br class="calibre2"/>$ sudo chmod a+x /usr/bin/myscript.sh</pre>
<ol start="3" class="calibre20">
<li class="chapter">Now that we have something to execute on start, we need to create a service configuration file to describe our service; we used <kbd class="calibre17">vi</kbd> in this example and <kbd class="calibre17">sudo</kbd> (note down its location):</li>
</ol>
<pre class="calibre27">$ sudo vi /etc/systemd/system/myscript.service <br class="calibre2"/>[Unit]<br class="calibre2"/>Description=myscript<br class="calibre2"/><br class="calibre2"/>[Service]<br class="calibre2"/>ExecStart=/usr/bin/myscript.sh<br class="calibre2"/><span class="calibre11">ExecStop=killall myscript.sh<br class="calibre2"/></span><br class="calibre2"/>[Install]<br class="calibre2"/>WantedBy=multi-user.target</pre>
<ol start="4" class="calibre20">
<li class="chapter">To enable the <kbd class="calibre17">myscript</kbd> service, run the following command:</li>
</ol>
<pre class="calibre27">$ sudo systemctl enable myscript # disable instead of enable will disable the service</pre>
<ol start="5" class="calibre20">
<li class="chapter">To start and verify the presence of the process, run the following command:</li>
</ol>
<pre class="calibre27">$ sudo systemctl start myscript<br class="calibre2"/>$ sudo systemctl status myscript</pre>
<ol start="6" class="calibre20">
<li class="chapter"> You may reboot the system to see our service in action on startup.</li>
</ol>


            </article>

            
        </section>
    </div>



  
<div id="sbo-rt-content" class="calibre1"><section class="calibre2">

                            <header class="calibre2">
                    <h1 class="header-title">How it works...</h1>
                </header>
            
            <article class="calibre2">
                
<p class="mce-root">Let's understand our script in detail:</p>
<ol start="1" class="calibre20">
<li class="chapter">In step 1, we create a trivial looping program to be ran at system startup called <kbd class="calibre17">myscript.sh</kbd>.</li>
<li class="chapter">In step 2, we copy the script to the <kbd class="calibre17">/usr/bin</kbd> directory and add permissions using the <kbd class="calibre17">chmod</kbd> command for everyone to be able to execute the script (<kbd class="calibre17">chmod a+x myscript.sh</kbd>). Notice the use of <kbd class="calibre17">sudo</kbd> permissions to create a file in this directory and to apply permissions.</li>
<li class="chapter">In the third step, we create the service configuration file, which describes a service unit for systemd. It goes by the name of <kbd class="calibre17">myscript</kbd> and within the <kbd class="calibre17">[Service]</kbd> directive, the two most important parameters are present: <kbd class="calibre17">ExecStart</kbd> and <kbd class="calibre17">ExecStop</kbd>. Notice that the start and stop sections look similar to the SysV/init.d approach.</li>
</ol>
<p class="mce-root"> </p>
<ol start="4" class="calibre20">
<li class="chapter">Next, we use the <kbd class="calibre17">systemctl</kbd> command to enable <kbd class="calibre17">myscript</kbd>. Conversely, it can be used in the following way to disable <kbd class="calibre17">myscript:</kbd> <kbd class="calibre17"><span class="calibre11">$systemctl disable myscript<kbd class="calibre29">.</kbd></span></kbd></li>
<li class="chapter">Then, we use <kbd class="calibre17">systemctl</kbd> to start <kbd class="calibre17">myscript</kbd> and verify the status of our script. You should get a similar output to the following (notice that we double checked the presence using <kbd class="calibre17">ps</kbd>):</li>
</ol>
<pre class="calibre27">$ sudo systemctl status myscript<br class="calibre2"/>myscript.service - myscript<br class="calibre2"/>   Loaded: loaded (/etc/systemd/system/myscript.service; enabled; vendor preset:<br class="calibre2"/>   Active: active (running) since Tue 2017-12-26 14:28:51 EST; 6min ago<br class="calibre2"/> Main PID: 17966 (myscript.sh)<br class="calibre2"/>   CGroup: /system.slice/myscript.service<br class="calibre2"/>           ├─17966 /bin/bash /usr/bin/myscript.sh<br class="calibre2"/>           └─18600 sleep 1<br class="calibre2"/><br class="calibre2"/>Dec 26 14:28:51 moon systemd[1]: Started myscript.<br class="calibre2"/>$ ps aux | grep myscript<br class="calibre2"/>root 17966 0.0 0.0 20992 3324 ? Ss 14:28 0:00 /bin/bash /usr/bin/myscript.sh<br class="calibre2"/>rbrash 18608 0.0 0.0 14228 1016 pts/20 S+ 14:35 0:00 grep --color=auto myscript</pre>
<ol start="6" class="calibre20">
<li class="chapter">On reboot, if enable was set, our script will be running as expected.</li>
</ol>


            </article>

            
        </section>
    </div>



  </body></html>