<html><head></head><body>
        <section class="calibre1">

            <header class="calibre1">
                </header><h1 class="header-title" id="calibre_pb_0">Using Python to Build and Manage KVM Instances</h1>
            

            <article class="calibre1">
                
<p class="calibre3">In this chapter, we are going to cover the following topics:</p>
<ul class="calibre16">
<li class="calibre17">Installing and using the Python libvirt library</li>
<li class="calibre17">Defining KVM instances with Python</li>
<li class="calibre17">Starting, stopping, and deleting KVM instances with Python</li>
<li class="calibre17">Inspecting KVM instances with Python</li>
<li class="calibre17">Building a simple REST API server with libvirt and bottle</li>
</ul>


            </article>

            <footer class="calibre5">
                
            </footer>

        </section>
    

        <section class="calibre1">

            <header class="calibre1">
                </header><h1 class="header-title" id="calibre_pb_0">Introduction</h1>
            

            <article class="calibre1">
                
<p class="calibre3">The <kbd class="calibre13">libvirt</kbd> library exposes a virtualization agnostic interface for controlling the full lifecycle of KVM (and other technologies, such as XEN and LXC) instances. Using the Python bindings we can define, start, destroy, and delete virtual guests, along with anything else the <kbd class="calibre13">virsh</kbd> userspace tool implements. In fact, we can see that the <kbd class="calibre13">virsh</kbd> command uses various libvirt shared libraries, by running:</p>
<pre class="calibre23">
<strong class="calibre4">root@kvm:~# ldd /usr/bin/virsh | grep libvirt</strong><br class="calibre7"/><strong class="calibre4">libvirt-lxc.so.0 =&gt; /usr/lib/x86_64-linux-gnu/libvirt-lxc.so.0 (0x00007fd050d88000)</strong><br class="calibre7"/><strong class="calibre4">libvirt-qemu.so.0 =&gt; /usr/lib/x86_64-linux-gnu/libvirt-qemu.so.0 (0x00007fd050b84000)</strong><br class="calibre7"/><strong class="calibre4">libvirt.so.0 =&gt; /usr/lib/x86_64-linux-gnu/libvirt.so.0 (0x00007fd050394000)</strong><br class="calibre7"/><strong class="calibre4">root@kvm:~#</strong>
</pre>
<p class="calibre3">The Python libvirt module, also provides methods to monitor and report the use of CPU, memory, storage, and network resources on the hypervisor node and other capabilities depending on the type of hypervisor driver in use.</p>
<p class="calibre3">In this chapter, we are going to use a small subset of the Python libvirt API to define, start, inspect, and stop a KVM instance.</p>
<div class="packt_infobox">For a complete list of functions, classes, and methods that the Python libvirt module provides, execute:<br class="calibre34"/>
<kbd class="calibre27">root@kvm:~# pydoc libvirt</kbd></div>


            </article>

            <footer class="calibre5">
                
            </footer>

        </section>
    

        <section class="calibre1">

            <header class="calibre1">
                </header><h1 class="header-title" id="calibre_pb_0">Installing and using the Python libvirt library</h1>
            

            <article class="calibre1">
                
<p class="calibre3">In this recipe we are going to install the Python libvirt module and its dependencies, create a new virtual environment, and install the <kbd class="calibre13">iPython</kbd> command shell for interactive computing.</p>


            </article>

            <footer class="calibre5">
                
            </footer>

        </section>
    

        <section class="calibre1">

            <header class="calibre1">
                </header><h1 class="header-title" id="calibre_pb_0">Getting ready</h1>
            

            <article class="calibre1">
                
<p class="calibre3">For this recipe we are going to need the following:</p>
<ul class="calibre16">
<li class="calibre17">An Ubuntu host, with libvirt and QEMU installed and configured</li>
<li class="calibre17">The <kbd class="calibre13">debian.img</kbd> raw image file we built in the <em class="calibre22">Installing custom OS on the image with debootstrap</em> recipe from <a target="_blank" href="part0026.html#OPEK0-c1e587dcccb14690b55c247c1809e6ce" class="calibre8">Chapter 1</a>, <em class="calibre22">Getting Started with QEMU and KVM</em></li>
<li class="calibre17">The Python 2.7 interpreter, usually provided by the <kbd class="calibre13">python2.7</kbd> package</li>
</ul>


            </article>

            <footer class="calibre5">
                
            </footer>

        </section>
    

        <section class="calibre1">

            <header class="calibre1">
                </header><h1 class="header-title" id="calibre_pb_0">How to do it...</h1>
            

            <article class="calibre1">
                
<p class="calibre3">To install the Python libvirt module, the <kbd class="calibre13">iPython</kbd> utility,<span> and to create a new virtual environment for our tests, follow these steps:</span></p>
<ol class="calibre18">
<li value="1" class="calibre17"><span>Install the Python development packages </span><kbd class="calibre13">pip</kbd><span> and</span> <kbd class="calibre13">virtualenv</kbd><span>:</span></li>
</ol>
<pre class="calibre25">
<strong class="calibre4">root@kvm:~# apt-get install python-pip python-dev pkg-config build-essential autoconf libvirt-dev</strong><br class="calibre7"/><strong class="calibre4">root@kvm:~# pip install virtualenv</strong><br class="calibre7"/><strong class="calibre4">Downloading/unpacking virtualenv</strong><br class="calibre7"/><strong class="calibre4"> Downloading virtualenv-15.1.0-py2.py3-none-any.whl (1.8MB): 1.8MB downloaded</strong><br class="calibre7"/><strong class="calibre4">Installing collected packages: virtualenv</strong><br class="calibre7"/><strong class="calibre4">Successfully installed virtualenv</strong><br class="calibre7"/><strong class="calibre4">Cleaning up...</strong><br class="calibre7"/><strong class="calibre4">root@kvm:~#</strong>
</pre>
<ol start="2" class="calibre18">
<li value="2" class="calibre17">Create a new Python virtual environment and activate it:</li>
</ol>
<pre class="calibre25">
<strong class="calibre4">root@kvm:~# mkdir kvm_python</strong><br class="calibre7"/><strong class="calibre4">root@kvm:~# virtualenv kvm_python/</strong><br class="calibre7"/><strong class="calibre4">New python executable in /root/kvm_python/bin/python</strong><br class="calibre7"/><strong class="calibre4">Installing setuptools, pip, wheel...done.</strong><br class="calibre7"/><strong class="calibre4">root@kvm:~# source kvm_python/bin/activate</strong><br class="calibre7"/><strong class="calibre4">(kvm_python) root@kvm:~# cd kvm_python/</strong><br class="calibre7"/><strong class="calibre4">(kvm_python) root@kvm:~/kvm_python# ls -la</strong><br class="calibre7"/><strong class="calibre4">total 28</strong><br class="calibre7"/><strong class="calibre4">drwxr-xr-x 6 root root 4096 May 9 17:28 .</strong><br class="calibre7"/><strong class="calibre4">drwx------ 8 root root 4096 May 9 17:28 ..</strong><br class="calibre7"/><strong class="calibre4">drwxr-xr-x 2 root root 4096 May 9 17:28 bin</strong><br class="calibre7"/><strong class="calibre4">drwxr-xr-x 2 root root 4096 May 9 17:28 include</strong><br class="calibre7"/><strong class="calibre4">drwxr-xr-x 3 root root 4096 May 9 17:28 lib</strong><br class="calibre7"/><strong class="calibre4">drwxr-xr-x 2 root root 4096 May 9 17:28 local</strong><br class="calibre7"/><strong class="calibre4">-rw-r--r-- 1 root root 60 May 9 17:28 pip-selfcheck.json</strong><br class="calibre7"/><strong class="calibre4">(kvm_python) root@kvm:~/kvm_python#</strong>
</pre>
<ol start="3" class="calibre18">
<li value="3" class="calibre17">Install the libvirt module:</li>
</ol>
<pre class="calibre25">
<strong class="calibre4">(kvm_python) root@kvm:~/kvm_python# pip install libvirt-python</strong><br class="calibre7"/><strong class="calibre4">Collecting libvirt-python</strong><br class="calibre7"/><strong class="calibre4"> Using cached libvirt-python-3.3.0.tar.gz</strong><br class="calibre7"/><strong class="calibre4">Building wheels for collected packages: libvirt-python</strong><br class="calibre7"/><strong class="calibre4"> Running setup.py bdist_wheel for libvirt-python ... done</strong><br class="calibre7"/><strong class="calibre4"> Stored in directory: /root/.cache/pip/wheels/67/f0/5c/c939bf8fcce5387a36efca53eab34ba8e94a28f244fd1757c1</strong><br class="calibre7"/><strong class="calibre4">Successfully built libvirt-python</strong><br class="calibre7"/><strong class="calibre4">Installing collected packages: libvirt-python</strong><br class="calibre7"/><strong class="calibre4">Successfully installed libvirt-python-3.3.0</strong><br class="calibre7"/><strong class="calibre4">(kvm_python) root@kvm:~/kvm_python# pip freeze</strong><br class="calibre7"/><strong class="calibre4">appdirs==1.4.3</strong><br class="calibre7"/><strong class="calibre4">libvirt-python==3.3.0</strong><br class="calibre7"/><strong class="calibre4">packaging==16.8</strong><br class="calibre7"/><strong class="calibre4">pyparsing==2.2.0</strong><br class="calibre7"/><strong class="calibre4">six==1.10.0</strong><br class="calibre7"/><strong class="calibre4">(kvm_python) root@kvm:~/kvm_python# python --version</strong><br class="calibre7"/><strong class="calibre4">Python 2.7.6</strong><br class="calibre7"/><strong class="calibre4">(kvm_python) root@kvm:~/kvm_python#</strong>
</pre>
<ol start="4" class="calibre18">
<li value="4" class="calibre17">Install <kbd class="calibre13">iPython</kbd> and start it:</li>
</ol>
<pre class="calibre25">
<strong class="calibre4">(kvm_python) root@kvm:~/kvm_python# apt-get install ipython</strong><br class="calibre7"/><strong class="calibre4">...</strong><br class="calibre7"/><strong class="calibre4">(kvm_python) root@kvm:~/kvm_python# ipython</strong><br class="calibre7"/><strong class="calibre4">Python 2.7.6 (default, Oct 26 2016, 20:30:19)</strong><br class="calibre7"/><strong class="calibre4">Type "copyright", "credits" or "license" for more information.</strong><br class="calibre7"/><br class="calibre7"/><strong class="calibre4">IPython 1.2.1 -- An enhanced Interactive Python.</strong><br class="calibre7"/><strong class="calibre4">? -&gt; Introduction and overview of IPython's features.</strong><br class="calibre7"/><strong class="calibre4">%quickref -&gt; Quick reference.</strong><br class="calibre7"/><strong class="calibre4">help -&gt; Python's own help system.</strong><br class="calibre7"/><strong class="calibre4">object? -&gt; Details about 'object', use 'object??' for extra details.</strong><br class="calibre7"/><br class="calibre7"/><strong class="calibre4">In [1]:</strong>
</pre>


            </article>

            <footer class="calibre5">
                
            </footer>

        </section>
    

        <section class="calibre1">

            <header class="calibre1">
                </header><h1 class="header-title" id="calibre_pb_0">How it works...</h1>
            

            <article class="calibre1">
                
<p class="calibre3">We start by installing the dependency packages in step 1. Since we are going to use a Python virtual environment for our development, we install the <kbd class="calibre13">virtualenv</kbd> package as well. The Python libvirt module is going to be installed in the virtual environment with the <kbd class="calibre13">pip</kbd> package manager, since we don't want to pollute the host with extra packages.</p>
<p class="calibre3">In step 2, we create and activate a new Python virtual environment and install the Python libvirt module in step 3.</p>
<p class="calibre3">Finally in step 4, we install and start the <kbd class="calibre13">iPython</kbd> development tool, which we are going to use throughout this chapter.</p>


            </article>

            <footer class="calibre5">
                
            </footer>

        </section>
    

        <section class="calibre1">

            <header class="calibre1">
                </header><h1 class="header-title" id="calibre_pb_0">Defining KVM instances with Python</h1>
            

            <article class="calibre1">
                
<p class="calibre3">In this recipe we are going to define a new KVM instance using the Python libvirt module we installed in the previous recipe. We are going to use a virtual environment and the <kbd class="calibre13">iPython</kbd> development tool for the following examples.</p>


            </article>

            <footer class="calibre5">
                
            </footer>

        </section>
    

        <section class="calibre1">

            <header class="calibre1">
                </header><h1 class="header-title" id="calibre_pb_0">Getting ready</h1>
            

            <article class="calibre1">
                
<p class="calibre3">For this recipe we are going to need the following:</p>
<ul class="calibre16">
<li class="calibre17">An Ubuntu host, with libvirt and QEMU installed and configured</li>
<li class="calibre17">The <kbd class="calibre13">debian.img</kbd> raw image file we built in the <em class="calibre22">Installing custom OS on the image with debootstrap</em> recipe from <a target="_blank" href="part0026.html#OPEK0-c1e587dcccb14690b55c247c1809e6ce" class="calibre8">Chapter 1</a>, <em class="calibre22">Getting Started with QEMU and KVM</em></li>
<li class="calibre17">Python 2.7, the <kbd class="calibre13">iPython</kbd> tool, and the virtual environment we created in the <em class="calibre22">Installing and using the Python libvirt library</em> recipe in this chapter</li>
</ul>


            </article>

            <footer class="calibre5">
                
            </footer>

        </section>
    

        <section class="calibre1">

            <header class="calibre1">
                </header><h1 class="header-title" id="calibre_pb_0">How to do it...</h1>
            

            <article class="calibre1">
                
<p class="calibre3">To define a new KVM instance, using the Python libvirt module follow these instructions:</p>
<ol class="calibre18">
<li value="1" class="calibre17"><span>In the iPython interpreter, import the</span> <kbd class="calibre13">libvirt</kbd> <span>module:</span></li>
</ol>
<pre class="calibre25">
In [1]: import libvirt<br class="calibre7"/><br class="calibre7"/>In [2]:
</pre>
<ol start="2" class="calibre18">
<li value="2" class="calibre17">Create the instance definition string:</li>
</ol>
<pre class="calibre25">
In [2]: xmlconfig = """<br class="calibre7"/>&lt;domain type='kvm' id='1'&gt;<br class="calibre7"/> &lt;name&gt;kvm_python&lt;/name&gt;<br class="calibre7"/> &lt;memory unit='KiB'&gt;1048576&lt;/memory&gt;<br class="calibre7"/> &lt;currentMemory unit='KiB'&gt;1048576&lt;/currentMemory&gt;<br class="calibre7"/> &lt;vcpu placement='static'&gt;1&lt;/vcpu&gt;<br class="calibre7"/> &lt;resource&gt;<br class="calibre7"/>   &lt;partition&gt;/machine&lt;/partition&gt;<br class="calibre7"/> &lt;/resource&gt;<br class="calibre7"/> &lt;os&gt;<br class="calibre7"/>   &lt;type arch='x86_64' machine='pc-i440fx-trusty'&gt;hvm&lt;/type&gt;<br class="calibre7"/>   &lt;boot dev='hd'/&gt;<br class="calibre7"/> &lt;/os&gt;<br class="calibre7"/> &lt;features&gt;<br class="calibre7"/>   &lt;acpi/&gt;<br class="calibre7"/>   &lt;apic/&gt;<br class="calibre7"/>   &lt;pae/&gt;<br class="calibre7"/> &lt;/features&gt;<br class="calibre7"/> &lt;clock offset='utc'/&gt;<br class="calibre7"/> &lt;on_poweroff&gt;destroy&lt;/on_poweroff&gt;<br class="calibre7"/> &lt;on_reboot&gt;restart&lt;/on_reboot&gt;<br class="calibre7"/> &lt;on_crash&gt;restart&lt;/on_crash&gt;<br class="calibre7"/> &lt;devices&gt;<br class="calibre7"/>   &lt;emulator&gt;/usr/bin/qemu-system-x86_64&lt;/emulator&gt;<br class="calibre7"/>   &lt;disk type='file' device='disk'&gt;<br class="calibre7"/>     &lt;driver name='qemu' type='raw'/&gt;<br class="calibre7"/>     &lt;source file='/tmp/debian.img'/&gt;<br class="calibre7"/>     &lt;backingStore/&gt;<br class="calibre7"/>     &lt;target dev='hda' bus='ide'/&gt;<br class="calibre7"/>     &lt;alias name='ide0-0-0'/&gt;<br class="calibre7"/>     &lt;address type='drive' controller='0' bus='0' target='0' unit='0'/&gt;<br class="calibre7"/>   &lt;/disk&gt;<br class="calibre7"/>   &lt;controller type='usb' index='0'&gt;<br class="calibre7"/>     &lt;alias name='usb'/&gt;<br class="calibre7"/>     &lt;address type='pci' domain='0x0000' bus='0x00' slot='0x01' function='0x2'/&gt;<br class="calibre7"/>   &lt;/controller&gt;<br class="calibre7"/>   &lt;controller type='pci' index='0' model='pci-root'&gt;<br class="calibre7"/>     &lt;alias name='pci.0'/&gt;<br class="calibre7"/>   &lt;/controller&gt;<br class="calibre7"/>   &lt;controller type='ide' index='0'&gt;<br class="calibre7"/>     &lt;alias name='ide'/&gt;<br class="calibre7"/>     &lt;address type='pci' domain='0x0000' bus='0x00' slot='0x01' function='0x1'/&gt;<br class="calibre7"/>   &lt;/controller&gt;<br class="calibre7"/>   &lt;interface type='network'&gt;<br class="calibre7"/>     &lt;mac address='52:54:00:da:02:01'/&gt;<br class="calibre7"/>     &lt;source network='default' bridge='virbr0'/&gt;<br class="calibre7"/>     &lt;target dev='vnet0'/&gt;<br class="calibre7"/>     &lt;model type='rtl8139'/&gt;<br class="calibre7"/>     &lt;alias name='net0'/&gt;<br class="calibre7"/>     &lt;address type='pci' domain='0x0000' bus='0x00' slot='0x03' function='0x0'/&gt;<br class="calibre7"/>   &lt;/interface&gt;<br class="calibre7"/>   &lt;serial type='pty'&gt;<br class="calibre7"/>     &lt;source path='/dev/pts/5'/&gt;<br class="calibre7"/>     &lt;target port='0'/&gt;<br class="calibre7"/>     &lt;alias name='serial0'/&gt;<br class="calibre7"/>   &lt;/serial&gt;<br class="calibre7"/>   &lt;console type='pty' tty='/dev/pts/5'&gt;<br class="calibre7"/>     &lt;source path='/dev/pts/5'/&gt;<br class="calibre7"/>     &lt;target type='serial' port='0'/&gt;<br class="calibre7"/>     &lt;alias name='serial0'/&gt;<br class="calibre7"/>   &lt;/console&gt;<br class="calibre7"/>   &lt;input type='mouse' bus='ps2'/&gt;<br class="calibre7"/>   &lt;input type='keyboard' bus='ps2'/&gt;<br class="calibre7"/>   &lt;graphics type='vnc' port='5900' autoport='yes' listen='0.0.0.0'&gt;<br class="calibre7"/>     &lt;listen type='address' address='0.0.0.0'/&gt;<br class="calibre7"/>   &lt;/graphics&gt;<br class="calibre7"/>   &lt;video&gt;<br class="calibre7"/>     &lt;model type='cirrus' vram='16384' heads='1'/&gt;<br class="calibre7"/>     &lt;alias name='video0'/&gt;<br class="calibre7"/>     &lt;address type='pci' domain='0x0000' bus='0x00' slot='0x02' function='0x0'/&gt;<br class="calibre7"/>   &lt;/video&gt;<br class="calibre7"/>   &lt;memballoon model='virtio'&gt;<br class="calibre7"/>     &lt;alias name='balloon0'/&gt;<br class="calibre7"/>     &lt;address type='pci' domain='0x0000' bus='0x00' slot='0x04' function='0x0'/&gt;<br class="calibre7"/>   &lt;/memballoon&gt;<br class="calibre7"/> &lt;/devices&gt;<br class="calibre7"/>&lt;/domain&gt;<br class="calibre7"/>"""<br class="calibre7"/><br class="calibre7"/>In [3]:
</pre>
<ol start="3" class="calibre18">
<li value="3" class="calibre17">Obtain a connection to the hypervisor:</li>
</ol>
<pre class="calibre25">
In [3]: conn = libvirt.open('qemu:///system')<br class="calibre7"/><br class="calibre7"/>In [4]:
</pre>
<ol start="4" class="calibre18">
<li value="4" class="calibre17">Define the new instance without starting it:</li>
</ol>
<pre class="calibre25">
In [4]: instance = conn.defineXML(xmlconfig)<br class="calibre7"/><br class="calibre7"/>In [5]:
</pre>
<ol start="5" class="calibre18">
<li value="5" class="calibre17">List the defined instances on the host:</li>
</ol>
<pre class="calibre25">
In [5]: instances = conn.listDefinedDomains()<br class="calibre7"/><br class="calibre7"/>In [6]: print 'Defined instances: {}'.format(instances)<br class="calibre7"/>Defined instances: ['kvm_python']<br class="calibre7"/><br class="calibre7"/>In [7]:
</pre>
<ol start="6" class="calibre18">
<li value="6" class="calibre17">Ensure the instance has been defined, using the <kbd class="calibre13">virsh</kbd> command:</li>
</ol>
<pre class="calibre25">
<strong class="calibre4">(kvm_python) root@kvm:~/kvm_python# virsh list --all</strong><br class="calibre7"/><strong class="calibre4"> Id  Name        State</strong><br class="calibre7"/><strong class="calibre4">----------------------------------------------------</strong><br class="calibre7"/><strong class="calibre4"> -   kvm_python  shut off</strong><br class="calibre7"/><br class="calibre7"/><strong class="calibre4">(kvm_python) root@kvm:~/kvm_python#</strong>
</pre>


            </article>

            <footer class="calibre5">
                
            </footer>

        </section>
    

        <section class="calibre1">

            <header class="calibre1">
                </header><h1 class="header-title" id="calibre_pb_0">How it works...</h1>
            

            <article class="calibre1">
                
<p class="calibre3">In this recipe, we are using the pre-existing raw Debian image we created in <a target="_blank" href="part0026.html#OPEK0-c1e587dcccb14690b55c247c1809e6ce" class="calibre8">Chapter 1</a>, <em class="calibre22">Getting Started with QEMU and KVM, </em>to define the KVM instance.</p>
<p class="calibre3">In step 1, we import the libvirt package and proceed to define the new KVM instance. We assign the XML formatted string to the <kbd class="calibre13">xmlconfig</kbd> variable in step 2. Notice that the definition contains the name of the new instance and the location of the image file.</p>
<p class="calibre3">In step 3, we obtain a connection object and assign it to the <kbd class="calibre13">conn</kbd> variable. We can now use the available methods to define the KVM guest.</p>
<div class="packt_tip2">To list all available methods for an object in iPython, type the variable name followed by <kbd class="calibre27"><em class="calibre29">.</em></kbd> and press the <em class="calibre29">Tab</em> key twice: <br class="calibre34"/>
In [7]: conn.<br class="calibre34"/>
Display all 117 possibilities? (y or n)<br class="calibre34"/>
<kbd class="calibre27">conn.allocPages</kbd>                                                                     <kbd class="calibre27">conn.getURI<br class="calibre34"/></kbd><kbd class="calibre27">conn.nodeDeviceLookupByName</kbd><br class="calibre34"/>
<kbd class="calibre27">conn.baselineCPU</kbd>                                                               <kbd class="calibre27">conn.getVersion<br class="calibre34"/></kbd><kbd class="calibre27">conn.nodeDeviceLookupSCSIHostByWWN</kbd><br class="calibre34"/>
<kbd class="calibre27">conn.c_pointer</kbd>                                                 <kbd class="calibre27">conn.interfaceDefineXML<br class="calibre34"/></kbd> <kbd class="calibre27">conn.numOfDefinedDomains</kbd>        <kbd class="calibre27">conn.interfaceLookupByMACString<br class="calibre34"/></kbd><kbd class="calibre27">conn.numOfDefinedInterfaces</kbd><br class="calibre34"/>
...<br class="calibre34"/>
<br class="calibre34"/>
In [7]: conn.<br class="calibre34"/>
<br class="calibre34"/>
To obtain help on a method, append the question mark character at the end of the method:<br class="calibre34"/>
<kbd class="calibre27">In [7]: conn.defineXML?</kbd><br class="calibre34"/>
<kbd class="calibre27">Type: instancemethod</kbd><br class="calibre34"/>
<kbd class="calibre27">String Form:&lt;bound method virConnect.defineXML of &lt;libvirt.virConnect object at 0x7fc5e57dc350&gt;&gt;</kbd><br class="calibre34"/>
<kbd class="calibre27">File: /root/kvm_python/lib/python2.7/site-packages/libvirt.py</kbd><br class="calibre34"/>
<kbd class="calibre27">Definition: conn.defineXML(self, xml)</kbd><br class="calibre34"/>
<kbd class="calibre27">Docstring:</kbd><br class="calibre34"/>
<kbd class="calibre27">Define a domain, but does not start it.</kbd><br class="calibre34"/>
<kbd class="calibre27">This definition is persistent, until explicitly undefined with</kbd><br class="calibre34"/>
<kbd class="calibre27">virDomainUndefine(). A previous definition for this domain would be</kbd><br class="calibre34"/>
<kbd class="calibre27">overridden if it already exists.</kbd><br class="calibre34"/>
<br class="calibre34"/>
Some hypervisors may prevent this operation if there is a current<br class="calibre34"/>
block copy operation on a transient domain with the same ID as the<br class="calibre34"/>
domain being defined; in that case, use <kbd class="calibre27">virDomainBlockJobAbort()</kbd> to<br class="calibre34"/>
stop the block copy first.<br class="calibre34"/>
<br class="calibre34"/>
virDomainFree should be used to free the resources after the<br class="calibre34"/>
domain object is no longer needed.<br class="calibre34"/>
<br class="calibre34"/>
In [7]:</div>
<p class="calibre3">In step 4, we use the <kbd class="calibre13">defineXML()</kbd> method on the <kbd class="calibre13">libvirt.virConnect</kbd> connection object, passing the XML definition string and assign it to the instance variable. We can see the type of the new object by running:</p>
<pre class="calibre23">
In [7]: type(instance)<br class="calibre7"/>Out[7]: libvirt.virDomain<br class="calibre7"/><br class="calibre7"/>In [8]:
</pre>
<p class="calibre3">In step 5, we list the defined instances on the host, by using the <kbd class="calibre13">listDefinedDomains()</kbd> method and we confirm the result by using the <kbd class="calibre13">virsh</kbd> command in step 6.</p>


            </article>

            <footer class="calibre5">
                
            </footer>

        </section>
    

        <section class="calibre1">

            <header class="calibre1">
                </header><h1 class="header-title" id="calibre_pb_0">There's more...</h1>
            

            <article class="calibre1">
                
<p class="calibre3">Let's add some simple error checking to the preceding Python code and write all of it to a new file. We are going to be adding to this file in the subsequent recipes:</p>
<pre class="calibre23">
(kvm_python) root@kvm:~/kvm_python# cat kvm.py<br class="calibre7"/>import libvirt<br class="calibre7"/><br class="calibre7"/>xmlconfig = """<br class="calibre7"/>&lt;domain type='kvm' id='1'&gt;<br class="calibre7"/> &lt;name&gt;kvm_python&lt;/name&gt;<br class="calibre7"/> &lt;memory unit='KiB'&gt;1048576&lt;/memory&gt;<br class="calibre7"/> &lt;currentMemory unit='KiB'&gt;1048576&lt;/currentMemory&gt;<br class="calibre7"/> &lt;vcpu placement='static'&gt;1&lt;/vcpu&gt;<br class="calibre7"/> &lt;resource&gt;<br class="calibre7"/>   &lt;partition&gt;/machine&lt;/partition&gt;<br class="calibre7"/> &lt;/resource&gt;<br class="calibre7"/> &lt;os&gt;<br class="calibre7"/>   &lt;type arch='x86_64' machine='pc-i440fx-trusty'&gt;hvm&lt;/type&gt;<br class="calibre7"/>   &lt;boot dev='hd'/&gt;<br class="calibre7"/> &lt;/os&gt;<br class="calibre7"/> &lt;features&gt;<br class="calibre7"/>   &lt;acpi/&gt;<br class="calibre7"/>   &lt;apic/&gt;<br class="calibre7"/>   &lt;pae/&gt;<br class="calibre7"/> &lt;/features&gt;<br class="calibre7"/> &lt;clock offset='utc'/&gt;<br class="calibre7"/> &lt;on_poweroff&gt;destroy&lt;/on_poweroff&gt;<br class="calibre7"/> &lt;on_reboot&gt;restart&lt;/on_reboot&gt;<br class="calibre7"/> &lt;on_crash&gt;restart&lt;/on_crash&gt;<br class="calibre7"/> &lt;devices&gt;<br class="calibre7"/>   &lt;emulator&gt;/usr/bin/qemu-system-x86_64&lt;/emulator&gt;<br class="calibre7"/>   &lt;disk type='file' device='disk'&gt;<br class="calibre7"/>     &lt;driver name='qemu' type='raw'/&gt;<br class="calibre7"/>     &lt;source file='/tmp/debian.img'/&gt;<br class="calibre7"/>     &lt;backingStore/&gt;<br class="calibre7"/>     &lt;target dev='hda' bus='ide'/&gt;<br class="calibre7"/>     &lt;alias name='ide0-0-0'/&gt;<br class="calibre7"/>     &lt;address type='drive' controller='0' bus='0' target='0' unit='0'/&gt;<br class="calibre7"/>   &lt;/disk&gt;<br class="calibre7"/>   &lt;controller type='usb' index='0'&gt;<br class="calibre7"/>     &lt;alias name='usb'/&gt;<br class="calibre7"/>     &lt;address type='pci' domain='0x0000' bus='0x00' slot='0x01' function='0x2'/&gt;<br class="calibre7"/>   &lt;/controller&gt;<br class="calibre7"/>   &lt;controller type='pci' index='0' model='pci-root'&gt;<br class="calibre7"/>     &lt;alias name='pci.0'/&gt;<br class="calibre7"/>   &lt;/controller&gt;<br class="calibre7"/>   &lt;controller type='ide' index='0'&gt;<br class="calibre7"/>     &lt;alias name='ide'/&gt;<br class="calibre7"/>     &lt;address type='pci' domain='0x0000' bus='0x00' slot='0x01' function='0x1'/&gt;<br class="calibre7"/>   &lt;/controller&gt;<br class="calibre7"/>   &lt;interface type='network'&gt;<br class="calibre7"/>     &lt;mac address='52:54:00:da:02:01'/&gt;<br class="calibre7"/>     &lt;source network='default' bridge='virbr0'/&gt;<br class="calibre7"/>     &lt;target dev='vnet0'/&gt;<br class="calibre7"/>     &lt;model type='rtl8139'/&gt;<br class="calibre7"/>     &lt;alias name='net0'/&gt;<br class="calibre7"/>     &lt;address type='pci' domain='0x0000' bus='0x00' slot='0x03' function='0x0'/&gt;<br class="calibre7"/>   &lt;/interface&gt;<br class="calibre7"/>   &lt;serial type='pty'&gt;<br class="calibre7"/>     &lt;source path='/dev/pts/5'/&gt;<br class="calibre7"/>     &lt;target port='0'/&gt;<br class="calibre7"/>     &lt;alias name='serial0'/&gt;<br class="calibre7"/>   &lt;/serial&gt;<br class="calibre7"/>   &lt;console type='pty' tty='/dev/pts/5'&gt;<br class="calibre7"/>     &lt;source path='/dev/pts/5'/&gt;<br class="calibre7"/>     &lt;target type='serial' port='0'/&gt;<br class="calibre7"/>     &lt;alias name='serial0'/&gt;<br class="calibre7"/>   &lt;/console&gt;<br class="calibre7"/>   &lt;input type='mouse' bus='ps2'/&gt;<br class="calibre7"/>   &lt;input type='keyboard' bus='ps2'/&gt;<br class="calibre7"/>   &lt;graphics type='vnc' port='5900' autoport='yes' listen='0.0.0.0'&gt;<br class="calibre7"/>     &lt;listen type='address' address='0.0.0.0'/&gt;<br class="calibre7"/>   &lt;/graphics&gt;<br class="calibre7"/>   &lt;video&gt;<br class="calibre7"/>     &lt;model type='cirrus' vram='16384' heads='1'/&gt;<br class="calibre7"/>     &lt;alias name='video0'/&gt;<br class="calibre7"/>     &lt;address type='pci' domain='0x0000' bus='0x00' slot='0x02' function='0x0'/&gt;<br class="calibre7"/>   &lt;/video&gt;<br class="calibre7"/>   &lt;memballoon model='virtio'&gt;<br class="calibre7"/>     &lt;alias name='balloon0'/&gt;<br class="calibre7"/>     &lt;address type='pci' domain='0x0000' bus='0x00' slot='0x04' function='0x0'/&gt;<br class="calibre7"/>   &lt;/memballoon&gt;<br class="calibre7"/> &lt;/devices&gt;<br class="calibre7"/>&lt;/domain&gt;<br class="calibre7"/>"""<br class="calibre7"/><br class="calibre7"/>conn = libvirt.open('qemu:///system')<br class="calibre7"/>if conn == None:<br class="calibre7"/>  print 'Failed to connecto to the hypervizor'<br class="calibre7"/>  exit(1)<br class="calibre7"/><br class="calibre7"/>instance = conn.defineXML(xmlconfig)<br class="calibre7"/>if instance == None:<br class="calibre7"/>  print 'Failed to define the instance'<br class="calibre7"/>  exit(1)<br class="calibre7"/><br class="calibre7"/>instances = conn.listDefinedDomains()<br class="calibre7"/>print 'Defined instances: {}'.format(instances)<br class="calibre7"/><br class="calibre7"/>conn.close()<br class="calibre7"/><br class="calibre7"/>(kvm_python) root@kvm:~/kvm_python#
</pre>
<p class="calibre3">To execute the script, ensure that the <kbd class="calibre13">python_kmv</kbd> instance has been undefined first, then run:</p>
<pre class="calibre23">
<strong class="calibre4">(kvm_python) root@kvm:~/kvm_python# python kvm.py</strong><br class="calibre7"/><strong class="calibre4">Defined instances: ['kvm_python']</strong><br class="calibre7"/><strong class="calibre4">(kvm_python) root@kvm:~/kvm_python#</strong>
</pre>


            </article>

            <footer class="calibre5">
                
            </footer>

        </section>
    

        <section class="calibre1">

            <header class="calibre1">
                </header><h1 class="header-title" id="calibre_pb_0">Starting, stopping, and deleting KVM instances with Python</h1>
            

            <article class="calibre1">
                
<p class="calibre3">In this recipe we are going to use the <kbd class="calibre13">create()</kbd> method on the instance object we defined in the previous recipe to start it and the <kbd class="calibre13">destroy()</kbd> method to stop it.</p>
<p class="calibre3">To obtain more information on the <kbd class="calibre13">create()</kbd> method, run:</p>
<pre class="calibre23">
<strong class="calibre4">In [1]: instance.create?</strong><br class="calibre7"/><strong class="calibre4">Type: instancemethod</strong><br class="calibre7"/><strong class="calibre4">String Form:&lt;bound method virDomain.create of &lt;libvirt.virDomain object at 0x7fc5d9b97d90&gt;&gt;</strong><br class="calibre7"/><strong class="calibre4">File: /root/kvm_python/lib/python2.7/site-packages/libvirt.py</strong><br class="calibre7"/><strong class="calibre4">Definition: instance.create(self)</strong><br class="calibre7"/><strong class="calibre4">Docstring:</strong><br class="calibre7"/><strong class="calibre4">Launch a defined domain. If the call succeeds the domain moves from the</strong><br class="calibre7"/><strong class="calibre4">defined to the running domains pools. The domain will be paused only</strong><br class="calibre7"/><strong class="calibre4">if restoring from managed state created from a paused domain. For more</strong><br class="calibre7"/><strong class="calibre4">control, see virDomainCreateWithFlags().</strong><br class="calibre7"/><br class="calibre7"/><strong class="calibre4">In [2]:</strong>
</pre>


            </article>

            <footer class="calibre5">
                
            </footer>

        </section>
    

        <section class="calibre1">

            <header class="calibre1">
                </header><h1 class="header-title" id="calibre_pb_0">Getting ready</h1>
            

            <article class="calibre1">
                
<p class="calibre3">For this recipe we are going to need the following:</p>
<ul class="calibre16">
<li class="calibre17">An Ubuntu host, with libvirt and QEMU installed and configured</li>
<li class="calibre17">The <kbd class="calibre13">debian.img</kbd> raw image file we built in the Installing custom OS on the image with debootstrap recipe from <a target="_blank" href="part0026.html#OPEK0-c1e587dcccb14690b55c247c1809e6ce" class="calibre8">Chapter 1</a>, <em class="calibre22">Getting Started with QEMU and KVM</em></li>
<li class="calibre17">Python 2.7, the iPython tool, and the virtual environment we created in the <em class="calibre22">Installing and using the Python libvirt library</em> recipe in this chapter</li>
<li class="calibre17">The instance object we created in the <em class="calibre22">Defining KVM instances with Python</em> recipe in this chapter</li>
</ul>


            </article>

            <footer class="calibre5">
                
            </footer>

        </section>
    

        <section class="calibre1">

            <header class="calibre1">
                </header><h1 class="header-title" id="calibre_pb_0">How to do it...</h1>
            

            <article class="calibre1">
                
<p class="calibre3">To start the KVM instance that was defined earlier, to obtain its status and finally to stop it, use the following Python code:</p>
<ol start="1" class="calibre18">
<li value="1" class="calibre17">Invoke the <kbd class="calibre13">create()</kbd> method on the instance object:</li>
</ol>
<pre class="calibre25">
In [1]: instance.create()<br class="calibre7"/>Out[1]: 0<br class="calibre7"/><br class="calibre7"/>In [2]:
</pre>
<ol start="2" class="calibre18">
<li value="2" class="calibre17">Ensure the instance is in a running state by calling the <kbd class="calibre13">isActive()</kbd> method on the instance object:</li>
</ol>
<pre class="calibre25">
In [2]: instance.isActive()<br class="calibre7"/>Out[2]: 1<br class="calibre7"/><br class="calibre7"/>In [3]:
</pre>
<ol start="3" class="calibre18">
<li value="3" class="calibre17">Check the status of the KVM instance from the host OS:</li>
</ol>
<pre class="calibre25">
<strong class="calibre4">(kvm_python) root@kvm:~/kvm_python# virsh list --all</strong><br class="calibre7"/><strong class="calibre4"> Id   Name        State</strong><br class="calibre7"/><strong class="calibre4">----------------------------------------------------</strong><br class="calibre7"/><strong class="calibre4"> 5    kvm_python  running</strong><br class="calibre7"/><br class="calibre7"/><strong class="calibre4">(kvm_python) root@kvm:~/kvm_python#</strong>
</pre>
<ol start="4" class="calibre18">
<li value="4" class="calibre17">Stop the instance with the <kbd class="calibre13">destroy()</kbd> method:</li>
</ol>
<pre class="calibre25">
In [3]: instance.destroy()<br class="calibre7"/>Out[3]: 0<br class="calibre7"/><br class="calibre7"/>In [4]:
</pre>
<ol start="5" class="calibre18">
<li value="5" class="calibre17">Ensure the instance has been destroyed:</li>
</ol>
<pre class="calibre25">
In [4]: instance.isActive()<br class="calibre7"/>Out[4]: 0<br class="calibre7"/><br class="calibre7"/>In [5]:
</pre>
<ol start="6" class="calibre18">
<li value="6" class="calibre17">Delete the instance and list all defined guests:</li>
</ol>
<pre class="calibre25">
In [5]: instance.undefine()<br class="calibre7"/>Out[5]: 0<br class="calibre7"/><br class="calibre7"/>In [6]: conn.listDefinedDomains()<br class="calibre7"/>Out[6]: []<br class="calibre7"/><br class="calibre7"/>In [7]:
</pre>


            </article>

            <footer class="calibre5">
                
            </footer>

        </section>
    

        <section class="calibre1">

            <header class="calibre1">
                </header><h1 class="header-title" id="calibre_pb_0">How it works...</h1>
            

            <article class="calibre1">
                
<p class="calibre3">In step 1, we call the <kbd class="calibre13">create()</kbd> method to launch the defined instance. If successful the guest will transition from shut off state to running as we can see in the output of the command in step 3. In step 2, we use the <kbd class="calibre13">isActive()</kbd> method, to check the status of the instance. An output of 1 indicates that the instance is running.</p>
<p class="calibre3">In step 4, we stop the instance using the <kbd class="calibre13">destroy()</kbd> method and confirm in step 5.</p>
<p class="calibre3">Finally in step 6, we delete the instance using the <kbd class="calibre13">undefine()</kbd> method and list all defined instances with the <kbd class="calibre13">listDefinedDomains()</kbd> call.</p>


            </article>

            <footer class="calibre5">
                
            </footer>

        </section>
    

        <section class="calibre1">

            <header class="calibre1">
                </header><h1 class="header-title" id="calibre_pb_0">There's more...</h1>
            

            <article class="calibre1">
                
<p class="calibre3">Let's add the new code to the Python script we started in the <em class="calibre22">Defining KVM instances with Python</em> recipe. The updated script should look like the following:</p>
<pre class="calibre23">
<strong class="calibre4">(kvm_python) root@kvm:~/kvm_python# cat kvm.py</strong><br class="calibre7"/><strong class="calibre4">import libvirt</strong><br class="calibre7"/><strong class="calibre4">import time</strong><br class="calibre7"/><br class="calibre7"/><strong class="calibre4">xmlconfig = """</strong><br class="calibre7"/><strong class="calibre4">&lt;domain type='kvm' id='1'&gt;</strong><br class="calibre7"/><strong class="calibre4"> &lt;name&gt;kvm_python&lt;/name&gt;</strong><br class="calibre7"/><strong class="calibre4"> &lt;memory unit='KiB'&gt;1048576&lt;/memory&gt;</strong><br class="calibre7"/><strong class="calibre4"> &lt;currentMemory unit='KiB'&gt;1048576&lt;/currentMemory&gt;</strong><br class="calibre7"/><strong class="calibre4"> &lt;vcpu placement='static'&gt;1&lt;/vcpu&gt;</strong><br class="calibre7"/><strong class="calibre4"> &lt;resource&gt;</strong><br class="calibre7"/><strong class="calibre4">   &lt;partition&gt;/machine&lt;/partition&gt;</strong><br class="calibre7"/><strong class="calibre4"> &lt;/resource&gt;</strong><br class="calibre7"/><strong class="calibre4"> &lt;os&gt;</strong><br class="calibre7"/><strong class="calibre4">   &lt;type arch='x86_64' machine='pc-i440fx-trusty'&gt;hvm&lt;/type&gt;</strong><br class="calibre7"/><strong class="calibre4">   &lt;boot dev='hd'/&gt;</strong><br class="calibre7"/><strong class="calibre4"> &lt;/os&gt;</strong><br class="calibre7"/><strong class="calibre4"> &lt;features&gt;</strong><br class="calibre7"/><strong class="calibre4">   &lt;acpi/&gt;</strong><br class="calibre7"/><strong class="calibre4">   &lt;apic/&gt;</strong><br class="calibre7"/><strong class="calibre4">   &lt;pae/&gt;</strong><br class="calibre7"/><strong class="calibre4"> &lt;/features&gt;</strong><br class="calibre7"/><strong class="calibre4"> &lt;clock offset='utc'/&gt;</strong><br class="calibre7"/><strong class="calibre4"> &lt;on_poweroff&gt;destroy&lt;/on_poweroff&gt;</strong><br class="calibre7"/><strong class="calibre4"> &lt;on_reboot&gt;restart&lt;/on_reboot&gt;</strong><br class="calibre7"/><strong class="calibre4"> &lt;on_crash&gt;restart&lt;/on_crash&gt;</strong><br class="calibre7"/><strong class="calibre4"> &lt;devices&gt;</strong><br class="calibre7"/><strong class="calibre4">   &lt;emulator&gt;/usr/bin/qemu-system-x86_64&lt;/emulator&gt;</strong><br class="calibre7"/><strong class="calibre4">   &lt;disk type='file' device='disk'&gt;</strong><br class="calibre7"/><strong class="calibre4">     &lt;driver name='qemu' type='raw'/&gt;</strong><br class="calibre7"/><strong class="calibre4">     &lt;source file='/tmp/debian.img'/&gt;</strong><br class="calibre7"/><strong class="calibre4">&lt;backingStore/&gt;</strong><br class="calibre7"/><strong class="calibre4">     &lt;target dev='hda' bus='ide'/&gt;</strong><br class="calibre7"/><strong class="calibre4">     &lt;alias name='ide0-0-0'/&gt;</strong><br class="calibre7"/><strong class="calibre4">     &lt;address type='drive' controller='0' bus='0' target='0' unit='0'/&gt;</strong><br class="calibre7"/><strong class="calibre4">   &lt;/disk&gt;</strong><br class="calibre7"/><strong class="calibre4">   &lt;controller type='usb' index='0'&gt;</strong><br class="calibre7"/><strong class="calibre4">     &lt;alias name='usb'/&gt;</strong><br class="calibre7"/><strong class="calibre4">     &lt;address type='pci' domain='0x0000' bus='0x00' slot='0x01' function='0x2'/&gt;</strong><br class="calibre7"/><strong class="calibre4">   &lt;/controller&gt;</strong><br class="calibre7"/><strong class="calibre4">   &lt;controller type='pci' index='0' model='pci-root'&gt;</strong><br class="calibre7"/><strong class="calibre4">     &lt;alias name='pci.0'/&gt;</strong><br class="calibre7"/><strong class="calibre4">   &lt;/controller&gt;</strong><br class="calibre7"/><strong class="calibre4">   &lt;controller type='ide' index='0'&gt;</strong><br class="calibre7"/><strong class="calibre4">     &lt;alias name='ide'/&gt;</strong><br class="calibre7"/><strong class="calibre4">     &lt;address type='pci' domain='0x0000' bus='0x00' slot='0x01' function='0x1'/&gt;</strong><br class="calibre7"/><strong class="calibre4">   &lt;/controller&gt;</strong><br class="calibre7"/><strong class="calibre4">   &lt;interface type='network'&gt;</strong><br class="calibre7"/><strong class="calibre4">     &lt;mac address='52:54:00:da:02:01'/&gt;</strong><br class="calibre7"/><strong class="calibre4">     &lt;source network='default' bridge='virbr0'/&gt;</strong><br class="calibre7"/><strong class="calibre4">     &lt;target dev='vnet0'/&gt;</strong><br class="calibre7"/><strong class="calibre4">     &lt;model type='rtl8139'/&gt;</strong><br class="calibre7"/><strong class="calibre4">     &lt;alias name='net0'/&gt;</strong><br class="calibre7"/><strong class="calibre4">     &lt;address type='pci' domain='0x0000' bus='0x00' slot='0x03'</strong> <strong class="calibre4">function='0x0'/&gt;</strong><br class="calibre7"/><strong class="calibre4">   &lt;/interface&gt;</strong><br class="calibre7"/><strong class="calibre4">   &lt;serial type='pty'&gt;</strong><br class="calibre7"/><strong class="calibre4">     &lt;source path='/dev/pts/5'/&gt;</strong><br class="calibre7"/><strong class="calibre4">     &lt;target port='0'/&gt;</strong><br class="calibre7"/><strong class="calibre4">     &lt;alias name='serial0'/&gt;</strong><br class="calibre7"/><strong class="calibre4">   &lt;/serial&gt;</strong><br class="calibre7"/><strong class="calibre4">   &lt;console type='pty' tty='/dev/pts/5'&gt;</strong><br class="calibre7"/><strong class="calibre4">     &lt;source path='/dev/pts/5'/&gt;</strong><br class="calibre7"/><strong class="calibre4">     &lt;target type='serial' port='0'/&gt;</strong><br class="calibre7"/><strong class="calibre4">     &lt;alias name='serial0'/&gt;</strong><br class="calibre7"/><strong class="calibre4">   &lt;/console&gt;</strong><br class="calibre7"/><strong class="calibre4">   &lt;input type='mouse' bus='ps2'/&gt;</strong><br class="calibre7"/><strong class="calibre4">   &lt;input type='keyboard' bus='ps2'/&gt;</strong><br class="calibre7"/><strong class="calibre4">   &lt;graphics type='vnc' port='5900' autoport='yes' listen='0.0.0.0'&gt;</strong><br class="calibre7"/><strong class="calibre4">     &lt;listen type='address' address='0.0.0.0'/&gt;</strong><br class="calibre7"/><strong class="calibre4">   &lt;/graphics&gt;</strong><br class="calibre7"/><strong class="calibre4">   &lt;video&gt;</strong><br class="calibre7"/><strong class="calibre4">     &lt;model type='cirrus' vram='16384' heads='1'/&gt;</strong><br class="calibre7"/><strong class="calibre4">     &lt;alias name='video0'/&gt;</strong><br class="calibre7"/><strong class="calibre4">     &lt;address type='pci' domain='0x0000' bus='0x00' slot='0x02' function='0x0'/&gt;</strong><br class="calibre7"/><strong class="calibre4">   &lt;/video&gt;</strong><br class="calibre7"/><strong class="calibre4">   &lt;memballoon model='virtio'&gt;</strong><br class="calibre7"/><strong class="calibre4">     &lt;alias name='balloon0'/&gt;</strong><br class="calibre7"/><strong class="calibre4">&lt;address type='pci' domain='0x0000' bus='0x00' slot='0x04' function='0x0'/&gt;</strong><br class="calibre7"/><strong class="calibre4">   &lt;/memballoon&gt;</strong><br class="calibre7"/><strong class="calibre4"> &lt;/devices&gt;</strong><br class="calibre7"/><strong class="calibre4">&lt;/domain&gt;</strong><br class="calibre7"/><strong class="calibre4">"""</strong><br class="calibre7"/><br class="calibre7"/><strong class="calibre4">conn = libvirt.open('qemu:///system')</strong><br class="calibre7"/><strong class="calibre4">if conn == None:</strong><br class="calibre7"/><strong class="calibre4">  print 'Failed to connecto to the hypervizor'</strong><br class="calibre7"/><strong class="calibre4">  exit(1)</strong><br class="calibre7"/><br class="calibre7"/><strong class="calibre4">instance = conn.defineXML(xmlconfig)</strong><br class="calibre7"/><strong class="calibre4">if instance == None:</strong><br class="calibre7"/><strong class="calibre4">  print 'Failed to define the instance'</strong><br class="calibre7"/><strong class="calibre4">  exit(1)</strong><br class="calibre7"/><br class="calibre7"/><strong class="calibre4">instances = conn.listDefinedDomains()</strong><br class="calibre7"/><strong class="calibre4">print 'Defined instances: {}'.format(instances)</strong><br class="calibre7"/><br class="calibre7"/><strong class="calibre4">time.sleep(5)</strong><br class="calibre7"/><br class="calibre7"/><strong class="calibre4">if instance.create() &lt; 0:</strong><br class="calibre7"/><strong class="calibre4">  print 'Failed to start the {} instance'.format(instance.name())</strong><br class="calibre7"/><strong class="calibre4">exit(1)</strong><br class="calibre7"/><br class="calibre7"/><strong class="calibre4">if instance.isActive():</strong><br class="calibre7"/><strong class="calibre4">  print 'The instance {} is running'.format(instance.name())</strong><br class="calibre7"/><strong class="calibre4">else:</strong><br class="calibre7"/><strong class="calibre4">  print 'The instance {} is not running'.format(instance.name())</strong><br class="calibre7"/><br class="calibre7"/><strong class="calibre4">time.sleep(5)</strong><br class="calibre7"/><br class="calibre7"/><strong class="calibre4">if instance.destroy() &lt; 0:</strong><br class="calibre7"/><strong class="calibre4">  print 'Failed to stop the {} instance'.format(instance.name())</strong><br class="calibre7"/><strong class="calibre4">  exit(1)</strong><br class="calibre7"/><strong class="calibre4">else:</strong><br class="calibre7"/><strong class="calibre4">  print 'The instance {} has been destroyed'.format(instance.name())</strong><br class="calibre7"/><br class="calibre7"/><strong class="calibre4">if instance.undefine() &lt; 0:</strong><br class="calibre7"/><strong class="calibre4">  print 'Failed to remove the {} instance'.format(instance.name())</strong><br class="calibre7"/><strong class="calibre4">  exit(1)</strong><br class="calibre7"/><strong class="calibre4">else:</strong><br class="calibre7"/><strong class="calibre4">  print 'The instance {} has been undefined'.format(instance.name())</strong><br class="calibre7"/><br class="calibre7"/><strong class="calibre4">conn.close()<br class="calibre7"/></strong><br class="calibre7"/><strong class="calibre4">(kvm_python) root@kvm:~/kvm_python#</strong>
</pre>
<p class="calibre3">Starting the script should define a new instance, start it, stop it, and finally remove it:</p>
<pre class="calibre23">
<strong class="calibre4">(kvm_python) root@kvm:~/kvm_python# python kvm.py</strong><br class="calibre7"/><strong class="calibre4">Defined instances: ['kvm1', 'kvm_python']</strong><br class="calibre7"/><strong class="calibre4">The instance kvm_python is running</strong><br class="calibre7"/><strong class="calibre4">The instance kvm_python has been destroyed</strong><br class="calibre7"/><strong class="calibre4">The instance kvm_python has been undefined</strong><br class="calibre7"/><strong class="calibre4">(kvm_python) root@kvm:~/kvm_python#</strong>
</pre>
<p class="calibre3">In the preceding script, we used the <kbd class="calibre13">instance.name()</kbd> method to get the name of the KVM guest and print it. We also clean up, by closing the connection to the hypervisor with the <kbd class="calibre13">conn.close()</kbd> call.</p>


            </article>

            <footer class="calibre5">
                
            </footer>

        </section>
    

        <section class="calibre1">

            <header class="calibre1">
                </header><h1 class="header-title" id="calibre_pb_0">Inspecting KVM instances with Python</h1>
            

            <article class="calibre1">
                
<p class="calibre3">In this recipe we are going to collect instance information, using methods from the <kbd class="calibre13">libvirt.virDomain</kbd> class. </p>
<div class="packt_infobox">For more information on the libvirt Python API, please refer to the official documentation at: <a href="http://libvirt.org/docs/libvirt-appdev-guide-python/en-US/html/index.html" class="calibre30">http://libvirt.org/docs/libvirt-appdev-guide-python/en-US/html/index.html</a>.</div>


            </article>

            <footer class="calibre5">
                
            </footer>

        </section>
    

        <section class="calibre1">

            <header class="calibre1">
                </header><h1 class="header-title" id="calibre_pb_0">Getting ready</h1>
            

            <article class="calibre1">
                
<p class="calibre3">For this recipe we are going to need the following:</p>
<ul class="calibre16">
<li class="calibre17">An Ubuntu host, with libvirt and QEMU installed and configured</li>
<li class="calibre17">The <kbd class="calibre13">debian.img</kbd> raw image file we built in the <em class="calibre22">Installing custom OS on the image with debootstrap</em> recipe from <a target="_blank" href="part0026.html#OPEK0-c1e587dcccb14690b55c247c1809e6ce" class="calibre8">Chapter 1</a>, <em class="calibre22">Getting Started with QEMU and KVM</em></li>
<li class="calibre17">Python 2.7, the <kbd class="calibre13">iPython</kbd> tool, and the virtual environment we created in the <em class="calibre22">Installing and using the Python libvirt library</em> recipe in this chapter</li>
<li class="calibre17">The <kbd class="calibre13">instance</kbd> object we created in the <em class="calibre22">Defining KVM instances with Python</em> recipe in this chapter, representing the KVM guest</li>
</ul>


            </article>

            <footer class="calibre5">
                
            </footer>

        </section>
    

        <section class="calibre1">

            <header class="calibre1">
                </header><h1 class="header-title" id="calibre_pb_0">How to do it...</h1>
            

            <article class="calibre1">
                
<p class="calibre3">To collect CPU, memory, and state information about a running instance, use the following Python methods:</p>
<ol class="calibre18">
<li value="1" class="calibre17"><span>Get the</span> name <span>of the instance:</span></li>
</ol>
<pre class="calibre25">
In [1]: instance.name()<br class="calibre7"/>Out[1]: 'kvm_python'<br class="calibre7"/><br class="calibre7"/>In [2]:
</pre>
<ol start="2" class="calibre18">
<li value="2" class="calibre17">Ensure the instance is running:</li>
</ol>
<pre class="calibre25">
In [2]: instance.isActive()<br class="calibre7"/>Out[2]: 1<br class="calibre7"/><br class="calibre7"/>In [3]:
</pre>
<ol start="3" class="calibre18">
<li value="3" class="calibre17">Collect resource statistics on the KVM instance:</li>
</ol>
<pre class="calibre25">
In [3]: instance.info()<br class="calibre7"/>Out[3]: [1, 1048576L, 1048576L, 1, 10910000000L]<br class="calibre7"/><br class="calibre7"/>In [4]:
</pre>
<ol start="4" class="calibre18">
<li value="4" class="calibre17">Retrieve the maximum amount of physical memory allocated to the instance:</li>
</ol>
<pre class="calibre25">
In [4]: instance.maxMemory()<br class="calibre7"/>Out[4]: 1048576L<br class="calibre7"/><br class="calibre7"/>In [5]:
</pre>
<ol start="5" class="calibre18">
<li value="5" class="calibre17">Extract CPU statistics for the instance:</li>
</ol>
<pre class="calibre25">
In [5]: instance.getCPUStats(1)<br class="calibre7"/>Out[5]:<br class="calibre7"/>[{'cpu_time': 10911545901L,<br class="calibre7"/> 'system_time': 1760000000L,<br class="calibre7"/> 'user_time': 1560000000L}]<br class="calibre7"/><br class="calibre7"/>In [6]:
</pre>
<ol start="6" class="calibre18">
<li value="6" class="calibre17">Check if the virtual machine is using hardware acceleration:</li>
</ol>
<pre class="calibre25">
In [6]: instance.OSType()<br class="calibre7"/>Out[6]: 'hvm'<br class="calibre7"/><br class="calibre7"/>In [7]:
</pre>
<ol start="7" class="calibre18">
<li value="7" class="calibre17">Collect the instance state:</li>
</ol>
<pre class="calibre25">
In [82]: state, reason = instance.state()<br class="calibre7"/><br class="calibre7"/>In [83]: if state == libvirt.VIR_DOMAIN_NOSTATE:<br class="calibre7"/> ....:           print('The state is nostate')<br class="calibre7"/> ....: elif state == libvirt.VIR_DOMAIN_RUNNING:<br class="calibre7"/> ....:           print('The state is running')<br class="calibre7"/> ....: elif state == libvirt.VIR_DOMAIN_BLOCKED:<br class="calibre7"/> ....:           print('The state is blocked')<br class="calibre7"/> ....: elif state == libvirt.VIR_DOMAIN_PAUSED:<br class="calibre7"/> ....:           print('The state is paused')<br class="calibre7"/> ....: elif state == libvirt.VIR_DOMAIN_SHUTDOWN:<br class="calibre7"/> ....:           print('The state is shutdown')<br class="calibre7"/> ....: elif state == libvirt.VIR_DOMAIN_SHUTOFF:<br class="calibre7"/> ....:           print('The state is shutoff')<br class="calibre7"/> ....: elif state == libvirt.VIR_DOMAIN_CRASHED:<br class="calibre7"/> ....:           print('The state is crashed')<br class="calibre7"/> ....: elif state == libvirt.VIR_DOMAIN_PMSUSPENDED:<br class="calibre7"/> ....:           print('The state is suspended')<br class="calibre7"/> ....: else:<br class="calibre7"/> ....:           print('The state is unknown')<br class="calibre7"/> ....:<br class="calibre7"/>The state is running<br class="calibre7"/><br class="calibre7"/>In [84]:
</pre>


            </article>

            <footer class="calibre5">
                
            </footer>

        </section>
    

        <section class="calibre1">

            <header class="calibre1">
                </header><h1 class="header-title" id="calibre_pb_0">How it works...</h1>
            

            <article class="calibre1">
                
<p class="calibre3">In this recipe, we used a few new methods from the <kbd class="calibre13">libvirt.virDomain</kbd> class. Let's see what they do in more detail and then add them to the simple <kbd class="calibre13">kvm.py</kbd> Python script we started in the <em class="calibre22">Defining KVM instances with Python</em> recipe.</p>
<p class="calibre3">In steps 1 and 2, we get the name of the KVM instance and ensure it's in a running state. </p>
<p class="calibre3">In step 3, we collect the following instance information, returned as a Python list:</p>
<ul class="calibre16">
<li class="calibre17"><strong class="calibre4">state</strong>: The state of the instance, as defined in the <em class="calibre22">virDomainState</em> enumerated type at <a href="https://libvirt.org/html/libvirt-libvirt-domain.html#virDomainState" class="calibre8">https://libvirt.org/html/libvirt-libvirt-domain.html#virDomainState</a></li>
<li class="calibre17"><strong class="calibre4">maxMemory</strong>: The maximum memory used by the guest</li>
<li class="calibre17"><strong class="calibre4">memory</strong>: The current amount of memory used by the instance</li>
<li class="calibre17"><strong class="calibre4">nbVirtCPU</strong>: The number of allocated virtual CPUs</li>
<li class="calibre17"><strong class="calibre4">cpuTime</strong>: The time used by the instance (in nanoseconds)</li>
</ul>
<p class="calibre3">In step 4, we collect the memory allocated to the instance. Notice how it matches the output of the function from step 3.</p>
<p class="calibre3">In step 5, we collect information about the CPU of the guest instance. We can see the CPU, system, and user times.</p>
<p class="calibre3">The <kbd class="calibre13">hvm</kbd> output of the <kbd class="calibre13">OSType()</kbd> method in step 6, indicates that the guest OS is designed to run on bare metal, requiring full virtualization, such as KVM.</p>
<p class="calibre3">In the last step of this recipe, we call the <kbd class="calibre13">state()</kbd> method to return the current instance state.</p>


            </article>

            <footer class="calibre5">
                
            </footer>

        </section>
    

        <section class="calibre1">

            <header class="calibre1">
                </header><h1 class="header-title" id="calibre_pb_0">There's more...</h1>
            

            <article class="calibre1">
                
<p class="calibre3">Let's finish up this chapter with a complete example script, containing all of the methods we have used so far:</p>
<pre class="calibre23">
<strong class="calibre4">(kvm_python) root@kvm:~/kvm_python# cat kvm.py</strong><br class="calibre7"/><strong class="calibre4">import libvirt</strong><br class="calibre7"/><strong class="calibre4">import time</strong><br class="calibre7"/><br class="calibre7"/><br class="calibre7"/><strong class="calibre4">def main():</strong><br class="calibre7"/><br class="calibre7"/><strong class="calibre4">  xmlconfig = """</strong><br class="calibre7"/><strong class="calibre4">  &lt;domain type='kvm' id='1'&gt;</strong><br class="calibre7"/><strong class="calibre4">  &lt;name&gt;kvm_python&lt;/name&gt;</strong><br class="calibre7"/><strong class="calibre4">  &lt;memory unit='KiB'&gt;1048576&lt;/memory&gt;</strong><br class="calibre7"/><strong class="calibre4">  &lt;currentMemory unit='KiB'&gt;1048576&lt;/currentMemory&gt;</strong><br class="calibre7"/><strong class="calibre4">  &lt;vcpu placement='static'&gt;1&lt;/vcpu&gt;</strong><br class="calibre7"/><strong class="calibre4">  &lt;resource&gt;</strong><br class="calibre7"/><strong class="calibre4">    &lt;partition&gt;/machine&lt;/partition&gt;</strong><br class="calibre7"/><strong class="calibre4">  &lt;/resource&gt;</strong><br class="calibre7"/><strong class="calibre4">  &lt;os&gt;</strong><br class="calibre7"/><strong class="calibre4">    &lt;type arch='x86_64' machine='pc-i440fx-trusty'&gt;hvm&lt;/type&gt;</strong><br class="calibre7"/><strong class="calibre4">    &lt;boot dev='hd'/&gt;</strong><br class="calibre7"/><strong class="calibre4">  &lt;/os&gt;</strong><br class="calibre7"/><strong class="calibre4">  &lt;features&gt;</strong><br class="calibre7"/><strong class="calibre4">&lt;acpi/&gt;</strong><br class="calibre7"/><strong class="calibre4">    &lt;apic/&gt;</strong><br class="calibre7"/><strong class="calibre4">    &lt;pae/&gt;</strong><br class="calibre7"/><strong class="calibre4">  &lt;/features&gt;</strong><br class="calibre7"/><strong class="calibre4">  &lt;clock offset='utc'/&gt;</strong><br class="calibre7"/><strong class="calibre4">  &lt;on_poweroff&gt;destroy&lt;/on_poweroff&gt;</strong><br class="calibre7"/><strong class="calibre4">  &lt;on_reboot&gt;restart&lt;/on_reboot&gt;</strong><br class="calibre7"/><strong class="calibre4">  &lt;on_crash&gt;restart&lt;/on_crash&gt;</strong><br class="calibre7"/><strong class="calibre4">  &lt;devices&gt;</strong><br class="calibre7"/><strong class="calibre4">    &lt;emulator&gt;/usr/bin/qemu-system-x86_64&lt;/emulator&gt;</strong><br class="calibre7"/><strong class="calibre4">    &lt;disk type='file' device='disk'&gt;</strong><br class="calibre7"/><strong class="calibre4">      &lt;driver name='qemu' type='raw'/&gt;</strong><br class="calibre7"/><strong class="calibre4">      &lt;source file='/tmp/debian.img'/&gt;</strong><br class="calibre7"/><strong class="calibre4">      &lt;backingStore/&gt;</strong><br class="calibre7"/><strong class="calibre4">      &lt;target dev='hda' bus='ide'/&gt;</strong><br class="calibre7"/><strong class="calibre4">      &lt;alias name='ide0-0-0'/&gt;</strong><br class="calibre7"/><strong class="calibre4">      &lt;address type='drive' controller='0' bus='0' target='0' unit='0'/&gt;</strong><br class="calibre7"/><strong class="calibre4">    &lt;/disk&gt;</strong><br class="calibre7"/><strong class="calibre4">    &lt;controller type='usb' index='0'&gt;</strong><br class="calibre7"/><strong class="calibre4">      &lt;alias name='usb'/&gt;</strong><br class="calibre7"/><strong class="calibre4">      &lt;address type='pci' domain='0x0000' bus='0x00' slot='0x01'</strong> <strong class="calibre4">function='0x2'/&gt;</strong><br class="calibre7"/><strong class="calibre4">    &lt;/controller&gt;</strong><br class="calibre7"/><strong class="calibre4">    &lt;controller type='pci' index='0' model='pci-root'&gt;</strong><br class="calibre7"/><strong class="calibre4">      &lt;alias name='pci.0'/&gt;</strong><br class="calibre7"/><strong class="calibre4">    &lt;/controller&gt;</strong><br class="calibre7"/><strong class="calibre4">    &lt;controller type='ide' index='0'&gt;</strong><br class="calibre7"/><strong class="calibre4">      &lt;alias name='ide'/&gt;</strong><br class="calibre7"/><strong class="calibre4">      &lt;address type='pci' domain='0x0000' bus='0x00' slot='0x01' function='0x1'/&gt;</strong><br class="calibre7"/><strong class="calibre4">    &lt;/controller&gt;</strong><br class="calibre7"/><strong class="calibre4">    &lt;interface type='network'&gt;</strong><br class="calibre7"/><strong class="calibre4">      &lt;mac address='52:54:00:da:02:01'/&gt;</strong><br class="calibre7"/><strong class="calibre4">      &lt;source network='default' bridge='virbr0'/&gt;</strong><br class="calibre7"/><strong class="calibre4">      &lt;target dev='vnet0'/&gt;</strong><br class="calibre7"/><strong class="calibre4">      &lt;model type='rtl8139'/&gt;</strong><br class="calibre7"/><strong class="calibre4">      &lt;alias name='net0'/&gt;</strong><br class="calibre7"/><strong class="calibre4">      &lt;address type='pci' domain='0x0000' bus='0x00' slot='0x03' function='0x0'/&gt;</strong><br class="calibre7"/><strong class="calibre4">    &lt;/interface&gt;</strong><br class="calibre7"/><strong class="calibre4">    &lt;serial type='pty'&gt;</strong><br class="calibre7"/><strong class="calibre4">      &lt;source path='/dev/pts/5'/&gt;</strong><br class="calibre7"/><strong class="calibre4">      &lt;target port='0'/&gt;</strong><br class="calibre7"/><strong class="calibre4">      &lt;alias name='serial0'/&gt;</strong><br class="calibre7"/><strong class="calibre4">    &lt;/serial&gt;</strong><br class="calibre7"/><strong class="calibre4">    &lt;console type='pty' tty='/dev/pts/5'&gt;</strong><br class="calibre7"/><strong class="calibre4">      &lt;source path='/dev/pts/5'/&gt;</strong><br class="calibre7"/><strong class="calibre4"> &lt;target type='serial' port='0'/&gt;</strong><br class="calibre7"/><strong class="calibre4">      &lt;alias name='serial0'/&gt;</strong><br class="calibre7"/><strong class="calibre4">    &lt;/console&gt;</strong><br class="calibre7"/><strong class="calibre4">    &lt;input type='mouse' bus='ps2'/&gt;</strong><br class="calibre7"/><strong class="calibre4">    &lt;input type='keyboard' bus='ps2'/&gt;</strong><br class="calibre7"/><strong class="calibre4">    &lt;graphics type='vnc' port='5900' autoport='yes' listen='0.0.0.0'&gt;</strong><br class="calibre7"/><strong class="calibre4">      &lt;listen type='address' address='0.0.0.0'/&gt;</strong><br class="calibre7"/><strong class="calibre4">    &lt;/graphics&gt;</strong><br class="calibre7"/><strong class="calibre4">    &lt;video&gt;</strong><br class="calibre7"/><strong class="calibre4">      &lt;model type='cirrus' vram='16384' heads='1'/&gt;</strong><br class="calibre7"/><strong class="calibre4">      &lt;alias name='video0'/&gt;</strong><br class="calibre7"/><strong class="calibre4">      &lt;address type='pci' domain='0x0000' bus='0x00' slot='0x02' function='0x0'/&gt;</strong><br class="calibre7"/><strong class="calibre4">    &lt;/video&gt;</strong><br class="calibre7"/><strong class="calibre4">    &lt;memballoon model='virtio'&gt;</strong><br class="calibre7"/><strong class="calibre4">      &lt;alias name='balloon0'/&gt;</strong><br class="calibre7"/><strong class="calibre4">      &lt;address type='pci' domain='0x0000' bus='0x00' slot='0x04' function='0x0'/&gt;</strong><br class="calibre7"/><strong class="calibre4">    &lt;/memballoon&gt;</strong><br class="calibre7"/><strong class="calibre4">  &lt;/devices&gt;</strong><br class="calibre7"/><strong class="calibre4">  &lt;/domain&gt;</strong><br class="calibre7"/><strong class="calibre4">  """</strong><br class="calibre7"/><br class="calibre7"/><strong class="calibre4">  conn = libvirt.open('qemu:///system')</strong><br class="calibre7"/><strong class="calibre4">  if conn == None:</strong><br class="calibre7"/><strong class="calibre4">    print 'Failed to connecto to the hypervizor'</strong><br class="calibre7"/><strong class="calibre4">exit(1)</strong><br class="calibre7"/><br class="calibre7"/><strong class="calibre4">  instance = conn.defineXML(xmlconfig)</strong><br class="calibre7"/><strong class="calibre4">  if instance == None:</strong><br class="calibre7"/><strong class="calibre4">    print 'Failed to define the instance'</strong><br class="calibre7"/><strong class="calibre4">    exit(1)</strong><br class="calibre7"/><br class="calibre7"/><strong class="calibre4">  instances = conn.listDefinedDomains()</strong><br class="calibre7"/><strong class="calibre4">  print 'Defined instances: {}'.format(instances)</strong><br class="calibre7"/><br class="calibre7"/><strong class="calibre4">  time.sleep(5)</strong><br class="calibre7"/><br class="calibre7"/><strong class="calibre4">  if instance.create() &lt; 0:</strong><br class="calibre7"/><strong class="calibre4">    print 'Failed to start the {} instance'.format(instance.name())</strong><br class="calibre7"/><strong class="calibre4">    exit(1)</strong><br class="calibre7"/><br class="calibre7"/><strong class="calibre4">  if instance.isActive():</strong><br class="calibre7"/><strong class="calibre4">    print 'The instance {} is running'.format(instance.name())</strong><br class="calibre7"/><strong class="calibre4">  else:</strong><br class="calibre7"/><strong class="calibre4">    print 'The instance {} is not running'.format(instance.name())</strong><br class="calibre7"/><br class="calibre7"/><strong class="calibre4">  print 'The instance state, max memory, current memory, CPUs and time is {}'.format(instance.info())</strong><br class="calibre7"/><br class="calibre7"/><strong class="calibre4">  print 'The CPU, system and user times are {}'.format(instance.getCPUStats(1))</strong><br class="calibre7"/><br class="calibre7"/><strong class="calibre4">print 'The OS type for the {} instance is {}'.format(instance.name(), instance.OSType())</strong><br class="calibre7"/><br class="calibre7"/><strong class="calibre4">  time.sleep(5)</strong><br class="calibre7"/><br class="calibre7"/><strong class="calibre4">  if instance.destroy() &lt; 0:</strong><br class="calibre7"/><strong class="calibre4">    print 'Failed to stop the {} instance'.format(instance.name())</strong><br class="calibre7"/><strong class="calibre4">    exit(1)</strong><br class="calibre7"/><strong class="calibre4">  else:</strong><br class="calibre7"/><strong class="calibre4">    print 'The instance {} has been destroyed'.format(instance.name())</strong><br class="calibre7"/><br class="calibre7"/><strong class="calibre4">  if instance.undefine() &lt; 0:</strong><br class="calibre7"/><strong class="calibre4">    print 'Failed to remove the {} instance'.format(instance.name())</strong><br class="calibre7"/><strong class="calibre4">    exit(1)</strong><br class="calibre7"/><strong class="calibre4">  else:</strong><br class="calibre7"/><strong class="calibre4">    print 'The instance {} has been undefined'.format(instance.name())</strong><br class="calibre7"/><br class="calibre7"/><strong class="calibre4">  conn.close()</strong><br class="calibre7"/><br class="calibre7"/><strong class="calibre4">if __name__ == "__main__":</strong><br class="calibre7"/><strong class="calibre4">  main()</strong><br class="calibre7"/><br class="calibre7"/><strong class="calibre4">(kvm_python) root@kvm:~/kvm_python#</strong>
</pre>
<p class="calibre3">Executing it provides the following output, assuming the <kbd class="calibre13">kvm_python</kbd> instance has been undefined first:</p>
<pre class="calibre23">
<strong class="calibre4">(kvm_python) root@kvm:~/kvm_python# python kvm.py</strong><br class="calibre7"/><strong class="calibre4">Defined instances: ['kvm_python']</strong><br class="calibre7"/><strong class="calibre4">The instance kvm_python is running</strong><br class="calibre7"/><strong class="calibre4">The instance state, max memory, current memory, CPUs and time is [1, 1048576L, 1048576L, 1, 40000000L]</strong><br class="calibre7"/><strong class="calibre4">The CPU, system and user times are [{'cpu_time': 42349077L, 'system_time': 0L, 'user_time': 30000000L}]</strong><br class="calibre7"/><strong class="calibre4">The OS type for the kvm_python instance is hvm</strong><br class="calibre7"/><strong class="calibre4">The instance kvm_python has been destroyed</strong><br class="calibre7"/><strong class="calibre4">The instance kvm_python has been undefined</strong><br class="calibre7"/><strong class="calibre4">(kvm_python) root@kvm:~/kvm_python#<br class="calibre7"/></strong>
</pre>


            </article>

            <footer class="calibre5">
                
            </footer>

        </section>
    

        <section class="calibre1">

            <header class="calibre1">
                </header><h1 class="header-title" id="calibre_pb_0">Building a simple REST API server with libvirt and bottle</h1>
            

            <article class="calibre1">
                
<p class="calibre3">In this recipe, we are going to use all of the libvirt methods we saw in the earlier recipes to build a simple RESTfull API server, leveraging the bottle micro framework for Python.</p>
<p class="calibre3">Bottle is described as a fast and simple <strong class="calibre4">Web Server Gateway Interface</strong> (<strong class="calibre4">WSGI</strong>) micro web-framework for Python, which is distributed as a single module file.</p>
<div class="packt_infobox">For more information on the bottle micro framework please visit the official website at: <a href="https://bottlepy.org/docs/dev/" class="calibre30">https://bottlepy.org/docs/dev/</a>.</div>
<p class="calibre3">The simple API server we are implementing, will accept the following requests:</p>
<ul class="calibre16">
<li class="calibre17"><strong class="calibre4">list</strong>: <kbd class="calibre13">get</kbd> method that lists all defined libvirt instances.</li>
<li class="calibre17"><strong class="calibre4">define</strong>: <kbd class="calibre13">post</kbd> method used to define a new KVM instance. We are going to provide the XML definition as a header in the post request.</li>
<li class="calibre17"><strong class="calibre4">start</strong>: <kbd class="calibre13">post</kbd> method to start an instance. The name of the instance will be provided in the header of the request.</li>
<li class="calibre17"><strong class="calibre4">stop</strong>: <kbd class="calibre13">post</kbd> method to spot a KVM instance.</li>
<li class="calibre17"><strong class="calibre4">undefine</strong>: <kbd class="calibre13">post</kbd> method to delete the instance.</li>
</ul>


            </article>

            <footer class="calibre5">
                
            </footer>

        </section>
    

        <section class="calibre1">

            <header class="calibre1">
                </header><h1 class="header-title" id="calibre_pb_0">Getting ready</h1>
            

            <article class="calibre1">
                
<p class="calibre3">For this recipe we are going to need the following:</p>
<ul class="calibre16">
<li class="calibre17">An Ubuntu host, with libvirt and QEMU installed and configured</li>
<li class="calibre17">The <kbd class="calibre13">debian.img</kbd> raw image file we built in the <em class="calibre22">Installing custom OS on the image with debootstrap</em> recipe from <a target="_blank" href="part0026.html#OPEK0-c1e587dcccb14690b55c247c1809e6ce" class="calibre8">Chapter 1</a>, <em class="calibre22">Getting Started with QEMU and KVM</em> </li>
<li class="calibre17">Python 2.7  and the virtual environment we created in the <em class="calibre22">Installing and using the Python libvirt library</em> recipe in this chapter</li>
<li class="calibre17">The <kbd class="calibre13">curl</kbd> command line tool for transferring data with URL syntax, usually provided by the curl package</li>
</ul>


            </article>

            <footer class="calibre5">
                
            </footer>

        </section>
    

        <section class="calibre1">

            <header class="calibre1">
                </header><h1 class="header-title" id="calibre_pb_0">How to do it...</h1>
            

            <article class="calibre1">
                
<p class="calibre3">The following steps describe how to install the bottle module and the simple RESTfull API server written in Python:</p>
<ol class="calibre18">
<li value="1" class="calibre17"><span>Install the <kbd class="calibre13">bottle</kbd> module:</span></li>
</ol>
<pre class="calibre25">
<strong class="calibre4">(kvm_python) root@kvm:~/kvm_python# pip install bottle</strong><br class="calibre7"/><strong class="calibre4">Collecting bottle</strong><br class="calibre7"/><strong class="calibre4">...</strong><br class="calibre7"/><strong class="calibre4"> Downloading bottle-0.12.13.tar.gz (70kB)</strong><br class="calibre7"/><strong class="calibre4"> 100% |████████████████████████████████| 71kB 4.5MB/s</strong><br class="calibre7"/><strong class="calibre4">...</strong><br class="calibre7"/><strong class="calibre4">Successfully installed bottle-0.12.13</strong><br class="calibre7"/><strong class="calibre4">(kvm_python) root@kvm:~/kvm_python#</strong>
</pre>
<ol start="2" class="calibre18">
<li value="2" class="calibre17">Create a new file, import the libvirt and bottle modules and write the libvirt connection method:</li>
</ol>
<pre class="calibre25">
<strong class="calibre4">(kvm_python) root@kvm:~/kvm_python# vim kvm_api.py</strong><br class="calibre7"/><strong class="calibre4">import libvirt</strong><br class="calibre7"/><strong class="calibre4">from bottle import run, request, get, post, HTTPResponse</strong><br class="calibre7"/><br class="calibre7"/><strong class="calibre4">def libvirtConnect():</strong><br class="calibre7"/><strong class="calibre4">  try:</strong><br class="calibre7"/><strong class="calibre4">    conn = libvirt.open('qemu:///system')</strong><br class="calibre7"/><strong class="calibre4">  except libvirt.libvirtError:</strong><br class="calibre7"/><strong class="calibre4">    conn = None</strong><br class="calibre7"/><br class="calibre7"/><strong class="calibre4">  return conn</strong>
</pre>
<ol start="3" class="calibre18">
<li value="3" class="calibre17">Implement <kbd class="calibre13">/define</kbd> the API route and function:</li>
</ol>
<pre class="calibre25">
def defineKVMInstance(template):<br class="calibre7"/>  conn = libvirtConnect()<br class="calibre7"/><br class="calibre7"/>  if conn == None:<br class="calibre7"/>    return HTTPResponse(status=500, body='Error defining instance\n')<br class="calibre7"/>  else:<br class="calibre7"/>    try:<br class="calibre7"/>      conn.defineXML(template)<br class="calibre7"/>      return HTTPResponse(status=200, body='Instance defined\n')<br class="calibre7"/>    except libvirt.libvirtError:<br class="calibre7"/>      return HTTPResponse(status=500, body='Error defining instance\n')<br class="calibre7"/><br class="calibre7"/><br class="calibre7"/>@post('/define')<br class="calibre7"/>def build():<br class="calibre7"/>  template = str(request.headers.get('X-KVM-Definition'))<br class="calibre7"/>  status = defineKVMInstance(template)<br class="calibre7"/><br class="calibre7"/>  return status
</pre>
<ol start="4" class="calibre18">
<li value="4" class="calibre17">Implement <kbd class="calibre13">/undefine</kbd> the API route and function:</li>
</ol>
<pre class="calibre25">
def undefineKVMInstance(name):<br class="calibre7"/>  conn = libvirtConnect()<br class="calibre7"/><br class="calibre7"/>  if conn == None:<br class="calibre7"/>    return HTTPResponse(status=500, body='Error undefining instance\n')<br class="calibre7"/>  else:<br class="calibre7"/>    try:<br class="calibre7"/>      instance = conn.lookupByName(name)<br class="calibre7"/>      instance.undefine()<br class="calibre7"/>      return HTTPResponse(status=200, body='Instance undefined\n')<br class="calibre7"/>    except libvirt.libvirtError:<br class="calibre7"/>      return HTTPResponse(status=500, body='Error undefining instance\n')<br class="calibre7"/><br class="calibre7"/><br class="calibre7"/>@post('/undefine')<br class="calibre7"/>def build():<br class="calibre7"/>  name = str(request.headers.get('X-KVM-Name'))<br class="calibre7"/>  status = undefineKVMInstance(name)<br class="calibre7"/><br class="calibre7"/>  return status
</pre>
<ol start="5" class="calibre18">
<li value="5" class="calibre17">Implement <kbd class="calibre13">/start</kbd> the API route and function:</li>
</ol>
<pre class="calibre25">
def startKVMInstance(name):<br class="calibre7"/>  conn = libvirtConnect()<br class="calibre7"/><br class="calibre7"/>  if conn == None:<br class="calibre7"/>    return HTTPResponse(status=500, body='Error starting instance\n')<br class="calibre7"/>  else:<br class="calibre7"/>    try:<br class="calibre7"/>      instance = conn.lookupByName(name)<br class="calibre7"/>      instance.create()<br class="calibre7"/>      return HTTPResponse(status=200, body='Instance started\n')<br class="calibre7"/>    except libvirt.libvirtError:<br class="calibre7"/>      return HTTPResponse(status=500, body='Error starting instance\n')<br class="calibre7"/><br class="calibre7"/><br class="calibre7"/>@post('/start')<br class="calibre7"/>def build():<br class="calibre7"/>  name = str(request.headers.get('X-KVM-Name'))<br class="calibre7"/>  status = startKVMInstance(name)<br class="calibre7"/><br class="calibre7"/>  return status
</pre>
<ol start="6" class="calibre18">
<li value="6" class="calibre17">Implement <kbd class="calibre13">/stop</kbd> the API route and function:</li>
</ol>
<pre class="calibre25">
def stopKVMInstance(name):<br class="calibre7"/>  conn = libvirtConnect()<br class="calibre7"/><br class="calibre7"/>  if conn == None:<br class="calibre7"/>    return HTTPResponse(status=500, body='Error stopping instance\n')<br class="calibre7"/>  else:<br class="calibre7"/>    try:<br class="calibre7"/>      instance = conn.lookupByName(name)<br class="calibre7"/>      instance.destroy()<br class="calibre7"/>      return HTTPResponse(status=200, body='Instance stopped\n')<br class="calibre7"/>    except libvirt.libvirtError:<br class="calibre7"/>      return HTTPResponse(status=500, body='Error stopping instance\n')<br class="calibre7"/><br class="calibre7"/><br class="calibre7"/>@post('/stop')<br class="calibre7"/>def build():<br class="calibre7"/>  name = str(request.headers.get('X-KVM-Name'))<br class="calibre7"/>  status = stopKVMInstance(name)<br class="calibre7"/><br class="calibre7"/>  return status
</pre>
<ol start="7" class="calibre18">
<li value="7" class="calibre17">Implement <kbd class="calibre13">/list</kbd> the API route and function:</li>
</ol>
<pre class="calibre25">
def getLibvirtInstances():<br class="calibre7"/>  conn = libvirtConnect()<br class="calibre7"/><br class="calibre7"/>  if conn == None:<br class="calibre7"/>    return HTTPResponse(status=500, body='Error listing instances\n')<br class="calibre7"/>  else:<br class="calibre7"/>    try:<br class="calibre7"/>      instances = conn.listDefinedDomains()<br class="calibre7"/>      return instances<br class="calibre7"/>    except libvirt.libvirtError:<br class="calibre7"/>      return HTTPResponse(status=500, body='Error listing instances\n')<br class="calibre7"/><br class="calibre7"/><br class="calibre7"/>@get('/list')<br class="calibre7"/>def list():<br class="calibre7"/>  kvm_list = getLibvirtInstances()<br class="calibre7"/><br class="calibre7"/>  return "List of KVM instances: {}\n".format(kvm_list)
</pre>
<ol start="8" class="calibre18">
<li value="8" class="calibre17">Invoke the <kbd class="calibre13">run()</kbd> method to start the WSGI server when the script is executed:</li>
</ol>
<pre class="calibre25">
run(host='localhost', port=8080, debug=True)
</pre>


            </article>

            <footer class="calibre5">
                
            </footer>

        </section>
    

        <section class="calibre1">

            <header class="calibre1">
                </header><h1 class="header-title" id="calibre_pb_0">How it works...</h1>
            

            <article class="calibre1">
                
<p class="calibre3">Let's look at the code in more detail. First,  save the preceding changes in a file and execute the script:</p>
<pre class="calibre23">
<strong class="calibre4">(kvm_python) root@kvm:~/kvm_python# python kvm_api.py</strong><br class="calibre7"/><strong class="calibre4">Bottle v0.12.13 server starting up (using WSGIRefServer())...</strong><br class="calibre7"/><strong class="calibre4">Listening on http://localhost:8080/</strong><br class="calibre7"/><strong class="calibre4">Hit Ctrl-C to quit.</strong><br class="calibre7"/><br class="calibre7"/>
</pre>
<p class="calibre3">In a separate terminal, define a new instance, passing the following XML definition, as a header:</p>
<pre class="calibre23">
<strong class="calibre4">(kvm_python) root@kvm:~/kvm_python# curl -s -i -XPOST localhost:8080/define --header "X-KVM-Definition: &lt;domain type='kvm'&gt;&lt;name&gt;kvm_api&lt;/name&gt;&lt;memory unit='KiB'&gt;1048576&lt;/memory&gt;&lt;vcpu &gt;1&lt;/vcpu&gt;&lt;os&gt;&lt;type arch='x86_64' machine='pc-i440fx-trusty'&gt;hvm&lt;/type&gt;&lt;/os&gt;&lt;devices&gt;&lt;emulator&gt;/usr/bin/qemu-system-x86_64&lt;/emulator&gt;&lt;disk type='file' device='disk'&gt;&lt;driver name='qemu' type='raw'/&gt;&lt;source file='/tmp/debian.img'/&gt;&lt;target dev='hda' bus='ide'/&gt;&lt;/disk&gt;&lt;interface type='network'&gt;&lt;mac address='52:54:00:da:02:01'/&gt;&lt;source network='default' bridge='virbr0'/&gt;&lt;target dev='vnet0'/&gt;&lt;/interface&gt;&lt;graphics type='vnc' port='5900' autoport='yes' listen='0.0.0.0'&gt;&lt;listen type='address' address='0.0.0.0'/&gt;&lt;/graphics&gt;&lt;/devices&gt;&lt;/domain&gt;"</strong><br class="calibre7"/><strong class="calibre4">HTTP/1.0 200 OK</strong><br class="calibre7"/><strong class="calibre4">Date: Fri, 12 May 2017 20:29:14 GMT</strong><br class="calibre7"/><strong class="calibre4">Server: WSGIServer/0.1 Python/2.7.6</strong><br class="calibre7"/><strong class="calibre4">Content-Length: 17</strong><br class="calibre7"/><strong class="calibre4">Content-Type: text/html; charset=UTF-8</strong><br class="calibre7"/><br class="calibre7"/><strong class="calibre4">Instance defined</strong><br class="calibre7"/><strong class="calibre4">(kvm_python) root@kvm:~/kvm_python#<br class="calibre7"/></strong>
</pre>
<p class="calibre3">We are using the raw Debian image we created in <a target="_blank" href="part0026.html#OPEK0-c1e587dcccb14690b55c247c1809e6ce" class="calibre8">Chapter 1</a><em class="calibre22">, Getting Started with QEMU and KVM</em>. The XML definition should look familiar as well; we've been using it in most of the recipes in this chapter.</p>
<p class="calibre3">We should now have a new KVM instance defined. Let's use the <kbd class="calibre13">/list</kbd> route to list all instances and confirm with the <kbd class="calibre13">virsh</kbd> command:</p>
<pre class="calibre23">
<strong class="calibre4">(kvm_python) root@kvm:~/kvm_python# curl localhost:8080/list</strong><br class="calibre7"/><strong class="calibre4">List of KVM instances: ['kvm_api']</strong><br class="calibre7"/><strong class="calibre4">(kvm_python) root@kvm:~/kvm_python# virsh list --all</strong><br class="calibre7"/><strong class="calibre4"> Id   Name     State</strong><br class="calibre7"/><strong class="calibre4">----------------------------------------------------</strong><br class="calibre7"/><strong class="calibre4"> -   kvm_api   shut off</strong><br class="calibre7"/><br class="calibre7"/><strong class="calibre4">(kvm_python) root@kvm:~/kvm_python#</strong>
</pre>
<p class="calibre3">Now that we have a defined instance, let's start it using the <kbd class="calibre13">/start</kbd> route and ensure it's running:</p>
<pre class="calibre23">
<strong class="calibre4">(kvm_python) root@kvm:~/kvm_python# curl -s -i -XPOST localhost:8080/start --header "X-KVM-Name: kvm_api"</strong><br class="calibre7"/><strong class="calibre4">HTTP/1.0 200 OK</strong><br class="calibre7"/><strong class="calibre4">Date: Fri, 12 May 2017 20:29:38 GMT</strong><br class="calibre7"/><strong class="calibre4">Server: WSGIServer/0.1 Python/2.7.6</strong><br class="calibre7"/><strong class="calibre4">Content-Length: 17</strong><br class="calibre7"/><strong class="calibre4">Content-Type: text/html; charset=UTF-8</strong><br class="calibre7"/><br class="calibre7"/><strong class="calibre4">Instance started</strong><br class="calibre7"/><strong class="calibre4">(kvm_python) root@kvm:~/kvm_python# virsh list --all</strong><br class="calibre7"/><strong class="calibre4"> Id   Name      State</strong><br class="calibre7"/><strong class="calibre4">----------------------------------------------------</strong><br class="calibre7"/><strong class="calibre4"> 1    kvm_api   running</strong><br class="calibre7"/><br class="calibre7"/><strong class="calibre4">(kvm_python) root@kvm:~/kvm_python#<br class="calibre7"/></strong>
</pre>
<p class="calibre3">To stop the instance and remove it completely, we use the <kbd class="calibre13">/stop</kbd> and <kbd class="calibre13">/undefine</kbd> routes from the script:</p>
<pre class="calibre23">
<strong class="calibre4">(kvm_python) root@kvm:~/kvm_python# curl -s -i -XPOST localhost:8080/stop --header "X-KVM-Name: kvm_api"</strong><br class="calibre7"/><strong class="calibre4">HTTP/1.0 200 OK</strong><br class="calibre7"/><strong class="calibre4">Date: Fri, 12 May 2017 20:29:52 GMT</strong><br class="calibre7"/><strong class="calibre4">Server: WSGIServer/0.1 Python/2.7.6</strong><br class="calibre7"/><strong class="calibre4">Content-Length: 17</strong><br class="calibre7"/><strong class="calibre4">Content-Type: text/html; charset=UTF-8</strong><br class="calibre7"/><br class="calibre7"/><strong class="calibre4">Instance stopped</strong><br class="calibre7"/><strong class="calibre4">(kvm_python) root@kvm:~/kvm_python#</strong><br class="calibre7"/><strong class="calibre4">(kvm_python) root@kvm:~/kvm_python# virsh list --all</strong><br class="calibre7"/><strong class="calibre4"> Id   Name      State</strong><br class="calibre7"/><strong class="calibre4">----------------------------------------------------</strong><br class="calibre7"/><strong class="calibre4"> -    kvm_api   shut off</strong><br class="calibre7"/><br class="calibre7"/><strong class="calibre4">(kvm_python) root@kvm:~/kvm_python#</strong><br class="calibre7"/><strong class="calibre4">(kvm_python) root@kvm:~/kvm_python# curl -s -i -XPOST localhost:8080/undefine --header "X-KVM-Name: kvm_api"</strong><br class="calibre7"/><strong class="calibre4">HTTP/1.0 200 OK</strong><br class="calibre7"/><strong class="calibre4">Date: Fri, 12 May 2017 20:30:09 GMT</strong><br class="calibre7"/><strong class="calibre4">Server: WSGIServer/0.1 Python/2.7.6</strong><br class="calibre7"/><strong class="calibre4">Content-Length: 19</strong><br class="calibre7"/><strong class="calibre4">Content-Type: text/html; charset=UTF-8</strong><br class="calibre7"/><br class="calibre7"/><strong class="calibre4">Instance undefined</strong><br class="calibre7"/><strong class="calibre4">(kvm_python) root@kvm:~/kvm_python#</strong><br class="calibre7"/><strong class="calibre4">(kvm_python) root@kvm:~/kvm_python# virsh list --all</strong><br class="calibre7"/><strong class="calibre4"> Id Name State</strong><br class="calibre7"/><strong class="calibre4">----------------------------------------------------</strong><br class="calibre7"/><br class="calibre7"/><strong class="calibre4">(kvm_python) root@kvm:~/kvm_python#</strong>
</pre>
<p class="calibre3">Let us go through the code in more detail.</p>
<p class="calibre3">In step 1, we install the bottle module in the Python virtual environment.</p>
<p class="calibre3">After importing the libvirt and bottle packages in step 2, we define the <kbd class="calibre13">libvirtConnect()</kbd> method. The functions in our program will use it to connect to the hypervisor.  </p>
<p class="calibre3">In step 3, we implement the <kbd class="calibre13">/define</kbd> route and its functionality. The <kbd class="calibre13">@post</kbd> decorator links the code from the following function to a URL path. In our example the <kbd class="calibre13">/define</kbd> route is bound to the <kbd class="calibre13">build()</kbd> function. Passing the <kbd class="calibre13">/define</kbd> route to the curl command will execute the function, which in turn will call the <kbd class="calibre13">defineKVMInstance()</kbd> method to define the instance.</p>
<p class="calibre3">We use the same code pattern in steps 4, 5, and 6 to start, stop, and undefine the instance.</p>
<p class="calibre3">In step 7, we use the <kbd class="calibre13">@get</kbd> decorator to implement a function to list all defined instances on the host.</p>
<p class="calibre3">In step 8, we use the <kbd class="calibre13">run</kbd> class which provides the <kbd class="calibre13">run()</kbd> method we use to start a built-in server. In our example the server will be listening on localhost, port <kbd class="calibre13">8080</kbd>.</p>
<p class="calibre3">As we saw earlier, executing the script will start a listening socket on port <kbd class="calibre13">8080</kbd>, which we can interact with, using the <kbd class="calibre13">curl</kbd> command.</p>


            </article>

            <footer class="calibre5">
                
            </footer>

        </section>
    

        <section class="calibre1">

            <header class="calibre1">
                </header><h1 class="header-title" id="calibre_pb_0">There's more...</h1>
            

            <article class="calibre1">
                
<p class="calibre3">The full code implementation follows:</p>
<pre class="calibre23">
import libvirt<br class="calibre7"/>from bottle import run, request, get, post, HTTPResponse<br class="calibre7"/><br class="calibre7"/>def libvirtConnect():<br class="calibre7"/>  try:<br class="calibre7"/>    conn = libvirt.open('qemu:///system')<br class="calibre7"/>  except libvirt.libvirtError:<br class="calibre7"/>    conn = None<br class="calibre7"/><br class="calibre7"/>  return conn<br class="calibre7"/><br class="calibre7"/><br class="calibre7"/>def getLibvirtInstances():<br class="calibre7"/>  conn = libvirtConnect()<br class="calibre7"/><br class="calibre7"/>  if conn == None:<br class="calibre7"/>    return HTTPResponse(status=500, body='Error listing instances\n')<br class="calibre7"/>  else:<br class="calibre7"/>    try:<br class="calibre7"/>      instances = conn.listDefinedDomains()<br class="calibre7"/>      return instances<br class="calibre7"/>    except libvirt.libvirtError:<br class="calibre7"/>      return HTTPResponse(status=500, body='Error listing instances\n')<br class="calibre7"/><br class="calibre7"/><br class="calibre7"/>def defineKVMInstance(template):<br class="calibre7"/>  conn = libvirtConnect()<br class="calibre7"/><br class="calibre7"/>  if conn == None:<br class="calibre7"/>    return HTTPResponse(status=500, body='Error defining instance\n')<br class="calibre7"/>  else:<br class="calibre7"/>    try:<br class="calibre7"/>      conn.defineXML(template)<br class="calibre7"/>      return HTTPResponse(status=200, body='Instance defined\n')<br class="calibre7"/>    except libvirt.libvirtError:<br class="calibre7"/>      return HTTPResponse(status=500, body='Error defining instance\n')<br class="calibre7"/><br class="calibre7"/><br class="calibre7"/>def undefineKVMInstance(name):<br class="calibre7"/>  conn = libvirtConnect()<br class="calibre7"/><br class="calibre7"/>  if conn == None:<br class="calibre7"/>    return HTTPResponse(status=500, body='Error undefining instance\n')<br class="calibre7"/>  else:<br class="calibre7"/>    try:<br class="calibre7"/>      instance = conn.lookupByName(name)<br class="calibre7"/>      instance.undefine()<br class="calibre7"/>      return HTTPResponse(status=200, body='Instance undefined\n')<br class="calibre7"/>    except libvirt.libvirtError:<br class="calibre7"/>      return HTTPResponse(status=500, body='Error undefining instance\n')<br class="calibre7"/><br class="calibre7"/><br class="calibre7"/>def startKVMInstance(name):<br class="calibre7"/>  conn = libvirtConnect()<br class="calibre7"/><br class="calibre7"/>  if conn == None:<br class="calibre7"/>    return HTTPResponse(status=500, body='Error starting instance\n')<br class="calibre7"/>  else:<br class="calibre7"/>    try:<br class="calibre7"/>      instance = conn.lookupByName(name)<br class="calibre7"/>      instance.create()<br class="calibre7"/>      return HTTPResponse(status=200, body='Instance started\n')<br class="calibre7"/>    except libvirt.libvirtError:<br class="calibre7"/>      return HTTPResponse(status=500, body='Error starting instance\n')<br class="calibre7"/><br class="calibre7"/><br class="calibre7"/>def stopKVMInstance(name):<br class="calibre7"/>  conn = libvirtConnect()<br class="calibre7"/><br class="calibre7"/>  if conn == None:<br class="calibre7"/>    return HTTPResponse(status=500, body='Error stopping instance\n')<br class="calibre7"/>  else:<br class="calibre7"/>    try:<br class="calibre7"/>      instance = conn.lookupByName(name)<br class="calibre7"/>      instance.destroy()<br class="calibre7"/>      return HTTPResponse(status=200, body='Instance stopped\n')<br class="calibre7"/>    except libvirt.libvirtError:<br class="calibre7"/>      return HTTPResponse(status=500, body='Error stopping instance\n')<br class="calibre7"/><br class="calibre7"/><br class="calibre7"/>@post('/define')<br class="calibre7"/>def build():<br class="calibre7"/>  template = str(request.headers.get('X-KVM-Definition'))<br class="calibre7"/>  status = defineKVMInstance(template)<br class="calibre7"/><br class="calibre7"/>  return status<br class="calibre7"/><br class="calibre7"/><br class="calibre7"/>@post('/undefine')<br class="calibre7"/>def build():<br class="calibre7"/>  name = str(request.headers.get('X-KVM-Name'))<br class="calibre7"/>  status = undefineKVMInstance(name)<br class="calibre7"/><br class="calibre7"/>  return status<br class="calibre7"/><br class="calibre7"/><br class="calibre7"/>@get('/list')<br class="calibre7"/>def list():<br class="calibre7"/>  kvm_list = getLibvirtInstances()<br class="calibre7"/><br class="calibre7"/>  return "List of KVM instances: {}\n".format(kvm_list)<br class="calibre7"/><br class="calibre7"/><br class="calibre7"/>@post('/start')<br class="calibre7"/>def build():<br class="calibre7"/>  name = str(request.headers.get('X-KVM-Name'))<br class="calibre7"/>  status = startKVMInstance(name)<br class="calibre7"/><br class="calibre7"/>  return status<br class="calibre7"/><br class="calibre7"/><br class="calibre7"/>@post('/stop')<br class="calibre7"/>def build():<br class="calibre7"/>  name = str(request.headers.get('X-KVM-Name'))<br class="calibre7"/>  status = stopKVMInstance(name)<br class="calibre7"/><br class="calibre7"/>  return status<br class="calibre7"/><br class="calibre7"/><br class="calibre7"/>run(host='localhost', port=8080, debug=True)
</pre>


            </article>

            <footer class="calibre5">
                
            </footer>

        </section>
    </body></html>