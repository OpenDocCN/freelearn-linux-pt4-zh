<html><head></head><body><div class="chapter" title="Chapter&#xA0;6.&#xA0;NSX Security Features"><div class="titlepage"><div><div><h1 class="title"><a id="ch06"/>Chapter 6. NSX Security Features</h1></div></div></div><p>Traditionally, isolating and securing a network was done at the perimeter level of any data center, which was an error-prone and time-consuming activity. In the current Software Defined Data Center world, where most workloads are dynamic, we need better control over the security feature, and at the same time we expect configuration and management of these tasks to be automated without compromising any security features. If there is a virtual machine migration from one server to another server all my polices should move along with that irrespective of Layer 2 and Layer 3 boundaries. But the real question would be, is that really possible? In this chapter, we will discuss how NSX has changed the view of modern-day data center security. We will be covering the following topics with some classic examples:</p><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc">NSX Distributed Firewall</li><li class="listitem" style="list-style-type: disc">NSX Service Composer</li><li class="listitem" style="list-style-type: disc">NSX Distributed Firewall monitoring</li><li class="listitem" style="list-style-type: disc">NSX SpoofGuard</li><li class="listitem" style="list-style-type: disc">DFW takeaways</li></ul></div><div class="section" title="NSX Distributed Firewall"><div class="titlepage"><div><div><h1 class="title"><a id="ch06lvl1sec47"/>NSX Distributed Firewall</h1></div></div></div><p>NSX <span class="strong"><strong>Distributed Firewall</strong></span> (<span class="strong"><strong>DFW</strong></span>) focuses on East-West traffic and NSX Edge firewall focuses on North-South traffic. Those of us who remember the vCloud network security days will feel like this is an enhancement of the vShield app. Okay! For now, I would certainly agree with that; it is certainly an enhanced feature-rich version of the vShield app firewall. But the app demands that you run a dedicated firewall VM for each host and the virtual machine remains protected irrespective of where they are moving. Apart from the fact that it demands a hypervisor-specific firewall (FW) virtual machine, it was a featureless firewall and installation and troubleshooting was also slightly tedious. NSX Distributed Firewall is a hypervisor kernel-embedded firewall and policies are totally virtualization-aware. What does that mean? We can apply policies on vCenter objects such as data centers and clusters and virtual machine names and tags, and network constructs such as IP/VLAN/VXLAN addresses. What if we have the same firewall rule added in NSX Edge and Distributed Firewall? Which policy would be enforced first? There are two answers to that question. If the traffic is going out from the virtual machine, certainly the distributed firewall rule will be checked first, primarily because it is a VNIC-level firewall policy. However, if traffic is coming into the virtual data center, NSX Edge, our perimeter device, will be the first point of firewall rule table checking and later there would be a VNIC-level filtering also. Time to ask a few questions and justify why it is a feature-rich firewall:</p><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc">Can we have a dynamic FW rule creation based on the virtual name or operating system name?</li><li class="listitem" style="list-style-type: disc">I have a domain user <span class="strong"><strong>A</strong></span> and we need to <span class="strong"><strong>allow</strong></span> and <span class="strong"><strong>block</strong></span> a few rules based on user access <span class="strong"><strong>A</strong></span>. Is that achievable?</li><li class="listitem" style="list-style-type: disc">I have two tenants and we are using IPV4 and IPV6 respectively; can we leverage the Distributed Firewall feature irrespective of the IP stack?</li><li class="listitem" style="list-style-type: disc">Can we monitor the network activity between two virtual machines based on the firewall rule? This will ensure our rules are working as expected or we can take proactive action if required.</li><li class="listitem" style="list-style-type: disc">I'm migrating my virtual machine from cluster A to cluster B; will it retain the security/firewall policies? Do I need to add/delete any security/firewall settings in the physical network?</li><li class="listitem" style="list-style-type: disc">Can we implement a few network security policies without changing/impacting our existing physical network topology?</li></ul></div><p>The preceding questions are not a complete list. However, these are few key concerns for now, apart from being keen to know if we have a security feature X when we leverage an NSX distributed firewall, the fundamental problem is the question of whether I can switch my traditional physical-network-based security controls to the NSX world so that my features and policies are more virtualization-aware or, one more ask is, are they application aware policies with visibility over users, process, usage, and so on?  Don't get me wrong, we are not taking/removing all the physical network security settings and replicating them in the NSX world. All we need is a better secured network virtualized platform. NSX Distributed Firewall provides a micro-segmentation feature which resolves a lot of network security challenges. Since the firewall modules are running inside the ESXi host, we will always get a better throughput and policy configuration, deletion and monitoring all can be done from one single management console—vSphere web client. Before discussing firewall rules and how they work, let's understand what components are involved and how they communicate with each other. As we can see from the following diagram, we have vSphere web client, NSX Manager, and vSphere farm with all the VIBS loaded. By connecting to vCenter Server through web client, we can create security policies and NSX Manager will push the policies to vSphere Servers. <span class="strong"><strong>VMware Service Insertion Platform</strong></span> (<span class="strong"><strong>VSIP</strong></span>), which is a module within DFW, will apply the policy to underlying virtual machines. Any new generation or traditional port-based firewall  will have an intelligent rule table and NSX DFW is of no exception. There are two tables associated with DFW:</p><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc">Rule table</li><li class="listitem" style="list-style-type: disc">Connection table</li></ul></div><p>While the rule table maintains all the rules, the connection table will keep track of active connections based on the type of rules that we have created:</p><p>
</p><div class="mediaobject"><img src="graphics/image_06_001.jpg" alt="NSX Distributed Firewall"/></div><p>
</p><p>Now that we have a fundamental understanding of what Distributed Firewall is, it is equally important to know that DFW is fully virtualization-aware firewall and we can set firewall rules at the following vCenter Server objects:</p><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc">Data center</li><li class="listitem" style="list-style-type: disc">Cluster</li><li class="listitem" style="list-style-type: disc">vSwitch Port Group</li><li class="listitem" style="list-style-type: disc">Distributed Switch Port Group</li><li class="listitem" style="list-style-type: disc">Virtual app(vAPP)</li><li class="listitem" style="list-style-type: disc">Resource pool</li><li class="listitem" style="list-style-type: disc">Virtual machine</li><li class="listitem" style="list-style-type: disc">vNIC</li><li class="listitem" style="list-style-type: disc">Logical switch</li><li class="listitem" style="list-style-type: disc">Security Group</li><li class="listitem" style="list-style-type: disc">IP Sets</li><li class="listitem" style="list-style-type: disc">NSX Service Composer</li></ul></div><p>NSX Service Composer is a built-in feature which allows you to configure security services, firewall rules, and security policies with the help of security groups and security policies. We can create security groups and security policies and can apply a combination of security groups and security policies using NSX Service Composer, which is certainly a great way of automating rule/policy creation tasks. In a nutshell, we are doing two tasks and the final result is the automation of network security in the NSX world:</p><p>Deploy + Apply = Network Security Automation</p><p>But the question is, What are we going to deploy and where are we going to apply that? For that, we need to understand what security groups and security policies are.</p><div class="section" title="Security groups"><div class="titlepage"><div><div><h2 class="title"><a id="ch06lvl2sec44"/>Security groups</h2></div></div></div><p>A security group is where we define what type of assets we want to protect and we can define the group with the <span class="strong"><strong>dynamic way</strong></span> of selecting an asset or we could simply create a <span class="strong"><strong>static membership</strong></span> group. We will go back and read our questionnaire section in this chapter:</p><p>Can we have dynamic rule creation based on the virtual name or operating system name?</p><p>That gives us clarity on why dynamic membership would be a key factor while creating security groups. In a nutshell, when we create a Dynamic Membership Group with selection criteria <span class="emphasis"><em>Include All Operating System of windows flavor and apply the Security Group with a Security Policy that will one the easiest way in which we would have created and Secured our Virtual Machines with the intelligence of DFW firewall.</em></span>
</p></div><div class="section" title="Security policies"><div class="titlepage"><div><div><h2 class="title"><a id="ch06lvl2sec45"/>Security policies</h2></div></div></div><p>Security policies are combinations of security services and firewall rules. Policies can be a combination of antivirus, data security, vulnerability, network introspection, and firewall rules.</p><p>Okay! But what if we need to create a dynamic group, while excluding virtual machines running on one specific logic switch and given that all these configurations should be part of a single security group? This is the real power of security groups: all these configurations can be part of a single security group and in that case our security group will be like this:</p><p>Dynamic Inclusion + Static Inclusion (if required, we can still have a static inclusion list) - Static Exclusion = Security Group.</p><div class="section" title="Creating a service group"><div class="titlepage"><div><div><h3 class="title"><a id="ch06lvl3sec22"/>Creating a service group</h3></div></div></div><p>With a basic understanding of security groups and security policies, we will go ahead and discuss one of the security requirements to show the power of this feature. Let's have a look at one of the network requirements for securing the traffic with DFW features and we will discuss the lab exercise. As per the following topology, we have our three-tier application running on three logical switches and a transit network:</p><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc">App-Tier-01</li><li class="listitem" style="list-style-type: disc">Web-Tier-01</li><li class="listitem" style="list-style-type: disc">DB-Tier-01</li><li class="listitem" style="list-style-type: disc">Transit network</li></ul></div><p>In the following diagram, by leveraging NSX DFW we will disable the ICMP traffic in the Web-Tier logic switch and the final result will be that web servers running in logical switch Web-Tier-01 will block ICMP traffic:</p><p>
</p><div class="mediaobject"><img src="graphics/image_06_002.jpg" alt="Creating a service group"/></div><p>
</p><p>Before we start, let's do a simple ping test to confirm whether ICMP is allowed. The following screenshot depicts successful ICMP traffic between <code class="literal">web-01a</code> and <code class="literal">web-02a</code> connected to same logical switch <code class="literal">Web Tier-01</code>:</p><p>
</p><div class="mediaobject"><img src="graphics/image_06_003.jpg" alt="Creating a service group"/></div><p>
</p><p>For configuring a Distributed Firewall rule, we have two methods:</p><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc">By selecting <span class="strong"><strong>Firewall</strong></span> | <span class="strong"><strong>Networking &amp; Security</strong></span> | <span class="strong"><strong>Firewall</strong></span></li><li class="listitem" style="list-style-type: disc">By selecting <span class="strong"><strong>Service Composer</strong></span> | <span class="strong"><strong>Networking &amp; Security</strong></span> | <span class="strong"><strong>Service Composer</strong></span></li></ul></div><p>In this example, I'm leveraging Service Composer. Let's create a security group with the name <span class="strong"><strong>Web Security-Group</strong></span>:</p><p>
</p><div class="mediaobject"><img src="graphics/image_06_004.jpg" alt="Creating a service group"/></div><p>
</p><p>In the dynamic membership list, we are not selecting any options. However, it is worth focusing on the <span class="strong"><strong>Criteria Details</strong></span> option to get a clear picture of what options are available for defining a dynamic membership group as shown in the following screenshot. For example, if we select VM name in the following criteria list and mention Windows in white text box and create a Security Group. Any existing/future virtual machines which are getting deployed in vCenter Server will be applied with the DFW policy. Highly powerful feature as it ease lot of repeated task when same set of polices are required for a group of virtual machines also down the line adding and deletion of polices to same group is a one click task:</p><p>
</p><div class="mediaobject"><img src="graphics/image_06_005.jpg" alt="Creating a service group"/></div><p>
</p><p>In the static inclusion list, we set <span class="strong"><strong>Object Type</strong></span> to <span class="strong"><strong>Logical Switch</strong></span> so that we can apply the policy on the <span class="strong"><strong>Web-Tier-01</strong></span> logical switch as shown in the following screenshot:</p><p>
</p><div class="mediaobject"><img src="graphics/image_06_006.jpg" alt="Creating a service group"/></div><p>
</p><p>What next? I have intentionally connected a <span class="strong"><strong>Linux VM</strong></span> to our <span class="strong"><strong>Web-Tier</strong></span> and the idea is to exclude only Linux from the security group policy that we are creating. Even though we are creating a security group at Logical Switch level, we can still filter our policy in such a way by mentioning a exclusion criteria. In a nutshell, polices are applied at logical switch level, however it is not applied to all the virtual machines connected to same logical switch. As we can see from following screenshot, we have set <span class="strong"><strong>Object Type</strong></span> to <span class="strong"><strong>Virtual Machine</strong></span> and excluded <span class="strong"><strong>Linux-01a</strong></span>:</p><p>
</p><div class="mediaobject"><img src="graphics/image_06_007.jpg" alt="Creating a service group"/></div><p>
</p><p>With that step, we are done with security group creation and we will see the web security group created under <span class="strong"><strong>Service Composer</strong></span> | <span class="strong"><strong>Networking &amp; Security</strong></span> | <span class="strong"><strong>Service Composer</strong></span>. I have explicitly highlighted the virtual machine as I want everyone's attention on the virtual machine number, which is showing as <span class="strong"><strong>1</strong></span>. Using the same step, we will create another security group called <span class="strong"><strong>Web2Security</strong></span> and in the static inclusion we will include the <span class="strong"><strong>Web-02a</strong></span> virtual machine.</p><p>So let's revise the two security group rules with our example:</p><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc">Security Group (Web Security-Group) = Dynamic Inclusion (Not Selected Anything) + Static Inclusion (Selected Web-Tier Logical Switch) - Static Exclusion (Excluded Linux VM)</li><li class="listitem" style="list-style-type: disc">Security Group (Web2Security) = Dynamic Inclusion (Not Selected Anything) + Static Inclusion (Web-02a) - Static Exclusion (Not Selected anything)</li></ul></div><p>The following screenshot depicts two security groups that we created and we can see the VM count also showing there:</p><p>
</p><div class="mediaobject"><img src="graphics/image_06_008.jpg" alt="Creating a service group"/></div><p>
</p></div><div class="section" title="Creating a security policy"><div class="titlepage"><div><div><h3 class="title"><a id="ch06lvl3sec23"/>Creating a security policy</h3></div></div></div><p>As we have discussed earlier, policies are groups of security services, such as antivirus, IPS/IDS solution, and DFW rules.</p><p>Before creating policies, we need to prioritize the policy with a weight attribute if required. The whole purpose of this feature is that, at times, objects (in our example, let's take a virtual machine as an object) will be part of multiple policies. Based on which policy has a higher weight attribute, that policy will take precedence over lower-weight attributes. In addition to that, if the policy that we are creating receives services from another security policy, we need to select the parent policy.</p><p>The following screenshot depicts a security policy being created; we name it <span class="strong"><strong>Web Security-Group</strong></span>:</p><p>
</p><div class="mediaobject"><img src="graphics/image_06_009.jpg" alt="Creating a security policy"/></div><p>
</p><p>Since we are not leveraging guest introspection and network introspection services in this example, I'm skipping that configuration and moving directly to the firewall rule. Both configurations will be extremely useful for the following scenarios:</p><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc">Endpoint services are required for data security or third-party solution provider services such as antivirus or vulnerability management services.</li><li class="listitem" style="list-style-type: disc">To detect sensitive data such as <span class="strong"><strong>Payment Card Industry</strong></span> (<span class="strong"><strong>PCI</strong></span>), <span class="strong"><strong>Protected Health Information</strong></span> (<span class="strong"><strong>PHI</strong></span>), and <span class="strong"><strong>Personally Identifiable Information</strong></span> (<span class="strong"><strong>PII</strong></span>) information in our environment, we can create data security policies. When we run a scan, data security identifies data that violates the regulations in your policy will be <span class="strong"><strong>blocked</strong></span> with brilliance of firewall policies.</li><li class="listitem" style="list-style-type: disc">Network introspection services that monitor your network, such as IPS.</li></ul></div><p>Let's have a closer look at the firewall source and destination rules:</p><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc"><span class="strong"><strong>Source</strong></span>: Policy Security Group</li><li class="listitem" style="list-style-type: disc"><span class="strong"><strong>Destination</strong></span>: Web2Security Group</li><li class="listitem" style="list-style-type: disc"><span class="strong"><strong>Service</strong></span>: We are blocking all ICMP traffic (total 4 ICMP traffic selected which we will see very shortly)</li></ul></div><p>The following screenshot depicts the preceding rules:</p><p>
</p><div class="mediaobject"><img src="graphics/image_06_010.jpg" alt="Creating a security policy"/></div><p>
</p><p>Now that our security policies and security groups have been created, we can simply apply our policy to the <span class="strong"><strong>security group</strong></span> which we created earlier by clicking on the <span class="strong"><strong>Apply Policy</strong></span> option, which is portrayed in the following screenshot:</p><p>
</p><div class="mediaobject"><img src="graphics/image_06_011.jpg" alt="Creating a security policy"/></div><p>
</p><p>While applying the security policy, NSX will show us all <span class="strong"><strong>Security Groups</strong></span> that have been created and we need to ensure we are applying it against the correct security group. Selecting the wrong security group will have a major impact on network traffic. Also, we can see a <span class="strong"><strong>Synchronize Firewall Config</strong></span> option just below <span class="strong"><strong>Apply Policy</strong></span>. Any time we modify a policy, it is recommended to synchronize the firewall configuration. A good sign with the latest release of NSX 6.2.3 is there is an out-of-sync security policy alarm which will be generated if a security policy is out of sync. But watch out for previous versions of NSX Manager as we will never know if the policy is out of sync unless a problem is reported and we isolate the same after troubleshooting.</p></div><div class="section" title="Testing firewall rules"><div class="titlepage"><div><div><h3 class="title"><a id="ch06lvl3sec24"/>Testing firewall rules</h3></div></div></div><p>What next? Well, if we have been alert so far, we will see these rules getting populated in <span class="strong"><strong>Firewall</strong></span> | <span class="strong"><strong>Networking &amp; Security</strong></span> | <span class="strong"><strong>Firewall</strong></span>. The following screenshot depicts the WebSecurity rule that we created for:</p><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc"><span class="strong"><strong>Source</strong></span>: <span class="strong"><strong>WebSecurity-Group</strong></span> (<span class="strong"><strong>Web-01a</strong></span>)</li><li class="listitem" style="list-style-type: disc"><span class="strong"><strong>Destination</strong></span>: <span class="strong"><strong>Web2Security</strong></span> (<span class="strong"><strong>Web-02a</strong></span>)</li><li class="listitem" style="list-style-type: disc"><span class="strong"><strong>Services</strong></span>: <span class="strong"><strong>4 ICMP protocols</strong></span> and <span class="strong"><strong>Action</strong></span> is <span class="strong"><strong>Block</strong></span></li></ul></div><p>
</p><div class="mediaobject"><img src="graphics/image_06_012.jpg" alt="Testing firewall rules"/></div><p>
</p><p>Time to test what we have configured so far and I will show you the detailed firewall summary on the ESXi host. As we can see from the following screenshot, we have an SSH session to the <code class="literal">web-02a</code> machine and we are able to ping 172.16.10.11 (web-01a):</p><p>
</p><div class="mediaobject"><img src="graphics/image_06_013.jpg" alt="Testing firewall rules"/></div><p>
</p><p>Now, if we do a ping test from <code class="literal">web-01a</code> to <code class="literal">web-02a,</code> as shown in the following screenshot, the result would be a failure, primarily because of the <span class="strong"><strong>ICMP DROP</strong></span> rules that we have created:</p><p>
</p><div class="mediaobject"><img src="graphics/image_06_014.jpg" alt="Testing firewall rules"/></div><p>
</p><p>I strongly believe our DFW basics are crystal-clear. Even though we have a troubleshooting chapter coming up, I'm very excited to show you an informative output that we can check and view from the underlying host. All we need to do is to take an SSH session to the ESXi host wherein our web servers are running and issue the following command:</p><pre class="programlisting">
<span class="strong"><strong>summarize-dvfilter</strong></span>
</pre><p>Distributed Virtual Filter is the module that monitors the outgoing and incoming traffic that is protected by NSX DFW. So this command would display the same output. The following command output is for the Web-02a virtual machine and let's make a note of the name of the vNic slot 2 associated with the <code class="literal">VM - nic-60841-eth0-vmware-sfw.2</code>:</p><p>
</p><div class="mediaobject"><img src="graphics/image_06_015.jpg" alt="Testing firewall rules"/></div><p>
</p><p>As we can see that the preceding command and output don't give any information on all the DFW rules associated with that virtual machine, let's display the rules associated with the name <code class="literal">nic-60841-eth0-vmware-sfw.2</code>. Issue the following command in the same host:</p><pre class="programlisting">
<span class="strong"><strong>Vsipioctl getfwrules -f nic-60841-eth0-vmware-sfw.2</strong></span>
</pre><p>The following screenshot clearly depicts all the rules. I have marked the <span class="strong"><strong>DROP</strong></span> rule and we have a total of four rules, which are just the ICMP rules we created a few minutes ago:</p><p>
</p><div class="mediaobject"><img src="graphics/image_06_016.jpg" alt="Testing firewall rules"/></div><p>
</p><p>As I said earlier, the complete centralized management of Distributed Firewall is done from vSphere web client and, as far as rules are concerned, we will provide a name, source and destination entities, type of service, action required, and where the rules are enforced. In addition to normal rule creation, DFW also supports an identity-based firewall.</p></div><div class="section" title="Understanding identity-based firewall rules"><div class="titlepage"><div><div><h3 class="title"><a id="ch06lvl3sec25"/>Understanding identity-based firewall rules</h3></div></div></div><p>Let me reiterate our second query that we had when we discussed DFW:</p><p>I have a domain user A and we need to allow and block a few rules based on user access A. Is that achievable?</p><p>With an identity-based firewall, we can define firewall rules based on <span class="strong"><strong>Active Directory</strong></span> (<span class="strong"><strong>AD</strong></span>) groups. Obviously, there are few prerequisites and limitations when we use an identity-based firewall, which we will discuss in a short while. First and foremost, we need to register AD with NSX Manager.</p><div class="section" title="Procedure for AD registration"><div class="titlepage"><div><div><h4 class="title"><a id="ch06lvl4sec3"/>Procedure for AD registration</h4></div></div></div><p>We will follow these steps to register the AD on NSX Manager:</p><div class="orderedlist"><ol class="orderedlist arabic"><li class="listitem">Firstly, we will log in to vSphere web client.</li><li class="listitem">Click <span class="strong"><strong>Networking &amp; Security</strong></span> and then click <span class="strong"><strong>NSX Managers</strong></span>.</li><li class="listitem">Click an NSX Manager in the <span class="strong"><strong>Name</strong></span> column and then click the <span class="strong"><strong>Manage</strong></span> tab.</li><li class="listitem">Click the <span class="strong"><strong>Domain</strong></span> tab and then click on the add domain icon.</li><li class="listitem">In the <span class="strong"><strong>Add Domain</strong></span> dialog box, enter the fully qualified domain name and netBIOS name for the domain. The following figure depicts the preceding steps:<p>
</p><div class="mediaobject"><img src="graphics/image_06_017.jpg" alt="Procedure for AD registration"/></div><p>
</p></li><li class="listitem">In the <span class="strong"><strong>LDAP Options</strong></span> page, specify the domain controller that the domain is to be synchronized with and select the protocol.</li><li class="listitem">Edit the port number if required.</li><li class="listitem">Enter the user credentials for the domain account. This user must be able to access the directory tree structure.<p>The following figure shows the LDAP configuration that needs to be filled in during the configuration time:</p><p>
</p><div class="mediaobject"><img src="graphics/image_06_018.jpg" alt="Procedure for AD registration"/></div><p>
</p></li><li class="listitem">In the <span class="strong"><strong>Security Event Log Access</strong></span> page, select the connection method to access security event logs on the specified LDAP server. Change the port number if required.</li><li class="listitem">Select <span class="strong"><strong>Use Domain Credentials</strong></span> to use the LDAP server user credentials. To specify an alternate domain account for log access, un-select <span class="strong"><strong>Use Domain Credentials</strong></span> and specify the user name and password. The specified account must be able to read the security event logs on the domain controller.</li><li class="listitem">Click <span class="strong"><strong>Next</strong></span>.</li><li class="listitem">In the <span class="strong"><strong>Ready to complete</strong></span> page, review the settings you entered.</li><li class="listitem">Click <span class="strong"><strong>Finish</strong></span>.</li></ol></div><p>Once after configuring required AD details as shown in the above steps, NSX manager to AD synchronization will start. Only when it is synchronized  properly we should start leveraging <span class="strong"><strong>Identity firewall</strong></span> (<span class="strong"><strong>IDFW</strong></span>). This is a one time task and further synchronization is automatic. What next? We can simply create security groups (AD groups) and security policies (Firewal policy) and allow/deny the services based on business requirement. The following diagram shows AD integration with NSX Manager and AD groups MG as source and destination is group of windows machines with http and icmp services allowed between them:</p><p>
</p><div class="mediaobject"><img src="graphics/need-to-change1.jpg" alt="Procedure for AD registration"/></div><p>
</p></div></div></div></div></div>
<div class="section" title="NSX flow monitoring"><div class="titlepage"><div><div><h1 class="title"><a id="ch06lvl1sec48"/>NSX flow monitoring</h1></div></div></div><p>Network monitoring tools are always difficult to set up, configure, and analyze. To date, most of us will have configured a third-party monitoring tool for analyzing network traffic and taken action accordingly. Maybe we could capture packets at a few points and have them analyzed using Wireshark. Do we really like switching from one management console to another management console for such scenarios? Are we happy with third-party monitoring software and expect all types of integration brilliance to showcase all the traffic? I know most people are not happy with such tools, which are vendor-dependent. We need a tool which will help us analyze things quickly and take proactive action. <span class="strong"><strong>NSX flow monitoring</strong></span> is an built-in feature which gives that visibility and control over any traffic. In a nutshell, it configures Distributed Firewall to capture traffic and we can analyze traffic flow. Flow monitoring data includes the number of sessions and packets transmitted per session. Session details include sources, destinations, applications, and ports being used, and later we can create firewall allow or block rules based on session details. By default, the last 24 hours of data are displayed, the minimum time span is 1 hour and the maximum is 2 weeks.</p><p>To enable flow monitoring:</p><div class="orderedlist"><ol class="orderedlist arabic"><li class="listitem">Log in to vSphere web client.</li><li class="listitem">Select <span class="strong"><strong>Networking &amp; Security</strong></span> from the left navigation pane and then select <span class="strong"><strong>Flow Monitoring</strong></span>.</li><li class="listitem">Select the <span class="strong"><strong>Configuration</strong></span> tab.</li><li class="listitem">Ensure that <span class="strong"><strong>Global Flow Collection Status</strong></span> is <span class="strong"><strong>Enabled</strong></span> and we are not making any changes with the <span class="strong"><strong>Detail Collection Policy</strong></span>.</li></ol></div><p>The following screenshot depicts <span class="strong"><strong>Global Flow Connection Status</strong></span> set to <span class="strong"><strong>Enabled</strong></span>:</p><p>
</p><div class="mediaobject"><img src="graphics/image_06_020.jpg" alt="NSX flow monitoring"/></div><p>
</p><p>OK! So we have enabled flow monitoring and we should be able to see a few flow stats. In our example, we will quickly check a live flow from a Windows 2008 machine (192.168.2.2).</p><p>Capturing a live flow:</p><div class="orderedlist"><ol class="orderedlist arabic"><li class="listitem">Log in to vSphere web client.</li><li class="listitem">Select <span class="strong"><strong>Networking &amp; Security</strong></span> from the left navigation pane and then select <span class="strong"><strong>Flow Monitoring</strong></span>.</li><li class="listitem">Click the <span class="strong"><strong>Live Flow</strong></span> tab.</li><li class="listitem">Click <span class="strong"><strong>Browse</strong></span> and select <span class="strong"><strong>windows-2008(IPSEC) NIC</strong></span>.</li><li class="listitem">Click <span class="strong"><strong>Start</strong></span> to begin viewing live flow.</li></ol></div><p>The following figure shows live flow stats and I have highlighted a block rule which applies when source windows-2008 192.168.2.2 tries to communicate with destination IP 192.168.4.2:</p><p>
</p><div class="mediaobject"><img src="graphics/image_06_021.jpg" alt="NSX flow monitoring"/></div><p>
</p><p>As we can see, this is an excellent feature and we can easily work out not only what type of traffic is allowed and what is blocked but also the incoming and outgoing bytes, which is very important for situations wherein we would like to know which source is sending more bytes or where we are getting more incoming bytes from. In our case, the <span class="strong"><strong>TCP-SYNC</strong></span> packet is sent, but there is no reply since I have created a DFW rule that is blocking the traffic between 192.168.2.2 and 192.168.4.2.</p></div>
<div class="section" title="NSX SpoofGuard"><div class="titlepage"><div><div><h1 class="title"><a id="ch06lvl1sec49"/>NSX SpoofGuard</h1></div></div></div><p>Another powerful feature of NSX is SpoofGuard. The SpoofGuard feature will monitor and manage the IP address of a virtual machine. OK! Why do we need such a feature? If a virtual machine is compromised by chance, what are the outcomes? A hacker can certainly change the IP and bypass all firewall policies and the rest will be history. SpoofGuard gives us that granular control to ensure all IP changes are approved, until when traffic would be blocked. NSX Manager will collect the IP address of the virtual machines as long we have a VMware tool installed and running.</p><p>The following methods are supported in SpoofGuard:</p><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc"><span class="strong"><strong>Automatically trust IP assignments on their first use</strong></span>: This mode allows all traffic from your virtual machines to pass; additionally, it builds a table of vNIC-to-IP address assignments. That way, we can review this table and make IP address changes. Both IPv4 and IPv6 are supported.</li><li class="listitem" style="list-style-type: disc"><span class="strong"><strong>Manually inspect and approve all IP assignments before use</strong></span>: This mode blocks all traffic until you approve each vNIC-to-IP address assignment.</li></ul></div><p>That brings us to another question. How about virtual machines which are leveraging DHCP IP? Will they get IP assigned? Do we need to approve them for DHCP IP assignment?</p><p>The answer is very simple if we have understood supported SpoofGuard methods. Only in <span class="strong"><strong>Manual Inspect</strong></span>, DHCP traffic won't be allowed until we approve the request; the rule applies the same for DHCP as well. By DHCP will be blocked if we are manually inspecting IP assignment. That being said, let's do a lab test based on the following scenario:</p><p>
<span class="emphasis"><em>Virtual machines running on the web server logical switch should inspect all IP assignments</em></span>.</p><div class="section" title="Procedure for SpoofGuard configuration"><div class="titlepage"><div><div><h2 class="title"><a id="ch06lvl2sec46"/>Procedure for SpoofGuard configuration</h2></div></div></div><p>We need to perform the following steps for SpoofGuard configuration:</p><div class="orderedlist"><ol class="orderedlist arabic"><li class="listitem">Firstly, log in to vSphere web client.</li><li class="listitem">Click <span class="strong"><strong>Networking &amp; Security</strong></span> and then click <span class="strong"><strong>SpoofGuard</strong></span>.</li><li class="listitem">Click the add icon.</li><li class="listitem">Type a name for the SpoofGuard policy.</li><li class="listitem">We can immediately enable or disable based on business requirements.</li><li class="listitem">For <span class="strong"><strong>Operation Mode</strong></span>, we select <span class="strong"><strong>Manually inspect and approve all IP assignments before use.</strong></span> The following screenshot depicts the initial configuration of SpoofGuard:<p>
</p><div class="mediaobject"><img src="graphics/image_06_022.jpg" alt="Procedure for SpoofGuard configuration"/></div><p>
</p></li><li class="listitem">To specify where we need to apply the SpoofGuard policy, click <span class="strong"><strong>Add</strong></span> and select the networks, distributed port groups, or logical switches that this policy should apply to. In our example, we are configuring the <span class="strong"><strong>Web-Tier</strong></span> logical switch as shown in the following screenshot:<p>
</p><div class="mediaobject"><img src="graphics/image_06_023.jpg" alt="Procedure for SpoofGuard configuration"/></div><p>
</p></li><li class="listitem">Since we have set SpoofGuard to require manual approval of all IP address, let's check that assignment.</li></ol></div><p>In the following screenshot, we are viewing the <span class="strong"><strong>Virtual NIC IP Required Approval</strong></span> screen, IP address changes that require approval before traffic can flow to or from these virtual machines. Other options available are as follows:</p><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc"><span class="strong"><strong>Active Virtual NICs</strong></span></li><li class="listitem" style="list-style-type: disc"><span class="strong"><strong>Active Virtual NICs Since Last Published</strong></span></li><li class="listitem" style="list-style-type: disc"><span class="strong"><strong>Virtual NICs with Duplicate IP</strong></span></li><li class="listitem" style="list-style-type: disc"><span class="strong"><strong>Inactive Virtual NICs</strong></span></li></ul></div><p>Unpublished virtual NICs IP:</p><p>
</p><div class="mediaobject"><img src="graphics/image_06_024.jpg" alt="Procedure for SpoofGuard configuration"/></div><p>
</p><p>To approve an IP address, we need to click <span class="strong"><strong>Approve</strong></span> next to the IP address option. That sums up our detailed discussion on NSX security and monitoring. A few more integrations are certainly possible with NSX, vRealize operations management (previously VROPS) with NSX, vCloud Director integration with NSX; vRealize Automation with NSX , NSX with third-party software such as Palo Alto networks, check point, and so on. Considering the positive momentum NSX has created in the market, more and more integrations will be coming down the line, which makes life easier for all architects. It's definitely worth knowing all these integrations; please read the links I will be providing in <a class="link" href="ch08.html" title="Chapter 8.  NSX Troubleshooting">Chapter 8</a>, <span class="emphasis"><em>NSX Troubleshooting</em></span>. Finally, let's have a quick look at a few key points that need to be taken care of.</p></div></div>
<div class="section" title="Distributed Firewall takeaways"><div class="titlepage"><div><div><h1 class="title"><a id="ch06lvl1sec50"/>Distributed Firewall takeaways</h1></div></div></div><p>Distributed Firewall is a feature-rich firewall. But we have to be extremely careful while installing and creating rules. Gone are the days when gigantic physical firewalls were used for traffic filtering and other security measures. Applications demanded firewalls to be a little closer to them rather than running at <span class="strong"><strong>Top of Rack</strong></span> (<span class="strong"><strong>TOR</strong></span>). All we needed was a stateful firewall that is more application-aware. When we are inspecting the traffic at near line rate processing that too for East-West traffic which will give us better visibility over the traffic and reduces any attacking loopholes in virtualized data centers, we can call NSX DFW firewall the foundation pillar of <span class="strong"><strong>Micro Segmentation</strong></span>. Worried about bottlenecks? No problem! DFW is the new kid in town. Let's have a quick look at a few key takeaways from this chapter.</p><p>DFW doesn't demand any physical network topology changes.</p><p>Make a note of all management virtual machines (VMware appliances, third-party appliances, AD, DNS and exchange, and so on) that are installed in the vSphere environment and make a decision about which should be part of DFW protection.</p><p>VSphere switch is not supported for policy enforcement; only logical switches and distributed switch port groups are supported. DFW is fully supported with IPv4 and IPv6.</p><p>Starting from NSX 6.2, DFW rules leveraging vCenter Server objects even without VMware tools are supported. NSX 6.1 and above has a new option called <span class="strong"><strong>reject</strong></span> in firewall actions. This action is available in NSX Edge as well.</p><p>NSX 6.2.3 supports <span class="strong"><strong>Trivial File Transfer Protocol</strong></span> (<span class="strong"><strong>TFTP</strong></span>)-ALG Distributed Firewall rules.</p><p>An identity-based firewall is supported only for <span class="strong"><strong>Windows Clients</strong></span>, ideal for East-West data center traffic. However, we can configure it with NSX Edge firewall and a physical firewall, which will bring end-to-end security in the overall data center.</p><p>Removing and adding vSphere virtual machines from vCenter won't delete any DFW rules. Make use of the <span class="strong"><strong>exclusion list</strong></span> feature if you want to exclude a VM completely from DFW protection. I will be discussing exclusion lists in more detail in <a class="link" href="ch08.html" title="Chapter 8.  NSX Troubleshooting">Chapter 8</a>, <span class="emphasis"><em>NSX Troubleshooting</em></span>.</p><p>If we are leveraging Identity firewall feature and for some reason there is a synchronization issue between NSX Manager and Active Directory, it will have a direct impact on DFW rules. So this is one scenario wherein Management plane (NSX Manager) outage causing a dataplane traffic issue because firewall is impacted.</p><p>If we need to identity applications and allow/block the traffic irrespective of the port and protocols information, best firewall for such use case will be to integrate New generation firewalls like palo alto along with DFW.</p><p>It is not mandatory to install the DFW feature in the vSphere management cluster; if we want to install DFW, watch out for the VCenter Server machine. Ensure that the machine is excluded from the list. If there is an other third-party management software running in the same cluster, DFW doesn't have the intelligence to exclude it from protection. I have seen this mistake back in the VCNS days: all of a sudden, VC loses access to all management components. A simple click on the <span class="strong"><strong>Install</strong></span> button will cause a major production outage.</p></div>
<div class="section" title="Summary"><div class="titlepage"><div><div><h1 class="title"><a id="ch06lvl1sec51"/>Summary</h1></div></div></div><p>We started this chapter with an introduction to NSX security and later we covered DFW architecture, use cases, and features. We also had a discussion about monitoring options available in NSX and, finally, we wrapped up the chapter by discussing key points to be noted before installing NSX security features.</p><p>In the next chapter, we will discuss cross-VC NSX for a multi-site solution with logical switch, Distributed Logical Router, and DFW installation and configuration across multiple vCenter domains.</p></div></body></html>